************************************************************
OBJETO: cls_cbtes_m2_sf
************************************************************
*** PROPIEDADES ***
DoCreate = .T.
WindowType = 0
cerrar_cbte = .F.
Name = "cls_cbtes_m2_sf"
CONTENIDO.Clsetiqueta1.Name = "Clsetiqueta1"
CONTENIDO.SEL_CLIENTE.txtCodigo.Name = "txtCodigo"
CONTENIDO.SEL_CLIENTE.txtDescripcion.Name = "txtDescripcion"
CONTENIDO.SEL_CLIENTE.Name = "SEL_CLIENTE"
CONTENIDO.Clsetiqueta2.Name = "Clsetiqueta2"
CONTENIDO.Clsetiqueta3.Name = "Clsetiqueta3"
CONTENIDO.TXTSITIVA.Name = "TXTSITIVA"
CONTENIDO.SEL_FORMAPAGO.txtCodigo.Name = "txtCodigo"
CONTENIDO.SEL_FORMAPAGO.txtDescripcion.Name = "txtDescripcion"
CONTENIDO.SEL_FORMAPAGO.Name = "SEL_FORMAPAGO"
CONTENIDO.CLSLINEA1.Name = "CLSLINEA1"
CONTENIDO.Clsetiqueta4.Name = "Clsetiqueta4"
CONTENIDO.SEL_ARTICULO.txtCodigo.Name = "txtCodigo"
CONTENIDO.SEL_ARTICULO.txtDescripcion.Name = "txtDescripcion"
CONTENIDO.SEL_ARTICULO.Name = "SEL_ARTICULO"
CONTENIDO.Clsetiqueta5.Name = "Clsetiqueta5"
CONTENIDO.TXTCANTIDAD.Name = "TXTCANTIDAD"
CONTENIDO.btnAgregar.Top = 163
CONTENIDO.btnAgregar.Left = 896
CONTENIDO.btnAgregar.Height = 44
CONTENIDO.btnAgregar.Width = 45
CONTENIDO.btnAgregar.Name = "btnAgregar"
CONTENIDO.GRDDETALLES.COLUMN1.Header1.Name = "Header1"
CONTENIDO.GRDDETALLES.COLUMN1.Text1.Name = "Text1"
CONTENIDO.GRDDETALLES.COLUMN1.Name = "COLUMN1"
CONTENIDO.GRDDETALLES.COLUMN2.Header1.Name = "Header1"
CONTENIDO.GRDDETALLES.COLUMN2.Text1.Name = "Text1"
CONTENIDO.GRDDETALLES.COLUMN2.Name = "COLUMN2"
CONTENIDO.GRDDETALLES.COLUMN3.Header1.Name = "Header1"
CONTENIDO.GRDDETALLES.COLUMN3.Text1.Name = "Text1"
CONTENIDO.GRDDETALLES.COLUMN3.Name = "COLUMN3"
CONTENIDO.GRDDETALLES.COLUMN4.Header1.Name = "Header1"
CONTENIDO.GRDDETALLES.COLUMN4.Text1.Name = "Text1"
CONTENIDO.GRDDETALLES.COLUMN4.Name = "COLUMN4"
CONTENIDO.GRDDETALLES.COLUMN5.Header1.Name = "Header1"
CONTENIDO.GRDDETALLES.COLUMN5.Text1.Name = "Text1"
CONTENIDO.GRDDETALLES.COLUMN5.Name = "COLUMN5"
CONTENIDO.GRDDETALLES.COLUMN6.Header1.Name = "Header1"
CONTENIDO.GRDDETALLES.COLUMN6.Text1.Name = "Text1"
CONTENIDO.GRDDETALLES.COLUMN6.Name = "COLUMN6"
CONTENIDO.GRDDETALLES.COLUMN7.Header1.Name = "Header1"
CONTENIDO.GRDDETALLES.COLUMN7.Text1.Name = "Text1"
CONTENIDO.GRDDETALLES.COLUMN7.Name = "COLUMN7"
CONTENIDO.GRDDETALLES.COLUMN8.Header1.Name = "Header1"
CONTENIDO.GRDDETALLES.COLUMN8.Text1.Name = "Text1"
CONTENIDO.GRDDETALLES.COLUMN8.Name = "COLUMN8"
CONTENIDO.GRDDETALLES.COLUMN9.Header1.Name = "Header1"
CONTENIDO.GRDDETALLES.COLUMN9.Text1.Name = "Text1"
CONTENIDO.GRDDETALLES.COLUMN9.Name = "COLUMN9"
CONTENIDO.GRDDETALLES.COLUMN10.Header1.Name = "Header1"
CONTENIDO.GRDDETALLES.COLUMN10.Text1.Name = "Text1"
CONTENIDO.GRDDETALLES.COLUMN10.Name = "COLUMN10"
CONTENIDO.GRDDETALLES.COLUMN11.Header1.Name = "Header1"
CONTENIDO.GRDDETALLES.COLUMN11.Text1.Name = "Text1"
CONTENIDO.GRDDETALLES.COLUMN11.Name = "COLUMN11"
CONTENIDO.GRDDETALLES.COLUMN12.Header1.Name = "Header1"
CONTENIDO.GRDDETALLES.COLUMN12.Text1.Name = "Text1"
CONTENIDO.GRDDETALLES.COLUMN12.Name = "COLUMN12"
CONTENIDO.GRDDETALLES.COLUMN13.Header1.Name = "Header1"
CONTENIDO.GRDDETALLES.COLUMN13.Text1.Name = "Text1"
CONTENIDO.GRDDETALLES.COLUMN13.Name = "COLUMN13"
CONTENIDO.GRDDETALLES.COLUMN14.Header1.Name = "Header1"
CONTENIDO.GRDDETALLES.COLUMN14.Text1.Name = "Text1"
CONTENIDO.GRDDETALLES.COLUMN14.Name = "COLUMN14"
CONTENIDO.GRDDETALLES.COLUMN15.Header1.Name = "Header1"
CONTENIDO.GRDDETALLES.COLUMN15.Text1.Name = "Text1"
CONTENIDO.GRDDETALLES.COLUMN15.Name = "COLUMN15"
CONTENIDO.GRDDETALLES.COLUMN16.Header1.Name = "Header1"
CONTENIDO.GRDDETALLES.COLUMN16.Text1.Name = "Text1"
CONTENIDO.GRDDETALLES.COLUMN16.Name = "COLUMN16"
CONTENIDO.GRDDETALLES.COLUMN17.Header1.Name = "Header1"
CONTENIDO.GRDDETALLES.COLUMN17.Text1.Name = "Text1"
CONTENIDO.GRDDETALLES.COLUMN17.Name = "COLUMN17"
CONTENIDO.GRDDETALLES.COLUMN18.Header1.Name = "Header1"
CONTENIDO.GRDDETALLES.COLUMN18.Text1.Name = "Text1"
CONTENIDO.GRDDETALLES.COLUMN18.Name = "COLUMN18"
CONTENIDO.GRDDETALLES.COLUMN19.Header1.Name = "Header1"
CONTENIDO.GRDDETALLES.COLUMN19.Text1.Name = "Text1"
CONTENIDO.GRDDETALLES.COLUMN19.Name = "COLUMN19"
CONTENIDO.GRDDETALLES.COLUMN20.Header1.Name = "Header1"
CONTENIDO.GRDDETALLES.COLUMN20.Text1.Name = "Text1"
CONTENIDO.GRDDETALLES.COLUMN20.Name = "COLUMN20"
CONTENIDO.GRDDETALLES.Name = "GRDDETALLES"
CONTENIDO.btnGrabar.Name = "btnGrabar"
CONTENIDO.btnCancelar.Name = "btnCancelar"
CONTENIDO.CLSCERRAR1.Picture = ..\imagen\iconos bajados\salir-de-mi-perfil-icono-3964.ico
CONTENIDO.CLSCERRAR1.Name = "CLSCERRAR1"
CONTENIDO.CLSETIQUETA10.Name = "CLSETIQUETA10"
CONTENIDO.TXTPRMAY.Name = "TXTPRMAY"
CONTENIDO.CLSETIQUETA11.Name = "CLSETIQUETA11"
CONTENIDO.TXTPRMINORISTA.Name = "TXTPRMINORISTA"
CONTENIDO.CLSETIQUETA12.Name = "CLSETIQUETA12"
CONTENIDO.TXTALICIVA.Name = "TXTALICIVA"
CONTENIDO.CHKCALCIVA.Alignment = 0
CONTENIDO.CHKCALCIVA.Name = "CHKCALCIVA"
CONTENIDO.BTNELIMINAR.Top = 163
CONTENIDO.BTNELIMINAR.Left = 942
CONTENIDO.BTNELIMINAR.Height = 44
CONTENIDO.BTNELIMINAR.Width = 45
CONTENIDO.BTNELIMINAR.Name = "BTNELIMINAR"
CONTENIDO.CHKIMPRIMEDUP.Alignment = 0
CONTENIDO.CHKIMPRIMEDUP.Name = "CHKIMPRIMEDUP"
CONTENIDO.BTNCBTEORIGEN.Name = "BTNCBTEORIGEN"
CONTENIDO.TXTOBSERV.Name = "TXTOBSERV"
CONTENIDO.Clsetiqueta6.Name = "Clsetiqueta6"
CONTENIDO.Clsetiqueta7.Name = "Clsetiqueta7"
CONTENIDO.Clsetiqueta8.Name = "Clsetiqueta8"
CONTENIDO.Clsetiqueta9.Name = "Clsetiqueta9"
CONTENIDO.TXTTOTNETO.Name = "TXTTOTNETO"
CONTENIDO.TXTPORIVA21.Name = "TXTPORIVA21"
CONTENIDO.TXTPORIVA105.Name = "TXTPORIVA105"
CONTENIDO.TXTIMPIVA21.Name = "TXTIMPIVA21"
CONTENIDO.TXTIMPIVA105.Name = "TXTIMPIVA105"
CONTENIDO.txtTotal.Name = "txtTotal"
CONTENIDO.CLSETIQUETA14.Name = "CLSETIQUETA14"
CONTENIDO.TXTDESC1.Name = "TXTDESC1"
CONTENIDO.TXTDESC2.Name = "TXTDESC2"
CONTENIDO.TXTDESC3.Name = "TXTDESC3"
CONTENIDO.TXTDESC4.Name = "TXTDESC4"
CONTENIDO.TXTIMPDESC1.Name = "TXTIMPDESC1"
CONTENIDO.TXTIMPDESC2.Name = "TXTIMPDESC2"
CONTENIDO.TXTIMPDESC3.Name = "TXTIMPDESC3"
CONTENIDO.TXTIMPDESC4.Name = "TXTIMPDESC4"
CONTENIDO.CLSETIQUETA15.Name = "CLSETIQUETA15"
CONTENIDO.CLSETIQUETA16.Name = "CLSETIQUETA16"
CONTENIDO.CLSETIQUETA17.Name = "CLSETIQUETA17"
CONTENIDO.TXTTOTFACT.Name = "TXTTOTFACT"
CONTENIDO.Clsetiqueta18.Name = "Clsetiqueta18"
CONTENIDO.txtPorIIBB.Name = "txtPorIIBB"
CONTENIDO.txtImpIIBB.Name = "txtImpIIBB"
CONTENIDO.Clsetiqueta19.Name = "Clsetiqueta19"
CONTENIDO.txtST.Name = "txtST"
CONTENIDO.Clsetiqueta20.Name = "Clsetiqueta20"
CONTENIDO.txtPorDesc1.Name = "txtPorDesc1"
CONTENIDO.txtImpDescItem1.Name = "txtImpDescItem1"
CONTENIDO.txtPorDesc2.Name = "txtPorDesc2"
CONTENIDO.txtImpDescItem2.Name = "txtImpDescItem2"
CONTENIDO.txtPorDesc3.Name = "txtPorDesc3"
CONTENIDO.txtImpDescItem3.Name = "txtImpDescItem3"
CONTENIDO.txtPorDesc4.Name = "txtPorDesc4"
CONTENIDO.txtImpDescItem4.Name = "txtImpDescItem4"
CONTENIDO.Clsetiqueta21.Name = "Clsetiqueta21"
CONTENIDO.txtImpIVA.Name = "txtImpIVA"
CONTENIDO.Clsetiqueta22.Name = "Clsetiqueta22"
CONTENIDO.txtSTNeto.Name = "txtSTNeto"
CONTENIDO.CLSETIQUETA13.Name = "CLSETIQUETA13"
CONTENIDO.txtSubTotal.Name = "txtSubTotal"
CONTENIDO.Clsetiqueta23.Name = "Clsetiqueta23"
CONTENIDO.txtPrNeto.Name = "txtPrNeto"
CONTENIDO.lblExistencia.Name = "lblExistencia"
CONTENIDO.txtExistencia.Name = "txtExistencia"
CONTENIDO.Name = "CONTENIDO"
mov_stock.Name = "mov_stock"

*** METODOS ***
PROCEDURE Init
thisform.ShowTips = .T.
Thisform.Closable = .F.
DODEFAULT()

ENDPROC
PROCEDURE CONTENIDO.SEL_CLIENTE.recuperar_datos
DODEFAULT()
Thisform.Contenido.btnGrabar.Enabled = .T.
ENDPROC
PROCEDURE CONTENIDO.btnGrabar.Click
DODEFAULT()
IF Thisform.cerrar_cbte THEN
	Thisform.blanquear()
	Thisform.Hide()
ENDIF
ENDPROC
PROCEDURE CONTENIDO.CLSCERRAR1.Click
Thisform.Hide()
ENDPROC


************************************************************
OBJETO: cls_cbtes_m2_sf
************************************************************
*** PROPIEDADES ***
Arial, 0, 9, 5, 15, 12, 32, 3, 0
Arial, 1, 8, 5, 14, 11, 29, 3, 0
Arial, 1, 9, 6, 15, 12, 32, 3, 0

*** METODOS ***


************************************************************
OBJETO: cl_stk_insufi
************************************************************
*** PROPIEDADES ***
DataSession = 1
Height = 340
Width = 819
DoCreate = .T.
BorderStyle = 2
Caption = "Stocks insuficiente"
Name = "cl_stk_insufi"

*** METODOS ***
PROCEDURE llenar_datos
SELECT cur_StkInsu
thisform.grdArticulos.RecordSource = "cur_StkInsu"
thisform.grdArticulos.alias_name = "cur_StkInsu"
thisform.grdArticulos.list_controlsource = "codArt,descripcio,stock_disp,cantFC"
thisform.grdArticulos.lista_ancho_cols = "100,200,70,70"
thisform.grdArticulos.titulos_cabeceras = "Código,Descripción,Stk.Disp,Cant.FC"
thisform.grdArticulos.generar_grid()


ENDPROC
PROCEDURE Init
DODEFAULT()

ENDPROC


************************************************************
OBJETO: grdArticulos
************************************************************
*** PROPIEDADES ***
Height = 292
Left = 0
Top = 0
Width = 820
permitir_busqueda = .F.
permitir_ordenamiento = .F.
Name = "grdArticulos"
COLUMN1.Header1.Name = "Header1"
COLUMN1.Text1.Name = "Text1"
COLUMN1.Name = "COLUMN1"
COLUMN2.Header1.Name = "Header1"
COLUMN2.Text1.Name = "Text1"
COLUMN2.Name = "COLUMN2"
COLUMN3.Header1.Name = "Header1"
COLUMN3.Text1.Name = "Text1"
COLUMN3.Name = "COLUMN3"
COLUMN4.Header1.Name = "Header1"
COLUMN4.Text1.Name = "Text1"
COLUMN4.Name = "COLUMN4"
COLUMN5.Header1.Name = "Header1"
COLUMN5.Text1.Name = "Text1"
COLUMN5.Name = "COLUMN5"
COLUMN6.Header1.Name = "Header1"
COLUMN6.Text1.Name = "Text1"
COLUMN6.Name = "COLUMN6"
COLUMN7.Header1.Name = "Header1"
COLUMN7.Text1.Name = "Text1"
COLUMN7.Name = "COLUMN7"
COLUMN8.Header1.Name = "Header1"
COLUMN8.Text1.Name = "Text1"
COLUMN8.Name = "COLUMN8"
COLUMN9.Header1.Name = "Header1"
COLUMN9.Text1.Name = "Text1"
COLUMN9.Name = "COLUMN9"
COLUMN10.Header1.Name = "Header1"
COLUMN10.Text1.Name = "Text1"
COLUMN10.Name = "COLUMN10"
COLUMN11.Header1.Name = "Header1"
COLUMN11.Text1.Name = "Text1"
COLUMN11.Name = "COLUMN11"
COLUMN12.Header1.Name = "Header1"
COLUMN12.Text1.Name = "Text1"
COLUMN12.Name = "COLUMN12"
COLUMN13.Header1.Name = "Header1"
COLUMN13.Text1.Name = "Text1"
COLUMN13.Name = "COLUMN13"
COLUMN14.Header1.Name = "Header1"
COLUMN14.Text1.Name = "Text1"
COLUMN14.Name = "COLUMN14"
COLUMN15.Header1.Name = "Header1"
COLUMN15.Text1.Name = "Text1"
COLUMN15.Name = "COLUMN15"
COLUMN16.Header1.Name = "Header1"
COLUMN16.Text1.Name = "Text1"
COLUMN16.Name = "COLUMN16"
COLUMN17.Header1.Name = "Header1"
COLUMN17.Text1.Name = "Text1"
COLUMN17.Name = "COLUMN17"
COLUMN18.Header1.Name = "Header1"
COLUMN18.Text1.Name = "Text1"
COLUMN18.Name = "COLUMN18"
COLUMN19.Header1.Name = "Header1"
COLUMN19.Text1.Name = "Text1"
COLUMN19.Name = "COLUMN19"
COLUMN20.Header1.Name = "Header1"
COLUMN20.Text1.Name = "Text1"
COLUMN20.Name = "COLUMN20"

*** METODOS ***


************************************************************
OBJETO: btnCerrar
************************************************************
*** PROPIEDADES ***
Top = 293
Left = 773
Height = 44
Width = 45
Name = "btnCerrar"

*** METODOS ***


************************************************************
OBJETO: cl_stk_insufi
************************************************************
*** PROPIEDADES ***
Arial, 0, 8, 5, 14, 11, 29, 3, 0
Arial, 1, 8, 5, 14, 11, 29, 3, 0
Arial, 0, 9, 5, 15, 12, 32, 3, 0

*** METODOS ***


************************************************************
OBJETO: cls_form_saf_viewmov
************************************************************
*** PROPIEDADES ***
DataSession = 1
Height = 519
Width = 873
DoCreate = .T.
BorderStyle = 2
Caption = "Movimientos a generar"
Name = "cls_form_saf_viewmov"

*** METODOS ***
PROCEDURE Init
DODEFAULT()

SELECT cur_Movs
thisform.grdMovimientos.RecordSource = "cur_Movs"
thisform.grdMovimientos.alias_name = "cur_Movs"
thisform.grdMovimientos.list_controlsource = "idOper,cbte,tipoDoc,ptoVta,numCbte,debe,haber"
thisform.grdMovimientos.lista_ancho_cols = "70,70,70,70,100,70,70"
thisform.grdMovimientos.titulos_cabeceras = "Operación,Comprob.,Tipo,Pto.Vta.,Número,Debe,Haber"
thisform.grdMovimientos.generar_grid()

SELECT cur_CCMovs
thisform.grdControl.RecordSource = "cur_CCMovs"
thisform.grdControl.alias_name = "cur_CCMovs"
thisform.grdControl.list_controlsource = "idOper,cbte,tipoDoc,ptoVta,numCbte,haber"
thisform.grdControl.lista_ancho_cols = "70,70,70,70,100,70,70"
thisform.grdControl.titulos_cabeceras = "Operación,Comprob.,Tipo,Pto.Vta.,Número,Importe"
thisform.grdControl.generar_grid()
ENDPROC


************************************************************
OBJETO: grdMovimientos
************************************************************
*** PROPIEDADES ***
Height = 207
Left = 2
TabIndex = 2
Top = 262
Width = 870
permitir_busqueda = .F.
permitir_ordenamiento = .F.
Name = "grdMovimientos"
COLUMN1.Header1.Name = "Header1"
COLUMN1.Text1.Name = "Text1"
COLUMN1.Name = "COLUMN1"
COLUMN2.Header1.Name = "Header1"
COLUMN2.Text1.Name = "Text1"
COLUMN2.Name = "COLUMN2"
COLUMN3.Header1.Name = "Header1"
COLUMN3.Text1.Name = "Text1"
COLUMN3.Name = "COLUMN3"
COLUMN4.Header1.Name = "Header1"
COLUMN4.Text1.Name = "Text1"
COLUMN4.Name = "COLUMN4"
COLUMN5.Header1.Name = "Header1"
COLUMN5.Text1.Name = "Text1"
COLUMN5.Name = "COLUMN5"
COLUMN6.Header1.Name = "Header1"
COLUMN6.Text1.Name = "Text1"
COLUMN6.Name = "COLUMN6"
COLUMN7.Header1.Name = "Header1"
COLUMN7.Text1.Name = "Text1"
COLUMN7.Name = "COLUMN7"
COLUMN8.Header1.Name = "Header1"
COLUMN8.Text1.Name = "Text1"
COLUMN8.Name = "COLUMN8"
COLUMN9.Header1.Name = "Header1"
COLUMN9.Text1.Name = "Text1"
COLUMN9.Name = "COLUMN9"
COLUMN10.Header1.Name = "Header1"
COLUMN10.Text1.Name = "Text1"
COLUMN10.Name = "COLUMN10"
COLUMN11.Header1.Name = "Header1"
COLUMN11.Text1.Name = "Text1"
COLUMN11.Name = "COLUMN11"
COLUMN12.Header1.Name = "Header1"
COLUMN12.Text1.Name = "Text1"
COLUMN12.Name = "COLUMN12"
COLUMN13.Header1.Name = "Header1"
COLUMN13.Text1.Name = "Text1"
COLUMN13.Name = "COLUMN13"
COLUMN14.Header1.Name = "Header1"
COLUMN14.Text1.Name = "Text1"
COLUMN14.Name = "COLUMN14"
COLUMN15.Header1.Name = "Header1"
COLUMN15.Text1.Name = "Text1"
COLUMN15.Name = "COLUMN15"
COLUMN16.Header1.Name = "Header1"
COLUMN16.Text1.Name = "Text1"
COLUMN16.Name = "COLUMN16"
COLUMN17.Header1.Name = "Header1"
COLUMN17.Text1.Name = "Text1"
COLUMN17.Name = "COLUMN17"
COLUMN18.Header1.Name = "Header1"
COLUMN18.Text1.Name = "Text1"
COLUMN18.Name = "COLUMN18"
COLUMN19.Header1.Name = "Header1"
COLUMN19.Text1.Name = "Text1"
COLUMN19.Name = "COLUMN19"
COLUMN20.Header1.Name = "Header1"
COLUMN20.Text1.Name = "Text1"
COLUMN20.Name = "COLUMN20"

*** METODOS ***


************************************************************
OBJETO: btnSalir
************************************************************
*** PROPIEDADES ***
Top = 474
Left = 828
TabIndex = 3
Name = "btnSalir"

*** METODOS ***


************************************************************
OBJETO: grdControl
************************************************************
*** PROPIEDADES ***
Height = 207
Left = 2
TabIndex = 1
Top = 21
Width = 870
permitir_busqueda = .F.
permitir_ordenamiento = .F.
Name = "grdControl"
COLUMN1.Header1.Name = "Header1"
COLUMN1.Text1.Name = "Text1"
COLUMN1.Name = "COLUMN1"
COLUMN2.Header1.Name = "Header1"
COLUMN2.Text1.Name = "Text1"
COLUMN2.Name = "COLUMN2"
COLUMN3.Header1.Name = "Header1"
COLUMN3.Text1.Name = "Text1"
COLUMN3.Name = "COLUMN3"
COLUMN4.Header1.Name = "Header1"
COLUMN4.Text1.Name = "Text1"
COLUMN4.Name = "COLUMN4"
COLUMN5.Header1.Name = "Header1"
COLUMN5.Text1.Name = "Text1"
COLUMN5.Name = "COLUMN5"
COLUMN6.Header1.Name = "Header1"
COLUMN6.Text1.Name = "Text1"
COLUMN6.Name = "COLUMN6"
COLUMN7.Header1.Name = "Header1"
COLUMN7.Text1.Name = "Text1"
COLUMN7.Name = "COLUMN7"
COLUMN8.Header1.Name = "Header1"
COLUMN8.Text1.Name = "Text1"
COLUMN8.Name = "COLUMN8"
COLUMN9.Header1.Name = "Header1"
COLUMN9.Text1.Name = "Text1"
COLUMN9.Name = "COLUMN9"
COLUMN10.Header1.Name = "Header1"
COLUMN10.Text1.Name = "Text1"
COLUMN10.Name = "COLUMN10"
COLUMN11.Header1.Name = "Header1"
COLUMN11.Text1.Name = "Text1"
COLUMN11.Name = "COLUMN11"
COLUMN12.Header1.Name = "Header1"
COLUMN12.Text1.Name = "Text1"
COLUMN12.Name = "COLUMN12"
COLUMN13.Header1.Name = "Header1"
COLUMN13.Text1.Name = "Text1"
COLUMN13.Name = "COLUMN13"
COLUMN14.Header1.Name = "Header1"
COLUMN14.Text1.Name = "Text1"
COLUMN14.Name = "COLUMN14"
COLUMN15.Header1.Name = "Header1"
COLUMN15.Text1.Name = "Text1"
COLUMN15.Name = "COLUMN15"
COLUMN16.Header1.Name = "Header1"
COLUMN16.Text1.Name = "Text1"
COLUMN16.Name = "COLUMN16"
COLUMN17.Header1.Name = "Header1"
COLUMN17.Text1.Name = "Text1"
COLUMN17.Name = "COLUMN17"
COLUMN18.Header1.Name = "Header1"
COLUMN18.Text1.Name = "Text1"
COLUMN18.Name = "COLUMN18"
COLUMN19.Header1.Name = "Header1"
COLUMN19.Text1.Name = "Text1"
COLUMN19.Name = "COLUMN19"
COLUMN20.Header1.Name = "Header1"
COLUMN20.Text1.Name = "Text1"
COLUMN20.Name = "COLUMN20"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta1
************************************************************
*** PROPIEDADES ***
Caption = "Vista previa la vinculación de los comprobantes resultante"
Height = 15
Left = 5
Top = 243
Width = 355
TabIndex = 4
Name = "Clsetiqueta1"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta2
************************************************************
*** PROPIEDADES ***
Caption = "Control de movimientos que se van a generar"
Height = 15
Left = 5
Top = 2
Width = 355
TabIndex = 5
Name = "Clsetiqueta2"

*** METODOS ***


************************************************************
OBJETO: cls_form_saf_viewmov
************************************************************
*** PROPIEDADES ***
Arial, 0, 8, 5, 14, 11, 29, 3, 0
Arial, 1, 8, 5, 14, 11, 29, 3, 0
Arial, 0, 9, 5, 15, 12, 32, 3, 0

*** METODOS ***


************************************************************
OBJETO: cls_cbte_moro
************************************************************
*** PROPIEDADES ***
DataSession = 1
BorderStyle = 2
Height = 310
Width = 751
DoCreate = .T.
Caption = "Comprobantes que se encuentras con morosidad de pago"
Name = "cls_cbte_moro"

*** METODOS ***
PROCEDURE generar_registros
LOCAL lnTotal

lnTotal = 0

SELECT cur_cbtemoro
GO TOP
DO WHILE !EOF("cur_cbtemoro")
	lnTotal = lnTotal + cur_cbtemoro.saldo

	SELECT cur_cbtemoro
	SKIP
ENDDO

IF RECCOUNT("cur_cbtemoro") > 0 THEN
	GO TOP
ENDIF

thisform.grdmorosos.Refresh()
thisform.txtImpTot.Value = lnTotal
ENDPROC
PROCEDURE Init
SELECT cur_cbtemoro
thisform.grdMorosos.RecordSource = "cur_cbtemoro"
thisform.grdMorosos.alias_name = "cur_cbtemoro"
thisform.grdMorosos.list_controlsource = "cbte,tipoDoc,ptoVta,numCbte,fecEmis,fecVto, saldo"
thisform.grdMorosos.lista_ancho_cols = "70,70,70,100,100,100,70"
thisform.grdmorosos.titulos_cabeceras = "C.B.T.E.,Tipo,Pto. Vta.,Número,Emitido,Vencido,Saldo"
thisform.grdMorosos.generar_grid()

ENDPROC


************************************************************
OBJETO: grdMorosos
************************************************************
*** PROPIEDADES ***
Height = 225
Left = 2
Top = 4
Width = 743
permitir_busqueda = .F.
permitir_ordenamiento = .F.
Name = "grdMorosos"
COLUMN1.HEADER1.Name = "HEADER1"
COLUMN1.TEXT1.Name = "TEXT1"
COLUMN1.Name = "COLUMN1"
COLUMN2.HEADER1.Name = "HEADER1"
COLUMN2.TEXT1.Name = "TEXT1"
COLUMN2.Name = "COLUMN2"
COLUMN3.HEADER1.Name = "HEADER1"
COLUMN3.TEXT1.Name = "TEXT1"
COLUMN3.Name = "COLUMN3"
COLUMN4.HEADER1.Name = "HEADER1"
COLUMN4.TEXT1.Name = "TEXT1"
COLUMN4.Name = "COLUMN4"
COLUMN5.HEADER1.Name = "HEADER1"
COLUMN5.TEXT1.Name = "TEXT1"
COLUMN5.Name = "COLUMN5"
COLUMN6.HEADER1.Name = "HEADER1"
COLUMN6.TEXT1.Name = "TEXT1"
COLUMN6.Name = "COLUMN6"
COLUMN7.HEADER1.Name = "HEADER1"
COLUMN7.TEXT1.Name = "TEXT1"
COLUMN7.Name = "COLUMN7"
COLUMN8.HEADER1.Name = "HEADER1"
COLUMN8.TEXT1.Name = "TEXT1"
COLUMN8.Name = "COLUMN8"
COLUMN9.HEADER1.Name = "HEADER1"
COLUMN9.TEXT1.Name = "TEXT1"
COLUMN9.Name = "COLUMN9"
COLUMN10.HEADER1.Name = "HEADER1"
COLUMN10.TEXT1.Name = "TEXT1"
COLUMN10.Name = "COLUMN10"
COLUMN11.HEADER1.Name = "HEADER1"
COLUMN11.TEXT1.Name = "TEXT1"
COLUMN11.Name = "COLUMN11"
COLUMN12.HEADER1.Name = "HEADER1"
COLUMN12.TEXT1.Name = "TEXT1"
COLUMN12.Name = "COLUMN12"
COLUMN13.HEADER1.Name = "HEADER1"
COLUMN13.TEXT1.Name = "TEXT1"
COLUMN13.Name = "COLUMN13"
COLUMN14.HEADER1.Name = "HEADER1"
COLUMN14.TEXT1.Name = "TEXT1"
COLUMN14.Name = "COLUMN14"
COLUMN15.HEADER1.Name = "HEADER1"
COLUMN15.TEXT1.Name = "TEXT1"
COLUMN15.Name = "COLUMN15"
COLUMN16.HEADER1.Name = "HEADER1"
COLUMN16.TEXT1.Name = "TEXT1"
COLUMN16.Name = "COLUMN16"
COLUMN17.HEADER1.Name = "HEADER1"
COLUMN17.TEXT1.Name = "TEXT1"
COLUMN17.Name = "COLUMN17"
COLUMN18.HEADER1.Name = "HEADER1"
COLUMN18.TEXT1.Name = "TEXT1"
COLUMN18.Name = "COLUMN18"
COLUMN19.HEADER1.Name = "HEADER1"
COLUMN19.TEXT1.Name = "TEXT1"
COLUMN19.Name = "COLUMN19"
COLUMN20.HEADER1.Name = "HEADER1"
COLUMN20.TEXT1.Name = "TEXT1"
COLUMN20.Name = "COLUMN20"

*** METODOS ***


************************************************************
OBJETO: btnCerrar
************************************************************
*** PROPIEDADES ***
Top = 263
Left = 701
Cancel = .T.
Name = "btnCerrar"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta1
************************************************************
*** PROPIEDADES ***
Caption = "Saldo Moroso:"
Height = 15
Left = 509
Top = 240
Width = 86
Name = "Clsetiqueta1"

*** METODOS ***


************************************************************
OBJETO: txtImpTot
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 600
Top = 237
Width = 145
isnumeric = .T.
Name = "txtImpTot"

*** METODOS ***


************************************************************
OBJETO: cls_cbte_moro
************************************************************
*** PROPIEDADES ***
Arial, 0, 8, 5, 14, 11, 29, 3, 0
Arial, 1, 8, 5, 14, 11, 29, 3, 0
Arial, 0, 9, 5, 15, 12, 32, 3, 0

*** METODOS ***


************************************************************
OBJETO: frm_ajuste_ctacte
************************************************************
*** PROPIEDADES ***
Height = 235
Width = 540
DoCreate = .T.
Caption = "Ajuste de Cuenta Corriente"
cbte = 
idcc_cli = 0
idcliente = 0
idoperacion = 0
importe = 0.00
nrocbte = 
saldo = 0.00
tipodoc = 
ptovta = 
idventascab = -1
Name = "frm_ajuste_ctacte"

*** METODOS ***
PROCEDURE Activate
DODEFAULT()

thisform.contenedor.txtcbte.Value = thisform.cbte
thisform.contenedor.txttipo.Value = thisform.tipodoc
thisform.contenedor.txtnrocbte.Value = thisform.nrocbte
thisform.contenedor.txtimporte.Value = thisform.importe

thisform.contenedor.cmbajuste.AddItem("Crédito",1)
thisform.contenedor.cmbajuste.AddItem("Débito",2)
thisform.contenedor.txtimp.Value = 0.00
thisform.contenedor.cmbajuste.SetFocus()


ENDPROC


************************************************************
OBJETO: Contenedor
************************************************************
*** PROPIEDADES ***
Top = 0
Left = 0
Width = 540
Height = 300
BackColor = 241,236,235
Name = "Contenedor"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta1
************************************************************
*** PROPIEDADES ***
Caption = "Aplicado a comprobante"
Height = 15
Left = 13
Top = 17
Width = 156
Name = "Clsetiqueta1"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta2
************************************************************
*** PROPIEDADES ***
Caption = "Importe"
Height = 15
Left = 334
Top = 17
Width = 51
Name = "Clsetiqueta2"

*** METODOS ***


************************************************************
OBJETO: txtimporte
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Left = 384
Top = 12
Name = "txtimporte"

*** METODOS ***


************************************************************
OBJETO: txtcbte
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 155
Top = 12
Width = 37
Name = "txtcbte"

*** METODOS ***


************************************************************
OBJETO: txttipo
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 195
Top = 12
Width = 28
Name = "txttipo"

*** METODOS ***


************************************************************
OBJETO: txtnrocbte
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 226
Top = 12
Width = 86
Name = "txtnrocbte"

*** METODOS ***


************************************************************
OBJETO: Clslinea1
************************************************************
*** PROPIEDADES ***
Height = 1
Left = 12
Top = 39
Width = 521
Name = "Clslinea1"

*** METODOS ***


************************************************************
OBJETO: cmbajuste
************************************************************
*** PROPIEDADES ***
Height = 24
Left = 109
TabIndex = 1
Top = 57
Width = 192
cfieldname = 
Name = "cmbajuste"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta4
************************************************************
*** PROPIEDADES ***
Caption = "Ajuste de:"
Height = 15
Left = 14
Top = 62
Width = 60
Name = "Clsetiqueta4"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta5
************************************************************
*** PROPIEDADES ***
Caption = "Importe:"
Height = 15
Left = 324
Top = 62
Width = 60
Name = "Clsetiqueta5"

*** METODOS ***


************************************************************
OBJETO: txtimp
************************************************************
*** PROPIEDADES ***
Left = 379
TabIndex = 2
Top = 58
Name = "txtimp"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta6
************************************************************
*** PROPIEDADES ***
Caption = "Observaciones:"
Height = 15
Left = 14
Top = 95
Width = 96
Name = "Clsetiqueta6"

*** METODOS ***


************************************************************
OBJETO: txtobservac
************************************************************
*** PROPIEDADES ***
Height = 71
Left = 109
TabIndex = 3
Top = 97
Width = 417
Name = "txtobservac"

*** METODOS ***


************************************************************
OBJETO: btnGrabar
************************************************************
*** PROPIEDADES ***
Top = 180
Left = 436
TabIndex = 4
Name = "btnGrabar"

*** METODOS ***
PROCEDURE Click
LOCAL lcSql, loCommand, loCliente, loDT, loNumerador
LOCAL lnAjuste, lcNumAjuste, lnIdCC_Cli, lnIdOper, lcCbte, lcTipoDoc, lnPtoVta, lnNroCbte
LOCAL lcObserv, lnImporte, lnIdCC_CliOrig

loCommand = CREATEOBJECT("odbc_command")
loCliente = CREATEOBJECT("odbc_result")
loDT = CREATEOBJECT("datetime")
loNumerador = CREATEOBJECT("odbc_result")
lcSql = ""
lnAjuste = 0
lcNumAjuste = ""
lnIdVendedor = 0
lnIdCondPago = 0
lnIdSitIva = 0
lnIdCC_Cli = 0
lnIdOper = 0
lcCbte = ""
lcTipoDoc = "X"
lnPtoVta = 0
lnNroCbte = 0
lcObserv = ""
lnImporte = 0.00

lnAjuste = thisform.contenedor.cmbajuste.ListItemId
lcObserv = thisform.contenedor.txtobservac.Value
lnImporte = thisform.contenedor.txtimp.Value 
lnIdOper = thisform.idoperacion
lnIdCC_CliOrig = thisform.idcc_cli

IF lnAjuste = 1 THEN
	lcCbte = "AC"
ELSE 
	lcCbte = "AD"
ENDIF 

&& Busco los datos del cliente
lcSql = "SELECT * FROM clientes WHERE idcliente = " + ALLTRIM(STR(thisform.idcliente))
loCliente.ActiveConnection = goConn.ActiveConnection
loCliente.Cursor_Name = "cur_cliente"
loCliente.OpenQuery(lcSql)

lnIdVendedor = cur_cliente.idVendedor
lnIdCondPago = cur_cliente.idCondPago
lnIdSitIva = cur_cliente.IdSitIva

loCliente.Close_Query()

&& Inicio la transaccion
goConn.BeginTransaction

&& Busco el numero de ptovta y cbte
lcSql = "SELECT * FROM numerador WHERE cbte = '" + ALLTRIM(lcCbte) + "' and tipodoc = '" + ALLTRIM(lcTipoDoc) + "'"
loNumerador.ActiveConnection = goConn.ActiveConnection
loNumerador.cursor_name = "cur_num"
loNumerador.OpenQuery(lcSql)

IF RECCOUNT("cur_num") = 0 THEN
	MESSAGEBOX("No se encuentra configurado el numerador del comprobante " + ALLTRIM(lcCbte) + " Letra: " + ALLTRIM(lcTipoDoc), 0+48, thisform.Caption)
	loNumerador.close_query()
	goConn.Rollback()
	RETURN .F.
ENDIF

lnPtoVta = cur_num.ptovta
lnNroCbte = cur_num.numactual + 1
lcNumAjuste = REPLICATE("0", 8 - LEN(ALLTRIM(STR(lnNroCbte)))) + ALLTRIM(STR(lnNroCbte))

loNumerador.close_query()

&& Actualizo el numerador
lcSql = "update numerador set numActual = " + ALLTRIM(STR(lnNroCbte)) + ;
	" where cbte = '" + ALLTRIM(lcCbte) + "' and tipoDoc = '" + ALLTRIM(lcTipoDoc) + "'"
	
loCommand.ActiveConnection = goConn.ActiveConnection
loCommand.CommandText = lcSql

IF !loCommand.execute() THEN 
	goConn.Rollback()
	RETURN .F.
ENDIF	

&& Busco el proximo ID de la tabla CC_Cli
lnIdCC_Cli = goConn.GetNextID("cc_cli", "idCC_Cli")

IF lnIdOper = 0 THEN 
	lnIdOper = goConn.GetNextID("cc_cli", "idOper")
ENDIF 

IF ALLTRIM(lcCbte) == "AC" THEN 
	lcSql = "INSERT INTO cc_cli (idCC_Cli, idCliente, idCC_Orig, cbte, tipoDoc, ptoVta, nroCbte, fecEmis, fecVto, "
	lcSql = lcSql + "	impDebe, impHaber, idOper, observ, idCondPago, idSitIva, idVendedor, usuAlta, fecAlta, idHostAlta) "
	lcSql = lcSql + "VALUES( " + ALLTRIM(STR(lnIdCC_Cli)) + ", " + ALLTRIM(STR(thisform.idcliente)) + ", " + IIF(lnIdCC_CliOrig <> 0, ALLTRIM(STR(lnIdCC_CliOrig)), "null") + ", '" + ALLTRIM(lcCbte) + "', '"
	lcSql = lcSql + 	ALLTRIM(lcTipoDoc) + "', " + ALLTRIM(STR(lnPtoVta)) + ", " + ALLTRIM(STR(lnNroCbte)) + ", " 
	lcSql = lcSql + 	loDT.getdatetime() + ", " + loDT.getdatetime() + ", 0, " + ALLTRIM(STR(lnImporte, 10, 2)) + ", " 
	lcSql = lcSql + 	ALLTRIM(STR(lnIdOper)) + ", '" + ALLTRIM(lcObserv) + "', " + ALLTRIM(STR(lnIdCondPago)) + ", "
	lcSql = lcSql + 	ALLTRIM(STR(lnIdSitIva)) + ", " + ALLTRIM(STR(lnIdVendedor)) + ", '" + ALLTRIM(gcCodUsu) + "', " + loDT.getDateTime() + ", '" + SYS(0) + "')"
ELSE 
	lcSql = "INSERT INTO cc_cli (idCC_Cli, idCliente, idCC_Orig, cbte, tipoDoc, ptoVta, nroCbte, fecEmis, fecVto, "
	lcSql = lcSql + "	impDebe, impHaber, idOper, observ, idCondPago, idSitIva, idVendedor, usuAlta, fecAlta, idHostAlta) "
	lcSql = lcSql + "VALUES( " + ALLTRIM(STR(lnIdCC_Cli)) + ", " + ALLTRIM(STR(thisform.idcliente)) + ", " + IIF(lnIdCC_CliOrig <> 0, ALLTRIM(STR(lnIdCC_CliOrig)), "null") + ", '" + ALLTRIM(lcCbte) + "', '"
	lcSql = lcSql + 	ALLTRIM(lcTipoDoc) + "', " + ALLTRIM(STR(lnPtoVta)) + ", " + ALLTRIM(STR(lnNroCbte)) + ", " 
	lcSql = lcSql + 	loDT.getdatetime() + ", " + loDT.getdatetime() + ", " + ALLTRIM(STR(lnImporte, 10, 2)) + ", 0, " 
	lcSql = lcSql + 	ALLTRIM(STR(lnIdOper)) + ", '" + ALLTRIM(lcObserv) + "', " + ALLTRIM(STR(lnIdCondPago)) + ", "
	lcSql = lcSql + 	ALLTRIM(STR(lnIdSitIva)) + ", " + ALLTRIM(STR(lnIdVendedor)) + ", '" + ALLTRIM(gcCodUsu) + "', " + loDT.getDateTime() + ", '" + SYS(0) + "')"
ENDIF 

loCommand.ActiveConnection = goConn.ActiveConnection
loCommand.CommandText = lcSql

IF !loCommand.execute() THEN
	goConn.Rollback()
	RETURN .F.
ENDIF

&& Actualizar el saldo de la factura seleccionada
&&IF thisform.idventascab <> -1 THEN 
	IF ALLTRIM(lcCbte) == "AC" THEN
		lcSql = "UPDATE ventascab SET Saldo = Saldo - " + ALLTRIM(STR(Thisform.contenedor.txtimp.Value, 10, 2)) + ", "
		lcSql = lcSql + "usuModi = '" + ALLTRIM(gcCodUsu) + "', "
		lcSql = lcSql + "fecModi = " + loDT.getDateTime() + ", "
		lcSql = lcSql + "idHostModi = '" + ALLTRIM(SYS(0)) + "' "
		lcSql = lcSql + "WHERE idVentasC IN (SELECT IdVentasC FROM cc_cli WHERE IdOper = " +  ALLTRIM(STR(lnIdOper)) + " AND cbte like 'FC%')"
	ELSE 
		lcSql = "UPDATE ventascab SET Saldo = Saldo + " + ALLTRIM(STR(Thisform.contenedor.txtimp.Value, 10, 2)) + ", "
		lcSql = lcSql + "usuModi = '" + ALLTRIM(gcCodUsu) + "', "
		lcSql = lcSql + "fecModi = " + loDT.getDateTime() + ", "
		lcSql = lcSql + "idHostModi = '" + ALLTRIM(SYS(0)) + "' "
		lcSql = lcSql + "WHERE idVentasC IN (SELECT IdVentasC FROM cc_cli WHERE IdOper = " +  ALLTRIM(STR(lnIdOper)) + " AND cbte like 'FC%')"
	ENDIF
		
	loCommand.CommandText = lcSql
	loCommand.ActiveConnection = goConn.ActiveConnection

	IF !loCommand.Execute()
		goConn.Rollback()
		RETURN .F.
	ENDIF 
&&ENDIF 

goConn.Commit()

IF lcCbte = "AC" THEN 
	MESSAGEBOX("El Ajuste de Crédito " + ALLTRIM(lcNumAjuste) + " se ha generado exitosamente", 0+64, thisform.Caption)
ELSE
	MESSAGEBOX("El Ajuste de Débito " + ALLTRIM(lcNumAjuste) + " se ha generado exitosamente", 0+64, thisform.Caption)
ENDIF 

thisform.Release()

ENDPROC


************************************************************
OBJETO: btnSalir
************************************************************
*** PROPIEDADES ***
Top = 180
Left = 484
Cancel = .T.
TabIndex = 5
Name = "btnSalir"

*** METODOS ***


************************************************************
OBJETO: frm_ajuste_ctacte
************************************************************
*** PROPIEDADES ***
Arial, 0, 8, 5, 14, 11, 29, 3, 0
Arial, 1, 8, 5, 14, 11, 29, 3, 0
Arial, 0, 9, 5, 15, 12, 32, 3, 0

*** METODOS ***


************************************************************
OBJETO: cls_frm_linkedcbtes
************************************************************
*** PROPIEDADES ***
BorderStyle = 2
Height = 336
Width = 760
DoCreate = .T.
Caption = "Comprobantes vinculados"
nrocbte = 
idventasc = 0
Name = "cls_frm_linkedcbtes"

*** METODOS ***
PROCEDURE leer_datos
LOCAL loResVC, loResVR, loRes
LOCAL lcSql

loResVC = CREATEOBJECT("odbc_result")
loResVR = CREATEOBJECT("odbc_result")
loRes = CREATEOBJECT("odbc_result")
lcSql = ""

Thisform.txtNumero.Value = Thisform.nrocbte

lcSql = "SELECT ventasrel.idVtaCD, ventasrel.idVtaCO FROM ventasrel WHERE idVtaCO = " + ALLTRIM(STR(thisform.idventasc))
loResVR.ActiveConnection = goConn.ActiveConnection
loResVR.Cursor_Name = "cur_vr"

IF !loResVR.OpenQuery(lcSql) THEN
	MESSAGEBOX(loResVR.Error_Message, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

SELECT cur_vr
GO TOP

lcSql = "SELECT		ventascab.idVentasC, "
lcSql = lcSql + "	ventascab.fecEmision, "
lcSql = lcSql + "	ventascab.fecVto, "
lcSql = lcSql + "	ventascab.cbte, "
lcSql = lcSql + "	ventascab.tipoDoc, "
lcSql = lcSql + "	ventascab.ptoVta, "
lcSql = lcSql + "	ventascab.numCbte, "
lcSql = lcSql + "	ventascab.totFact "
lcSql = lcSql + "FROM ventascab "
lcSql = lcSql + "WHERE idVentasC = " + ALLTRIM(STR(cur_vr.idVtaCD))

loResVC.ActiveConnection = goConn.ActiveConnection
loResVC.Cursor_Name = "cur_x"

IF !loResVC.OpenQuery(lcSql) THEN
	MESSAGEBOX(loRes.Error_Message, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

SELECT cur_x
IF RECCOUNT("cur_x") > 0 THEN
	GO TOP
ENDIF

DO WHILE !EOF("cur_x")
	SELECT cur_cbtes
	APPEND BLANK
	REPLACE cur_cbtes.idVentasC WITH cur_x.idVentasC
	REPLACE cur_cbtes.fecEmision WITH cur_x.fecEmision ADDITIVE
	REPLACE cur_cbtes.fecVto WITH cur_x.fecVto ADDITIVE
	REPLACE cur_cbtes.cbte WITH cur_x.cbte ADDITIVE
	REPLACE cur_cbtes.tipoDoc WITH cur_x.tipoDoc ADDITIVE
	REPLACE cur_cbtes.ptoVta WITH REPLICATE("0", 4 - LEN(ALLTRIM(STR(cur_x.ptoVta)))) + ALLTRIM(STR(cur_x.ptoVta)) ADDITIVE
	REPLACE cur_cbtes.nroCbte WITH REPLICATE("0", 8 - LEN(ALLTRIM(STR(cur_x.numCbte)))) + ALLTRIM(STR(cur_x.numCbte)) ADDITIVE
	REPLACE cur_cbtes.totFact WITH cur_x.totFact ADDITIVE
	
	&& Ahora levanto los comprobantes asociados al comprobante vinculado
	lcSql = "SELECT		ventascab.idVentasC, "
	lcSql = lcSql + "	ventascab.fecEmision, "
	lcSql = lcSql + "	ventascab.fecVto, "
	lcSql = lcSql + "	ventascab.cbte, "
	lcSql = lcSql + "	ventascab.tipoDoc, "
	lcSql = lcSql + "	ventascab.ptoVta, "
	lcSql = lcSql + "	ventascab.numCbte, "
	lcSql = lcSql + "	ventascab.totFact "
	lcSql = lcSql + "FROM ventascab "
	lcSql = lcSql + "WHERE ventascab.cbte != 'PED' "
	lcSql = lcSql + "	AND ventascab.idVentasC IN ( "
	lcSql = lcSql + "		SELECT idVtaCD FROM ventasrel WHERE idVtaCO = " + ALLTRIM(STR(cur_x.idVentasC)) + ")"
	
	loRes.ActiveConnection = goConn.ActiveConnection
	loRes.Cursor_Name = "cur_x1"
	
	IF !loRes.OpenQuery(lcSql) THEN
		MESSAGEBOX(loRes.Error_Message, 0+48, Thisform.Caption)
		RETURN .F.
	ENDIF
	
	SELECT cur_x1
	GO TOP
	
	DO WHILE !EOF("cur_x1")
		SELECT cur_cbtes
		APPEND BLANK
		REPLACE cur_cbtes.idVentasC WITH cur_x1.idVentasC
		REPLACE cur_cbtes.fecEmision WITH cur_x1.fecEmision ADDITIVE
		REPLACE cur_cbtes.fecVto WITH cur_x1.fecVto ADDITIVE
		REPLACE cur_cbtes.cbte WITH cur_x1.cbte ADDITIVE
		REPLACE cur_cbtes.tipoDoc WITH cur_x1.tipoDoc ADDITIVE
		REPLACE cur_cbtes.ptoVta WITH REPLICATE("0", 4 - LEN(ALLTRIM(STR(cur_x1.ptoVta)))) + ALLTRIM(STR(cur_x1.ptoVta)) ADDITIVE
		REPLACE cur_cbtes.nroCbte WITH REPLICATE("0", 8 - LEN(ALLTRIM(STR(cur_x1.numCbte)))) + ALLTRIM(STR(cur_x1.numCbte)) ADDITIVE
		REPLACE cur_cbtes.totFact WITH cur_x1.totFact ADDITIVE		
	
		SELECT cur_x1
		SKIP
	ENDDO
	
	loRes.Close_Query()
	
	SELECT cur_x
	SKIP
ENDDO

loResVR.Close_Query()
loResVC.Close_Query()

Thisform.grdSegCpr.Refresh()
RETURN .T.
ENDPROC
PROCEDURE Init
SELECT cur_cbtes
GO TOP
Thisform.grdSegCpr.alias_name = "cur_cbtes"
Thisform.grdSegCpr.RecordSource = "cur_cbtes"
Thisform.grdSegCpr.list_controlsource = "fecEmision,fecVto,cbte,tipoDoc,ptoVta,nroCbte,totFact"
Thisform.grdSegCpr.lista_ancho_cols = "100,100,100,70,70,100,70"
Thisform.grdSegCpr.titulos_cabeceras = "Fecha Emis.,Fec. Vto.,Compr.,Letra,P. Vta.,Nro. Comp.,Total"
Thisform.grdSegCpr.generar_grid()

ENDPROC
PROCEDURE Load
DODEFAULT()

CREATE CURSOR cur_cbtes ( ;
	idVentasC	int,;
	fecEmision	DATE,;
	fecVto		DATE,;
	cbte		varchar(3),;
	tipoDoc		varchar(1),;
	ptoVta		varchar(4),;
	nroCbte		varchar(8),;
	totFact		float(10, 2))
	

ENDPROC


************************************************************
OBJETO: Clsetiqueta1
************************************************************
*** PROPIEDADES ***
Caption = "Comprobante seleccionado:"
Height = 15
Left = 12
Top = 12
Width = 168
Name = "Clsetiqueta1"

*** METODOS ***


************************************************************
OBJETO: txtNumero
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 175
ReadOnly = .T.
Top = 9
Width = 162
ischaracter = .T.
Name = "txtNumero"

*** METODOS ***


************************************************************
OBJETO: grdSegCpr
************************************************************
*** PROPIEDADES ***
Height = 241
Left = 3
Top = 36
Width = 754
permitir_busqueda = .F.
permitir_ordenamiento = .F.
Name = "grdSegCpr"
COLUMN1.Header1.Name = "Header1"
COLUMN1.Text1.Name = "Text1"
COLUMN1.Name = "COLUMN1"
COLUMN2.Header1.Name = "Header1"
COLUMN2.Text1.Name = "Text1"
COLUMN2.Name = "COLUMN2"
COLUMN3.Header1.Name = "Header1"
COLUMN3.Text1.Name = "Text1"
COLUMN3.Name = "COLUMN3"
COLUMN4.Header1.Name = "Header1"
COLUMN4.Text1.Name = "Text1"
COLUMN4.Name = "COLUMN4"
COLUMN5.Header1.Name = "Header1"
COLUMN5.Text1.Name = "Text1"
COLUMN5.Name = "COLUMN5"
COLUMN6.Header1.Name = "Header1"
COLUMN6.Text1.Name = "Text1"
COLUMN6.Name = "COLUMN6"
COLUMN7.Header1.Name = "Header1"
COLUMN7.Text1.Name = "Text1"
COLUMN7.Name = "COLUMN7"
COLUMN8.Header1.Name = "Header1"
COLUMN8.Text1.Name = "Text1"
COLUMN8.Name = "COLUMN8"
COLUMN9.Header1.Name = "Header1"
COLUMN9.Text1.Name = "Text1"
COLUMN9.Name = "COLUMN9"
COLUMN10.Header1.Name = "Header1"
COLUMN10.Text1.Name = "Text1"
COLUMN10.Name = "COLUMN10"
COLUMN11.Header1.Name = "Header1"
COLUMN11.Text1.Name = "Text1"
COLUMN11.Name = "COLUMN11"
COLUMN12.Header1.Name = "Header1"
COLUMN12.Text1.Name = "Text1"
COLUMN12.Name = "COLUMN12"
COLUMN13.Header1.Name = "Header1"
COLUMN13.Text1.Name = "Text1"
COLUMN13.Name = "COLUMN13"
COLUMN14.Header1.Name = "Header1"
COLUMN14.Text1.Name = "Text1"
COLUMN14.Name = "COLUMN14"
COLUMN15.Header1.Name = "Header1"
COLUMN15.Text1.Name = "Text1"
COLUMN15.Name = "COLUMN15"
COLUMN16.Header1.Name = "Header1"
COLUMN16.Text1.Name = "Text1"
COLUMN16.Name = "COLUMN16"
COLUMN17.Header1.Name = "Header1"
COLUMN17.Text1.Name = "Text1"
COLUMN17.Name = "COLUMN17"
COLUMN18.Header1.Name = "Header1"
COLUMN18.Text1.Name = "Text1"
COLUMN18.Name = "COLUMN18"
COLUMN19.Header1.Name = "Header1"
COLUMN19.Text1.Name = "Text1"
COLUMN19.Name = "COLUMN19"
COLUMN20.Header1.Name = "Header1"
COLUMN20.Text1.Name = "Text1"
COLUMN20.Name = "COLUMN20"

*** METODOS ***


************************************************************
OBJETO: btnSalir
************************************************************
*** PROPIEDADES ***
Top = 287
Left = 713
Name = "btnSalir"

*** METODOS ***


************************************************************
OBJETO: cls_frm_linkedcbtes
************************************************************
*** PROPIEDADES ***
Arial, 0, 8, 5, 14, 11, 29, 3, 0
Arial, 1, 8, 5, 14, 11, 29, 3, 0
Arial, 0, 9, 5, 15, 12, 32, 3, 0

*** METODOS ***


************************************************************
OBJETO: clsformcbtes_cf
************************************************************
*** PROPIEDADES ***
DoCreate = .T.
usar_fiscal = .T.
Name = "clsformcbtes_cf"
contenido.Clsetiqueta1.Name = "Clsetiqueta1"
contenido.sel_Cliente.txtCodigo.Name = "txtCodigo"
contenido.sel_Cliente.txtDescripcion.Name = "txtDescripcion"
contenido.sel_Cliente.Name = "sel_Cliente"
contenido.Clsetiqueta2.Name = "Clsetiqueta2"
contenido.Clsetiqueta3.Name = "Clsetiqueta3"
contenido.txtSitIVA.Name = "txtSitIVA"
contenido.sel_FormaPago.txtCodigo.Name = "txtCodigo"
contenido.sel_FormaPago.txtDescripcion.Name = "txtDescripcion"
contenido.sel_FormaPago.Name = "sel_FormaPago"
contenido.Clslinea1.Name = "Clslinea1"
contenido.Clsetiqueta4.Name = "Clsetiqueta4"
contenido.sel_Articulo.txtCodigo.Name = "txtCodigo"
contenido.sel_Articulo.txtDescripcion.Name = "txtDescripcion"
contenido.sel_Articulo.Name = "sel_Articulo"
contenido.Clsetiqueta5.Name = "Clsetiqueta5"
contenido.txtCantidad.Name = "txtCantidad"
contenido.btnAgregar.Name = "btnAgregar"
contenido.grdDetalles.COLUMN1.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN1.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN1.Name = "COLUMN1"
contenido.grdDetalles.COLUMN2.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN2.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN2.Name = "COLUMN2"
contenido.grdDetalles.COLUMN3.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN3.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN3.Name = "COLUMN3"
contenido.grdDetalles.COLUMN4.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN4.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN4.Name = "COLUMN4"
contenido.grdDetalles.COLUMN5.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN5.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN5.Name = "COLUMN5"
contenido.grdDetalles.COLUMN6.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN6.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN6.Name = "COLUMN6"
contenido.grdDetalles.COLUMN7.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN7.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN7.Name = "COLUMN7"
contenido.grdDetalles.COLUMN8.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN8.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN8.Name = "COLUMN8"
contenido.grdDetalles.COLUMN9.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN9.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN9.Name = "COLUMN9"
contenido.grdDetalles.COLUMN10.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN10.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN10.Name = "COLUMN10"
contenido.grdDetalles.COLUMN11.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN11.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN11.Name = "COLUMN11"
contenido.grdDetalles.COLUMN12.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN12.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN12.Name = "COLUMN12"
contenido.grdDetalles.COLUMN13.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN13.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN13.Name = "COLUMN13"
contenido.grdDetalles.COLUMN14.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN14.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN14.Name = "COLUMN14"
contenido.grdDetalles.COLUMN15.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN15.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN15.Name = "COLUMN15"
contenido.grdDetalles.COLUMN16.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN16.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN16.Name = "COLUMN16"
contenido.grdDetalles.COLUMN17.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN17.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN17.Name = "COLUMN17"
contenido.grdDetalles.COLUMN18.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN18.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN18.Name = "COLUMN18"
contenido.grdDetalles.COLUMN19.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN19.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN19.Name = "COLUMN19"
contenido.grdDetalles.COLUMN20.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN20.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN20.Name = "COLUMN20"
contenido.grdDetalles.Name = "grdDetalles"
contenido.btnGrabar.Name = "btnGrabar"
contenido.btnCancelar.Name = "btnCancelar"
contenido.Clscerrar1.Name = "Clscerrar1"
contenido.Clsetiqueta10.Name = "Clsetiqueta10"
contenido.txtPrMay.Name = "txtPrMay"
contenido.Clsetiqueta11.Name = "Clsetiqueta11"
contenido.txtPrMinorista.Name = "txtPrMinorista"
contenido.Clsetiqueta12.Name = "Clsetiqueta12"
contenido.txtAlicIVA.Name = "txtAlicIVA"
contenido.chkCalcIVA.Alignment = 0
contenido.chkCalcIVA.Name = "chkCalcIVA"
contenido.btnEliminar.Name = "btnEliminar"
contenido.chkImprimeDup.Alignment = 0
contenido.chkImprimeDup.Name = "chkImprimeDup"
contenido.btnCbteOrigen.Name = "btnCbteOrigen"
contenido.txtObserv.MaxLength = 100
contenido.txtObserv.Name = "txtObserv"
contenido.Clsetiqueta6.Name = "Clsetiqueta6"
contenido.Clsetiqueta7.Name = "Clsetiqueta7"
contenido.Clsetiqueta8.Name = "Clsetiqueta8"
contenido.Clsetiqueta9.Name = "Clsetiqueta9"
contenido.txtTotNeto.Name = "txtTotNeto"
contenido.txtPorIVA21.Name = "txtPorIVA21"
contenido.txtPorIVA105.Name = "txtPorIVA105"
contenido.txtImpIVA21.Name = "txtImpIVA21"
contenido.txtImpIVA105.Name = "txtImpIVA105"
contenido.txtTotal.Name = "txtTotal"
contenido.Clsetiqueta14.Name = "Clsetiqueta14"
contenido.txtDesc1.Name = "txtDesc1"
contenido.txtDesc2.Name = "txtDesc2"
contenido.txtDesc3.Name = "txtDesc3"
contenido.txtDesc4.Name = "txtDesc4"
contenido.txtImpDesc1.Name = "txtImpDesc1"
contenido.txtImpDesc2.Name = "txtImpDesc2"
contenido.txtImpDesc3.Name = "txtImpDesc3"
contenido.txtImpDesc4.Name = "txtImpDesc4"
contenido.Clsetiqueta15.Name = "Clsetiqueta15"
contenido.Clsetiqueta16.Name = "Clsetiqueta16"
contenido.Clsetiqueta17.Name = "Clsetiqueta17"
contenido.txtTotFact.Name = "txtTotFact"
contenido.Clsetiqueta18.Name = "Clsetiqueta18"
contenido.txtPorIIBB.Name = "txtPorIIBB"
contenido.txtImpIIBB.Name = "txtImpIIBB"
contenido.Clsetiqueta19.Name = "Clsetiqueta19"
contenido.txtST.Name = "txtST"
contenido.Clsetiqueta20.Name = "Clsetiqueta20"
contenido.txtPorDesc1.Name = "txtPorDesc1"
contenido.txtImpDescItem1.Name = "txtImpDescItem1"
contenido.txtPorDesc2.Name = "txtPorDesc2"
contenido.txtImpDescItem2.Name = "txtImpDescItem2"
contenido.txtPorDesc3.Name = "txtPorDesc3"
contenido.txtImpDescItem3.Name = "txtImpDescItem3"
contenido.txtPorDesc4.Name = "txtPorDesc4"
contenido.txtImpDescItem4.Name = "txtImpDescItem4"
contenido.Clsetiqueta21.Name = "Clsetiqueta21"
contenido.txtImpIVA.Name = "txtImpIVA"
contenido.Clsetiqueta22.Name = "Clsetiqueta22"
contenido.txtSTNeto.Name = "txtSTNeto"
contenido.Clsetiqueta13.Name = "Clsetiqueta13"
contenido.txtSubTotal.Name = "txtSubTotal"
contenido.Clsetiqueta23.Name = "Clsetiqueta23"
contenido.txtPrNeto.Name = "txtPrNeto"
contenido.lblExistencia.Name = "lblExistencia"
contenido.txtExistencia.Name = "txtExistencia"
contenido.Clsetiqueta24.Name = "Clsetiqueta24"
contenido.txtPorRec.Enabled = .T.
contenido.txtPorRec.Name = "txtPorRec"
contenido.txtImpRec.Name = "txtImpRec"
contenido.txtRecItem.Name = "txtRecItem"
contenido.Clsetiqueta25.Name = "Clsetiqueta25"
contenido.txtTelefono.Name = "txtTelefono"
contenido.Clsetiqueta26.Name = "Clsetiqueta26"
contenido.txtcuit.Name = "txtcuit"
contenido.Clsetiqueta27.Name = "Clsetiqueta27"
contenido.cboUnidVta.Name = "cboUnidVta"
contenido.txtCantPack.Name = "txtCantPack"
contenido.Name = "contenido"
mov_stock.Name = "mov_stock"
faltantes.Name = "faltantes"

*** METODOS ***
PROCEDURE enviar_fiscal
LOCAL lcDireccion, lcDesc, lnImpItem, lnImpItemNeto, lnPorIIBB, lnImpIIBB, lnimpIva

lnImpItem = 0.00
lnImpItemNeto = 0.00
lnPorIIBB = 0.00
lnImpIIBB = 0.00
lnimpIva = 0.00

lcDireccion = ALLTRIM(Thisform.cli_calle) + " " + ALLTRIM(Thisform.cli_Codpostal) + " " + ALLTRIM(Thisform.cli_Localidad) + " " + ALLTRIM(Thisform.cli_pcia)
lnPorIIBB = Thisform.contenido.txtporiiBB.Value 
lnImpIIBB = Thisform.contenido.txtimpiiBB.Value 

Thisform.Fiscal.Puerto = 1
Thisform.Fiscal.Comenzar()
Thisform.Fiscal.usarASCII = .F.
Thisform.Fiscal.Modelo = 8  && MODELO_P320
Thisform.Fiscal.TratarDeCancelarTodo()
Thisform.Fiscal.DescripcionesLargas = .T.
Thisform.Fiscal.ReintentoConstante = .T.
&&Thisform.Fiscal.DatosCliente(ALLTRIM(STR(thisform.contenido.sel_cliente.txtCodigo.Value)) + " - " + ALLTRIM(Thisform.Contenido.sel_Cliente.txtDescripcion.Value), ALLTRIM(Thisform.cli_cuit), IIF(thisform.codivafiscal = 67, 50, 67), Thisform.codivafiscal, lcDireccion)
Thisform.Fiscal.DatosCliente(ALLTRIM(STR(thisform.contenido.sel_cliente.txtCodigo.Value)) + " - " + ALLTRIM(Thisform.Contenido.sel_Cliente.txtDescripcion.Value), ALLTRIM(Thisform.contenido.txtcuit.Value), IIF(thisform.codivafiscal = 67, 50, 67), Thisform.codivafiscal, lcDireccion)

* Configuración del controlador
&&Thisform.Fiscal.ConfigurarControladorCompleto(.T., .F., 10000, 10000, 0.00, 1, .F., .F., 70, .F., .F., "", .T., 79, 78, 84, 65)

&& Pruebo configurar un absurdo en el limite de facturacion en comprobantes B
* thisform.fiscal.configurarControladorCompleto(.F., .T., 999999.99, 999999.99, 0, 1)

IF ALLTRIM(Thisform.cbte) == "FC" THEN
	IF ALLTRIM(Thisform.tipodoc) == "A" THEN
		Thisform.Fiscal.AbrirComprobanteFiscal(48)	&& FACTURA A
	ELSE
		Thisform.Fiscal.AbrirComprobanteFiscal(49)	&& FACTURA B
	ENDIF
ELSE
	IF ALLTRIM(Thisform.cbte) == "NC" THEN
		Thisform.Fiscal.InformacionRemito(1) = " "
		
		IF ALLTRIM(Thisform.tipodoc) == "A" THEN
			Thisform.Fiscal.AbrirComprobanteNoFiscalHomologado(82)	&& NOTA DE CREDITO A
		ELSE
			Thisform.Fiscal.AbrirComprobanteNoFiscalHomologado(83)	&& NOTA DE CREDITO B
		ENDIF
	ENDIF
ENDIF

SELECT cur_Detalle
IF RECCOUNT("cur_Detalle") > 0 THEN
	GO TOP
ENDIF

DO WHILE !EOF("cur_Detalle")
	lcDesc = ALLTRIM(cur_Detalle.codArt) + REPLICATE(" ", 20 - LEN(ALLTRIM(cur_Detalle.codArt))) + "-" + SUBSTR(ALLTRIM(cur_Detalle.Descripcio), 1, 25)
	
	&&lnImpItemNeto = ROUND(cur_Detalle.prVta, 2)
	&&lnImpItem = (ROUND(cur_Detalle.impNeto, 2) + (ROUND(cur_Detalle.impIVA, 2) / ROUND(cur_Detalle.cantidad, 2)))
	&&Thisform.Fiscal.ImprimirItem(ALLTRIM(lcDesc), ROUND(cur_Detalle.Cantidad, 2), ROUND(lnImpItem, 2), ROUND(cur_Detalle.alicIVA, 2), 0)

	lnImpItemNeto = ROUND(cur_Detalle.prVta, 2)
	lnimpIva = cur_Detalle.impNeto * (cur_Detalle.alicIVA / 100) && No hago el redondeo porque sino me va a quedar un importe distinto al grabado en la BD, dejo que redondee la fiscal
	lnImpItem = cur_Detalle.impNeto + lnimpIva 
	Thisform.Fiscal.ImprimirItem(ALLTRIM(lcDesc), ROUND(cur_Detalle.Cantidad, 2), lnImpItem, ROUND(cur_Detalle.alicIVA, 2), 0)


	SELECT cur_Detalle
	SKIP
ENDDO

Thisform.Fiscal.EspecificarPercepcionGlobal("Perc. IIBB. %" + ALLTRIM(STR(lnPorIIBB)), lnImpIIBB)

IF Thisform.Contenido.txtPorRec.Value <> 0 THEN
	Thisform.Fiscal.DescuentoGeneral("Recargo por compra con Tarjeta de Crédito", Thisform.contenido.txtImpRec.Value, .F.) 
ENDIF

IF ALLTRIM(thisform.contenido.txtObserv.Value) == "" THEN
	Thisform.Fiscal.Encabezado(11) = ""
ELSE 
	Thisform.Fiscal.Encabezado(11) = ALLTRIM(Thisform.contenido.txtObserv.Value)
ENDIF

Thisform.Fiscal.Subtotal(.T.)
IF ALLTRIM(Thisform.cbte) == "FC" THEN
	Thisform.Fiscal.CerrarComprobanteFiscal()
ELSE
	Thisform.Fiscal.CerrarComprobanteNoFiscalHomologado()
ENDIF

Thisform.fis_numcbte = INT(VAL(Thisform.Fiscal.Respuesta(3)))	&& Devuelvo el número de comprobante a grabar

Thisform.Fiscal.Finalizar()
ENDPROC
PROCEDURE contenido.btnGrabar.Click
IF !Thisform.ValidarCampos()
	RETURN .F.
ENDIF

IF !thisform.agregar_item() THEN
	MESSAGEBOX("Ha ocurrido un error mientras se estaba preparando los ítems para facturar", 0+48, thisform.Caption)
	RETURN .F.
ENDIF

IF !thisform.grabar()
	MESSAGEBOX("Error al intentar grabar el comprobante", 0+16, Thisform.Caption)
	RETURN .F.
ENDIF

IF (ALLTRIM(Thisform.cbte) == "NC") .OR. (ALLTRIM(Thisform.cbte) == "FC") THEN
	Thisform.Contenido.btnCbteOrigen.Enabled = .T.
ENDIF

Thisform.Blanquear()
Thisform.mov_stock.limpiar()

&& Inicializo nuevamente el tipo de movimiento de stock
IF ALLTRIM(Thisform.cbte) == "PTO" THEN
	Thisform.mov_stock.tipomov = "SAL"
ELSE 
	IF ALLTRIM(Thisform.cbte) == "NC" THEN
		Thisform.mov_stock.tipomov = "ENT"
	ELSE
		IF ALLTRIM(Thisform.cbte) == "FC" THEN
			Thisform.mov_stock.tipomov = "SAL"
		ENDIF
	ENDIF
ENDIF 

RETURN .T.
ENDPROC


************************************************************
OBJETO: Fiscal
************************************************************
*** PROPIEDADES ***
Top = 492
Left = 816
Height = 100
Width = 100
Name = "Fiscal"

*** METODOS ***


************************************************************
OBJETO: clsformcbtes_cf
************************************************************
*** PROPIEDADES ***
Arial, 0, 9, 5, 15, 12, 32, 3, 0
Arial, 1, 8, 5, 14, 11, 29, 3, 0
Arial, 1, 9, 6, 15, 12, 32, 3, 0

*** METODOS ***


************************************************************
OBJETO: cls_ncdev_cf
************************************************************
*** PROPIEDADES ***
DoCreate = .T.
nro_cbte_original = 
fis_numcbte = 
tipodoc = 
cli_calle = 
cli_codpostal = 
cli_localidad = 
cli_pcia = 
cbte = NC
Name = "cls_ncdev_cf"
contenido.Clsetiqueta1.Name = "Clsetiqueta1"
contenido.sel_cliente.txtCodigo.Name = "txtCodigo"
contenido.sel_cliente.txtDescripcion.Name = "txtDescripcion"
contenido.sel_cliente.Name = "sel_cliente"
contenido.btnBuscarFC.Name = "btnBuscarFC"
contenido.paginas.ErasePage = .T.
contenido.paginas.Page1.grdItems.COLUMN1.Header1.Name = "Header1"
contenido.paginas.Page1.grdItems.COLUMN1.Text1.Name = "Text1"
contenido.paginas.Page1.grdItems.COLUMN1.Name = "COLUMN1"
contenido.paginas.Page1.grdItems.COLUMN2.Header1.Name = "Header1"
contenido.paginas.Page1.grdItems.COLUMN2.Text1.Name = "Text1"
contenido.paginas.Page1.grdItems.COLUMN2.Name = "COLUMN2"
contenido.paginas.Page1.grdItems.COLUMN3.Header1.Name = "Header1"
contenido.paginas.Page1.grdItems.COLUMN3.Text1.Name = "Text1"
contenido.paginas.Page1.grdItems.COLUMN3.Name = "COLUMN3"
contenido.paginas.Page1.grdItems.COLUMN4.Header1.Name = "Header1"
contenido.paginas.Page1.grdItems.COLUMN4.Text1.Name = "Text1"
contenido.paginas.Page1.grdItems.COLUMN4.Name = "COLUMN4"
contenido.paginas.Page1.grdItems.COLUMN5.Header1.Name = "Header1"
contenido.paginas.Page1.grdItems.COLUMN5.Text1.Name = "Text1"
contenido.paginas.Page1.grdItems.COLUMN5.Name = "COLUMN5"
contenido.paginas.Page1.grdItems.COLUMN6.Header1.Name = "Header1"
contenido.paginas.Page1.grdItems.COLUMN6.Text1.Name = "Text1"
contenido.paginas.Page1.grdItems.COLUMN6.Name = "COLUMN6"
contenido.paginas.Page1.grdItems.COLUMN7.Header1.Name = "Header1"
contenido.paginas.Page1.grdItems.COLUMN7.Text1.Name = "Text1"
contenido.paginas.Page1.grdItems.COLUMN7.Name = "COLUMN7"
contenido.paginas.Page1.grdItems.COLUMN8.Header1.Name = "Header1"
contenido.paginas.Page1.grdItems.COLUMN8.Text1.Name = "Text1"
contenido.paginas.Page1.grdItems.COLUMN8.Name = "COLUMN8"
contenido.paginas.Page1.grdItems.COLUMN9.Header1.Name = "Header1"
contenido.paginas.Page1.grdItems.COLUMN9.Text1.Name = "Text1"
contenido.paginas.Page1.grdItems.COLUMN9.Name = "COLUMN9"
contenido.paginas.Page1.grdItems.COLUMN10.Header1.Name = "Header1"
contenido.paginas.Page1.grdItems.COLUMN10.Text1.Name = "Text1"
contenido.paginas.Page1.grdItems.COLUMN10.Name = "COLUMN10"
contenido.paginas.Page1.grdItems.COLUMN11.Header1.Name = "Header1"
contenido.paginas.Page1.grdItems.COLUMN11.Text1.Name = "Text1"
contenido.paginas.Page1.grdItems.COLUMN11.Name = "COLUMN11"
contenido.paginas.Page1.grdItems.COLUMN12.Header1.Name = "Header1"
contenido.paginas.Page1.grdItems.COLUMN12.Text1.Name = "Text1"
contenido.paginas.Page1.grdItems.COLUMN12.Name = "COLUMN12"
contenido.paginas.Page1.grdItems.COLUMN13.Header1.Name = "Header1"
contenido.paginas.Page1.grdItems.COLUMN13.Text1.Name = "Text1"
contenido.paginas.Page1.grdItems.COLUMN13.Name = "COLUMN13"
contenido.paginas.Page1.grdItems.COLUMN14.Header1.Name = "Header1"
contenido.paginas.Page1.grdItems.COLUMN14.Text1.Name = "Text1"
contenido.paginas.Page1.grdItems.COLUMN14.Name = "COLUMN14"
contenido.paginas.Page1.grdItems.COLUMN15.Header1.Name = "Header1"
contenido.paginas.Page1.grdItems.COLUMN15.Text1.Name = "Text1"
contenido.paginas.Page1.grdItems.COLUMN15.Name = "COLUMN15"
contenido.paginas.Page1.grdItems.COLUMN16.Header1.Name = "Header1"
contenido.paginas.Page1.grdItems.COLUMN16.Text1.Name = "Text1"
contenido.paginas.Page1.grdItems.COLUMN16.Name = "COLUMN16"
contenido.paginas.Page1.grdItems.COLUMN17.Header1.Name = "Header1"
contenido.paginas.Page1.grdItems.COLUMN17.Text1.Name = "Text1"
contenido.paginas.Page1.grdItems.COLUMN17.Name = "COLUMN17"
contenido.paginas.Page1.grdItems.COLUMN18.Header1.Name = "Header1"
contenido.paginas.Page1.grdItems.COLUMN18.Text1.Name = "Text1"
contenido.paginas.Page1.grdItems.COLUMN18.Name = "COLUMN18"
contenido.paginas.Page1.grdItems.COLUMN19.Header1.Name = "Header1"
contenido.paginas.Page1.grdItems.COLUMN19.Text1.Name = "Text1"
contenido.paginas.Page1.grdItems.COLUMN19.Name = "COLUMN19"
contenido.paginas.Page1.grdItems.COLUMN20.Header1.Name = "Header1"
contenido.paginas.Page1.grdItems.COLUMN20.Text1.Name = "Text1"
contenido.paginas.Page1.grdItems.COLUMN20.Name = "COLUMN20"
contenido.paginas.Page1.grdItems.Name = "grdItems"
contenido.paginas.Page1.grdItemNC.COLUMN1.Header1.Name = "Header1"
contenido.paginas.Page1.grdItemNC.COLUMN1.Text1.Name = "Text1"
contenido.paginas.Page1.grdItemNC.COLUMN1.Name = "COLUMN1"
contenido.paginas.Page1.grdItemNC.COLUMN2.Header1.Name = "Header1"
contenido.paginas.Page1.grdItemNC.COLUMN2.Text1.Name = "Text1"
contenido.paginas.Page1.grdItemNC.COLUMN2.Name = "COLUMN2"
contenido.paginas.Page1.grdItemNC.COLUMN3.Header1.Name = "Header1"
contenido.paginas.Page1.grdItemNC.COLUMN3.Text1.Name = "Text1"
contenido.paginas.Page1.grdItemNC.COLUMN3.Name = "COLUMN3"
contenido.paginas.Page1.grdItemNC.COLUMN4.Header1.Name = "Header1"
contenido.paginas.Page1.grdItemNC.COLUMN4.Text1.Name = "Text1"
contenido.paginas.Page1.grdItemNC.COLUMN4.Name = "COLUMN4"
contenido.paginas.Page1.grdItemNC.COLUMN5.Header1.Name = "Header1"
contenido.paginas.Page1.grdItemNC.COLUMN5.Text1.Name = "Text1"
contenido.paginas.Page1.grdItemNC.COLUMN5.Name = "COLUMN5"
contenido.paginas.Page1.grdItemNC.COLUMN6.Header1.Name = "Header1"
contenido.paginas.Page1.grdItemNC.COLUMN6.Text1.Name = "Text1"
contenido.paginas.Page1.grdItemNC.COLUMN6.Name = "COLUMN6"
contenido.paginas.Page1.grdItemNC.COLUMN7.Header1.Name = "Header1"
contenido.paginas.Page1.grdItemNC.COLUMN7.Text1.Name = "Text1"
contenido.paginas.Page1.grdItemNC.COLUMN7.Name = "COLUMN7"
contenido.paginas.Page1.grdItemNC.COLUMN8.Header1.Name = "Header1"
contenido.paginas.Page1.grdItemNC.COLUMN8.Text1.Name = "Text1"
contenido.paginas.Page1.grdItemNC.COLUMN8.Name = "COLUMN8"
contenido.paginas.Page1.grdItemNC.COLUMN9.Header1.Name = "Header1"
contenido.paginas.Page1.grdItemNC.COLUMN9.Text1.Name = "Text1"
contenido.paginas.Page1.grdItemNC.COLUMN9.Name = "COLUMN9"
contenido.paginas.Page1.grdItemNC.COLUMN10.Header1.Name = "Header1"
contenido.paginas.Page1.grdItemNC.COLUMN10.Text1.Name = "Text1"
contenido.paginas.Page1.grdItemNC.COLUMN10.Name = "COLUMN10"
contenido.paginas.Page1.grdItemNC.COLUMN11.Header1.Name = "Header1"
contenido.paginas.Page1.grdItemNC.COLUMN11.Text1.Name = "Text1"
contenido.paginas.Page1.grdItemNC.COLUMN11.Name = "COLUMN11"
contenido.paginas.Page1.grdItemNC.COLUMN12.Header1.Name = "Header1"
contenido.paginas.Page1.grdItemNC.COLUMN12.Text1.Name = "Text1"
contenido.paginas.Page1.grdItemNC.COLUMN12.Name = "COLUMN12"
contenido.paginas.Page1.grdItemNC.COLUMN13.Header1.Name = "Header1"
contenido.paginas.Page1.grdItemNC.COLUMN13.Text1.Name = "Text1"
contenido.paginas.Page1.grdItemNC.COLUMN13.Name = "COLUMN13"
contenido.paginas.Page1.grdItemNC.COLUMN14.Header1.Name = "Header1"
contenido.paginas.Page1.grdItemNC.COLUMN14.Text1.Name = "Text1"
contenido.paginas.Page1.grdItemNC.COLUMN14.Name = "COLUMN14"
contenido.paginas.Page1.grdItemNC.COLUMN15.Header1.Name = "Header1"
contenido.paginas.Page1.grdItemNC.COLUMN15.Text1.Name = "Text1"
contenido.paginas.Page1.grdItemNC.COLUMN15.Name = "COLUMN15"
contenido.paginas.Page1.grdItemNC.COLUMN16.Header1.Name = "Header1"
contenido.paginas.Page1.grdItemNC.COLUMN16.Text1.Name = "Text1"
contenido.paginas.Page1.grdItemNC.COLUMN16.Name = "COLUMN16"
contenido.paginas.Page1.grdItemNC.COLUMN17.Header1.Name = "Header1"
contenido.paginas.Page1.grdItemNC.COLUMN17.Text1.Name = "Text1"
contenido.paginas.Page1.grdItemNC.COLUMN17.Name = "COLUMN17"
contenido.paginas.Page1.grdItemNC.COLUMN18.Header1.Name = "Header1"
contenido.paginas.Page1.grdItemNC.COLUMN18.Text1.Name = "Text1"
contenido.paginas.Page1.grdItemNC.COLUMN18.Name = "COLUMN18"
contenido.paginas.Page1.grdItemNC.COLUMN19.Header1.Name = "Header1"
contenido.paginas.Page1.grdItemNC.COLUMN19.Text1.Name = "Text1"
contenido.paginas.Page1.grdItemNC.COLUMN19.Name = "COLUMN19"
contenido.paginas.Page1.grdItemNC.COLUMN20.Header1.Name = "Header1"
contenido.paginas.Page1.grdItemNC.COLUMN20.Text1.Name = "Text1"
contenido.paginas.Page1.grdItemNC.COLUMN20.Name = "COLUMN20"
contenido.paginas.Page1.grdItemNC.Name = "grdItemNC"
contenido.paginas.Page1.Clsetiqueta1.Name = "Clsetiqueta1"
contenido.paginas.Page1.Clsetiqueta2.Name = "Clsetiqueta2"
contenido.paginas.Page1.btnAceptar.Name = "btnAceptar"
contenido.paginas.Page1.btnCancelar.Name = "btnCancelar"
contenido.paginas.Page1.Name = "Page1"
contenido.paginas.Page2.Clsetiqueta1.Name = "Clsetiqueta1"
contenido.paginas.Page2.Clsetiqueta2.Name = "Clsetiqueta2"
contenido.paginas.Page2.Clsetiqueta3.Name = "Clsetiqueta3"
contenido.paginas.Page2.Clsetiqueta4.Name = "Clsetiqueta4"
contenido.paginas.Page2.Clsetiqueta5.Name = "Clsetiqueta5"
contenido.paginas.Page2.Clsetiqueta6.Name = "Clsetiqueta6"
contenido.paginas.Page2.Clsetiqueta7.Name = "Clsetiqueta7"
contenido.paginas.Page2.Clsetiqueta8.Name = "Clsetiqueta8"
contenido.paginas.Page2.Clsetiqueta9.Name = "Clsetiqueta9"
contenido.paginas.Page2.Clslinea1.Name = "Clslinea1"
contenido.paginas.Page2.CLSLINEA2.Name = "CLSLINEA2"
contenido.paginas.Page2.Clsetiqueta10.Name = "Clsetiqueta10"
contenido.paginas.Page2.Clsetiqueta11.Name = "Clsetiqueta11"
contenido.paginas.Page2.txtFCImpNeto.Name = "txtFCImpNeto"
contenido.paginas.Page2.txtFCPorDto1.Name = "txtFCPorDto1"
contenido.paginas.Page2.txtFCPorDto2.Name = "txtFCPorDto2"
contenido.paginas.Page2.txtFCPorDto3.Name = "txtFCPorDto3"
contenido.paginas.Page2.txtFCPorDto4.Name = "txtFCPorDto4"
contenido.paginas.Page2.txtFCImpFinal.Name = "txtFCImpFinal"
contenido.paginas.Page2.txtFCImpIVA21.Name = "txtFCImpIVA21"
contenido.paginas.Page2.txtFCImpIVA105.Name = "txtFCImpIVA105"
contenido.paginas.Page2.txtFCTotFact.Name = "txtFCTotFact"
contenido.paginas.Page2.txtFCImpDto1.Name = "txtFCImpDto1"
contenido.paginas.Page2.txtFCImpDto2.Name = "txtFCImpDto2"
contenido.paginas.Page2.txtFCImpDto3.Name = "txtFCImpDto3"
contenido.paginas.Page2.txtFCImpDto4.Name = "txtFCImpDto4"
contenido.paginas.Page2.txtNCImpNeto.Name = "txtNCImpNeto"
contenido.paginas.Page2.txtNCPorDto1.Name = "txtNCPorDto1"
contenido.paginas.Page2.txtNCPorDto2.Name = "txtNCPorDto2"
contenido.paginas.Page2.txtNCPorDto3.Name = "txtNCPorDto3"
contenido.paginas.Page2.txtNCPorDto4.Name = "txtNCPorDto4"
contenido.paginas.Page2.txtNCImpFinal.Name = "txtNCImpFinal"
contenido.paginas.Page2.txtNCImpIVA21.Name = "txtNCImpIVA21"
contenido.paginas.Page2.txtNCImpIVA105.Name = "txtNCImpIVA105"
contenido.paginas.Page2.txtNCTotFact.Name = "txtNCTotFact"
contenido.paginas.Page2.txtNCImpDto1.Name = "txtNCImpDto1"
contenido.paginas.Page2.txtNCImpDto2.Name = "txtNCImpDto2"
contenido.paginas.Page2.txtNCImpDto3.Name = "txtNCImpDto3"
contenido.paginas.Page2.txtNCImpDto4.Name = "txtNCImpDto4"
contenido.paginas.Page2.Clslinea3.Name = "Clslinea3"
contenido.paginas.Page2.Clslinea4.Name = "Clslinea4"
contenido.paginas.Page2.Clsetiqueta12.Name = "Clsetiqueta12"
contenido.paginas.Page2.txtFCPorIIBB.Name = "txtFCPorIIBB"
contenido.paginas.Page2.txtFCimpIIBB.Name = "txtFCimpIIBB"
contenido.paginas.Page2.txtNCPorIIBB.Name = "txtNCPorIIBB"
contenido.paginas.Page2.txtNCImpIIBB.Name = "txtNCImpIIBB"
contenido.paginas.Page2.txtNCporRec.Name = "txtNCporRec"
contenido.paginas.Page2.txtNCimpRec.Name = "txtNCimpRec"
contenido.paginas.Page2.txtFCporRec.Name = "txtFCporRec"
contenido.paginas.Page2.txtFCimpRec.Name = "txtFCimpRec"
contenido.paginas.Page2.Clsetiqueta13.Name = "Clsetiqueta13"
contenido.paginas.Page2.Name = "Page2"
contenido.paginas.Name = "paginas"
contenido.btnCerrar.Name = "btnCerrar"
contenido.btnGrabar.Name = "btnGrabar"
contenido.btnNuevo.Name = "btnNuevo"
contenido.CLSETIQUETA2.Name = "CLSETIQUETA2"
contenido.TXTCBTE.Name = "TXTCBTE"
contenido.TXTTIPO.Name = "TXTTIPO"
contenido.TXTNROCBTE.Name = "TXTNROCBTE"
contenido.Name = "contenido"
datos_cbtes.Name = "datos_cbtes"

*** METODOS ***
PROCEDURE enviar_fiscal
LOCAL lcDireccion, lcDesc, lnImpItem, lnImpItemNeto, lnPorIIBB, lnImpIIBB, lnimpIva

lnImpItem = 0.00
lnImpItemNeto = 0.00
lnPorIIBB = 0.00
lnImpIIBB = 0.00
lnimpIva = 0.00

lcDireccion = ALLTRIM(Thisform.cli_calle) + " " + ALLTRIM(Thisform.cli_Codpostal) + " " + ALLTRIM(Thisform.cli_Localidad) + " " + ALLTRIM(Thisform.cli_pcia)
lnPorIIBB = Thisform.contenido.paginas.page2.txtNCPorIIBB.Value 
lnImpIIBB = Thisform.contenido.paginas.page2.txtNCImpIIBB.Value 

Thisform.tipodoc = thisform.contenido.txttipo.Value
Thisform.Fiscal.Puerto = 1
Thisform.Fiscal.Comenzar()
Thisform.Fiscal.usarASCII = .F.
Thisform.Fiscal.Modelo = 8  && MODELO_P320
Thisform.Fiscal.TratarDeCancelarTodo()
Thisform.Fiscal.DescripcionesLargas = .T.
Thisform.Fiscal.ReintentoConstante = .T.
Thisform.Fiscal.DatosCliente(ALLTRIM(STR(thisform.cli_id)) + " - " + ALLTRIM(Thisform.cli_razsoc), ALLTRIM(Thisform.cli_cuit), IIF(thisform.codivafiscal = 67, 50, 67), Thisform.codivafiscal, lcDireccion)

Thisform.Fiscal.InformacionRemito(1) = ALLTRIM(Thisform.contenido.txtnrocbte.Value) 

IF ALLTRIM(Thisform.tipodoc) == "A" THEN
	Thisform.Fiscal.AbrirComprobanteNoFiscalHomologado(82)	&& NOTA DE CREDITO A
ELSE
	Thisform.Fiscal.AbrirComprobanteNoFiscalHomologado(83)	&& NOTA DE CREDITO B
ENDIF

SELECT cur_Detalle
IF RECCOUNT("cur_Detalle") > 0 THEN
	GO TOP
ENDIF

DO WHILE !EOF("cur_Detalle")
	lcDesc = ALLTRIM(cur_Detalle.codArt) + REPLICATE(" ", 20 - LEN(ALLTRIM(cur_Detalle.codArt))) + "-" + SUBSTR(ALLTRIM(cur_Detalle.Descripcio), 1, 25)
	
	&&lnImpItemNeto = ROUND(cur_Detalle.prVenta, 2)
	&&lnImpItem = (ROUND(cur_Detalle.impNeto, 2) + (ROUND(cur_Detalle.impIVA, 2) / ROUND(cur_detalle.cantNC, 2)))
	&&Thisform.Fiscal.ImprimirItem(ALLTRIM(lcDesc), ROUND(cur_Detalle.cantNC, 2), ROUND(lnImpItem, 2), ROUND(cur_Detalle.alicIVA, 2), 0)

	lnImpItemNeto = ROUND(cur_Detalle.prVenta, 2)
	lnimpIva = cur_Detalle.impNeto * (cur_Detalle.alicIVA / 100) && No hago el redondeo porque sino me va a quedar un importe distinto al grabado en la BD, dejo que redondee la fiscal
	lnImpItem = cur_Detalle.impNeto + lnimpIva 
	Thisform.Fiscal.ImprimirItem(ALLTRIM(lcDesc), ROUND(cur_Detalle.cantNC, 2), lnImpItem, ROUND(cur_Detalle.alicIVA, 2), 0)
	
	
	SELECT cur_Detalle
	SKIP
ENDDO

Thisform.Fiscal.EspecificarPercepcionGlobal("Perc. IIBB. %" + ALLTRIM(STR(lnPorIIBB)), lnImpIIBB)

Thisform.Fiscal.Encabezado(11) = ""

Thisform.Fiscal.Subtotal(.T.)
IF ALLTRIM(Thisform.cbte) == "FC" THEN
	Thisform.Fiscal.CerrarComprobanteFiscal()
ELSE
	Thisform.Fiscal.CerrarComprobanteNoFiscalHomologado()
ENDIF

Thisform.fis_numcbte = INT(VAL(Thisform.Fiscal.Respuesta(3)))	&& Devuelvo el número de comprobante a grabar
Thisform.datos_cbtes.fis_num_cbte = thisform.fis_numcbte

Thisform.Fiscal.Finalizar()

ENDPROC
PROCEDURE contenido.btnGrabar.Click
&& Envio a grabar

thisform.datos_cbtes.lnncimpdesc1 = thisform.contenido.paginas.page2.txtNCImpDto1.Value
thisform.datos_cbtes.lnncimpdesc2 = thisform.contenido.paginas.page2.txtNCImpDto2.Value
thisform.datos_cbtes.lnncimpdesc3 = thisform.contenido.paginas.page2.txtNCImpDto3.Value
thisform.datos_cbtes.lnncimpdesc4 = thisform.contenido.paginas.page2.txtNCImpDto4.Value
thisform.datos_cbtes.lnncimpfinal = thisform.contenido.paginas.page2.txtNCImpFinal.Value
thisform.datos_cbtes.lnncporiibb = thisform.contenido.paginas.page2.txtNCPorIIBB.Value
thisform.datos_cbtes.lnncimpiibb = thisform.contenido.paginas.page2.txtNCImpIIBB.Value
thisform.datos_cbtes.lnncimpiva105 =  thisform.contenido.paginas.page2.txtNCImpIVA105.Value
thisform.datos_cbtes.lnncimpiva21 = thisform.contenido.paginas.page2.txtNCImpIVA21.Value
thisform.datos_cbtes.lnncimpneto = thisform.contenido.paginas.page2.txtNCImpNeto.Value
thisform.datos_cbtes.lnnctotfact = thisform.contenido.paginas.page2.txtNCTotFact.Value
thisform.datos_cbtes.lnncpordto1 = thisform.contenido.paginas.page2.txtNCPorDto1.Value
thisform.datos_cbtes.lnncpordto2 = thisform.contenido.paginas.page2.txtNCPorDto2.Value
thisform.datos_cbtes.lnncpordto3 = thisform.contenido.paginas.page2.txtNCPorDto3.Value
thisform.datos_cbtes.lnncpordto4 = thisform.contenido.paginas.page2.txtNCPorDto4.Value
thisform.datos_cbtes.lnncporrec = thisform.contenido.paginas.page2.txtNCporRec.Value
thisform.datos_cbtes.lnncimprec = thisform.contenido.paginas.page2.txtNCimpRec.Value
thisform.datos_cbtes.poriva21 = IIF(thisform.datos_cbtes.lnncimpiva21 <> 0, 21, 0)
thisform.datos_cbtes.poriva105 = IIF(thisform.datos_cbtes.lnncimpiva105 <> 0, 10.5, 0)

thisform.datos_cbtes.cli_razsoc = thisform.cli_razsoc
thisform.datos_cbtes.cli_nrodoc = thisform.cli_cuit
thisform.datos_cbtes.cli_tipodoc = thisform.cli_idtipodoc
thisform.datos_cbtes.esfe = 0

IF !thisform.validardetalle() THEN
	RETURN .F.
ENDIF

thisform.enviar_fiscal()

IF !thisform.datos_cbtes.grabar() THEN
	MESSAGEBOX(thisform.datos_cbtes.error_message, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

MESSAGEBOX("El comprobante: " + ALLTRIM(thisform.datos_cbtes.cbte) + " " + ALLTRIM(thisform.datos_cbtes.tipodoc) + " " + REPLICATE("0", 4 - LEN(ALLTRIM(STR(thisform.datos_cbtes.ptovta)))) + ALLTRIM(STR(thisform.datos_cbtes.ptovta)) + "-" + ;
	REPLICATE("0", 8 - LEN(ALLTRIM(STR(thisform.datos_cbtes.numcbte)))) + ALLTRIM(STR(thisform.datos_cbtes.numcbte)) + " se ha generado exitosamente...", 0+64, Thisform.Caption)

Thisform.limpiar()

RETURN .T.
ENDPROC


************************************************************
OBJETO: Fiscal
************************************************************
*** PROPIEDADES ***
Top = 432
Left = 276
Height = 100
Width = 100
Name = "Fiscal"

*** METODOS ***


************************************************************
OBJETO: cls_ncdev_cf
************************************************************
*** PROPIEDADES ***
Arial, 0, 9, 5, 15, 12, 32, 3, 0
Arial, 1, 8, 5, 14, 11, 29, 3, 0

*** METODOS ***


************************************************************
OBJETO: frm_ncnd_cc
************************************************************
*** PROPIEDADES ***
BorderStyle = 2
Height = 520
Width = 776
DoCreate = .T.
Caption = "Nota de crédito"
cbte = NC
idventascab = -1
cbteref = 
tipodocref = 
ptovtaref = 
numcbteref = 
importecbteref = 
idcliente = -1
idcc_cli = -1
printerdevice = 
idoper = 
imptotiva21 = 0.00
imptotiva105 = 0.00
poriva21 = 0.00
poriva105 = 0.00
ptovta = 
nrocbte = 
cli_calle = 
cli_codpostal = 
cli_localidad = 
cli_pcia = 
cli_sitiva = 
cli_razsoc = 
cli_cuit = 
fiscal_nrodoc = 0
usa_fiscal = .F.
sqlsrv = .F.
idcheque = 0
codabr = 
idsitiva = 0
cli_idtipodoc = 0
cli_tipodoc = 
Name = "frm_ncnd_cc"

*** METODOS ***
PROCEDURE imprimir
LOCAL m.NroCli, m.RazSoc, m.Telefono, m.direccion, m.localidad, m.codPostal, m.pcia, m.TipoIVA, m.nroCUIT
LOCAL m.Total, m.tipoDoc, m.NroCbte, m.Fecha, m.leyenda, m.fecVto, m.tipoDoc, m.ptoVta
LOCAL m.porDesc1, m.porDesc2, m.porDesc3, m.porDesc4
LOCAL m.impDesc1, m.impDesc2, m.impDesc3, m.impDesc4
LOCAL m.impIVA105, m.impIVA21, m.impNeto, m.impFinal, m.porIIBB, m.impIIBB, m.observ
LOCAL lcSql, loNumerador, lcPrinterName, lnCantCpia
LOCAL loResCli, loResLoc, loResPcia

loNumerador = CREATEOBJECT("odbc_result")
loResCli = CREATEOBJECT("odbc_result")
loResLoc = CREATEOBJECT("odbc_result")
loResPcia = CREATEOBJECT("odbc_result")
loResSitIVA = CREATEOBJECT("odbc_result")
lcSql = ""

m.Total = 0.00
m.tipoDoc = ""
m.NroCbte = ""
m.leyenda = ""
m.Fecha = DATETIME()
m.impIVA105 = 0.00
m.impIVA21 = 0.00
m.impNeto = 0.00
m.impFinal = 0.00
m.tipoDoc = Thisform.tipodocref
m.ptoVta = Thisform.ptovta
m.NroCbte = Thisform.ptovta + "-" + Thisform.nrocbte
m.porIIBB = 0.00
m.impIIBB = 0.00
m.observ = ""

&& Me fijo cuantas copias tengo que imprimir
lcSql = "select * from numerador where cbte = '" + ALLTRIM(Thisform.cbte) + "' and tipoDoc = '" + ALLTRIM(m.tipoDoc) + "' AND ptoVta = " + ALLTRIM(STR(INT(VAL(m.ptoVta))))
loNumerador = CREATEOBJECT("odbc_result")
loNumerador.ActiveConnection = goConn.ActiveConnection
loNumerador.Cursor_Name = "cur_num"
loNumerador.OpenQuery(lcSql)

SELECT cur_num
m.NroCbte = m.ptoVta + "-" + REPLICATE("0", 8 - LEN(ALLTRIM(STR(cur_num.numActual)))) + ALLTRIM(STR(cur_num.numActual))
lcPrinterName = cur_num.impresora
lnCantCpia = cur_num.cantCpia

loNumerador.close_query()

&& Recupero los datos del cliente
lcSql = "SELECT * FROM clientes WHERE idCliente = " + ALLTRIM(STR(Thisform.idCliente))
loResCli.cursor_name = "cur_Cliente"
loResCli.ActiveConnection = goConn.ActiveConnection
loResCli.OpenQuery(lcSql)

m.NroCli = cur_Cliente.idCliente
m.RazSoc = cur_Cliente.razSoc
m.Telefono = cur_Cliente.telefono
m.direccion = cur_Cliente.direccion

&& Levanto los datos de la localidad que tiene asignada el cliente
lcSql = "SELECT * FROM localidad WHERE idLocalid = " + ALLTRIM(STR(cur_Cliente.idLocalid))
loResLoc.Cursor_Name = "cur_Loc"
loResLoc.ActiveConnection = goConn.ActiveConnection
loResLoc.OpenQuery(lcSql)

m.localidad = ALLTRIM(cur_Loc.descripcio)
m.codPostal = ALLTRIM(cur_Loc.codPostal)

&& Levanto los datos de la provincia que tiene asignada la localidad
lcSql = "SELECT * FROM provincias WHERE idProvin = " + ALLTRIM(STR(cur_Loc.idProvin))
loResPcia.Cursor_Name = "cur_Pcia"
loResPcia.ActiveConnection = goConn.ActiveConnection
loResPcia.OpenQuery(lcSql)

m.pcia = ALLTRIM(cur_Loc.descripcio)

loResPcia.Close_Query()
loResLoc.Close_Query()

m.nroCUIT = cur_Cliente.nroCUIT

&& Levanto los datos de la situación de IVA que tiene el cliente
lcSql = "SELECT * FROM sitiva WHERE idSitIVA = " + ALLTRIM(STR(cur_Cliente.idSitIVA))
loResSitIVA.Cursor_Name = "cur_SitIVA"
loResSitIVA.ActiveConnection = goConn.ActiveConnection
loResSitIVA.OpenQuery(lcSql)

m.TipoIVA = cur_SitIVA.descripcio

loResSitIVA.Close_Query()
loResCli.Close_Query()


m.impIVA105 = Thisform.txtImpIVA105.Value 
m.impIVA21 = Thisform.txtImpIVA21.Value 
m.impNeto = Thisform.txtSubTotal.Value
m.impFinal = Thisform.txtTotal.Value
m.porIIBB = Thisform.txtporIIBB.Value 
m.impIIBB = Thisform.txtImpIIBB.Value 
m.observ = Thisform.txtobserv.Value

IF ALLTRIM(Thisform.Cbte) == "NC"
	m.Leyenda = "NOTA DE CREDITO"
	m.Total = Thisform.txtTotal.Value
ELSE
	IF ALLTRIM(Thisform.Cbte) == "ND"
		m.leyenda = "NOTA DE DEBITO"
		m.Total = Thisform.txtTotal.Value
	ENDIF
ENDIF

SET PRINTER TO NAME ALLTRIM(lcPrinterName)
SELECT vtadcp

FOR i = 1 TO lnCantCpia
	IF ALLTRIM(m.tipodoc) == "A" THEN 
		REPORT FORM "repncnd.frx" TO PRINTER NOCONSOLE
	ELSE 
		REPORT FORM "repncnd_b.frx" TO PRINTER NOCONSOLE
	ENDIF
NEXT


ENDPROC
PROCEDURE enviar_fiscal
LOCAL lcDireccion, lcDesc, lnPorIIBB, lnImpIIBB

lnPorIIBB = 0.00
lnImpIIBB = 0.00

lcDireccion = Thisform.cli_calle + " " + Thisform.cli_Codpostal + " " + Thisform.cli_Localidad + " " + Thisform.cli_pcia
lnPorIIBB = Thisform.txtporIIBB.Value 
lnImpIIBB = Thisform.txtimpIIBB.Value 

Thisform.Fiscal.Puerto = 1
Thisform.Fiscal.Comenzar()
Thisform.Fiscal.UsarASCII = .F.
Thisform.Fiscal.Modelo = 8  && MODELO_P320
Thisform.Fiscal.TratarDeCancelarTodo()
Thisform.Fiscal.DescripcionesLargas = .T.
Thisform.Fiscal.ReintentoConstante = .T.
Thisform.Fiscal.DatosCliente(ALLTRIM(STR(Thisform.idcliente)) + " - " + ALLTRIM(Thisform.cli_razsoc), ALLTRIM(Thisform.cli_cuit), IIF(thisform.cli_sitiva = 67, 50, 67), Thisform.cli_sitiva, lcDireccion)

IF ALLTRIM(Thisform.cbte) == "NC" THEN
	IF ALLTRIM(thisform.numcbteref) <> "" THEN
		Thisform.Fiscal.InformacionRemito(1) = ALLTRIM(this.ptovtaref) + "-" + ALLTRIM(this.numcbteref)
	ELSE
		Thisform.Fiscal.InformacionRemito(1) = " "
	ENDIF

	IF ALLTRIM(Thisform.TipoDocRef) == "A" THEN
		Thisform.Fiscal.AbrirComprobanteNoFiscalHomologado(82)	&& NOTA DE CREDITO "A"
	ELSE
		Thisform.Fiscal.AbrirComprobanteNoFiscalHomologado(83)	&& NOTA DE CREDITO "B"
	ENDIF
ELSE
	IF ALLTRIM(Thisform.TipoDocRef) == "A" THEN			
		Thisform.Fiscal.AbrirComprobanteFiscal(68)	&& NOTA DE DEBITO "A"
	ELSE
		Thisform.Fiscal.AbrirComprobanteFiscal(69)	&& NOTA DE DEBITO "B"
	ENDIF
ENDIF

SELECT vtadcp
IF RECCOUNT("vtadcp") > 0 THEN
	GO TOP
ENDIF

DO WHILE !EOF("vtadcp")
	lcDesc = ALLTRIM(vtadcp.descPlan)
	THisform.Fiscal.imprimirItem(lcDesc, 1, vtadcp.impNeto + vtadcp.ivaImp, vtadcp.ivaPor, 0) 

	SELECT vtadcp
	SKIP
ENDDO

Thisform.Fiscal.EspecificarPercepcionGlobal("Perc. IIBB. %" + ALLTRIM(STR(lnPorIIBB)), lnImpIIBB)

IF ALLTRIM(Thisform.txtobserv.Value) == "" THEN
	Thisform.Fiscal.Encabezado(11) = ""
ELSE 
	Thisform.Fiscal.Encabezado(11) = ALLTRIM(Thisform.txtobserv.Value)
ENDIF

Thisform.Fiscal.Subtotal(.T.)

IF ALLTRIM(Thisform.cbte) == "NC" THEN
	Thisform.Fiscal.CerrarComprobanteNoFiscalHomologado()
ELSE
	Thisform.Fiscal.CerrarComprobanteFiscal()
ENDIF

&& Thisform.Fiscal_nrodoc = Thisform.Fiscal.Respuesta(3)
Thisform.Fiscal_nrodoc = INT(VAL(Thisform.Fiscal.Respuesta(3)))
Thisform.Fiscal.Finalizar()

ENDPROC
PROCEDURE buscar_cheque
LOCAL loResult, lcSql
LOCAL lnIdBanco

loResult = CREATEOBJECT("odbc_result")
lcSql = ""

IF TYPE('Thisform.sel_Banco.valcpoid') == "C" THEN
	lnIdBanco = INT(VAL(Thisform.sel_Banco.valcpoid))
ELSE
	lnIdBanco = Thisform.sel_Banco.valcpoid
ENDIF

lcSql = "SELECT * FROM cheques WHERE chq_nro = '" + ALLTRIM(Thisform.txtNroCheque.Value) + "' AND idBanco = " + ALLTRIM(STR(lnIdBanco)) + " "
lcSql = lcSql + "AND estado != 'R'"

loResult.Cursor_Name = "cur_Bco"
loResult.ActiveConnection = goConn.ActiveConnection
loResult.OpenQuery(lcSql)

SELECT cur_Bco
IF RECCOUNT("cur_Bco") > 0 THEN
	Thisform.IdCheque = cur_Bco.idCheque
	Thisform.txtImporteNeto.Value = cur_Bco.importe
ELSE
	MESSAGEBOX("Cheque no encontrado, por favor, ingrese bien los datos", 0+48, Thisform.Caption)
	Thisform.txtNroCheque.Value = ""
	Thisform.sel_Banco.txtCodigo.Value = ""
	Thisform.sel_Banco.txtDescripcion.Value = ""
ENDIF

loResult.Close_Query()

RETURN .T.

ENDPROC
PROCEDURE calcular_tipodoc
LOCAL lnSitIVACli

lnSitIvaEmp = 0
lnSitIvaEmp = VAL(ALLTRIM(getConfig("SITIVAEMP")))

IF lnSitIvaEmp = 1 .AND. Thisform.idSitIva = 1 THEN
	RETURN "A"
ENDIF

IF lnSitIvaEmp = 1 .AND. Thisform.idSitIva= 2 THEN
	RETURN "B"
ENDIF

IF lnSitIvaEmp = 1 .AND. Thisform.idSitIva = 3 THEN
	RETURN "B"
ENDIF

IF lnSitIvaEmp = 1 .AND. Thisform.sitivacli = 5 THEN
	RETURN "B"
ENDIF

IF lnSitIvaEmp = 1 .AND. Thisform.idSitIva = 6 THEN
	RETURN "B"
ENDIF

IF lnSitIvaEmp = 1 .AND. Thisform.sitivacli = 7 THEN
   	RETURN "B"
ENDIF

IF lnSitIvaEmp = 6 THEN
	RETURN "B"
ENDIF

ENDPROC
PROCEDURE calcular_ret_iibb
&& Calculo el importe de percepción de ingresos brutos y lo anexo al total
IF ALLTRIM(Thisform.cbte) == "NC" THEN
	Thisform.txtImpIIBB.Value = ROUND(Thisform.txtsubTotal.Value * (Thisform.txtPorIIBB.Value / 100), 2)
	Thisform.txttotal.Value = Thisform.txttotal.Value + Thisform.txtImpIIBB.Value
ENDIF 
ENDPROC
PROCEDURE sumar_items
LOCAL lnSubtotal, lnIVA21, lnIVA105, lnTotal

lnSubtotal = 0.00
lnIVA21 = 0.00
lnIVA105 = 0.00
lnTotal = 0.00

SELECT vtadcp
IF RECCOUNT("vtadcp") > 0
	GO TOP 
ENDIF 

DO WHILE !EOF()
	lnSubtotal = lnSubtotal + vtadcp.impNeto
	
	IF vtadcp.ivaPor = 21 THEN
		lnIVA21 = lnIVA21 + vtadcp.ivaImp
	ELSE
		lnIVA105 = lnIVA105  + vtadcp.ivaImp
	ENDIF
	
	lnTotal = lnTotal + vtadcp.total
	
	SELECT vtadcp
	SKIP 
ENDDO 

Thisform.txtsubTotal.Value = lnSubtotal
Thisform.txtImpIVA21.Value = lnIVA21
Thisform.txtImpIVA105.Value = lnIVA105
Thisform.txttotal.Value = lnTotal

SELECT vtadcp
IF RECCOUNT("vtadcp") > 0
	GO TOP 
ENDIF 

ENDPROC
PROCEDURE Activate
LOCAL lo_rsIIBB

lo_rsIIBB = CREATEOBJECT("odbc_result")
lcSql = ""

&& Levanto el IIBB del cliente
lcSql = "SELECT * FROM padronib WHERE cuit = '" + ALLTRIM(STRTRAN(thisform.cli_cuit,"-","")) + "'"
lo_rsIIBB.ActiveConnection = goConn.ActiveConnection
lo_rsIIBB.Cursor_Name = "cur_PadronIB"
lo_rsIIBB.OpenQuery(lcSql)

SELECT cur_PadronIB
IF RECCOUNT("cur_PadronIB") > 0 THEN
	Thisform.txtPorIIBB.Value = cur_PadronIB.AlicuotaPer
ELSE 
	Thisform.txtPorIIBB.Value = 0.00
ENDIF 

lo_rsIIBB.close_query()

&& Si es cuenta dos no tildo IVA 21%
IF INT(VAL(ALLTRIM(getconfig("DEMO")))) == 0 THEN
	Thisform.chkIVA21.Value = 1
ENDIF

&&Thisform.chkIVA21.Value = 1
Thisform.txtPtoVta.Value = Thisform.ptovtaref
Thisform.txtNroCbte.Value = Thisform.numcbteref
Thisform.txtPorIVA105.Value = 10.50
Thisform.txtPorIVA21.Value = 21.00

IF ALLTRIM(Thisform.cbte) == "NC" THEN
	Thisform.txtOperacion.Value = "NOTA DE CREDITO"
ELSE
	Thisform.txtOperacion.Value = "NOTA DE DEBITO"
	Thisform.txtPorIIBB.Value = 0.00
ENDIF
ENDPROC
PROCEDURE Load
DODEFAULT()

&& Creo el cursor que contendrá el detalle del comprobante

CREATE CURSOR vtadcp (	;
	id_vtadcp	int	,;
	idVentasC	int ,;
	idPlanCta	int ,;
	idBanco		int ,;
	codPlanCta	varchar(20),;
	descPlan	varchar(60),;
	cheque_nro	varchar(8),;
	impNeto		float(10, 2),;
	ivaPor		float(10, 2),;
	ivaImp		float(10, 2),;
	total		float(10, 2) ;
)
	

ENDPROC
PROCEDURE Init
DODEFAULT()

&& Creo la grilla
SELECT vtadcp
Thisform.grdDetalle.RecordSource = "vtadcp"
Thisform.grdDetalle.list_controlsource = "codPlanCta,descPlan,cheque_nro,impNeto,ivaPor,ivaImp,total"
Thisform.grdDetalle.lista_ancho_cols = "100,250,100,70,70,70,70"
Thisform.grdDetalle.titulos_cabeceras = "Código,Descripción,Cheque,Imp. Neto,I.V.A,Imp. IVA,Total"
Thisform.grdDetalle.generar_grid()


IF ALLTRIM(GetConfig("USA_FISCAL")) == "S" THEN
	Thisform.usa_fiscal = .T.
ELSE
	Thisform.usa_fiscal = .F.
ENDIF

IF ALLTRIM(GetConfig("SQLSRV")) == "1" THEN
	Thisform.sqlsrv = .T.
ELSE
	Thisform.sqlsrv = .F.
ENDIF
ENDPROC


************************************************************
OBJETO: Clsetiqueta1
************************************************************
*** PROPIEDADES ***
Caption = "Operación"
Height = 15
Left = 12
Top = 12
Width = 72
TabIndex = 15
Name = "Clsetiqueta1"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta2
************************************************************
*** PROPIEDADES ***
Caption = "Factura de Referencia"
Height = 15
Left = 157
Top = 12
Width = 132
TabIndex = 16
Name = "Clsetiqueta2"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta3
************************************************************
*** PROPIEDADES ***
Caption = "Importe"
Height = 15
Left = 346
Top = 12
Width = 51
TabIndex = 17
Name = "Clsetiqueta3"

*** METODOS ***


************************************************************
OBJETO: txtOperacion
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 12
TabIndex = 18
Top = 28
Width = 120
Name = "txtOperacion"

*** METODOS ***


************************************************************
OBJETO: txtPtoVta
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 157
TabIndex = 19
Top = 28
Width = 43
Name = "txtPtoVta"

*** METODOS ***


************************************************************
OBJETO: txtNroCbte
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 204
TabIndex = 20
Top = 28
Width = 109
Name = "txtNroCbte"

*** METODOS ***


************************************************************
OBJETO: txtImporte
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 347
TabIndex = 21
Top = 28
Width = 86
Name = "txtImporte"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta4
************************************************************
*** PROPIEDADES ***
Caption = "Concepto:"
Height = 15
Left = 12
Top = 70
Width = 72
TabIndex = 22
Name = "Clsetiqueta4"

*** METODOS ***


************************************************************
OBJETO: sel_Conceptos
************************************************************
*** PROPIEDADES ***
Top = 63
Left = 91
Width = 557
Height = 25
TabIndex = 1
cfieldname = 
nombre_campo_codigo = codPlanCta
nombre_campo_desc = descripcio
nombre_tabla = planctas
pkfield = idPlanCta
autocompletar_ceros = .F.
Name = "sel_Conceptos"
txtCodigo.Height = 21
txtCodigo.Left = 2
txtCodigo.Top = 2
txtCodigo.Width = 172
txtCodigo.Name = "txtCodigo"
txtDescripcion.Left = 177
txtDescripcion.Top = 2
txtDescripcion.Name = "txtDescripcion"

*** METODOS ***
PROCEDURE recuperar_datos
SELECT planctas
thisform.codabr = planctas.codAbr

&& Si es cheque rechazado, habilito para que carguen el banco y el número
&& de cheque, en caso contrario, deshabilito los controles de cheques.
IF ALLTRIM(planctas.codAbr) == "CHR" THEN
	Thisform.sel_Banco.txtcodigo.Enabled = .T.
	Thisform.txtNroCheque.Enabled = .T.
ELSE
	Thisform.sel_Banco.txtcodigo.Enabled = .F.
	Thisform.txtNroCheque.Enabled = .F.
ENDIF
ENDPROC


************************************************************
OBJETO: Clsetiqueta5
************************************************************
*** PROPIEDADES ***
Caption = "Importe Neto"
Height = 15
Left = 87
Top = 146
Width = 79
TabIndex = 23
Name = "Clsetiqueta5"

*** METODOS ***


************************************************************
OBJETO: chkIVA21
************************************************************
*** PROPIEDADES ***
Top = 144
Left = 192
Height = 18
Width = 91
Alignment = 0
Caption = "I.V.A 21,00%"
TabIndex = 5
Name = "chkIVA21"

*** METODOS ***
PROCEDURE Click
IF this.Value = 1 THEN
	Thisform.txtIVA105.Value = 0.00
	Thisform.txtIVA21.Value = ROUND(Thisform.txtImporteNeto.Value * 0.21, 2)
	Thisform.txtImpTotal.Value = ROUND(Thisform.txtImporteNeto.Value + Thisform.txtIVA21.Value + Thisform.txtIVA105.Value, 2)
	Thisform.chkIVA105.Value = 0
ELSE
	Thisform.txtIVA21.Value = 0.00
	Thisform.txtImpTotal.Value = ROUND(Thisform.txtImporteNeto.Value + Thisform.txtIVA21.Value + Thisform.txtIVA105.Value, 2)
ENDIF
ENDPROC


************************************************************
OBJETO: chkIVA105
************************************************************
*** PROPIEDADES ***
Top = 144
Left = 300
Height = 18
Width = 92
Alignment = 0
Caption = "I.V.A 10,50%"
TabIndex = 6
Name = "chkIVA105"

*** METODOS ***
PROCEDURE Click
IF this.Value = 1 THEN
	Thisform.txtIVA21.Value = 0.00
	Thisform.txtIVA105.Value = ROUND(Thisform.txtImporteNeto.Value * 0.105, 2)
	Thisform.txtImpTotal.Value = ROUND(Thisform.txtImporteNeto.Value + Thisform.txtIVA21.Value + Thisform.txtIVA105.Value, 2)
	Thisform.chkIVA21.Value = 0
ELSE
	Thisform.txtIVA105.Value = 0.00
	Thisform.txtImpTotal.Value = ROUND(Thisform.txtImporteNeto.Value + Thisform.txtIVA21.Value + Thisform.txtIVA105.Value, 2)
ENDIF
ENDPROC


************************************************************
OBJETO: Clsetiqueta6
************************************************************
*** PROPIEDADES ***
Caption = "Importe Total"
Height = 15
Left = 412
Top = 146
Width = 79
TabIndex = 25
Name = "Clsetiqueta6"

*** METODOS ***


************************************************************
OBJETO: txtImporteNeto
************************************************************
*** PROPIEDADES ***
Left = 84
TabIndex = 4
Top = 162
isnumeric = .T.
Name = "txtImporteNeto"

*** METODOS ***
PROCEDURE LostFocus
IF thisform.chkIVA21.Value = 1 THEN
	Thisform.txtIVA105.Value = 0.00
	Thisform.txtIVA21.Value = ROUND(Thisform.txtImporteNeto.Value * 0.21, 2)
	Thisform.txtImpTotal.Value = ROUND(Thisform.txtImporteNeto.Value + Thisform.txtIVA21.Value + Thisform.txtIVA105.Value, 2)
ELSE
	IF thisform.txtIVA105.Value = 1 THEN
		Thisform.txtIVA21.Value = 0.00
		Thisform.txtIVA105.Value = ROUND(Thisform.txtImporteNeto.Value * 0.105, 2)
		Thisform.txtImpTotal.Value = ROUND(Thisform.txtImporteNeto.Value + Thisform.txtIVA21.Value + Thisform.txtIVA105.Value, 2)
	ELSE 
		Thisform.txtIVA21.Value = 0.00
		Thisform.txtIVA105.Value = 0.00
		Thisform.txtImpTotal.Value = ROUND(Thisform.txtImporteNeto.Value + Thisform.txtIVA21.Value + Thisform.txtIVA105.Value, 2)
	ENDIF 
ENDIF
ENDPROC


************************************************************
OBJETO: txtIVA21
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 192
TabIndex = 26
Top = 162
Width = 104
isnumeric = .T.
Name = "txtIVA21"

*** METODOS ***


************************************************************
OBJETO: txtIVA105
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 302
TabIndex = 28
Top = 162
Width = 101
isnumeric = .T.
Name = "txtIVA105"

*** METODOS ***


************************************************************
OBJETO: txtImpTotal
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 411
TabIndex = 29
Top = 162
Width = 101
isnumeric = .T.
Name = "txtImpTotal"

*** METODOS ***


************************************************************
OBJETO: btnAgregar
************************************************************
*** PROPIEDADES ***
Top = 143
Left = 680
Height = 44
Width = 45
TabIndex = 7
Name = "btnAgregar"

*** METODOS ***
PROCEDURE Click
IF Thisform.sel_Conceptos.valcpoid = 0 THEN
	MESSAGEBOX("Debe selecionar un concepto", 0+48, Thisform.Caption)
	Thisform.sel_Conceptos.txtCodigo.SetFocus()
	RETURN .F.
ENDIF

IF Thisform.txtImporteNeto.Value = 0 THEN
	MESSAGEBOX("Debe ingresar el importe neto", 0+48, Thisform.Caption)
	Thisform.txtImporteNeto.SetFocus()
	RETURN .F.
ENDIF

&& Si es cheque rechazado entonces valido que el usuario ingrese los datos
&& del cheque
IF ALLTRIM(Thisform.codAbr) == "CHR" THEN
	IF ALLTRIM(Thisform.Sel_Banco.txtCodigo.Value) == "" THEN
		MESSAGEBOX("Debe ingresar el banco", 0+48, Thisform.Caption)
		Thisform.sel_Banco.txtCodigo.SetFocus()
		RETURN .F.
	ENDIF
	
	IF ALLTRIM(Thisform.txtNroCheque.Value) == "" THEN
		MESSAGEBOX("Debe ingresar el número de cheque", 0+48, Thisform.Caption)
		Thisform.txtNroCheque.SetFocus()
		RETURN .F.
	ENDIF
	
	IF !Thisform.buscar_cheque() THEN
		Thisform.sel_Banco.txtCodigo.SetFocus()
		RETURN .F.
	ENDIF	
ENDIF

SELECT vtadcp
APPEND BLANK
REPLACE vtadcp.id_vtadcp WITH 0
REPLACE vtadcp.idVentasC WITH 0 ADDITIVE
REPLACE vtadcp.idPlanCta WITH Thisform.sel_Conceptos.valcpoid ADDITIVE
REPLACE vtadcp.idBanco WITH Thisform.sel_Banco.valcpoid ADDITIVE
REPLACE vtadcp.codPlanCta WITH Thisform.sel_Conceptos.txtCodigo.Value ADDITIVE
REPLACE vtadcp.descPlan WITH Thisform.sel_Conceptos.txtDescripcion.Value ADDITIVE
REPLACE vtadcp.cheque_nro WITH Thisform.txtNroCheque.Value ADDITIVE
REPLACE	vtadcp.impNeto WITH ROUND(Thisform.txtImporteNeto.Value, 2) ADDITIVE

IF Thisform.txtIVA105.Value <> 0 THEN
	REPLACE vtadcp.ivaPor WITH 10.5 ADDITIVE
	REPLACE vtadcp.ivaImp WITH Thisform.txtIVA105.Value ADDITIVE
ELSE 
	IF Thisform.txtIVA21.Value <> 0 THEN
		REPLACE vtadcp.ivaPor WITH 21 ADDITIVE
		REPLACE vtadcp.ivaImp WITH Thisform.txtIVA21.Value ADDITIVE
	ELSE 
		REPLACE vtadcp.ivaPor WITH 0 ADDITIVE
		REPLACE vtadcp.ivaImp WITH 0 ADDITIVE
	ENDIF
ENDIF 

REPLACE vtadcp.total WITH Thisform.txtImpTotal.Value ADDITIVE

Thisform.grdDetalle.Refresh()

Thisform.sel_Conceptos.txtCodigo.Value = ""
Thisform.sel_Conceptos.txtdescripcion.Value = ""
Thisform.txtImporteNeto.Value = 0.00
Thisform.txtIVA105.Value = 0.00
Thisform.txtIVA21.Value = 0.00
Thisform.txtImpTotal.Value = 0.00
Thisform.sel_Conceptos.txtCodigo.SetFocus()
Thisform.chkIVA105.Value = 0
Thisform.chkIVA21.Value = 1

Thisform.sumar_items()
Thisform.calcular_ret_iibb()

RETURN .T.
ENDPROC


************************************************************
OBJETO: grdDetalle
************************************************************
*** PROPIEDADES ***
Height = 224
Left = 3
TabIndex = 30
Top = 189
Width = 769
Name = "grdDetalle"
COLUMN1.Header1.Name = "Header1"
COLUMN1.Text1.Name = "Text1"
COLUMN1.Name = "COLUMN1"
COLUMN2.Header1.Name = "Header1"
COLUMN2.Text1.Name = "Text1"
COLUMN2.Name = "COLUMN2"
COLUMN3.Header1.Name = "Header1"
COLUMN3.Text1.Name = "Text1"
COLUMN3.Name = "COLUMN3"
COLUMN4.Header1.Name = "Header1"
COLUMN4.Text1.Name = "Text1"
COLUMN4.Name = "COLUMN4"
COLUMN5.Header1.Name = "Header1"
COLUMN5.Text1.Name = "Text1"
COLUMN5.Name = "COLUMN5"
COLUMN6.Header1.Name = "Header1"
COLUMN6.Text1.Name = "Text1"
COLUMN6.Name = "COLUMN6"
COLUMN7.Header1.Name = "Header1"
COLUMN7.Text1.Name = "Text1"
COLUMN7.Name = "COLUMN7"
COLUMN8.Header1.Name = "Header1"
COLUMN8.Text1.Name = "Text1"
COLUMN8.Name = "COLUMN8"
COLUMN9.Header1.Name = "Header1"
COLUMN9.Text1.Name = "Text1"
COLUMN9.Name = "COLUMN9"
COLUMN10.Header1.Name = "Header1"
COLUMN10.Text1.Name = "Text1"
COLUMN10.Name = "COLUMN10"
COLUMN11.Header1.Name = "Header1"
COLUMN11.Text1.Name = "Text1"
COLUMN11.Name = "COLUMN11"
COLUMN12.Header1.Name = "Header1"
COLUMN12.Text1.Name = "Text1"
COLUMN12.Name = "COLUMN12"
COLUMN13.Header1.Name = "Header1"
COLUMN13.Text1.Name = "Text1"
COLUMN13.Name = "COLUMN13"
COLUMN14.Header1.Name = "Header1"
COLUMN14.Text1.Name = "Text1"
COLUMN14.Name = "COLUMN14"
COLUMN15.Header1.Name = "Header1"
COLUMN15.Text1.Name = "Text1"
COLUMN15.Name = "COLUMN15"
COLUMN16.Header1.Name = "Header1"
COLUMN16.Text1.Name = "Text1"
COLUMN16.Name = "COLUMN16"
COLUMN17.Header1.Name = "Header1"
COLUMN17.Text1.Name = "Text1"
COLUMN17.Name = "COLUMN17"
COLUMN18.Header1.Name = "Header1"
COLUMN18.Text1.Name = "Text1"
COLUMN18.Name = "COLUMN18"
COLUMN19.Header1.Name = "Header1"
COLUMN19.Text1.Name = "Text1"
COLUMN19.Name = "COLUMN19"
COLUMN20.Header1.Name = "Header1"
COLUMN20.Text1.Name = "Text1"
COLUMN20.Name = "COLUMN20"

*** METODOS ***


************************************************************
OBJETO: SubTotal
************************************************************
*** PROPIEDADES ***
Caption = "SubTotal"
Height = 15
Left = 12
Top = 422
Width = 60
TabIndex = 31
Name = "SubTotal"

*** METODOS ***


************************************************************
OBJETO: txtSubTotal
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 72
TabIndex = 9
Top = 418
Width = 86
isnumeric = .T.
Name = "txtSubTotal"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta9
************************************************************
*** PROPIEDADES ***
Caption = "Total:"
Height = 15
Left = 464
Top = 422
Width = 40
TabIndex = 34
Name = "Clsetiqueta9"

*** METODOS ***


************************************************************
OBJETO: txtTotal
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 504
TabIndex = 12
Top = 418
Width = 86
isnumeric = .T.
Name = "txtTotal"

*** METODOS ***


************************************************************
OBJETO: btnGrabar
************************************************************
*** PROPIEDADES ***
Top = 471
Left = 679
Height = 44
Width = 45
TabIndex = 13
Name = "btnGrabar"

*** METODOS ***
PROCEDURE Click
LOCAL lcSql, loCommand, lnIdVentaC, lnPtoVta, lnIdVtasRel, loResCli
LOCAL loNumerador, lnPtoVta, lnNroCbte, lnPorIVA21 
LOCAL lnPorIVA105, lnImpIVA21, lnImpIVA105, lnIdVtaCP, lnIdCC_Cli
LOCAL lnIdOper, lnSaldo, loDateTime
LOCAL lnIdCondPago, lnIdSitIVA, lnIdVendedor, lnPorIIBB, lnImpIIBB, lnIdCC_CliOrig 

lcSql = ""
loDateTime = CREATEOBJECT("datetime")
loCommand = CREATEOBJECT("odbc_command")
loResCli = CREATEOBJECT("odbc_result")
lnIdVentaC = 0
lnPtoVta = INT(VAL(ALLTRIM(getconfig("PTOVTA"))))
lnNroCbte = 0
lnIdVtaCP = 0
lnIdCC_Cli = 0
lnPorIVA21 = 0.00
lnImpIVA21 = 0.00
lnPorIVA105 = 0.00
lnImpIVA105 = 0.00
lnIdOper = 0
lnSaldo = 0.00
lnIdVtasRel = 0
lnIdCondPago = 0
lnIdSitIVA = 0
lnIdVendedor = 0
lnPorIIBB = 0.00
lnImpIIBB = 0.00
lnIdCC_CliOrig = thisform.idcc_cli


SELECT vtadcp
IF RECCOUNT("vtadcp") = 0 THEN
	MESSAGEBOX("Debe ingresar al menos un ítem del detalle", 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

lcSql = "SELECT * FROM clientes WHERE idCliente = " + ALLTRIM(STR(Thisform.idCliente))
loResCli.ActiveConnection = goConn.ActiveConnection
loResCli.Cursor_Name = "cur_cli"

IF !loResCli.OpenQuery(lcSql) THEN
	MESSAGEBOX(loResCli.Error_Message, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

SELECT cur_cli
lnIdCondPago = cur_cli.idCondPago
lnIdSitIVA = cur_cli.idSitIVA
lnIdVendedor = cur_cli.idVendedor

loResCli.Close_Query()

SELECT vtadcp
DO WHILE !EOF("vtadcp") 
	IF vtadcp.ivaPor = 21 THEN
		lnPorIVA21 = vtadcp.ivaPor
		lnImpIVA21 = lnImpIVA21 + vtadcp.ivaImp
	ELSE
		lnPorIVA105 = vtadcp.ivaPor
		lnImpIVA105 = lnImpIVA105 + vtadcp.ivaImp
	ENDIF	

	SELECT vtadcp
	SKIP	
ENDDO

lnPorIIBB = Thisform.txtporIIBB.Value
lnImpIIBB = Thisform.txtImpIIBB.Value

goConn.BeginTransaction()	&& Inicio la transacción

&& Calculo el tipo de comprobante
IF INT(VAL(ALLTRIM(getconfig("DEMO")))) == 0 THEN
	Thisform.Tipodocref = Thisform.calcular_tipodoc()
ELSE
	Thisform.Tipodocref = "X"
ENDIF

IF Thisform.usa_fiscal THEN
	Thisform.enviar_fiscal()
	lnNroCbte = Thisform.fiscal_nrodoc
	
	IF lnNroCbte = 0 THEN
		MESSAGEBOX("Error al enviar el comprobante fiscal, el documento no será grabado", 0+48, Thisform.Caption)
		RETURN .F.
	ENDIF
ELSE
	lcSql = "SELECT * FROM numerador WHERE cbte = '" + ALLTRIM(Thisform.cbte) + "' AND tipoDoc = '" + ALLTRIM(thisform.tipodocref) + "' AND ptoVta = " + ALLTRIM(STR(lnPtoVta))
	loNumerador = CREATEOBJECT("odbc_result")
	loNumerador.ActiveConnection = goConn.ActiveConnection
	loNumerador.Cursor_Name = "cur_num"
	loNumerador.OpenQuery(lcSql)
	SELECT cur_num

	IF RECCOUNT("cur_num") = 0 THEN
		MESSAGEBOX("No se encuentra configurado el numerador del comprobante " + ALLTRIM(Thisform.cbte) + " Punto de Venta: " + ALLTRIM(STR(lnPtoVta)) + " Letra: " + ALLTRIM(thisform.tipodocref), 0+48, thisform.Caption)
		loNumerador.close_query()
		RETURN .F.
	ENDIF

	SELECT cur_num
	lnNroCbte = cur_num.numActual + 1
	Thisform.printerDevice = cur_num.impresora

	loNumerador.close_query()

	&& Actualizo el numerador
	lcSql = "update numerador set numActual = " + ALLTRIM(STR(lnNroCbte)) + ;
		" where cbte = '" + ALLTRIM(Thisform.cbte) + "' and tipoDoc = '" + ALLTRIM(thisform.tipodocref) + "'"

	loCommand.ActiveConnection = goConn.ActiveConnection
	loCommand.CommandText = lcSql

	IF !loCommand.Execute()
		goConn.Rollback()
		RETURN .F.
	ENDIF
ENDIF

lnIdVentaC = goConn.GetNextId("ventascab", "idVentasC")

lcSql = "INSERT INTO ventascab ( "
lcSql = lcSql + "idVentasC, idCliente, razSoc, idTipoDoc, nroDoc, fecEmision, fecVto, cbte, tipoDoc, ptoVta, numCbte, anulado, idCondPago, idSitIVA, idVendedor, "
lcSql = lcSql + "impNeto, impFinal, porIVA21, impIVA21, porIVA105, impIVA105, porDesc1, "
lcSql = lcSql + "porDesc2, porDesc3, porDesc4, impDesc1, impDesc2, impDesc3, impDesc4, totFact, Saldo, usuAlta, fecAlta, idHostAlta, porIIBB, impIIBB, observ) VALUES ("
lcSql = lcSql + ALLTRIM(STR(lnIdVentaC)) + ", "
lcSql = lcSql + ALLTRIM(STR(Thisform.idCliente)) + ", "
lcSql = lcSql + "'" + ALLTRIM(Thisform.cli_razsoc) + "', "
lcSql = lcSql + ALLTRIM(STR(Thisform.cli_idTipodoc)) + ", "
lcSql = lcSql + "'" + ALLTRIM(Thisform.cli_cuit) + "', "
lcSql = lcSql + IIF(Thisform.sqlsrv, "GETDATE(), " , "current_date, ")
lcSql = lcSql + IIF(Thisform.sqlsrv, "GETDATE(), " , "current_date, ")
lcSql = lcSql + "'" + ALLTRIM(Thisform.cbte) + "', "
lcSql = lcSql + "'" + ALLTRIM(Thisform.tipodocref) + "', "
lcSql = lcSql + ALLTRIM(STR(lnPtoVta)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnNroCbte)) + ", "
lcSql = lcSql + "0, "
lcSql = lcSQl + ALLTRIM(STR(lnIdCondPago)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnIdSitIVA)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnIdVendedor)) + ", "
lcSql = lcSql + ALLTRIM(STR(Thisform.txtSubTotal.Value, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(Thisform.txtSubTotal.Value, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnPorIVA21, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpIVA21, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnPorIVA105, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpIVA105, 10, 2)) + ", "
lcSql = lcSql + "0, 0, 0, 0, 0, 0, 0, 0, "
lcSql = lcSql + ALLTRIM(STR(Thisform.txtTotal.Value, 10, 2)) + ", 0, "
lcSql = lcSql + "'" + ALLTRIM(gcCodUsu) + "', "
lcSql = lcSql + loDateTime.getDateTime() + ", " 
lcSql = lcSql + "'" + SYS(0) + "', "
lcSql = lcSql + ALLTRIM(STR(lnPorIIBB, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpIIBB, 10, 2)) + ", "
lcSql = lcSql + "'" + ALLTRIM(thisform.txtobserv.Value) + "')"

loCommand.commandText = lcSql
loCommand.ActiveConnection = goConn.ActiveConnection

IF !loCommand.Execute() then
	goConn.Rollback()
	MESSAGEBOX(loCommand.ErrorMessage, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

&& Grabar el detalle en VTADCP
SELECT vtadcp
GO TOP
DO WHILE !EOF("vtadcp")
	lnIdVtaCP = goConn.GetNextID("vtadcp", "id_vtadcp")
	
	lcSql = "INSERT INTO vtadcp ( "
	lcSql = lcSql + "id_vtadcp, idVentasC, idPlanCta, impNeto, ivaPor, ivaImp, total) VALUES "
	lcSql = lcSql + "(" + ALLTRIM(STR(lnIdVtaCP)) + ", " + ALLTRIM(STR(lnIdVentaC)) + ", " + ALLTRIM(STR(vtadcp.idPlanCta)) + ", "
	lcSql = lcSql + ALLTRIM(STR(vtadcp.impNeto, 10, 2)) + ", " + ALLTRIM(STR(vtadcp.ivaPor, 10, 2)) + ", " + ALLTRIM(STR(vtadcp.ivaImp, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(vtadcp.total, 10, 2)) + ")"
	
	loCommand.ActiveConnection = goConn.ActiveConnection
	loCommand.CommandText = lcSql
	
	IF !loCommand.Execute() THEN
		goConn.Rollback()
		MESSAGEBOX(loCommand.ErrorMessage, 0+48, Thisform.Caption)
		RETURN .F.
	ENDIF
	
	&& Marco el cheque como cheque rechazado
	IF ALLTRIM(vtadcp.cheque_nro) != "" THEN
		lcSql = "UPDATE cheques SET estado = 'R' WHERE chq_nro = '" + ALLTRIM(vtadcp.cheque_nro) + "' AND idBanco = " + ALLTRIM(STR(vtadcp.idBanco))
		loCommand.ActiveConnection = goConn.ActiveConnection
		loCommand.CommandText = lcSql
		
		IF !loCommand.Execute() THEN
			goConn.Rollback()
			MESSAGEBOX(loCommand.ErrorMessage, 0+48, Thisform.Caption)
			RETURN .F.
		ENDIF
	ENDIF

	SELECT vtadcp
	SKIP
ENDDO


&& Grabar el registro en CC_CLI vinculado por Id_Oper al cbte seleccionado
lnIdCC_Cli = goConn.GetNextID("cc_cli", "idCC_Cli")

IF Thisform.idOper = 0 THEN
	lnIdOper = goConn.GetNextID("cc_Cli", "idOper")
ELSE
	lnIdOper = Thisform.idOper
ENDIF

IF ALLTRIM(Thisform.cbte) == "NC" THEN
	lcSql = "INSERT INTO cc_cli (idCC_Cli, idCliente, idCC_Orig, idVentasC, cbte, tipoDoc, ptoVta, nroCbte, fecEmis, fecVto, idCondPago, idSitIVA, idVendedor, "
	lcSql = lcSql + "impDebe, impHaber, idOper, observ, usuAlta, fecAlta, idHostAlta) VALUES ( "
	lcSql = lcSql + ALLTRIM(STR(lnIdCC_Cli)) + ", " + ALLTRIM(STR(Thisform.idCliente)) + ", " + IIF(lnIdCC_CliOrig <> -1, ALLTRIM(STR(lnIdCC_CliOrig)), "null") + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIdVentaC)) + ", '" + ALLTRIM(Thisform.cbte) + "', '" + ALLTRIM(Thisform.TipoDocRef) + "', "
	lcSql = lcSql + ALLTRIM(STR(lnPtoVta)) + ", " + ALLTRIM(STR(lnNroCbte)) + ", " + loDateTime.getDateTime() + ", " + loDateTime.getDateTime() + ", " + ALLTRIM(STR(lnIdCondPago)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIdSitIVA)) + ", " + ALLTRIM(STR(lnIdVendedor)) + ", 0, " + ALLTRIM(STR(Thisform.txtTotal.Value, 10, 2)) + ", " + ALLTRIM(STR(lnIdOPer)) + ", '" + ALLTRIM(thisform.txtobserv.Value) + "', "
	lcSql = lcSql + "'" + ALLTRIM(gcCodUsu) + "', " + loDateTime.getDateTime() + ", '" + ALLTRIM(SYS(0)) + "')"
ELSE
	lcSql = "INSERT INTO cc_cli (idCC_Cli, idCliente, idCC_Orig, idVentasC, cbte, tipoDoc, ptoVta, nroCbte, fecEmis, fecVto, idCondPago, idSitIVA, idVendedor, "
	lcSql = lcSql + "impDebe, impHaber, idOper, observ, usuAlta, fecAlta, idHostAlta) VALUES ( "
	lcSql = lcSql + ALLTRIM(STR(lnIdCC_Cli)) + ", " + ALLTRIM(STR(Thisform.idCliente)) + ", " + IIF(lnIdCC_CliOrig <> -1, ALLTRIM(STR(lnIdCC_CliOrig)), "null") + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIdVentaC)) + ", '" + ALLTRIM(Thisform.cbte) + "', '" + ALLTRIM(Thisform.TipoDocRef) + "', "
	lcSql = lcSql + ALLTRIM(STR(lnPtoVta)) + ", " + ALLTRIM(STR(lnNroCbte)) + ", " + loDateTime.getDateTime() + ", " + loDateTime.getDateTime() + ", " + ALLTRIM(STR(lnIdCondPago)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIdSitIVA)) + ", " + ALLTRIM(STR(lnIdVendedor)) + ", " + ALLTRIM(STR(Thisform.txtTotal.Value, 10, 2)) + ", 0, " + ALLTRIM(STR(lnIdOper)) + ", '" + ALLTRIM(thisform.txtobserv.Value) + "', "
	lcSql = lcSql + "'" + ALLTRIM(gcCodUsu) + "', " + loDateTime.getDateTime() + ", '" + ALLTRIM(SYS(0)) + "')"
ENDIF

loCommand.ActiveConnection = goConn.ActiveConnection
loCommand.CommandText = lcSql

IF !loCommand.Execute() THEN
	goConn.Rollback()
	MESSAGEBOX(loCommand.ErrorMessage, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

IF Thisform.idVentascab <> - 1 THEN

	&& Actualizar idOper del movimiento seleccionado
	lcSql = "UPDATE cc_cli SET idOper = " + ALLTRIM(STR(lnIdOper)) + ", "
	lcSql = lcSql + "usuModi = '" + ALLTRIM(gcCodUsu) + "', "
	lcSql = lcSql + "fecModi = " + loDateTime.getDateTime() + ", "
	lcSql = lcSql + "idHostModi = '" + ALLTRIM(SYS(0)) + "' "
	lcSql = lcSql + "WHERE idCC_Cli = " + ALLTRIM(STR(Thisform.idcc_cli))

	loCommand.CommandText = lcSql
	loCommand.ActiveConnection = goConn.ActiveConnection

	IF !loCommand.Execute()
		goConn.Rollback()
		RETURN .F.
	ENDIF

	&& Generar el registro de vinculación de comprobantes
	lnIdVtasRel = goConn.GetNextId("ventasrel", "idvtarel")

	&& Vinculo el comprobante de venta
	lcSql = "INSERT INTO ventasrel (idVtaRel, idVtaCO, idVtaCD) VALUES "
	lcSql = lcSql + "(" + ALLTRIM(STR(lnIdVtasRel)) + ", " + ALLTRIM(STR(Thisform.idventascab)) + ", " + ALLTRIM(STR(lnIdVentaC)) + ")"

	loCommand.ActiveConnection = goConn.ActiveConnection
	loCommand.CommandText = lcSql

	IF !loCommand.Execute()
		goConn.Rollback()
		RETURN .F.
	ENDIF
ENDIF 

&& Actualizar el saldo de la factura seleccionada
IF ALLTRIM(thisform.cbte) == "NC" THEN

	lcSql = "UPDATE ventascab SET Saldo = Saldo - " + ALLTRIM(STR(Thisform.txtTotal.Value, 10, 2)) + ", "
	lcSql = lcSql + "usuModi = '" + ALLTRIM(gcCodUsu) + "', "
	lcSql = lcSql + "fecModi = " + loDateTime.getDateTime() + ", "
	lcSql = lcSql + "idHostModi = '" + ALLTRIM(SYS(0)) + "' "
	lcSql = lcSql + "WHERE idVentasC IN (SELECT IdVentasC FROM cc_cli WHERE IdOper = " +  ALLTRIM(STR(lnIdOper)) + " AND cbte like 'FC%')"
ELSE 
	lcSql = "UPDATE ventascab SET Saldo = Saldo + " + ALLTRIM(STR(Thisform.txtTotal.Value, 10, 2)) + ", "
	lcSql = lcSql + "usuModi = '" + ALLTRIM(gcCodUsu) + "', "
	lcSql = lcSql + "fecModi = " + loDateTime.getDateTime() + ", "
	lcSql = lcSql + "idHostModi = '" + ALLTRIM(SYS(0)) + "' "
	lcSql = lcSql + "WHERE idVentasC IN (SELECT IdVentasC FROM cc_cli WHERE IdOper = " +  ALLTRIM(STR(lnIdOper)) + " AND cbte like 'FC%')"

ENDIF
	
loCommand.CommandText = lcSql
loCommand.ActiveConnection = goConn.ActiveConnection

IF !loCommand.Execute()
	goConn.Rollback()
	RETURN .F.
ENDIF 

goConn.Commit()

Thisform.ptovta = REPLICATE("0", 4 - LEN(ALLTRIM(STR(lnPtoVta)))) + ALLTRIM(STR(lnPtoVta))
Thisform.nrocbte = REPLICATE("0", 8 - LEN(ALLTRIM(STR(lnNroCbte)))) + ALLTRIM(STR(lnNroCbte))

MESSAGEBOX("El comprobante: " + ALLTRIM(Thisform.cbte) + " " + ALLTRIM(Thisform.Tipodocref) + " " + REPLICATE("0", 4 - LEN(ALLTRIM(STR(lnPtoVta)))) + ALLTRIM(STR(lnPtoVta)) + "-" + ;
	REPLICATE("0", 8 - LEN(ALLTRIM(STR(lnNroCbte)))) + ALLTRIM(STR(lnNroCbte)) + " se ha generado exitosamente...", 0+64, Thisform.Caption)

IF !Thisform.usa_fiscal THEN
	Thisform.imprimir()
ENDIF

Thisform.Release()
RETURN .T.
ENDPROC


************************************************************
OBJETO: btnCerrar
************************************************************
*** PROPIEDADES ***
Top = 471
Left = 727
Height = 44
Width = 45
TabIndex = 14
Name = "btnCerrar"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta10
************************************************************
*** PROPIEDADES ***
Caption = "Banco:"
Height = 15
Left = 12
Top = 94
Width = 72
TabIndex = 24
Name = "Clsetiqueta10"

*** METODOS ***


************************************************************
OBJETO: Sel_Banco
************************************************************
*** PROPIEDADES ***
Top = 87
Left = 91
TabIndex = 2
esnumerico = .F.
cfieldname = codbco
nombre_campo_codigo = codbco
nombre_campo_desc = descripcio
nombre_tabla = bancos
pkfield = idBanco
autocompletar_ceros = .F.
Name = "Sel_Banco"
txtCodigo.Value = 
txtCodigo.Name = "txtCodigo"
txtDescripcion.Name = "txtDescripcion"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta11
************************************************************
*** PROPIEDADES ***
Caption = "Cheque Nº:"
Height = 15
Left = 576
Top = 92
Width = 72
TabIndex = 27
Name = "Clsetiqueta11"

*** METODOS ***


************************************************************
OBJETO: txtNroCheque
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 644
MaxLength = 8
TabIndex = 3
Top = 89
Width = 125
ischaracter = .T.
autocompleta = .T.
Name = "txtNroCheque"

*** METODOS ***
PROCEDURE LostFocus
DODEFAULT()

IF !Thisform.buscar_cheque() THEN
	Thisform.sel_Banco.txtCodigo.SetFocus()
ENDIF

ENDPROC


************************************************************
OBJETO: Fiscal
************************************************************
*** PROPIEDADES ***
Top = 446
Left = 612
Height = 100
Width = 100
Name = "Fiscal"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta12
************************************************************
*** PROPIEDADES ***
Caption = "I.V.A 21:"
Height = 15
Left = 228
Top = 422
Width = 57
TabIndex = 33
Name = "Clsetiqueta12"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta13
************************************************************
*** PROPIEDADES ***
Caption = "I.V.A 10,5:"
Height = 15
Left = 228
Top = 445
Width = 72
TabIndex = 35
Name = "Clsetiqueta13"

*** METODOS ***


************************************************************
OBJETO: txtPorIVA21
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 299
ReadOnly = .T.
TabIndex = 41
Top = 418
Width = 44
isnumeric = .T.
Name = "txtPorIVA21"

*** METODOS ***


************************************************************
OBJETO: txtPorIVA105
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 299
ReadOnly = .T.
TabIndex = 42
Top = 441
Width = 44
isnumeric = .T.
Name = "txtPorIVA105"

*** METODOS ***


************************************************************
OBJETO: txtImpIVA21
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 344
ReadOnly = .T.
TabIndex = 44
Top = 418
Width = 75
isnumeric = .T.
Name = "txtImpIVA21"

*** METODOS ***


************************************************************
OBJETO: txtImpIVA105
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 344
ReadOnly = .T.
TabIndex = 45
Top = 441
Width = 75
isnumeric = .T.
Name = "txtImpIVA105"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta18
************************************************************
*** PROPIEDADES ***
Caption = "Perc. IIBB.:"
Height = 15
Left = 228
Top = 467
Width = 63
TabIndex = 34
Name = "Clsetiqueta18"

*** METODOS ***


************************************************************
OBJETO: txtPorIIBB
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 299
ReadOnly = .T.
TabIndex = 40
Top = 464
Width = 44
isnumeric = .T.
Name = "txtPorIIBB"

*** METODOS ***


************************************************************
OBJETO: txtImpIIBB
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 344
ReadOnly = .T.
TabIndex = 43
Top = 464
Width = 75
isnumeric = .T.
Name = "txtImpIIBB"

*** METODOS ***


************************************************************
OBJETO: Clsdelete1
************************************************************
*** PROPIEDADES ***
Top = 143
Left = 727
Height = 44
Width = 45
Name = "Clsdelete1"

*** METODOS ***
PROCEDURE Click
LOCAL lnResp

lnResp = MESSAGEBOX("Está seguro que desea eliminar este ítem?", 0+4, Thisform.Caption)

IF lnResp = 6 THEN
	SELECT vtadcp 
	DELETE 

	Thisform.grdDetalle.Refresh()

	Thisform.sumar_items()
	Thisform.calcular_ret_iibb()
ENDIF 
ENDPROC


************************************************************
OBJETO: Clsetiqueta7
************************************************************
*** PROPIEDADES ***
Caption = "Leyenda:"
Height = 15
Left = 11
Top = 118
Width = 72
TabIndex = 22
Name = "Clsetiqueta7"

*** METODOS ***


************************************************************
OBJETO: txtobserv
************************************************************
*** PROPIEDADES ***
Enabled = .T.
Height = 21
Left = 93
TabIndex = 18
Top = 113
Width = 550
Name = "txtobserv"

*** METODOS ***


************************************************************
OBJETO: frm_ncnd_cc
************************************************************
*** PROPIEDADES ***
Arial, 0, 8, 5, 14, 11, 29, 3, 0
Arial, 1, 8, 5, 14, 11, 29, 3, 0
Arial, 0, 9, 5, 15, 12, 32, 3, 0

*** METODOS ***


************************************************************
OBJETO: cls_busca_pedido_sf
************************************************************
*** PROPIEDADES ***
BorderStyle = 1
Height = 397
Width = 728
DoCreate = .T.
Caption = "Búsqueda de pedidos ON-Line pendeintes de facturar"
Closable = .F.
cancelar = .F.
idpedcab = 
observ = 
idcliente = 0
Name = "cls_busca_pedido_sf"

*** METODOS ***
PROCEDURE leer_datos
LOCAL loRes
LOCAL lcSql

loRes = CREATEOBJECT("odbc_result")
lcSql = ""

lcSql = "SELECT "
lcSql = lcSql + " pedext.idPedCab, "
lcSql = lcSql + " MAX(pedext.idCliente) AS idCliente, " 
lcSql = lcSql + " MAX(pedext.fecEmis) AS fecha, " 
lcSql = lcSql + " MAX(pedext.observ) AS observ " 
lcSql = lcSql + " FROM  pedext " 
lcSql = lcSql + " WHERE pedext.idCliente = " + ALLTRIM(STR(Thisform.idcliente)) + " "
lcSql = lcSql + " 	AND pedext.procesado = 0 " 
lcSql = lcSql + " GROUP BY pedext.idPedCab " 

loRes.ActiveConnection = goConn.ActiveConnection
loRes.Cursor_Name = "cur_temp"

IF !loRes.OpenQuery(lcSql) THEN
	MESSAGEBOX(loRes.Error_Message, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

SELECT cur_temp
DO WHILE !EOF("cur_temp")
	SELECT cur_Pend
	APPEND BLANK
	REPLACE cur_Pend.idPedCab WITH cur_temp.idPedCab
	REPLACE cur_Pend.fecha WITH cur_temp.fecha ADDITIVE
	REPLACE cur_Pend.idCliente WITH cur_temp.idCliente ADDITIVE
	REPLACE cur_Pend.observ WITH cur_temp.observ ADDITIVE

	SELECT cur_temp
	SKIP
ENDDO

loRes.Close_Query()

SELECT cur_Pend
GO TOP

Thisform.grdPendi.Refresh()
ENDPROC
PROCEDURE Init
DODEFAULT()

SELECT cur_Pend
Thisform.grdPendi.RecordSource = "cur_Pend"
Thisform.grdPendi.alias_name = "cur_Pend"
Thisform.grdPendi.titulos_cabeceras = "#,Fecha,Observac"
Thisform.grdPendi.list_controlsource = "idPedCab,fecha"
Thisform.grdPendi.lista_ancho_cols = "70,350"
Thisform.grdPendi.generar_grid()
ENDPROC
PROCEDURE Load
DODEFAULT()

&& El siguiente cursor graba los archivos pendientes
&& de pedidos que hay que descargar

CREATE CURSOR cur_pend (	;
	idPedCab	int,;
	fecha		datetime,;
	idCliente	int,;
	observ		M)

ENDPROC


************************************************************
OBJETO: grdPendi
************************************************************
*** PROPIEDADES ***
Height = 343
Left = 8
Top = 8
Width = 713
permitir_busqueda = .F.
permitir_ordenamiento = .F.
Name = "grdPendi"
COLUMN1.Header1.Name = "Header1"
COLUMN1.Text1.Name = "Text1"
COLUMN1.Name = "COLUMN1"
COLUMN2.Header1.Name = "Header1"
COLUMN2.Text1.Name = "Text1"
COLUMN2.Name = "COLUMN2"
COLUMN3.Header1.Name = "Header1"
COLUMN3.Text1.Name = "Text1"
COLUMN3.Name = "COLUMN3"
COLUMN4.Header1.Name = "Header1"
COLUMN4.Text1.Name = "Text1"
COLUMN4.Name = "COLUMN4"
COLUMN5.Header1.Name = "Header1"
COLUMN5.Text1.Name = "Text1"
COLUMN5.Name = "COLUMN5"
COLUMN6.Header1.Name = "Header1"
COLUMN6.Text1.Name = "Text1"
COLUMN6.Name = "COLUMN6"
COLUMN7.Header1.Name = "Header1"
COLUMN7.Text1.Name = "Text1"
COLUMN7.Name = "COLUMN7"
COLUMN8.Header1.Name = "Header1"
COLUMN8.Text1.Name = "Text1"
COLUMN8.Name = "COLUMN8"
COLUMN9.Header1.Name = "Header1"
COLUMN9.Text1.Name = "Text1"
COLUMN9.Name = "COLUMN9"
COLUMN10.Header1.Name = "Header1"
COLUMN10.Text1.Name = "Text1"
COLUMN10.Name = "COLUMN10"
COLUMN11.Header1.Name = "Header1"
COLUMN11.Text1.Name = "Text1"
COLUMN11.Name = "COLUMN11"
COLUMN12.Header1.Name = "Header1"
COLUMN12.Text1.Name = "Text1"
COLUMN12.Name = "COLUMN12"
COLUMN13.Header1.Name = "Header1"
COLUMN13.Text1.Name = "Text1"
COLUMN13.Name = "COLUMN13"
COLUMN14.Header1.Name = "Header1"
COLUMN14.Text1.Name = "Text1"
COLUMN14.Name = "COLUMN14"
COLUMN15.Header1.Name = "Header1"
COLUMN15.Text1.Name = "Text1"
COLUMN15.Name = "COLUMN15"
COLUMN16.Header1.Name = "Header1"
COLUMN16.Text1.Name = "Text1"
COLUMN16.Name = "COLUMN16"
COLUMN17.Header1.Name = "Header1"
COLUMN17.Text1.Name = "Text1"
COLUMN17.Name = "COLUMN17"
COLUMN18.Header1.Name = "Header1"
COLUMN18.Text1.Name = "Text1"
COLUMN18.Name = "COLUMN18"
COLUMN19.Header1.Name = "Header1"
COLUMN19.Text1.Name = "Text1"
COLUMN19.Name = "COLUMN19"
COLUMN20.Header1.Name = "Header1"
COLUMN20.Text1.Name = "Text1"
COLUMN20.Name = "COLUMN20"

*** METODOS ***


************************************************************
OBJETO: btnCerrar
************************************************************
*** PROPIEDADES ***
Top = 352
Left = 676
Height = 44
Width = 45
Cancel = .T.
Caption = ""
TabIndex = 3
Name = "btnCerrar"

*** METODOS ***
PROCEDURE Click
Thisform.cancelar = .T.
Thisform.Hide()
ENDPROC


************************************************************
OBJETO: btnAceptar
************************************************************
*** PROPIEDADES ***
Top = 352
Left = 629
Height = 44
Width = 45
Picture = ..\imagen\iconos bajados\aceptar-comprobar-si-puede-icono-9389.ico
Default = .T.
TabIndex = 2
Name = "btnAceptar"

*** METODOS ***
PROCEDURE Click
LOCAL lcUrl, lcRuta, loSoapCli
LOCAL lcFTADDR

lcRuta = ""

SELECT cur_Pend
Thisform.idpedcab = cur_Pend.idPedCab
Thisform.observ = cur_Pend.observ

Thisform.cancelar = .F.
Thisform.Hide()
ENDPROC


************************************************************
OBJETO: cls_busca_pedido_sf
************************************************************
*** PROPIEDADES ***
Arial, 0, 8, 5, 14, 11, 29, 3, 0
Arial, 1, 8, 5, 14, 11, 29, 3, 0
Arial, 0, 9, 5, 15, 12, 32, 3, 0

*** METODOS ***


************************************************************
OBJETO: cls_saldo_a_favor_sf
************************************************************
*** PROPIEDADES ***
DataSession = 1
BorderStyle = 2
Height = 538
Width = 1059
DoCreate = .T.
Caption = "Compensación de Comprobantes"
idcliente = 0
idventasc = 0
idcc_cli = 0
Name = "cls_saldo_a_favor_sf"

*** METODOS ***
PROCEDURE cargar
LOCAL lcSql, loRes

lcSql = ""
loRes = CREATEOBJECT("odbc_result")

SELECT	*	;
FROM	cur_CtaCte ;
WHERE	cur_CtaCte.seleccion = .T. ;
ORDER BY cur_CtaCte.fecEmis ;
INTO CURSOR cur_SelCbtes

SELECT cur_SelCbtes
IF RECCOUNT("cur_SelCbtes") > 0 THEN
	GO TOP
ENDIF

DO WHILE !EOF("cur_SelCbtes")
	&& Si cur_SelCbtes.idVentasC es nulo, entonces, significa que el movimiento no tiene
	&& cabecera de ventas vinculado, por lo tanto, se asume que es un ajuste de débio.
	IF !ISNULL(cur_SelCbtes.idVentasC) THEN
		lcSql = "select	SUM(cc_cli.impDebe) - SUM(cc_cli.impHaber) as saldo "
		lcSql = lcSql + "from	cc_cli "
		lcSql = lcSql + "where	idOper in (	"
		lcSql = lcSql + "			select	idOper	"
		lcSql = lcSql + "			from	cc_cli	"
		lcSql = lcSql + "			where	cc_cli.idVentasC = " + ALLTRIM(STR(cur_SelCbtes.idVentasC)) + " "
		lcSql = lcSql + "				and cc_cli.fecBaja IS NULL) "
		lcSql = lcSql + "	and fecBaja IS NULL "
		lcSql = lcSql + "group by idOper"
	ELSE
		&& Pasa por acá si no tiene idVentaC asociado. Se da en el caso de los ajustes.
		lcSql = "select	SUM(cc_cli.impDebe) - SUM(cc_cli.impHaber) as saldo "
		lcSql = lcSql + "from	cc_cli "
		lcSql = lcSql + "where	idOper = " + ALLTRIM(STR(cur_SelCbtes.idOper)) + " "
		lcSql = lcSql + "	and fecBaja IS NULL "
		lcSql = lcSql + "group by idOper"
	ENDIF
	
	loRes.ActiveConnection = goConn.ActiveConnection
	loRes.Cursor_Name = "cur_tempo"
	
	IF !loRes.OpenQuery(lcSql) THEN
		MESSAGEBOX(loRes.Error_Message, 0+48, Thisform.Caption)
		RETURN .F.
	ENDIF
	
	SELECT cur_tempo
	IF cur_tempo.saldo <= 0 THEN
		MESSAGEBOX("Se está el saldo de la(s) factura(s) seleccionada(s) no puede ser menor o igual que 0(cero)", 0+48, Thisform.Caption)
		loRes.Close_Query()
		thisform.hide()
		RETURN .F.
	ENDIF

	SELECT cur_cbtes
	APPEND BLANK
	REPLACE cur_cbtes.idCC_Cli WITH cur_SelCbtes.idCC_Cli
	REPLACE cur_cbtes.idVentasC WITH IIF(ISNULL(cur_SelCbtes.idVentasC), 0, cur_SelCbtes.idVentasC) ADDITIVE
	REPLACE cur_cbtes.idOper WITH cur_SelCbtes.idOper ADDITIVE
	REPLACE cur_cbtes.fecEmis WITH cur_SelCbtes.fecEmis ADDITIVE
	REPLACE cur_cbtes.fecVto WITH cur_SelCbtes.fecVto ADDITIVE
	REPLACE cur_cbtes.numCbte WITH cur_SelCbtes.numCbte ADDITIVE
	REPLACE cur_cbtes.saldo WITH cur_tempo.saldo ADDITIVE
	
	loRes.Close_Query()
	
	thisform.txtSaldoComp.Value = thisform.txtSaldoComp.Value + cur_cbtes.saldo

	SELECT cur_SelCbtes
	SKIP
ENDDO

SELECT cur_cbtes
IF RECCOUNT("cur_cbtes") > 0 THEN
	GO TOP
ENDIF

SELECT cur_cbtes
thisform.grdCbtes.RecordSource = "cur_cbtes"
thisform.grdCbtes.alias_name = "cur_cbtes"
thisform.grdCbtes.list_controlsource = "fecEmis,fecVto,numCbte,Saldo"
thisform.grdCbtes.lista_ancho_cols = "150,150,150,100"
thisform.grdCbtes.titulos_cabeceras = "Fec. Emisión,Fec. Vto.,Número,Saldo"
thisform.grdCbtes.generar_grid()

&& Ahora levanto los comprobantes disponibles para utilizar en la compensación
lcSql = "SELECT		idCC_Cli, "
lcSql = lcSql + "	idCliente, "
lcSql = lcSql + "	idOper, "
lcSql = lcSql + "	fecEmis, "
lcSql = lcSql + "	cbte, "
lcSql = lcSql + "	tipoDoc, "
lcSql = lcSql + "	ptoVta, "
lcSql = lcSql + "	nroCbte, "
lcSql = lcSql + "	impHaber "
lcSql = lcSql + "FROM	cc_cli "
lcSql = lcSql + "WHERE	Cbte IN ('NC', 'RC', 'CJA', 'AC') "
lcSql = lcSql + "	AND idCliente = " + ALLTRIM(STR(Thisform.idcliente))
lcSql = lcSql + "	AND cc_cli.fecBaja IS NULL "
lcSql = lcSql + "	AND idOper IN ( "
lcSql = lcSql + "		SELECT	idOper "
lcSql = lcSql + "  		FROM	cc_cli "
lcSql = lcSql + "  		WHERE	idCliente = " + ALLTRIM(STR(thisform.idcliente))
lcSql = lcSql + "			AND cc_cli.fecBaja IS NULL "
lcSql = lcSql + "  		GROUP BY idOper "
lcSql = lcSql + "		HAVING (ROUND(SUM(impDebe), 2) - ROUND(SUM(impHaber), 2)) < 0) "
lcSql = lcSql + "ORDER BY fecEmis"

loRes.ActiveConnection = goConn.ActiveConnection
loRes.Cursor_Name = "tmp_cbtes"
loRes.OpenQuery(lcSql)

SELECT tmp_cbtes
DO WHILE !EOF("tmp_cbtes")
	SELECT cur_CbteDisp	
	APPEND BLANK
	REPLACE marcado WITH .F.
	REPLACE cur_CbteDisp.idCC_Cli WITH tmp_cbtes.idCC_Cli ADDITIVE
	REPLACE cur_CbteDisp.idOper WITH tmp_cbtes.idOper ADDITIVE
	REPLACE cur_CbteDisp.fecEmis WITH tmp_cbtes.fecEmis ADDITIVE
	REPLACE cur_CbteDisp.cbte WITH tmp_cbtes.cbte ADDITIVE
	REPLACE cur_CbteDisp.tipoDoc WITH tmp_cbtes.tipoDoc ADDITIVE
	REPLACE cur_CbteDisp.ptoVta WITH REPLICATE("0", 4 - LEN(ALLTRIM(STR(tmp_cbtes.ptoVta)))) + ALLTRIM(STR(tmp_cbtes.ptoVta)) ADDITIVE
	REPLACE cur_CbteDisp.numCbte WITH REPLICATE("0", 8 - LEN(ALLTRIM(STR(tmp_cbtes.nroCbte)))) + ALLTRIM(STR(tmp_cbtes.nroCbte)) ADDITIVE
	REPLACE cur_CbteDisp.importe WITH tmp_cbtes.impHaber ADDITIVE
	REPLACE cur_CbteDisp.restante WITH tmp_cbtes.impHaber ADDITIVE
	
	SELECT tmp_cbtes
	SKIP
ENDDO

loRes.Close_Query()

SELECT cur_CbteDisp
IF RECCOUNT("cur_CbteDisp") > 0 THEN
	GO TOP
ENDIF

&& Asigno los comprobantes disponible a la grilla
SELECT cur_CbteDisp
Thisform.grdCbteDisp.RecordSource = "cur_CbteDisp"
Thisform.grdCbteDisp.list_controlsource = "marcado,fecEmis,cbte,tipoDoc,ptoVta,numCbte,importe"
Thisform.grdCbteDisp.lista_ancho_cols = "70,250,70,70,70,100,100"
Thisform.grdCbteDisp.titulos_cabeceras = "Sel.,Fecha,Comp.,Tipo,Pto. Vta.,Número,Importe"
Thisform.grdCbteDisp.Columns[3].Alignment = 2
Thisform.grdCbteDisp.generar_grid()

Thisform.grdCbteDisp.Columns[1].ReadOnly = .F.

ENDPROC
PROCEDURE grabar
LOCAL loCommand, lcSql, lnIdCC_Cli
LOCAL loRes, lnIdCondPago, lnIdSitIVA, lnIdVendedor
LOCAL loDT

loCommand = CREATEOBJECT("odbc_command")
loRes = CREATEOBJECT("odbc_result")
loDT = CREATEOBJECT("datetime")
lcSql = ""
lnIdCC_Cli = 0

lnIdCondPago = 0
lnIdSitIVA = 0
lnIdVendedor = 0

goConn.BeginTransaction()

SELECT cur_CCMovs
GO TOP

DO WHILE !EOF("cur_CCMovs")
	lcSql = "select * from cc_cli where idCC_Cli = " + ALLTRIM(STR(cur_CCMovs.idCC_Cli))
	loRes.ActiveConnection = goConn.ActiveConnection
	loRes.Cursor_Name = "cur_x"
	
	IF !loRes.OpenQuery(lcSql) THEN
		MESSAGEBOX(loRes.Error_Message, 0+48, Thisform.Caption)
		goConn.Rollback()
		RETURN .F.
	ENDIF
	
	SELECT cur_x
	IF RECCOUNT("cur_x") > 0 THEN
		lnIdCondPago = cur_x.idCondPago
		lnIdSitIVA = cur_x.idSitIVA
		lnIdVendedor = cur_x.idVendedor
	ENDIF
	
	loRes.Close_Query()
	
	IF !cur_CCMovs.isUpd THEN
		lnIdCC_Cli = goConn.getNextID("cc_cli", "idCC_Cli")

		lcSql = "insert into cc_cli ( "
		lcSql = lcSql + "	idCC_Cli, "
		lcSql = lcSql + "	idCliente, "
		lcSql = lcSql + "	idCC_Orig, "
		lcSql = lcSql + "	cbte, "
		lcSql = lcSql + "	tipoDoc, "
		lcSql = lcSql + "	ptoVta, "
		lcSql = lcSql + "	nroCbte, "
		lcSql = lcSql + "	fecEmis, "
		lcSql = lcSql + "	fecVto, "
		lcSql = lcSql + "	impDebe, "
		lcSql = lcSql + "	impHaber, "
		lcSql = lcSql + "	idOper, "
		lcSql = lcSql + "	observ, "
		lcSql = lcSql + "	idCondPago, "
		lcSql = lcSql + "	idSitIVA, "
		lcSql = lcSql + "	idVendedor, "
		lcSql = lcSql + "	usuAlta, "
		lcSql = lcSql + "	fecAlta, "
		lcSql = lcSql + "	idHostAlta) "
		lcSql = lcSql + "VALUES ( "
		lcSql = lcSql + ALLTRIM(STR(lnIdCC_Cli)) + ", "
		lcSql = lcSql + ALLTRIM(STR(thisform.idcliente)) + ", "
		lcSql = lcSql + ALLTRIM(STR(cur_CCMovs.idCC_Cli)) + ", "
		lcSql = lcSql + "'" + ALLTRIM(cur_CCMovs.cbte) + "', "
		lcSql = lcSql + "'" + ALLTRIM(cur_CCMovs.tipoDoc) + "', "
		lcSql = lcSql + ALLTRIM(STR(INT(VAL(cur_CCMovs.ptoVta)))) + ", "
		lcSql = lcSql + ALLTRIM(STR(INT(VAL(cur_CCMovs.numCbte)))) + ", "
		lcSql = lcSql + loDT.toMySql(cur_CCMovs.fecEmis) + ", "
		lcSql = lcSql + loDT.toMySql(cur_CCMovs.fecEmis) + ", "
		lcSql = lcSql + "0, "
		lcSql = lcSql + ALLTRIM(STR(cur_CCMovs.haber, 10, 2)) + ", "
		lcSql = lcSql + ALLTRIM(STR(cur_CCMovs.idOper)) + ", "
		lcSql = lcSql + "'', "
		lcSql = lcSql + ALLTRIM(STR(lnIdCondPago)) + ", "
		lcSql = lcSql + ALLTRIM(STR(lnIdSitIVA)) + ", "
		lcSql = lcSql + ALLTRIM(STR(lnIdVendedor)) + ", "
		lcSql = lcSql + "'" + ALLTRIM(gcCodUsu) + "', "
		lcSql = lcSql + IIF(INT(VAL(getConfig("SQLSRV"))) = 1, "GETDATE()", "current_timestamp") + ", "
		lcSql = lcSql + "'" + ALLTRIM(SYS(0)) + "')"
		
		loCommand.ActiveConnection = goConn.ActiveConnection
		loCommand.CommandText = lcSql
		
		IF !loCommand.Execute() THEN
			MESSAGEBOX(loCommand.ErrorMessage, 0+48,  Thisform.Caption)
			goConn.Rollback()
			RETURN .F.
		ENDIF
		
		&& cuando idVentasC es nulo, entonces, no hay saldo para actualizar en ventascab
		IF !ISNULL(cur_CCMovs.idVentasC) THEN
			&& Actualizo el saldo correspondiente a la factura que se está cancelando.
			lcSql = "update ventascab set saldo = saldo - " + ALLTRIM(STR(cur_CCMovs.haber, 10, 2)) + " "
			lcSql = lcSql + "where idVentasC = " + ALLTRIM(STR(cur_CCMovs.idVentasC))
			
			loCommand.ActiveConnection = goConn.ActiveConnection
			loCommand.CommandText = lcSql
			
			IF !loCommand.Execute() THEN
				MESSAGEBOX(loCommand.ErrorMessage, 0+48, Thisform.Caption)
				goConn.Rollback()
				RETURN .F.
			ENDIF
		ENDIF
	ELSE
		lcSql = "update cc_cli "
		lcSql = lcSql + "SET impHaber = " + ALLTRIM(STR(cur_CCMovs.haber, 10, 2)) + ", "
		lcSql = lcSql + " 	usuModi = '" + ALLTRIM(gcCodUsu) + "', "
		lcSql = lcSql + "	fecModi = current_timestamp, "
		lcSql = lcSql + "	idHostModi = '" + ALLTRIM(SYS(0)) + "' "
		lcSql = lcSql + "where cc_cli.idOper = " + ALLTRIM(STR(cur_CCMovs.idOper))
		lcSql = lcSql + "	and cc_cli.cbte = 'RC'"
				
		loCommand.ActiveConnection = goConn.ActiveConnection
		loCommand.CommandText = lcSql
		
		IF !loCommand.Execute() THEN
			MESSAGEBOX(loCommand.ErrorMessage, 0+48, Thisform.Caption)
			goConn.Rollback()
			RETURN .F.
		ENDIF
	ENDIF
	
	SELECT cur_CCMovs
	SKIP
ENDDO

SELECT cur_tempo
GO TOP

DO WHILE !EOF("cur_tempo")
	IF cur_tempo.restante = 0 THEN
		lcSql = "delete from cc_cli where cc_cli.idCC_Cli = " + ALLTRIM(STR(cur_tempo.idCC_Cli))
	ELSE
		lcSql = "update cc_cli "
		lcSql = lcSql + "SET impHaber = " + ALLTRIM(STR(cur_tempo.restante, 10, 2)) + ", "
		lcSql = lcSql + " 	usuModi = '" + ALLTRIM(gcCodUsu) + "', "
		lcSql = lcSql + "	fecModi = current_timestamp, "
		lcSql = lcSql + "	idHostModi = '" + ALLTRIM(SYS(0)) + "' "
		lcSql = lcSql + "where cc_cli.idCC_Cli = " + ALLTRIM(STR(cur_tempo.idCC_Cli))	
	ENDIF
	
	loCommand.ActiveConnection = goConn.ActiveConnection
	loCommand.CommandText = lcSql
	
	IF !loCommand.Execute() THEN
		goConn.Rollback()
		MESSAGEBOX(loCommand.ErrorMessage, 0+48, Thisform.Caption)
		RETURN .F.
	ENDIF

	SELECT cur_tempo
	SKIP
ENDDO

goConn.Commit()

RETURN .T.
ENDPROC
PROCEDURE compensar
LOCAL lnResto, loForm

lnResto = 0	

SELECT * FROM cur_CbteDisp WHERE cur_CbteDisp.marcado = .T. ;
INTO CURSOR cur_tempo READWRITE

SELECT cur_tempo
GO TOP
DO WHILE !EOF("cur_tempo")
	lnResto = lnResto + cur_tempo.importe
	
	SELECT cur_tempo
	SKIP
ENDDO

IF RECCOUNT("cur_tempo") = 0 THEN
	MESSAGEBOX("Debe seleccionar al menos un comprobante con saldo negativo", 0+48, thisform.Caption)
	RETURN .F.
ENDIF

SELECT cur_cbtes
GO TOP

SELECT cur_tempo
GO TOP

DO WHILE !EOF("cur_tempo")	
	IF lnResto <= 0 THEN
		EXIT
	ENDIF
	
	DO WHILE !EOF("cur_cbtes")
		IF cur_tempo.restante > 0 THEN
			SELECT cur_Movs
			APPEND BLANK
			REPLACE cur_Movs.idOper WITH cur_cbtes.idOper 
			REPLACE cur_Movs.fecEmis WITH cur_cbtes.fecEmis ADDITIVE
			REPLACE cur_Movs.cbte WITH SUBSTR(cur_cbtes.numCbte, 1, 2) ADDITIVE
			REPLACE cur_Movs.tipoDoc WITH SUBSTR(cur_cbtes.numCbte, 4, 1) ADDITIVE
			REPLACE cur_Movs.ptoVta WITH SUBSTR(cur_cbtes.numCbte, 6, 4) ADDITIVE
			REPLACE cur_Movs.numCbte WITH SUBSTR(cur_cbtes.numCbte, 11, 8) ADDITIVE
			REPLACE cur_Movs.debe WITH cur_cbtes.saldo ADDITIVE
			REPLACE cur_Movs.haber WITH 0 ADDITIVE
			
			SELECT cur_Movs
			APPEND BLANK
			REPLACE cur_Movs.idOper WITH cur_cbtes.idOper
			REPLACE cur_Movs.fecEmis WITH cur_cbtes.fecEmis ADDITIVE
			REPLACE cur_Movs.cbte WITH cur_tempo.cbte ADDITIVE
			REPLACE cur_Movs.tipoDoc WITH cur_tempo.tipoDoc ADDITIVE
			REPLACE cur_Movs.ptoVta WITH cur_tempo.ptoVta ADDITIVE
			REPLACE cur_movs.numCbte WITH cur_tempo.numCbte ADDITIVE
			REPLACE cur_Movs.debe WITH 0 ADDITIVE
						
			&& Grabo el movimiento a generar en la base de datos física a parte
			SELECT cur_CCMovs
			APPEND BLANK
			REPLACE cur_CCMovs.idCC_Cli WITH cur_cbtes.idCC_Cli
			REPLACE cur_CCMovs.idOper WITH cur_cbtes.idOper ADDITIVE
			REPLACE cur_CCMovs.idVentasC WITH cur_cbtes.idVentasC ADDITIVE
			REPLACE cur_CCMovs.fecEmis WITH cur_tempo.fecEmis ADDITIVE
			REPLACE cur_CCMovs.cbte WITH cur_tempo.cbte ADDITIVE
			REPLACE cur_CCMovs.tipoDoc WITH cur_tempo.tipoDoc ADDITIVE
			REPLACE cur_CCMovs.ptoVta WITH cur_tempo.ptoVta ADDITIVE
			REPLACE cur_CCMovs.numCbte WITH cur_tempo.numCbte ADDITIVE
			REPLACE cur_CCMovs.debe WITH 0 ADDITIVE
			
			IF cur_cbtes.saldo <= lnResto THEN
				IF cur_cbtes.saldo <= cur_tempo.restante THEN
					SELECT cur_Movs
					REPLACE cur_Movs.haber WITH cur_cbtes.saldo ADDITIVE
					
					SELECT cur_CCMovs
					REPLACE cur_CCMovs.haber WITH cur_cbtes.saldo ADDITIVE
					REPLACE cur_CCMovs.isUpd WITH .F. ADDITIVE
					
					lnResto = lnResto - cur_cbtes.saldo
										
					SELECT cur_tempo
					LOCK()
					REPLACE cur_tempo.restante WITH cur_tempo.restante - cur_cbtes.saldo
					UNLOCK
					
					SELECT cur_cbtes
					LOCK()
					REPLACE cur_cbtes.saldo WITH 0
					UNLOCK
				ELSE
					SELECT cur_Movs
					REPLACE cur_Movs.haber WITH cur_tempo.restante ADDITIVE
					
					SELECT cur_CCMovs
					REPLACE cur_CCMovs.haber WITH cur_tempo.restante ADDITIVE
					REPLACE cur_CCMovs.isUpd WITH .F. ADDITIVE
					
					lnResto = lnResto - cur_tempo.restante
					
					SELECT cur_cbtes
					LOCK()
					REPLACE cur_cbtes.saldo WITH cur_cbtes.saldo - cur_tempo.restante
					UNLOCK
					
					SELECT cur_tempo
					LOCK()
					REPLACE cur_tempo.restante WITH 0
					UNLOCK			
					
					EXIT		
				ENDIF
			ELSE
				* Antes estaba asignando al haber lnResto
				SELECT cur_Movs
				REPLACE cur_Movs.haber WITH cur_tempo.restante ADDITIVE
				
				SELECT cur_CCMovs
				REPLACE cur_CCMovs.haber WITH cur_tempo.restante ADDITIVE
				REPLACE cur_CCMovs.isUpd WITH .F. ADDITIVE
				
				lnResto = lnResto - cur_tempo.restante
				
				SELECT cur_cbtes
				LOCK()
				* REPLACE cur_cbtes.saldo WITH cur_cbtes.saldo - lnResto
				REPLACE cur_cbtes.saldo WITH cur_cbtes.saldo - cur_tempo.restante
				UNLOCK
				
				SELECT cur_tempo
				LOCK()
				REPLACE cur_tempo.restante WITH 0
				UNLOCK
				
				IF cur_cbtes.saldo > 0 THEN
					EXIT
				ENDIF
			ENDIF
		ENDIF
			
		SELECT cur_cbtes
		SKIP
	ENDDO

	SELECT cur_tempo
	SKIP
ENDDO

IF lnResto > 0 THEN
	SELECT cur_tempo
	SKIP -1
	
	SELECT cur_Movs
	APPEND BLANK
	REPLACE cur_Movs.idOper WITH cur_tempo.idOper ADDITIVE
	REPLACE cur_Movs.fecEmis WITH cur_tempo.fecEmis ADDITIVE
	REPLACE cur_Movs.cbte WITH cur_tempo.cbte ADDITIVE
	REPLACE cur_Movs.tipoDoc WITH cur_tempo.tipoDoc ADDITIVE
	REPLACE cur_Movs.ptoVta WITH cur_tempo.ptoVta ADDITIVE
	REPLACE cur_Movs.numCbte WITH cur_tempo.numCbte ADDITIVE
	REPLACE cur_Movs.debe WITH 0 ADDITIVE
	REPLACE cur_Movs.haber WITH lnResto ADDITIVE
	REPLACE cur_Movs.isUpd WITH .T. ADDITIVE

	&& Grabo el movimiento a generar en la base de datos física a parte
	SELECT cur_CCMovs
	APPEND BLANK
	REPLACE cur_CCMovs.idCC_Cli WITH cur_tempo.idCC_Cli
	REPLACE cur_CCMovs.idOper WITH cur_tempo.idOper ADDITIVE
	REPLACE cur_CCMovs.idVentasC WITH cur_cbtes.idVentasC ADDITIVE
	REPLACE cur_CCMovs.fecEmis WITH cur_tempo.fecEmis ADDITIVE
	REPLACE cur_CCMovs.cbte WITH cur_tempo.cbte ADDITIVE
	REPLACE cur_CCMovs.tipoDoc WITH cur_tempo.tipoDoc ADDITIVE
	REPLACE cur_CCMovs.ptoVta WITH cur_tempo.ptoVta ADDITIVE
	REPLACE cur_CCMovs.numCbte WITH cur_tempo.numCbte ADDITIVE
	REPLACE cur_CCMovs.debe WITH 0 ADDITIVE
	REPLACE cur_CCMovs.haber WITH lnResto ADDITIVE
	REPLACE cur_CCMovs.isUpd WITH .T. ADDITIVE
ENDIF


SELECT cur_CCMovs
GO TOP

SELECT cur_Movs
GO TOP
loForm = CREATEOBJECT("cls_form_saf_viewmov")
loForm.show()

RETURN .T.
ENDPROC
PROCEDURE validar
LOCAL lnCantSel, lnImporte, lnImputado

lnCantSel = 0
lnImporte = 0.00
lnImputado = Thisform.txtImpTot.Value

SELECT cur_cbtes
lnCantSel = RECCOUNT("cur_cbtes")

SELECT cur_cbtes
IF RECCOUNT("cur_cbtes") > 0 THEN
	GO TOP
ENDIF

DO WHILE !EOF("cur_cbtes")
	IF (lnCantSel > 1) .AND. lnImputado <= 0 THEN
		RETURN .F.
	ELSE
		lnImputado = lnImputado - cur_cbtes.saldo
	ENDIF
	
	SELECT cur_cbtes
	SKIP
ENDDO

SELECT cur_cbtes
IF RECCOUNT("cur_cbtes") > 0 THEN
	GO TOP
ENDIF

RETURN .T.
ENDPROC
PROCEDURE validar_selnc
lnCantSel = 0
lnImporte = 0.00
lnImputado = thisform.txtSaldoComp.Value

SELECT * FROM cur_CbteDisp WHERE marcado = .T. ;
INTO CURSOR cur_x

SELECT cur_x
lnCantSel = RECCOUNT("cur_x")
USE IN cur_x

SELECT cur_CbteDisp
IF RECCOUNT("cur_CbteDisp") > 0 THEN
	GO TOP
ENDIF

DO WHILE !EOF("cur_CbteDisp")
	IF cur_CbteDisp.marcado THEN
		IF (lnCantSel > 1) .AND. lnImputado <= 0 THEN
			RETURN .F.
		ELSE
			lnImputado = lnImputado - cur_CbteDisp.importe
		ENDIF
	ENDIF

	SELECT cur_CbteDisp
	SKIP
ENDDO

SELECT cur_CbteDisp
IF RECCOUNT("cur_CbteDisp") > 0 THEN
	GO TOP
ENDIF

RETURN .T.
ENDPROC
PROCEDURE Init
DODEFAULT()

thisform.btnGrabar.Enabled = .F.
thisform.btnAceptar.Enabled = .T.

ENDPROC
PROCEDURE Load
LOCAL lcSql, loRes

lcSql = ""
loRes = CREATEOBJECT("odbc_result")

DODEFAULT()

&& Este cursor tiene los comprobantes a compensar
CREATE CURSOR cur_cbtes (	;
	idCC_Cli	int,;
	idVentasC	int,;
	idOper		int,;
	fecEmis		datetime,;
	fecVto		datetime,;
	numCbte		varchar(20),;
	saldo		float(10, 2))	


&& Este cursor tiene los comprobantes disponible para compensar los comprobantes
CREATE CURSOR cur_CbteDisp (	;
	marcado		l,;
	idCC_Cli	int,;
	IdOper		int,;
	fecEmis		datetime,;
	cbte		varchar(3),;
	tipoDoc		varchar(1),;
	ptoVta		varchar(4),;
	numCbte		varchar(8),;
	importe		float(10, 2),;
	restante	float(10, 2))
	

&& En este cursor se graba un borrador de los movimientos a generar en las
&& cuentas corrientes.
CREATE CURSOR cur_Movs (	;
	idOper		int,;		
	fecEmis		datetime,;
	cbte		varchar(3),;
	tipoDoc		varchar(1),;
	ptoVta		varchar(4),;
	numCbte		varchar(8),;
	debe		float(10, 2),;
	haber		float(10, 2),;
	isUpd		l)
	
&& Este cursor graba los movimientos puntuales que hay que generar en la tabla cc_cli de la
&& base de datos
CREATE CURSOR cur_CCMovs (	;
	idCC_Cli	int,;
	idOper		int,;
	idVentasC	int,;		
	fecEmis		datetime,;
	cbte		varchar(3),;
	tipoDoc		varchar(1),;
	ptoVta		varchar(4),;
	numCbte		varchar(8),;
	debe		float(10, 2),;
	haber		float(10, 2),;
	isUpd		l)	
ENDPROC


************************************************************
OBJETO: Clsetiqueta1
************************************************************
*** PROPIEDADES ***
Caption = "Comprobantes a aplicar:"
Height = 15
Left = 12
Top = 10
Width = 144
TabIndex = 6
Name = "Clsetiqueta1"

*** METODOS ***


************************************************************
OBJETO: grdCbtes
************************************************************
*** PROPIEDADES ***
Height = 190
Left = 12
TabIndex = 1
Top = 27
Width = 996
permitir_busqueda = .F.
permitir_ordenamiento = .F.
Name = "grdCbtes"
COLUMN1.Header1.Name = "Header1"
COLUMN1.Text1.Name = "Text1"
COLUMN1.Name = "COLUMN1"
COLUMN2.Header1.Name = "Header1"
COLUMN2.Text1.Name = "Text1"
COLUMN2.Name = "COLUMN2"
COLUMN3.Header1.Name = "Header1"
COLUMN3.Text1.Name = "Text1"
COLUMN3.Name = "COLUMN3"
COLUMN4.Header1.Name = "Header1"
COLUMN4.Text1.Name = "Text1"
COLUMN4.Name = "COLUMN4"
COLUMN5.Header1.Name = "Header1"
COLUMN5.Text1.Name = "Text1"
COLUMN5.Name = "COLUMN5"
COLUMN6.Header1.Name = "Header1"
COLUMN6.Text1.Name = "Text1"
COLUMN6.Name = "COLUMN6"
COLUMN7.Header1.Name = "Header1"
COLUMN7.Text1.Name = "Text1"
COLUMN7.Name = "COLUMN7"
COLUMN8.Header1.Name = "Header1"
COLUMN8.Text1.Name = "Text1"
COLUMN8.Name = "COLUMN8"
COLUMN9.Header1.Name = "Header1"
COLUMN9.Text1.Name = "Text1"
COLUMN9.Name = "COLUMN9"
COLUMN10.Header1.Name = "Header1"
COLUMN10.Text1.Name = "Text1"
COLUMN10.Name = "COLUMN10"
COLUMN11.Header1.Name = "Header1"
COLUMN11.Text1.Name = "Text1"
COLUMN11.Name = "COLUMN11"
COLUMN12.Header1.Name = "Header1"
COLUMN12.Text1.Name = "Text1"
COLUMN12.Name = "COLUMN12"
COLUMN13.Header1.Name = "Header1"
COLUMN13.Text1.Name = "Text1"
COLUMN13.Name = "COLUMN13"
COLUMN14.Header1.Name = "Header1"
COLUMN14.Text1.Name = "Text1"
COLUMN14.Name = "COLUMN14"
COLUMN15.Header1.Name = "Header1"
COLUMN15.Text1.Name = "Text1"
COLUMN15.Name = "COLUMN15"
COLUMN16.Header1.Name = "Header1"
COLUMN16.Text1.Name = "Text1"
COLUMN16.Name = "COLUMN16"
COLUMN17.Header1.Name = "Header1"
COLUMN17.Text1.Name = "Text1"
COLUMN17.Name = "COLUMN17"
COLUMN18.Header1.Name = "Header1"
COLUMN18.Text1.Name = "Text1"
COLUMN18.Name = "COLUMN18"
COLUMN19.Header1.Name = "Header1"
COLUMN19.Text1.Name = "Text1"
COLUMN19.Name = "COLUMN19"
COLUMN20.Header1.Name = "Header1"
COLUMN20.Text1.Name = "Text1"
COLUMN20.Name = "COLUMN20"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta2
************************************************************
*** PROPIEDADES ***
Caption = "Comprobantes con saldos negativos"
Height = 15
Left = 13
Top = 260
Width = 227
TabIndex = 7
Name = "Clsetiqueta2"

*** METODOS ***


************************************************************
OBJETO: grdCbteDisp
************************************************************
*** PROPIEDADES ***
Height = 190
Left = 12
TabIndex = 2
Top = 279
Width = 996
permitir_busqueda = .F.
permitir_ordenamiento = .F.
Name = "grdCbteDisp"
COLUMN1.Header1.Name = "Header1"
COLUMN1.Text1.Name = "Text1"
COLUMN1.CurrentControl = "Clscheckbox1"
COLUMN1.Sparse = .F.
COLUMN1.Name = "COLUMN1"
COLUMN2.Header1.Name = "Header1"
COLUMN2.Text1.Name = "Text1"
COLUMN2.Name = "COLUMN2"
COLUMN3.Header1.Name = "Header1"
COLUMN3.Text1.Name = "Text1"
COLUMN3.Name = "COLUMN3"
COLUMN4.Header1.Name = "Header1"
COLUMN4.Text1.Name = "Text1"
COLUMN4.Name = "COLUMN4"
COLUMN5.Header1.Name = "Header1"
COLUMN5.Text1.Name = "Text1"
COLUMN5.Name = "COLUMN5"
COLUMN6.Header1.Name = "Header1"
COLUMN6.Text1.Name = "Text1"
COLUMN6.Name = "COLUMN6"
COLUMN7.Header1.Name = "Header1"
COLUMN7.Text1.Name = "Text1"
COLUMN7.Name = "COLUMN7"
COLUMN8.Header1.Name = "Header1"
COLUMN8.Text1.Name = "Text1"
COLUMN8.Name = "COLUMN8"
COLUMN9.Header1.Name = "Header1"
COLUMN9.Text1.Name = "Text1"
COLUMN9.Name = "COLUMN9"
COLUMN10.Header1.Name = "Header1"
COLUMN10.Text1.Name = "Text1"
COLUMN10.Name = "COLUMN10"
COLUMN11.Header1.Name = "Header1"
COLUMN11.Text1.Name = "Text1"
COLUMN11.Name = "COLUMN11"
COLUMN12.Header1.Name = "Header1"
COLUMN12.Text1.Name = "Text1"
COLUMN12.Name = "COLUMN12"
COLUMN13.Header1.Name = "Header1"
COLUMN13.Text1.Name = "Text1"
COLUMN13.Name = "COLUMN13"
COLUMN14.Header1.Name = "Header1"
COLUMN14.Text1.Name = "Text1"
COLUMN14.Name = "COLUMN14"
COLUMN15.Header1.Name = "Header1"
COLUMN15.Text1.Name = "Text1"
COLUMN15.Name = "COLUMN15"
COLUMN16.Header1.Name = "Header1"
COLUMN16.Text1.Name = "Text1"
COLUMN16.Name = "COLUMN16"
COLUMN17.Header1.Name = "Header1"
COLUMN17.Text1.Name = "Text1"
COLUMN17.Name = "COLUMN17"
COLUMN18.Header1.Name = "Header1"
COLUMN18.Text1.Name = "Text1"
COLUMN18.Name = "COLUMN18"
COLUMN19.Header1.Name = "Header1"
COLUMN19.Text1.Name = "Text1"
COLUMN19.Name = "COLUMN19"
COLUMN20.Header1.Name = "Header1"
COLUMN20.Text1.Name = "Text1"
COLUMN20.Name = "COLUMN20"

*** METODOS ***


************************************************************
OBJETO: Clscheckbox1
************************************************************
*** PROPIEDADES ***
Top = 23
Left = 37
Alignment = 0
Caption = ""
Name = "Clscheckbox1"

*** METODOS ***
PROCEDURE InteractiveChange
SELECT cur_CbteDisp

IF this.Value THEN
	thisform.txtImpTot.Value = thisform.txtImpTot.Value + cur_CbteDisp.importe
ELSE
	thisform.txtImpTot.Value = thisform.txtImpTot.Value - cur_CbteDisp.importe
ENDIF
ENDPROC


************************************************************
OBJETO: btnCerrar
************************************************************
*** PROPIEDADES ***
Top = 492
Left = 1012
TabIndex = 5
Name = "btnCerrar"

*** METODOS ***


************************************************************
OBJETO: btnGrabar
************************************************************
*** PROPIEDADES ***
Top = 492
Left = 964
TabIndex = 4
Name = "btnGrabar"

*** METODOS ***
PROCEDURE Click
thisform.grabar()
thisform.Release()
ENDPROC


************************************************************
OBJETO: btnAceptar
************************************************************
*** PROPIEDADES ***
Top = 278
Left = 1012
Name = "btnAceptar"

*** METODOS ***
PROCEDURE Click
SELECT cur_CCMovs
ZAP

SELECT cur_Movs
ZAP

IF !thisform.validar() THEN
	MESSAGEBOX("Verifique la selección de facturas.", 0+48, thisform.Caption)
	RETURN
ENDIF

IF !thisform.validar_selnc() THEN
	MESSAGEBOX("Verifique la selección de notas de créditos", 0+48, Thisform.Caption)
	RETURN
ENDIF

IF thisform.compensar() THEN
	thisform.btnGrabar.Enabled = .T.
	thisform.btnAceptar.Enabled = .F.
	thisform.grdCbteDisp.Enabled = .F.
ENDIF

ENDPROC


************************************************************
OBJETO: CLSETIQUETA3
************************************************************
*** PROPIEDADES ***
Caption = "Saldo total a compensar:"
Height = 15
Left = 12
Top = 228
Width = 144
Name = "CLSETIQUETA3"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta4
************************************************************
*** PROPIEDADES ***
Caption = "Importe total seleccionado:"
Height = 15
Left = 12
Top = 473
Width = 164
Name = "Clsetiqueta4"

*** METODOS ***


************************************************************
OBJETO: txtSaldoComp
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 168
ReadOnly = .T.
Top = 224
Width = 113
isnumeric = .T.
Name = "txtSaldoComp"

*** METODOS ***


************************************************************
OBJETO: txtImpTot
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 168
ReadOnly = .T.
Top = 472
Width = 113
isnumeric = .T.
Name = "txtImpTot"

*** METODOS ***


************************************************************
OBJETO: cls_saldo_a_favor_sf
************************************************************
*** PROPIEDADES ***
Arial, 0, 8, 5, 14, 11, 29, 3, 0
Arial, 1, 8, 5, 14, 11, 29, 3, 0
Arial, 0, 9, 5, 15, 12, 32, 3, 0

*** METODOS ***


************************************************************
OBJETO: cls_detalle_recibo
************************************************************
*** PROPIEDADES ***
BorderStyle = 2
Height = 641
Width = 1021
DoCreate = .T.
Caption = "Consulta de recibos"
idrccob_c = 0
idcliente = 0
razsoc = 
nrorec = 
fecemis = {}
fecing = {}
vendedor = 
Name = "cls_detalle_recibo"

*** METODOS ***
PROCEDURE leer_datos
LOCAL loRes, lcSql

Thisform.txtCodCli.Value = Thisform.idcliente
Thisform.txtRazSoc.value = Thisform.razsoc
Thisform.txtNroRec.Value = Thisform.nrorec
Thisform.txtFecEmision.Value = Thisform.fecemis

lcSql = ""
loRes = CREATEOBJECT("odbc_result")

SELECT cur_pagos
ZAP

SELECT cur_cbtevinc
ZAP

lcsql = "SELECT	ventascab.cbte, "
lcSql = lcSql + "	ventascab.tipoDoc, "
lcSql = lcSql + "	ventascab.ptoVta, "
lcSql = lcSql + "	ventascab.numCbte, "
lcSql = lcSql + "	ventascab.fecEmision, "
lcSql = lcSql + "	ventascab.totFact "
lcSql = lcSql + "FROM	rccob_dv  "
lcSql = lcSql + "			INNER JOIN ventascab ON ventascab.idVentasC = rccob_dv.idVentasC "
lcSql = lcSql + "WHERE	idRCCob_C = " + ALLTRIM(STR(Thisform.idrccob_c))

loRes.ActiveConnection = goConn.ActiveConnection
loRes.Cursor_Name = "cur_x"

IF !loRes.OpenQuery(lcSql) THEN
	MESSAGEBOX(loRes.Error_Message, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

SELECT cur_x
GO TOP
DO WHILE !EOF("cur_x")
	SELECT cur_cbtevinc
	APPEND BLANK
	REPLACE cur_cbtevinc.cbte WITH cur_x.cbte
	REPLACE cur_cbtevinc.tipoDoc WITH cur_x.tipoDoc ADDITIVE
	REPLACE cur_cbtevinc.ptoVta WITH REPLICATE("0", 4 - LEN(ALLTRIM(STR(cur_x.ptoVta)))) + ALLTRIM(STR(cur_x.ptoVta)) ADDITIVE
	REPLACE cur_cbtevinc.numCbte WITH REPLICATE("0", 8 - LEN(ALLTRIM(STR(cur_x.numCbte)))) + ALLTRIM(STR(cur_x.numCbte)) ADDITIVE
	REPLACE cur_cbtevinc.fecEmis WITH cur_x.fecEmision ADDITIVE
	REPLACE cur_cbtevinc.totFact WITH cur_x.totFact ADDITIVE

	SELECT cur_x
	SKIP
ENDDO

loRes.Close_Query()
Thisform.grdCbtes.Refresh()

lcSql = "SELECT	rccob_d.idCheque, "
lcSql = lcSql + "	rccob_d.tipopago, "
lcSql = lcSql + "	CASE rccob_d.tipoPago "
lcSql = lcSql + "		WHEN 'E' THEN 'EFECTIVO' "
lcSql = lcSql + "		WHEN 'TD' THEN 'TARJETA DE DEBITO' "
lcSql = lcSql + "		WHEN 'C' THEN 'CHEQUE' "
lcSql = lcSql + "		WHEN 'T' THEN 'DEPOSITO BANCARIO' "
lcSql = lcSql + "		WHEN 'DEP' THEN 'DEPOSITO' "
lcSql = lcSql + "	END descTipoPago, "
lcSql = lcSql + "	planctas.descripcio as descPlan, "
lcSql = lcSql + "	bancos.codBco, "
lcSql = lcSql + "	bancos.descripcio AS nomBco, "
lcSql = lcSql + "	cheques.chq_nro, "
lcSql = lcSql + "	cheques.fecEmis, "
lcSql = lcSql + "	cheques.fecVto, "
lcSql = lcSql + "	cheques.nroCUIT, "
lcSql = lcSql + "	cheques.titular, "
lcSql = lcSql + "	rccob_d.importe "
lcSql = lcSql + "FROM	rccob_d "
lcSql = lcSql + "			LEFT JOIN bancos ON bancos.idBanco = rccob_d.idBanco "
lcSql = lcSql + "			LEFT JOIN planctas ON planctas.idPlanCta = rccob_d.idPlanCta "
lcSql = lcSql + "			LEFT JOIN cheques ON cheques.idCheque = rccob_d.idCheque "
lcSql = lcSql + "WHERE	idRCCob_C = " + ALLTRIM(STR(Thisform.idrccob_c))

loRes.ActiveConnection = goConn.ActiveConnection
loRes.Cursor_Name = "cur_x"

IF !loRes.OpenQuery(lcSql) THEN
	MESSAGEBOX(loRes.Error_Message, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

SELECT cur_x
GO TOP
DO WHILE !EOF("cur_x")
	SELECT cur_pagos
	APPEND BLANK
	REPLACE cur_pagos.tipopago WITH ALLTRIM(cur_x.tipopago)
	REPLACE cur_pagos.descripcio WITH IIF(ISNULL(cur_x.descTipoPago), ALLTRIM(cur_x.descPlan), ALLTRIM(cur_x.descTipoPago)) ADDITIVE
	REPLACE cur_pagos.codBco WITH IIF(ISNULL(cur_x.codBco), "", cur_x.codBco) ADDITIVE
	REPLACE cur_pagos.nomBco WITH IIF(ISNULL(cur_x.nomBco), "", cur_x.nomBco) ADDITIVE
	REPLACE cur_pagos.idCheque WITH cur_x.idCheque ADDITIVE
	REPLACE cur_pagos.ch_nro WITH IIF(ISNULL(cur_x.chq_nro), "", cur_x.chq_nro) ADDITIVE
	REPLACE cur_pagos.ch_femis WITH cur_x.fecEmis ADDITIVE
	REPLACE cur_pagos.ch_fecvto WITH cur_x.fecVto ADDITIVE
	REPLACE cur_pagos.ch_nCuit WITH IIF(ISNULL(cur_x.nroCUIT), "", cur_x.nroCUIT) ADDITIVE
	REPLACE cur_pagos.ch_titul WITH IIF(ISNULL(cur_x.titular), "", cur_x.titular) ADDITIVE
	REPLACE cur_pagos.importe WITH cur_x.importe ADDITIVE

	SELECT cur_x
	SKIP
ENDDO

loRes.Close_Query()

SELECT cur_pagos
GO TOP
Thisform.grdPagos.Refresh()

RETURN .T.
ENDPROC
PROCEDURE imprimir
LOCAL loRes
LOCAL lcSql
LOCAL m.nroRec
LOCAL m.cobrador
LOCAL m.fecha
LOCAL m.idCliente
LOCAL m.razSoc
LOCAL m.domicilio
LOCAL m.localidad
LOCAL m.sitIVA
LOCAL m.nroCUIT
LOCAL m.total
LOCAL m.leyenda
LOCAL m.detfact
LOCAL m.detpag
LOCAL lcSaltoLinea
LOCAL m.efectivo
LOCAL m.TDebito
LOCAL m.TCredito

m.nroRec = thisform.nrorec
m.idCliente = thisform.idcliente
m.razSoc = thisform.razsoc
m.cobrador = thisform.vendedor
m.fecha = thisform.fecemis
m.leyenda = ""
m.efectivo = 0.00
m.TDebito = 0.00
m.TCredito = 0.00

lcSaltoLinea = CHR(13) + CHR(10)

loRes = CREATEOBJECT("odbc_result")
lcSql = ""

&& Levanto los datos que necesito del cliente
lcSql = "SELECT sitiva.descripcio AS descIVA, "
lcSql = lcSql + "clientes.direccion, "
lcSql = lcSql + "clientes.nroCUIT, "
lcSql = lcSql + "localidad.codPostal, "
lcSql = lcSql + "localidad.descripcio, "
lcSql = lcSql + "provincias.descripcio "
lcSql = lcSql + "FROM clientes INNER JOIN localidad ON clientes.idLocalid = localidad.idLocalid "
lcSql = lcSql + "	INNER JOIN provincias ON provincias.idProvin = localidad.idProvin "
lcSql = lcSql + "	INNER JOIN sitiva ON sitiva.idSitIVA = clientes.idSitIVA "
lcSql = lcSql + "WHERE clientes.idCliente = " + ALLTRIM(STR(Thisform.idcliente))

loRes.ActiveConnection = goConn.ActiveConnection
loRes.Cursor_Name = "cur_x"

IF !loRes.OpenQuery(lcSql) THEN
	MESSAGEBOX(loRes.Error_Message, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

SELECT cur_x
m.domicilio = cur_x.direccion
m.localidad = ALLTRIM(cur_x.descripcio) + " (" + ALLTRIM(cur_x.codPostal) + ")"
m.nroCUIT = ALLTRIM(cur_x.nroCUIT)
m.sitIVA = ALLTRIM(cur_x.descIVA)

loRes.Close_Query()

&& Completo el cursor con las facturas seleccionadas que tiene el recibo
&& que se está revisando actualmente.

m.detfact = ""
SELECT cur_cbtevinc
GO TOP

DO WHILE !EOF("cur_cbtevinc")
	m.detfact = m.detfact + ALLTRIM(DTOC(cur_cbtevinc.fecEmis)) + SPACE(2)
	
	m.detfact = m.detfact + ALLTRIM(cur_cbtevinc.cbte) + SPACE(1) + ; 
		ALLTRIM(cur_cbtevinc.tipoDoc) + " " + ;
		ALLTRIM(cur_cbtevinc.ptoVta) + "-" + ALLTRIM(cur_cbtevinc.numCbte) + SPACE(5)
	
	m.detfact = m.detfact + REPLICATE(" ", 9 - LEN(ALLTRIM(STR(cur_cbtevinc.totFact, 10, 2)))) + ALLTRIM(STR(cur_cbtevinc.totFact, 10, 2))
	m.detfact = m.detfact + lcSaltoLinea

	SELECT cur_cbtevinc
	SKIP
ENDDO

SELECT cur_cbtevinc
GO TOP

&& Ahora tengo que levantar el detalle

m.total = 0.00
m.detpag = ""
SELECT cur_pagos
GO TOP

DO WHILE !EOF("cur_pagos")
	m.detpag = m.detpag + IIF(cur_pagos.ch_fecVto = {} .OR. ISNULL(cur_pagos.ch_fecVto), SPACE(10), ALLTRIM(DTOC(cur_pagos.ch_fecVto))) + SPACE(1)	
	
	IF ALLTRIM(cur_pagos.descripcio) == "CHEQUE" THEN
		m.detpag = m.detpag + SUBSTR(ALLTRIM(cur_pagos.nomBco), 1, 20) + ;
			IIF(LEN(ALLTRIM(cur_pagos.nomBco)) < 20, REPLICATE(" ", 20 - LEN(ALLTRIM(cur_pagos.nomBco))), "") + SPACE(1)	
	ELSE	
		m.detpag = m.detpag + SUBSTR(ALLTRIM(cur_pagos.descripcio), 1, 20) + ;
			IIF(LEN(ALLTRIM(cur_pagos.descripcio)) < 20, REPLICATE(" ", 20 - LEN(ALLTRIM(cur_pagos.descripcio))), "") + SPACE(1)
	ENDIF
	
	m.detpag = m.detpag + IIF(ALLTRIM(cur_pagos.ch_nro) == "", SPACE(8), ALLTRIM(cur_pagos.ch_nro)) + SPACE(1)
	
	m.detpag = m.detpag + IIF(ALLTRIM(cur_pagos.ch_nCuit) == "", SPACE(11), ;
		ALLTRIM(cur_pagos.ch_nCuit) + REPLICATE(" ", 11 - LEN(ALLTRIM(cur_pagos.ch_nCuit)))) + SPACE(1)
	
	m.detpag = m.detpag + REPLICATE(" ", 9 - LEN(ALLTRIM(STR(cur_pagos.importe, 10, 2)))) + ALLTRIM(STR(cur_pagos.importe, 10, 2)) + lcSaltoLinea
	
	m.total = m.total + cur_pagos.importe
	
	IF ALLTRIM(cur_pagos.tipopago) == "EFVO" .OR. ALLTRIM(cur_pagos.tipopago) == "E" THEN
		m.efectivo = m.efectivo + cur_pagos.importe
	ENDIF
	
	IF ALLTRIM(cur_pagos.tipopago) == "TD" THEN
		m.TDebito = m.TDebito + cur_pagos.importe
	ENDIF
	
	IF ALLTRIM(cur_pagos.tipopago) == "TC" THEN
		m.TCredito = m.TCredito + cur_pagos.importe
	ENDIF
	
	SELECT cur_pagos
	SKIP
ENDDO

SELECT cur_pagos
GO TOP

&& Levanto la vista previa de la impresora con la posibilidad
&& de seleccionar la impresora en caso de hacer clic en el
&& ícono imprimir
REPORT FORM "rep_recibos" TO PRINTER PROMPT NODIALOG PREVIEW
ENDPROC
PROCEDURE Load
DODEFAULT()

CREATE CURSOR cur_pagos (	;
	tipopago	varchar(5),;
	descripcio	varchar(60) NULL,;
	codBco		varchar(3) NULL,;
	nomBco		varchar(60) NULL,;
	idCheque	int NULL,;
	ch_nro		varchar(8) NULL,;
	ch_femis	D NULL,;
	ch_fecvto	D NULL,;
	ch_nCuit	varchar(20) NULL,;
	ch_titul	varchar(60) NULL,;
	importe		float(10, 2))

CREATE CURSOR cur_cbtevinc (	;
	cbte varchar(3),;
	tipoDoc varchar(1),;
	ptoVta varchar(4),;
	numCbte varchar(8),;
	fecEmis D,;
	totFact  float(10, 2))
	
ENDPROC
PROCEDURE Init
DODEFAULT()

SELECT cur_pagos
Thisform.grdPagos.alias_name = "cur_pagos"
Thisform.grdPagos.RecordSource = "cur_pagos"
Thisform.grdPagos.list_controlsource = "descripcio,codBco,nomBco,importe,ch_nro,ch_femis,ch_fecvto,ch_nCuit,ch_titul"
Thisform.grdPagos.lista_ancho_cols = "300,70,200,100,100,100,100,100,150"
Thisform.grdPagos.titulos_cabeceras = "Descripción,Banco,Nombre,Importe,Cheque Nº,Emision,Vencimiento,CUIT Titualr,Titular"
Thisform.grdPagos.generar_grid()

SELECT cur_cbtevinc
Thisform.grdCbtes.alias_name = "cur_cbtevinc"
Thisform.grdCbtes.RecordSource = "cur_cbtevinc"
Thisform.grdCbtes.list_controlsource = "cbte,tipoDoc,ptoVta,numCbte,fecEmis,totFact"
Thisform.grdCbtes.lista_ancho_cols = "70,70,100,100,100,100"
Thisform.grdCbtes.titulos_cabeceras = "C.B.T.E.,Letra,P. Vta.,Número,Fecha Emisión,Total"
Thisform.grdCbtes.generar_grid()

ENDPROC


************************************************************
OBJETO: Clsetiqueta1
************************************************************
*** PROPIEDADES ***
Caption = "Cliente:"
Height = 15
Left = 14
Top = 12
Width = 72
TabIndex = 13
Name = "Clsetiqueta1"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta2
************************************************************
*** PROPIEDADES ***
Caption = "Nro. Recibo:"
Height = 15
Left = 14
Top = 36
Width = 72
TabIndex = 14
Name = "Clsetiqueta2"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta3
************************************************************
*** PROPIEDADES ***
Caption = "Fecha de Emisión:"
Height = 15
Left = 14
Top = 59
Width = 110
TabIndex = 15
Name = "Clsetiqueta3"

*** METODOS ***


************************************************************
OBJETO: txtCodCli
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 97
ReadOnly = .T.
TabIndex = 1
Top = 8
Width = 140
Name = "txtCodCli"

*** METODOS ***


************************************************************
OBJETO: txtRazSoc
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 240
ReadOnly = .T.
TabIndex = 2
Top = 8
Width = 548
Name = "txtRazSoc"

*** METODOS ***


************************************************************
OBJETO: txtNroRec
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 97
ReadOnly = .T.
TabIndex = 3
Top = 32
Width = 140
Name = "txtNroRec"

*** METODOS ***


************************************************************
OBJETO: txtFecEmision
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 128
ReadOnly = .T.
TabIndex = 5
Top = 55
Width = 140
Name = "txtFecEmision"

*** METODOS ***


************************************************************
OBJETO: grdPagos
************************************************************
*** PROPIEDADES ***
Height = 257
Left = 1
TabIndex = 8
Top = 331
Width = 1016
permitir_busqueda = .F.
permitir_ordenamiento = .F.
Name = "grdPagos"
COLUMN1.Header1.Name = "Header1"
COLUMN1.Text1.Name = "Text1"
COLUMN1.Name = "COLUMN1"
COLUMN2.Header1.Name = "Header1"
COLUMN2.Text1.Name = "Text1"
COLUMN2.Name = "COLUMN2"
COLUMN3.Header1.Name = "Header1"
COLUMN3.Text1.Name = "Text1"
COLUMN3.Name = "COLUMN3"
COLUMN4.Header1.Name = "Header1"
COLUMN4.Text1.Name = "Text1"
COLUMN4.Name = "COLUMN4"
COLUMN5.Header1.Name = "Header1"
COLUMN5.Text1.Name = "Text1"
COLUMN5.Name = "COLUMN5"
COLUMN6.Header1.Name = "Header1"
COLUMN6.Text1.Name = "Text1"
COLUMN6.Name = "COLUMN6"
COLUMN7.Header1.Name = "Header1"
COLUMN7.Text1.Name = "Text1"
COLUMN7.Name = "COLUMN7"
COLUMN8.Header1.Name = "Header1"
COLUMN8.Text1.Name = "Text1"
COLUMN8.Name = "COLUMN8"
COLUMN9.Header1.Name = "Header1"
COLUMN9.Text1.Name = "Text1"
COLUMN9.Name = "COLUMN9"
COLUMN10.Header1.Name = "Header1"
COLUMN10.Text1.Name = "Text1"
COLUMN10.Name = "COLUMN10"
COLUMN11.Header1.Name = "Header1"
COLUMN11.Text1.Name = "Text1"
COLUMN11.Name = "COLUMN11"
COLUMN12.Header1.Name = "Header1"
COLUMN12.Text1.Name = "Text1"
COLUMN12.Name = "COLUMN12"
COLUMN13.Header1.Name = "Header1"
COLUMN13.Text1.Name = "Text1"
COLUMN13.Name = "COLUMN13"
COLUMN14.Header1.Name = "Header1"
COLUMN14.Text1.Name = "Text1"
COLUMN14.Name = "COLUMN14"
COLUMN15.Header1.Name = "Header1"
COLUMN15.Text1.Name = "Text1"
COLUMN15.Name = "COLUMN15"
COLUMN16.Header1.Name = "Header1"
COLUMN16.Text1.Name = "Text1"
COLUMN16.Name = "COLUMN16"
COLUMN17.Header1.Name = "Header1"
COLUMN17.Text1.Name = "Text1"
COLUMN17.Name = "COLUMN17"
COLUMN18.Header1.Name = "Header1"
COLUMN18.Text1.Name = "Text1"
COLUMN18.Name = "COLUMN18"
COLUMN19.Header1.Name = "Header1"
COLUMN19.Text1.Name = "Text1"
COLUMN19.Name = "COLUMN19"
COLUMN20.Header1.Name = "Header1"
COLUMN20.Text1.Name = "Text1"
COLUMN20.Name = "COLUMN20"

*** METODOS ***


************************************************************
OBJETO: btnCerrar
************************************************************
*** PROPIEDADES ***
Top = 592
Left = 972
Cancel = .T.
TabIndex = 11
Name = "btnCerrar"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta5
************************************************************
*** PROPIEDADES ***
Caption = "Comprobantes vinculados"
Height = 15
Left = 14
Top = 83
Width = 158
TabIndex = 17
Name = "Clsetiqueta5"

*** METODOS ***


************************************************************
OBJETO: grdCbtes
************************************************************
*** PROPIEDADES ***
Height = 207
Left = 2
TabIndex = 7
Top = 98
Width = 1015
permitir_busqueda = .F.
permitir_ordenamiento = .F.
Name = "grdCbtes"
COLUMN1.Header1.Name = "Header1"
COLUMN1.Text1.Name = "Text1"
COLUMN1.Name = "COLUMN1"
COLUMN2.Header1.Name = "Header1"
COLUMN2.Text1.Name = "Text1"
COLUMN2.Name = "COLUMN2"
COLUMN3.Header1.Name = "Header1"
COLUMN3.Text1.Name = "Text1"
COLUMN3.Name = "COLUMN3"
COLUMN4.Header1.Name = "Header1"
COLUMN4.Text1.Name = "Text1"
COLUMN4.Name = "COLUMN4"
COLUMN5.Header1.Name = "Header1"
COLUMN5.Text1.Name = "Text1"
COLUMN5.Name = "COLUMN5"
COLUMN6.Header1.Name = "Header1"
COLUMN6.Text1.Name = "Text1"
COLUMN6.Name = "COLUMN6"
COLUMN7.Header1.Name = "Header1"
COLUMN7.Text1.Name = "Text1"
COLUMN7.Name = "COLUMN7"
COLUMN8.Header1.Name = "Header1"
COLUMN8.Text1.Name = "Text1"
COLUMN8.Name = "COLUMN8"
COLUMN9.Header1.Name = "Header1"
COLUMN9.Text1.Name = "Text1"
COLUMN9.Name = "COLUMN9"
COLUMN10.Header1.Name = "Header1"
COLUMN10.Text1.Name = "Text1"
COLUMN10.Name = "COLUMN10"
COLUMN11.Header1.Name = "Header1"
COLUMN11.Text1.Name = "Text1"
COLUMN11.Name = "COLUMN11"
COLUMN12.Header1.Name = "Header1"
COLUMN12.Text1.Name = "Text1"
COLUMN12.Name = "COLUMN12"
COLUMN13.Header1.Name = "Header1"
COLUMN13.Text1.Name = "Text1"
COLUMN13.Name = "COLUMN13"
COLUMN14.Header1.Name = "Header1"
COLUMN14.Text1.Name = "Text1"
COLUMN14.Name = "COLUMN14"
COLUMN15.Header1.Name = "Header1"
COLUMN15.Text1.Name = "Text1"
COLUMN15.Name = "COLUMN15"
COLUMN16.Header1.Name = "Header1"
COLUMN16.Text1.Name = "Text1"
COLUMN16.Name = "COLUMN16"
COLUMN17.Header1.Name = "Header1"
COLUMN17.Text1.Name = "Text1"
COLUMN17.Name = "COLUMN17"
COLUMN18.Header1.Name = "Header1"
COLUMN18.Text1.Name = "Text1"
COLUMN18.Name = "COLUMN18"
COLUMN19.Header1.Name = "Header1"
COLUMN19.Text1.Name = "Text1"
COLUMN19.Name = "COLUMN19"
COLUMN20.Header1.Name = "Header1"
COLUMN20.Text1.Name = "Text1"
COLUMN20.Name = "COLUMN20"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta6
************************************************************
*** PROPIEDADES ***
Caption = "Movimientos de fondo"
Height = 15
Left = 14
Top = 314
Width = 158
TabIndex = 18
Name = "Clsetiqueta6"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta7
************************************************************
*** PROPIEDADES ***
Caption = "Vendedor:"
Height = 15
Left = 249
Top = 36
Width = 72
TabIndex = 12
Name = "Clsetiqueta7"

*** METODOS ***


************************************************************
OBJETO: txtVendedor
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 312
ReadOnly = .T.
TabIndex = 4
Top = 32
Width = 476
Name = "txtVendedor"

*** METODOS ***


************************************************************
OBJETO: btnImprimir
************************************************************
*** PROPIEDADES ***
Top = 592
Left = 924
TabIndex = 10
Name = "btnImprimir"

*** METODOS ***
PROCEDURE Click
thisform.imprimir()
ENDPROC


************************************************************
OBJETO: btnEliminar
************************************************************
*** PROPIEDADES ***
Top = 592
Left = 863
TabIndex = 9
Name = "btnEliminar"

*** METODOS ***
PROCEDURE Click
LOCAL lnResp
LOCAL loRes
LOCAL loRes_1
LOCAL loCommand
LOCAL lcSql
LOCAL lcCbte
LOCAL lnPtoVta
LOCAL lnNroCbte
LOCAL lnImpHaber

loRes = CREATEOBJECT("odbc_result")
loRes_1 = CREATEOBJECT("odbc_result")
loCommand = CREATEOBJECT("odbc_command")
lcSql = ""
lnResp = 0
lcCbte = ""
lnPtoVta = 0
lnNroCbte = 0
lnImpHaber = 0.00

lnResp = MESSAGEBOX("¿Está seguro que desea anular el recibo?", 4+32, Thisform.Caption)
IF lnResp = 6 THEN
	goConn.BeginTransaction()
	
	SELECT cur_pagos
	DO WHILE !EOF("cur_pagos")
		&& Verifico si el detalle está asociado a algún cheque.
		IF !ISNULL(cur_pagos.idCheque) THEN	
			lcSql = "UPDATE cheques "
			lcSql = lcSql + "SET cheques.usuBaja = '" + ALLTRIM(gcCodUsu) + "', "
			lcSql = lcSql + "	 cheques.fecBaja = current_timestamp, "
			lcSql = lcSql + "	 cheques.idHostBaja = '" + ALLTRIM(SYS(0)) + "' "
			lcSql = lcSql + "WHERE cheques.idCheque = " + ALLTRIM(STR(cur_pagos.idCheque))
			_cliptext = lcSql
			loCommand.ActiveConnection = goConn.ActiveConnection
			loCommand.CommandText = lcSql
			
			IF !loCommand.Execute() THEN
				goConn.Rollback()
				MESSAGEBOX(loCommand.ErrorMessage, 0+48, Thisform.Caption)
				RETURN
			ENDIF
		ENDIF
	
		SELECT cur_pagos
		SKIP
	ENDDO
		
	&& Busco los datos de RC para hacer el cruce contra cc_cli
	lcSql = "SELECT * "
	lcSql = lcSql + "FROM rccob_c "
	lcSql = lcSql + "WHERE rccob_c.idRCCob_C = " + ALLTRIM(STR(Thisform.idrccob_c))
	
	loRes.ActiveConnection = goConn.ActiveConnection
	loRes.Cursor_Name = "cur_rc"
	
	IF !loRes.OpenQuery(lcSql) THEN
		goConn.Rollback()
		MESSAGEBOX(loRes.Error_Message, 0+48, Thisform.Caption)
		RETURN
	ENDIF
	
	lcCbte = "RC"
	lnPtoVta = INT(VAL(SUBSTR(cur_rc.nroRec, 1, 4)))
	lnNroCbte = INT(VAL(SUBSTR(cur_rc.nroRec, 6, LEN(ALLTRIM(cur_rc.nroRec)))))
	
	loRes.Close_Query()
	
	&& Tengo que pensar como voy a recuperar el importe a sumar en el saldo
	&& de las FCs vinculadas
	lcSql = "SELECT idCC_Cli, idOper, impHaber FROM cc_cli "
	lcSql = lcSql + "WHERE cbte = '" + ALLTRIM(lcCbte) + "' "
	lcSql = lcSql + "	AND ptoVta = " + ALLTRIM(STR(lnPtoVta)) + " "
	lcSql = lcSql + "	AND nroCbte = " + ALLTRIM(STR(lnNroCbte))
	
	loRes.ActiveConnection = goConn.ActiveConnection
	loRes.Cursor_Name = "cur_ctacte"
	
	IF !loRes.OpenQuery(lcSql) THEN
		MESSAGEBOX(loRes.Error_Message, 0+48, Thisform.Caption)
		RETURN
	ENDIF
	
	SELECT cur_ctacte
	DO WHILE !EOF("cur_ctacte")
		lcSql = "SELECT * FROM cc_cli "
		lcSql = lcSql + "WHERE idOper = " + ALLTRIM(STR(cur_ctacte.idOper)) + " "
		lcSql = lcSql + "	AND cbte = 'FC'"
		
		loRes_1.ActiveConnection = goConn.ActiveConnection
		loRes_1.Cursor_Name = "cur_ccFC"
		
		IF !loRes_1.OpenQuery(lcSql) THEN
			MESSAGEBOX(loRes_1.Error_Message, 0+48, Thisform.Caption)
			RETURN
		ENDIF
		
		SELECT cur_ccFC
		IF RECCOUNT("cur_ccFC") > 0 THEN
			&& Paso por aca solo si encuentra la FC de origen en la cuenta corriente porque
			&& tengo que tener en cuenta que se cargan recibos por pagos anticipados donde no
			&& se vinculan ninguna factura.
			
			lcSql = "UPDATE ventascab "
			lcSql = lcSql + "SET saldo = saldo + " + ALLTRIM(STR(cur_ctacte.impHaber, 10, 2)) + " "
			lcSql = lcSql + "WHERE ventascab.idVentasC = " + ALLTRIM(STR(cur_ccFC.idVentasC))
			
			loCommand.ActiveConnection = goConn.ActiveConnection
			loCommand.CommandText = lcSql
			
			IF !loCommand.Execute() THEN
				MESSAGEBOX(loCommand.ErrorMessage, 0+48, Thisform.Caption)
				RETURN
			ENDIF
		ENDIF
		
		loRes_1.Close_Query()
	
		SELECT cur_ctacte
		SKIP
	ENDDO
	
	loRes.Close_Query()
	
	&& Elimino el registro de cuentas corrientes
	lcSql = "UPDATE cc_cli "
	lcSql = lcSql + "SET usuBaja = '" + ALLTRIM(gcCodUsu) + "', "
	lcSql = lcSql + "	fecBaja = current_timestamp, "
	lcSql = lcSql + "	idHostBaja = '" + ALLTRIM(SYS(0)) + "' "
	lcSql = lcSql + "WHERE cbte = '" + ALLTRIM(lcCbte) + "'" 
	lcSql = lcSql + "	AND tipoDoc = 'X' "
	lcSql = lcSql + "	AND ptoVta = " + ALLTRIM(STR(lnPtoVta)) + " "
	lcSql = lcSql + "	AND nroCbte = " + ALLTRIM(STR(lnNroCbte))
	
	loCommand.ActiveConnection = goConn.ActiveConnection
	loCommand.CommandText = lcSql
	
	IF !loCommand.Execute() THEN
		goConn.Rollback()
		MESSAGEBOX(loCommand.ErrorMessage, 0+48, Thisform.Caption)
		RETURN
	ENDIF
		
	&& Por último procedo a eliminar el registro de cabecera del recibo
	lcSql = "UPDATE rccob_c "
	lcSql = lcSql + "SET usuBaja = '" + ALLTRIM(gcCodUsu) + "', "
	lcSql = lcSql + "	fecBaja = current_timestamp, "
	lcSql = lcSql + "	idHostBaja = '" + ALLTRIM(SYS(0)) + "' "
	lcSql = lcSql + "WHERE idRCCob_C = " + ALLTRIM(STR(Thisform.idrccob_c))
	
	loCommand.ActiveConnection = goConn.ActiveConnection
	loCommand.CommandText = lcSql
	
	IF !loCommand.Execute() THEN
		goConn.Rollback()
		MESSAGEBOX(loCommand.ErrorMessage, 0+48, Thisform.Caption)
		RETURN
	ENDIF
	
	goConn.Commit()
	MESSAGEBOX("El recibo fué eliminado con éxito", 0+64, Thisform.Caption)
	Thisform.Release()
ENDIF




ENDPROC


************************************************************
OBJETO: cls_detalle_recibo
************************************************************
*** PROPIEDADES ***
Arial, 0, 8, 5, 14, 11, 29, 3, 0
Arial, 1, 8, 5, 14, 11, 29, 3, 0
Arial, 0, 9, 5, 15, 12, 32, 3, 0

*** METODOS ***


************************************************************
OBJETO: cls_form_ctacte
************************************************************
*** PROPIEDADES ***
BorderStyle = 3
Height = 533
Width = 956
DoCreate = .T.
Tag = ""
Caption = "Cuentas Corrientes de Clientes"
MaxButton = .T.
MinButton = .T.
WindowType = 0
cli_calle = 
cli_cuit = 
cli_telefono = 
idcliente = 0
cli_razsoc = 
cli_pcia = 
cli_sitiva = 
idsitiva = 0
cli_localidad = 
cli_codpostal = 
cli_tipodoc = 
cli_idtipodoc = 0
envcbte = .F.
mailfc = 
printcbte = .F.
Name = "cls_form_ctacte"

*** METODOS ***
PROCEDURE llenar_grilla
&& Esta rutina permite recuperar los datos de la tabla
&& de cuentas corrientes

LOCAL lcSql, loResult, lnIdOperAnt, lnSaldo, lnBandera, lnSqlSrv, lnSaldoTot
LOCAL loCliente, loSitIva, loVendedor, loCondPago

lnSqlSrv = VAL(getconfig("SQLSRV"))

lcSql = ""
lnIdOperAnt = 0
lnSaldo = 0
lnSaldoTot = 0.00
loResult = CREATEOBJECT("odbc_result")
loCliente = CREATEOBJECT("odbc_result")
loSitIva = CREATEOBJECT("odbc_result")
loVendedor = CREATEOBJECT("odbc_result")
loCondPago = CREATEOBJECT("odbc_result")

IF Thisform.Contenido.sel_Cliente.txtCodigo.Value = 0 THEN
	MESSAGEBOX("Debe ingresar el cliente", 0+48, Thisform.Caption)
	Thisform.Contenido.sel_Cliente.txtCodigo.SetFocus()
	RETURN .F.
ENDIF

SELECT cur_CtaCte
ZAP

lcSql = "SELECT	cc.*, "
lcSql = lcSql + "(CASE WHEN operfc.fecfc is null THEN (CASE WHEN operadnd.fecadnd is null THEN fecemis ELSE operadnd.fecadnd END) ELSE operfc.fecfc END) AS fecha, "
lcSql = lcSql + "(CASE WHEN cbte = 'PTO' OR cbte = 'FC' OR cbte = 'FCO' THEN  1 ELSE "
lcSql = lcSql + "	(CASE WHEN cbte = 'RC' OR cbte = 'RCC' OR cbte = 'PA' THEN  4 ELSE "
lcSql = lcSql + "		(CASE WHEN cbte = 'NC' THEN  5 ELSE "
lcSql = lcSql + "			(CASE WHEN cbte = 'AC' THEN  6 ELSE "
lcSql = lcSql + "				(CASE WHEN cbte = 'AD' THEN  3 ELSE "
lcSql = lcSql + "					(CASE WHEN cbte = 'ND' THEN  2 ELSE "
lcSql = lcSql + "						(CASE WHEN cbte = 'AN' THEN  2 ELSE 0 END) "
lcSql = lcSql + "					END) "
lcSql = lcSql + "				END) "
lcSql = lcSql + "			END) "
lcSql = lcSql + "		END) "
lcSql = lcSql + "	END) "
lcSql = lcSql + "END) AS Orden2 "
lcSql = lcSql + " FROM  cc_cli cc "
lcSql = lcSql + " 	left join ( SELECT idoper, MAX(fecemis) AS 'fecfc' "
lcSql = lcSql + " 				FROM cc_cli "
lcSql = lcSql + " 				WHERE cbte IN ('FC') and idoper != 0"
lcSql = lcSql + " 				GROUP BY idoper) AS operfc ON cc.idoper = operfc.idoper "
lcSql = lcSql + " 	left join ( SELECT idoper, MAX(fecemis) AS 'fecadnd' "
lcSql = lcSql + " 				FROM cc_cli "
lcSql = lcSql + " 				WHERE cbte IN ('AD','ND') and idoper != 0"
lcSql = lcSql + " 				GROUP BY idoper) AS operadnd ON cc.idoper = operadnd.idoper "
lcSql = lcSql + " WHERE idCliente = " + ALLTRIM(STR(Thisform.Contenido.sel_Cliente.valcpoid)) + " "
lcSql = lcSql + "	AND cc.idOper IN (SELECT cc_cli.idOper "
lcSql = lcSql + "					FROM cc_cli "
lcSql = lcSql + "					WHERE idCliente = " + ALLTRIM(STR(Thisform.Contenido.sel_Cliente.valcpoid)) + " "
lcSql = lcSql + " 						AND (UsuBaja IS NULL OR UsuBaja = '') "
lcSql = lcSql + "					GROUP BY cc_cli.idOper HAVING ROUND(SUM(cc_cli.impDebe - cc_cli.impHaber),2) <> 0) "
lcSql = lcSql + " 	AND (UsuBaja IS NULL OR UsuBaja = '') "
lcSql = lcSql + "ORDER BY fecha, cc.idOper, Orden2, nroCbte"

loResult.ActiveConnection = goConn.ActiveConnection
loResult.Cursor_Name = "tmp_cc"
loResult.OpenQuery(lcSql)

lnBandera = 0

SELECT tmp_cc
lnIdOperAnt = tmp_cc.idOper

DO WHILE !EOF("tmp_cc")
	SELECT cur_CtaCte
	APPEND BLANK
	REPLACE cur_CtaCte.seleccion WITH .F.
	REPLACE cur_CtaCte.idCC_Cli WITH tmp_cc.idCC_Cli ADDITIVE
	REPLACE cur_CtaCte.idVentasC WITH tmp_cc.idVentasC ADDITIVE
	REPLACE cur_CtaCte.idOper WITH tmp_cc.idOper ADDITIVE
	REPLACE cur_CtaCte.fecEmis WITH tmp_cc.fecEmis ADDITIVE
	REPLACE cur_CtaCte.fecVto WITH tmp_cc.fecVto ADDITIVE
	REPLACE cur_CtaCte.numCbte WITH ALLTRIM(tmp_cc.cbte) + " " + ALLTRIM(tmp_cc.tipoDoc) + " " + getPtoVta(tmp_cc.ptoVta) + "-" + getNroCbte(tmp_cc.nroCbte) ADDITIVE
	REPLACE cur_CtaCte.impDebe WITH tmp_cc.impDebe ADDITIVE
	REPLACE cur_CtaCte.impHaber WITH tmp_cc.impHaber ADDITIVE
	REPLACE cur_ctacte.observ WITH IIF(ISNULL(tmp_cc.observ), " ", ALLTRIM(tmp_cc.observ)) ADDITIVE
	
	IF lnIdOperAnt != tmp_cc.idOper THEN
		IF lnBandera = 0 THEN
			lnBandera = 1
		ELSE
			lnBandera = 0
		ENDIF
				
		IF tmp_cc.impDebe != 0 THEN
			lnSaldo = tmp_cc.impDebe
		ELSE
			lnSaldo = tmp_cc.impHaber * -1
		ENDIF
	ELSE
		IF tmp_cc.impDebe != 0 THEN
			lnSaldo = lnSaldo + tmp_cc.impDebe
		ELSE
			lnSaldo = lnSaldo - tmp_cc.impHaber
		ENDIF
	ENDIF
	
	lnSaldoTot = lnSaldoTot + IIF(tmp_cc.impDebe <> 0, tmp_cc.impdebe, (tmp_cc.imphaber * -1))
	
	REPLACE cur_CtaCte.saldo WITH lnSaldo ADDITIVE
	REPLACE cur_CtaCte.bandera WITH lnBandera ADDITIVE
	
	lnIdOperAnt = tmp_cc.idOper

	SELECT tmp_cc
	SKIP
ENDDO

loResult.Close_Query()

SELECT cur_CtaCte
IF RECCOUNT("cur_CtaCte") > 0 THEN
	GO TOP
ENDIF

lcSql = "SELECT * FROM clientes WHERE idCliente = " + ALLTRIM(STR(thisform.contenido.sel_cliente.valcpoid))
loCliente.ActiveConnection = goConn.ActiveConnection
loCliente.Cursor_Name = "cur_cliente"
loCliente.OpenQuery(lcSql)

lcSql = "SELECT * FROM sitiva WHERE idsitiva = " + ALLTRIM(STR(cur_cliente.idsitiva))
loSitIva.ActiveConnection = goConn.ActiveConnection
loSitIva.Cursor_Name = "cur_sitiva"
loSitIva.OpenQuery(lcSql)

thisform.contenido.txtsitiva.Value = ALLTRIM(cur_sitiva.descripcio)

loSitIva.Close_Query()

lcSql = "SELECT * FROM vendedores WHERE idVendedor = " + ALLTRIM(STR(cur_cliente.idvendedor))
loVendedor.ActiveConnection = goConn.ActiveConnection
loVendedor.Cursor_Name = "cur_vendedores"
loVendedor.OpenQuery(lcSql)

thisform.contenido.txtcodvend.Value = ALLTRIM(STR(cur_vendedores.idvendedor))
thisform.contenido.txtvendedor.Value = ALLTRIM(cur_vendedores.nombre)

loVendedor.Close_Query()

lcSql = "SELECT * FROM condpagos WHERE idcondpago = " + ALLTRIM(STR(cur_cliente.idcondpago))
loCondPago.ActiveConnection = goConn.ActiveConnection
loCondPago.Cursor_Name = "cur_condpago"
loCondPago.OpenQuery(lcSql)

thisform.contenido.txtcondpago.Value = ALLTRIM(cur_condpago.descripcio)

loCondPago.Close_Query()
loCliente.Close_Query()

thisform.contenido.txtsaldo.Value = lnSaldoTot

Thisform.grdCtaCte.Refresh()

ENDPROC
PROCEDURE validar_seleccion
LOCAL lnPosActual, lnCont

SELECT cur_CtaCte
IF RECCOUNT("cur_CtaCte") > 0 THEN
	lnPosActual = RECNO("cur_CtaCte")
	GO TOP
ENDIF

lnCont = 0
DO WHILE !EOF("cur_CtaCte")
	IF cur_CtaCte.seleccion THEN
		lnCont = lnCont + 1
	ENDIF

	SELECT cur_CtaCte
	SKIP
ENDDO

SELECT cur_CtaCte
IF RECCOUNT("cur_CtaCte") > 0 THEN
	GO lnPosActual
ENDIF

IF lnCont = 0 THEN
	MESSAGEBOX("Debe seleccionar un comprobante", 0+48, thisform.Caption)
	RETURN .F.
ENDIF

RETURN .T.


ENDPROC
PROCEDURE Load
DODEFAULT()

CREATE CURSOR cur_CtaCte ( ;
	seleccion	l,;
	idCC_Cli	int,;
	idVentasC	int null,;
	idOper		int null,;
	fecEmis		datetime,;
	fecVto		datetime null,;
	numCbte		varchar(20),;
	impDebe		double,;
	impHaber	double,;
	saldo		double,;
	observ		varchar(100),;
	bandera		int)

SELECT cur_CtaCte

ENDPROC
PROCEDURE Init
DODEFAULT()

SELECT cur_CtaCte
Thisform.grdCtaCte.RecordSource = "cur_CtaCte"
Thisform.grdCtaCte.list_controlsource = "seleccion,fecEmis,fecVto,numCbte,impDebe,impHaber,saldo,observ,bandera"
Thisform.grdCtaCte.lista_ancho_cols = "50,200,200,200,100,100,100,300,0"
Thisform.grdCtaCte.titulos_cabeceras = "#,Fecha,Fec. Vto.,Comprobante,Debe,Haber,Saldo,Observaciones,#"
Thisform.grdCtaCte.Columns[1].ReadOnly = .F.
Thisform.grdCtaCte.Columns[9].Visible = .F.

Thisform.grdCtaCte.SetAll("DynamicBackColor", "iif(cur_CtaCte.bandera = 0, RGB(255,255,255), RGB(255,205,155))", "Column")
Thisform.grdCtaCte.generar_grid()
Thisform.WindowState = 2

ENDPROC


************************************************************
OBJETO: Contenido
************************************************************
*** PROPIEDADES ***
Anchor = 11
Top = 4
Left = 6
Width = 945
Height = 82
BackStyle = 1
BackColor = 237,218,205
Name = "Contenido"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta1
************************************************************
*** PROPIEDADES ***
Anchor = 0
Caption = "Cliente:"
Height = 15
Left = 9
Top = 12
Width = 60
Name = "Clsetiqueta1"

*** METODOS ***


************************************************************
OBJETO: sel_cliente
************************************************************
*** PROPIEDADES ***
Anchor = 0
Top = 6
Left = 90
esnumerico = .T.
nombre_campo_codigo = idCliente
nombre_campo_desc = razSoc
nombre_tabla = clientes
pkfield = idCliente
Name = "sel_cliente"
txtCodigo.Name = "txtCodigo"
txtDescripcion.Name = "txtDescripcion"

*** METODOS ***
PROCEDURE recuperar_datos
LOCAL lo_rsSitIVA, lo_rsCondPago, lo_rsLocalidad, lo_rsPcia, lcSql
LOCAL loResult

lo_rsSitIVA = CREATEOBJECT("odbc_result")
lo_rsCondPago = CREATEOBJECT("odbc_result")
lo_rsLocalidad = CREATEOBJECT("odbc_result")
lo_rsPcia = CREATEOBJECT("odbc_result")
loResult = CREATEOBJECT("odbc_result")
lcSql = ""

SELECT clientes
lcSql = "SELECT * FROM tipodoc WHERE idTipoDoc = " + ALLTRIM(STR(clientes.idTipoDoc))

loResult.ActiveConnection = goConn.ActiveConnection
loResult.cursor_name = "cur_x"

IF !loResult.OpenQuery(lcSql) THEN
	MESSAGEBOX(loResult.Error_Message, 0+48, Thisform.Caption)
	RETURN
ENDIF

Thisform.cli_tipodoc = cur_x.tipodoc
Thisform.cli_idTipoDoc = cur_x.idTipoDoc

loResult.Close_Query()

Thisform.cli_calle = ALLTRIM(clientes.direccion)
Thisform.cli_cuit = ALLTRIM(clientes.nroCUIT)
Thisform.cli_telefono = clientes.telefono
Thisform.idcliente = clientes.idCliente
Thisform.cli_razsoc = ALLTRIM(clientes.RazSoc)
Thisform.envcbte = clientes.envCbte
Thisform.mailfc = ALLTRIM(clientes.mailfc)
Thisform.PrintCbte = clientes.printcbte

lcSql = "SELECT * FROM localidad WHERE idLocalid = " + ALLTRIM(STR(clientes.idLocalid))
lo_rsLocalidad.ActiveConnection = goConn.ActiveConnection
lo_rsLocalidad.Cursor_Name = "cur_Localid"
lo_rsLocalidad.OpenQuery(lcSql)

SELECT cur_Localid
Thisform.cli_localidad = cur_Localid.descripcio
Thisform.cli_codpostal = cur_Localid.codPostal

lcSql = "SELECT * FROM provincias WHERE idProvin = " + ALLTRIM(STR(cur_Localid.idProvin))
lo_rsPcia.ActiveConnection = goConn.ActiveConnection
lo_rsPcia.Cursor_Name = "cur_Pcia"
lo_rsPcia.OpenQuery(lcSql)

SELECT cur_Pcia
Thisform.cli_pcia = cur_Pcia.descripcio

lo_rsPcia.close_query()
lo_rsLocalidad.close_query()

lcSql = "SELECT * FROM sitiva WHERE idSitIVA = " + ALLTRIM(STR(clientes.idSitIVA))
lo_rsSitIVA.ActiveConnection = goConn.ActiveConnection
lo_rsSitIVA.Cursor_Name = "cur_SitIVA"
lo_rsSitIVA.OpenQuery(lcSql)

SELECT cur_SitIVA
Thisform.cli_Sitiva = cur_SitIVA.CodFiscal
Thisform.idSitIva = cur_SitIVA.idSitIVA

lo_rsSitIVA.close_query()


ENDPROC


************************************************************
OBJETO: btnAceptar
************************************************************
*** PROPIEDADES ***
Top = 34
Left = 896
Height = 44
Width = 45
Anchor = 9
Name = "btnAceptar"

*** METODOS ***
PROCEDURE Click
IF ALLTRIM(Thisform.cli_tipodoc) == "" THEN
	MESSAGEBOX("Atención, el cliente no tiene el tipo de documento cargado. Edite el cliente y vuelva a intentarlo", 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

IF ALLTRIM(Thisform.cli_cuit) == "" THEN
	MESSAGEBOX("Atención, el cliente no tiene el número de CUIT/DNI cargado. Edite el cliente y vuelva a intentarlo", 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

Thisform.llenar_grilla()
ENDPROC


************************************************************
OBJETO: Clsetiqueta2
************************************************************
*** PROPIEDADES ***
FontSize = 10
Caption = "Saldo:"
Height = 15
Left = 578
Top = 9
Width = 55
ForeColor = 255,0,0
Name = "Clsetiqueta2"

*** METODOS ***


************************************************************
OBJETO: txtsaldo
************************************************************
*** PROPIEDADES ***
FontSize = 10
FontUnderline = .F.
Enabled = .F.
Height = 26
Left = 631
Top = 3
Width = 164
ForeColor = 255,0,0
isnumeric = .T.
Name = "txtsaldo"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta3
************************************************************
*** PROPIEDADES ***
Caption = "Situación IVA:"
Height = 15
Left = 9
Top = 37
Width = 74
Name = "Clsetiqueta3"

*** METODOS ***


************************************************************
OBJETO: txtsitiva
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 92
Top = 32
Width = 277
ischaracter = .F.
Name = "txtsitiva"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta4
************************************************************
*** PROPIEDADES ***
Caption = "Vendedor:"
Height = 15
Left = 9
Top = 60
Width = 57
Name = "Clsetiqueta4"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta5
************************************************************
*** PROPIEDADES ***
Caption = "Cond. Pago:"
Height = 15
Left = 390
Top = 37
Width = 68
Name = "Clsetiqueta5"

*** METODOS ***


************************************************************
OBJETO: txtcondpago
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 463
Top = 32
Width = 332
Name = "txtcondpago"

*** METODOS ***


************************************************************
OBJETO: txtcodvend
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Left = 92
Top = 56
isnumeric = .F.
isinteger = .T.
Name = "txtcodvend"

*** METODOS ***


************************************************************
OBJETO: txtvendedor
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 196
Top = 56
Width = 374
Name = "txtvendedor"

*** METODOS ***


************************************************************
OBJETO: grdCtaCte
************************************************************
*** PROPIEDADES ***
Anchor = 75
Height = 394
Left = 6
Top = 89
Width = 945
permitir_busqueda = .F.
permitir_ordenamiento = .F.
Name = "grdCtaCte"
COLUMN1.Header1.Name = "Header1"
COLUMN1.Text1.Name = "Text1"
COLUMN1.CurrentControl = "Clscheckbox1"
COLUMN1.Sparse = .F.
COLUMN1.Name = "COLUMN1"
COLUMN2.Header1.Name = "Header1"
COLUMN2.Text1.TerminateRead = .F.
COLUMN2.Text1.OpenWindow = .F.
COLUMN2.Text1.NullDisplay = ""
COLUMN2.Text1.Name = "Text1"
COLUMN2.Name = "COLUMN2"
COLUMN3.Header1.Name = "Header1"
COLUMN3.Text1.Name = "Text1"
COLUMN3.Name = "COLUMN3"
COLUMN4.Header1.Name = "Header1"
COLUMN4.Text1.Name = "Text1"
COLUMN4.Name = "COLUMN4"
COLUMN5.Header1.Name = "Header1"
COLUMN5.Text1.Name = "Text1"
COLUMN5.Name = "COLUMN5"
COLUMN6.Header1.Name = "Header1"
COLUMN6.Text1.Name = "Text1"
COLUMN6.Name = "COLUMN6"
COLUMN7.Header1.Name = "Header1"
COLUMN7.Text1.Name = "Text1"
COLUMN7.Name = "COLUMN7"
COLUMN8.Header1.Name = "Header1"
COLUMN8.Text1.Name = "Text1"
COLUMN8.Name = "COLUMN8"
COLUMN9.Header1.Name = "Header1"
COLUMN9.Text1.Name = "Text1"
COLUMN9.Name = "COLUMN9"
COLUMN10.Header1.Name = "Header1"
COLUMN10.Text1.Name = "Text1"
COLUMN10.Name = "COLUMN10"
COLUMN11.Header1.Name = "Header1"
COLUMN11.Text1.Name = "Text1"
COLUMN11.Name = "COLUMN11"
COLUMN12.Header1.Name = "Header1"
COLUMN12.Text1.Name = "Text1"
COLUMN12.Name = "COLUMN12"
COLUMN13.Header1.Name = "Header1"
COLUMN13.Text1.Name = "Text1"
COLUMN13.Name = "COLUMN13"
COLUMN14.Header1.Name = "Header1"
COLUMN14.Text1.Name = "Text1"
COLUMN14.Name = "COLUMN14"
COLUMN15.Header1.Name = "Header1"
COLUMN15.Text1.Name = "Text1"
COLUMN15.Name = "COLUMN15"
COLUMN16.Header1.Name = "Header1"
COLUMN16.Text1.Name = "Text1"
COLUMN16.Name = "COLUMN16"
COLUMN17.Header1.Name = "Header1"
COLUMN17.Text1.Name = "Text1"
COLUMN17.Name = "COLUMN17"
COLUMN18.Header1.Name = "Header1"
COLUMN18.Text1.Name = "Text1"
COLUMN18.Name = "COLUMN18"
COLUMN19.Header1.Name = "Header1"
COLUMN19.Text1.Name = "Text1"
COLUMN19.Name = "COLUMN19"
COLUMN20.Header1.Name = "Header1"
COLUMN20.Text1.Name = "Text1"
COLUMN20.Name = "COLUMN20"

*** METODOS ***


************************************************************
OBJETO: Clscheckbox1
************************************************************
*** PROPIEDADES ***
Top = 20
Left = 46
Alignment = 0
Caption = ""
Name = "Clscheckbox1"

*** METODOS ***


************************************************************
OBJETO: btnCerrar
************************************************************
*** PROPIEDADES ***
Top = 486
Left = 905
Anchor = 12
Name = "btnCerrar"

*** METODOS ***


************************************************************
OBJETO: btnCompensar
************************************************************
*** PROPIEDADES ***
Top = 487
Left = 227
Height = 42
Width = 106
FontBold = .T.
Anchor = 6
Caption = "\<Saldos a Favor"
Name = "btnCompensar"

*** METODOS ***
PROCEDURE Click
LOCAL loForm

&& Valido que no haya notas de créditos, ni ajuste de débito ni nota de débito seleccionada
SELECT cur_CtaCte
IF RECCOUNT("cur_ctacte") > 0 THEN
	GO TOP
ENDIF

DO WHILE !EOF("cur_ctacte")
	IF cur_ctacte.seleccion THEN
		IF SUBSTR(cur_ctacte.numCbte, 1, 2) == "NC" .OR. ;
				SUBSTR(cur_ctacte.numCbte, 1, 2) == "AC" .OR.  ;
				SUBSTR(cur_ctacte.numCbte, 1, 2) == "CJA" .OR. ;
				SUBSTR(cur_ctacte.numCbte, 1, 2) == "RC" THEN
				
			MESSAGEBOX("No puede seleccionar NC, AC, CJA y/o RC para compensar", 0+48, Thisform.Caption)
			RETURN .F.
		ENDIF
	ENDIF

	SELECT cur_ctacte
	SKIP
ENDDO

loForm = CREATEOBJECT("cls_saldo_a_favor_sf")
loForm.idCliente = Thisform.Contenido.sel_Cliente.valcpoid
loForm.idVentasC = cur_CtaCte.idVentasC
loForm.idCC_Cli = cur_CtaCte.idCC_Cli
IF !loForm.cargar() THEN
	loForm.release()
	RETURN .F.
ENDIF

loForm.show()
Thisform.llenar_grilla()

RETURN .T.
ENDPROC


************************************************************
OBJETO: btnNotaCredito
************************************************************
*** PROPIEDADES ***
Top = 487
Left = 9
Height = 42
Width = 106
FontBold = .T.
Anchor = 6
Caption = "\<Nota de Crédito"
Name = "btnNotaCredito"

*** METODOS ***
PROCEDURE Click
LOCAL loForm
LOCAL lcPtoVta, lcNumCbte, lcTipoDoc, lcCbte
LOCAL _index, loResult, lcSql

loResult = CREATEOBJECT("odbc_result")
lcSql = ""

SELECT	*;
FROM	cur_CtaCte ;
WHERE	cur_CtaCte.seleccion = .T. ;
INTO CURSOR cur_SelCta

SELECT cur_SelCta
IF RECCOUNT("cur_SelCta") > 1 THEN
	MESSAGEBOX("No puede seleccionar más de un comprobante", 0+48, Thisform.Caption)
	thisform.grdCtaCte.SetFocus()
	RETURN .F.
ENDIF

IF ALLTRIM(GetConfig("USA_FISCAL")) == "S" THEN
	loForm = CREATEOBJECT("frm_ncnd_cc")
ELSE
	loForm = CREATEOBJECT("frm_ncnd_cc_sf")
ENDIF

loForm.cbte = "NC"

IF RECCOUNT("cur_SelCta") > 0 THEN
	lcCbte = GETWORDNUM(cur_SelCta.numCbte, 1, " ")
	lcTipoDoc = GETWORDNUM(cur_SelCta.numCbte, 2, " ")
	lcNumCbte = GETWORDNUM(cur_SelCta.numCbte, 3, " ")
	
	IF (ALLTRIM(lcCbte) <> "FC") .AND. (ALLTRIM(lcCbte) <> "ND" ) THEN
		MESSAGEBOX("La Nota de Crédito solo se puede aplicar a Facturas o Notas de Débito", 0+48, Thisform.Caption)
		RETURN .F.
	ENDIF	
	
	loForm.CbteRef = lcCbte
	loForm.IdVentasCab = cur_SelCta.idVentasC
	loForm.ptoVtaRef = ALLTRIM(GETWORDNUM(lcNumCbte, 1, "-"))
	loForm.numCbteRef = ALLTRIM(GETWORDNUM(lcNumCbte, 2, "-"))
	loForm.tipoDocRef = ALLTRIM(lcTipoDoc)
	loForm.idOper = cur_SelCta.idOper
	loForm.idcc_cli = cur_SelCta.idCC_Cli	
	
	lcSql = "SELECT * FROM ventascab WHERE idVentasC = " + ALLTRIM(STR(cur_SelCta.idVentasC))
	loResult.ActiveConnection = goConn.ActiveConnection
	loResult.Cursor_Name = "cur_tempo"
	loResult.OpenQuery(lcSql)

	SELECT cur_tempo
	loForm.txtImporte.value = cur_tempo.saldo
	loResult.close_query()
	loForm.Caption = "Nota de Crédito - Aplicando al comprobante: " + ALLTRIM(cur_SelCta.numCbte)
ELSE 
	loForm.idOper = 0
	loForm.Caption = "Nota de Crédito"
ENDIF

* Datos del cliente
loForm.cli_idtipodoc = thisform.cli_idtipodoc
loForm.cli_tipodoc = Thisform.cli_tipodoc
loForm.idCliente = Thisform.contenido.sel_Cliente.valcpoid
loForm.cli_razsoc = Thisform.cli_razsoc
loForm.cli_CUIT = Thisform.cli_cuit
loForm.cli_sitiva = Thisform.cli_sitiva
loForm.idSitIva = Thisform.idSitIva
loForm.cli_calle = Thisform.cli_calle
loForm.cli_codpostal = thisform.cli_codpostal
loForm.cli_localidad = Thisform.cli_localidad
loForm.cli_pcia = Thisform.cli_pcia
loForm.Show()
Thisform.llenar_grilla()

USE IN cur_SelCta

RETURN .T.
ENDPROC


************************************************************
OBJETO: btnNotaDebito
************************************************************
*** PROPIEDADES ***
Top = 487
Left = 118
Height = 42
Width = 106
FontBold = .T.
Anchor = 6
Caption = "Nota de \<Débito"
Name = "btnNotaDebito"

*** METODOS ***
PROCEDURE Click
LOCAL loForm
LOCAL lcPtoVta, lcNumCbte, lcTipoDoc, lcCbte
LOCAL _index, loResult, lcSql

loResult = CREATEOBJECT("odbc_result")
lcSql = ""

SELECT	*;
FROM	cur_CtaCte ;
WHERE	cur_CtaCte.seleccion = .T. ;
INTO CURSOR cur_SelCta

SELECT cur_SelCta
IF RECCOUNT("cur_SelCta") > 1 THEN
	MESSAGEBOX("No puede seleccionar más de un comprobante", 0+48, Thisform.Caption)
	thisform.grdCtaCte.SetFocus()
	RETURN .F.
ENDIF

IF ALLTRIM(GetConfig("USA_FISCAL")) == "S" THEN
	loForm = CREATEOBJECT("frm_ncnd_cc")
ELSE
	loForm = CREATEOBJECT("frm_ncnd_cc_sf")
ENDIF

loForm.cbte = "ND"

IF RECCOUNT("cur_SelCta") > 0 THEN
	lcCbte = GETWORDNUM(cur_SelCta.numCbte, 1, " ")
	lcTipoDoc = GETWORDNUM(cur_SelCta.numCbte, 2, " ")
	lcNumCbte = GETWORDNUM(cur_SelCta.numCbte, 3, " ")
	
	loForm.CbteRef = lcCbte
	loForm.IdVentasCab = cur_SelCta.idVentasC
	loForm.ptoVtaRef = ALLTRIM(GETWORDNUM(lcNumCbte, 1, "-"))
	loForm.numCbteRef = ALLTRIM(GETWORDNUM(lcNumCbte, 2, "-"))
	loForm.tipoDocRef = ALLTRIM(lcTipoDoc)
	loForm.idOper = cur_SelCta.idOper
	loForm.idcc_cli = cur_SelCta.idCC_Cli
	loForm.cli_tipodoc = Thisform.cli_tipodoc
	
	lcSql = "SELECT * FROM cc_cli WHERE idCC_Cli = " + ALLTRIM(STR(cur_CtaCte.idCC_Cli))
	loResult.ActiveConnection = goConn.ActiveConnection
	loResult.Cursor_Name = "cur_tempo"
	loResult.OpenQuery(lcSql)

	SELECT cur_tempo
	loForm.txtImporte.value = IIF(cur_tempo.impDebe <> 0, cur_tempo.impDebe, cur_tempo.impHaber)
	loResult.close_query()
	loForm.Caption = "Nota de Débito - Aplicando al comprobante: " + ALLTRIM(cur_SelCta.numCbte)
ELSE 
	loForm.idOper = 0
	loForm.Caption = "Nota de Débito"
ENDIF

* Datos del cliente
loForm.cli_idTipoDoc = Thisform.cli_idTipoDoc
loForm.idCliente = Thisform.contenido.sel_Cliente.valcpoid
loForm.cli_razsoc = Thisform.cli_razsoc
loForm.cli_CUIT = Thisform.cli_cuit
loForm.cli_sitiva = Thisform.cli_sitiva
loForm.idSitIva = Thisform.idSitIva
loForm.cli_calle = Thisform.cli_calle
loForm.cli_codpostal = thisform.cli_codpostal
loForm.cli_localidad = Thisform.cli_localidad
loForm.cli_pcia = Thisform.cli_pcia
loForm.Show()
Thisform.llenar_grilla()

USE IN cur_SelCta

RETURN .T.
ENDPROC


************************************************************
OBJETO: btnAjuste
************************************************************
*** PROPIEDADES ***
Top = 487
Left = 336
Height = 42
Width = 106
FontBold = .T.
Anchor = 6
Caption = "\<Ajustes"
Name = "btnAjuste"

*** METODOS ***
PROCEDURE Click
LOCAL loForm
LOCAL lcPtoVta, lcNumCbte, lcTipoDoc, lcCbte
LOCAL _index, loResult, lcSql

loResult = CREATEOBJECT("odbc_result")
lcSql = ""

SELECT	*;
FROM	cur_CtaCte ;
WHERE	cur_CtaCte.seleccion = .T. ;
INTO CURSOR cur_SelCta

SELECT cur_SelCta
IF RECCOUNT("cur_SelCta") > 1 THEN
	MESSAGEBOX("No puede seleccionar más de un comprobante", 0+48, Thisform.Caption)
	thisform.grdCtaCte.SetFocus()
	RETURN .F.
ENDIF

loForm = CREATEOBJECT("frm_ajuste_ctacte")

IF RECCOUNT("cur_SelCta") > 0 THEN
	lcCbte = GETWORDNUM(cur_SelCta.numCbte, 1, " ")
	lcTipoDoc = GETWORDNUM(cur_SelCta.numCbte, 2, " ")
	lcNumCbte = GETWORDNUM(cur_SelCta.numCbte, 3, " ")
	loForm.cbte = lcCbte
	loForm.IdVentasCab = cur_SelCta.idVentasC
	loForm.ptoVta = ALLTRIM(GETWORDNUM(lcNumCbte, 1, "-"))
	loForm.nroCbte = ALLTRIM(GETWORDNUM(lcNumCbte, 2, "-"))
	loForm.tipoDoc = ALLTRIM(lcTipoDoc)
	loForm.idOperacion = cur_SelCta.idOper
	loForm.idcc_cli = cur_SelCta.idCC_Cli
	
	lcSql = "SELECT * FROM cc_cli WHERE idCC_Cli = " + ALLTRIM(STR(cur_SelCta.idCC_Cli))
	loResult.ActiveConnection = goConn.ActiveConnection
	loResult.Cursor_Name = "cur_tempo"
	loResult.OpenQuery(lcSql)

	SELECT cur_tempo
	loForm.importe = IIF(cur_tempo.impDebe <> 0, cur_tempo.impDebe, cur_tempo.impHaber)
	loResult.close_query()

ELSE 
	loForm.idOperacion = 0
ENDIF

* Datos del cliente
loForm.idCliente = Thisform.contenido.sel_Cliente.valcpoid

loForm.Show()

thisform.llenar_grilla()
USE IN cur_SelCta

RETURN .T.
ENDPROC


************************************************************
OBJETO: btnDetalles
************************************************************
*** PROPIEDADES ***
Top = 487
Left = 448
Height = 42
Width = 106
FontBold = .T.
Anchor = 6
Caption = "\<Ver Detalle"
Name = "btnDetalles"

*** METODOS ***
PROCEDURE Click
IF LIKE("AD*", ALLTRIM(cur_ctacte.numCbte)) .OR. LIKE("AC*", ALLTRIM(cur_ctacte.numCbte)) THEN
	MESSAGEBOX("Los ajustes de Débito y/o crédito no dispone de detalle", 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

DO FORM "frmctacte_imgcbte"
RETURN .T.
ENDPROC


************************************************************
OBJETO: cls_form_ctacte
************************************************************
*** PROPIEDADES ***
Arial, 0, 8, 5, 14, 11, 29, 3, 0
Arial, 1, 8, 5, 14, 11, 29, 3, 0
Arial, 0, 9, 5, 15, 12, 32, 3, 0
Arial, 1, 10, 6, 16, 13, 34, 3, 0
Arial, 1, 9, 6, 15, 12, 32, 3, 0

*** METODOS ***


************************************************************
OBJETO: cls_form_ctacte_fe
************************************************************
*** PROPIEDADES ***
DoCreate = .T.
Name = "cls_form_ctacte_fe"
contenido.Clsetiqueta1.Name = "Clsetiqueta1"
contenido.sel_Cliente.txtCodigo.Name = "txtCodigo"
contenido.sel_Cliente.txtDescripcion.Name = "txtDescripcion"
contenido.sel_Cliente.Name = "sel_Cliente"
contenido.btnAceptar.Name = "btnAceptar"
contenido.Clsetiqueta2.Name = "Clsetiqueta2"
contenido.txtsaldo.Name = "txtsaldo"
contenido.Clsetiqueta3.Name = "Clsetiqueta3"
contenido.txtSitIVA.Name = "txtSitIVA"
contenido.Clsetiqueta4.Name = "Clsetiqueta4"
contenido.Clsetiqueta5.Name = "Clsetiqueta5"
contenido.txtcondpago.Name = "txtcondpago"
contenido.txtcodvend.Name = "txtcodvend"
contenido.txtvendedor.Name = "txtvendedor"
contenido.Name = "contenido"
grdCtaCte.COLUMN1.Header1.Name = "Header1"
grdCtaCte.COLUMN1.Text1.Name = "Text1"
grdCtaCte.COLUMN1.Clscheckbox1.Alignment = 0
grdCtaCte.COLUMN1.Clscheckbox1.Name = "Clscheckbox1"
grdCtaCte.COLUMN1.Name = "COLUMN1"
grdCtaCte.COLUMN2.Header1.Name = "Header1"
grdCtaCte.COLUMN2.Text1.Name = "Text1"
grdCtaCte.COLUMN2.Name = "COLUMN2"
grdCtaCte.COLUMN3.Header1.Name = "Header1"
grdCtaCte.COLUMN3.Text1.Name = "Text1"
grdCtaCte.COLUMN3.Name = "COLUMN3"
grdCtaCte.COLUMN4.Header1.Name = "Header1"
grdCtaCte.COLUMN4.Text1.Name = "Text1"
grdCtaCte.COLUMN4.Name = "COLUMN4"
grdCtaCte.COLUMN5.Header1.Name = "Header1"
grdCtaCte.COLUMN5.Text1.Name = "Text1"
grdCtaCte.COLUMN5.Name = "COLUMN5"
grdCtaCte.COLUMN6.Header1.Name = "Header1"
grdCtaCte.COLUMN6.Text1.Name = "Text1"
grdCtaCte.COLUMN6.Name = "COLUMN6"
grdCtaCte.COLUMN7.Header1.Name = "Header1"
grdCtaCte.COLUMN7.Text1.Name = "Text1"
grdCtaCte.COLUMN7.Name = "COLUMN7"
grdCtaCte.COLUMN8.Header1.Name = "Header1"
grdCtaCte.COLUMN8.Text1.Name = "Text1"
grdCtaCte.COLUMN8.Name = "COLUMN8"
grdCtaCte.COLUMN9.Header1.Name = "Header1"
grdCtaCte.COLUMN9.Text1.Name = "Text1"
grdCtaCte.COLUMN9.Name = "COLUMN9"
grdCtaCte.COLUMN10.Header1.Name = "Header1"
grdCtaCte.COLUMN10.Text1.Name = "Text1"
grdCtaCte.COLUMN10.Name = "COLUMN10"
grdCtaCte.COLUMN11.Header1.Name = "Header1"
grdCtaCte.COLUMN11.Text1.Name = "Text1"
grdCtaCte.COLUMN11.Name = "COLUMN11"
grdCtaCte.COLUMN12.Header1.Name = "Header1"
grdCtaCte.COLUMN12.Text1.Name = "Text1"
grdCtaCte.COLUMN12.Name = "COLUMN12"
grdCtaCte.COLUMN13.Header1.Name = "Header1"
grdCtaCte.COLUMN13.Text1.Name = "Text1"
grdCtaCte.COLUMN13.Name = "COLUMN13"
grdCtaCte.COLUMN14.Header1.Name = "Header1"
grdCtaCte.COLUMN14.Text1.Name = "Text1"
grdCtaCte.COLUMN14.Name = "COLUMN14"
grdCtaCte.COLUMN15.Header1.Name = "Header1"
grdCtaCte.COLUMN15.Text1.Name = "Text1"
grdCtaCte.COLUMN15.Name = "COLUMN15"
grdCtaCte.COLUMN16.Header1.Name = "Header1"
grdCtaCte.COLUMN16.Text1.Name = "Text1"
grdCtaCte.COLUMN16.Name = "COLUMN16"
grdCtaCte.COLUMN17.Header1.Name = "Header1"
grdCtaCte.COLUMN17.Text1.Name = "Text1"
grdCtaCte.COLUMN17.Name = "COLUMN17"
grdCtaCte.COLUMN18.Header1.Name = "Header1"
grdCtaCte.COLUMN18.Text1.Name = "Text1"
grdCtaCte.COLUMN18.Name = "COLUMN18"
grdCtaCte.COLUMN19.Header1.Name = "Header1"
grdCtaCte.COLUMN19.Text1.Name = "Text1"
grdCtaCte.COLUMN19.Name = "COLUMN19"
grdCtaCte.COLUMN20.Header1.Name = "Header1"
grdCtaCte.COLUMN20.Text1.Name = "Text1"
grdCtaCte.COLUMN20.Name = "COLUMN20"
grdCtaCte.Name = "grdCtaCte"
btnCerrar.Name = "btnCerrar"
btnCompensar.Name = "btnCompensar"
btnNotaCredito.Name = "btnNotaCredito"
btnNotaDebito.Name = "btnNotaDebito"
btnAjuste.Name = "btnAjuste"
btnDetalles.Name = "btnDetalles"

*** METODOS ***
PROCEDURE btnNotaCredito.Click
LOCAL loForm
LOCAL lcPtoVta, lcNumCbte, lcTipoDoc, lcCbte
LOCAL _index, loResult, lcSql

loResult = CREATEOBJECT("odbc_result")
lcSql = ""

SELECT	*;
FROM	cur_CtaCte ;
WHERE	cur_CtaCte.seleccion = .T. ;
INTO CURSOR cur_SelCta

SELECT cur_SelCta
IF RECCOUNT("cur_SelCta") > 1 THEN
	MESSAGEBOX("No puede seleccionar más de un comprobante", 0+48, Thisform.Caption)
	thisform.grdCtaCte.SetFocus()
	RETURN .F.
ENDIF

loForm = CREATEOBJECT("frm_ncnd_cc_fe")
loForm.cbte = "NC"

IF RECCOUNT("cur_SelCta") > 0 THEN
	lcCbte = GETWORDNUM(cur_SelCta.numCbte, 1, " ")
	lcTipoDoc = GETWORDNUM(cur_SelCta.numCbte, 2, " ")
	lcNumCbte = GETWORDNUM(cur_SelCta.numCbte, 3, " ")
	
	IF (ALLTRIM(lcCbte) <> "FC") .AND. (ALLTRIM(lcCbte) <> "ND" ) THEN
		MESSAGEBOX("La Nota de Crédito solo se puede aplicar a Facturas o Notas de Débito", 0+48, Thisform.Caption)
		RETURN .F.
	ENDIF	
	
	loForm.CbteRef = lcCbte
	loForm.IdVentasCab = cur_SelCta.idVentasC
	loForm.ptoVtaRef = ALLTRIM(GETWORDNUM(lcNumCbte, 1, "-"))
	loForm.numCbteRef = ALLTRIM(GETWORDNUM(lcNumCbte, 2, "-"))
	loForm.tipoDocRef = ALLTRIM(lcTipoDoc)
	loForm.idOper = cur_SelCta.idOper
	loForm.idcc_cli = cur_SelCta.idCC_Cli

	lcSql = "SELECT * FROM ventascab WHERE idVentasC = " + ALLTRIM(STR(cur_SelCta.idVentasC))
	loResult.ActiveConnection = goConn.ActiveConnection
	loResult.Cursor_Name = "cur_tempo"
	loResult.OpenQuery(lcSql)

	SELECT cur_tempo
	loForm.txtImporte.value = cur_tempo.saldo
	loResult.close_query()
	loForm.Caption = "Nota de Crédito - Aplicando al comprobante: " + ALLTRIM(cur_SelCta.numCbte)
ELSE 
	loForm.idOper = 0
	loForm.Caption = "Nota de Crédito"
ENDIF

* Datos del cliente
loForm.cli_idTipoDoc = Thisform.cli_idTipoDoc
loForm.cli_tipodoc = Thisform.cli_tipodoc
loForm.idCliente = Thisform.contenido.sel_Cliente.valcpoid
loForm.cli_razsoc = Thisform.cli_razsoc
loForm.cli_CUIT = Thisform.cli_cuit
loForm.cli_sitiva = Thisform.cli_sitiva
loForm.idSitIva = Thisform.idSitIva
loForm.cli_calle = Thisform.cli_calle
loForm.cli_codpostal = thisform.cli_codpostal
loForm.cli_localidad = Thisform.cli_localidad
loForm.cli_pcia = Thisform.cli_pcia
loForm.envCbte = thisform.envcbte
loForm.mailFC = thisform.mailfc
loForm.printcbte = thisform.PrintCbte
loForm.Show()

Thisform.llenar_grilla()

USE IN cur_SelCta

RETURN .T.
ENDPROC
PROCEDURE btnNotaDebito.Click
LOCAL loForm
LOCAL lcPtoVta, lcNumCbte, lcTipoDoc, lcCbte
LOCAL _index, loResult, lcSql

loResult = CREATEOBJECT("odbc_result")
lcSql = ""

SELECT	*;
FROM	cur_CtaCte ;
WHERE	cur_CtaCte.seleccion = .T. ;
INTO CURSOR cur_SelCta

SELECT cur_SelCta
IF RECCOUNT("cur_SelCta") > 1 THEN
	MESSAGEBOX("No puede seleccionar más de un comprobante", 0+48, Thisform.Caption)
	thisform.grdCtaCte.SetFocus()
	RETURN .F.
ENDIF

loForm = CREATEOBJECT("frm_ncnd_cc_fe")
loForm.cbte = "ND"

IF RECCOUNT("cur_SelCta") > 0 THEN
	lcCbte = GETWORDNUM(cur_SelCta.numCbte, 1, " ")
	lcTipoDoc = GETWORDNUM(cur_SelCta.numCbte, 2, " ")
	lcNumCbte = GETWORDNUM(cur_SelCta.numCbte, 3, " ")
	
	loForm.CbteRef = lcCbte
	loForm.IdVentasCab = cur_SelCta.idVentasC
	loForm.ptoVtaRef = ALLTRIM(GETWORDNUM(lcNumCbte, 1, "-"))
	loForm.numCbteRef = ALLTRIM(GETWORDNUM(lcNumCbte, 2, "-"))
	loForm.tipoDocRef = ALLTRIM(lcTipoDoc)
	loForm.idOper = cur_SelCta.idOper
	loForm.idcc_cli = cur_SelCta.idCC_Cli
	
	lcSql = "SELECT * FROM cc_cli WHERE idCC_Cli = " + ALLTRIM(STR(cur_CtaCte.idCC_Cli))
	loResult.ActiveConnection = goConn.ActiveConnection
	loResult.Cursor_Name = "cur_tempo"
	loResult.OpenQuery(lcSql)

	SELECT cur_tempo
	loForm.txtImporte.value = IIF(cur_tempo.impDebe <> 0, cur_tempo.impDebe, cur_tempo.impHaber)
	loResult.close_query()
	loForm.Caption = "Nota de Débito - Aplicando al comprobante: " + ALLTRIM(cur_SelCta.numCbte)
ELSE 
	loForm.idOper = 0
	loForm.Caption = "Nota de Débito"
ENDIF

* Datos del cliente
loForm.cli_idTipoDoc = Thisform.cli_idTipoDoc
loForm.cli_tipodoc = Thisform.cli_tipodoc
loForm.idCliente = Thisform.contenido.sel_Cliente.valcpoid
loForm.cli_razsoc = Thisform.cli_razsoc
loForm.cli_CUIT = Thisform.cli_cuit
loForm.cli_sitiva = Thisform.cli_sitiva
loForm.idSitIva = Thisform.idSitIva
loForm.cli_calle = Thisform.cli_calle
loForm.cli_codpostal = thisform.cli_codpostal
loForm.cli_localidad = Thisform.cli_localidad
loForm.cli_pcia = Thisform.cli_pcia
loForm.envCbte = thisform.envcbte
loForm.mailFC = thisform.mailfc
loForm.printcbte = thisform.PrintCbte
loForm.Show()

Thisform.llenar_grilla()

USE IN cur_SelCta

RETURN .T.
ENDPROC


************************************************************
OBJETO: cls_form_ctacte_fe
************************************************************
*** PROPIEDADES ***
Arial, 0, 8, 5, 14, 11, 29, 3, 0
Arial, 1, 8, 5, 14, 11, 29, 3, 0
Arial, 0, 9, 5, 15, 12, 32, 3, 0
Arial, 1, 10, 6, 16, 13, 34, 3, 0
Arial, 1, 9, 6, 15, 12, 32, 3, 0

*** METODOS ***


************************************************************
OBJETO: cls_busca_fcorigen_sf
************************************************************
*** PROPIEDADES ***
DataSession = 1
Height = 329
Width = 842
DoCreate = .T.
Caption = "Seleccionar Factura de Origen"
Closable = .F.
valor_id = 0
press_aceptar = .F.
idcliente = 0
saldo = 
cbte = 
cli_razsoc = 
cli_idtipodoc = 0
cli_nrodoc = 
fecemision = {}
Name = "cls_busca_fcorigen_sf"

*** METODOS ***
PROCEDURE seleccionar
LOCAL lnCantSel
LOCAL lnIdVtaC

lnIdVtaC = 0
lnCantSel = 0

IF ALLTRIM(Thisform.cbte) == "NC" THEN
	SELECT cur_Cbtes
	GO TOP
	
	lnCantSel = 0
	DO WHILE !EOF("cur_Cbtes")
		IF cur_Cbtes.Sel THEN
			lnIdVtaC = cur_Cbtes.idVentasC
			lnCantSel = lnCantSel + 1
		ENDIF
		
		SELECT cur_Cbtes
		SKIP
	ENDDO
	
	SELECT cur_Cbtes
	GO TOP
	
	IF lnCantSel > 1 THEN
		MESSAGEBOX("No se puede seleccionar más de una factura para hacer la NC", 0+48, Thisform.Caption)
		RETURN .F.
	ENDIF
ENDIF

SELECT cur_Cbtes
LOCATE FOR cur_Cbtes.idVentasC = lnIdVtaC

Thisform.valor_id = lnIdVtaC
Thisform.saldo = cur_Cbtes.totFact
Thisform.cli_razsoc = cur_cbtes.razSoc
Thisform.cli_idtipodoc = cur_cbtes.idTipoDoc
Thisform.cli_nrodoc = cur_cbtes.nroDoc
Thisform.fecemision = cur_cbtes.fecEmision

Thisform.press_aceptar = .T.
Thisform.Hide()

RETURN .T.
ENDPROC
PROCEDURE llenar_grilla
LOCAL loCbtes, lcSql, lnSqlSrv

lcSql = ""
loCbtes = CREATEOBJECT("odbc_result")
lnSqlSrv = VAL(getconfig("SQLSRV"))

lcSql = lcSql + "SELECT ventascab.idVentasC, "
lcSql = lcSql + "   	ventascab.fecEmision, "

IF lnSqlSrv = 0 THEN
	lcSql = lcSql + "CONCAT(ventascab.cbte, CONCAT(' ', CONCAT(ventascab.tipoDoc, "
	lcSql = lcSql + "	CONCAT(' ', CONCAT(CONCAT(CONCAT(REPEAT('0', 4 - LENGTH(TRIM(ventascab.ptoVta))), "
	lcSql = lcSql + "   TRIM(ventascab.ptoVta)), '-'), CONCAT(REPEAT('0', 8 - LENGTH(TRIM(ventascab.numCbte))), "
	lcSql = lcSql + "   TRIM(ventascab.numCbte))))))) AS numCbte, "
ELSE
	lcSql = lcSql + "ventascab.cbte + ' ' + ventascab.tipoDoc + " 
	lcSql = lcSql + "	' ' + REPLICATE('0', 4 - LEN(RTRIM(LTRIM(ventascab.ptoVta)))) + "
	lcSql = lcSql + "	LTRIM(RTRIM(ventascab.ptoVta)) + '-' + REPLICATE('0', 8 - LEN(LTRIM(RTRIM(ventascab.numCbte)))) + "
	lcSql = lcSql + "	RTRIM(LTRIM(ventascab.numCbte)) AS numCbte, "
ENDIF

lcSql = lcSql + "       ventascab.idCliente, "
lcSql = lcSql + "       ventascab.razSoc, "
lcSql = lcSql + "       ventascab.totFact, "
lcSql = lcSql + "		ventascab.idTipoDoc, "
lcSql = lcSql + "		ventascab.nroDoc "
lcSql = lcSql + "FROM   ventascab, "
lcSql = lcSql + "       clientes "
lcSql = lcSql + "WHERE  ventascab.idCliente = clientes.idCliente "
lcSql = lcSql + "	 AND ventascab.fecBaja IS NULL "
lcSql = lcSql + "	 AND ventascab.idCliente = " + ALLTRIM(STR(Thisform.idcliente)) + " "

&& Segun el comprobante que se está procesando, levanto los comprobantes de 
&& origen que corresponda
IF ALLTRIM(Thisform.cbte) == "NC" THEN
	&& Si es nota de crédito levanto las facturas con saldo pendiente de cancelar
	lcSql = lcSql + "    AND ventascab.cbte = 'FC' "
	
	&& Levanto solamente las facturas que no tengan NC o que la aplicación de la misma
	&& sea parcial
	lcSql = lcSql + "AND ventascab.idVentasC IN (SELECT idVentasC "
	lcSql = lcSql + "FROM ventasdet "
	lcSql = lcSql + "GROUP BY idVentasC "
	lcSql = lcSql + "HAVING (SUM(cantidad) - SUM(cantNC)) <> 0) "
	
	lcSql = lcSql + "ORDER BY idVentasC ASC"
ELSE
	IF ALLTRIM(Thisform.cbte) == "FC" THEN
		&& si es factura levanto los pedidos
		lcSql = lcSql + "	AND ventascab.cbte IN ('PED', 'COT') "
		lcSql = lcSql + "	AND idVentasC NOT IN ( "
		lcSql = lcSql + "		SELECT idVtaCO FROM ventasrel) "
		lcSql = lcSql + "ORDER BY ventascab.idVentasC DESC"
	ELSE
		IF ALLTRIM(Thisform.cbte) == "PTO" THEN
			lcSql = lcSql + "	AND ventascab.cbte IN ('PED', 'COT') "
			lcSql = lcSql + "	AND ventascab.procesado = 0 "
			lcSql = lcSql + "	AND ventascab.idVentasC IN ("
			lcSql = lcsql + "		SELECT ventasdet.idVentasC "
			lcSql = lcSql + "		FROM ventasdet WHERE ventasdet.cant_pri2 <> 0 OR ventasdet.cant_pri3 <> 0) "
			lcSql = lcSql + "ORDER BY ventascab.idVentasC DESC"
		ENDIF
	ENDIF
ENDIF

loCbtes.ActiveConnection = goConn.ActiveConnection
loCbtes.cursor_name = "tmp_cbtes"
loCbtes.OpenQuery(lcSql)

SELECT tmp_cbtes
IF RECCOUNT("tmp_cbtes") > 0 THEN
	GO TOP
ENDIF

DO WHILE !EOF("tmp_cbtes")
	SELECT cur_Cbtes
	APPEND BLANK
	REPLACE cur_cbtes.sel WITH .F.
	REPLACE cur_cbtes.idVentasC WITH tmp_cbtes.idVentasC ADDITIVE
	REPLACE cur_cbtes.fecEmision WITH tmp_cbtes.fecEmision ADDITIVE
	REPLACE cur_cbtes.numCbte WITH tmp_cbtes.numCbte ADDITIVE
	REPLACE cur_cbtes.idCliente WITH tmp_cbtes.idCliente ADDITIVE
	REPLACE cur_cbtes.razSoc WITH tmp_cbtes.razSoc ADDITIVE
	REPLACE cur_cbtes.totFact WITH tmp_cbtes.totFact ADDITIVE
	REPLACE cur_cbtes.idTipoDoc WITH tmp_cbtes.idTipoDoc ADDITIVE
	REPLACE cur_cbtes.nroDoc WITH tmp_cbtes.nroDoc ADDITIVE

	SELECT tmp_cbtes
	SKIP
ENDDO

loCbtes.Close_Query()

SELECT cur_Cbtes
IF RECCOUNT("cur_Cbtes") > 0 THEN
	GO TOP
ENDIF

SELECT cur_Cbtes
INDEX ON numCbte TAG numCbte DESCENDING ADDITIVE

SELECT cur_Cbtes
Thisform.grdCbtes.alias_name = "cur_Cbtes"
Thisform.grdCbtes.RecordSource = "cur_Cbtes"
Thisform.grdCbtes.list_controlsource = "sel,fecEmision,numCbte,idCliente,razSoc,totFact"
Thisform.grdCbtes.lista_ancho_cols = "50,100,150,70,350,100"
Thisform.grdCbtes.titulos_cabeceras = "Sel.,Fecha,Comprobante,Cliente,Razón Social, Total Factura"
Thisform.grdCbtes.generar_grid()

ENDPROC
PROCEDURE Load
DODEFAULT()

ENDPROC
PROCEDURE Init
&& El siguiente código permite confeccionar la grilla
DODEFAULT()

ENDPROC


************************************************************
OBJETO: grdCbtes
************************************************************
*** PROPIEDADES ***
Height = 258
Left = 2
TabIndex = 2
Top = 26
Width = 838
permitir_busqueda = .F.
permitir_ordenamiento = .F.
Name = "grdCbtes"
COLUMN1.Header1.Name = "Header1"
COLUMN1.Text1.ReadOnly = .F.
COLUMN1.Text1.Name = "Text1"
COLUMN1.CurrentControl = "chk"
COLUMN1.ReadOnly = .F.
COLUMN1.Sparse = .F.
COLUMN1.Name = "COLUMN1"
COLUMN2.Header1.Name = "Header1"
COLUMN2.Text1.Name = "Text1"
COLUMN2.Name = "COLUMN2"
COLUMN3.Header1.Name = "Header1"
COLUMN3.Text1.Name = "Text1"
COLUMN3.Name = "COLUMN3"
COLUMN4.Header1.Name = "Header1"
COLUMN4.Text1.Name = "Text1"
COLUMN4.Name = "COLUMN4"
COLUMN5.Header1.Name = "Header1"
COLUMN5.Text1.Name = "Text1"
COLUMN5.Name = "COLUMN5"
COLUMN6.Header1.Name = "Header1"
COLUMN6.Text1.Name = "Text1"
COLUMN6.Name = "COLUMN6"
COLUMN7.Header1.Name = "Header1"
COLUMN7.Text1.Name = "Text1"
COLUMN7.Name = "COLUMN7"
COLUMN8.Header1.Name = "Header1"
COLUMN8.Text1.Name = "Text1"
COLUMN8.Name = "COLUMN8"
COLUMN9.Header1.Name = "Header1"
COLUMN9.Text1.Name = "Text1"
COLUMN9.Name = "COLUMN9"
COLUMN10.Header1.Name = "Header1"
COLUMN10.Text1.Name = "Text1"
COLUMN10.Name = "COLUMN10"
COLUMN11.Header1.Name = "Header1"
COLUMN11.Text1.Name = "Text1"
COLUMN11.Name = "COLUMN11"
COLUMN12.Header1.Name = "Header1"
COLUMN12.Text1.Name = "Text1"
COLUMN12.Name = "COLUMN12"
COLUMN13.Header1.Name = "Header1"
COLUMN13.Text1.Name = "Text1"
COLUMN13.Name = "COLUMN13"
COLUMN14.Header1.Name = "Header1"
COLUMN14.Text1.Name = "Text1"
COLUMN14.Name = "COLUMN14"
COLUMN15.Header1.Name = "Header1"
COLUMN15.Text1.Name = "Text1"
COLUMN15.Name = "COLUMN15"
COLUMN16.Header1.Name = "Header1"
COLUMN16.Text1.Name = "Text1"
COLUMN16.Name = "COLUMN16"
COLUMN17.Header1.Name = "Header1"
COLUMN17.Text1.Name = "Text1"
COLUMN17.Name = "COLUMN17"
COLUMN18.Header1.Name = "Header1"
COLUMN18.Text1.Name = "Text1"
COLUMN18.Name = "COLUMN18"
COLUMN19.Header1.Name = "Header1"
COLUMN19.Text1.Name = "Text1"
COLUMN19.Name = "COLUMN19"
COLUMN20.Header1.Name = "Header1"
COLUMN20.Text1.Name = "Text1"
COLUMN20.Name = "COLUMN20"

*** METODOS ***
PROCEDURE press_enter
Thisform.seleccionar()
ENDPROC


************************************************************
OBJETO: chk
************************************************************
*** PROPIEDADES ***
Top = 21
Left = 47
Alignment = 0
Caption = ""
Name = "chk"

*** METODOS ***


************************************************************
OBJETO: btnAceptar
************************************************************
*** PROPIEDADES ***
Top = 286
Left = 751
Height = 42
Width = 44
TabIndex = 3
Name = "btnAceptar"

*** METODOS ***
PROCEDURE Click
Thisform.seleccionar()
ENDPROC


************************************************************
OBJETO: btnCancelar
************************************************************
*** PROPIEDADES ***
Top = 286
Left = 795
Height = 42
Width = 44
Cancel = .T.
TabIndex = 4
Name = "btnCancelar"

*** METODOS ***
PROCEDURE Click
Thisform.press_aceptar = .F.
Thisform.Hide()
ENDPROC


************************************************************
OBJETO: Clsetiqueta1
************************************************************
*** PROPIEDADES ***
Caption = "Valor Buscado:"
Height = 15
Left = 9
Top = 6
Width = 87
TabIndex = 5
Name = "Clsetiqueta1"

*** METODOS ***


************************************************************
OBJETO: txtValorBuscado
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 98
TabIndex = 1
Top = 3
Width = 742
ischaracter = .T.
Name = "txtValorBuscado"

*** METODOS ***
PROCEDURE InteractiveChange
SELECT cur_Cbtes
IF ALLTRIM(this.Value) == "" THEN
	SET FILTER TO
ELSE
	SET FILTER TO LIKE("*" + ALLTRIM(thisform.txtVAlorBuscado.Value) + "*", DTOC(cur_Cbtes.fecEmision)) .OR. ;
		LIKE("*" + ALLTRIM(thisform.txtValorBuscado.Value) + "*", IIF(TYPE("cur_Cbtes.numCbte") == "C", cur_Cbtes.numCbte, STR(cur_Cbtes.numCbte))) IN cur_Cbtes
ENDIF

SELECT cur_Cbtes
thisform.grdCbtes.Refresh()
ENDPROC


************************************************************
OBJETO: cls_busca_fcorigen_sf
************************************************************
*** PROPIEDADES ***
Arial, 0, 8, 5, 14, 11, 29, 3, 0
Arial, 1, 8, 5, 14, 11, 29, 3, 0
Arial, 0, 9, 5, 15, 12, 32, 3, 0

*** METODOS ***


************************************************************
OBJETO: cls_form_wsafip_autoriza
************************************************************
*** PROPIEDADES ***
BorderStyle = 2
Height = 571
Width = 946
DoCreate = .T.
Caption = "Autorización diferida de comprobantes"
aut_cae = 
aut_cae_vto = 
aut_motivo = 
aut_numero = 
aut_resultado = 
cbte = 
ptovta = 
nrocbte = 
saldodeudor = 0.00
cbte_por_cpto = .F.
idventasc = 0
rto_numero = 0
rto_printer = 
rto_cantcpias = 0
Name = "cls_form_wsafip_autoriza"
contenido.TabIndex = 1
contenido.Name = "contenido"

*** METODOS ***
PROCEDURE calc_digito_verificador
&& El prefijo E1, E2, En... indica a la etapa del algoritmo que pertenece el coeficiente

PARAMETERS tcCodigo

LOCAL lnDigito
LOCAL lnSumaE1
LOCAL lnSumaE3
LOCAL lnProductoE2
LOCAL lnSumaE4
LOCAL lnMin
LOCAL lnPos

lnDigito = 0
lnSumaE1 = 0
lnSumaE3 = 0
lnSumaE4 = 0
lnMin = 0

FOR i = 1 TO LEN(ALLTRIM(tcCodigo))
	lnDigito = INT(VAL(SUBSTR(tcCodigo, i, 1)))
	
	IF MOD(i, 2) <> 0 THEN
		&& Etapa 1 (posiciones impares)
		lnSumaE1 = lnSumaE1 + lnDigito
	ELSE
		&& Etapa 3 (posiciones pares)
		lnSumaE3 = lnSumaE3 + lnDigito
	ENDIF
NEXT i

lnProductoE2 = lnSumaE1 * 3 && Etapa 2
lnSumaE4 = lnProductoE2 + lnSumaE3 && Etapa 4

&& Etapa 5
lnPos = 0
FOR i = 1 TO LEN(ALLTRIM(tcCodigo))
	lnDigito = INT(VAL(SUBSTR(tcCodigo, i, 1)))
	
	IF MOD(lnSumaE4 + lnDigito, 10) = 0 THEN
		IF lnPos = 0 THEN
			lnMin = lnDigito
		ELSE
			IF lnDigito < lnMin THEN
				lnMin = lnDigito
			ENDIF
		ENDIF
		
		lnPos = lnPos + 1
	ENDIF
NEXT i

RETURN lnMin
ENDPROC
PROCEDURE fe_convertir_tipodoc
PARAMETERS tcTipoDoc
LOCAL lnResultado

lnResultado = 99 && Código que corresponde a sin identificación en el diccionario

DO CASE
	CASE ALLTRIM(tcTipoDoc) == "CUIT"
		lnResultado = 80
	CASE ALLTRIM(tcTipoDoc) == "CUIL"
		lnResultado = 86
	CASE ALLTRIM(tcTipoDoc) == "CI"
		lnResultado = 87
	CASE ALLTRIM(tcTipoDoc) == "LE"
		lnResultado = 89
	CASE ALLTRIM(tcTipoDoc) == "LC"
		lnResultado = 90
	CASE ALLTRIM(tcTipoDoc) == "CIE"
		lnResultado = 91
	CASE ALLTRIM(tcTipoDoc) == "PAS"
		lnResultado = 94
	CASE ALLTRIM(tcTipoDoc) == "DNI"
		lnResultado = 96
ENDCASE

RETURN lnResultado
ENDPROC
PROCEDURE fe_get_tipocbte_afip
PARAMETERS tc_letra

DO CASE
	CASE ALLTRIM(thisform.cbte) == "FC"
		DO CASE
			CASE ALLTRIM(tc_letra) == "A"
				RETURN 1
			CASE ALLTRIM(tc_letra) == "B"
				RETURN 6
			CASE ALLTRIM(tc_letra) == "C" 
				RETURN 11
		ENDCASE
	CASE ALLTRIM(thisform.cbte) == "ND"
		DO CASE
			CASE ALLTRIM(tc_letra) == "A"
				RETURN 2
			CASE ALLTRIM(tc_letra) == "B"
				RETURN 7
			CASE ALLTRIM(tc_letra) == "C"
				RETURN 12
		ENDCASE
	CASE ALLTRIM(thisform.cbte) == "NC"
		DO CASE
			CASE ALLTRIM(tc_letra) == "A"
				RETURN 3
			CASE ALLTRIM(tc_letra) == "B"
				RETURN 8
			CASE ALLTRIM(tc_letra) == "C"
				RETURN 13
		ENDCASE	
ENDCASE

RETURN -1
ENDPROC
PROCEDURE fe_set_cae
LOCAL loCommand, lcSql
LOCAL loDT, ldFecVto
LOCAL lcAnio, lcMes, lcDia

loDT = CREATEOBJECT("datetime")
loCommand = CREATEOBJECT("odbc_command")
lcSql = ""

lcAnio = SUBSTR(Thisform.aut_cae_vto, 1, 4)
lcMes = SUBSTR(Thisform.aut_cae_vto, 5, 2)
lcDia = SUBSTR(Thisform.aut_cae_vto, 7, 2)

lcSql = "UPDATE ventascab "
lcSql = lcSql + "SET "
lcSql = lcSql + "	fecEmision = " + loDT.getDateTime() + ", "
lcSql = lcSql + "	ptoVta = " + ALLTRIM(STR(Thisform.ptovta)) + ", "
lcSql = lcSql + "	numCbte = " + ALLTRIM(STR(Thisform.nrocbte)) + ", "
lcSql = lcSql + "	aut_CAE = '" + ALLTRIM(Thisform.aut_cae) + "', "
lcSql = lcSql + "	aut_CAE_vto = " + loDT.toMySql(CTOD(lcDia + "/" + lcMes + "/" + lcAnio)) + ", "
lcSql = lcSql + "	aut_Resultado = '" + ALLTRIM(Thisform.aut_resultado) + "', "
lcSql = lcSql + "	aut_Motivo = '" + ALLTRIM(Thisform.aut_motivo) + "', "
lcSql = lcsql + "	aut_tipoCbte = '" + REPLICATE("0", 2 - LEN(ALLTRIM(STR(Thisform.fe.F1CabeceraCbteTipo)))) + ALLTRIM(STR(Thisform.fe.F1CabeceraCbteTipo)) + "' "
lcSql = lcSql + "WHERE idVentasC = " + ALLTRIM(STR(cur_CbtePendi.idVentasC))

goConn.BeginTransaction()

loCommand.ActiveConnection = goConn.ActiveConnection
loCommand.CommandText = lcSql

IF !loCommand.Execute() THEN
	MESSAGEBOX(loCommand.ErrorMessage, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

lcSql = "update cc_cli set nroCbte = " + ALLTRIM(STR(Thisform.nrocbte)) + " "
lcSql = lcSql + "WHERE idVentasC = " + ALLTRIM(STR(cur_CbtePendi.idVentasC))

loCommand.ActiveConnection = goConn.ActiveConnection
loCommand.CommandText = lcSql

IF !loCommand.Execute() THEN
	goConn.Rollback()
	MESSAGEBOX(loCommand.ErrorMessage, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

goConn.Commit()

Thisform.imprimir()

RETURN .T.
ENDPROC
PROCEDURE imprimir
LOCAL m.NroCli, m.RazSoc, m.Telefono, m.direccion, m.localidad, m.codPostal, m.pcia, m.TipoIVA, m.nroCUIT
LOCAL m.Total, m.tipoDoc, m.NroCbte, m.Fecha, m.leyenda, m.fecVto, m.tipoDoc, m.ptoVta
LOCAL m.porDesc1, m.porDesc2, m.porDesc3, m.porDesc4, m.porRec
LOCAL m.impDesc1, m.impDesc2, m.impDesc3, m.impDesc4
LOCAL m.porIIBB, m.impIIBB, m.observ, m.vendedor
LOCAL m.porIVA105, m.impIVA105, m.porIVA21, m.impIVA21, m.impNeto, m.impFinal
LOCAL m.condPago
LOCAL lcSql, loNumerador, lcPrinterName, lnCantCpia
LOCAL m.cae, m.caevto, lcDia, lcMes, lcAnio
LOCAL m.codigoCbte, m.barcode, m.code
LOCAL m.saldoDeudor
LOCAL loRsCab, loRsDet, lcSql
LOCAL lnIdNum, lnResp, m.NroRto, m.nroOC
LOCAL lcFileName
LOCAL lcNomEmp

lcNomEmp = getconfig("NOMEMP")
loRsCab = CREATEOBJECT("odbc_result")
loRsDet = CREATEOBJECT("odbc_result")
loNumerador = CREATEOBJECT("odbc_result")
lcSql = ""
lnIdNum = 0
lcFileName = ""

&& Acá tengo que levantar el comprobante a actualizar actual
lcSql = "SELECT ventascab.*, "
lcSql = lcSql + "tipodoc.TipoDoc, "
lcSql = lcSql + "clientes.telefono, "
lcSql = lcSql + "clientes.direccion, "
lcSql = lcSql + "clientes.envCbte, "
lcSql = lcSql + "clientes.mailFC, "
lcSql = lcSql + "clientes.printCbte, "
lcSql = lcSql + "localidad.codPostal, "
lcSql = lcSql + "localidad.descripcio AS descLoc, "
lcSql = lcSql + "provincias.descripcio AS descPcia, "
lcSql = lcSql + "sitiva.descripcio AS descSIVA, "
lcSql = lcSql + "condpagos.cntDias, "
lcSql = lcSql + "vendedores.nombre "
lcSql = lcSql + "FROM ventascab  "
lcSql = lcSql + "	INNER JOIN clientes ON clientes.idCliente = ventascab.idCliente "
lcSql = lcSql + "	INNER JOIN tipodoc ON tipodoc.idTipoDoc = clientes.idTipoDoc "
lcSql = lcSql + "	INNER JOIN localidad ON localidad.idLocalid = clientes.idLocalid "
lcSql = lcSql + "	INNER JOIN provincias ON provincias.idProvin = localidad.idProvin "
lcSql = lcSql + "	INNER JOIN sitiva ON sitiva.idSitIVA = clientes.idSitIVA "
lcSql = lcSql + "	INNER JOIN condpagos ON condpagos.idCondPago = clientes.idCondPago "
lcSql = lcSql + "	INNER JOIN vendedores ON vendedores.idVendedor = ventascab.idVendedor "
lcSql = lcSql + "WHERE idVentasC = " + ALLTRIM(STR(cur_CbtePendi.idVentasC))

loRsCab.ActiveConnection = goConn.ActiveConnection
loRsCab.Cursor_Name = "cur_cabecera"

IF !loRsCab.OpenQuery(lcSql) THEN
	MESSAGEBOX(loRsCab.Error_Message, 0+48, Thisform.Caption)
	RETURN
ENDIF

IF !Thisform.cbte_por_cpto THEN
	&& Entra por acá si el comprobante es por detalle
	
	lcSql = "SELECT	"
	IF ALLTRIM(thisform.cbte) == "NC" THEN 
		lcSql = lcSql + "ventasdet.cantidad AS cantNC, "
	ELSE 
		lcSql = lcSql + "ventasdet.cantidad, "
	ENDIF 
	
	lcSql = lcSql + "articulos.codArt, "
	lcSql = lcSql + "ventasdet.descripcio, "
	lcSql = lcSql + "ventasdet.prArtic, "
	lcSql = lcSql + "ventasdet.alicIVA, "
	lcSql = lcSql + "ventasdet.subTotal, "
	lcSql = lcSql + "ventasdet.impNeto, "
	lcSql = lcSql + "ventasdet.totNeto "
	lcSql = lcSql + "FROM ventasdet "
	lcSql = lcSql + "	INNER JOIN articulos ON articulos.idArticulo = ventasdet.idArticulo "
	lcSql = lcSql + "WHERE ventasdet.idVentasC = " + ALLTRIM(STR(cur_CbtePendi.idVentasC))

	loRsDet.ActiveConnection = goConn.ActiveConnection
	loRsDet.Cursor_Name = "cur_aux"

	IF !loRsDet.OpenQuery(lcSql) THEN
		MESSAGEBOX(loRsDet.Error_Message, 0+48, Thisform.Caption)
		RETURN
	ENDIF
	
	Thisform.calc_saldo_deudor(cur_cabecera.idCliente)
ELSE
	&& Entra por aca si el comprobante es por concepto.
	lcSql = "SELECT vtadcp.*, "
	lcSql = lcSql + " planctas.codPlanCta, "
	lcSql = lcSql + " planctas.descripcio AS descPlan "
	lcSql = lcSql + "FROM	vtadcp "
	lcSql = lcSql + "	INNER JOIN planctas ON planctas.idPlanCta = vtadcp.idPlanCta "
	lcSql = lcSql + "WHERE	idVentasC = " + ALLTRIM(STR(cur_CbtePendi.idVentasC))
	
	loRsDet.ActiveConnection = goConn.ActiveConnection
	loRsDet.Cursor_Name = "vtadcp"
	
	IF !loRsDet.OpenQuery(lcSql) THEN
		MESSAGEBOX(loRsDet.Error_Message, 0+48, Thisform.Caption)
		RETURN
	ENDIF	
ENDIF

m.NroCli = cur_cabecera.idCliente
m.RazSoc = ALLTRIM(cur_cabecera.razSoc)
m.Telefono = ALLTRIM(cur_cabecera.telefono)
m.direccion = ALLTRIM(cur_cabecera.direccion)
m.localidad = ALLTRIM(cur_cabecera.descLoc)
m.codPostal = ALLTRIM(cur_cabecera.codPostal)
m.pcia = ALLTRIM(cur_cabecera.descPcia)
m.nroCUIT = ALLTRIM(cur_cabecera.nroDoc)
m.TipoIVA = ALLTRIM(cur_cabecera.descSIVA)
m.Total = 0.00
m.ptoVta = ""
m.NroCbte = ""
m.leyenda = ""
m.Fecha = DATETIME()
m.porIVA105 = 0.00
m.porIVA21 = 0.00
m.impIVA105 = 0.00
m.impIVA21 = 0.00
m.impNeto = 0.00
m.impFinal = 0.00
m.fecVto = DATE() + cur_cabecera.cntDias
m.tipoDoc = cur_cabecera.tipoDoc
m.porIIBB = 0.00
m.impIIBB = 0.00
lnCantCpia = 0
m.observ = ""
m.vendedor = cur_cabecera.usualta
m.cae = thisform.aut_cae
m.codigoCbte = REPLICATE("0", 2 - LEN(ALLTRIM(STR(Thisform.fe.F1CabeceraCbteTipo)))) + ALLTRIM(STR(Thisform.fe.F1CabeceraCbteTipo))
m.barcode = ""
m.saldoDeudor = Thisform.saldodeudor
m.code = "" 
m.NroRto = ""
m.nroOC = ALLTRIM(STR(cur_cabecera.nroOC))
m.condPago = IIF(cur_cabecera.cntDias = 0, "CONTADO", "CUENTAS CORRIENTES")

lcAnio = SUBSTR(Thisform.aut_cae_vto, 1, 4)
lcMes = SUBSTR(Thisform.aut_cae_vto, 5, 2)
lcDia = SUBSTR(Thisform.aut_cae_vto, 7, 2)

m.caevto = lcDia + "/" + lcMes + "/" + lcAnio
m.ptovta = cur_cabecera.ptoVta

&& Levanto el talonario del numerador solo para tomar la configuración de la impresora
lcSql = "select * from numerador where cbte = '" + ALLTRIM(Thisform.cbte) + "' and tipoDoc = '" + ALLTRIM(m.tipoDoc) + "' AND ptoVta = " + ALLTRIM(STR(m.ptoVta))
_cliptext = lcSql
loNumerador = CREATEOBJECT("odbc_result")
loNumerador.ActiveConnection = goConn.ActiveConnection
loNumerador.Cursor_Name = "cur_num"
loNumerador.OpenQuery(lcSql)

SELECT cur_num
lnIdNum = cur_num.idNum

loNumerador.close_query()


&& Levanto la impresora configurada en el puesto de trabajo actual.
lcSql = "SELECT * FROM impresoras WHERE hostName = '" + ALLTRIM(SYS(0)) + "' AND idNum = " + ALLTRIM(STR(lnIdNum))

loNumerador.ActiveConnection = goConn.ActiveConnection
loNumerador.Cursor_Name = "cur_x"

IF !loNumerador.OpenQuery(lcSql) THEN
	MESSAGEBOX(loNumerador.Error_Message, 0+48, Thisform.Caption)
	RETURN
ENDIF

SELECT cur_x
IF RECCOUNT("cur_x") = 0 THEN
	MESSAGEBOX("La impresora no se encuentra configurada en este puesto de trabajo.", 0+48, Thisform.Caption)
	RETURN
ENDIF

lcPrinterName = ALLTRIM(cur_x.impresora)
lnCantCpia = cur_x.copias

loNumerador.Close_Query()

m.NroCbte = REPLICATE("0", 4 - LEN(ALLTRIM(STR(Thisform.ptovta)))) + ALLTRIM(STR(Thisform.ptovta)) + "-" + REPLICATE("0", 8 - LEN(ALLTRIM(STR(Thisform.nrocbte)))) + ALLTRIM(STR(Thisform.nrocbte))

IF ALLTRIM(Thisform.cbte) == "COT"
	m.leyenda = "COTIZACION"
	m.tipoDoc = "X"
	m.Total = cur_cabecera.totFact
ELSE 
	IF ALLTRIM(Thisform.cbte) == "PTO"
		m.leyenda = "PRESUPUESTO"
		m.tipoDoc = "X"
		m.Total = cur_cabecera.impFinal
	ELSE
		IF ALLTRIM(Thisform.cbte) == "PED"
			m.leyenda = "NOTA DE PEDIDO"
			m.tipoDoc = "P"
			m.Total = cur_cabecera.totFact
		ELSE
			IF ALLTRIM(Thisform.Cbte) == "FC"
				m.leyenda = "FACTURA"
				m.Total = cur_cabecera.totFact
			ELSE
				IF ALLTRIM(Thisform.Cbte) == "NC"
					m.Leyenda = "NOTA DE CREDITO"
					m.Total = cur_cabecera.totFact
				ELSE
					IF ALLTRIM(Thisform.Cbte) == "ND"
						m.leyenda = "NOTA DE DEBITO"
						m.Total = cur_cabecera.totFact
					ENDIF
				ENDIF
			ENDIF
		ENDIF
	ENDIF
ENDIF

m.porDesc1 = cur_cabecera.porDesc1
m.porDesc2 = cur_cabecera.porDesc2
m.porDesc3 = cur_cabecera.porDesc3
m.porDesc4 = cur_cabecera.porDesc4
m.impDesc1 = cur_cabecera.impDesc1
m.impDesc2 = cur_cabecera.impDesc2
m.impDesc3 = cur_cabecera.impDesc3
m.impDesc4 = cur_cabecera.impDesc4
m.porRec = cur_cabecera.porRec
m.porIVA105 = cur_cabecera.porIVA105
m.poIVA21 = cur_cabecera.porIVA21
m.impIVA105 = cur_cabecera.impIVA105
m.impIVA21 = cur_cabecera.impIVA21
m.impNeto = cur_cabecera.impFinal
m.impFinal = cur_cabecera.impFinal
m.porIIBB = cur_cabecera.porIIBB
m.impIIBB = cur_cabecera.impIIBB

m.observ = cur_cabecera.observ

&& Mando a imprimir los remitos
IF getglobalcfg("PRINT_RTO") THEN
	IF This.cbte <> "COT" THEN
		lnResp = MESSAGEBOX("¿Desea emitir remito?", 32+4, Thisform.Caption)
		IF lnResp = 6 THEN
			IF Thisform.getprinterrto() THEN
				m.NroRto = Thisform.rto_numero
				SET PRINTER TO NAME ALLTRIM(Thisform.rto_printer)
				SELECT cur_aux
			
				FOR i = 1 TO This.rto_cantcpias
					REPORT FORM "rep_rtos.frx" TO PRINTER NOCONSOLE
				NEXT i
			ENDIF
		ENDIF
	ENDIF
ENDIF

&& Generación del código de barra
m.barcode = ALLTRIM(cur_cabecera.nroDoc)
m.barcode = m.barcode + ALLTRIM(m.codigoCbte)
m.barcode = m.barcode + REPLICATE("0", 4 - LEN(ALLTRIM(STR(m.ptovta)))) + ALLTRIM(STR(m.ptovta))
m.barcode = m.barcode + ALLTRIM(m.cae)
m.barcode = m.barcode + ALLTRIM(lcAnio)
m.barcode = m.barcode + REPLICATE("0", 2 - LEN(ALLTRIM(lcMes))) + ALLTRIM(lcMes)
m.barcode = m.barcode + REPLICATE("0", 2 - LEN(ALLTRIM(lcDia))) + ALLTRIM(lcDia)
m.barcode = m.barcode + ALLTRIM(STR(Thisform.calc_digito_verificador(m.barcode)))
m.code = m.barcode
m.barcode = getcodbarras(m.barcode)

IF cur_cabecera.printCbte THEN
	SET PRINTER TO NAME ALLTRIM(lcPrinterName)

	FOR i = 1 TO lnCantCpia
		IF (this.cbte == "COT") THEN
			&& Imprime un presupuesto
			SELECT cur_aux
			REPORT FORM "repcot.frx" TO PRINTER NOCONSOLE
		ELSE
			IF (this.cbte == "PTO") THEN
				&& Imprime un presupuesto
				SELECT cur_aux
				REPORT FORM "reppto.frx" TO PRINTER NOCONSOLE
			ELSE
				&& Si el comprobante es "PED" entonces, tiene que enviar a imprimir una nota de pedido
				IF ALLTRIM(Thisform.cbte) == "PED" THEN
					SELECT cur_detalle
					m.observ = Thisform.contenido.txtObserv.Value
					REPORT FORM "reppedido.frx" TO PRINTER NOCONSOLE
				ELSE 
					IF ALLTRIM(m.tipoDoc) == "A" THEN
						&& Imprime el comprobante de tipo "A"
						IF !Thisform.cbte_por_cpto THEN
							SELECT cur_aux
							REPORT FORM "repcbtesvta.frx" TO PRINTER NOCONSOLE
						ELSE
							SELECT vtadcp
							REPORT FORM "repncnd" TO PRINTER NOCONSOLE
						ENDIF
					ELSE
						&& Imprime el comprobante de tipo "B"
						IF !Thisform.cbte_por_cpto THEN
							SELECT cur_aux
							REPORT FORM "repcbtesvta_b.frx" TO PRINTER NOCONSOLE
						ELSE
							SELECT vtadcp
							REPORT FORM "repncnd_b" TO PRINTER NOCONSOLE
						ENDIF
					ENDIF
				ENDIF
			ENDIF
		ENDIF
	NEXT
ENDIF

IF cur_cabecera.envCbte THEN
	lcFileName = SYS(5) + SYS(2003) + "\wsafip\ComprobantesPDF\" + this.cbte + "_" + m.NroCbte + ".pdf"
	
	loPDF = CREATEOBJECT("Bullzip.PDFPrinterSettings")
		loPDF.SetValue('output', lcFileName)
		loPDF.SetValue('DisableOptionDialog', 'no') 
		loPDF.SetValue('ConfirmOverwrite', 'no')
		loPDF.SetValue('Showsettings', 'never') 
		loPDF.SetValue('ShowSaveAS', 'nofile') 
		loPDF.SetValue('ShowPdf', 'no') 
		loPDF.WriteSettings(.t.)
	
	SET CONSOLE OFF
	SET PRINTER TO NAME("Bullzip PDF Printer")

	IF ALLTRIM(m.tipoDoc) == "A" THEN
		&& Imprime el comprobante de tipo "A"
		IF !Thisform.cbte_por_cpto THEN
			SELECT cur_aux
			REPORT FORM "repcbtesvta.frx" TO PRINTER NOCONSOLE
		ELSE
			SELECT vtadcp
			REPORT FORM "repncnd" TO PRINTER NOCONSOLE
		ENDIF
	ELSE
		&& Imprime el comprobante de tipo "B"
		IF !Thisform.cbte_por_cpto THEN
			SELECT cur_aux
			REPORT FORM "repcbtesvta_b.frx" TO PRINTER NOCONSOLE
		ELSE
			SELECT vtadcp
			REPORT FORM "repncnd_b" TO PRINTER NOCONSOLE
		ENDIF
	ENDIF
	
	SET PRINTER TO DEFAULT
	SET CONSOLE ON
	
	DO WHILE !FILE(lcFileName)
		WAIT WINDOW "El archivo PDF se está generando, aguarde unos segundos..." NOWAIT
	ENDDO
	
	MESSAGEBOX("Archivo generado en " + lcFileName, 0+64, Thisform.Caption)
	
	TEXT TO lcMailMsg NOSHOW
	Estimado cliente,
	Le adjuntamos el comprobante electrónico emitido en formato PDF.
	
	Desde ya muchas gracias por la compra!!!
	
	Saludos cordiales,
	
	ENDTEXT
	lcMailMsg = lcMailMsg + lcNomEmp
		
	&& Procedo a hacer el envío de mail
	DO LOCFILE("FoxyPreviewer.App")
	WITH _screen.oFoxyPreviewer	
		.cEmailType = "PDF"
		.nEmailMode = 2
		.cEMailTo = cur_cabecera.mailFC
		.cSMTPServer = "smtp.gmail.com"
		.cEmailFrom = "noreply.lpsoft@gmail.com"
		.cEMailSubject = "Comprobante Electrónico " + this.cbte + "_" + m.NroCbte
		.nSMTPPort = 465
		.lSMTPUseSSL = .t.
		.cSMTPUserName = "noreply.lpsoft@gmail.com"
		.cSMTPPassword = "LP2523eo"
		.lReadReceipt   = .F.
		.lPriority      = .F.
		.cEmailBody = lcMailMsg
		.SendEmailUsingCDO(lcFileName)
	ENDWITH	
ENDIF

loRsCab.Close_Query()
loRsDet.Close_Query()

ENDPROC
PROCEDURE enviar_wsafipfe
LOCAL llRes
LOCAL lnPtoVta
LOCAL lnTipoDoc, lcTipoDoc
LOCAL lnRetAlva
LOCAL lnCantIVA
LOCAL lnImpBase21
LOCAL lnImpBase105
LOCAL lcNumero
LOCAL lcMensaje
LOCAL lnImpBaseSIVA
LOCAL lnIndice
LOCAL lnTotalIVA
LOCAL lnModo
LOCAL lcCUIT
LOCAL lcCertif
LOCAL lcLicencia
LOCAL lcPassword
LOCAL loRsCab
LOCAL loRsDet
LOCAL lcSql

lnTipoDoc = 0
lcTipoDoc = ""
lnPtoVta = ""
lnRetAlva = 0
lnCantIVA = 0
lnImpBase21 = 0
lnImpBase105 = 0
lnImpBaseSIVA = 0
lcNumero = ""
lcMensaje = ""
lnIndice = 0
lnTotalIVA = 0.00
loRsCab = CREATEOBJECT("odbc_result")
loRsDet = CREATEOBJECT("odbc_result")

&& Parametros para la conexión con WSFEv1
lnModo = IIF(getGlobalCFG("FEDEBUG"), 0, 1)
lcCUIT = ALLTRIM(getGlobalCFG("FECUIT"))
lcCertif = ALLTRIM(getGlobalCFG("FE_FILE"))
lcLicencia = ALLTRIM(getGlobalCFG("FE_LIC"))
lcPassword = ALLTRIM(getGlobalCFG("FE_PWD"))

&& Acá tengo que levantar el comprobante a actualizar actual
lcSql = "SELECT *, tipodoc.tipoDoc as tdoc "
lcSql = lcSql + "FROM ventascab "
lcSql = lcSql + "	INNER JOIN tipodoc ON tipodoc.idTipoDoc = ventascab.idTipoDoc "
lcSql = lcSql + "WHERE idVentasC = " + ALLTRIM(STR(cur_CbtePendi.idVentasC))

loRsCab.ActiveConnection = goConn.ActiveConnection
loRsCab.Cursor_Name = "cur_cabecera"

IF !loRsCab.OpenQuery(lcSql) THEN
	MESSAGEBOX(loRsCab.Error_Message, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

lnPtoVta = cur_cabecera.ptoVta
lcTipoDoc = cur_cabecera.tipoDoc
Thisform.cbte = cur_cabecera.cbte

&& Tengo que acordarme que en el tercer parámetro tengo que pasar
&& la ruta y el nombre de archivo del certificado.

llRes = Thisform.fe.iniciar(lnModo, lcCUIT, SYS(5) + SYS(2003) + "\wsafip\" + lcCertif, lcLicencia)
&& llRes = Thisform.fe.iniciar(0, "20364791969", SYS(5) + SYS(2003) + "\Release\SISCOM_BETA\wsafip\20364791969.pfx", "")

IF !llRes THEN
	MESSAGEBOX("Falló al iniciar: " + Thisform.fe.ultimoMensajeError, 0+32, Thisform.Caption)
	RETURN .F.
ENDIF

Thisform.fe.ArchivoCertificadoPassWord = lcPassword
IF !Thisform.ticket_valido() THEN
	MESSAGEBOX("No se pudo generar Ticket de Acceso", 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

Thisform.fe.ArchivoXMLRecibido = SYS(5) + SYS(2003) + "\wsafip\xml\" + ALLTRIM(STR(cur_CbtePendi.idVentasC)) + "_rec_" + ALLTRIM(STR(YEAR(DATETIME()))) + ;
	ALLTRIM(STR(MONTH(DATETIME()))) + ALLTRIM(STR(DAY(DATETIME()))) + ALLTRIM(STR(HOUR(DATETIME()))) + ;
	ALLTRIM(STR(MINUTE(DATETIME()))) + ALLTRIM(STR(SEC(DATETIME()))) + ".xml"
	
Thisform.fe.archivoXMLEnviado = SYS(5) + SYS(2003) + "\wsafip\xml\" + ALLTRIM(STR(cur_CbtePendi.idVentasC)) + "_env_" + ALLTRIM(STR(YEAR(DATETIME()))) + ;
	ALLTRIM(STR(MONTH(DATETIME()))) + ALLTRIM(STR(DAY(DATETIME()))) + ALLTRIM(STR(HOUR(DATETIME()))) + ;
	ALLTRIM(STR(MINUTE(DATETIME()))) + ALLTRIM(STR(SEC(DATETIME()))) + ".xml"
	
lnRetAlva = Thisform.fe.f1CompUltimoAutorizado(lnPtoVta, Thisform.fe_get_tipocbte_afip(ALLTRIM(cur_cabecera.tipoDoc)))

Thisform.fe.F1CabeceraCantReg = 1
Thisform.fe.F1CabeceraPtoVta = lnPtoVta
Thisform.fe.F1CabeceraCbteTipo = Thisform.fe_get_tipocbte_afip(ALLTRIM(cur_cabecera.tipoDoc))
Thisform.fe.F1DetalleDocTipo = Thisform.fe_convertir_tipodoc(ALLTRIM(cur_cabecera.tdoc))
Thisform.fe.F1DetalleDocNro = cur_cabecera.nroDoc
Thisform.fe.F1DetalleCbteDesde = lnRetAlva + 1
Thisform.fe.F1DetalleCbteHasta = lnRetAlva + 1

Thisform.fe.F1DetalleCbteFch = ALLTRIM(STR(YEAR(DATE()))) + IIF(LEN(ALLTRIM(STR(MONTH(DATE())))) < 2, "0" + ALLTRIM(STR(MONTH(DATE()))), ALLTRIM(STR(MONTH(DATE())))) + ;
	IIF(LEN(ALLTRIM(STR(DAY(DATE())))) < 2, "0" + ALLTRIM(STR(DAY(DATE()))), ALLTRIM(STR(DAY(DATE()))))
	
&& Tengo que calcular la suma del neto de los articulos con 21 de IVA y con el 10.5 de IVA
&& por separado.

lcSql = "SELECT * FROM ventasdet "
lcSql = lcSql + "WHERE ventasdet.idVentasC = " + ALLTRIM(STR(cur_cabecera.idVentasC))

loRsDet.ActiveConnection = goConn.ActiveConnection
loRsDet.Cursor_Name = "cur_detalle"

IF !loRsDet.OpenQuery(lcSql) THEN
	MESSAGEBOX(loRsDet.Error_Message, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

SELECT cur_detalle
IF RECCOUNT("cur_detalle") <> 0 THEN
	&& Entra por acá en caso de que el comprobante sea normal
	GO TOP
	DO WHILE !EOF("cur_detalle")
		IF cur_detalle.alicIVA = 21 THEN
			lnImpBase21 = lnImpBase21 + cur_detalle.totNeto
		ENDIF
		
		IF cur_detalle.alicIVA = 10.5 THEN
			lnImpBase105 = lnImpBase105 + cur_detalle.totNeto
		ENDIF
		
		IF cur_detalle.alicIVA = 0 THEN
			lnImpBaseSIVA = lnImpBaseSIVA + cur_detalle.totNeto
		ENDIF

		SELECT cur_detalle
		SKIP
	ENDDO
	
	loRsDet.Close_Query()
	Thisform.cbte_por_cpto = .F.
ELSE
	&& entra por acá en caso de que el comprobante sea por concepto
	loRsDet.Close_Query()
	
	lcSql = "select * from vtadcp where idVentasC = " + ALLTRIM(STR(cur_cabecera.idVentasC))
	loRsDet.ActiveConnection = goConn.ActiveConnection
	loRsDet.Cursor_Name = "cur_detalle"

	IF !loRsDet.OpenQuery(lcSql) THEN
		MESSAGEBOX(loRsDet.Error_Message, 0+48, Thisform.Caption)
		RETURN .F.
	ENDIF
	
	SELECT cur_detalle
	GO TOP
	
	DO WHILE !EOF("cur_detalle")
		IF cur_detalle.ivaPor = 21 THEN
			lnImpBase21 = lnImpBase21 + cur_detalle.impNeto
		ENDIF
		
		IF cur_detalle.ivaPor = 10.5 THEN
			lnImpBase105 = lnImpBase105 + cur_detalle.impNeto
		ENDIF
		
		IF cur_detalle.ivaPor = 0 THEN
			lnImpBaseSIVA = lnImpBaseSIVA + cur_detalle.impNeto
		ENDIF
		
		SELECT cur_detalle
		SKIP
	ENDDO
	
	loRsDet.Close_Query()
	Thisform.cbte_por_cpto = .T.
ENDIF


lnIndice = 0
lnTotalIVA = 0.00
IF lnImpBase21 <> 0 THEN
	Thisform.fe.F1DetalleIvaItemCantidad = 1
	Thisform.fe.f1IndiceItem = lnIndice
	Thisform.fe.F1DetalleIvaId = 5
	Thisform.fe.F1DetalleIvaBaseImp = ROUND(lnImpBase21, 2)
	Thisform.fe.F1DetalleIvaImporte = ROUND(lnImpBase21 * 0.21, 2)
	lnTotalIVA = lnTotalIVA + (ROUND(lnImpBase21 * 0.21, 2))
	lnIndice = lnIndice + 1
ENDIF

IF lnImpBase105 <> 0 THEN
	Thisform.fe.F1DetalleIvaItemCantidad = Thisform.fe.F1DetalleIvaItemCantidad + 1
	Thisform.fe.f1IndiceItem = lnIndice
	Thisform.fe.F1DetalleIvaId = 4
	Thisform.fe.F1DetalleIvaBaseImp = ROUND(lnImpBase105, 2)
	Thisform.fe.F1DetalleIvaImporte = ROUND(lnImpBase105 * 0.105, 2)
	lnTotalIVA = lnTotalIVA + (ROUND(lnImpBase105 * 0.105, 2))
	lnIndice = lnIndice + 1
ENDIF

IF lnImpBaseSIVA <> 0 THEN
	Thisform.fe.F1DetalleIvaItemCantidad = Thisform.fe.F1DetalleIvaItemCantidad + 1
	Thisform.fe.f1IndiceItem = lnIndice
	Thisform.fe.F1DetalleIvaId = 3
	Thisform.fe.F1DetalleIvaBaseImp = ROUND(lnImpBaseSIVA, 2)
ENDIF

&& Agrego los conceptos de IIBB

IF cur_cabecera.porIIBB <> 0 THEN
	Thisform.FE.F1DetalleTributoItemCantidad = 1
	Thisform.FE.f1IndiceItem = 0
	Thisform.FE.F1DetalleTributoId = 2
	Thisform.FE.F1DetalleTributoDesc = "IIBB Pcia Bs AS"
	Thisform.FE.F1DetalleTributoBaseImp = cur_cabecera.impFinal
	Thisform.FE.F1DetalleTributoAlic = cur_cabecera.porIIBB
	Thisform.FE.F1DetalleTributoImporte = cur_cabecera.impIIBB
ENDIF

Thisform.fe.F1DetalleConcepto = 1
Thisform.fe.F1DetalleImpNeto = cur_cabecera.impFinal
Thisform.fe.F1DetalleImpTotalConc = 0
Thisform.fe.F1DetalleImpIva = ROUND(lnTotalIVA, 2)
Thisform.fe.F1DetalleImpOpEx = 0
Thisform.fe.F1DetalleImpTrib = Thisform.FE.F1DetalleTributoImporte
Thisform.fe.F1DetalleMonId = "PES"
Thisform.fe.F1DetalleMonCotiz = 1
Thisform.fe.F1DetalleImpTotal = cur_cabecera.totFact


llRes = Thisform.fe.f1CAESolicitar()

&& llRes = Thisform.fe.registrar(lnPtoVta, Thisform.fe_get_tipocbte_afip(ALLTRIM(lcTipoDoc)), "1") 
loRsCab.Close_Query()

IF llRes THEN
	lcNumero = REPLICATE("0", 4 - LEN(ALLTRIM(STR(lnPtoVta)))) + ALLTRIM(STR(lnPtoVta)) + "-" + ;
		REPLICATE("0", 8 - LEN(ALLTRIM(STR(Thisform.fe.F1RespuestaDetalleCbteDesde)))) + ALLTRIM(STR(Thisform.fe.F1RespuestaDetalleCbteDesde))
	
	Thisform.ptovta = lnPtoVta
	Thisform.nrocbte = INT(VAL(Thisform.fe.F1RespuestaDetalleCbteDesdeS))
	
	lcMensaje = "CAE: " + Thisform.fe.F1RespuestaDetalleCae + CHR(13)+ CHR(10)
	lcMensaje = lcMensaje + "FECHA VTO: " + Thisform.fe.F1RespuestaDetalleCaeFchVto + CHR(13) + CHR(10)
	lcMensaje = lcMensaje + "MOTIVO: " + Thisform.fe.F1RespuestaDetalleObservacionMsg + CHR(13) + CHR(10)
	lcMensaje = lcMensaje + "PROCESO: " + Thisform.fe.F1RespuestaReProceso
	MESSAGEBOX(lcMensaje, 0+64, Thisform.Caption)
	
	Thisform.aut_numero = lcNumero
	Thisform.aut_cae = Thisform.fe.F1RespuestaDetalleCae
	Thisform.aut_cae_vto = Thisform.fe.F1RespuestaDetalleCaeFchVto
	Thisform.aut_resultado = Thisform.fe.F1RespuestaResultado
	Thisform.aut_motivo = Thisform.fe.F1RespuestaDetalleObservacionMsg
ELSE
	IF !(ISNULL(Thisform.fe.F1RespuestaReProceso) .OR. Thisform.fe.F1RespuestaReProceso == "R") THEN
		lcNumero = REPLICATE("0", 4 - LEN(ALLTRIM(STR(lnPtoVta)))) + ALLTRIM(STR(lnPtoVta)) + "-" + ;
			REPLICATE("0", 4 - LEN(ALLTRIM(STR(Thisform.fe.F1RespuestaDetalleCbteDesde)))) + ALLTRIM(STR(Thisform.fe.F1RespuestaDetalleCbteDesde))
		
		&& lcMensaje = "CAE: " + Thisform.fe.F1RespuestaDetalleCae + CHR(13)+ CHR(10)
		lcMensaje = "ATENCION: Factura rechazada por el AFIP" + CHR(13) + CHR(10)
		&&lcMensaje = lcMensaje + "FECHA VTO: " + Thisform.fe.F1RespuestaDetalleCaeFchVto + CHR(13) + CHR(10)		
		lcMensaje = lcMensaje + "MOTIVO: " + Thisform.fe.F1RespuestaDetalleObservacionMsg + CHR(13) + CHR(10)
		&&lcMensaje = lcMensaje + "PROCESO: " + Thisform.fe.F1RespuestaReProceso
		MESSAGEBOX(lcMensaje, 0+64, Thisform.Caption)
		MESSAGEBOX("Recomendación: Elimine este comprobante y vuelva a generarlo por favor.", 0+48, Thisform.Caption)
		
		Thisform.aut_numero = lcNumero
		Thisform.aut_cae = Thisform.fe.F1RespuestaDetalleCae
		Thisform.aut_cae_vto = Thisform.fe.F1RespuestaDetalleCaeFchVto
		Thisform.aut_resultado = Thisform.fe.F1RespuestaResultado
		Thisform.aut_motivo = Thisform.fe.F1RespuestaDetalleObservacionMsg
		RETURN .F.
	ELSE
		lcMensaje = "MOTIVO: " + Thisform.fe.F1RespuestaDetalleObservacionMsg + CHR(13) + CHR(10)
		lcMensaje = lcMensaje + "ERROR: " + Thisform.fe.f1ErrorMsg1 + CHR(13) + CHR(10)
		lcMensaje = lcMensaje + "ULTIMO: " + Thisform.fe.UltimoMensajeError
		MESSAGEBOX(lcMensaje, 0+64, Thisform.Caption)
		
		Thisform.aut_numero = lcNumero
		Thisform.aut_cae = ""
		Thisform.aut_cae_vto = ""
		Thisform.aut_resultado = Thisform.fe.F1RespuestaResultado
		Thisform.aut_motivo = Thisform.fe.F1RespuestaDetalleObservacionMsg
		RETURN .F.
	ENDIF
ENDIF

RETURN .T.

ENDPROC
PROCEDURE calc_saldo_deudor
PARAMETERS lnIdCliente
LOCAL loRes, lcSql

loRes = CREATEOBJECT("odbc_result")
lcSql = ""

lcSql = "SELECT		ventascab.idVentasC, "
lcSql = lcSql + "	ventascab.cbte, "
lcSql = lcSql + "	ventascab.tipoDoc, "
lcSql = lcSql + "	ventascab.ptoVta, "
lcSql = lcSql + "	ventascab.numCbte, "
lcSql = lcSql + "	ventascab.fecEmision, "
lcSql = lcSql + "	ventascab.fecVto,  "
lcSql = lcSql + "	ventascab.saldo "
lcSql = lcSql + "FROM	ventascab "
lcSql = lcSql + "WHERE ventascab.idCliente = " + ALLTRIM(STR(lnIdCliente))
lcSql = lcSql + "	AND ventascab.idVentasC IN ( "
lcSql = lcSql + "			SELECT	MAX(idVentasC) "
lcSql = lcSql + "			FROM	cc_cli  "
lcSql = lcSql + "			WHERE	idCliente = " + ALLTRIM(STR(lnIdCliente)) + " "
lcSql = lcSql + "			GROUP BY idOper "
lcSql = lcSql + "			HAVING (SUM(impDebe) - SUM(impHaber)) <> 0) "

loRes.ActiveConnection = goConn.ActiveConnection
loRes.Cursor_Name = "cur_moro"

IF !loRes.OpenQuery(lcSql) THEN
	MESSAGEBOX(loRes.Error_Message, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF


thisform.saldodeudor = 0.00

SELECT cur_moro
IF RECCOUNT("cur_moro") > 0 THEN
	GO TOP
ENDIF

DO WHILE !EOF("cur_moro")
	
	thisform.saldodeudor = thisform.saldodeudor + cur_moro.saldo

	SELECT cur_moro
	SKIP
ENDDO

loRes.Close_Query()

RETURN .T.
ENDPROC
PROCEDURE leer_cbtes_pendi
LOCAL loResult, lcSql

SELECT cur_CbtePendi
ZAP

lcSql = "SELECT idVentasC, fecEmision, cbte, tipoDoc, ptoVta, numCbte, totFact, "
lcSql = lcSql + "idCliente, razSoc "
lcSql = lcSql + "FROM ventascab "
lcSql = lcSql + "WHERE (ventascab.aut_cae IS NULL OR ventascab.aut_Resultado = 'R') "
lcSql = lcSql + "	AND ventascab.cbte IN ('FC', 'NC', 'ND') "
lcSql = lcSql + "	AND ventascab.idHostAlta = '" + ALLTRIM(SYS(0)) + "' "
lcSql = lcSql + "	AND ventascab.fecBaja IS NULL "
lcSql = lcSql + "ORDER BY fecEmision DESC "

loResult = CREATEOBJECT("odbc_result")
loResult.ActiveConnection = goConn.ActiveConnection
loResult.Cursor_Name = "cur_x"

IF !loResult.OpenQuery(lcSql) THEN
	MESSAGEBOX(loResult.Error_Message, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

SELECT cur_x
DO WHILE !EOF("cur_x")
	SELECT cur_CbtePendi
	APPEND BLANK
	REPLACE cur_CbtePendi.idVentasC WITH cur_x.idVentasC
	REPLACE cur_CbtePendi.fecEmision WITH cur_x.fecEmision ADDITIVE
	REPLACE cur_CbtePendi.cbte WITH cur_x.cbte ADDITIVE
	REPLACE cur_CbtePendi.tipoDoc WITH cur_x.tipoDoc ADDITIVE
	REPLACE cur_CbtePendi.ptoVta WITH REPLICATE("0", 4 - LEN(ALLTRIM(STR(cur_x.ptoVta)))) + ALLTRIM(STR(cur_x.ptoVta)) ADDITIVE
	REPLACE cur_CbtePendi.numCbte WITH REPLICATE("0", 8 - LEN(ALLTRIM(STR(cur_x.numCbte)))) + ALLTRIM(STR(cur_x.numCbte)) ADDITIVE
	REPLACE cur_CbtePendi.totFact WITH cur_x.totFact ADDITIVE
	REPLACE cur_CbtePendi.idCliente WITH cur_x.idCliente ADDITIVE
	REPLACE cur_CbtePendi.razSoc WITH cur_x.razSoc ADDITIVE
	
	SELECT cur_x
	SKIP
ENDDO

loResult.Close_Query()

SELECT cur_CbtePendi
GO TOP
Thisform.Contenido.grdCbtes.Refresh()

ENDPROC
PROCEDURE ticket_valido
LOCAL llTkValido
LOCAL lcTicket
LOCAL lcFileTicket
LOCAL lcTK
LOCAL hndFile

llTkValido = .F.
lcTicket = ""
lcTK = ""
lcFileTicket = getGlobalCFG("FE_TICKACC")

IF FILE(ALLTRIM(lcFileTicket)) THEN
	hndFile = FOPEN(lcFileTicket, 12)
	IF hndFile < 0 THEN
		=MESSAGEBOX("Error al intentar leer el ticket de acceso", 0+48, Thisform.Caption)
		=FCLOSE(hndFile)
	ELSE
		=FCLOSE(hndFile)
		
		lcTK = FILETOSTR(ALLTRIM(lcFileTicket))
		Thisform.fe.f1RestaurarTicketAcceso(lcTK)
		
		IF Thisform.fe.f1TicketEsValido THEN
			llTkValido = .T.
		ELSE
			llTkValido = .F.
		ENDIF
	ENDIF
	
	IF !llTkValido THEN
		DELETE FILE ALLTRIM(lcFileTicket)
		
		IF Thisform.fe.f1ObtenerTicketAcceso() THEN
			lcTK = Thisform.fe.f1GuardarTicketAcceso()
			hndFile = FCREATE(lcFileTicket)
			
			IF hndFile < 0 THEN
				=MESSAGEBOX("Error al generar el archivo, por favor verifique la ruta se encuentre accesible", 0+16, Thisform.Caption)
			ELSE
				=FWRITE(hndFile, lcTK)
				llTkValido = .T.
			ENDIF
			
			=FCLOSE(hndFile)
		ELSE
			MESSAGEBOX("Fallo de acceso: " + ALLTRIM(Thisform.fe.ultimoMensajeError), 0+16, Thisform.Caption)
			llTkValido = .F.
		ENDIF
	ENDIF
ELSE
	IF Thisform.fe.f1ObtenerTicketAcceso() THEN
		lcTK = Thisform.fe.f1GuardarTicketAcceso()
		hndFile = FCREATE(lcFileTicket)
		
		IF hndFile < 0 THEN
			=MESSAGEBOX("Error al generar el archivo, por favor verifique la ruta se encuentre accesible", 0+48, Thisform.Caption)
		ELSE
			=FWRITE(hndFile, lcTK)
			llTkValido = .T.
		ENDIF
		
		=FCLOSE(hndFile)
	ELSE
		MESSAGEBOX("Fallo de acceso: " + ALLTRIM(Thisform.fe.ultimoMensajeError), 0+16, Thisform.Caption)
		llTkValido = .F.			
	ENDIF
ENDIF

RETURN llTkValido
ENDPROC
PROCEDURE corregir_iva
LOCAL loCommand
LOCAL loRes
LOCAL lcSql

loRes = CREATEOBJECT("odbc_result")
loCommand = CREATEOBJECT("odbc_command")
lcSql = ""

goConn.BeginTransaction()

&& Paso 1: Corrijo las diferencias de centavos de IVA
&& en el detalle.

lcSql = "UPDATE ventasdet SET impIVA = (totNeto * (alicIVA / 100)) "
lcSql = lcSql + "WHERE idVentasC = " + ALLTRIM(STR(cur_CbtePendi.idVentasC))

loCommand.ActiveConnection = goConn.ActiveConnection
loCommand.CommandText = lcSql

IF !loCommand.Execute() THEN
	goConn.Rollback()
	MESSAGEBOX(loCommand.Error_Message, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

lcSql = "SELECT idVentasC, "
lcSql = lcSql + " totNeto, "
lcSql = lcSql + " alicIVA, "
lcSql = lcSql + " SUM(totNeto) AS totNeto, "
lcSql = lcSql + " SUM(totNeto * (alicIVA / 100)) AS impIVA "
lcSql = lcSql + "FROM	ventasdet "
lcSql = lcSql + "WHERE	ventasdet.idVentasC = " + ALLTRIM(STR(cur_CbtePendi.idVentasC)) + " "
lcSql = lcSql + " 	AND ventasdet.alicIVA = 21 "
lcSql = lcSql + "GROUP BY idVentasC "
lcSql = lcSql + "UNION "
lcSql = lcSql + "	SELECT 	idVentasC, "
lcSql = lcSql + "			totNeto, "
lcSql = lcSql + "			alicIVA, "
lcSql = lcSql + "			SUM(totNeto) AS totNeto, "
lcSql = lcSql + "			SUM(totNeto * (alicIVA / 100)) AS impIVA "
lcSql = lcSql + "	FROM ventasdet "
lcSql = lcSql + "	WHERE ventasdet.idVentasC = " + ALLTRIM(STR(cur_CbtePendi.idVentasC)) + " "
lcSql = lcSql + "		AND ventasdet.alicIVA = 10.5 "
lcSql = lcSql + "	GROUP BY idVentasC "

loRes.ActiveConnection = goConn.ActiveConnection
loRes.Cursor_Name = "cur_tempo"

IF !loRes.OpenQuery(lcSql) THEN
	goConn.Rollback()
	MESSAGEBOX(loRes.Error_Message, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

SELECT cur_tempo
GO TOP
DO WHILE !EOF("cur_tempo")
	IF cur_tempo.alicIVA = 21 THEN
		lcSql = "UPDATE ventascab "
		lcSql = lcSql + "SET ventascab.impIVA21 = " + ALLTRIM(STR(cur_tempo.impIVA, 10, 2)) + " "
		lcSql = lcSql + "WHERE ventascab.idVentasC = " + ALLTRIM(STR(cur_tempo.idVentasC))
	ELSE
		lcSql = "UPDATE ventascab "
		lcSql = lcSql + "SET ventascab.impIVA105 = " + ALLTRIM(STR(cur_tempo.impIVA, 10, 2)) + " "
		lcSql = lcSql + "WHERE ventascab.idVentasC = " + ALLTRIM(STR(cur_tempo.idVentasC))	
	ENDIF
	
	loCommand.ActiveConnection = goConn.ActiveConnection
	loCommand.CommandText = lcSql
	
	IF !loCommand.Execute() THEN
		goConn.Rollback()
		MESSAGEBOX(loCommand.ErrorMessage, 0+48, Thisform.Caption)
		RETURN .F.
	ENDIF

	SELECT cur_tempo
	SKIP
ENDDO

loRes.Close_Query()

RETURN .T.
ENDPROC
PROCEDURE getprinterrto
LOCAL loRes
LOCAL loCommand
LOCAL lcSql
LOCAL lnPtoVta
LOCAL lnIdNum
LOCAL lnNro

loRes = CREATEOBJECT("odbc_result")
loCommand = CREATEOBJECT("odbc_command")
lcSql = ""
lnPtoVta = INT(VAL(getConfig("PTOVTA")))
lnIdNum = 0

lcSql = "SELECT * FROM numerador "
lcSql = lcSql + "WHERE cbte = 'RTO' "
lcSql = lcSql + "	AND ptoVta = " + ALLTRIM(STR(lnPtoVta))

loRes.ActiveConnection = goConn.ActiveConnection
loRes.Cursor_Name = "cur_num"

IF !loRes.OpenQuery(lcSql) THEN
	MESSAGEBOX(loRes.Error_Message, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

IF RECCOUNT("cur_num") > 0 THEN
	lnNro = cur_num.numActual + 1
	Thisform.rto_numero = REPLICATE("0", 4 - LEN(ALLTRIM(STR(lnPtoVta)))) + ALLTRIM(STR(lnPtoVta)) ;
			+ "-" + REPLICATE("0", 8 - LEN(ALLTRIM(STR(lnNro)))) + ALLTRIM(STR(lnNro))
	
	lnIdNum = cur_num.idNum
ELSE
	MESSAGEBOX("El numerador no se encuentra configurado", 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

loRes.Close_Query()

lcSql = "SELECT * FROM impresoras "
lcSql = lcSql + "WHERE hostName = '" + ALLTRIM(SYS(0)) + "' "
lcSql = lcSql + "	AND impresoras.idNum = " + ALLTRIM(STR(lnIdNum))

loRes.ActiveConnection = goConn.ActiveConnection
loRes.Cursor_Name = "cur_printer"

IF !loRes.OpenQuery(lcSql) THEN
	MESSAGEBOX(loRes.Error_Message, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

SELECT cur_printer
IF RECCOUNT("cur_printer") > 0 THEN
	Thisform.rto_printer = ALLTRIM(cur_printer.impresora)
	Thisform.rto_cantcpias = cur_printer.copias
ELSE
	MESSAGEBOX("El remito no tiene impresora configurada", 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

loRes.Close_Query()

&& Actualizo el numero de remito
goConn.BeginTransaction()
lcSql = "UPDATE numerador "
lcSql = lcSql + "SET numActual = " + ALLTRIM(STR(lnNro)) + " "
lcSql = lcSql + "WHERE idNum = " + ALLTRIM(STR(lnIdNum))

loCommand.ActiveConnection = goConn.ActiveConnection
loCommand.CommandText = lcSql

IF !loCommand.Execute() THEN
	goConn.Rollback()
	MESSAGEBOX(loCommand.Error_Message, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

goConn.Commit()

RETURN .T.
ENDPROC
PROCEDURE validar_cbte
LOCAL loRes
LOCAL lcSql

loRes = CREATEOBJECT("odbc_result")
lcSql = "SELECT aut_Resultado "
lcSql = lcSql + "FROM ventascab "
lcSql = lcSql + "WHERE ventascab.idVentasC = " + ALLTRIM(STR(cur_CbtePendi.idVentasC))
loRes.ActiveConnection = goConn.ActiveConnection
loRes.Cursor_Name = "cur_x"
IF !loRes.OpenQuery(lcSql) THEN
	MESSAGEBOX(loRes.Error_Message, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

SELECT cur_x
IF ALLTRIM(cur_x.aut_Resultado) == "A" THEN
	loRes.Close_Query()
	RETURN .F.
ENDIF

loRes.Close_Query()
RETURN .T.
ENDPROC
PROCEDURE grabar_ctacte
PARAMETERS tnIdVentasC

LOCAL loCommand
LOCAL loRes
LOCAL oDT
LOCAL lcSql
LOCAL lnIdCliente, lcCbte, lnNroCbte, lcTipoDoc, lnPtoVta, lnIdCondPago
LOCAL lnIdSitIVA, lnIdVendedor, ldFecVto, lnTotFact, lnIdOper
LOCAL lcObserv, lnIdCC_CliOrig
LOCAL lnIdOper

loCommand = CREATEOBJECT("odbc_command")
loRes = CREATEOBJECT("odbc_result")
oDT = CREATEOBJECT("datetime")
lcSql = ""
lnIdCliente = 0
lcCbte = ""
lnNroCbte = 0
lcTipoDoc = ""
lnPtoVta = 0
lnIdCondPago = 0
lnIdSitIVA = 0
lnIdVendedor = 0
ldFecVto = {}
lnTotFact = 0.00
lnIdOper = 0
lcObserv = ""
lnIdCC_CliOrig = 0
lnIdOper = 0

lcSql = "SELECT * "
lcSql = lcSql + "FROM ventascab "
lcSql = lcSql + "WHERE ventascab.idVentasC = " + ALLTRIM(STR(tnIdVentasC))
loRes.ActiveConnection = goConn.ActiveConnection
loRes.Cursor_Name = "cur_vtas"

IF !loRes.OpenQuery(lcSql) THEN
	MESSAGEBOX(loRes.Error_Message, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

SELECT cur_vtas
IF RECCOUNT("cur_vtas") > 0 THEN
	lnIdCliente = cur_vtas.idCliente
	lcCbte = cur_vtas.cbte
	lnNroCbte = cur_vtas.numCbte
	lcTipoDoc = cur_vtas.tipoDoc
	lnPtoVta = cur_vtas.ptoVta
	lnIdCondPago = cur_vtas.idCondPago
	lnIdSitIVA = cur_vtas.idSitIVA
	lnIdVendedor = cur_vtas.idVendedor
	ldFecVto = cur_vtas.fecVto
	lnTotFact = cur_vtas.totFact
	*lnIdCC_CliOrig = cur_vtas.idCC_CliO
ENDIF

loRes.Close_Query()

lnProxID = goConn.GetNextId("cc_cli", "idCC_Cli")

DO CASE
	CASE ALLTRIM(lcCbte) == "FC"
		lnIdOper = goConn.GetNextID("cc_cli", "idOper")
		
		lcSql = "INSERT INTO cc_cli ("
		lcSql = lcSql + "idCC_Cli, "
		lcSql = lcSql + "idCliente, "
		lcSql = lcSql + "idCC_Orig, "
		lcSql = lcSql + "idVentasC, "
		lcSql = lcSql + "cbte, "
		lcSql = lcSql + "tipoDoc, "
		lcSql = lcSql + "ptoVta, "
		lcSql = lcSql + "nroCbte, "
		lcSql = lcSql + "fecEmis, "
		lcSql = lcSql + "fecVto, "
		lcSql = lcSql + "idCondPago, "
		lcSql = lcSql + "idSitIVA, "
		lcSql = lcSql + "idVendedor, "
		lcSql = lcSql + "impDebe, "
		lcSql = lcSql + "impHaber, "
		lcSql = lcSql + "idOper, "
		lcSql = lcSql + "observ, "
		lcSql = lcSql + "usuAlta, "
		lcSql = lcSql + "fecAlta, "
		lcSql = lcSql + "idHostAlta) "
		lcSql = lcSql + "VALUES ("
		lcSql = lcSql + ALLTRIM(STR(lnProxID)) + ", " + ;
				ALLTRIM(STR(lnIdCliente)) + ;
				", null, " + ;
				ALLTRIM(STR(tnIdVentasC)) + ", " + ;
				"'" + ALLTRIM(lcCbte) + "', " + ;
				"'" + ALLTRIM(lcTipoDoc) + "', " + ;
				ALLTRIM(STR(lnPtoVta)) + ", " + ;
				ALLTRIM(STR(lnNroCbte)) + ", " + ;
				oDT.getDateTime() + ", " + ;
				oDT.toMySql(ldFecVto) + ", " + ; 
				ALLTRIM(STR(lnIdCondPago)) + ", " + ;
				ALLTRIM(STR(lnIdSitIVA)) + ", " + ;
				ALLTRIM(STR(lnIdVendedor)) + ", " + ;
				ALLTRIM(STR(lnTotFact, 10, 2)) + ", " + ;
				"0, " + ;
				ALLTRIM(STR(lnIdOper)) + ", " + ;
				"'" + ALLTRIM(lcObserv) + "', " + ;
				"'" + ALLTRIM(gcCodUsu) + "', " + ;
				oDT.getDateTime() + ", '" + ;
				ALLTRIM(SYS(0)) + "')"
	CASE ALLTRIM(lcCbte) == "NC"
		IF lnIdCC_CliOrig = 0 THEN
			lnIdOper = goConn.GetNextID("cc_cli", "idOper")

			lcSql = "SELECT ventascab.cbte, ventascab.tipoDoc, ventascab.ptoVta, ventascab.numCbte "
			lcSql = lcSql + "FROM ventascab "
			lcSql = lcSql + " INNER JOIN ventasrel ON ventasrel.idVtaCO = ventascab.idVentasC "
			lcSql = lcSql + "WHERE ventasrel.idVtaCD = " + ALLTRIM(STR(tnIdVentasC))
			loRes.ActiveConnection = goConn.ActiveConnection
			loRes.Cursor_Name = "cur_x"
			IF !loRes.OpenQuery(lcSql) THEN
				MESSAGEBOX(loRes.Error_Message, 0+48, Thisform.Caption)
				RETURN .F.
			ENDIF
			lcObserv = "Devolución de " + ALLTRIM(cur_x.cbte) + " " + ;
				ALLTRIM(cur_x.tipoDoc) + " " + REPLICATE("0", 4 - LEN(ALLTRIM(STR(cur_x.ptoVta)))) + ALLTRIM(STR(cur_x.ptovta)) + ;
				"-" + REPLICATE("0", 8 - LEN(ALLTRIM(STR(cur_x.numCbte)))) + ALLTRIM(STR(cur_x.numCbte))
			loRes.Close_Query()
			
			lcSql = "INSERT INTO cc_cli ("
			lcSql = lcSql + "idCC_Cli, "
			lcSql = lcSql + "idCliente, "
			lcSql = lcSql + "idCC_Orig, "
			lcSql = lcSql + "idVentasC, "
			lcSql = lcSql + "cbte, "
			lcSql = lcSql + "tipoDoc, "
			lcSql = lcSql + "ptoVta, "
			lcSql = lcSql + "nroCbte, "
			lcSql = lcSql + "fecEmis, "
			lcSql = lcSql + "fecVto, "
			lcSql = lcSql + "idCondPago, "
			lcSql = lcSql + "idSitIVA, "
			lcSql = lcSql + "idVendedor, "
			lcSql = lcSql + "impDebe, "
			lcSql = lcSql + "impHaber, "
			lcSql = lcSql + "idOper, "
			lcSql = lcSql + "observ, "
			lcSql = lcSql + "usuAlta, "
			lcSql = lcSql + "fecAlta, "
			lcSql = lcSql + "idHostAlta) "
			lcSql = lcSql + "VALUES ("
			lcSql = lcSql + ALLTRIM(STR(lnProxID)) + ", " + ;
					ALLTRIM(STR(lnIdCliente)) + ;
					", null, " + ;
					ALLTRIM(STR(tnIdVentasC)) + ", " + ;
					"'" + ALLTRIM(lcCbte) + "', " + ;
					"'" + ALLTRIM(lcTipoDoc) + "', " + ;
					ALLTRIM(STR(lnPtoVta)) + ", " + ;
					ALLTRIM(STR(lnNroCbte)) + ", " + ;
					oDT.getDateTime() + ", " + ;
					oDT.toMySql(ldFecVto) + ", " + ; 
					ALLTRIM(STR(lnIdCondPago)) + ", " + ;
					ALLTRIM(STR(lnIdSitIVA)) + ", " + ;
					ALLTRIM(STR(lnIdVendedor)) + ", " + ;
					"0, " + ;
					ALLTRIM(STR(lnTotFact, 10, 2)) + ", " + ;
					ALLTRIM(STR(lnIdOper)) + ", " + ;
					"'" + ALLTRIM(lcObserv) + "', " + ;
					"'" + ALLTRIM(gcCodUsu) + "', " + ;
					oDT.getDateTime() + ", '" + ;
					ALLTRIM(SYS(0)) + "')"
		ELSE
			lcSql = "SELECT idOper "
			lcSql = lcSql + "FROM cc_cli "
			lcSql = lcSql + "WHERE cc_cli.idCC_Cli = " + ALLTRIM(STR(lnIdCC_CliOrig))
			loRes.ActiveConnection = goConn.ActiveConnection
			loRes.Cursor_Name = "cur_x"
			IF !loRes.OpenQuery(lcSql) THEN
				MESSAGEBOX(loRes.Error_Message, 0+48, Thisform.Caption)
				RETURN .F.
			ENDIF
			SELECT cur_x
			lnIDOper = cur_x.idOper
			loRes.Close_Query()
			
			lcSql = "INSERT INTO cc_cli ("
			lcSql = lcSql + "idCC_Cli, "
			lcSql = lcSql + "idCliente, "
			lcSql = lcSql + "idCC_Orig, "
			lcSql = lcSql + "idVentasC, "
			lcSql = lcSql + "cbte, "
			lcSql = lcSql + "tipoDoc, "
			lcSql = lcSql + "ptoVta, "
			lcSql = lcSql + "nroCbte, "
			lcSql = lcSql + "fecEmis, "
			lcSql = lcSql + "fecVto, "
			lcSql = lcSql + "idCondPago, "
			lcSql = lcSql + "idSitIVA, "
			lcSql = lcSql + "idVendedor, "
			lcSql = lcSql + "impDebe, "
			lcSql = lcSql + "impHaber, "
			lcSql = lcSql + "idOper, "
			lcSql = lcSql + "observ, "
			lcSql = lcSql + "usuAlta, "
			lcSql = lcSql + "fecAlta, "
			lcSql = lcSql + "idHostAlta) "
			lcSql = lcSql + "VALUES ("
			lcSql = lcSql + ALLTRIM(STR(lnProxID)) + ", " + ;
					ALLTRIM(STR(lnIdCliente)) + ;
					", null, " + ;
					ALLTRIM(STR(tnIdVentasC)) + ", " + ;
					"'" + ALLTRIM(lcCbte) + "', " + ;
					"'" + ALLTRIM(lcTipoDoc) + "', " + ;
					ALLTRIM(STR(lnPtoVta)) + ", " + ;
					ALLTRIM(STR(lnNroCbte)) + ", " + ;
					oDT.getDateTime() + ", " + ;
					oDT.toMySql(ldFecVto) + ", " + ; 
					ALLTRIM(STR(lnIdCondPago)) + ", " + ;
					ALLTRIM(STR(lnIdSitIVA)) + ", " + ;
					ALLTRIM(STR(lnIdVendedor)) + ", " + ;
					"0, " + ;
					ALLTRIM(STR(lnTotFact, 10, 2)) + ", " + ;
					ALLTRIM(STR(lnIdOper)) + ", " + ;
					"'" + ALLTRIM(lcObserv) + "', " + ;
					"'" + ALLTRIM(gcCodUsu) + "', " + ;
					oDT.getDateTime() + ", '" + ;
					ALLTRIM(SYS(0)) + "')"
		ENDIF
	CASE ALLTRIM(lcCbte) == "ND"
		IF lnIdCC_CliOrig = 0 THEN
			lnIdOper = goConn.GetNextID("cc_cli", "idOper")

			lcSql = "SELECT ventascab.cbte, ventascab.tipoDoc, ventascab.ptoVta, ventascab.numCbte "
			lcSql = lcSql + "FROM ventascab "
			lcSql = lcSql + " INNER JOIN ventasrel ON ventasrel.idVtaCO = ventascab.idVentasC "
			lcSql = lcSql + "WHERE ventasrel.idVtaCD = " + ALLTRIM(STR(tnIdVentasC))
			loRes.ActiveConnection = goConn.ActiveConnection
			loRes.Cursor_Name = "cur_x"
			IF !loRes.OpenQuery(lcSql) THEN
				MESSAGEBOX(loRes.Error_Message, 0+48, Thisform.Caption)
				RETURN .F.
			ENDIF
			lcObserv = "Devolución de " + ALLTRIM(cur_x.cbte) + " " + ;
				ALLTRIM(cur_x.tipoDoc) + " " + REPLICATE("0", 4 - LEN(ALLTRIM(STR(cur_x.ptoVta)))) + ALLTRIM(STR(cur_x.ptovta)) + ;
				"-" + REPLICATE("0", 8 - LEN(ALLTRIM(STR(cur_x.numCbte)))) + ALLTRIM(STR(cur_x.numCbte))
			loRes.Close_Query()
		
			lcSql = "INSERT INTO cc_cli ("
			lcSql = lcSql + "idCC_Cli, "
			lcSql = lcSql + "idCliente, "
			lcSql = lcSql + "idCC_Orig, "
			lcSql = lcSql + "idVentasC, "
			lcSql = lcSql + "cbte, "
			lcSql = lcSql + "tipoDoc, "
			lcSql = lcSql + "ptoVta, "
			lcSql = lcSql + "nroCbte, "
			lcSql = lcSql + "fecEmis, "
			lcSql = lcSql + "fecVto, "
			lcSql = lcSql + "idCondPago, "
			lcSql = lcSql + "idSitIVA, "
			lcSql = lcSql + "idVendedor, "
			lcSql = lcSql + "impDebe, "
			lcSql = lcSql + "impHaber, "
			lcSql = lcSql + "idOper, "
			lcSql = lcSql + "observ, "
			lcSql = lcSql + "usuAlta, "
			lcSql = lcSql + "fecAlta, "
			lcSql = lcSql + "idHostAlta) "
			lcSql = lcSql + "VALUES ("
			lcSql = lcSql + ALLTRIM(STR(lnProxID)) + ", " + ;
					ALLTRIM(STR(lnIdCliente)) + ;
					", null, " + ;
					ALLTRIM(STR(tnIdVentasC)) + ", " + ;
					"'" + ALLTRIM(lcCbte) + "', " + ;
					"'" + ALLTRIM(lcTipoDoc) + "', " + ;
					ALLTRIM(STR(lnPtoVta)) + ", " + ;
					ALLTRIM(STR(lnNroCbte)) + ", " + ;
					oDT.getDateTime() + ", " + ;
					oDT.toMySql(ldFecVto) + ", " + ; 
					ALLTRIM(STR(lnIdCondPago)) + ", " + ;
					ALLTRIM(STR(lnIdSitIVA)) + ", " + ;
					ALLTRIM(STR(lnIdVendedor)) + ", " + ;
					ALLTRIM(STR(lnTotFact, 10, 2)) + ", " + ;
					"0, " + ;
					ALLTRIM(STR(lnIdOper)) + ", " + ;
					"'" + ALLTRIM(lcObserv) + "', " + ;
					"'" + ALLTRIM(gcCodUsu) + "', " + ;
					oDT.getDateTime() + ", '" + ;
					ALLTRIM(SYS(0)) + "')"
		ELSE
			lcSql = "SELECT idOper "
			lcSql = lcSql + "FROM cc_cli "
			lcSql = lcSql + "WHERE cc_cli.idCC_Cli = " + ALLTRIM(STR(lnIdCC_CliOrig))
			loRes.ActiveConnection = goConn.ActiveConnection
			loRes.Cursor_Name = "cur_x"
			IF !loRes.OpenQuery(lcSql) THEN
				MESSAGEBOX(loRes.Error_Message, 0+48, Thisform.Caption)
				RETURN .F.
			ENDIF
			SELECT cur_x
			lnIDOper = cur_x.idOper
			loRes.Close_Query()
		
			lcSql = "INSERT INTO cc_cli ("
			lcSql = lcSql + "idCC_Cli, "
			lcSql = lcSql + "idCliente, "
			lcSql = lcSql + "idCC_Orig, "
			lcSql = lcSql + "idVentasC, "
			lcSql = lcSql + "cbte, "
			lcSql = lcSql + "tipoDoc, "
			lcSql = lcSql + "ptoVta, "
			lcSql = lcSql + "nroCbte, "
			lcSql = lcSql + "fecEmis, "
			lcSql = lcSql + "fecVto, "
			lcSql = lcSql + "idCondPago, "
			lcSql = lcSql + "idSitIVA, "
			lcSql = lcSql + "idVendedor, "
			lcSql = lcSql + "impDebe, "
			lcSql = lcSql + "impHaber, "
			lcSql = lcSql + "idOper, "
			lcSql = lcSql + "observ, "
			lcSql = lcSql + "usuAlta, "
			lcSql = lcSql + "fecAlta, "
			lcSql = lcSql + "idHostAlta) "
			lcSql = lcSql + "VALUES ("
			lcSql = lcSql + ALLTRIM(STR(lnProxID)) + ", " + ;
					ALLTRIM(STR(lnIdCliente)) + ;
					", null, " + ;
					ALLTRIM(STR(tnIdVentasC)) + ", " + ;
					"'" + ALLTRIM(lcCbte) + "', " + ;
					"'" + ALLTRIM(lcTipoDoc) + "', " + ;
					ALLTRIM(STR(lnPtoVta)) + ", " + ;
					ALLTRIM(STR(lnNroCbte)) + ", " + ;
					oDT.getDateTime() + ", " + ;
					oDT.toMySql(ldFecVto) + ", " + ; 
					ALLTRIM(STR(lnIdCondPago)) + ", " + ;
					ALLTRIM(STR(lnIdSitIVA)) + ", " + ;
					ALLTRIM(STR(lnIdVendedor)) + ", " + ;
					ALLTRIM(STR(lnTotFact, 10, 2)) + ", " + ;
					"0, " + ;
					ALLTRIM(STR(lnIdOper)) + ", " + ;
					"'" + ALLTRIM(lcObserv) + "', " + ;
					"'" + ALLTRIM(gcCodUsu) + "', " + ;
					oDT.getDateTime() + ", '" + ;
					ALLTRIM(SYS(0)) + "')"
		ENDIF
ENDCASE

IF ALLTRIM(lcCbte) == "FC" .OR. ALLTRIM(lcCbte) == "ND" THEN
ELSE
ENDIF

goConn.BeginTransaction()

loCommand.ActiveConnection = goConn.ActiveConnection
loCommand.CommandText = lcSql

IF !loCommand.Execute()
	goConn.Rollback()
	RETURN .F.
ENDIF

goConn.Commit()
RETURN .T.
ENDPROC
PROCEDURE validardetalle
LOCAL loRes
LOCAL lcSql

loRes = CREATEOBJECT("odbc_result")

SELECT cur_CbtePendi
lcSql = "SELECT * "
lcSql = lcSql + "FROM ventascab "
lcSql = lcSql + "WHERE idVentasC = " + ALLTRIM(STR(cur_CbtePendi.idVentasC))
loRes.ActiveConnection = goConn.ActiveConnection
loRes.Cursor_Name = "cur_x"
IF !loRes.OpenQuery(lcSql) THEN
	MESSAGEBOX(loRes.ErrorMessage, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

IF ALLTRIM(cur_x.aut_Resultado) == 'A' THEN
	MESSAGEBOX("El comprobante ya se encuentra autorizado.", 0+48, thisform.Caption)
	RETURN .F.
ENDIF

loRes.Close_Query()

RETURN .T.
ENDPROC
PROCEDURE Init
Thisform.Contenido.grdCbtes.RecordSource = "cur_CbtePendi"
Thisform.Contenido.grdCbtes.Alias_name = "cur_CbtePendi"
Thisform.Contenido.grdCbtes.list_controlsource = "fecEmision,cbte,tipoDoc,ptoVta,numCbte,totFact,idCliente,razSoc"
Thisform.Contenido.grdCbtes.lista_ancho_cols = "100,70,70,70,100,70,70,250"
Thisform.Contenido.grdCbtes.titulos_cabeceras = "Fecha,Cbte,Letra,Pto Vta,Número,Total,Cliente,Raz. Social"
Thisform.Contenido.grdCbtes.generar_grid()

Thisform.leer_cbtes_pendi()
ENDPROC
PROCEDURE Load
DODEFAULT()

CREATE CURSOR cur_CbtePendi (;
	idVentasC	int,;
	fecEmision 	date,;
	cbte		varchar(3),;
	tipoDoc		varchar(1),;
	ptoVta		varchar(4),;
	numCbte		varchar(8),;
	totFact		float(10,2),;
	idCliente	int,;
	razSoc		varchar(60))
	

ENDPROC
PROCEDURE eliminar
LOCAL loCommand, lcSql, lnResp
LOCAL loRes, llTieneCC

loCommand = CREATEOBJECT("odbc_command")
loRes = CREATEOBJECT("odbc_result")
lcSql = ""
lnResp = 0
llTieneCC = .F.

lnResp = MESSAGEBOX("¿Está seguro que desea eliminar el comprobante?", 4+32, Thisform.Caption)
IF lnResp = 6 THEN
	goConn.BeginTransaction()
	
	&& Rastreo a ver si tiene algún registro vinculado en
	&& cuentas corrientes.
	SELECT cur_CbtePendi
	lcSql = "SELECT * FROM cc_cli WHERE idVentasC = " + ALLTRIM(STR(cur_CbtePendi.idVentasC))
	loRes.ActiveConnection = goConn.ActiveConnection
	loRes.Cursor_Name = "cur_ctacte"
	
	IF !loRes.OpenQuery(lcSql) THEN
		MESSAGEBOX(loRes.Error_Message, 0+48, Thisform.Caption)
		RETURN
	ENDIF
	
	IF RECCOUNT("cur_ctacte") > 0 THEN
		llTieneCC = .T.
	ENDIF
	
	loRes.Close_Query()
	
	IF llTieneCC THEN
		&& Procedo a la eliminación del comprobante
		lcSql = "UPDATE cc_cli "
		lcSql = lcSql + "SET cc_cli.usuBaja = '" + ALLTRIM(gcCodUsu) + "', "
		lcSql = lcSql + "	cc_cli.fecBaja = current_timestamp, "
		lcSql = lcSql + "	cc_cli.idHostBaja = '" + ALLTRIM(SYS(0)) + "' "
		lcSql = lcSql + "WHERE idVentasC = " + ALLTRIM(STR(cur_CbtePendi.idVentasC))
		
		loCommand.ActiveConnection = goConn.ActiveConnection
		loCommand.CommandText = lcSql
		
		IF !loCommand.Execute() THEN
			goConn.Rollback()
			MESSAGEBOX(loCommand.ErrorMessage, 0+48, Thisform.Caption)
			RETURN
		ENDIF
	ENDIF
	
	lcSql = "UPDATE ventascab "
	lcSql = lcSql + "SET ventascab.usuBaja = '" + ALLTRIM(gcCodUsu) + "', "
	lcSql = lcSql + "	ventascab.fecBaja = current_timestamp, "
	lcSql = lcSql + "	ventascab.idHostBaja = '" + ALLTRIM(SYS(0)) + "' "
	lcSql = lcSql + "WHERE ventascab.idVentasC = " + ALLTRIM(STR(cur_CbtePendi.idVentasC))
	
	loCommand.ActiveConnection = goConn.ActiveConnection
	loCommand.CommandText = lcSql
	
	IF !loCommand.Execute() THEN
		goConn.Rollback()
		MESSAGEBOX(loCommand.ErrorMessage, 0+48, Thisform.Caption)
		RETURN
	ENDIF
	
	&& Valido si el módulo de stock está o no habilitado
	IF getGlobalCFG("STK_MODULE") THEN
		Thisform.mov_stock.idVentasC = cur_CbtePendi.idVentasC
		IF !Thisform.mov_stock.dar_baja_byvta() THEN
			goConn.Rollback()
			MESSAGEBOX(Thisform.mov_stock.ErrorMessage, 0+48, Thisform.Caption)
			RETURN
		ENDIF
	ENDIF
	
	goConn.Commit()
	
	Thisform.leer_cbtes_pendi()
	SELECT cur_CbtePendi
	Thisform.Contenido.grdCbtes.Refresh()	
ENDIF


ENDPROC


************************************************************
OBJETO: fe
************************************************************
*** PROPIEDADES ***
Top = 531
Left = 593
Height = 24
Width = 36
Name = "fe"

*** METODOS ***


************************************************************
OBJETO: mov_stock
************************************************************
*** PROPIEDADES ***
Top = 540
Left = 111
Height = 17
Width = 29
Name = "mov_stock"

*** METODOS ***


************************************************************
OBJETO: grdCbtes
************************************************************
*** PROPIEDADES ***
Height = 496
Left = 18
TabIndex = 1
Top = 21
Width = 922
permitir_busqueda = .F.
permitir_ordenamiento = .F.
Name = "grdCbtes"
COLUMN1.Header1.Name = "Header1"
COLUMN1.Text1.Name = "Text1"
COLUMN1.Name = "COLUMN1"
COLUMN2.Header1.Name = "Header1"
COLUMN2.Text1.Name = "Text1"
COLUMN2.Name = "COLUMN2"
COLUMN3.Header1.Name = "Header1"
COLUMN3.Text1.Name = "Text1"
COLUMN3.Name = "COLUMN3"
COLUMN4.Header1.Name = "Header1"
COLUMN4.Text1.Name = "Text1"
COLUMN4.Name = "COLUMN4"
COLUMN5.Header1.Name = "Header1"
COLUMN5.Text1.Name = "Text1"
COLUMN5.Name = "COLUMN5"
COLUMN6.Header1.Name = "Header1"
COLUMN6.Text1.Name = "Text1"
COLUMN6.Name = "COLUMN6"
COLUMN7.Header1.Name = "Header1"
COLUMN7.Text1.Name = "Text1"
COLUMN7.Name = "COLUMN7"
COLUMN8.Header1.Name = "Header1"
COLUMN8.Text1.Name = "Text1"
COLUMN8.Name = "COLUMN8"
COLUMN9.Header1.Name = "Header1"
COLUMN9.Text1.Name = "Text1"
COLUMN9.Name = "COLUMN9"
COLUMN10.Header1.Name = "Header1"
COLUMN10.Text1.Name = "Text1"
COLUMN10.Name = "COLUMN10"
COLUMN11.Header1.Name = "Header1"
COLUMN11.Text1.Name = "Text1"
COLUMN11.Name = "COLUMN11"
COLUMN12.Header1.Name = "Header1"
COLUMN12.Text1.Name = "Text1"
COLUMN12.Name = "COLUMN12"
COLUMN13.Header1.Name = "Header1"
COLUMN13.Text1.Name = "Text1"
COLUMN13.Name = "COLUMN13"
COLUMN14.Header1.Name = "Header1"
COLUMN14.Text1.Name = "Text1"
COLUMN14.Name = "COLUMN14"
COLUMN15.Header1.Name = "Header1"
COLUMN15.Text1.Name = "Text1"
COLUMN15.Name = "COLUMN15"
COLUMN16.Header1.Name = "Header1"
COLUMN16.Text1.Name = "Text1"
COLUMN16.Name = "COLUMN16"
COLUMN17.Header1.Name = "Header1"
COLUMN17.Text1.Name = "Text1"
COLUMN17.Name = "COLUMN17"
COLUMN18.Header1.Name = "Header1"
COLUMN18.Text1.Name = "Text1"
COLUMN18.Name = "COLUMN18"
COLUMN19.Header1.Name = "Header1"
COLUMN19.Text1.Name = "Text1"
COLUMN19.Name = "COLUMN19"
COLUMN20.Header1.Name = "Header1"
COLUMN20.Text1.Name = "Text1"
COLUMN20.Name = "COLUMN20"

*** METODOS ***


************************************************************
OBJETO: btnAutorizar
************************************************************
*** PROPIEDADES ***
Top = 522
Left = 850
TabIndex = 2
Name = "btnAutorizar"

*** METODOS ***
PROCEDURE Click
IF thisform.validar_cbte() THEN
	SELECT cur_CbtePendi

	IF !thisform.corregir_iva() THEN
		RETURN
	ENDIF

	SELECT cur_CbtePendi

	WAIT WINDOW "Esperando respuesta de AFIP..." NOWAIT
	IF !Thisform.enviar_wsafipfe() THEN
		MESSAGEBOX("El comprobante no pudo ser autorizado, por favor intente mas tarde", 0+48, Thisform.Caption)
	ELSE
		IF Thisform.fe_set_cae() THEN
			IF !Thisform.grabar_ctacte(cur_CbtePendi.idVentasC) THEN
				MESSAGEBOX("Atención, por algún motivo no se ha generado el registro en la tabla de cuentas corrientes.", 0+48, Thisform.Caption)
				RETURN .F.
			ENDIF
		ENDIF
		Thisform.saldodeudor = 0.00
		Thisform.leer_cbtes_pendi()
	ENDIF

	MESSAGEBOX("El comprobante fué autorizado con éxito", 0+64, thisform.Caption)
ELSE
	MESSAGEBOX("El comprobante ya se encuentra autorizado", 0+64, thisform.Caption)
ENDIF
ENDPROC


************************************************************
OBJETO: btnCerrar
************************************************************
*** PROPIEDADES ***
Top = 522
Left = 897
TabIndex = 3
Name = "btnCerrar"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta1
************************************************************
*** PROPIEDADES ***
Caption = "Los siguientes comprobnates se encuentran pendientes de autorizar. Seleccione el que desee autorizar:"
Height = 15
Left = 20
Top = 7
Width = 593
TabIndex = 6
Name = "Clsetiqueta1"

*** METODOS ***


************************************************************
OBJETO: btnRefrescar
************************************************************
*** PROPIEDADES ***
Top = 522
Left = 803
TabIndex = 4
Name = "btnRefrescar"

*** METODOS ***
PROCEDURE Click
Thisform.leer_cbtes_pendi()
ENDPROC


************************************************************
OBJETO: btnEliminar
************************************************************
*** PROPIEDADES ***
Top = 522
Left = 723
TabIndex = 5
Name = "btnEliminar"

*** METODOS ***
PROCEDURE Click
IF !thisform.validar_cbte() THEN
	MESSAGEBOX("El comprobante no se puede eliminar por ya se encuentra autorizado", 0+64, thisform.Caption)
ELSE
	Thisform.eliminar()
ENDIF
ENDPROC


************************************************************
OBJETO: cls_form_wsafip_autoriza
************************************************************
*** PROPIEDADES ***
Arial, 0, 9, 5, 15, 12, 32, 3, 0
Arial, 1, 8, 5, 14, 11, 29, 3, 0

*** METODOS ***


************************************************************
OBJETO: frm_ncnd_cc_fe
************************************************************
*** PROPIEDADES ***
DoCreate = .T.
WindowState = 0
aut_numero = 
aut_cae = 
aut_cae_vto = 
aut_resultado = 
aut_motivo = 
id_ventasc = 0
envcbte = .F.
mailfc = 
printcbte = .F.
cli_idtipodoc = 0
Name = "frm_ncnd_cc_fe"
Clsetiqueta1.Name = "Clsetiqueta1"
Clsetiqueta2.Name = "Clsetiqueta2"
Clsetiqueta3.Name = "Clsetiqueta3"
txtOperacion.Name = "txtOperacion"
txtPtoVta.Name = "txtPtoVta"
TXTNROCBTE.Name = "TXTNROCBTE"
txtImporte.Name = "txtImporte"
Clsetiqueta4.Name = "Clsetiqueta4"
sel_Conceptos.txtCodigo.Name = "txtCodigo"
sel_Conceptos.txtDescripcion.Name = "txtDescripcion"
sel_Conceptos.Name = "sel_Conceptos"
Clsetiqueta5.Name = "Clsetiqueta5"
chkIVA21.Alignment = 0
chkIVA21.Name = "chkIVA21"
chkIVA105.Alignment = 0
chkIVA105.Name = "chkIVA105"
Clsetiqueta6.Name = "Clsetiqueta6"
txtImporteNeto.Name = "txtImporteNeto"
txtIVA21.Name = "txtIVA21"
txtIVA105.Name = "txtIVA105"
txtImpTotal.Name = "txtImpTotal"
btnAgregar.Name = "btnAgregar"
grdDetalle.COLUMN1.Header1.Name = "Header1"
grdDetalle.COLUMN1.Text1.Name = "Text1"
grdDetalle.COLUMN1.Name = "COLUMN1"
grdDetalle.COLUMN2.Header1.Name = "Header1"
grdDetalle.COLUMN2.Text1.Name = "Text1"
grdDetalle.COLUMN2.Name = "COLUMN2"
grdDetalle.COLUMN3.Header1.Name = "Header1"
grdDetalle.COLUMN3.Text1.Name = "Text1"
grdDetalle.COLUMN3.Name = "COLUMN3"
grdDetalle.COLUMN4.Header1.Name = "Header1"
grdDetalle.COLUMN4.Text1.Name = "Text1"
grdDetalle.COLUMN4.Name = "COLUMN4"
grdDetalle.COLUMN5.Header1.Name = "Header1"
grdDetalle.COLUMN5.Text1.Name = "Text1"
grdDetalle.COLUMN5.Name = "COLUMN5"
grdDetalle.COLUMN6.Header1.Name = "Header1"
grdDetalle.COLUMN6.Text1.Name = "Text1"
grdDetalle.COLUMN6.Name = "COLUMN6"
grdDetalle.COLUMN7.Header1.Name = "Header1"
grdDetalle.COLUMN7.Text1.Name = "Text1"
grdDetalle.COLUMN7.Name = "COLUMN7"
grdDetalle.COLUMN8.Header1.Name = "Header1"
grdDetalle.COLUMN8.Text1.Name = "Text1"
grdDetalle.COLUMN8.Name = "COLUMN8"
grdDetalle.COLUMN9.Header1.Name = "Header1"
grdDetalle.COLUMN9.Text1.Name = "Text1"
grdDetalle.COLUMN9.Name = "COLUMN9"
grdDetalle.COLUMN10.Header1.Name = "Header1"
grdDetalle.COLUMN10.Text1.Name = "Text1"
grdDetalle.COLUMN10.Name = "COLUMN10"
grdDetalle.COLUMN11.Header1.Name = "Header1"
grdDetalle.COLUMN11.Text1.Name = "Text1"
grdDetalle.COLUMN11.Name = "COLUMN11"
grdDetalle.COLUMN12.Header1.Name = "Header1"
grdDetalle.COLUMN12.Text1.Name = "Text1"
grdDetalle.COLUMN12.Name = "COLUMN12"
grdDetalle.COLUMN13.Header1.Name = "Header1"
grdDetalle.COLUMN13.Text1.Name = "Text1"
grdDetalle.COLUMN13.Name = "COLUMN13"
grdDetalle.COLUMN14.Header1.Name = "Header1"
grdDetalle.COLUMN14.Text1.Name = "Text1"
grdDetalle.COLUMN14.Name = "COLUMN14"
grdDetalle.COLUMN15.Header1.Name = "Header1"
grdDetalle.COLUMN15.Text1.Name = "Text1"
grdDetalle.COLUMN15.Name = "COLUMN15"
grdDetalle.COLUMN16.Header1.Name = "Header1"
grdDetalle.COLUMN16.Text1.Name = "Text1"
grdDetalle.COLUMN16.Name = "COLUMN16"
grdDetalle.COLUMN17.Header1.Name = "Header1"
grdDetalle.COLUMN17.Text1.Name = "Text1"
grdDetalle.COLUMN17.Name = "COLUMN17"
grdDetalle.COLUMN18.Header1.Name = "Header1"
grdDetalle.COLUMN18.Text1.Name = "Text1"
grdDetalle.COLUMN18.Name = "COLUMN18"
grdDetalle.COLUMN19.Header1.Name = "Header1"
grdDetalle.COLUMN19.Text1.Name = "Text1"
grdDetalle.COLUMN19.Name = "COLUMN19"
grdDetalle.COLUMN20.Header1.Name = "Header1"
grdDetalle.COLUMN20.Text1.Name = "Text1"
grdDetalle.COLUMN20.Name = "COLUMN20"
grdDetalle.Name = "grdDetalle"
SUBTOTAL.Name = "SUBTOTAL"
txtSubTotal.Name = "txtSubTotal"
Clsetiqueta9.Name = "Clsetiqueta9"
txtTotal.Name = "txtTotal"
btnGrabar.Name = "btnGrabar"
BTNCERRAR.Name = "BTNCERRAR"
Clsetiqueta10.Name = "Clsetiqueta10"
Sel_Banco.txtCodigo.Name = "txtCodigo"
Sel_Banco.txtDescripcion.Name = "txtDescripcion"
Sel_Banco.Name = "Sel_Banco"
Clsetiqueta11.Name = "Clsetiqueta11"
txtNroCheque.Name = "txtNroCheque"
Clsetiqueta12.Name = "Clsetiqueta12"
Clsetiqueta13.Name = "Clsetiqueta13"
txtPorIVA21.Name = "txtPorIVA21"
txtPorIVA105.Name = "txtPorIVA105"
txtImpIVA21.Name = "txtImpIVA21"
txtImpIVA105.Name = "txtImpIVA105"
Clsetiqueta18.Name = "Clsetiqueta18"
txtPorIIBB.Name = "txtPorIIBB"
txtImpIIBB.Name = "txtImpIIBB"
clsdelete.Name = "clsdelete"
Clsetiqueta7.Name = "Clsetiqueta7"
txtObserv.Name = "txtObserv"

*** METODOS ***
PROCEDURE fe_convertir_tipodoc
PARAMETERS tcTipoDoc
LOCAL lnResultado

lnResultado = 99 && Código que corresponde a sin identificación en el diccionario

DO CASE
	CASE ALLTRIM(tcTipoDoc) == "CUIT"
		lnResultado = 80
	CASE ALLTRIM(tcTipoDoc) == "CUIL"
		lnResultado = 86
	CASE ALLTRIM(tcTipoDoc) == "CI"
		lnResultado = 87
	CASE ALLTRIM(tcTipoDoc) == "LE"
		lnResultado = 89
	CASE ALLTRIM(tcTipoDoc) == "LC"
		lnResultado = 90
	CASE ALLTRIM(tcTipoDoc) == "CIE"
		lnResultado = 91
	CASE ALLTRIM(tcTipoDoc) == "PAS"
		lnResultado = 94
	CASE ALLTRIM(tcTipoDoc) == "DNI"
		lnResultado = 96
ENDCASE

RETURN lnResultado
ENDPROC
PROCEDURE fe_get_tipocbte_afip
PARAMETERS tc_letra

DO CASE
	CASE ALLTRIM(thisform.cbte) == "FC"
		DO CASE
			CASE ALLTRIM(tc_letra) == "A"
				RETURN 1
			CASE ALLTRIM(tc_letra) == "B"
				RETURN 6
			CASE ALLTRIM(tc_letra) == "C" 
				RETURN 11
		ENDCASE
	CASE ALLTRIM(thisform.cbte) == "ND"
		DO CASE
			CASE ALLTRIM(tc_letra) == "A"
				RETURN 2
			CASE ALLTRIM(tc_letra) == "B"
				RETURN 7
			CASE ALLTRIM(tc_letra) == "C"
				RETURN 12
		ENDCASE
	CASE ALLTRIM(thisform.cbte) == "NC"
		DO CASE
			CASE ALLTRIM(tc_letra) == "A"
				RETURN 3
			CASE ALLTRIM(tc_letra) == "B"
				RETURN 8
			CASE ALLTRIM(tc_letra) == "C"
				RETURN 13
		ENDCASE	
ENDCASE

RETURN -1

ENDPROC
PROCEDURE fe_set_cae
LOCAL loCommand, lcSql
LOCAL loDT, ldFecVto
LOCAL lcAnio, lcMes, lcDia

loDT = CREATEOBJECT("datetime")
loCommand = CREATEOBJECT("odbc_command")
lcSql = ""

lcAnio = SUBSTR(Thisform.aut_cae_vto, 1, 4)
lcMes = SUBSTR(Thisform.aut_cae_vto, 5, 2)
lcDia = SUBSTR(Thisform.aut_cae_vto, 7, 2)

lcSql = "update ventascab "
lcSql = lcSql + "set "
lcSql = lcSql + "	ptoVta = " + ALLTRIM(STR(Thisform.ptovta)) + ", "
lcSql = lcSql + "	numCbte = " + ALLTRIM(STR(Thisform.nrocbte)) + ", "
lcSql = lcSql + "	aut_CAE = '" + ALLTRIM(Thisform.aut_cae) + "', "
lcSql = lcSql + "	aut_CAE_vto = " + loDT.toMySql(CTOD(lcDia + "/" + lcMes + "/" + lcAnio)) + ", "
lcSql = lcSql + "	aut_Resultado = '" + ALLTRIM(Thisform.aut_resultado) + "', "
lcSql = lcSql + "	aut_Motivo = '" + ALLTRIM(Thisform.aut_motivo) + "', "
lcSql = lcsql + "	aut_tipoCbte = '" + REPLICATE("0", 2 - LEN(ALLTRIM(STR(Thisform.fe.F1CabeceraCbteTipo)))) + ALLTRIM(STR(Thisform.fe.F1CabeceraCbteTipo)) + "' "
lcSql = lcSql + "where idVentasC = " + ALLTRIM(STR(Thisform.id_ventasc))

goConn.BeginTransaction()

loCommand.ActiveConnection = goConn.ActiveConnection
loCommand.CommandText = lcSql

IF !loCommand.Execute() THEN
	goConn.Rollback()
	MESSAGEBOX(loCommand.ErrorMessage, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

lcSql = "update cc_cli set nroCbte = " + ALLTRIM(STR(Thisform.nrocbte)) + " "
lcSql = lcSql + "WHERE idVentasC = " + ALLTRIM(STR(Thisform.id_ventasc))

loCommand.ActiveConnection = goConn.ActiveConnection
loCommand.CommandText = lcSql

IF !loCommand.Execute() THEN
	goConn.Rollback()
	MESSAGEBOX(loCommand.ErrorMessage, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

goConn.Commit()

RETURN .T.


ENDPROC
PROCEDURE enviar_wsafipfe
LOCAL llRes
LOCAL lnPtoVta
LOCAL lcTipoDoc
LOCAL lnRetAlva
LOCAL lnCantIVA 
LOCAL lnImpBase21
LOCAL lnImpBase105
LOCAL lcNumero 
LOCAL lcMensaje
LOCAL lnModo
LOCAL lnTotalIVA
LOCAL lnImpBaseSIVA
LOCAL lnIndice

lcTipoDoc = ""
lnPtoVta = INT(VAL(getConfig("PTOVTA")))
lnRetAlva = 0
lnCantIVA = 0
lnImpBase21 = 0
lnImpBase105 = 0
lnImpBaseSIVA = 0
lcNumero = ""
lcMensaje = ""
lnTotalIVA = 0.00
lnIndice = 0

lcTipoDoc = Thisform.tipodocref

lnModo = IIF(getGlobalCFG("FEDEBUG"), 0, 1)
llRes = Thisform.fe.iniciar(lnModo, getGlobalCFG("FECUIT"), SYS(5) + SYS(2003) + "\wsafip\" + getGlobalCFG("FE_FILE"), ALLTRIM(getGlobalCFG("FE_LIC")))

IF !llRes THEN
	MESSAGEBOX("Falló al iniciar: " + Thisform.fe.ultimoMensajeError, 0+32, Thisform.Caption)
	RETURN .F.
ENDIF

Thisform.fe.ArchivoCertificadoPassWord = ALLTRIM(getGlobalCFG("FE_PWD"))
IF !Thisform.ticket_valido() THEN
	MESSAGEBOX("No se pudo generar Ticket de Acceso", 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

Thisform.fe.ArchivoXMLRecibido = SYS(5) + SYS(2003) + "\wsafip\xml\rec_" + ALLTRIM(STR(YEAR(DATETIME()))) + ;
	ALLTRIM(STR(MONTH(DATETIME()))) + ALLTRIM(STR(DAY(DATETIME()))) + ALLTRIM(STR(HOUR(DATETIME()))) + ;
	ALLTRIM(STR(MINUTE(DATETIME()))) + ALLTRIM(STR(SEC(DATETIME()))) + ".xml"
	
Thisform.fe.archivoXMLEnviado = SYS(5) + SYS(2003) + "\wsafip\xml\env_" + ALLTRIM(STR(YEAR(DATETIME()))) + ;
	ALLTRIM(STR(MONTH(DATETIME()))) + ALLTRIM(STR(DAY(DATETIME()))) + ALLTRIM(STR(HOUR(DATETIME()))) + ;
	ALLTRIM(STR(MINUTE(DATETIME()))) + ALLTRIM(STR(SEC(DATETIME()))) + ".xml"

lnRetAlva = Thisform.fe.f1CompUltimoAutorizado(lnPtoVta, Thisform.fe_get_tipocbte_afip(ALLTRIM(lcTipoDoc)))

Thisform.fe.F1CabeceraCantReg = 1
Thisform.fe.F1CabeceraPtoVta = lnPtoVta
Thisform.fe.F1CabeceraCbteTipo = Thisform.fe_get_tipocbte_afip(ALLTRIM(lcTipoDoc))
Thisform.fe.F1DetalleDocTipo = Thisform.fe_convertir_tipodoc(Thisform.cli_tipodoc)
Thisform.fe.F1DetalleDocNro = Thisform.cli_cuit
Thisform.fe.F1DetalleCbteDesde = lnRetAlva + 1
Thisform.fe.F1DetalleCbteHasta = lnRetAlva + 1

Thisform.fe.F1DetalleCbteFch = ALLTRIM(STR(YEAR(DATE()))) + IIF(LEN(ALLTRIM(STR(MONTH(DATE())))) < 2, "0" + ALLTRIM(STR(MONTH(DATE()))), ALLTRIM(STR(MONTH(DATE())))) + ;
	IIF(LEN(ALLTRIM(STR(DAY(DATE())))) < 2, "0" + ALLTRIM(STR(DAY(DATE()))), ALLTRIM(STR(DAY(DATE()))))

&& Tengo que calcular la suma del neto de los articulos con 21 de IVA y con el 10.5 de IVA por separado

SELECT vtadcp
GO TOP
DO WHILE !EOF("vtadcp")
	IF vtadcp.ivaPor = 21 THEN
		lnImpBase21 = lnImpBase21 + vtadcp.impNeto		
	ENDIF
	
	IF vtadcp.ivaPor = 10.5 THEN
		lnImpBase105 = lnImpBase105 + vtadcp.impNeto
	ENDIF
	
	IF vtadcp.ivaPor = 0 THEN
		lnImpBaseSIVA = lnImpBaseSIVA + vtadcp.impNeto
	ENDIF

	SELECT vtadcp
	SKIP
ENDDO

lnIndice = 0
lnTotalIVA = 0.00
IF lnImpBase21 <> 0 THEN
	Thisform.fe.F1DetalleIvaItemCantidad = 1
	Thisform.fe.f1IndiceItem = lnIndice
	Thisform.fe.F1DetalleIvaId = 5
	Thisform.fe.F1DetalleIvaBaseImp = ROUND(lnImpBase21, 2)
	Thisform.fe.F1DetalleIvaImporte = Thisform.txtImpIVA21.Value
	lnTotalIVA = lnTotalIVA + Thisform.txtImpIVA21.Value
	lnIndice = lnIndice + 1
ENDIF

IF lnImpBase105 <> 0 THEN
	Thisform.fe.F1DetalleIvaItemCantidad = Thisform.fe.F1DetalleIvaItemCantidad + 1
	Thisform.fe.f1IndiceItem = lnIndice
	Thisform.fe.F1DetalleIvaId = 4
	Thisform.fe.F1DetalleIvaBaseImp = ROUND(lnImpBase105, 2)
	Thisform.fe.F1DetalleIvaImporte = Thisform.txtImpIVA105.Value
	lnTotalIVA = lnTotalIVA + Thisform.txtImpIVA105.Value
	lnIndice = lnIndice + 1	
ENDIF

IF lnImpBaseSIVA <> 0 THEN
	Thisform.fe.F1DetalleIvaItemCantidad = Thisform.fe.F1DetalleIvaItemCantidad + 1
	Thisform.fe.f1IndiceItem = lnIndice
	Thisform.fe.F1DetalleIvaId = 3
	Thisform.fe.F1DetalleIvaBaseImp = ROUND(lnImpBaseSIVA, 2)
ENDIF

&& Agrego los conceptos de IIBB

IF Thisform.txtPorIIBB.Value <> 0 THEN
	Thisform.FE.F1DetalleTributoItemCantidad = 1
	Thisform.FE.f1IndiceItem   = 0
	Thisform.FE.F1DetalleTributoId  = 2
	Thisform.FE.F1DetalleTributoDesc = "IIBB Pcia Bs AS"
	Thisform.FE.F1DetalleTributoBaseImp = Thisform.txtsubTotal.Value 
	Thisform.FE.F1DetalleTributoAlic = Thisform.txtPorIIBB.Value
	Thisform.FE.F1DetalleTributoImporte = Thisform.txtimpIIBB.Value 
ENDIF

Thisform.fe.F1DetalleConcepto = 1
Thisform.fe.F1DetalleImpNeto = ROUND(Thisform.txtSubTotal.Value, 2)
Thisform.fe.F1DetalleImpTotalConc = 0
Thisform.fe.F1DetalleImpIva = lnTotalIVA
Thisform.fe.F1DetalleImpOpEx = 0
Thisform.fe.F1DetalleImpTrib = Thisform.FE.F1DetalleTributoImporte
Thisform.fe.F1DetalleMonId = "PES"
Thisform.fe.F1DetalleMonCotiz = 1
Thisform.fe.F1DetalleImpTotal = Thisform.txtTotal.Value

llRes = Thisform.fe.f1CAESolicitar()

IF llRes THEN
	lcNumero = REPLICATE("0", 4 - LEN(ALLTRIM(STR(lnPtoVta)))) + ALLTRIM(STR(lnPtoVta)) + "-" + ;
		REPLICATE("0", 8 - LEN(ALLTRIM(STR(Thisform.fe.F1RespuestaDetalleCbteDesde)))) + ALLTRIM(STR(Thisform.fe.F1RespuestaDetalleCbteDesde))
	
	Thisform.ptovta = lnPtoVta
	Thisform.nrocbte = INT(VAL(Thisform.fe.F1RespuestaDetalleCbteDesdeS))
	
	lcMensaje = "CAE: " + Thisform.fe.F1RespuestaDetalleCae + CHR(13)+ CHR(10)
	lcMensaje = lcMensaje + "FECHA VTO: " + Thisform.fe.F1RespuestaDetalleCaeFchVto + CHR(13) + CHR(10)
	lcMensaje = lcMensaje + "MOTIVO: " + Thisform.fe.F1RespuestaDetalleObservacionMsg + CHR(13) + CHR(10)
	lcMensaje = lcMensaje + "PROCESO: " + Thisform.fe.F1RespuestaReProceso
	MESSAGEBOX(lcMensaje, 0+64, Thisform.Caption)
	
	Thisform.aut_numero = lcNumero
	Thisform.aut_cae = Thisform.fe.F1RespuestaDetalleCae
	Thisform.aut_cae_vto = Thisform.fe.F1RespuestaDetalleCaeFchVto
	Thisform.aut_resultado = Thisform.fe.F1RespuestaResultado
	Thisform.aut_motivo = Thisform.fe.F1RespuestaDetalleObservacionMsg
ELSE
	IF !(ISNULL(Thisform.fe.F1RespuestaReProceso) .OR. Thisform.fe.F1RespuestaReProceso == "R") THEN
		lcNumero = REPLICATE("0", 4 - LEN(ALLTRIM(STR(lnPtoVta)))) + ALLTRIM(STR(lnPtoVta)) + "-" + ;
			REPLICATE("0", 4 - LEN(ALLTRIM(STR(Thisform.fe.F1RespuestaDetalleCbteDesde)))) + ALLTRIM(STR(Thisform.fe.F1RespuestaDetalleCbteDesde))
		
		&& lcMensaje = "CAE: " + Thisform.fe.F1RespuestaDetalleCae + CHR(13)+ CHR(10)
		lcMensaje = "ATENCION: Factura rechazada por el AFIP" + CHR(13) + CHR(10)
		&&lcMensaje = lcMensaje + "FECHA VTO: " + Thisform.fe.F1RespuestaDetalleCaeFchVto + CHR(13) + CHR(10)		
		lcMensaje = lcMensaje + "MOTIVO: " + Thisform.fe.F1RespuestaDetalleObservacionMsg + CHR(13) + CHR(10)
		&&lcMensaje = lcMensaje + "PROCESO: " + Thisform.fe.F1RespuestaReProceso
		MESSAGEBOX(lcMensaje, 0+64, Thisform.Caption)
		MESSAGEBOX("Recomendación: Elimine este comprobante y vuelva a generarlo por favor.", 0+48, Thisform.Caption)
		
		Thisform.aut_numero = lcNumero
		Thisform.aut_cae = Thisform.fe.F1RespuestaDetalleCae
		Thisform.aut_cae_vto = Thisform.fe.F1RespuestaDetalleCaeFchVto
		Thisform.aut_resultado = Thisform.fe.F1RespuestaResultado
		Thisform.aut_motivo = Thisform.fe.F1RespuestaDetalleObservacionMsg
		RETURN .F.
	ELSE
		lcMensaje = "MOTIVO: " + Thisform.fe.F1RespuestaDetalleObservacionMsg + CHR(13) + CHR(10)
		lcMensaje = lcMensaje + "ERROR: " + Thisform.fe.f1ErrorMsg1 + CHR(13) + CHR(10)
		lcMensaje = lcMensaje + "ULTIMO: " + Thisform.fe.UltimoMensajeError
		MESSAGEBOX(lcMensaje, 0+64, Thisform.Caption)
		
		Thisform.aut_numero = lcNumero
		Thisform.aut_cae = ""
		Thisform.aut_cae_vto = ""
		Thisform.aut_resultado = Thisform.fe.F1RespuestaResultado
		Thisform.aut_motivo = Thisform.fe.F1RespuestaDetalleObservacionMsg
		RETURN .F.
	ENDIF
ENDIF

RETURN .T.
ENDPROC
PROCEDURE calc_digito_verificador
&& El prefijo E1, E2, En... indica a la etapa del algoritmo que pertenece el coeficiente

PARAMETERS tcCodigo

LOCAL lnDigito
LOCAL lnSumaE1
LOCAL lnSumaE3
LOCAL lnProductoE2
LOCAL lnSumaE4
LOCAL lnMin
LOCAL lnPos

lnDigito = 0
lnSumaE1 = 0
lnSumaE3 = 0
lnSumaE4 = 0
lnMin = 0

FOR i = 1 TO LEN(ALLTRIM(tcCodigo))
	lnDigito = INT(VAL(SUBSTR(tcCodigo, i, 1)))
	
	IF MOD(i, 2) <> 0 THEN
		&& Etapa 1 (posiciones impares)
		lnSumaE1 = lnSumaE1 + lnDigito
	ELSE
		&& Etapa 3 (posiciones pares)
		lnSumaE3 = lnSumaE3 + lnDigito
	ENDIF
NEXT i

lnProductoE2 = lnSumaE1 * 3 && Etapa 2
lnSumaE4 = lnProductoE2 + lnSumaE3 && Etapa 4

&& Etapa 5
lnPos = 0
FOR i = 1 TO LEN(ALLTRIM(tcCodigo))
	lnDigito = INT(VAL(SUBSTR(tcCodigo, i, 1)))
	
	IF MOD(lnSumaE4 + lnDigito, 10) = 0 THEN
		IF lnPos = 0 THEN
			lnMin = lnDigito
		ELSE
			IF lnDigito < lnMin THEN
				lnMin = lnDigito
			ENDIF
		ENDIF
		
		lnPos = lnPos + 1
	ENDIF
NEXT i

RETURN lnMin
ENDPROC
PROCEDURE ticket_valido
LOCAL llTkValido
LOCAL lcTicket
LOCAL lcFileTicket
LOCAL lcTK
LOCAL hndFile

llTkValido = .F.
lcTicket = ""
lcTK = ""
lcFileTicket = getGlobalCFG("FE_TICKACC")

IF FILE(ALLTRIM(lcFileTicket)) THEN
	hndFile = FOPEN(lcFileTicket, 12)
	IF hndFile < 0 THEN
		=MESSAGEBOX("Error al intentar leer el ticket de acceso", 0+48, Thisform.Caption)
		=FCLOSE(hndFile)
	ELSE
		=FCLOSE(hndFile)
		
		lcTK = FILETOSTR(ALLTRIM(lcFileTicket))
		Thisform.fe.f1RestaurarTicketAcceso(lcTK)
		
		IF Thisform.fe.f1TicketEsValido THEN
			llTkValido = .T.
		ELSE
			llTkValido = .F.
		ENDIF
	ENDIF
	
	IF !llTkValido THEN
		DELETE FILE ALLTRIM(lcFileTicket)
		
		IF Thisform.fe.f1ObtenerTicketAcceso() THEN
			lcTK = Thisform.fe.f1GuardarTicketAcceso()
			hndFile = FCREATE(lcFileTicket)
			
			IF hndFile < 0 THEN
				=MESSAGEBOX("Error al generar el archivo, por favor verifique la ruta se encuentre accesible", 0+16, Thisform.Caption)
			ELSE
				=FWRITE(hndFile, lcTK)
				llTkValido = .T.
			ENDIF
			
			=FCLOSE(hndFile)
		ELSE
			MESSAGEBOX("Fallo de acceso: " + ALLTRIM(Thisform.fe.ultimoMensajeError), 0+16, Thisform.Caption)
			llTkValido = .F.
		ENDIF
	ENDIF
ELSE
	IF Thisform.fe.f1ObtenerTicketAcceso() THEN
		lcTK = Thisform.fe.f1GuardarTicketAcceso()
		hndFile = FCREATE(lcFileTicket)
		
		IF hndFile < 0 THEN
			=MESSAGEBOX("Error al generar el archivo, por favor verifique la ruta se encuentre accesible", 0+48, Thisform.Caption)
		ELSE
			=FWRITE(hndFile, lcTK)
			llTkValido = .T.
		ENDIF
		
		=FCLOSE(hndFile)
	ELSE
		MESSAGEBOX("Fallo de acceso: " + ALLTRIM(Thisform.fe.ultimoMensajeError), 0+16, Thisform.Caption)
		llTkValido = .F.			
	ENDIF
ENDIF

RETURN llTkValido
ENDPROC
PROCEDURE imprimir
LOCAL m.NroCli, m.RazSoc, m.Telefono, m.direccion, m.localidad, m.codPostal, m.pcia, m.TipoIVA, m.nroCUIT
LOCAL m.Total, m.tipoDoc, m.NroCbte, m.Fecha, m.leyenda, m.fecVto, m.tipoDoc, m.ptoVta
LOCAL m.porDesc1, m.porDesc2, m.porDesc3, m.porDesc4
LOCAL m.impDesc1, m.impDesc2, m.impDesc3, m.impDesc4
LOCAL m.impIVA105, m.impIVA21, m.impNeto, m.impFinal, m.porIIBB, m.impIIBB, m.observ
LOCAL lcSql, loNumerador, lcPrinterName, lnCantCpia
LOCAL loResCli, loResLoc, loResPcia
LOCAL m.cae, m.caevto, lcAnio, lcMes, lcDia
LOCAL m.codigoCbte, m.barcode, m.code
LOCAL lnIdNum, loPDF, lcFileName
LOCAL lcNomEmp

lcNomEmp = getconfig("NOMEMP")
loNumerador = CREATEOBJECT("odbc_result")
loResCli = CREATEOBJECT("odbc_result")
loResLoc = CREATEOBJECT("odbc_result")
loResPcia = CREATEOBJECT("odbc_result")
loResSitIVA = CREATEOBJECT("odbc_result")
lcSql = ""
lnIdNum = 0

m.Total = 0.00
m.tipoDoc = ""
m.NroCbte = ""
m.leyenda = ""
m.Fecha = DATETIME()
m.impIVA105 = 0.00
m.impIVA21 = 0.00
m.impNeto = 0.00
m.impFinal = 0.00
m.tipoDoc = Thisform.tipodocref
m.ptoVta = Thisform.ptovta
m.porIIBB = 0.00
m.impIIBB = 0.00
m.observ = ""
m.codigoCbte = REPLICATE("0", 2 - LEN(ALLTRIM(STR(Thisform.fe.F1CabeceraCbteTipo)))) + ALLTRIM(STR(Thisform.fe.F1CabeceraCbteTipo))
m.barcode = ""
m.code = ""

lcAnio = SUBSTR(Thisform.aut_cae_vto, 1, 4)
lcMes = SUBSTR(Thisform.aut_cae_vto, 5, 2)
lcDia = SUBSTR(Thisform.aut_cae_vto, 7, 2)

&& Me fijo cuantas copias tengo que imprimir
lcSql = "select * from numerador where cbte = '" + ALLTRIM(Thisform.cbte) + "' and tipoDoc = '" + ALLTRIM(m.tipoDoc) + "' AND ptoVta = " + ALLTRIM(STR(m.ptoVta))
loNumerador = CREATEOBJECT("odbc_result")
loNumerador.ActiveConnection = goConn.ActiveConnection
loNumerador.Cursor_Name = "cur_num"
loNumerador.OpenQuery(lcSql)

SELECT cur_num
lnIdNum = cur_num.idNum
*lcPrinterName = cur_num.impresora
*lnCantCpia = cur_num.cantCpia

loNumerador.close_query()

lcSql = "SELECT * FROM impresoras WHERE hostName = '" + ALLTRIM(SYS(0)) + "' "
lcSql = lcSql + " AND idNum = " + ALLTRIM(STR(lnIdNum))

loNumerador.ActiveConnection = goConn.ActiveConnection
loNumerador.Cursor_Name = "cur_num"
loNumerador.OpenQuery(lcSql)

SELECT cur_num
IF RECCOUNT("cur_num") = 0 THEN
	MESSAGEBOX("La impresora no está instalada para este puesto de trabajo", 0+48, Thisform.Caption)
	RETURN
ENDIF

lcPrinterName = ALLTRIM(cur_num.impresora)
lnCantCpia = cur_num.copias

loNumerador.Close_Query()

&& Recupero los datos del cliente
lcSql = "SELECT * FROM clientes WHERE idCliente = " + ALLTRIM(STR(Thisform.idCliente))
loResCli.cursor_name = "cur_Cliente"
loResCli.ActiveConnection = goConn.ActiveConnection
loResCli.OpenQuery(lcSql)

m.NroCli = cur_Cliente.idCliente
m.RazSoc = cur_Cliente.razSoc
m.Telefono = cur_Cliente.telefono
m.direccion = cur_Cliente.direccion

&& Levanto los datos de la localidad que tiene asignada el cliente
lcSql = "SELECT * FROM localidad WHERE idLocalid = " + ALLTRIM(STR(cur_Cliente.idLocalid))
loResLoc.Cursor_Name = "cur_Loc"
loResLoc.ActiveConnection = goConn.ActiveConnection
loResLoc.OpenQuery(lcSql)

m.localidad = ALLTRIM(cur_Loc.descripcio)
m.codPostal = ALLTRIM(cur_Loc.codPostal)

&& Levanto los datos de la provincia que tiene asignada la localidad
lcSql = "SELECT * FROM provincias WHERE idProvin = " + ALLTRIM(STR(cur_Loc.idProvin))
loResPcia.Cursor_Name = "cur_Pcia"
loResPcia.ActiveConnection = goConn.ActiveConnection
loResPcia.OpenQuery(lcSql)

m.pcia = ALLTRIM(cur_Pcia.descripcio)

loResPcia.Close_Query()
loResLoc.Close_Query()

m.nroCUIT = cur_Cliente.nroCUIT

&& Levanto los datos de la situación de IVA que tiene el cliente
lcSql = "SELECT * FROM sitiva WHERE idSitIVA = " + ALLTRIM(STR(cur_Cliente.idSitIVA))
loResSitIVA.Cursor_Name = "cur_SitIVA"
loResSitIVA.ActiveConnection = goConn.ActiveConnection
loResSitIVA.OpenQuery(lcSql)

m.TipoIVA = cur_SitIVA.descripcio

loResSitIVA.Close_Query()
loResCli.Close_Query()

&& Incorporo los datos devueltos por la facturación electrónica
m.caevto = lcDia + "/" + lcMes + "/" + lcAnio
m.cae = Thisform.aut_cae
m.NroCbte = REPLICATE("0", 4 - LEN(ALLTRIM(STR(Thisform.ptovta)))) + ALLTRIM(STR(Thisform.ptovta)) + "-" + REPLICATE("0", 8 - LEN(ALLTRIM(STR(Thisform.nrocbte)))) + ALLTRIM(STR(Thisform.nrocbte))

&& Generación del código de barra
m.barcode = ALLTRIM(Thisform.cli_cuit)
m.barcode = m.barcode + ALLTRIM(m.codigoCbte)
m.barcode = m.barcode + REPLICATE("0", 4 - LEN(ALLTRIM(STR(m.ptovta)))) + ALLTRIM(STR(m.ptovta))
m.barcode = m.barcode + ALLTRIM(m.cae)
m.barcode = m.barcode + ALLTRIM(lcAnio)
m.barcode = m.barcode + REPLICATE("0", 2 - LEN(ALLTRIM(lcMes))) + ALLTRIM(lcMes)
m.barcode = m.barcode + REPLICATE("0", 2 - LEN(ALLTRIM(lcDia))) + ALLTRIM(lcDia)
m.barcode = m.barcode + ALLTRIM(STR(Thisform.calc_digito_verificador(m.barcode)))
m.code = m.barcode
m.barcode = getcodbarras(m.barcode)

m.impIVA105 = Thisform.txtImpIVA105.Value 
m.impIVA21 = Thisform.txtImpIVA21.Value 
m.impNeto = Thisform.txtSubTotal.Value
m.impFinal = Thisform.txtTotal.Value
m.porIIBB = Thisform.txtporIIBB.Value 
m.impIIBB = Thisform.txtImpIIBB.Value
m.observ = Thisform.txtobserv.Value
 
IF ALLTRIM(Thisform.Cbte) == "NC"
	m.Leyenda = "NOTA DE CREDITO"
	m.Total = Thisform.txtTotal.Value
ELSE
	IF ALLTRIM(Thisform.Cbte) == "ND"
		m.leyenda = "NOTA DE DEBITO"
		m.Total = Thisform.txtTotal.Value
	ENDIF
ENDIF

IF thisform.printcbte THEN
	SET PRINTER TO NAME ALLTRIM(lcPrinterName)
	SELECT vtadcp

	FOR i = 1 TO lnCantCpia
		IF ALLTRIM(m.tipodoc) == "A" THEN
			SELECT vtadcp
			REPORT FORM "repncnd.frx" TO PRINTER NOCONSOLE
		ELSE 
			SELECT vtadcp
			REPORT FORM "repncnd_b.frx" TO PRINTER NOCONSOLE
		ENDIF
	NEXT
ENDIF

&& Envío de mail automático
IF thisform.envcbte THEN
	lcFileName = SYS(5) + SYS(2003) + "\wsafip\ComprobantesPDF\" + this.cbte + "_" + m.NroCbte + ".pdf"
	
	loPDF = CREATEOBJECT("Bullzip.PDFPrinterSettings")
		loPDF.SetValue('output', lcFileName)
		loPDF.SetValue('DisableOptionDialog', 'no') 
		loPDF.SetValue('ConfirmOverwrite', 'no')
		loPDF.SetValue('Showsettings', 'never') 
		loPDF.SetValue('ShowSaveAS', 'nofile') 
		loPDF.SetValue('ShowPdf', 'no') 
		loPDF.WriteSettings(.t.)
	
	SET CONSOLE OFF
	SET PRINTER TO NAME("Bullzip PDF Printer")
	IF ALLTRIM(m.tipodoc) == "A" THEN
		&& Imprime el comprobante de tipo "A"
		SELECT vtadcp
		REPORT FORM "repncnd.frx" NOCONSOLE TO PRINTER
	ELSE
		&& Imprime el comprobante de tipo "B"
		SELECT vtadcp
		REPORT FORM "repncnd_b.frx" NOCONSOLE TO PRINTER
	ENDIF
	SET PRINTER TO DEFAULT
	SET CONSOLE ON
	
	WAIT WINDOW "El archivo PDF se está generando, aguarde unos segundos..." NOWAIT
	DO WHILE !FILE(lcFileName)
		
	ENDDO
	
	&&MESSAGEBOX("Archivo generado en " + lcFileName, 0+64, thisform.Caption)
	
	TEXT TO lcMailMsg NOSHOW
	Estimado cliente,
	
	Le adjuntamos el comprobante electrónico de su compra en formato PDF.
	
	Muchas gracias!
	
	
	
	Saludos cordiales,
	
	ENDTEXT
	lcMailMsg = lcMailMsg + lcNomEmp
	
	&& Procedo a hacer el envío de mail
	DO LOCFILE("FoxyPreviewer.App")
	WITH _screen.oFoxyPreviewer	
		.cEmailType = "PDF"
		.nEmailMode = 2
		.cEMailTo = thisform.mailfc
		.cSMTPServer = "smtp.gmail.com"
		.cEmailFrom = lcNomEmp + "<noreply.lpsoft@gmail.com>"
		.cEMailSubject = "Comprobante Electrónico " + this.cbte + " " + m.NroCbte
		.nSMTPPort = 465
		.lSMTPUseSSL = .t.
		.cSMTPUserName = "noreply.lpsoft@gmail.com"
		.cSMTPPassword = "LP2523eo"
		.lReadReceipt  = .F.
		.lPriority = .F.
		.cEmailBody = lcMailMsg
		.SendEmailUsingCDO(lcFileName)
	ENDWITH	
ENDIF

DO FoxyPreviewer.App WITH "Release"

ENDPROC
PROCEDURE btnGrabar.Click
LOCAL lcSql, loCommand, lnIdVentaC, lnPtoVta, lnIdVtasRel, loResCli
LOCAL loNumerador, lnPtoVta, lnNroCbte, lnPorIVA21 
LOCAL lnPorIVA105, lnImpIVA21, lnImpIVA105, lnIdVtaCP, lnIdCC_Cli
LOCAL lnIdOper, lnSaldo, loDateTime
LOCAL lnIdCondPago, lnIdSitIVA, lnIdVendedor, lnPorIIBB, lnImpIIBB, lnIdCC_CliOrig

lcSql = ""
loDateTime = CREATEOBJECT("datetime")
loCommand = CREATEOBJECT("odbc_command")
loResCli = CREATEOBJECT("odbc_result")
lnIdVentaC = 0
lnPtoVta = INT(VAL(ALLTRIM(getconfig("PTOVTA"))))
lnNroCbte = 0
lnIdVtaCP = 0
lnIdCC_Cli = 0
lnPorIVA21 = 0.00
lnImpIVA21 = 0.00
lnPorIVA105 = 0.00
lnImpIVA105 = 0.00
lnIdOper = 0
lnSaldo = 0.00
lnIdVtasRel = 0
lnIdCondPago = 0
lnIdSitIVA = 0
lnIdVendedor = 0
lnPorIIBB = 0.00
lnImpIIBB = 0.00
lnIdCC_CliOrig = thisform.idcc_cli

SELECT vtadcp
IF RECCOUNT("vtadcp") = 0 THEN
	MESSAGEBOX("Debe ingresar al menos un ítem del detalle", 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

lcSql = "SELECT * FROM clientes WHERE idCliente = " + ALLTRIM(STR(Thisform.idCliente))
loResCli.ActiveConnection = goConn.ActiveConnection
loResCli.Cursor_Name = "cur_cli"

IF !loResCli.OpenQuery(lcSql) THEN
	MESSAGEBOX(loResCli.Error_Message, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

SELECT cur_cli
lnIdCondPago = cur_cli.idCondPago
lnIdSitIVA = cur_cli.idSitIVA
lnIdVendedor = cur_cli.idVendedor

loResCli.Close_Query()

SELECT vtadcp
DO WHILE !EOF("vtadcp") 
	IF vtadcp.ivaPor = 21 THEN
		lnPorIVA21 = vtadcp.ivaPor
		lnImpIVA21 = lnImpIVA21 + vtadcp.ivaImp
	ELSE
		lnPorIVA105 = vtadcp.ivaPor
		lnImpIVA105 = lnImpIVA105 + vtadcp.ivaImp
	ENDIF	

	SELECT vtadcp
	SKIP	
ENDDO

lnPorIIBB = Thisform.txtporIIBB.Value
lnImpIIBB = Thisform.txtImpIIBB.Value

goConn.BeginTransaction()	&& Inicio la transacción
 
&& Calculo el tipo de comprobante
IF INT(VAL(ALLTRIM(getconfig("DEMO")))) == 0 THEN
	Thisform.Tipodocref = Thisform.calcular_tipodoc()
ELSE
	Thisform.Tipodocref = "X"
ENDIF

lcSql = "SELECT * FROM numerador WHERE cbte = '" + ALLTRIM(Thisform.cbte) + "' AND tipoDoc = '" + ALLTRIM(thisform.tipodocref) + "' AND ptoVta = " + ALLTRIM(STR(lnPtoVta))
loNumerador = CREATEOBJECT("odbc_result")
loNumerador.ActiveConnection = goConn.ActiveConnection
loNumerador.Cursor_Name = "cur_num"
loNumerador.OpenQuery(lcSql)
SELECT cur_num

IF RECCOUNT("cur_num") = 0 THEN
	MESSAGEBOX("No se encuentra configurado el numerador del comprobante " + ALLTRIM(Thisform.cbte) + " Punto de Venta: " + ALLTRIM(STR(lnPtoVta)) + " Letra: " + ALLTRIM(thisform.tipodocref), 0+48, thisform.Caption)
	loNumerador.close_query()
	RETURN .F.
ENDIF

SELECT cur_num
lnNroCbte = 0
THisform.ptovta = lnPtoVta
Thisform.nrocbte = lnNroCbte
Thisform.printerDevice = cur_num.impresora

loNumerador.close_query()

&& Actualizo el numerador
lcSql = "update numerador set numActual = " + ALLTRIM(STR(lnNroCbte)) + ;
	" where cbte = '" + ALLTRIM(Thisform.cbte) + "' and tipoDoc = '" + ALLTRIM(thisform.tipodocref) + "'"

loCommand.ActiveConnection = goConn.ActiveConnection
loCommand.CommandText = lcSql

IF !loCommand.Execute()
	goConn.Rollback()
	RETURN .F.
ENDIF

lnIdVentaC = goConn.GetNextId("ventascab", "idVentasC")
Thisform.id_ventasc = lnIdVentaC

lcSql = "INSERT INTO ventascab ( "
lcSql = lcSql + "idVentasC, idCliente, razSoc, idTipoDoc, nroDoc, fecEmision, fecVto, cbte, tipoDoc, ptoVta, numCbte, anulado, idCondPago, idSitIVA, idVendedor, "
lcSql = lcSql + "impNeto, impFinal, porIVA21, impIVA21, porIVA105, impIVA105, porDesc1, "
lcSql = lcSql + "porDesc2, porDesc3, porDesc4, impDesc1, impDesc2, impDesc3, impDesc4, totFact, Saldo, usuAlta, fecAlta, idHostAlta, porIIBB, impIIBB, observ) VALUES ("
lcSql = lcSql + ALLTRIM(STR(lnIdVentaC)) + ", "
lcSql = lcSql + ALLTRIM(STR(Thisform.idCliente)) + ", "
lcSql = lcSql + "'" + ALLTRIM(Thisform.cli_razsoc) + "', "
lcSql = lcSql + ALLTRIM(STR(Thisform.cli_idTipoDoc)) + ", "
lcSql = lcSql + "'" + ALLTRIM(Thisform.cli_cuit) + "', "
lcSql = lcSql + IIF(Thisform.sqlsrv, "GETDATE(), " , "current_date, ")
lcSql = lcSql + IIF(Thisform.sqlsrv, "GETDATE(), " , "current_date, ")
lcSql = lcSql + "'" + ALLTRIM(Thisform.cbte) + "', "
lcSql = lcSql + "'" + ALLTRIM(Thisform.tipodocref) + "', "
lcSql = lcSql + ALLTRIM(STR(lnPtoVta)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnNroCbte)) + ", "
lcSql = lcSql + "0, "
lcSql = lcSql + ALLTRIM(STR(lnIdCondPago)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnIdSitIVA)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnIdVendedor)) + ", "
lcSql = lcSql + ALLTRIM(STR(Thisform.txtSubTotal.Value, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(Thisform.txtSubTotal.Value, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnPorIVA21, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpIVA21, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnPorIVA105, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpIVA105, 10, 2)) + ", "
lcSql = lcSql + "0, 0, 0, 0, 0, 0, 0, 0, "
lcSql = lcSql + ALLTRIM(STR(Thisform.txtTotal.Value, 10, 2)) + ", 0, "
lcSql = lcSql + "'" + ALLTRIM(gcCodUsu) + "', "
lcSql = lcSql + loDateTime.getDateTime() + ", "
lcSql = lcSql + "'" + SYS(0) + "', "
lcSql = lcSql + ALLTRIM(STR(lnPorIIBB, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpIIBB, 10, 2)) + ", "
lcSql = lcSql + "'" + ALLTRIM(thisform.txtobserv.Value) + "') "
*lcSql = lcSql + ALLTRIM(STR(lnIdCC_CliOrig)) + ")"

loCommand.commandText = lcSql
loCommand.ActiveConnection = goConn.ActiveConnection

IF !loCommand.Execute() then
	goConn.Rollback()
	MESSAGEBOX(loCommand.ErrorMessage, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

&& Grabar el detalle en VTADCP
SELECT vtadcp
GO TOP
DO WHILE !EOF("vtadcp")
	lnIdVtaCP = goConn.GetNextID("vtadcp", "id_vtadcp")
	
	lcSql = "INSERT INTO vtadcp ( "
	lcSql = lcSql + "id_vtadcp, idVentasC, idPlanCta, impNeto, ivaPor, ivaImp, total) VALUES "
	lcSql = lcSql + "(" + ALLTRIM(STR(lnIdVtaCP)) + ", " + ALLTRIM(STR(lnIdVentaC)) + ", " + ALLTRIM(STR(vtadcp.idPlanCta)) + ", "
	lcSql = lcSql + ALLTRIM(STR(vtadcp.impNeto, 10, 2)) + ", " + ALLTRIM(STR(vtadcp.ivaPor, 10, 2)) + ", " + ALLTRIM(STR(vtadcp.ivaImp, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(vtadcp.total, 10, 2)) + ")"
	
	loCommand.ActiveConnection = goConn.ActiveConnection
	loCommand.CommandText = lcSql
	
	IF !loCommand.Execute() THEN
		goConn.Rollback()
		MESSAGEBOX(loCommand.ErrorMessage, 0+48, Thisform.Caption)
		RETURN .F.
	ENDIF
	
	&& Marco el cheque como cheque rechazado
	IF ALLTRIM(vtadcp.cheque_nro) != "" THEN
		lcSql = "UPDATE cheques SET estado = 'R' WHERE chq_nro = '" + ALLTRIM(vtadcp.cheque_nro) + "' AND idBanco = " + ALLTRIM(STR(vtadcp.idBanco))
		loCommand.ActiveConnection = goConn.ActiveConnection
		loCommand.CommandText = lcSql
		
		IF !loCommand.Execute() THEN
			goConn.Rollback()
			MESSAGEBOX(loCommand.ErrorMessage, 0+48, Thisform.Caption)
			RETURN .F.
		ENDIF
	ENDIF	

	SELECT vtadcp
	SKIP
ENDDO

IF Thisform.idVentascab <> - 1 THEN
	&& Generar el registro de vinculación de comprobantes
	lnIdVtasRel = goConn.GetNextId("ventasrel", "idvtarel")

	&& Vinculo el comprobante de venta
	lcSql = "INSERT INTO ventasrel (idVtaRel, idVtaCO, idVtaCD) VALUES "
	lcSql = lcSql + "(" + ALLTRIM(STR(lnIdVtasRel)) + ", " + ALLTRIM(STR(Thisform.idventascab)) + ", " + ALLTRIM(STR(lnIdVentaC)) + ")"

	loCommand.ActiveConnection = goConn.ActiveConnection
	loCommand.CommandText = lcSql

	IF !loCommand.Execute()
		goConn.Rollback()
		RETURN .F.
	ENDIF
ENDIF 

&& Actualizar el saldo de la factura seleccionada
IF ALLTRIM(thisform.cbte) == "NC" THEN
	lcSql = "UPDATE ventascab SET Saldo = Saldo - " + ALLTRIM(STR(Thisform.txtTotal.Value, 10, 2)) + ", "
	lcSql = lcSql + "usuModi = '" + ALLTRIM(gcCodUsu) + "', "
	lcSql = lcSql + "fecModi = " + loDateTime.getDateTime() + ", "
	lcSql = lcSql + "idHostModi = '" + ALLTRIM(SYS(0)) + "' "
	lcSql = lcSql + "WHERE idVentasC IN (SELECT IdVentasC FROM cc_cli WHERE IdOper = " +  ALLTRIM(STR(lnIdOper)) + " AND cbte like 'FC%')"
ELSE 
	lcSql = "UPDATE ventascab SET Saldo = Saldo + " + ALLTRIM(STR(Thisform.txtTotal.Value, 10, 2)) + ", "
	lcSql = lcSql + "usuModi = '" + ALLTRIM(gcCodUsu) + "', "
	lcSql = lcSql + "fecModi = " + loDateTime.getDateTime() + ", "
	lcSql = lcSql + "idHostModi = '" + ALLTRIM(SYS(0)) + "' "
	lcSql = lcSql + "WHERE idVentasC IN (SELECT IdVentasC FROM cc_cli WHERE IdOper = " +  ALLTRIM(STR(lnIdOper)) + " AND cbte like 'FC%')"
ENDIF
	
loCommand.CommandText = lcSql
loCommand.ActiveConnection = goConn.ActiveConnection

IF !loCommand.Execute()
	goConn.Rollback()
	RETURN .F.
ENDIF 

goConn.Commit()

Thisform.ptovta = lnPtoVta

IF !thisform.enviar_wsafipfe() THEN
	MESSAGEBOX("Este comprobante no ha sido autorizado, por favor, vuelva a intentarlo desde la autorización diferida", 0+48, Thisform.Caption)
	RETURN .F.
ELSE
	IF thisform.fe_set_cae() THEN
		IF thisform.grabar_ctacte(Thisform.id_ventasc) THEN
			Thisform.imprimir()
		ENDIF
	ENDIF
ENDIF

Thisform.Release()
RETURN .T.
ENDPROC


************************************************************
OBJETO: fe
************************************************************
*** PROPIEDADES ***
Top = 420
Left = 636
Height = 24
Width = 36
Name = "fe"

*** METODOS ***


************************************************************
OBJETO: frm_ncnd_cc_fe
************************************************************
*** PROPIEDADES ***
Arial, 0, 8, 5, 14, 11, 29, 3, 0
Arial, 1, 8, 5, 14, 11, 29, 3, 0
Arial, 0, 9, 5, 15, 12, 32, 3, 0

*** METODOS ***


************************************************************
OBJETO: cls_recibos_cons
************************************************************
*** PROPIEDADES ***
BorderStyle = 2
Height = 571
Width = 946
DoCreate = .T.
Caption = "Consultas de Recibos"
WindowState = 0
Name = "cls_recibos_cons"
CONTENIDO.Name = "CONTENIDO"

*** METODOS ***
PROCEDURE entrar_detalle
LOCAL loForm

loForm = CREATEOBJECT("cls_detalle_recibo")

SELECT cur_recibos
loForm.idRCCob_C = cur_recibos.idRCCob_C
loForm.idCliente = cur_recibos.idCliente
loForm.razSoc = cur_recibos.razSoc
loForm.fecEmis = cur_recibos.fecEmis
loForm.nroRec = cur_recibos.nroRec

loForm.leer_datos()
loForm.show()

&& Vuelvo a levantar la busqueda de recibos
&& actualizada
Thisform.buscar_rc()

ENDPROC
PROCEDURE buscar_rc
LOCAL lcSql, loResult
LOCAL lnIdClienteDD, lnIdClienteHH
LOCAL ldFecDD, ldFecHH
LOCAL lnNroRecDD, lnNroRecHH
LOCAL loDT

lcSql = ""
loResult = CREATEOBJECT("odbc_result")
loDT = CREATEOBJECT("datetime")

lnNroRecDD = 0
lnNroRecHH = 0

SELECT cur_recibos
ZAP

IF Thisform.contenido.sel_clienteDD.txtCodigo.Value = 0 .AND. Thisform.contenido.sel_clienteHH.txtCodigo.Value = 0 THEN
	lnIdClienteDD = 0
	lnIdClienteHH = 99999999
ELSE
	lnIdClienteDD = Thisform.contenido.sel_clienteDD.txtCodigo.Value
	lnIdClienteHH = Thisform.contenido.sel_clienteHH.txtCodigo.Value
ENDIF

ldFecDD = Thisform.contenido.txtFEchaDD.Value
ldFecHH = Thisform.contenido.txtFechaHH.Value
lnNroRecDD = Thisform.contenido.txtNroRecDD.Value
lnNroRecHH = Thisform.contenido.txtNroRecHH.Value

lcSql = "SELECT	rccob_c.*, clientes.razSoc "
lcSql = lcSql + "FROM rccob_c "
lcSql = lcSql + "	INNER JOIN clientes ON rccob_c.idCliente = clientes.idCliente "
lcSql = lcSql + "WHERE fecEmis BETWEEN " + loDT.toMySql(ldFecDD) + " AND " + loDT.toMySql(ldFecHH) + " " 
lcSql = lcSql + " AND clientes.idCliente BETWEEN " + ALLTRIM(STR(lnIdClienteDD)) + " AND " + ALLTRIM(STR(lnIdClienteHH)) + " "

IF lnNroRecDD <> 0 .AND. lnNroRecHH <> 0 THEN
	lcSql = lcSql + " AND CAST(SUBSTRING(nroRec, 6, length(nroRec)) AS SIGNED INTEGER) BETWEEN " + ALLTRIM(STR(lnNroRecDD)) + " AND " + ALLTRIM(STR(lnNroRecHH)) + " "
ENDIF

lcSql = lcSql + "AND rccob_c.fecBaja IS NULL "

loResult.ActiveConnection = goConn.ActiveConnection
loResult.Cursor_Name = "cur_x"

IF !loResult.OpenQuery(lcSql) THEN
	MESSAGEBOX(loResult.Error_Message, 0+48, Thisform.Caption)
	RETURN
ENDIF

SELECT cur_x
DO WHILE !EOF("cur_x")
	SELECT cur_recibos
	APPEND BLANK
	REPLACE cur_recibos.idRCCob_C WITH cur_x.idRCCob_C
	REPLACE cur_recibos.idCliente WITH cur_x.idCliente ADDITIVE
	REPLACE cur_recibos.razSoc WITH cur_x.razSoc ADDITIVE
	REPLACE cur_recibos.nroRec WITH cur_x.nroRec ADDITIVE
	REPLACE cur_recibos.fecEmis WITH cur_x.fecEmis ADDITIVE
	REPLACE cur_recibos.importe WITH cur_x.importe ADDITIVE

	SELECT cur_x
	SKIP
ENDDO

loResult.Close_Query()

SELECT cur_recibos
GO TOP
Thisform.contenido.grdRecibos.Refresh()


ENDPROC
PROCEDURE Init
DODEFAULT()

SELECT cur_recibos
Thisform.contenido.grdRecibos.alias_name = "cur_recibos"
Thisform.contenido.grdRecibos.RecordSource = "cur_recibos"
Thisform.contenido.grdRecibos.titulos_cabeceras = "Cliente,Razón Social,Número,Fecha Emis.,Importe"
Thisform.contenido.grdRecibos.list_controlsource = "idCliente,razSoc,nroRec,fecEmis,importe"
Thisform.contenido.grdRecibos.lista_ancho_cols = "70,300,100,100,100"
Thisform.contenido.grdRecibos.generar_grid()

Thisform.contenido.txtFechaDD.Value = CTOD("01/01/2000")
Thisform.contenidO.txtFechaHH.Value = DATE() + 1
ENDPROC
PROCEDURE Load
DODEFAULT()

CREATE CURSOR cur_recibos (	;
	idRCCob_C int,;
	idCliente int,;
	razSoc varchar(60),;
	nroRec varchar(13),;
	fecEmis D,;
	importe float(10, 2))
	

	

ENDPROC


************************************************************
OBJETO: CLSETIQUETA1
************************************************************
*** PROPIEDADES ***
Caption = "Cliente desde:"
Left = 16
Top = 12
TabIndex = 13
Name = "CLSETIQUETA1"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta2
************************************************************
*** PROPIEDADES ***
Caption = "Cliente hasta:"
Left = 16
Top = 37
TabIndex = 14
Name = "Clsetiqueta2"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta3
************************************************************
*** PROPIEDADES ***
Caption = "Fecha desde:"
Left = 16
Top = 62
TabIndex = 16
Name = "Clsetiqueta3"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta4
************************************************************
*** PROPIEDADES ***
Caption = "Fecha hasta:"
Left = 222
Top = 59
TabIndex = 18
Name = "Clsetiqueta4"

*** METODOS ***


************************************************************
OBJETO: sel_clienteDD
************************************************************
*** PROPIEDADES ***
Top = 5
Left = 113
TabIndex = 1
anchos_cols = 400,100
esnumerico = .T.
nombre_campo_codigo = idCliente
nombre_campo_desc = razSoc
alternative_cols = nroCUIT
nombre_tabla = clientes
pkfield = idCliente
title_cols = Descripción,DNI/CUIT
criterio_filtro = clientes.fecBaja IS NULL
Name = "sel_clienteDD"
TXTCODIGO.Name = "TXTCODIGO"
TXTDESCRIPCION.Name = "TXTDESCRIPCION"

*** METODOS ***


************************************************************
OBJETO: sel_clienteHH
************************************************************
*** PROPIEDADES ***
Top = 30
Left = 113
TabIndex = 2
anchos_cols = 400,100
esnumerico = .T.
nombre_campo_codigo = idCliente
nombre_campo_desc = razSoc
alternative_cols = nroCUIT
nombre_tabla = clientes
pkfield = idCliente
title_cols = Descripción,DNI/CUIT
criterio_filtro = clientes.fecBaja IS NULL
Name = "sel_clienteHH"
TXTCODIGO.Name = "TXTCODIGO"
TXTDESCRIPCION.Name = "TXTDESCRIPCION"

*** METODOS ***


************************************************************
OBJETO: txtFechaDD
************************************************************
*** PROPIEDADES ***
Left = 115
TabIndex = 3
Top = 57
isdatetime = .T.
Name = "txtFechaDD"

*** METODOS ***


************************************************************
OBJETO: txtFechaHH
************************************************************
*** PROPIEDADES ***
Left = 297
TabIndex = 4
Top = 57
isdatetime = .T.
Name = "txtFechaHH"

*** METODOS ***


************************************************************
OBJETO: btnAceptar
************************************************************
*** PROPIEDADES ***
Top = 63
Left = 849
TabIndex = 7
Name = "btnAceptar"

*** METODOS ***
PROCEDURE Click
thisform.buscar_rc()
ENDPROC


************************************************************
OBJETO: grdRecibos
************************************************************
*** PROPIEDADES ***
Height = 411
Left = 10
TabIndex = 12
Top = 109
Width = 932
permitir_busqueda = .F.
permitir_ordenamiento = .F.
Name = "grdRecibos"
COLUMN1.HEADER1.Name = "HEADER1"
COLUMN1.TEXT1.Name = "TEXT1"
COLUMN1.Name = "COLUMN1"
COLUMN2.HEADER1.Name = "HEADER1"
COLUMN2.TEXT1.Name = "TEXT1"
COLUMN2.Name = "COLUMN2"
COLUMN3.HEADER1.Name = "HEADER1"
COLUMN3.TEXT1.Name = "TEXT1"
COLUMN3.Name = "COLUMN3"
COLUMN4.HEADER1.Name = "HEADER1"
COLUMN4.TEXT1.Name = "TEXT1"
COLUMN4.Name = "COLUMN4"
COLUMN5.HEADER1.Name = "HEADER1"
COLUMN5.TEXT1.Name = "TEXT1"
COLUMN5.Name = "COLUMN5"
COLUMN6.HEADER1.Name = "HEADER1"
COLUMN6.TEXT1.Name = "TEXT1"
COLUMN6.Name = "COLUMN6"
COLUMN7.HEADER1.Name = "HEADER1"
COLUMN7.TEXT1.Name = "TEXT1"
COLUMN7.Name = "COLUMN7"
COLUMN8.HEADER1.Name = "HEADER1"
COLUMN8.TEXT1.Name = "TEXT1"
COLUMN8.Name = "COLUMN8"
COLUMN9.HEADER1.Name = "HEADER1"
COLUMN9.TEXT1.Name = "TEXT1"
COLUMN9.Name = "COLUMN9"
COLUMN10.HEADER1.Name = "HEADER1"
COLUMN10.TEXT1.Name = "TEXT1"
COLUMN10.Name = "COLUMN10"
COLUMN11.HEADER1.Name = "HEADER1"
COLUMN11.TEXT1.Name = "TEXT1"
COLUMN11.Name = "COLUMN11"
COLUMN12.HEADER1.Name = "HEADER1"
COLUMN12.TEXT1.Name = "TEXT1"
COLUMN12.Name = "COLUMN12"
COLUMN13.HEADER1.Name = "HEADER1"
COLUMN13.TEXT1.Name = "TEXT1"
COLUMN13.Name = "COLUMN13"
COLUMN14.HEADER1.Name = "HEADER1"
COLUMN14.TEXT1.Name = "TEXT1"
COLUMN14.Name = "COLUMN14"
COLUMN15.HEADER1.Name = "HEADER1"
COLUMN15.TEXT1.Name = "TEXT1"
COLUMN15.Name = "COLUMN15"
COLUMN16.HEADER1.Name = "HEADER1"
COLUMN16.TEXT1.Name = "TEXT1"
COLUMN16.Name = "COLUMN16"
COLUMN17.HEADER1.Name = "HEADER1"
COLUMN17.TEXT1.Name = "TEXT1"
COLUMN17.Name = "COLUMN17"
COLUMN18.HEADER1.Name = "HEADER1"
COLUMN18.TEXT1.Name = "TEXT1"
COLUMN18.Name = "COLUMN18"
COLUMN19.HEADER1.Name = "HEADER1"
COLUMN19.TEXT1.Name = "TEXT1"
COLUMN19.Name = "COLUMN19"
COLUMN20.HEADER1.Name = "HEADER1"
COLUMN20.TEXT1.Name = "TEXT1"
COLUMN20.Name = "COLUMN20"

*** METODOS ***
PROCEDURE press_enter
thisform.entrar_detalle()
ENDPROC


************************************************************
OBJETO: CLSCERRAR1
************************************************************
*** PROPIEDADES ***
Top = 525
Left = 898
TabIndex = 11
Name = "CLSCERRAR1"

*** METODOS ***


************************************************************
OBJETO: btnDetalles
************************************************************
*** PROPIEDADES ***
Top = 525
Left = 10
TabIndex = 9
Name = "btnDetalles"

*** METODOS ***
PROCEDURE Click
thisform.entrar_detalle()

ENDPROC


************************************************************
OBJETO: btnCancelar
************************************************************
*** PROPIEDADES ***
Top = 63
Left = 898
TabIndex = 8
Name = "btnCancelar"

*** METODOS ***
PROCEDURE Click

Thisform.contenido.sel_clienteDD.blanquear()
Thisform.contenido.sel_clienteHH.blanquear()
Thisform.contenido.txtFechaDD.Value = DATE() - 30
Thisform.contenido.txtFechaHH.Value = DATE() + 1
ENDPROC


************************************************************
OBJETO: Clsetiqueta5
************************************************************
*** PROPIEDADES ***
Caption = "N° Recibo desde:"
Height = 15
Left = 16
Top = 86
Width = 93
TabIndex = 15
Name = "Clsetiqueta5"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta6
************************************************************
*** PROPIEDADES ***
Caption = "N° Recibo Hasta:"
Height = 15
Left = 301
Top = 86
Width = 94
TabIndex = 17
Name = "Clsetiqueta6"

*** METODOS ***


************************************************************
OBJETO: txtNroRecDD
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 115
TabIndex = 5
Top = 81
Width = 169
ischaracter = .F.
isinteger = .T.
Name = "txtNroRecDD"

*** METODOS ***


************************************************************
OBJETO: txtNroRecHH
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 399
TabIndex = 6
Top = 81
Width = 169
ischaracter = .F.
isinteger = .T.
Name = "txtNroRecHH"

*** METODOS ***


************************************************************
OBJETO: cls_recibos_cons
************************************************************
*** PROPIEDADES ***
Arial, 0, 9, 5, 15, 12, 32, 3, 0
Arial, 1, 8, 5, 14, 11, 29, 3, 0

*** METODOS ***


************************************************************
OBJETO: cls_ncdev_fe
************************************************************
*** PROPIEDADES ***
DoCreate = .T.
WindowState = 0
nrocbte = 0
aut_cae = 
aut_cae_vto = 
aut_resultado = 
aut_motivo = 
aut_numero = 
ptovta = 
Name = "cls_ncdev_fe"
contenido.Clsetiqueta1.Name = "Clsetiqueta1"
contenido.sel_Cliente.txtCodigo.Name = "txtCodigo"
contenido.sel_Cliente.txtDescripcion.Name = "txtDescripcion"
contenido.sel_Cliente.Name = "sel_Cliente"
contenido.BTNBUSCARFC.Name = "BTNBUSCARFC"
contenido.PAGINAS.ErasePage = .T.
contenido.PAGINAS.Page1.GRDITEMS.COLUMN1.Header1.Name = "Header1"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN1.Text1.Name = "Text1"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN1.Name = "COLUMN1"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN2.Header1.Name = "Header1"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN2.Text1.Name = "Text1"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN2.Name = "COLUMN2"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN3.Header1.Name = "Header1"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN3.Text1.Name = "Text1"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN3.Name = "COLUMN3"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN4.Header1.Name = "Header1"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN4.Text1.Name = "Text1"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN4.Name = "COLUMN4"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN5.Header1.Name = "Header1"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN5.Text1.Name = "Text1"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN5.Name = "COLUMN5"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN6.Header1.Name = "Header1"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN6.Text1.Name = "Text1"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN6.Name = "COLUMN6"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN7.Header1.Name = "Header1"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN7.Text1.Name = "Text1"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN7.Name = "COLUMN7"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN8.Header1.Name = "Header1"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN8.Text1.Name = "Text1"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN8.Name = "COLUMN8"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN9.Header1.Name = "Header1"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN9.Text1.Name = "Text1"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN9.Name = "COLUMN9"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN10.Header1.Name = "Header1"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN10.Text1.Name = "Text1"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN10.Name = "COLUMN10"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN11.Header1.Name = "Header1"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN11.Text1.Name = "Text1"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN11.Name = "COLUMN11"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN12.Header1.Name = "Header1"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN12.Text1.Name = "Text1"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN12.Name = "COLUMN12"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN13.Header1.Name = "Header1"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN13.Text1.Name = "Text1"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN13.Name = "COLUMN13"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN14.Header1.Name = "Header1"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN14.Text1.Name = "Text1"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN14.Name = "COLUMN14"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN15.Header1.Name = "Header1"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN15.Text1.Name = "Text1"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN15.Name = "COLUMN15"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN16.Header1.Name = "Header1"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN16.Text1.Name = "Text1"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN16.Name = "COLUMN16"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN17.Header1.Name = "Header1"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN17.Text1.Name = "Text1"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN17.Name = "COLUMN17"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN18.Header1.Name = "Header1"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN18.Text1.Name = "Text1"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN18.Name = "COLUMN18"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN19.Header1.Name = "Header1"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN19.Text1.Name = "Text1"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN19.Name = "COLUMN19"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN20.Header1.Name = "Header1"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN20.Text1.Name = "Text1"
contenido.PAGINAS.Page1.GRDITEMS.COLUMN20.Name = "COLUMN20"
contenido.PAGINAS.Page1.GRDITEMS.Name = "GRDITEMS"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN1.Header1.Name = "Header1"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN1.Text1.Name = "Text1"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN1.Name = "COLUMN1"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN2.Header1.Name = "Header1"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN2.Text1.Name = "Text1"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN2.Name = "COLUMN2"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN3.Header1.Name = "Header1"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN3.Text1.Name = "Text1"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN3.Name = "COLUMN3"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN4.Header1.Name = "Header1"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN4.Text1.Name = "Text1"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN4.Name = "COLUMN4"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN5.Header1.Name = "Header1"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN5.Text1.Name = "Text1"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN5.Name = "COLUMN5"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN6.Header1.Name = "Header1"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN6.Text1.Name = "Text1"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN6.Name = "COLUMN6"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN7.Header1.Name = "Header1"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN7.Text1.Name = "Text1"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN7.Name = "COLUMN7"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN8.Header1.Name = "Header1"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN8.Text1.Name = "Text1"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN8.Name = "COLUMN8"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN9.Header1.Name = "Header1"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN9.Text1.Name = "Text1"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN9.Name = "COLUMN9"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN10.Header1.Name = "Header1"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN10.Text1.Name = "Text1"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN10.Name = "COLUMN10"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN11.Header1.Name = "Header1"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN11.Text1.Name = "Text1"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN11.Name = "COLUMN11"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN12.Header1.Name = "Header1"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN12.Text1.Name = "Text1"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN12.Name = "COLUMN12"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN13.Header1.Name = "Header1"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN13.Text1.Name = "Text1"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN13.Name = "COLUMN13"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN14.Header1.Name = "Header1"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN14.Text1.Name = "Text1"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN14.Name = "COLUMN14"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN15.Header1.Name = "Header1"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN15.Text1.Name = "Text1"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN15.Name = "COLUMN15"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN16.Header1.Name = "Header1"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN16.Text1.Name = "Text1"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN16.Name = "COLUMN16"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN17.Header1.Name = "Header1"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN17.Text1.Name = "Text1"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN17.Name = "COLUMN17"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN18.Header1.Name = "Header1"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN18.Text1.Name = "Text1"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN18.Name = "COLUMN18"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN19.Header1.Name = "Header1"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN19.Text1.Name = "Text1"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN19.Name = "COLUMN19"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN20.Header1.Name = "Header1"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN20.Text1.Name = "Text1"
contenido.PAGINAS.Page1.GRDITEMNC.COLUMN20.Name = "COLUMN20"
contenido.PAGINAS.Page1.GRDITEMNC.Name = "GRDITEMNC"
contenido.PAGINAS.Page1.Clsetiqueta1.Name = "Clsetiqueta1"
contenido.PAGINAS.Page1.Clsetiqueta2.Name = "Clsetiqueta2"
contenido.PAGINAS.Page1.BTNACEPTAR.Name = "BTNACEPTAR"
contenido.PAGINAS.Page1.btnCancelar.Name = "btnCancelar"
contenido.PAGINAS.Page1.Name = "Page1"
contenido.PAGINAS.Page2.Clsetiqueta1.Name = "Clsetiqueta1"
contenido.PAGINAS.Page2.Clsetiqueta2.Name = "Clsetiqueta2"
contenido.PAGINAS.Page2.Clsetiqueta3.Name = "Clsetiqueta3"
contenido.PAGINAS.Page2.Clsetiqueta4.Name = "Clsetiqueta4"
contenido.PAGINAS.Page2.Clsetiqueta5.Name = "Clsetiqueta5"
contenido.PAGINAS.Page2.Clsetiqueta6.Name = "Clsetiqueta6"
contenido.PAGINAS.Page2.Clsetiqueta7.Name = "Clsetiqueta7"
contenido.PAGINAS.Page2.Clsetiqueta8.Name = "Clsetiqueta8"
contenido.PAGINAS.Page2.Clsetiqueta9.Name = "Clsetiqueta9"
contenido.PAGINAS.Page2.Clslinea1.Name = "Clslinea1"
contenido.PAGINAS.Page2.CLSLINEA2.Name = "CLSLINEA2"
contenido.PAGINAS.Page2.Clsetiqueta10.Name = "Clsetiqueta10"
contenido.PAGINAS.Page2.Clsetiqueta11.Name = "Clsetiqueta11"
contenido.PAGINAS.Page2.TXTFCIMPNETO.Name = "TXTFCIMPNETO"
contenido.PAGINAS.Page2.TXTFCPORDTO1.Name = "TXTFCPORDTO1"
contenido.PAGINAS.Page2.TXTFCPORDTO2.Name = "TXTFCPORDTO2"
contenido.PAGINAS.Page2.TXTFCPORDTO3.Name = "TXTFCPORDTO3"
contenido.PAGINAS.Page2.TXTFCPORDTO4.Name = "TXTFCPORDTO4"
contenido.PAGINAS.Page2.TXTFCIMPFINAL.Name = "TXTFCIMPFINAL"
contenido.PAGINAS.Page2.TXTFCIMPIVA21.Name = "TXTFCIMPIVA21"
contenido.PAGINAS.Page2.TXTFCIMPIVA105.Name = "TXTFCIMPIVA105"
contenido.PAGINAS.Page2.TXTFCTOTFACT.Name = "TXTFCTOTFACT"
contenido.PAGINAS.Page2.TXTFCIMPDTO1.Name = "TXTFCIMPDTO1"
contenido.PAGINAS.Page2.TXTFCIMPDTO2.Name = "TXTFCIMPDTO2"
contenido.PAGINAS.Page2.TXTFCIMPDTO3.Name = "TXTFCIMPDTO3"
contenido.PAGINAS.Page2.TXTFCIMPDTO4.Name = "TXTFCIMPDTO4"
contenido.PAGINAS.Page2.TXTNCIMPNETO.Name = "TXTNCIMPNETO"
contenido.PAGINAS.Page2.TXTNCPORDTO1.Name = "TXTNCPORDTO1"
contenido.PAGINAS.Page2.TXTNCPORDTO2.Name = "TXTNCPORDTO2"
contenido.PAGINAS.Page2.TXTNCPORDTO3.Name = "TXTNCPORDTO3"
contenido.PAGINAS.Page2.TXTNCPORDTO4.Name = "TXTNCPORDTO4"
contenido.PAGINAS.Page2.TXTNCIMPFINAL.Name = "TXTNCIMPFINAL"
contenido.PAGINAS.Page2.TXTNCIMPIVA21.Name = "TXTNCIMPIVA21"
contenido.PAGINAS.Page2.TXTNCIMPIVA105.Name = "TXTNCIMPIVA105"
contenido.PAGINAS.Page2.TXTNCTOTFACT.Name = "TXTNCTOTFACT"
contenido.PAGINAS.Page2.TXTNCIMPDTO1.Name = "TXTNCIMPDTO1"
contenido.PAGINAS.Page2.TXTNCIMPDTO2.Name = "TXTNCIMPDTO2"
contenido.PAGINAS.Page2.TXTNCIMPDTO3.Name = "TXTNCIMPDTO3"
contenido.PAGINAS.Page2.TXTNCIMPDTO4.Name = "TXTNCIMPDTO4"
contenido.PAGINAS.Page2.CLSLINEA3.Name = "CLSLINEA3"
contenido.PAGINAS.Page2.CLSLINEA4.Name = "CLSLINEA4"
contenido.PAGINAS.Page2.Clsetiqueta12.Name = "Clsetiqueta12"
contenido.PAGINAS.Page2.TXTFCPORIIBB.Name = "TXTFCPORIIBB"
contenido.PAGINAS.Page2.TXTFCIMPIIBB.Name = "TXTFCIMPIIBB"
contenido.PAGINAS.Page2.TXTNCPORIIBB.Name = "TXTNCPORIIBB"
contenido.PAGINAS.Page2.TXTNCIMPIIBB.Name = "TXTNCIMPIIBB"
contenido.PAGINAS.Page2.TXTNCPORREC.Name = "TXTNCPORREC"
contenido.PAGINAS.Page2.TXTNCIMPREC.Name = "TXTNCIMPREC"
contenido.PAGINAS.Page2.TXTFCPORREC.Name = "TXTFCPORREC"
contenido.PAGINAS.Page2.TXTFCIMPREC.Name = "TXTFCIMPREC"
contenido.PAGINAS.Page2.Clsetiqueta13.Name = "Clsetiqueta13"
contenido.PAGINAS.Page2.Name = "Page2"
contenido.PAGINAS.Name = "PAGINAS"
contenido.BTNCERRAR.Name = "BTNCERRAR"
contenido.btnGrabar.Name = "btnGrabar"
contenido.BTNNUEVO.Name = "BTNNUEVO"
contenido.Clsetiqueta2.Name = "Clsetiqueta2"
contenido.TXTCBTE.Name = "TXTCBTE"
contenido.TXTTIPO.Name = "TXTTIPO"
contenido.TXTNROCBTE.Name = "TXTNROCBTE"
contenido.Clsetiqueta3.Name = "Clsetiqueta3"
contenido.txtFecEmis.Name = "txtFecEmis"
contenido.Name = "contenido"
DATOS_CBTES.Name = "DATOS_CBTES"

*** METODOS ***
PROCEDURE fe_convertir_tipodoc
PARAMETERS tcTipoDoc
LOCAL lnResultado

lnResultado = 99 && Código que corresponde a sin identificación en el diccionario

DO CASE
	CASE ALLTRIM(tcTipoDoc) == "CUIT"
		lnResultado = 80
	CASE ALLTRIM(tcTipoDoc) == "CUIL"
		lnResultado = 86
	CASE ALLTRIM(tcTipoDoc) == "CI"
		lnResultado = 87
	CASE ALLTRIM(tcTipoDoc) == "LE"
		lnResultado = 89
	CASE ALLTRIM(tcTipoDoc) == "LC"
		lnResultado = 90
	CASE ALLTRIM(tcTipoDoc) == "CIE"
		lnResultado = 91
	CASE ALLTRIM(tcTipoDoc) == "PAS"
		lnResultado = 94
	CASE ALLTRIM(tcTipoDoc) == "DNI"
		lnResultado = 96
ENDCASE

RETURN lnResultado
ENDPROC
PROCEDURE fe_get_tipocbte_afip
PARAMETERS tc_letra

DO CASE
	CASE ALLTRIM(Thisform.datos_cbtes.cbte) == "FC"
		DO CASE
			CASE ALLTRIM(tc_letra) == "A"
				RETURN 1
			CASE ALLTRIM(tc_letra) == "B"
				RETURN 6
			CASE ALLTRIM(tc_letra) == "C" 
				RETURN 11
		ENDCASE
	CASE ALLTRIM(Thisform.datos_cbtes.cbte) == "ND"
		DO CASE
			CASE ALLTRIM(tc_letra) == "A"
				RETURN 2
			CASE ALLTRIM(tc_letra) == "B"
				RETURN 7
			CASE ALLTRIM(tc_letra) == "C"
				RETURN 12
		ENDCASE
	CASE ALLTRIM(Thisform.datos_cbtes.cbte) == "NC"
		DO CASE
			CASE ALLTRIM(tc_letra) == "A"
				RETURN 3
			CASE ALLTRIM(tc_letra) == "B"
				RETURN 8
			CASE ALLTRIM(tc_letra) == "C"
				RETURN 13
		ENDCASE	
ENDCASE

RETURN -1
ENDPROC
PROCEDURE fe_set_cae
LOCAL loCommand, lcSql
LOCAL loDT, ldFecVto
LOCAL lcAnio, lcMes, lcDia

loDT = CREATEOBJECT("datetime")
loCommand = CREATEOBJECT("odbc_command")
lcSql = ""

lcAnio = SUBSTR(Thisform.aut_cae_vto, 1, 4)
lcMes = SUBSTR(Thisform.aut_cae_vto, 5, 2)
lcDia = SUBSTR(Thisform.aut_cae_vto, 7, 2)

lcSql = "update ventascab "
lcSql = lcSql + "set "
lcSql = lcSql + "	ptoVta = " + ALLTRIM(STR(Thisform.ptovta)) + ", "
lcSql = lcSql + "	numCbte = " + ALLTRIM(STR(Thisform.nrocbte)) + ", "
lcSql = lcSql + "	aut_CAE = '" + ALLTRIM(Thisform.aut_cae) + "', "
lcSql = lcSql + "	aut_CAE_vto = " + loDT.toMySql(CTOD(lcDia + "/" + lcMes + "/" + lcAnio)) + ", "
lcSql = lcSql + "	aut_Resultado = '" + ALLTRIM(Thisform.aut_resultado) + "', "
lcSql = lcSql + "	aut_Motivo = '" + ALLTRIM(Thisform.aut_motivo) + "', "
lcSql = lcsql + "	aut_tipoCbte = '" + REPLICATE("0", 2 - LEN(ALLTRIM(STR(Thisform.fe.F1CabeceraCbteTipo)))) + ALLTRIM(STR(Thisform.fe.F1CabeceraCbteTipo)) + "' "
lcSql = lcSql + "where idVentasC = " + ALLTRIM(STR(Thisform.datos_cbtes.idventasc))

goConn.BeginTransaction()

loCommand.ActiveConnection = goConn.ActiveConnection
loCommand.CommandText = lcSql

IF !loCommand.Execute() THEN
	MESSAGEBOX(loCommand.ErrorMessage, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

lcSql = "update cc_cli set nroCbte = " + ALLTRIM(STR(Thisform.nrocbte)) + " "
lcSql = lcSql + "WHERE idVentasC = " + ALLTRIM(STR(Thisform.datos_cbtes.idventasc))

loCommand.ActiveConnection = goConn.ActiveConnection
loCommand.CommandText = lcSql

IF !loCommand.Execute() THEN
	goConn.Rollback()
	MESSAGEBOX(loCommand.ErrorMessage, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

goConn.Commit()

Thisform.datos_cbtes.ptovta = Thisform.ptovta
Thisform.datos_cbtes.numcbte = Thisform.nrocbte

RETURN .T.


ENDPROC
PROCEDURE enviar_wsafipfe
LOCAL llRes
LOCAL lnPtoVta
LOCAL lnTipoDoc, lcTipoDoc
LOCAL lnRetAlva
LOCAL lnCantIVA
LOCAL lnImpBase21
LOCAL lnImpBase105
LOCAL lcNumero
LOCAL lcMensaje
LOCAL lnModo
LOCAL lnTotalIVA
LOCAL lnImpBaseSIVA
LOCAL lnIndice

lnTipoDoc = 0
lcTipoDoc = ""
lnPtoVta = INT(VAL(getConfig("PTOVTA")))
lnRetAlva = 0
lnCantIVA = 0
lnImpBase21 = 0
lnImpBase105 = 0
lnImpBaseSIVA = 0
lcNumero = ""
lcMensaje = ""
lnTotalIVA = 0.00
lnIndice = 0

lcTipoDoc = Thisform.datos_cbtes.tipodoc

&& Tengo que acordarme que en el tercer parámetro tengo que pasar
&& la ruta y el nombre de archivo del certificado.

lnModo = IIF(getGlobalCFG("FEDEBUG"), 0, 1)
llRes = Thisform.fe.iniciar(lnModo, getGlobalCFG("FECUIT"), SYS(5) + SYS(2003) + "\wsafip\" + getGlobalCFG("FE_FILE"), ALLTRIM(getGlobalCFG("FE_LIC")))
&&llRes = Thisform.fe.iniciar(0, "20364791969", SYS(5) + SYS(2003) + "\Release\SISCOM_BETA\wsafip\20364791969.pfx", "")

IF !llRes THEN
	MESSAGEBOX("Falló al iniciar: " + Thisform.fe.ultimoMensajeError, 0+32, Thisform.Caption)
	RETURN .F.
ENDIF

Thisform.fe.ArchivoCertificadoPassWord = ALLTRIM(getGlobalCFG("FE_PWD"))
IF !Thisform.ticket_valido() THEN
	MESSAGEBOX("No se pudo generar Ticket de Acceso", 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

Thisform.fe.ArchivoXMLRecibido = SYS(5) + SYS(2003) + "\wsafip\xml\rec_" + ALLTRIM(STR(YEAR(DATETIME()))) + ;
	ALLTRIM(STR(MONTH(DATETIME()))) + ALLTRIM(STR(DAY(DATETIME()))) + ALLTRIM(STR(HOUR(DATETIME()))) + ;
	ALLTRIM(STR(MINUTE(DATETIME()))) + ALLTRIM(STR(SEC(DATETIME()))) + ".xml"
	
Thisform.fe.archivoXMLEnviado = SYS(5) + SYS(2003) + "\wsafip\xml\env_" + ALLTRIM(STR(YEAR(DATETIME()))) + ;
	ALLTRIM(STR(MONTH(DATETIME()))) + ALLTRIM(STR(DAY(DATETIME()))) + ALLTRIM(STR(HOUR(DATETIME()))) + ;
	ALLTRIM(STR(MINUTE(DATETIME()))) + ALLTRIM(STR(SEC(DATETIME()))) + ".xml"
	
lnRetAlva = Thisform.fe.f1CompUltimoAutorizado(lnPtoVta, Thisform.fe_get_tipocbte_afip(ALLTRIM(lcTipoDoc)))

Thisform.fe.F1CabeceraCantReg = 1
Thisform.fe.F1CabeceraPtoVta = lnPtoVta
Thisform.fe.F1CabeceraCbteTipo = Thisform.fe_get_tipocbte_afip(Thisform.datos_cbtes.tipodoc)
Thisform.fe.F1DetalleDocTipo = Thisform.fe_convertir_tipodoc(Thisform.cli_tipodoc)
Thisform.fe.F1DetalleDocNro = Thisform.cli_cuit
Thisform.fe.F1DetalleCbteDesde = lnRetAlva + 1
Thisform.fe.F1DetalleCbteHasta = lnretAlva + 1

Thisform.fe.F1DetalleCbteFch = ALLTRIM(STR(YEAR(DATE()))) + IIF(LEN(ALLTRIM(STR(MONTH(DATE())))) < 2, "0" + ALLTRIM(STR(MONTH(DATE()))), ALLTRIM(STR(MONTH(DATE())))) + ;
	IIF(LEN(ALLTRIM(STR(DAY(DATE())))) < 2, "0" + ALLTRIM(STR(DAY(DATE()))), ALLTRIM(STR(DAY(DATE()))))

&& Tengo que calcular la suma del neto de los articulos con 21 de IVA y con el 10.5 de IVA por separado

SELECT cur_detalle
GO TOP
DO WHILE !EOF("cur_detalle")
	IF cur_detalle.alicIVA = 21 THEN
		lnImpBase21 = lnImpBase21 + cur_detalle.TotNeto
	ENDIF
	
	IF cur_detalle.alicIVA = 10.5 THEN
		lnImpBase105 = lnImpBase105 + cur_detalle.TotNeto
	ENDIF
	
	IF cur_detalle.alicIVA = 0 THEN
		lnImpBaseSIVA = lnImpBaseSIVA + cur_detalle.TotNeto
	ENDIF

	SELECT cur_detalle
	SKIP
ENDDO

lnIndice = 0
lnTotalIVA = 0.00
IF lnImpBase21 <> 0 THEN
	Thisform.fe.F1DetalleIvaItemCantidad = 1
	Thisform.fe.f1IndiceItem = lnIndice 
	Thisform.fe.F1DetalleIvaId = 5
	Thisform.fe.F1DetalleIvaBaseImp = ROUND(lnImpBase21, 2)
	Thisform.fe.F1DetalleIvaImporte = Thisform.datos_cbtes.lnncimpiva21
	lnTotalIVA = lnTotalIVA + Thisform.datos_cbtes.lnncimpiva21
	lnIndice = lnIndice + 1
ENDIF

IF lnImpBase105 <> 0 THEN
	Thisform.fe.F1DetalleIvaItemCantidad = Thisform.fe.F1DetalleIvaItemCantidad + 1
	Thisform.fe.f1IndiceItem = lnIndice
	Thisform.fe.F1DetalleIvaId = 4
	Thisform.fe.F1DetalleIvaBaseImp = ROUND(nImpBase105, 2)
	Thisform.fe.F1DetalleIvaImporte = Thisform.datos_cbtes.lnncimpiva105
	lnTotalIVA = lnTotalIVA + Thisform.datos_cbtes.lnncimpiva105
	lnIndice = lnIndice + 1
ENDIF

IF lnImpBaseSIVA <> 0 THEN
	Thisform.fe.F1DetalleIvaItemCantidad = Thisform.fe.F1DetalleIvaItemCantidad + 1
	Thisform.fe.f1IndiceItem = lnIndice
	Thisform.fe.F1DetalleIvaId = 3
	Thisform.fe.F1DetalleIvaBaseImp = ROUND(lnImpBaseSIVA, 2)
ENDIF

&& Agrego los conceptos de IIBB

IF Thisform.Contenido.paginas.page2.txtNCPorIIBB.Value <> 0 THEN
	Thisform.FE.F1DetalleTributoItemCantidad = 1
	Thisform.FE.f1IndiceItem   = 0
	Thisform.FE.F1DetalleTributoId  = 2
	Thisform.FE.F1DetalleTributoDesc = "IIBB Pcia Bs AS"
	Thisform.FE.F1DetalleTributoBaseImp = Thisform.datos_cbtes.lnncimpfinal
	Thisform.FE.F1DetalleTributoAlic = Thisform.datos_cbtes.lnncporiibb
	Thisform.FE.F1DetalleTributoImporte = Thisform.datos_cbtes.lnncimpiibb
ENDIF

Thisform.fe.F1DetalleConcepto = 1
Thisform.fe.F1DetalleImpNeto = ROUND(Thisform.datos_cbtes.lnncimpfinal, 2)
Thisform.fe.F1DetalleImpTotalConc = 0
Thisform.fe.F1DetalleImpIva = lnTotalIVA
Thisform.fe.F1DetalleImpOpEx = 0
Thisform.fe.F1DetalleImpTrib = Thisform.FE.F1DetalleTributoImporte
Thisform.fe.F1DetalleMonId = "PES"
Thisform.fe.F1DetalleMonCotiz = 1
Thisform.fe.F1DetalleImpTotal = Thisform.datos_cbtes.lnnctotfact

llRes = Thisform.fe.f1CAESolicitar()

IF llRes THEN
	lcNumero = REPLICATE("0", 4 - LEN(ALLTRIM(STR(lnPtoVta)))) + ALLTRIM(STR(lnPtoVta)) + "-" + ;
		REPLICATE("0", 8 - LEN(ALLTRIM(STR(Thisform.fe.F1RespuestaDetalleCbteDesde)))) + ALLTRIM(STR(Thisform.fe.F1RespuestaDetalleCbteDesde))
	
	Thisform.ptovta = lnPtoVta
	Thisform.nrocbte = INT(VAL(Thisform.fe.F1RespuestaDetalleCbteDesdeS))
	
	lcMensaje = "CAE: " + Thisform.fe.F1RespuestaDetalleCae + CHR(13)+ CHR(10)
	lcMensaje = lcMensaje + "FECHA VTO: " + Thisform.fe.F1RespuestaDetalleCaeFchVto + CHR(13) + CHR(10)
	lcMensaje = lcMensaje + "MOTIVO: " + Thisform.fe.F1RespuestaDetalleObservacionMsg + CHR(13) + CHR(10)
	lcMensaje = lcMensaje + "PROCESO: " + Thisform.fe.F1RespuestaReProceso
	MESSAGEBOX(lcMensaje, 0+64, Thisform.Caption)
	
	Thisform.aut_numero = lcNumero
	Thisform.aut_cae = Thisform.fe.F1RespuestaDetalleCae
	Thisform.aut_cae_vto = Thisform.fe.F1RespuestaDetalleCaeFchVto
	Thisform.aut_resultado = Thisform.fe.F1RespuestaResultado
	Thisform.aut_motivo = Thisform.fe.F1RespuestaDetalleObservacionMsg
ELSE
	IF !(ISNULL(Thisform.fe.F1RespuestaReProceso) .OR. Thisform.fe.F1RespuestaReProceso == "R") THEN
		lcNumero = REPLICATE("0", 4 - LEN(ALLTRIM(STR(lnPtoVta)))) + ALLTRIM(STR(lnPtoVta)) + "-" + ;
			REPLICATE("0", 4 - LEN(ALLTRIM(STR(Thisform.fe.F1RespuestaDetalleCbteDesde)))) + ALLTRIM(STR(Thisform.fe.F1RespuestaDetalleCbteDesde))
		
		&& lcMensaje = "CAE: " + Thisform.fe.F1RespuestaDetalleCae + CHR(13)+ CHR(10)
		lcMensaje = "ATENCION: Factura rechazada por el AFIP" + CHR(13) + CHR(10)
		&&lcMensaje = lcMensaje + "FECHA VTO: " + Thisform.fe.F1RespuestaDetalleCaeFchVto + CHR(13) + CHR(10)		
		lcMensaje = lcMensaje + "MOTIVO: " + Thisform.fe.F1RespuestaDetalleObservacionMsg + CHR(13) + CHR(10)
		&&lcMensaje = lcMensaje + "PROCESO: " + Thisform.fe.F1RespuestaReProceso
		MESSAGEBOX(lcMensaje, 0+64, Thisform.Caption)
		MESSAGEBOX("Recomendación: Elimine este comprobante y vuelva a generarlo por favor.", 0+48, Thisform.Caption)
		
		Thisform.aut_numero = lcNumero
		Thisform.aut_cae = Thisform.fe.F1RespuestaDetalleCae
		Thisform.aut_cae_vto = Thisform.fe.F1RespuestaDetalleCaeFchVto
		Thisform.aut_resultado = Thisform.fe.F1RespuestaResultado
		Thisform.aut_motivo = Thisform.fe.F1RespuestaDetalleObservacionMsg
		RETURN .F.
	ELSE
		lcMensaje = "MOTIVO: " + Thisform.fe.F1RespuestaDetalleObservacionMsg + CHR(13) + CHR(10)
		lcMensaje = lcMensaje + "ERROR: " + Thisform.fe.f1ErrorMsg1 + CHR(13) + CHR(10)
		lcMensaje = lcMensaje + "ULTIMO: " + Thisform.fe.UltimoMensajeError
		MESSAGEBOX(lcMensaje, 0+64, Thisform.Caption)
		
		Thisform.aut_numero = lcNumero
		Thisform.aut_cae = ""
		Thisform.aut_cae_vto = ""
		Thisform.aut_resultado = Thisform.fe.F1RespuestaResultado
		Thisform.aut_motivo = Thisform.fe.F1RespuestaDetalleObservacionMsg
		RETURN .F.
	ENDIF
ENDIF

RETURN .T.
ENDPROC
PROCEDURE calc_digito_verificador
&& El prefijo E1, E2, En... indica a la etapa del algoritmo que pertenece el coeficiente

PARAMETERS tcCodigo

LOCAL lnDigito
LOCAL lnSumaE1
LOCAL lnSumaE3
LOCAL lnProductoE2
LOCAL lnSumaE4
LOCAL lnMin
LOCAL lnPos

lnDigito = 0
lnSumaE1 = 0
lnSumaE3 = 0
lnSumaE4 = 0
lnMin = 0

FOR i = 1 TO LEN(ALLTRIM(tcCodigo))
	lnDigito = INT(VAL(SUBSTR(tcCodigo, i, 1)))
	
	IF MOD(i, 2) <> 0 THEN
		&& Etapa 1 (posiciones impares)
		lnSumaE1 = lnSumaE1 + lnDigito
	ELSE
		&& Etapa 3 (posiciones pares)
		lnSumaE3 = lnSumaE3 + lnDigito
	ENDIF
NEXT i

lnProductoE2 = lnSumaE1 * 3 && Etapa 2
lnSumaE4 = lnProductoE2 + lnSumaE3 && Etapa 4

&& Etapa 5
lnPos = 0
FOR i = 1 TO LEN(ALLTRIM(tcCodigo))
	lnDigito = INT(VAL(SUBSTR(tcCodigo, i, 1)))
	
	IF MOD(lnSumaE4 + lnDigito, 10) = 0 THEN
		IF lnPos = 0 THEN
			lnMin = lnDigito
		ELSE
			IF lnDigito < lnMin THEN
				lnMin = lnDigito
			ENDIF
		ENDIF
		
		lnPos = lnPos + 1
	ENDIF
NEXT i

RETURN lnMin
ENDPROC
PROCEDURE ticket_valido
LOCAL llTkValido
LOCAL lcTicket
LOCAL lcFileTicket
LOCAL lcTK
LOCAL hndFile

llTkValido = .F.
lcTicket = ""
lcTK = ""
lcFileTicket = getGlobalCFG("FE_TICKACC")

IF FILE(ALLTRIM(lcFileTicket)) THEN
	hndFile = FOPEN(lcFileTicket, 12)
	IF hndFile < 0 THEN
		=MESSAGEBOX("Error al intentar leer el ticket de acceso", 0+48, Thisform.Caption)
		=FCLOSE(hndFile)
	ELSE
		=FCLOSE(hndFile)
		
		lcTK = FILETOSTR(ALLTRIM(lcFileTicket))
		Thisform.fe.f1RestaurarTicketAcceso(lcTK)
		
		IF Thisform.fe.f1TicketEsValido THEN
			llTkValido = .T.
		ELSE
			llTkValido = .F.
		ENDIF
	ENDIF
	
	IF !llTkValido THEN
		DELETE FILE ALLTRIM(lcFileTicket)
		
		IF Thisform.fe.f1ObtenerTicketAcceso() THEN
			lcTK = Thisform.fe.f1GuardarTicketAcceso()
			hndFile = FCREATE(lcFileTicket)
			
			IF hndFile < 0 THEN
				=MESSAGEBOX("Error al generar el archivo, por favor verifique la ruta se encuentre accesible", 0+16, Thisform.Caption)
			ELSE
				=FWRITE(hndFile, lcTK)
				llTkValido = .T.
			ENDIF
			
			=FCLOSE(hndFile)
		ELSE
			MESSAGEBOX("Fallo de acceso: " + ALLTRIM(Thisform.fe.ultimoMensajeError), 0+16, Thisform.Caption)
			llTkValido = .F.
		ENDIF
	ENDIF
ELSE
	IF Thisform.fe.f1ObtenerTicketAcceso() THEN
		lcTK = Thisform.fe.f1GuardarTicketAcceso()
		hndFile = FCREATE(lcFileTicket)
		
		IF hndFile < 0 THEN
			=MESSAGEBOX("Error al generar el archivo, por favor verifique la ruta se encuentre accesible", 0+48, Thisform.Caption)
		ELSE
			=FWRITE(hndFile, lcTK)
			llTkValido = .T.
		ENDIF
		
		=FCLOSE(hndFile)
	ELSE
		MESSAGEBOX("Fallo de acceso: " + ALLTRIM(Thisform.fe.ultimoMensajeError), 0+16, Thisform.Caption)
		llTkValido = .F.			
	ENDIF
ENDIF

RETURN llTkValido
ENDPROC
PROCEDURE imprimir
LOCAL m.NroCli, m.RazSoc, m.Telefono, m.direccion, m.localidad, m.codPostal, m.pcia, m.TipoIVA, m.nroCUIT
LOCAL m.Total, m.tipoDoc, m.NroCbte, m.Fecha, m.leyenda, m.fecVto, m.tipoDoc, m.ptoVta
LOCAL m.porDesc1, m.porDesc2, m.porDesc3, m.porDesc4
LOCAL m.impDesc1, m.impDesc2, m.impDesc3, m.impDesc4
LOCAL m.porIIBB, m.impIIBB, m.observ
LOCAL m.porIVA105, m.impIVA105, m.porIVA21, m.impIVA21, m.impNeto, m.impFinal
LOCAL m.cae, m.caevto
LOCAL lcAnio, lcMes, lcDia
LOCAL lcSql, loResult, lcPrinterName, lnCantCpia
LOCAL m.codigoCbte, m.barcode, m.code
LOCAL lnIdNum, m.vendedor, m.nroOC, m.NroRto, m.condPago
LOCAL m.porRec, loPDF, lcFileName
LOCAL lcNomEmp

lcNomEmp = getconfig("NOMEMP")
loResult = CREATEOBJECT("odbc_result")
lcSql = ""

lcSql = "SELECT clientes.*, localidad.descripcio as descLoc, localidad.codPostal, provincias.descripcio as pcia, sitiva.descripcio as sitiva "
lcSql = lcSql + "FROM clientes INNER JOIN localidad ON localidad.idLocalid = clientes.idLocalid "
lcSql = lcSql + "	INNER JOIN provincias ON provincias.idProvin = localidad.idProvin "
lcSql = lcSql + "	INNER JOIN sitiva ON sitiva.idsitiva = clientes.idsitiva "
lcSql = lcSql + "WHERE clientes.idCliente = " + ALLTRIM(STR(thisform.contenido.sel_cliente.valcpoid))
lcSql = lcSql + " AND sitiva.idsitiva = " + ALLTRIM(STR(Thisform.datos_cbtes.idsitiva))

loResult.ActiveConnection = goConn.ActiveConnection
loResult.Cursor_Name = "cur_cli"

IF !loResult.OpenQuery(lcSql) THEN
	MESSAGEBOX(loResult.Error_Message, 0+48, thisform.Caption)
	RETURN .F.
ENDIF

SELECT cur_cli
m.NroCli = cur_cli.idCliente
m.RazSoc = ALLTRIM(thisform.cli_razsoc)
m.Telefono = ALLTRIM(cur_cli.telefono)
m.direccion = ALLTRIM(cur_cli.direccion)
m.localidad = ALLTRIM(cur_cli.descLoc)
m.codPostal = ALLTRIM(cur_cli.codPostal)
m.pcia = ALLTRIM(cur_cli.pcia)
m.nroCUIT = ALLTRIM(thisform.cli_cuit)
m.TipoIVA = ALLTRIM(cur_cli.sitiva)
m.codigoCbte = REPLICATE("0", 2 - LEN(ALLTRIM(STR(Thisform.fe.F1CabeceraCbteTipo)))) + ALLTRIM(STR(Thisform.fe.F1CabeceraCbteTipo))
m.barcode = ""
m.code = ""

loResult.close_query()

m.Total = 0.00
m.tipoDoc = ""
m.leyenda = ""
m.Fecha = DATETIME()
m.porIVA105 = 0.00
m.porIVA21 = 0.00
m.impIVA105 = 0.00
m.impIVA21 = 0.00
m.impNeto = 0.00
m.impFinal = 0.00
m.fecVto = DATE()
m.tipoDoc = this.datos_cbtes.tipodoc
m.ptovta = thisform.ptovta
m.porIIBB = 0.00
m.impIIBB = 0.00
lcPrinterName = ""
lnCantCpia = 0
m.observ = thisform.datos_cbtes.observ
m.total = thisform.contenido.paginas.page2.txtNcTotFact.Value
m.porRec = 0.00
m.NroRto = ""
m.condPago = ALLTRIM(thisform.cli_condpago)

&& Levanto el talonario del numerador solo para tomar la configuración de la impresora
lcSql = "select * from numerador where cbte = '" + ALLTRIM(Thisform.cbte) + "' and tipoDoc = '" + ALLTRIM(m.tipoDoc) + "' AND ptoVta = " + ALLTRIM(STR(m.ptoVta))

loResult.ActiveConnection = goConn.ActiveConnection
loResult.Cursor_Name = "cur_num"
loResult.OpenQuery(lcSql)

SELECT cur_num
lnIdNum = cur_num.idNum

loResult.close_query()

lcSql = "SELECT * FROM impresoras WHERE idNum = " + ALLTRIM(STR(lnIdNum)) + " AND hostName = '" + ALLTRIM(SYS(0)) + "'"
loResult.ActiveConnection = goConn.ActiveConnection
loResult.Cursor_Name = "cur_imp"

IF !loResult.OpenQuery(lcSql) THEN
	MESSAGEBOX(loResult.Error_Message, 0+48, Thisform.Caption)
	RETURN
ENDIF

SELECT cur_imp
IF RECCOUNT("cur_imp") = 0 THEN
	MESSAGEBOX("La impresora no está configurada en este puesto de trabajo", 0+48, Thisform.Caption)
	RETURN
ENDIF

lcPrinterName = ALLTRIM(cur_imp.impresora)
lnCantCpia = cur_imp.copias

loResult.Close_Query()

m.NroCbte = REPLICATE("0", 4 - LEN(ALLTRIM(STR(thisform.ptovta)))) + ALLTRIM(STR(thisform.ptovta)) + "-" + ;
	REPLICATE("0", 8 - LEN(ALLTRIM(STR(thisform.nrocbte)))) + ALLTRIM(STR(thisform.nrocbte))
	
m.Leyenda = "NOTA DE CREDITO"

m.porDesc1 = thisform.contenido.paginas.page2.txtNCPorDto1.Value
m.porDesc2 = thisform.contenido.paginas.page2.txtNCPorDto2.Value
m.porDesc3 = thisform.contenido.paginas.page2.txtNCPorDto3.Value
m.porDesc4 = thisform.contenido.paginas.page2.txtNCPorDto4.Value
m.impDesc1 = thisform.contenido.paginas.page2.txtNCImpDto1.Value
m.impDesc2 = thisform.contenido.paginas.page2.txtNCImpDto2.Value
m.impDesc3 = thisform.contenido.paginas.page2.txtNCImpDto3.Value
m.impDesc4 = thisform.contenido.paginas.page2.txtNCImpDto4.Value
m.porIVA105 = 10.5
m.porIVA21 = 21
m.impIVA105 = thisform.contenido.paginas.page2.txtNCImpIVA105.Value
m.impIVA21 = thisform.contenido.paginas.page2.txtNCImpIVA21.Value
&&m.impNeto = thisform.contenido.paginas.page2.txtNCImpNeto.Value
m.impNeto = thisform.contenido.paginas.page2.txtNCImpFinal.Value
m.porIIBB = thisform.contenido.paginas.page2.txtNCPorIIBB.Value
m.impIIBB = thisform.contenido.paginas.page2.txtNCImpIIBB.Value

m.vendedor = thisform.nombre_usuario
m.nroOC = ""

lcAnio = SUBSTR(Thisform.aut_cae_vto, 1, 4)
lcMes = SUBSTR(Thisform.aut_cae_vto, 5, 2)
lcDia = SUBSTR(Thisform.aut_cae_vto, 7, 2)

m.cae = thisform.aut_cae
m.caevto = lcDia + "/" + lcMes + "/" + lcAnio

&& Generación del código de barra
m.barcode = ALLTRIM(Thisform.cli_cuit)
m.barcode = m.barcode + ALLTRIM(m.codigoCbte)
m.barcode = m.barcode + REPLICATE("0", 4 - LEN(ALLTRIM(STR(m.ptovta)))) + ALLTRIM(STR(m.ptovta))
m.barcode = m.barcode + ALLTRIM(m.cae)
m.barcode = m.barcode + ALLTRIM(lcAnio)
m.barcode = m.barcode + REPLICATE("0", 2 - LEN(ALLTRIM(lcMes))) + ALLTRIM(lcMes)
m.barcode = m.barcode + REPLICATE("0", 2 - LEN(ALLTRIM(lcDia))) + ALLTRIM(lcDia)
m.barcode = m.barcode + ALLTRIM(STR(Thisform.calc_digito_verificador(m.barcode)))
m.code = m.barcode
m.barcode = getcodbarras(m.barcode)

&& Creo el cursor cur_aux para imprimir el detalle del comprobante
&& USE IN cur_aux
SELECT cur_aux
ZAP

SELECT cur_detalle
GO TOP
DO WHILE !EOF("cur_detalle")
	SELECT cur_aux
	APPEND BLANK
	REPLACE cur_aux.idVentasD WITH cur_detalle.idVentasD
	REPLACE cur_aux.idArticulo WITH cur_detalle.idArticulo ADDITIVE
	REPLACE cur_aux.codArt WITH cur_detalle.codArt ADDITIVE
	REPLACE cur_aux.descripcio WITH cur_detalle.descripcio ADDITIVE
	REPLACE cur_aux.cantidad WITH cur_detalle.cantidad ADDITIVE
	REPLACE cur_aux.cantNC WITH 0 ADDITIVE
	REPLACE cur_aux.nroPart WITH cur_detalle.nroPart ADDITIVE
	REPLACE cur_aux.costoRep WITH cur_detalle.costoRep ADDITIVE
	REPLACE cur_aux.porDesc1 WITH cur_detalle.porDesc1 ADDITIVE
	REPLACE cur_aux.porDesc2 WITH cur_detalle.porDesc2 ADDITIVE
	REPLACE cur_aux.porDesc3 WITH cur_detalle.porDesc3 ADDITIVE
	REPLACE cur_aux.porDesc4 WITH cur_detalle.porDesc4 ADDITIVE
	REPLACE cur_aux.impDesc1 WITH cur_detalle.impDesc1 ADDITIVE
	REPLACE cur_aux.impDesc2 WITH cur_detalle.impDesc2 ADDITIVE
	REPLACE cur_aux.impDesc3 WITH cur_detalle.impDesc3 ADDITIVE
	REPLACE cur_aux.impDesc4 WITH cur_detalle.impDesc4 ADDITIVE
	REPLACE cur_aux.pDtoVta1 WITH cur_detalle.pDtoVta1 ADDITIVE
	REPLACE cur_aux.pDtoVta2 WITH cur_detalle.pDtoVta2 ADDITIVE
	REPLACE cur_aux.pDtoVta3 WITH cur_detalle.pDtoVta3 ADDITIVE
	REPLACE cur_aux.pDtoVta4 WITH cur_detalle.pDtoVta4 ADDITIVE
	REPLACE cur_aux.iDtoVta1 WITH cur_detalle.iDtoVta1 ADDITIVE
	REPLACE cur_aux.iDtoVta2 WITH cur_detalle.iDtoVta2 ADDITIVE
	REPLACE cur_aux.iDtoVta3 WITH cur_detalle.iDtoVta3 ADDITIVE
	REPLACE cur_aux.iDtoVta4 WITH cur_detalle.iDtoVta4 ADDITIVE
	REPLACE cur_aux.totNeto WITH cur_detalle.totNeto ADDITIVE
	REPLACE cur_aux.alicIVA WITH cur_detalle.alicIVA ADDITIVE
	REPLACE cur_aux.impIVA WITH cur_detalle.impIVA ADDITIVE
	REPLACE cur_aux.subTotal WITH cur_detalle.subTotal ADDITIVE
	REPLACE cur_aux.impNeto WITH cur_detalle.impNeto ADDITIVE
	REPLACE cur_aux.prArtic WITH cur_detalle.prArtic ADDITIVE
	REPLACE cur_aux.pRecVta WITH cur_detalle.pRecVta ADDITIVE
	REPLACE cur_aux.iRecVta WITH cur_detalle.iRecVta ADDITIVE
	
	SELECT cur_detalle
	SKIP
ENDDO

SELECT cur_aux
GO TOP

IF thisform.printcbte THEN		
	SET PRINTER TO NAME ALLTRIM(lcPrinterName)

	FOR i = 1 TO lnCantCpia 
		IF ALLTRIM(This.datos_cbtes.tipodoc) == "X" THEN
			&& Imprime un comprobante de tipo "X"
			REPORT FORM "reppto.frx" TO PRINTER NOCONSOLE
		ELSE
			IF ALLTRIM(This.datos_cbtes.tipodoc) == "A" THEN
				&& Imprime el comprobante de tipo "A"
				REPORT FORM "repcbtesvta.frx" TO PRINTER NOCONSOLE
			ELSE
				&& Imprime el comprobante de tipo "B"
				REPORT FORM "repcbtesvta_b.frx" TO PRINTER NOCONSOLE
			ENDIF
		ENDIF 
	NEXT
ENDIF

IF thisform.envcbte THEN
	lcFileName = SYS(5) + SYS(2003) + "\wsafip\ComprobantesPDF\" + this.cbte + "_" + m.NroCbte + ".pdf"
	
	loPDF = CREATEOBJECT("Bullzip.PDFPrinterSettings")
		loPDF.SetValue('output', lcFileName)
		loPDF.SetValue('DisableOptionDialog', 'no') 
		loPDF.SetValue('ConfirmOverwrite', 'no')
		loPDF.SetValue('Showsettings', 'never') 
		loPDF.SetValue('ShowSaveAS', 'nofile') 
		loPDF.SetValue('ShowPdf', 'no') 
		loPDF.WriteSettings(.t.)
	
	SET CONSOLE OFF
	SET PRINTER TO NAME("Bullzip PDF Printer")
	IF ALLTRIM(This.datos_cbtes.tipodoc) == "A" THEN
		&& Imprime el comprobante de tipo "A"
		SELECT cur_aux
		REPORT FORM "repcbtesvta.frx" NOCONSOLE TO PRINTER
	ELSE
		&& Imprime el comprobante de tipo "B"
		SELECT cur_aux
		REPORT FORM "repcbtesvta_b.frx" NOCONSOLE TO PRINTER
	ENDIF
	SET PRINTER TO DEFAULT
	SET CONSOLE ON
	
	WAIT WINDOW "El archivo PDF se está generando, aguarde unos segundos..." NOWAIT
	DO WHILE !FILE(lcFileName)
		
	ENDDO
	
	&&MESSAGEBOX("Archivo generado en " + lcFileName, 0+64, thisform.Caption)
	
	TEXT TO lcMailMsg NOSHOW
	Estimado cliente,
	
	Le adjuntamos el comprobante electrónico de su compra en formato PDF.
	
	Muchas gracias!
	
	
	
	Saludos cordiales,
	
	ENDTEXT
	lcMailMsg = lcMailMsg + lcNomEmp
	
	&& Procedo a hacer el envío de mail
	DO LOCFILE("FoxyPreviewer.App")
	WITH _screen.oFoxyPreviewer	
		.cEmailType = "PDF"
		.nEmailMode = 2
		.cEMailTo = thisform.mailfc
		.cSMTPServer = "smtp.gmail.com"
		.cEmailFrom = lcNomEmp + "<noreply.lpsoft@gmail.com>"
		.cEMailSubject = "Comprobante Electrónico " + this.cbte + " " + m.NroCbte
		.nSMTPPort = 465
		.lSMTPUseSSL = .t.
		.cSMTPUserName = "noreply.lpsoft@gmail.com"
		.cSMTPPassword = "LP2523eo"
		.lReadReceipt  = .F.
		.lPriority = .F.
		.cEmailBody = lcMailMsg
		.SendEmailUsingCDO(lcFileName)
	ENDWITH	
ENDIF

DO FoxyPreviewer.App WITH "Release"

RETURN .T.
ENDPROC
PROCEDURE contenido.btnGrabar.Click
LOCAL lnResp

thisform.datos_cbtes.lnncimpdesc1 = thisform.contenido.paginas.page2.txtNCImpDto1.Value
thisform.datos_cbtes.lnncimpdesc2 = thisform.contenido.paginas.page2.txtNCImpDto2.Value
thisform.datos_cbtes.lnncimpdesc3 = thisform.contenido.paginas.page2.txtNCImpDto3.Value
thisform.datos_cbtes.lnncimpdesc4 = thisform.contenido.paginas.page2.txtNCImpDto4.Value
thisform.datos_cbtes.lnncimpfinal = thisform.contenido.paginas.page2.txtNCImpFinal.Value
thisform.datos_cbtes.lnncporiibb = thisform.contenido.paginas.page2.txtNCPorIIBB.Value
thisform.datos_cbtes.lnncimpiibb = thisform.contenido.paginas.page2.txtNCImpIIBB.Value
thisform.datos_cbtes.lnncimpiva105 =  thisform.contenido.paginas.page2.txtNCImpIVA105.Value
thisform.datos_cbtes.lnncimpiva21 = thisform.contenido.paginas.page2.txtNCImpIVA21.Value
thisform.datos_cbtes.lnncimpneto = thisform.contenido.paginas.page2.txtNCImpNeto.Value
thisform.datos_cbtes.lnnctotfact = thisform.contenido.paginas.page2.txtNCTotFact.Value
thisform.datos_cbtes.lnncpordto1 = thisform.contenido.paginas.page2.txtNCPorDto1.Value
thisform.datos_cbtes.lnncpordto2 = thisform.contenido.paginas.page2.txtNCPorDto2.Value
thisform.datos_cbtes.lnncpordto3 = thisform.contenido.paginas.page2.txtNCPorDto3.Value
thisform.datos_cbtes.lnncpordto4 = thisform.contenido.paginas.page2.txtNCPorDto4.Value
thisform.datos_cbtes.lnncporrec = thisform.contenido.paginas.page2.txtNCporRec.Value
thisform.datos_cbtes.lnncimprec = thisform.contenido.paginas.page2.txtNCimpRec.Value
thisform.datos_cbtes.poriva21 = IIF(thisform.datos_cbtes.lnncimpiva21 <> 0, 21, 0)
thisform.datos_cbtes.poriva105 = IIF(thisform.datos_cbtes.lnncimpiva105 <> 0, 10.5, 0)

thisform.datos_cbtes.cli_razsoc = thisform.cli_razsoc
thisform.datos_cbtes.cli_nrodoc = thisform.cli_cuit
thisform.datos_cbtes.cli_tipodoc = thisform.cli_idtipodoc
thisform.datos_cbtes.esfe = 1

IF !thisform.validardetalle() THEN
	RETURN .F.
ENDIF

Thisform.datos_cbtes.fecemision = DATETIME()
THisform.datos_cbtes.fecvto = DATETIME()

IF !thisform.datos_cbtes.grabar() THEN
	MESSAGEBOX(thisform.datos_cbtes.error_message, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

IF !thisform.enviar_wsafipfe() THEN
	MESSAGEBOX("Este comprobante no ha sido autorizado, por favor, vuelva a intentarlo desde la autorización diferida", 0+48, Thisform.Caption)
	
	Thisform.limpiar()
	
	RETURN .F.
ELSE
	IF thisform.fe_set_cae() THEN
		lnResp = MESSAGEBOX("¿Desea vincular esta nota de crédito " ;
			+ "al comprobante de origen?", 4+32, thisform.Caption)
		IF lnResp = 6 THEN
			thisform.datos_cbtes.vincular_cbte = .t.
		ELSE
			thisform.datos_cbtes.vincular_cbte = .f.
		ENDIF
	
		IF Thisform.datos_cbtes.grabar_ctacte() THEN
			Thisform.imprimir()
		ENDIF
	ENDIF
ENDIF

Thisform.limpiar()

RETURN .T.
ENDPROC


************************************************************
OBJETO: fe
************************************************************
*** PROPIEDADES ***
Top = 452
Left = 632
Height = 24
Width = 36
Name = "fe"

*** METODOS ***


************************************************************
OBJETO: cls_ncdev_fe
************************************************************
*** PROPIEDADES ***
Arial, 0, 9, 5, 15, 12, 32, 3, 0
Arial, 1, 8, 5, 14, 11, 29, 3, 0

*** METODOS ***


************************************************************
OBJETO: cls_cbtesnc_vtas
************************************************************
*** PROPIEDADES ***
idventasc = 0
idcliente = 
fecemision = {}
cbte = 
tipodoc = 
ptovta = 0
numcbte = 0
anulado = 0
impneto = 0.00
impfinal = 0.00
poriva21 = 0.00
impiva21 = 0.00
poriva105 = 0.00
impiva105 = 0.00
pordesc1 = 0.00
impdesc1 = 0.00
pordesc2 = 0.00
impdesc2 = 0.00
pordesc3 = 0.00
impdesc3 = 0.00
pordesc4 = 0.00
impdesc4 = 0.00
totfact = 0.00
saldo = 0.00
espendi = 0
usuario = 
fecha = {}
hostname = 
esdemo = .F.
demo_connection = 
error_message = 
printerdevice = 
observ = 
poriibb = 0.00
impiibb = 0.00
idcondpago = 0
idsitiva = 0
idvendedor = 0
procesado = 0
fecvto = {}
nro_item = 0
id_vta_origen = 0
lnncimpneto = 0.00
lnncimpdesc1 = 0.00
lnncimpdesc2 = 0.00
lnncimpdesc3 = 0.00
lnncimpdesc4 = 0.00
lnncimpfinal = 0.00
lnncimpiva21 = 0.00
lnncimpiva105 = 0.00
lnncporiibb = 0.00
lnncimpiibb = 0.00
lnnctotfact = 0.00
idcc_origen = 0
id_oper = 0
cant_copianc = 0
lnncpordto1 = 0.00
lnncpordto2 = 0.00
lnncpordto3 = 0.00
lnncpordto4 = 0.00
nrocbte = 
cbte_origen = 
tipodoc_origen = 
nrocbte_origen = 
fis_num_cbte = 
porrec = 0.00
imprec = 0.00
lnncporrec = 0.00
lnncimprec = 0.00
cli_razsoc = 
cli_tipodoc = 0
cli_nrodoc = 
esfe = 0
vincular_cbte = .F.
Name = "cls_cbtesnc_vtas"

*** METODOS ***
PROCEDURE grabar
* Tener en cuenta que al transacción deberá ser manejada desde donde se realiza la llamada.
* Este método devolverá .T. en caso de que se haya ejecutado correctamente o .F. en caso de que 
* se haya detectado algún error.

LOCAL lcSql, loCommand, loDT
LOCAL lnIdCC_Cli, loMovStock, lnIdVtaRel
LOCAL lnIdVentasD, lnOperacion

lcSql = ""
loCommand = CREATEOBJECT("odbc_command")
loDT = CREATEOBJECT("datetime")
loMovStock = CREATEOBJECT("cl_mov_stock")
lnIdCC_Cli = 0
lnIdVtaRel = 0
lnIdVentasD = 0
lnOperacion = 0

loMovStock.circuito = "S"
loMovStock.crear_cursor()
loMovStock.tipomov = "ENT"

this.cbte = "NC"
IF INT(VAL(getConfig("DEMO"))) = 1 THEN
	this.ptovta = 9999
ELSE
	this.ptovta = INT(VAL(getConfig("PTOVTA")))
ENDIF

IF EMPTY(this.tipodoc) .OR. ALLTRIM(this.tipodoc) == "" THEN
	this.calcuar_tipodoc()
ENDIF

IF this.esfe = 0 THEN 
	IF EMPTY(this.fis_num_cbte) THEN
		IF !this.calcular_nro_cbte() THEN
			RETURN .F.
		ENDIF
	ELSE
		&& Si la propiedad fis_num_cbte no es vacío, entonces, se debe tomar el número
		&& para grabar.
		&& this.nrocbte = this.fis_num_cbte
		this.numcbte = this.fis_num_cbte
	ENDIF
ENDIF 


goConn.BeginTransaction()

this.idventasc = goConn.getNextID("ventascab", "idVentasC")

lcSql = "INSERT INTO ventascab ( "
lcSql = lcSql + "idVentasC, "
lcSql = lcSql + "idCliente, "
lcSql = lcSql + "razSoc, "
lcSql = lcSql + "idTipoDoc, "
lcSql = lcSql + "nroDoc, "
lcSql = lcSql + "fecEmision, "
lcSql = lcSql + "cbte, "
lcSql = lcSql + "tipoDoc, "
lcSql = lcSql + "ptoVta, "
lcSql = lcSql + "numCbte, "
lcSql = lcSql + "anulado, "
lcSql = lcSql + "impNeto, "
lcSql = lcSql + "impFinal, "
lcSql = lcSql + "porIVA21, "
lcSql = lcSql + "impIVA21, "
lcSql = lcSql + "porIVA105, "
lcSql = lcSql + "impIVA105, "
lcSql = lcSql + "porDesc1, "
lcSql = lcSql + "impDesc1, "
lcSql = lcSql + "porDesc2, "
lcSql = lcSql + "impDesc2, "
lcSql = lcSql + "porDesc3, "
lcSql = lcSql + "impDesc3, "
lcSql = lcSql + "porDesc4, "
lcSql = lcSql + "impDesc4, "
lcSql = lcSql + "totFact, "
lcSql = lcSql + "saldo, "
lcSql = lcSql + "esPendi, "
lcSql = lcSql + "usuAlta, "
lcSql = lcSql + "fecAlta, "
lcSql = lcSql + "idHostAlta, "
lcSql = lcSql + "observ, "
lcSql = lcSql + "porIIBB, "
lcSql = lcSql + "impIIBB, "
lcSql = lcSql + "idCondPago, "
lcSql = lcSql + "idSitIVA, "
lcSql = lcSql + "idVendedor, "
lcSql = lcSql + "procesado, "
lcSql = lcSql + "fecVto, "
lcSql = lcSql + "porRec, "
lcSql = lcSql + "impRec) "
lcSql = lcSql + "VALUES ( "
lcSql = lcSql + ALLTRIM(STR(this.idventasc)) + ", "
lcSql = lcSql + ALLTRIM(STR(this.idcliente)) + ", "
lcSql = lcSql + "'" + ALLTRIM(this.cli_razsoc) + "', "
lcSql = lcSql + ALLTRIM(STR(this.cli_tipodoc)) + ", "
lcSql = lcSql + "'" + ALLTRIM(this.cli_nrodoc) + "', "
lcSql = lcSql + loDT.toMySql(this.fecemision) + ", "
lcSql = lcSql + "'" + ALLTRIM(this.cbte) + "', "
lcSql = lcSql + "'" + ALLTRIM(this.tipodoc) + "', "
lcSql = lcSql + ALLTRIM(STR(this.ptovta)) + ", "
lcSql = lcSql + ALLTRIM(STR(this.numcbte)) + ", "
lcSql = lcSql + ALLTRIM(STR(this.anulado)) + 	", "
lcSql = lcSql + ALLTRIM(STR(this.lnncimpneto, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(this.lnncimpfinal, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(this.poriva21, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(this.lnncimpiva21, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(this.poriva105, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(this.lnncimpiva105, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(this.pordesc1, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(this.lnncimpdesc1, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(this.pordesc2, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(this.lnncimpdesc2, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(this.pordesc3, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(this.lnncimpdesc3, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(this.pordesc4, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(this.lnncimpdesc4, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(this.lnnctotfact, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(0, 10, 2)) + ", "	&& saldo
lcSql = lcSql + ALLTRIM(STR(this.espendi)) + ", "
lcSql = lcSql + "'" + ALLTRIM(gcCodusu) + "', "
lcSql = lcSql + loDT.getDateTime() + ", "
lcSql = lcSql + "'" + ALLTRIM(SYS(0)) + "', "
lcSql = lcSql + "'" + ALLTRIM(this.observ) + "', "
lcSql = lcSql + ALLTRIM(STR(this.poriibb, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(this.lnncimpiibb, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(this.idcondpago)) + ", "
lcSql = lcSql + ALLTRIM(STR(this.idsitiva)) + ", "
lcSql = lcSql + ALLTRIM(STR(this.idvendedor)) + ", "
lcSql = lcSql + ALLTRIM(STR(this.procesado)) + ", "
lcSql = lcSql + loDT.toMySql(this.fecemision) + ", "
lcSql = lcSql + ALLTRIM(STR(this.lnncporrec, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(this.lnncimprec, 10, 2)) + ") "

loCommand.commandText = lcSql
loCommand.ActiveConnection = goConn.ActiveConnection

IF !loCommand.Execute() THEN
	this.error_message = loCommand.ErrorMessage
	goConn.Rollback()
	RETURN .F.
ENDIF

SELECT cur_detalle
IF RECCOUNT("cur_detalle") > 0 THEN
	GO TOP
ENDIF

DO WHILE !EOF("cur_detalle") 
	lnIdVentasD = lnIdVentasD + 1
	
	IF cur_detalle.cantNC <> 0 THEN
		&& Aca tengo que agregar el grabado en la tabla ventasdet
		lcSql = "INSERT INTO ventasdet ( "
		lcSql = lcSql + " idVentasD, "
		lcSql = lcSql + " idVentasC, "
		lcSql = lcSql + " idArticulo, "
		lcSql = lcSql + " descripcio, "
		lcSql = lcSql + " cantidad, "
		lcSql = lcSql + " cantNC, "
		lcSql = lcSql + " nroPart, "
		lcSql = lcSql + " costoRep, "
		lcSql = lcSql + " prVenta, "
		lcSql = lcSql + " porDesc1, "
		lcSql = lcSql + " porDesc2, "
		lcSql = lcSql + " porDesc3, "
		lcSql = lcSql + " porDesc4, "
		lcSql = lcSql + " impDesc1, "
		lcSql = lcSql + " impDesc2, "
		lcSql = lcSql + " impDesc3, "
		lcSql = lcSql + " impDesc4, "
		lcSql = lcSql + " pDtoVta1, "
		lcSql = lcSql + " pDtoVta2, "
		lcSql = lcSql + " pDtoVta3, "
		lcSql = lcSql + " pDtoVta4, "
		lcSql = lcSql + " iDtoVta1, "
		lcSql = lcSql + " iDtoVta2, "
		lcSql = lcSql + " iDtoVta3, "
		lcSql = lcSql + " iDtoVta4, "
		lcSql = lcSql + " totNeto, "
		lcSql = lcSql + " alicIVA, "
		lcSql = lcSql + " impIVA, "
		lcSql = lcSql + " subTotal, "
		lcSql = lcSql + " impNeto, "
		lcSql = lcSql + " prArtic, "
		lcSql = lcSql + " pRecVta, "
		lcSql = lcSql + " iRecVta) "
		lcSql = lcSql + "VALUES ( "
		lcSql = lcSql + ALLTRIM(STR(lnIdVentasD)) + ", "
		lcSql = lcSql + ALLTRIM(STR(this.idventasc)) + ", "
		lcSql = lcSql + ALLTRIM(STR(cur_detalle.idArticulo)) + ", "
		lcSql = lcSql + "'" + ALLTRIM(cur_detalle.descripcio) + "', "
		lcSql = lcSql + ALLTRIM(STR(cur_detalle.cantNC)) + ", "
		lcSql = lcSql + "0, "
		lcSql = lcSql + "'" + ALLTRIM(cur_detalle.nroPart) + "', "
		lcSql = lcSql + ALLTRIM(STR(cur_detalle.costoRep, 10, 2)) + ", "
		lcSql = lcSql + ALLTRIM(STR(cur_detalle.prVenta, 10, 2)) + ", "
		lcSql = lcSql + ALLTRIM(STR(cur_detalle.porDesc1, 10, 2)) + ", "
		lcSql = lcSql + ALLTRIM(STR(cur_detalle.porDesc2, 10, 2)) + ", "
		lcSql = lcSql + ALLTRIM(STR(cur_detalle.porDesc3, 10, 2)) + ", "
		lcSql = lcSql + ALLTRIM(STR(cur_detalle.porDesc4, 10, 2)) + ", "
		lcSql = lcSql + ALLTRIM(STR(cur_detalle.impDesc1, 10, 2)) + ", "
		lcSql = lcSql + ALLTRIM(STR(cur_detalle.impDesc2, 10, 2)) + ", "
		lcSql = lcSql + ALLTRIM(STR(cur_detalle.impDesc3, 10, 2)) + ", "
		lcSql = lcSql + ALLTRIM(STR(cur_detalle.impDesc4, 10, 2)) + ", "
		lcSql = lcSql + ALLTRIM(STR(cur_detalle.pDtoVta1, 10, 2)) + ", "
		lcSql = lcSql + ALLTRIM(STR(cur_detalle.pDtoVta2, 10, 2)) + ", "
		lcSql = lcSql + ALLTRIM(STR(cur_detalle.pDtoVta3, 10, 2)) + ", "
		lcSql = lcSql + ALLTRIM(STR(cur_detalle.pDtoVta4, 10, 2)) + ", "
		lcSql = lcSql + ALLTRIM(STR(cur_detalle.iDtoVta1, 10, 2)) + ", "
		lcSql = lcSql + ALLTRIM(STR(cur_detalle.iDtoVta2, 10, 2)) + ", "
		lcSql = lcSql + ALLTRIM(STR(cur_detalle.iDtoVta3, 10, 2)) + ", "
		lcSql = lcSql + ALLTRIM(STR(cur_detalle.iDtoVta4, 10, 2)) + ", "
		lcSql = lcSql + ALLTRIM(STR(cur_detalle.totNeto, 10, 2)) + ", "
		lcSql = lcSql + ALLTRIM(STR(cur_detalle.alicIVA, 10, 2)) + ", "
		lcSql = lcSql + ALLTRIM(STR(cur_detalle.impIVA, 10, 2)) + ", "
		lcSql = lcSql + ALLTRIM(STR(cur_detalle.subTotal, 10, 2)) + ", "
		lcSql = lcSql + ALLTRIM(STR(cur_detalle.impNeto, 10, 2)) + ", "
		lcSql = lcSql + ALLTRIM(STR(cur_detalle.prArtic, 10, 2)) + ", "
		lcSql = lcSql + ALLTRIM(STR(cur_detalle.pRecVta, 10, 2)) + ", "
		lcSql = lcSql + ALLTRIM(STR(cur_detalle.iRecVta, 10, 2)) + ")"
		
		loCommand.commandText = lcSql
		loCommand.ActiveConnection = goConn.ActiveConnection
		
		IF !loCommand.Execute() THEN
			this.error_message = loCommand.ErrorMessage
			goConn.Rollback()
			RETURN .F.
		ENDIF
	ENDIF
	
	&& Agrego los artículos al movimiento de stock
	loMovStock.Agregar_Articulo(cur_detalle.idArticulo, cur_detalle.cantNC, cur_detalle.nroPart)
	
	&& Actualizo los items de la factura de origen filtrando por el idArticulo y
	&& el id de venta de origen
	
	lcSql = "UPDATE ventasdet SET cantNC = cantNC + " + ALLTRIM(STR(cur_detalle.cantNC)) + " "
	lcSql = lcSql + "WHERE idArticulo = " + ALLTRIM(STR(cur_detalle.idArticulo)) + " "
	lcSql = lcSql + "	AND idVentasC = " + ALLTRIM(STR(this.id_vta_origen))
	lcSql = lcSql + "	AND idVentasD = " + ALLTRIM(STR(cur_detalle.idVentasD))
	
	loCommand.ActiveConnection = goConn.ActiveConnection
	loCommand.CommandText = lcSql
	
	IF !loCommand.Execute() THEN
		this.error_message = loCommand.ErrorMessage
		goConn.Rollback()
		RETURN .F.
	ENDIF
	
	SELECT cur_detalle
	SKIP
ENDDO

IF getGlobalCFG("STK_MODULE") THEN
	IF INT(VAL(getconfig("DEMO"))) = 1 THEN
		&& Si se está ejecutando la versión DEMO, entonces, llama al grabar3 y no carga ningún
		&& dato relativo al comprobante.
		
		loMovStock.circuito = "S"
		loMovStock.tipoDoc = ""
		loMovStock.cbte = ""
		
		IF !loMovStock.grabar3() THEN
			this.error_message = loMovStock.ErrorMessage
			goConn.Rollback()
			RETURN .F.
		ENDIF
	ELSE
		&& Si pasa por aca es en caso que se esté ejecutando la versión normal
		loMovStock.circuito = "V"
		
		loMovStock.idcliente = this.idcliente
		loMovStock.idprov = 0
		loMovStock.tipodoc = this.tipodoc
		loMovStock.cbte = this.cbte
		loMovStock.numcbte =  REPLICATE("0", 4 - LEN(ALLTRIM(STR(this.ptovta)))) + ALLTRIM(STR(this.ptovta)) + "-" + REPLICATE("0", 8 - LEN(ALLTRIM(STR(this.numcbte)))) + ALLTRIM(STR(this.numcbte))
	
		IF !loMovStock.grabar2() THEN
			this.error_message = loMovStock.ErrorMessage
			goConn.Rollback()
			RETURN .F.
		ENDIF
	ENDIF
ENDIF

&& Armo la relación entre comprobantes
lnIdVtaRel = goConn.getNextID("ventasrel", "idVtaRel")

lcSql = "INSERT INTO ventasrel (idVtaRel, idVtaCO, idVtaCD) VALUES ( "
lcSql = lcSql + ALLTRIM(STR(lnIdVtaRel)) + ", " + ALLTRIM(STR(this.id_vta_origen)) + ", " + ALLTRIM(STR(this.idventasc)) + ")"

loCommand.ActiveConnection = goConn.ActiveConnection
loCommand.CommandText = lcSql

IF !loCommand.Execute() THEN
	this.error_message = loCommand.ErrorMessage
	goConn.Rollback()
	RETURN .F.	
ENDIF

&& Actualizo el saldo de la factura
lcSql = "UPDATE ventascab "
lcSql = lcSql + "SET 	saldo = ROUND(saldo - " + ALLTRIM(STR(this.lnnctotfact, 10, 2)) + ", 2), "
lcSql = lcSql + "		usuModi = '" + ALLTRIM(gcCodusu) + "', "
lcSql = lcSql + "		fecModi = " + loDT.getDateTime() + ", "
lcSql = lcSql + "		idHostModi = '" + SYS(0) + "' "
lcSql = lcSql + "WHERE idVentasC = " + ALLTRIM(STR(this.id_vta_origen))

loCommand.ActiveConnection = goConn.ActiveConnection
loCommand.CommandText = lcSql

IF !loCommand.Execute() THEN
	this.error_message = loCommand.ErrorMessage
	goConn.Rollback()
	RETURN .F.
ENDIF

IF this.esfe = 0 THEN 
	&& Actualizo el numerador
	lcSql = "UPDATE numerador SET numActual = " + ALLTRIM(STR(this.numcbte)) + " "
	lcSql = lcSql + "WHERE cbte = '" + ALLTRIM(this.cbte) + "' "
	lcSql = lcSql + "	AND tipoDoc = '" + ALLTRIM(this.tipodoc) + "' "
	lcSql = lcSql + "	AND ptoVta = " + ALLTRIM(STR(this.ptovta))

	loCommand.ActiveConnection = goConn.ActiveConnection
	loCommand.CommandText = lcSql

	IF !loCommand.Execute() THEN
		this.error_message = loCommand.ErrorMessage
		goConn.Rollback()
		RETURN .F.
	ENDIF
ENDIF 

goConn.Commit()

RETURN .T.

ENDPROC
PROCEDURE calcular_nro_cbte
LOCAL loResul, loCommand, lcSql
LOCAL lnIdNum

lcSql = ""
loResult = CREATEOBJECT("odbc_result")
loCommand = CREATEOBJECT("odbc_command")

lcSql = "SELECT * FROM numerador WHERE cbte = '" + This.cbte + "' AND tipoDoc = '" + this.tipodoc + "' AND ptoVta = " + ALLTRIM(STR(this.ptovta))
loResult.ActiveConnection = goConn.ActiveConnection
loResult.cursor_name = "cur_Num"

IF !loResult.OpenQuery(lcSql) THEN
	this.error_message = loResult.Error_Message
	RETURN .F.
ENDIF

IF RECCOUNT("cur_num") = 0 THEN
	this.error_message = "No se encuentra configurado el numerador del comprobante " + ALLTRIM(this.cbte) + " Punto de Venta: " + ALLTRIM(STR(this.ptovta)) + " Letra: " + ALLTRIM(this.tipodoc)
	loResult.close_query()
	RETURN .F.
ENDIF

IF DATE() > cur_Num.fecVto THEN
	this.error_message = "El talonario actual está vencido, por favor, verifique que su talonario se encuentre en orden"
	loResult.close_query()
	RETURN .F.
ENDIF

SELECT cur_num
lnIdNum = cur_num.idNum
lnNroCbte = cur_num.numActual + 1
this.NroCbte = REPLICATE("0", 4 - LEN(ALLTRIM(STR(this.ptovta)))) + ALLTRIM(STR(this.ptovta)) + "-" + REPLICATE("0", 8 - LEN(ALLTRIM(STR(cur_num.numActual)))) + ALLTRIM(STR(cur_num.numActual))
*this.cant_copianc = cur_num.cantCpia
*This.printerDevice = cur_num.impresora

loResult.close_query()	

lcSql = "SELECT * FROM impresoras WHERE hostName = '" + ALLTRIM(SYS(0)) + "' AND idNum = " + ALLTRIM(STR(lnIdNum))
loResult.ActiveConnection = goConn.ActiveConnection
loResult.Cursor_Name = "cur_imp"

IF !loResult.OpenQuery(lcSql) THEN
	MESSAGEBOX(loResult.Error_message, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

SELECT cur_imp
IF RECCOUNT("cur_imp") = 0 THEN
	MESSAGEBOX("La impresora no está configurada para este puesto de trabajo", 0+48, Thisform.Caption)
	loResult.Close_Query()
	RETURN .F.
ENDIF

This.cant_copianc = cur_imp.copias
This.printerdevice = ALLTRIM(cur_imp.impresora)

this.numcbte = lnNroCbte

RETURN .T.
ENDPROC
PROCEDURE crear_cursor
CREATE CURSOR cur_detalleFC (	;
	idVentasD	int,;
	idArticulo	int,;
	codArt		varchar(20),;
	descripcio	varchar(60),;
	cantidad	float(10, 2),;
	cantNC		float(10, 2),;
	nroPart		varchar(30),;
	costoRep	float(10, 2),;
	prVenta		float(10, 2),;
	porDesc1	float(10, 2),;
	porDesc2	float(10, 2),;
	porDesc3	float(10, 2),;
	porDesc4	float(10, 2),;
	impDesc1	float(10, 2),;
	impDesc2	float(10, 2),;
	impDesc3	float(10, 2),;
	impDesc4	float(10, 2),;
	pDtoVta1	float(10, 2),;
	pDtoVta2	float(10, 2),;
	pDtoVta3	float(10, 2),;
	pDtoVta4	float(10, 2),;
	iDtoVta1	float(10, 2),;
	iDtoVta2	float(10, 2),;
	iDtoVta3	float(10, 2),;
	iDtoVta4	float(10, 2),;
	totNeto		float(10, 2),;
	alicIVA		float(10, 2),;
	impIVA		float(10, 2),;
	subTotal	float(10, 2),;
	impNeto		float(10, 2),;
	prArtic		float(10, 2),;
	pRecVta		float(10, 2),;
	iRecVta		float(10, 2),;
	pRecItem	float(10, 2),;
	iRecItem	float(10, 2))
	

CREATE CURSOR cur_detalle (	;
	idVentasD	int,;
	idArticulo	int,;
	codArt		varchar(20),;
	descripcio	varchar(60),;
	cantidad	float(10,2),;
	cantNC		float(10,2),;
	nroPart		varchar(30),;
	costoRep	float(10, 2),;
	prVenta		float(10, 2),;
	porDesc1	float(10, 2),;
	porDesc2	float(10, 2),;
	porDesc3	float(10, 2),;
	porDesc4	float(10, 2),;
	impDesc1	float(10, 2),;
	impDesc2	float(10, 2),;
	impDesc3	float(10, 2),;
	impDesc4	float(10, 2),;
	pDtoVta1	float(10, 2),;
	pDtoVta2	float(10, 2),;
	pDtoVta3	float(10, 2),;
	pDtoVta4	float(10, 2),;
	iDtoVta1	float(10, 2),;
	iDtoVta2	float(10, 2),;
	iDtoVta3	float(10, 2),;
	iDtoVta4	float(10, 2),;
	totNeto		float(10, 2),;
	alicIVA		float(10, 2),;
	impIVA		float(10, 2),;
	subTotal	float(10, 2),;
	impNeto		float(10, 2),;
	prArtic		float(10, 2),;
	pRecVta		float(10, 2),;
	iRecVta		float(10, 2),;
	pRecItem	float(10, 2),;
	iRecItem	float(10, 2))

&& Armo un cursor de detalle auxiliar para particionar la nota de crédito
CREATE CURSOR cur_aux ( ;
	idVentasD	int,;
	idArticulo	int,;
	codArt		varchar(20),;
	descripcio	varchar(60),;
	cantidad	float(10, 2),;
	cantNC		float(10, 2),;
	nroPart		varchar(30),;
	costoRep	float(10, 2),;
	prVenta		float(10, 2),;
	porDesc1	float(10, 2),;
	porDesc2	float(10, 2),;
	porDesc3	float(10, 2),;
	porDesc4	float(10, 2),;
	impDesc1	float(10, 2),;
	impDesc2	float(10, 2),;
	impDesc3	float(10, 2),;
	impDesc4	float(10, 2),;
	pDtoVta1	float(10, 2),;
	pDtoVta2	float(10, 2),;
	pDtoVta3	float(10, 2),;
	pDtoVta4	float(10, 2),;
	iDtoVta1	float(10, 2),;
	iDtoVta2	float(10, 2),;
	iDtoVta3	float(10, 2),;
	iDtoVta4	float(10, 2),;
	totNeto		float(10, 2),;
	alicIVA		float(10, 2),;
	impIVA		float(10, 2),;
	subTotal	float(10, 2),;
	impNeto		float(10, 2),;
	prArtic		float(10, 2),;
	pRecVta		float(10, 2),;
	iRecVta		float(10, 2),;
	pRecItem	float(10, 2),;
	iRecItem	float(10, 2))
	
ENDPROC
PROCEDURE recuperar_fc
LOCAL lcSql, loResult, loResDet, loResCC

lcSql = ""
loResult = CREATEOBJECT("odbc_result")
loResDet = CREATEOBJECT("odbc_result")
loResCC = CREATEOBJECT("odbc_result")

lcSql = "SELECT * FROM ventascab WHERE idVentasC = " + ALLTRIM(STR(this.id_vta_origen))
loResult.ActiveConnection = IIF(this.esdemo, this.demo_connection.ActiveConnection, goConn.ActiveConnection)
loResult.Cursor_Name = "cur_ventasC"

IF !loResult.OpenQuery(lcSql) THEN
	This.Error_Message = loResult.Error_Message
	RETURN .F.
ENDIF

SELECT cur_ventasC 
IF RECCOUNT("cur_ventasC") > 0 THEN
	this.id_vta_origen = cur_ventasC.idVentasC
	this.idcliente = cur_ventasC.idCliente
	this.tipodoc = cur_ventasC.tipoDoc
	this.idcondpago = cur_ventasC.idcondpago
	this.idsitiva = cur_ventasC.idsitiva
	this.fecemision = cur_ventasC.fecEmision
	this.pordesc1 = cur_ventasC.porDesc1
	this.pordesc2 = cur_ventasC.porDesc2
	this.pordesc3 = cur_ventasC.porDesc3
	this.pordesc4 = cur_ventasC.porDesc4
	this.impdesc1 = cur_ventasC.impDesc1
	this.impdesc2 = cur_ventasC.impDesc2
	this.impdesc3 = cur_ventasC.impDesc3
	this.impdesc4 = cur_ventasC.impDesc4
	this.saldo = cur_ventasc.saldo
	this.totfact = cur_ventasC.totFact
	this.impfinal = cur_ventasC.impFinal
	this.impiva105 = cur_VentasC.impIVA105
	this.impiva21 = cur_VentasC.impIVA21
	this.impiibb = cur_VentasC.impIIBB
	this.poriibb = cur_VentasC.porIIBB
	this.impneto = cur_ventasC.impNeto
	this.idvendedor = cur_ventasC.idVendedor
	this.porrec = cur_ventasC.porRec
	this.imprec = cur_ventasC.impRec
	this.cli_razsoc = cur_ventasC.razSoc
	this.cli_nrodoc = cur_ventasC.nroDoc
	this.cli_tipodoc = cur_ventasC.idTipoDoc

	this.cbte_origen = ALLTRIM(cur_ventasC.cbte)
	this.tipodoc_origen = ALLTRIM(cur_ventasC.tipodoc)
	this.nrocbte_origen = REPLICATE("0", 4 - LEN(ALLTRIM(STR(cur_ventasC.ptovta)))) + ALLTRIM(STR(cur_ventasC.ptovta)) + "-" + REPLICATE("0", 8 - LEN(ALLTRIM(STR(cur_ventasC.numCbte)))) + ALLTRIM(STR(cur_ventasC.numCbte))

	this.observ = "Devolución de " + this.cbte_origen + " " + this.tipodoc_origen + " " + this.nrocbte_origen
	
	lcSql = "SELECT ventasdet.*, articulos.codArt, ventasdet.descripcio "
	lcSql = lcSql + "FROM ventasdet INNER JOIN articulos ON ventasdet.idArticulo = articulos.idArticulo "
	lcSql = lcSql + "WHERE idVentasC = " + ALLTRIM(STR(this.id_vta_origen))
	
	loResDet.ActiveConnection = IIF(this.esdemo, this.demo_connection.ActiveConnection, goConn.ActiveConnection)
	loResDet.Cursor_Name = "cur_VtasD"
	
	IF !loResDet.OpenQuery(lcSql) THEN
		this.error_message = loResDet.Error_Message
		RETURN .F.
	ENDIF
	
	SELECT cur_VtasD 
	DO WHILE !EOF("cur_VtasD")
		&&this.nro_item = this.nro_item + 1
		
		SELECT cur_detalleFC
		APPEND BLANK
		REPLACE cur_detalleFC.idVentasD WITH cur_VtasD.idVentasD
		REPLACE cur_detalleFC.idArticulo WITH cur_VtasD.idArticulo ADDITIVE
		REPLACE cur_detalleFC.codArt WITH cur_VtasD.CodArt ADDITIVE
		REPLACE cur_detalleFC.descripcio WITH cur_VtasD.Descripcio ADDITIVE
		REPLACE cur_detalleFC.cantidad WITH cur_VtasD.Cantidad - cur_VtasD.CantNC ADDITIVE
		REPLACE cur_detalleFC.cantNC WITH 0 ADDITIVE
		REPLACE cur_detalleFC.nroPart WITH IIF(ISNULL(cur_VtasD.nroPart), "", cur_VtasD.nroPart) ADDITIVE
		REPLACE cur_detalleFC.costoRep WITH cur_VtasD.CostoRep ADDITIVE
		REPLACE cur_detalleFC.prVenta WITH cur_VtasD.prVenta ADDITIVE
		REPLACE cur_detalleFC.porDesc1 WITH cur_VtasD.PorDesc1 ADDITIVE
		REPLACE cur_detalleFC.porDesc2 WITH cur_VtasD.PorDesc2 ADDITIVE
		REPLACE cur_detalleFC.porDesc3 WITH cur_VtasD.PorDesc3 ADDITIVE
		REPLACE cur_detalleFC.porDesc4 WITH cur_VtasD.PorDesc4 ADDITIVE
		REPLACE cur_detalleFC.impDesc1 WITH cur_VtasD.impDesc1 ADDITIVE
		REPLACE cur_detalleFC.impDesc2 WITH cur_VtasD.impDesc2 ADDITIVE
		REPLACE cur_detalleFC.impDesc3 WITH cur_VtasD.impDesc3 ADDITIVE
		REPLACE cur_detalleFC.impDesc4 WITH cur_VtasD.impDesc4 ADDITIVE
		REPLACE cur_detalleFC.pDtoVta1 WITH cur_VtasD.pDtoVta1 ADDITIVE
		REPLACE cur_detalleFC.pDtoVta2 WITH cur_VtasD.pDtoVta2 ADDITIVE
		REPLACE cur_detalleFC.pDtoVta3 WITH cur_VtasD.pDtoVta3 ADDITIVE
		REPLACE cur_detalleFC.pDtoVta4 WITH cur_VtasD.pDtoVta4 ADDITIVE
		REPLACE cur_detalleFC.iDtoVta1 WITH cur_VtasD.iDtoVta1 ADDITIVE
		REPLACE cur_detalleFC.iDtoVta2 WITH cur_VtasD.iDtoVta2 ADDITIVE
		REPLACE cur_detalleFC.iDtoVta3 WITH cur_VtasD.iDtoVta3 ADDITIVE
		REPLACE cur_detalleFC.iDtoVta4 WITH cur_VtasD.iDtoVta4 ADDITIVE
		REPLACE cur_detalleFC.totNeto WITH cur_VtasD.totNeto ADDITIVE
		REPLACE cur_detalleFC.alicIVA WITH cur_VtasD.alicIVA ADDITIVE
		REPLACE cur_detalleFC.impIVA WITH cur_VtasD.impIVA ADDITIVE
		REPLACE cur_detalleFC.subTotal WITH cur_VtasD.SubTotal ADDITIVE
		REPLACE cur_detalleFC.impNeto WITH cur_VtasD.impNeto ADDITIVE	
		REPLACE cur_detalleFC.prArtic WITH cur_VtasD.prArtic ADDITIVE
		REPLACE cur_detalleFC.pRecVta WITH cur_VtasD.pRecVta ADDITIVE 
		REPLACE cur_detalleFC.iRecVta WITH cur_VtasD.iRecVta ADDITIVE 
		
		SELECT cur_VtasD
		SKIP
	ENDDO
	
	loResDet.Close_Query()
	
	SELECT cur_detalleFC
	IF RECCOUNT("cur_detalleFC") > 0 THEN
		GO TOP
	ENDIF
ELSE
	This.error_message = "No hay registros para mostrar"
	RETURN .F.
ENDIF

SELECT cur_ventasC
lcSql = "SELECT * FROM cc_cli WHERE idVentasC = " + ALLTRIM(STR(cur_ventasC.idVentasC))
loResCC.ActiveConnection = IIF(this.esdemo, this.demo_connection.ActiveConnection, goConn.ActiveConnection)
loResCC.Cursor_Name = "cur_ccCli"

IF !loResCC.OpenQuery(lcSql) THEN
	this.error_message = loResCC.ErrorMessage
	RETURN .F.
ENDIF

this.idcc_origen = cur_ccCli.idCC_Cli
this.id_oper = cur_ccCli.idOper

loResCC.close_query()
loResult.close_query()

RETURN .T.
ENDPROC
PROCEDURE calcuar_tipodoc
LOCAL lnSitIVACli

lnSitIvaEmp = 0
lnSitIvaEmp = VAL(ALLTRIM(getConfig("SITIVAEMP")))

IF lnSitIvaEmp = 1 .AND. This.idsitiva = 1 THEN
	RETURN "A"
ENDIF

IF lnSitIvaEmp = 1 .AND. This.idsitiva = 2 THEN
	RETURN "B"
ENDIF

IF lnSitIvaEmp = 1 .AND. This.idsitiva = 3 THEN
	RETURN "B"
ENDIF

IF lnSitIvaEmp = 1 .AND. This.idsitiva = 6 THEN
	RETURN "B"
ENDIF

IF lnSitIvaEmp = 6 THEN
	RETURN "C"
ENDIF

ENDPROC
PROCEDURE limpiar
&& Limpio los cursores
SELECT cur_detalleFC
ZAP
SELECT cur_detalle
ZAP
*SELECT cur_aux
*ZAP
ENDPROC
PROCEDURE imprimir
LOCAL m.NroCli, m.RazSoc, m.Telefono, m.direccion, m.localidad, m.codPostal, m.pcia, m.TipoIVA, m.nroCUIT
LOCAL m.Total, m.tipoDoc, m.NroCbte, m.Fecha, m.leyenda, m.fecVto, m.tipoDoc, m.ptoVta
LOCAL m.porDesc1, m.porDesc2, m.porDesc3, m.porDesc4
LOCAL m.impDesc1, m.impDesc2, m.impDesc3, m.impDesc4
LOCAL m.porIIBB, m.impIIBB, m.observ
LOCAL m.porIVA105, m.impIVA105, m.porIVA21, m.impIVA21, m.impNeto, m.impFinal
LOCAL lcSql, loResult, lcPrinterName, lnCantCpia

lo_rsSitIVA = CREATEOBJECT("odbc_result")
loResult = CREATEOBJECT("odbc_result")
lcSql = ""

lcSql = "SELECT clientes.*, localidad.descripcio as descLoc, localidad.codPostal, provincias.descripcio as pcia "
lcSql = lcSql + "FROM clientes INNER JOIN localidad ON localidad.idLocalid = clientes.idLocalid "
lcSql = lcSql + "	INNER JOIN provincias ON provincias.idProvin = localidad.idProvin "
lcSql = lcSql + "WHERE clientes.idCliente = " + ALLTRIM(STR(this.idcliente))

loResult.ActiveConnection = goConn.ActiveConnection
loResult.Cursor_Name = "cur_cli"

IF !loResult.OpenQuery(lcSql) THEN
	this.error_message = loResult.Error_Message
	RETURN .F.
ENDIF

SELECT cur_cli
m.NroCli = cur_cli.idCliente
m.RazSoc = ALLTRIM(this.cli_razsoc)
m.Telefono = ALLTRIM(cur_cli.telefono)
m.direccion = ALLTRIM(cur_cli.direccion)
m.localidad = ALLTRIM(cur_cli.descLoc)
m.codPostal = ALLTRIM(cur_cli.codPostal)
m.pcia = ALLTRIM(cur_cli.pcia)
m.nroCUIT = ALLTRIM(this.cli_nrodoc)
m.TipoIVA = this.idsitiva

loResult.close_query()

m.Total = 0.00
m.NroCbte = this.nrocbte
m.leyenda = ""
m.Fecha = DATETIME()
m.porIVA105 = 0.00
m.porIVA21 = 0.00
m.impIVA105 = 0.00
m.impIVA21 = 0.00
m.impNeto = 0.00
m.impFinal = 0.00
m.fecVto = DATE()
m.tipoDoc = this.tipodoc
m.ptoVta = ""
m.porIIBB = 0.00
m.impIIBB = 0.00
lnCantCpia = 0
m.observ = ""

m.Leyenda = "NOTA DE CREDITO"

m.porDesc1 = this.lnncpordto1
m.porDesc2 = this.lnncpordto2
m.porDesc3 = this.lnncpordto3
m.porDesc4 = this.lnncpordto4
m.impDesc1 = this.lnncimpdesc1
m.impDesc2 = this.lnncimpdesc2
m.impDesc3 = this.lnncimpdesc3
m.impDesc4 = this.lnncimpdesc4
m.porIVA105 = 10.5
m.porIVA21 = 21
m.impIVA105 = this.lnncimpiva105
m.impIVA21 = this.lnncimpiva21
m.impNeto = this.lnncimpfinal
&&m.impFinal = this.lnncimpfinal
m.porIIBB = this.lnncporiibb
m.impIIBB = this.lnncimpiibb
m.total = this.lnnctotfact

&& Busco la situacion de IVA
lcSql = "SELECT * FROM SitIva WHERE idSitIVA = " + ALLTRIM(STR(this.idsitiva))
lo_rsSitIVA.ActiveConnection = goConn.ActiveConnection
lo_rsSitIVA.Cursor_Name = "cur_SitIVA"
lo_rsSitIVA.OpenQuery(lcSql)

SELECT cur_SitIVA
m.TipoIVA = cur_SitIVA.descripcio

SET PRINTER TO NAME ALLTRIM(this.printerdevice)

FOR i = 1 TO this.cant_copianc
	IF ALLTRIM(This.tipodoc) == "A" THEN
		&& Imprime el comprobante de tipo "A"
		SELECT cur_aux
		REPORT FORM "repcbtesvta.frx" TO PRINTER NOCONSOLE
	ELSE
		&& Imprime el comprobante de tipo "B"
		SELECT cur_aux
		REPORT FORM "repcbtesvta_b.frx" TO PRINTER NOCONSOLE
	ENDIF
NEXT

RETURN .T.
ENDPROC
PROCEDURE grabar_ctacte
LOCAL loCommand
LOCAL loRes
LOCAL loDT
LOCAL lcSql
LOCAL lnOperacion
LOCAL lnIdCC_Cli

loCommand = CREATEOBJECT("odbc_command")
loRes = CREATEOBJECT("odbc_result")
loDT = CREATEOBJECT("datetime")
lcSql = ""
lnOperacion = 0
lnIdCC_Cli = 0

goConn.BeginTransaction()

IF this.vincular_cbte THEN
	lnOperacion = this.getidoper()
ELSE
	lnOperacion = INT(VAL(this.getnextidoper()))
ENDIF

lcSql = "CALL cccli_insert ( " ;
	+ ALLTRIM(STR(this.idcliente)) + ", " ;
	+ ALLTRIM(STR(this.idcc_origen)) + ", " ;
	+ ALLTRIM(STR(this.idventasc)) + ", " ;
	+ "'" + ALLTRIM(this.cbte) + "', " ;
	+ "'" + ALLTRIM(this.tipodoc) + "', " ;
	+ ALLTRIM(STR(this.ptovta)) + ", " ;
	+ ALLTRIM(STR(this.numCbte)) + ", " ;
	+ loDT.toMySql(this.fecemision) + ", " ;
	+ loDT.toMySql(this.fecemision) + ", " ;
	+ "0, " ;
	+ ALLTRIM(STR(this.lnnctotfact, 10, 2)) + ", " ;
	+ ALLTRIM(STR(lnOperacion)) + ", " ;
	+ "'" + ALLTRIM(this.observ) + "', " ;
	+ "'" + ALLTRIM(gcCodUsu) + "', " ;
	+ loDT.getDateTime() + ", " ;
	+ "'" + SYS(0) + "', " ;
	+ ALLTRIM(STR(this.idcondpago)) + ", " ;
	+ ALLTRIM(STR(this.idsitiva)) + ", " ;
	+ ALLTRIM(STR(this.idvendedor)) + ")"

loCommand.ActiveConnection = goConn.ActiveConnection
loCommand.CommandText = lcSql

IF !loCommand.Execute() THEN
	this.error_message = loCommand.ErrorMessage
	goConn.Rollback()
	RETURN .F.
ENDIF

goConn.Commit()

RETURN .T.
ENDPROC
PROCEDURE getidoper
LOCAL loRes
LOCAL lnIdOper

loRes = CREATEOBJECT("odbc_result")
loRes.ActiveConnection = goConn.ActiveConnection
loRes.Cursor_Name = "cur_tmp"
lcSql = "CALL cccli_getIdOper ( " ;
	+ ALLTRIM(STR(this.id_vta_origen)) + ")"
loRes.OpenQuery(lcSql)
SELECT cur_tmp
lnIdOper = cur_tmp.idOper
loRes.Close_Query()
RETURN lnIdOper
ENDPROC
PROCEDURE getnextidoper
LOCAL loRes
LOCAL lnIdOper

loRes = CREATEOBJECT("odbc_result")
loRes.ActiveConnection = goConn.ActiveConnection
loRes.Cursor_Name = "cur_tmp"
lcSql = "CALL cccli_getNextIdOper()"
loRes.Cursor_Name = "cur_tmp"
loRes.OpenQuery(lcSql)
SELECT cur_tmp
lnIdOper = cur_tmp.proxIdOper
loRes.Close_Query()

RETURN lnIdOper
ENDPROC
PROCEDURE verificar_estado_fc
LOCAL loCmd
LOCAL lcSql
LOCAL lnSaldo
lcSql = ""
lnSaldo = 0.00
loResult = CREATEOBJECT("odbc_result")
lcSql = "CALL cccli_verificarEstadoCbte (" + ALLTRIM(STR(this.id_vta_origen)) + ")"
loResult.ActiveConnection = goConn.ActiveConnection
loResult.Cursor_Name = "cur_x"
loResult.OpenQuery(lcSql)
lnSaldo = cur_x.saldo
loResult.Close_Query()
RETURN lnSaldo
ENDPROC


************************************************************
OBJETO: cls_ncdev_sf
************************************************************
*** PROPIEDADES ***
BorderStyle = 1
Height = 490
Width = 1053
DoCreate = .T.
Caption = "Ingreso de Notas de Créditos por Devolución"
idorigen = 0
saldo_fc = 0.00
usafiscal = .F.
codivafiscal = 
sitivacli = 
cli_cuit = 
cli_telefono = 
cli_id = 0
cli_calle = 
cli_localidad = 
cli_codpostal = 
cli_pcia = 
tipodoc = 
cbte = NC
cli_tipodoc = 
cli_idtipodoc = 0
cli_nrodoc = 
cli_razsoc = 
codusu = 
nombre_usuario = 
envcbte = .F.
mailfc = 
printcbte = .F.
fecemis_fc = {}
cli_condpago = 
Name = "cls_ncdev_sf"
contenido.Top = -1
contenido.Left = -1
contenido.Width = 1055
contenido.Height = 574
contenido.Name = "contenido"

*** METODOS ***
PROCEDURE calcular_totales
&& Variables del detalle

LOCAL lnIdArticulo, lnCantidad, lnCantNC, lnCostoRep
LOCAL lnPrVenta, lnPorDesc1, lnPorDesc2, lnPorDesc3, lnPorDesc4
LOCAL lnImpDesc1, lnImpDesc2, lnImpDesc3, lnImpDesc4
LOCAL lnPDtoVta1, lnPDtoVta2, lnPDtoVta3, lnPDtoVta4
LOCAL lnIDtoVta1, lnIDtoVta2, lnIDtoVta3, lnIDtoVta4
LOCAL lnTotNeto, lnAlicIVA, lnImpIVA, lnSubTotal, lnImpNeto, lnPrArtic
LOCAL lcCodArt, lcDescripcio, lnTotItem, lnPrVenta1, lnporRec, lnimpRec
LOCAL lnBaseImp21, lnBaseImp105, lnAlicIVA21, lnAlicIVA105
LOCAL lnSTIDesc1, lnSTIDesc2, lnSTIDesc3, lnSTIDesc4, lnSTIRec
LOCAL lnPRecItem, lnIRecItem

&& Variables para calcular el total del comprobante
LOCAL lnNCImpNeto, lnNCImpDesc1, lnNCImpDesc2, lnNCImpDesc3, lnNCImpDesc4
LOCAL lnNCImpFinal, lnNCImpIVA21, lnNCImpIVA105, lnNCPorIIBB, lnNCImpIBB, lnNCTotFact
LOCAL lnNCPorRec, lnNCImpRec

&& Inicialización de las variables correspondientes al detalle
lnIdVentasD = 0
lnIdArticulo = 0
lnCantidad = 0
lnCantNC = 0
lnCostoRep = 0.00
lnPrVenta = 0.00
lnPorDesc1 = 0.00
lnPorDesc2 = 0.00
lnPorDesc3 = 0.00
lnPorDesc4 = 0.00
lnImpDesc1 = 0.00
lnImpDesc2 = 0.00
lnImpDesc3 = 0.00
lnImpDesc4 = 0.00
lnPDtoVta1 = 0.00
lnPDtoVta2 = 0.00
lnPDtoVta3 = 0.00
lnPDtoVta4 = 0.00
lnIDtoVta1 = 0.00
lnIDtoVta2 = 0.00
lnIDtoVta3 = 0.00
lnIDtoVta4 = 0.00
lnTotNeto = 0.00
lnAlicIVA = 0.00
lnImpIVA = 0.00
lnSubTotal = 0.00
lnImpNeto = 0.00
lnPrArtic = 0.00
lcCodArt = ""
lcDescripcio = ""
lnTotItem = 0.00
lnPrVenta1 = 0.00
lnporRec = 0.00
lnimpRec = 0.00
lnPRecItem = 0.00
lnIRecItem = 0.00

&& Inicialización de las variables de totales
lnNCImpNeto = 0.00
lnNCImpDesc1 = 0.00
lnNCImpDesc2 = 0.00
lnNCImpDesc3 = 0.00
lnNCImpDesc4 = 0.00
lnNCImpFinal = 0.00
lnNCImpIVA21 = 0.00
lnNCImpIVA105 = 0.00
lnNCPorIIBB = 0.00
lnNCImpIIBB = 0.00
lnNCTotFact = 0.00
lnNCPorRec = 0.00
lnNCImpRec = 0.00
lnBaseImp21 = 0.00
lnBaseImp105 = 0.00
lnAlicIVA21 = 0.00
lnAlicIVA105 = 0.00
lnSTIDesc1 = 0.00
lnSTIDesc2 = 0.00
lnSTIDesc3 = 0.00
lnSTIDesc4 = 0.00
lnSTIRec = 0.00

&& Recorro el cursor que contiene el detalle de la factura
SELECT cur_detalleFC
GO TOP

DO WHILE !EOF("cur_detalleFC")
	&& Solamente proceso aquellos registros donde se haya cargado la cantidad en Nota de Crédito
	IF cur_detalleFC.cantNC > 0 THEN
		&& Cargo las variables del detalle con los valores que están en el registro actual
		&& del cursor
		
		lnIdVentasD = cur_detalleFC.idVentasD
		lnIdArticulo = cur_detalleFC.idArticulo
		lcCodArt = cur_detalleFC.codArt
		lcDescripcio = cur_detalleFC.descripcio
		* lnCantidad = cur_detalleFC.cantidad
		lnCantidad = cur_detalleFC.cantNC
		lnCantNC = cur_detalleFC.cantNC
		lnCostoRep = cur_detalleFC.costoRep
		lnPrVenta = cur_detalleFC.prVenta
		lnPorDesc1 = cur_detalleFC.porDesc1
		lnPorDesc2 = cur_detalleFC.porDesc2
		lnPorDesc3 = cur_detalleFC.porDesc3
		lnPorDesc4 = cur_detalleFC.porDesc4
		lnImpDesc1 = cur_detalleFC.impDesc1
		lnImpDesc2 = cur_detalleFC.impDesc2
		lnImpDesc3 = cur_detalleFC.impDesc3
		lnImpDesc4 = cur_detalleFC.impDesc4
		lnPDtoVta1 = cur_detalleFC.pDtoVta1
		lnPDtoVta2 = cur_detalleFC.pDtoVta2
		lnPDtoVta3 = cur_detalleFC.pDtoVta3
		lnPDtoVta4 = cur_detalleFC.pDtoVta4
		lnIDtoVta1 = cur_detalleFC.iDtoVta1
		lnIDtoVta2 = cur_detalleFC.iDtoVta2
		lnIDtoVta3 = cur_detalleFC.iDtoVta3
		lnIDtoVta4 = cur_detalleFC.iDtoVta4
		lnTotNeto = cur_detalleFC.totNeto
		lnAlicIVA = cur_detalleFC.alicIVA
		lnImpIVA = cur_detalleFC.impIVA
		lnSubTotal = cur_detalleFC.subTotal
		lnImpNeto = cur_detalleFC.impNeto
		lnPrArtic = cur_detalleFC.prArtic
		lnporRec = cur_detalleFC.pRecVta
		lnimpRec = cur_detalleFC.iRecVta
		lnPRecItem = cur_detalleFC.pRecItem
		lnIRecItem = cur_detalleFC.iRecItem
		
		&& Armo los cálculos del ítem según la cantidad cargada para la nota de crédito
		&& Calculo del total del item
				
*!*			&& Calculo los descuentos generales sobre el precio del artículo
*!*			lnImpDesc1 = ROUND(lnPrArtic * (lnPorDesc1 / 100), 2)
*!*			lnImpDesc2 = ROUND((lnPrArtic - lnImpDesc1) * (lnPorDesc2 / 100), 2)
*!*			lnImpDesc3 = ROUND((lnPrArtic - lnImpDesc1 - lnImpDesc2) * (lnPorDesc3 / 100), 2)
*!*			lnImpDesc4 = ROUND((lnPrArtic - lnImpDesc1 - lnImpDesc2 - lnImpDesc3) * (lnPorDesc4 / 100), 2)
*!*			
*!*			lnPrVenta = lnPrArtic - lnImpDesc1 - lnImpDesc2 - lnImpDesc3 - lnImpDesc4
*!*			
*!*			&& Ahora calculo los descuentos del ítem sobre el precio final obtenido del artículo
*!*			lnIDtoVta1 = ROUND(lnPrVenta * (lnPDtoVta1 / 100), 2)
*!*			lnIDtoVta2 = ROUND((lnPrVenta - lnIDtoVta1) * (lnPDtoVta2 / 100), 2)
*!*			lnIDtoVta3 = ROUND((lnPrVenta - lnIDtoVta1 - lnIDtoVta2) * (lnPDtoVta3 / 100), 2)
*!*			lnIDtoVta4 = ROUND((lnPrVenta - lnIDtoVta1 - lnIDtoVta2 - lnIDtoVta3) * (lnPDtoVta4 / 100), 2)

*!*			lnImpNeto = lnPrVenta - lnIDtoVta1 - lnIDtoVta2 - lnIDtoVta3 - lnIDtoVta4
*!*			
*!*			&& Estas lineas se agregaron para calcular el recargo general
*!*			****************************************************
*!*			lnimpRec = ROUND(lnImpNeto * (lnporRec / 100),2)
*!*			
*!*			lnImpNeto = lnImpNeto + lnimpRec
*!*			****************************************************
*!*			&& Calculo el recargo por item
*!*			lnIRecItem = ROUND(lnImpNeto * (lnPRecItem / 100), 2)

*!*			lnImpNeto = lnImpNeto + lnIRecItem 

		lnTotItem = ROUND(lnCantNC * lnPrArtic, 2)			&& Calculo el total del precio de lista
		lnTotNeto = ROUND(lnImpNeto * lnCantNC, 2)			&& Calculo el subtotal neto
		lnImpIVA = ROUND(lnTotNeto * (lnAlicIVA / 100), 4)	&& Calculo el iva total
		lnSubTotal = lnTotNeto + ROUND(lnImpIVA, 2)			&& Calculo el subtotal del ítem
		
		&& Multiplico los descuentos por la cantidad para calcular el subtotal
		&& de descuentos
		lnSTIDesc1 = ROUND(lnImpDesc1 * lnCantNC, 2)
		lnSTIDesc2 = ROUND(lnImpDesc2 * lnCantNC, 2)
		lnSTIDesc3 = ROUND(lnImpDesc3 * lnCantNC, 2)
		lnSTIDesc4 = ROUND(lnImpDesc4 * lnCantNC, 2)
		lnSTIRec = ROUND(lnImpRec * lnCantNC, 2)
		
		&& Ahora calculo los totales
		lnNCImpNeto = lnNCImpNeto + lnTotItem
		lnNCImpDesc1 = lnNCImpDesc1 + lnSTIDesc1 
		lnNCImpDesc2 = lnNCImpDesc2 + lnSTIDesc2
		lnNCImpDesc3 = lnNCImpDesc3 + lnSTIDesc3
		lnNCImpDesc4 = lnNCImpDesc4 + lnSTIDesc4
		lnNCImpRec = lnNCImpRec + lnSTIRec 
		lnNCImpFinal = lnNCImpFinal + lnTotNeto

		IF lnAlicIVA = 21 THEN
			lnBaseImp21 = lnBaseImp21 + lnTotNeto
			lnAlicIVA21 = lnAlicIVA
			lnNCImpIVA21 = lnNCImpIVA21 + lnImpIVA
		ELSE
			IF lnAlicIVA = 10.5 THEN 
				lnBaseImp105 = lnBaseImp105 + lnTotNeto
				lnAlicIVA105 = lnAlicIVA
				lnNCImpIVA105 = lnNCImpIVA105 + lnImpIVA
			ENDIF 
		ENDIF

		SELECT cur_detalle
		APPEND BLANK
		REPLACE cur_detalle.idVentasD WITH lnIdVentasD
		REPLACE cur_detalle.idArticulo WITH lnIdArticulo ADDITIVE 
		REPLACE cur_detalle.codArt WITH ALLTRIM(lcCodArt) ADDITIVE
		REPLACE cur_detalle.descripcio WITH ALLTRIM(lcDescripcio) ADDITIVE
		REPLACE cur_detalle.cantidad WITH lnCantidad ADDITIVE
		REPLACE cur_detalle.cantNC WITH lnCantNC ADDITIVE
		REPLACE cur_detalle.nroPart WITH cur_detalleFC.nroPart ADDITIVE
		REPLACE cur_detalle.costoRep WITH lnCostoRep ADDITIVE
		REPLACE cur_detalle.prVenta WITH lnPrVenta ADDITIVE
		REPLACE cur_detalle.porDesc1 WITH lnPorDesc1 ADDITIVE
		REPLACE cur_detalle.porDesc2 WITH lnPorDesc2 ADDITIVE
		REPLACE cur_detalle.porDesc3 WITH lnPorDesc3 ADDITIVE
		REPLACE cur_detalle.porDesc4 WITH lnPorDesc4 ADDITIVE
		REPLACE cur_detalle.impDesc1 WITH lnImpDesc1 ADDITIVE
		REPLACE cur_detalle.impDesc2 WITH lnImpDesc2 ADDITIVE
		REPLACE cur_detalle.impDesc3 WITH lnImpDesc3 ADDITIVE
		REPLACE cur_detalle.impDesc4 WITH lnImpDesc4 ADDITIVE
		REPLACE cur_detalle.pDtoVta1 WITH lnPDtoVta1 ADDITIVE
		REPLACE cur_detalle.pDtoVta2 WITH lnPDtoVta2 ADDITIVE
		REPLACE cur_detalle.pDtoVta3 WITH lnPDtoVta3 ADDITIVE
		REPLACE cur_detalle.pDtoVta4 WITH lnPDtoVta4 ADDITIVE
		REPLACE cur_detalle.iDtoVta1 WITH lnIDtoVta1 ADDITIVE
		REPLACE cur_detalle.iDtoVta2 WITH lnIDtoVta2 ADDITIVE
		REPLACE cur_detalle.iDtoVta3 WITH lnIDtoVta3 ADDITIVE
		REPLACE cur_detalle.iDtoVta4 WITH lnIDtoVta4 ADDITIVE
		REPLACE cur_detalle.totNeto WITH lnTotNeto ADDITIVE
		REPLACE cur_detalle.alicIVA WITH lnAlicIVA ADDITIVE
		REPLACE cur_detalle.impIVA WITH lnImpIVA ADDITIVE
		REPLACE cur_detalle.subTotal WITH lnSubTotal ADDITIVE
		REPLACE cur_detalle.impNeto WITH lnImpNeto ADDITIVE
		REPLACE cur_detalle.prArtic WITH lnPrArtic ADDITIVE
		REPLACE cur_detalle.pRecVta WITH lnporRec ADDITIVE
		REPLACE cur_detalle.iRecVta WITH lnimpRec ADDITIVE 
		REPLACE cur_detalle.pRecItem WITH lnPRecItem ADDITIVE
		REPLACE cur_detalle.iRecItem WITH lnIRecItem ADDITIVE 
	ENDIF
	
	SELECT cur_detalleFC
	SKIP
ENDDO

lnNCPorRec = Thisform.contenido.paginas.page2.txtFCporRec.Value 
lnNCPorIIBB = Thisform.contenido.paginas.page2.txtFCPorIIBB.Value
lnNCImpIIBB = ROUND(lnNCImpFinal * (lnNCPorIIBB / 100),2)
lnNCTotFact = ROUND(lnNCImpFinal + lnNCImpIVA21 + lnNCImpIVA105 + lnNCImpIIBB, 2)

Thisform.contenido.paginas.page2.txtNCImpDto1.Value = lnNCImpDesc1
Thisform.contenido.paginas.page2.txtNCImpDto2.Value = lnNCImpDesc2
Thisform.contenido.paginas.page2.txtNCImpDto3.Value = lnNCImpDesc3
Thisform.contenido.paginas.page2.txtNCImpDto4.Value = lnNCImpDesc4
Thisform.contenido.paginas.page2.txtNCImpFinal.Value = lnNCImpFinal
Thisform.contenido.paginas.page2.txtNCPorIIBB.Value = lnNCPorIIBB
Thisform.contenido.paginas.page2.txtNCImpIIBB.Value = lnNCImpIIBB
Thisform.contenido.paginas.page2.txtNCImpIVA105.Value = ROUND(lnNCImpIVA105, 2)
Thisform.contenido.paginas.page2.txtNCImpIVA21.Value = ROUND(lnNCImpIVA21, 2)
Thisform.contenido.paginas.page2.txtNCImpNeto.Value = lnNCImpNeto
Thisform.contenido.paginas.page2.txtNCTotFact.Value = lnNCTotFact
Thisform.contenido.paginas.page2.txtNCPorDto1.Value = Thisform.contenido.paginas.page2.txtFCPorDto1.Value
Thisform.contenido.paginas.page2.txtNCPorDto2.Value = Thisform.contenido.paginas.page2.txtFCPorDto2.Value
Thisform.contenido.paginas.page2.txtNCPorDto3.Value = Thisform.contenido.paginas.page2.txtFCPorDto3.Value
Thisform.contenido.paginas.page2.txtNCPorDto4.Value = Thisform.contenido.paginas.page2.txtFCPorDto4.Value
Thisform.contenido.paginas.page2.txtNCporRec.Value = lnNCPorRec
Thisform.contenido.paginas.page2.txtNCimpRec.Value = lnNCImpRec

*!*	thisform.datos_cbtes.lnncimpdesc1 = thisform.contenido.paginas.page2.txtNCImpDto1.Value
*!*	thisform.datos_cbtes.lnncimpdesc2 = thisform.contenido.paginas.page2.txtNCImpDto2.Value
*!*	thisform.datos_cbtes.lnncimpdesc3 = thisform.contenido.paginas.page2.txtNCImpDto3.Value
*!*	thisform.datos_cbtes.lnncimpdesc4 = thisform.contenido.paginas.page2.txtNCImpDto4.Value
*!*	thisform.datos_cbtes.lnncimpfinal = thisform.contenido.paginas.page2.txtNCImpFinal.Value
*!*	thisform.datos_cbtes.lnncporiibb = thisform.contenido.paginas.page2.txtNCPorIIBB.Value
*!*	thisform.datos_cbtes.lnncimpiibb = thisform.contenido.paginas.page2.txtNCImpIIBB.Value
*!*	thisform.datos_cbtes.lnncimpiva105 = thisform.contenido.paginas.page2.txtNCImpIVA105.Value
*!*	thisform.datos_cbtes.lnncimpiva21 = thisform.contenido.paginas.page2.txtNCImpIVA21.Value
*!*	thisform.datos_cbtes.lnncimpneto = thisform.contenido.paginas.page2.txtNCImpNeto.Value
*!*	thisform.datos_cbtes.lnnctotfact = thisform.contenido.paginas.page2.txtNCTotFact.Value
*!*	thisform.datos_cbtes.lnncpordto1 = thisform.contenido.paginas.page2.txtNCPorDto1.Value
*!*	thisform.datos_cbtes.lnncpordto2 = thisform.contenido.paginas.page2.txtNCPorDto2.Value
*!*	thisform.datos_cbtes.lnncpordto3 = thisform.contenido.paginas.page2.txtNCPorDto3.Value
*!*	thisform.datos_cbtes.lnncpordto4 = thisform.contenido.paginas.page2.txtNCPorDto4.Value
*!*	thisform.datos_cbtes.lnncporrec = thisform.contenido.paginas.page2.txtNCporRec.Value 
*!*	thisform.datos_cbtes.lnncimprec = thisform.contenido.paginas.page2.txtNCimpRec.Value 

SELECT cur_detalleFC
GO TOP

SELECT cur_detalle
GO TOP


ENDPROC
PROCEDURE imprimir
LOCAL m.NroCli, m.RazSoc, m.Telefono, m.direccion, m.localidad, m.codPostal, m.pcia, m.TipoIVA, m.nroCUIT
LOCAL m.Total, m.tipoDoc, m.NroCbte, m.Fecha, m.leyenda, m.fecVto, m.tipoDoc, m.ptoVta
LOCAL m.porDesc1, m.porDesc2, m.porDesc3, m.porDesc4
LOCAL m.impDesc1, m.impDesc2, m.impDesc3, m.impDesc4
LOCAL m.porIIBB, m.impIIBB, m.observ
LOCAL m.porIVA105, m.impIVA105, m.porIVA21, m.impIVA21, m.impNeto, m.impFinal
LOCAL lcSql, loResult, lcPrinterName, lnCantCpia
LOCAL m.vendedor, m.nroOC
LOCAL m.porRec

loResult = CREATEOBJECT("odbc_result")
lcSql = ""

lcSql = "SELECT clientes.*, localidad.descripcio as descLoc, localidad.codPostal, provincias.descripcio as pcia, sitiva.descripcio as sitiva "
lcSql = lcSql + "FROM clientes INNER JOIN localidad ON localidad.idLocalid = clientes.idLocalid "
lcSql = lcSql + "	INNER JOIN provincias ON provincias.idProvin = localidad.idProvin "
lcSql = lcSql + "	INNER JOIN sitiva ON sitiva.idsitiva = clientes.idsitiva "
lcSql = lcSql + "WHERE clientes.idCliente = " + ALLTRIM(STR(thisform.contenido.sel_cliente.valcpoid))
lcSql = lcSql + " AND sitiva.idsitiva = " + ALLTRIM(STR(Thisform.datos_cbtes.idsitiva))

loResult.ActiveConnection = goConn.ActiveConnection
loResult.Cursor_Name = "cur_cli"

IF !loResult.OpenQuery(lcSql) THEN
	MESSAGEBOX(loResult.Error_Message, 0+48, thisform.Caption)
	RETURN .F.
ENDIF

SELECT cur_cli
m.NroCli = cur_cli.idCliente
m.RazSoc = ALLTRIM(thisform.datos_cbtes.cli_razsoc)
m.Telefono = ALLTRIM(cur_cli.telefono)
m.direccion = ALLTRIM(cur_cli.direccion)
m.localidad = ALLTRIM(cur_cli.descLoc)
m.codPostal = ALLTRIM(cur_cli.codPostal)
m.pcia = ALLTRIM(cur_cli.pcia)
m.nroCUIT = ALLTRIM(thisform.datos_cbtes.cli_nrodoc)
m.TipoIVA = ALLTRIM(cur_cli.sitiva)
m.porRec = 0.00

loResult.close_query()

m.Total = 0.00
m.tipoDoc = ""

m.NroCbte = REPLICATE("0", 4 - LEN(ALLTRIM(STR(thisform.datos_cbtes.ptovta)))) + ALLTRIM(STR(thisform.datos_cbtes.ptovta)) + "-" + ;
	REPLICATE("0", 8 - LEN(ALLTRIM(STR(thisform.datos_cbtes.numcbte)))) + ALLTRIM(STR(thisform.datos_cbtes.numcbte))
	
m.leyenda = ""
m.Fecha = DATETIME()
m.porIVA105 = 0.00
m.porIVA21 = 0.00
m.impIVA105 = 0.00
m.impIVA21 = 0.00
m.impNeto = 0.00
m.impFinal = 0.00
m.fecVto = DATE()
m.tipoDoc = this.datos_cbtes.tipodoc
m.ptoVta = this.datos_cbtes.ptovta
m.porIIBB = 0.00
m.impIIBB = 0.00
lnCantCpia = 0
m.observ = thisform.datos_cbtes.observ
m.total = thisform.contenido.paginas.page2.txtNcTotFact.Value

m.Leyenda = "NOTA DE CREDITO"
m.tipoDoc = thisform.datos_cbtes.tipodoc

m.porDesc1 = thisform.contenido.paginas.page2.txtNCPorDto1.Value
m.porDesc2 = thisform.contenido.paginas.page2.txtNCPorDto2.Value
m.porDesc3 = thisform.contenido.paginas.page2.txtNCPorDto3.Value
m.porDesc4 = thisform.contenido.paginas.page2.txtNCPorDto4.Value
m.impDesc1 = thisform.contenido.paginas.page2.txtNCImpDto1.Value
m.impDesc2 = thisform.contenido.paginas.page2.txtNCImpDto2.Value
m.impDesc3 = thisform.contenido.paginas.page2.txtNCImpDto3.Value
m.impDesc4 = thisform.contenido.paginas.page2.txtNCImpDto4.Value
m.porIVA105 = 10.5
m.porIVA21 = 21
m.impIVA105 = thisform.contenido.paginas.page2.txtNCImpIVA105.Value
m.impIVA21 = thisform.contenido.paginas.page2.txtNCImpIVA21.Value
&&m.impNeto = thisform.contenido.paginas.page2.txtNCImpNeto.Value
m.impNeto = thisform.contenido.paginas.page2.txtNCImpFinal.Value
m.porIIBB = thisform.contenido.paginas.page2.txtNCPorIIBB.Value
m.impIIBB = thisform.contenido.paginas.page2.txtNCImpIIBB.Value

m.vendedor = thisform.nombre_usuario
m.nroOC = ""

&& Creo el cursor cur_aux para imprimir el detalle del comprobante
SELECT cur_aux
ZAP

SELECT cur_detalle
GO TOP
DO WHILE !EOF("cur_detalle")
	SELECT cur_aux
	APPEND BLANK
	REPLACE cur_aux.idVentasD WITH cur_detalle.idVentasD
	REPLACE cur_aux.idArticulo WITH cur_detalle.idArticulo ADDITIVE
	REPLACE cur_aux.codArt WITH cur_detalle.codArt ADDITIVE
	REPLACE cur_aux.descripcio WITH cur_detalle.descripcio ADDITIVE
	REPLACE cur_aux.cantidad WITH cur_detalle.cantidad ADDITIVE
	REPLACE cur_aux.cantNC WITH 0 ADDITIVE
	REPLACE cur_aux.nroPart WITH cur_detalle.nroPart ADDITIVE
	REPLACE cur_aux.costoRep WITH cur_detalle.costoRep ADDITIVE
	REPLACE cur_aux.porDesc1 WITH cur_detalle.porDesc1 ADDITIVE
	REPLACE cur_aux.porDesc2 WITH cur_detalle.porDesc2 ADDITIVE
	REPLACE cur_aux.porDesc3 WITH cur_detalle.porDesc3 ADDITIVE
	REPLACE cur_aux.porDesc4 WITH cur_detalle.porDesc4 ADDITIVE
	REPLACE cur_aux.impDesc1 WITH cur_detalle.impDesc1 ADDITIVE
	REPLACE cur_aux.impDesc2 WITH cur_detalle.impDesc2 ADDITIVE
	REPLACE cur_aux.impDesc3 WITH cur_detalle.impDesc3 ADDITIVE
	REPLACE cur_aux.impDesc4 WITH cur_detalle.impDesc4 ADDITIVE
	REPLACE cur_aux.pDtoVta1 WITH cur_detalle.pDtoVta1 ADDITIVE
	REPLACE cur_aux.pDtoVta2 WITH cur_detalle.pDtoVta2 ADDITIVE
	REPLACE cur_aux.pDtoVta3 WITH cur_detalle.pDtoVta3 ADDITIVE
	REPLACE cur_aux.pDtoVta4 WITH cur_detalle.pDtoVta4 ADDITIVE
	REPLACE cur_aux.iDtoVta1 WITH cur_detalle.iDtoVta1 ADDITIVE
	REPLACE cur_aux.iDtoVta2 WITH cur_detalle.iDtoVta2 ADDITIVE
	REPLACE cur_aux.iDtoVta3 WITH cur_detalle.iDtoVta3 ADDITIVE
	REPLACE cur_aux.iDtoVta4 WITH cur_detalle.iDtoVta4 ADDITIVE
	REPLACE cur_aux.totNeto WITH cur_detalle.totNeto ADDITIVE
	REPLACE cur_aux.alicIVA WITH cur_detalle.alicIVA ADDITIVE
	REPLACE cur_aux.impIVA WITH cur_detalle.impIVA ADDITIVE
	REPLACE cur_aux.subTotal WITH cur_detalle.subTotal ADDITIVE
	REPLACE cur_aux.impNeto WITH cur_detalle.impNeto ADDITIVE
	REPLACE cur_aux.prArtic WITH cur_detalle.prArtic ADDITIVE
	REPLACE cur_aux.pRecVta WITH cur_detalle.pRecVta ADDITIVE
	REPLACE cur_aux.iRecVta WITH cur_detalle.iRecVta ADDITIVE
	
	SELECT cur_detalle
	SKIP
ENDDO

SELECT cur_aux
GO TOP
	
SET PRINTER TO NAME ALLTRIM(thisform.datos_cbtes.printerdevice)

FOR i = 1 TO thisform.datos_cbtes.cant_copianc
	IF ALLTRIM(This.datos_cbtes.tipodoc) == "X" THEN
		&& Imprime un comprobante de tipo "X"
		REPORT FORM "reppto.frx" TO PRINTER NOCONSOLE
	ELSE
		IF ALLTRIM(This.datos_cbtes.tipodoc) == "A" THEN
			&& Imprime el comprobante de tipo "A"
			REPORT FORM "repcbtesvta.frx" TO PRINTER NOCONSOLE
		ELSE
			&& Imprime el comprobante de tipo "B"
			REPORT FORM "repcbtesvta_b.frx" TO PRINTER NOCONSOLE
		ENDIF
	ENDIF 
NEXT

thisform.datos_cbtes.limpiar()

RETURN .T.
ENDPROC
PROCEDURE validar_cantidadnc
LOCAL lnValidar

lnValidar = 0

IF RECCOUNT("cur_detalleFC") > 0 THEN 
	GO TOP 
ENDIF 

SELECT cur_detalleFC
DO WHILE !EOF()
	IF cur_detalleFC.CantNC > cur_detalleFC.Cantidad .OR. cur_detalleFC.CantNC < 0 THEN 
		lnValidar = 1
	ENDIF 
	
	SELECT cur_detalleFC
	SKIP 
ENDDO 

IF lnValidar = 1
	MESSAGEBOX("La cantidad de la Nota de Crédito no puede ser negativa o mayor a la cantidad del comprobante original. Revise las cantidad ingresadas.",0+48,thisform.Caption)	
	RETURN .F.
ENDIF 

ENDPROC
PROCEDURE limpiar
thisform.contenido.paginas.page1.btnAceptar.Enabled = .T.
thisform.contenido.btnBuscarFC.Enabled = .T.
thisform.contenido.sel_cliente.txtCodigo.SetFocus()
thisform.contenido.sel_cliente.blanquear()
thisform.datos_cbtes.limpiar()
thisform.contenido.txtcbte.Value = ""
thisform.contenido.txtnrocbte.Value = ""
thisform.contenido.txttipo.Value = ""

&& Limpio los cuadros de textos que tienen los totales
Thisform.contenido.paginas.page2.txtFCImpDto1.Value = 0.00
Thisform.contenido.paginas.page2.txtFCImpDto2.Value = 0.00
Thisform.contenido.paginas.page2.txtFCImpDto3.Value = 0.00
Thisform.contenido.paginas.page2.txtFCImpDto4.Value = 0.00
Thisform.contenido.paginas.page2.txtFCImpFinal.Value = 0.00
Thisform.contenido.paginas.page2.txtFCimpIIBB.Value = 0.00
Thisform.contenido.paginas.page2.txtFCporRec.Value = 0.00
Thisform.contenido.paginas.page2.txtFCimpRec.Value = 0.00
Thisform.contenido.paginas.page2.txtFCImpIVA105.Value = 0.00
Thisform.contenido.paginas.page2.txtFCImpIVA21.Value = 0.00
Thisform.contenido.paginas.page2.txtFCImpNeto.Value = 0.00
Thisform.contenido.paginas.page2.txtFCPorDto1.Value = 0.00
Thisform.contenido.paginas.page2.txtFCPorDto2.Value = 0.00
Thisform.contenido.paginas.page2.txtFCPorDto3.Value = 0.00
Thisform.contenido.paginas.page2.txtFCPorDto4.Value = 0.00
Thisform.contenido.paginas.page2.txtFCPorIIBB.Value = 0.00
Thisform.contenido.paginas.page2.txtFCTotFact.Value = 0.00
Thisform.contenido.paginas.page2.txtNCImpDto1.Value = 0.00
Thisform.contenido.paginas.page2.txtNCImpDto2.Value = 0.00
Thisform.contenido.paginas.page2.txtNCImpDto3.Value = 0.00
Thisform.contenido.paginas.page2.txtNCImpDto4.Value = 0.00
Thisform.contenido.paginas.page2.txtNCImpFinal.Value = 0.00
Thisform.contenido.paginas.page2.txtNCImpIIBB.Value = 0.00
Thisform.contenido.paginas.page2.txtNCporRec.Value = 0.00
Thisform.contenido.paginas.page2.txtNCimpRec.Value = 0.00
Thisform.contenido.paginas.page2.txtNCImpIVA105.Value = 0.00
Thisform.contenido.paginas.page2.txtNCImpIVA21.Value = 0.00
Thisform.contenido.paginas.page2.txtNCImpNeto.Value = 0.00
Thisform.contenido.paginas.page2.txtNCPorDto1.Value = 0.00
Thisform.contenido.paginas.page2.txtNCPorDto2.Value = 0.00
Thisform.contenido.paginas.page2.txtNCPorDto3.Value = 0.00
Thisform.contenido.paginas.page2.txtNCPorDto4.Value = 0.00
Thisform.contenido.paginas.page2.txtNCPorIIBB.Value = 0.00
Thisform.contenido.paginas.page2.txtNCTotFact.Value = 0.00

SELECT cur_Cbtes
ZAP
ENDPROC
PROCEDURE Init
DODEFAULT()
Thisform.datos_cbtes.crear_cursor()

SELECT cur_detalleFC
Thisform.contenido.paginas.page1.grdItems.alias_name = "cur_detalleFC"
Thisform.contenido.paginas.page1.grdItems.RecordSource = "cur_detalleFC"
Thisform.contenido.paginas.page1.grdItems.list_controlsource = "codArt,descripcio,cantidad,cantNC,nroPart,prVenta,alicIVA,impIVA,subTotal"
Thisform.contenido.paginas.page1.grdItems.lista_ancho_cols = "100,300,70,70,150,70,70,70,70,70"
Thisform.contenido.paginas.page1.grdItems.titulos_cabeceras = "Código,Descripción,Cantidad,Cant. NC.,Nro. Partida,Precio,% I.V.A,$ I.V.A,Sub-Total"
Thisform.contenido.paginas.page1.grdItems.generar_grid()

Thisform.contenido.paginas.page1.grdItems.Columns[4].ReadOnly = .F.

&& Acomodo los formatos del 3 al 9
Thisform.contenido.paginas.page1.grdItems.Columns[3].InputMask = "999999999.99"
Thisform.contenido.paginas.page1.grdItems.Columns[4].InputMask = "999999999.99"
Thisform.contenido.paginas.page1.grdItems.Columns[6].InputMask = "999999999.99"
Thisform.contenido.paginas.page1.grdItems.Columns[7].InputMask = "999999999.99"
Thisform.contenido.paginas.page1.grdItems.Columns[8].InputMask = "999999999.99"
Thisform.contenido.paginas.page1.grdItems.Columns[9].InputMask = "999999999.99"

SELECT cur_detalle
Thisform.contenido.paginas.page1.grdItemNC.alias_name = "cur_detalle"
Thisform.contenido.paginas.page1.grdItemNC.RecordSource = "cur_detalle"
Thisform.contenido.paginas.page1.grdItemNC.list_controlsource = "codArt,descripcio,cantidad,cantNC,nroPart,prVenta,alicIVA,impIVA,subTotal"
Thisform.contenido.paginas.page1.grdItemNC.lista_ancho_cols = "100,300,70,70,150,70,70,70,70,70"
Thisform.contenido.paginas.page1.grdItemNC.titulos_cabeceras = "Código,Descripción,Cantidad,Cant. NC.,Nro.Partida,Precio,% I.V.A,$ I.V.A,Sub-Total"
Thisform.contenido.paginas.page1.grdItemNC.generar_grid()

&& Acomodo los formatos del 3 al 9
Thisform.contenido.paginas.page1.grdItemNC.Columns[3].InputMask = "999999999.99"
Thisform.contenido.paginas.page1.grdItemNC.Columns[4].InputMask = "999999999.99"
Thisform.contenido.paginas.page1.grdItemNC.Columns[7].InputMask = "999999999.99"
Thisform.contenido.paginas.page1.grdItemNC.Columns[8].InputMask = "999999999.99"
Thisform.contenido.paginas.page1.grdItemNC.Columns[9].InputMask = "999999999.99"

Thisform.Contenido.txtFecEmis.Value = DATE()
ENDPROC
PROCEDURE validardetalle
SELECT cur_detalle
IF RECCOUNT("cur_detalle") = 0 THEN
	MESSAGEBOX("No se ha ingresado artículos para generar la nota de crédito", 0+48, Thisform.Caption)
	Thisform.contenido.paginas.page1.grdItems.SetFocus()
	RETURN .F.
ENDIF

IF thisform.contenido.sel_cliente.valcpoid = 0 THEN
	MESSAGEBOX("Debe ingresar el cliente", 0+48, Thisform.Caption)
	thisform.contenido.sel_cliente.txtCodigo.SetFocus()
	RETURN .F.
ENDIF

SELECT cur_detalleFC
IF RECCOUNT("cur_detalleFC") = 0 THEN
	MESSAGEBOX("No se puede hacer notas de créditos si no selecciona la factura de origen", 0+48, Thisform.Caption)
	thisform.contenido.btnBuscarFC.SetFocus()
	RETURN .F.
ENDIF

IF Thisform.fecemis_fc > Thisform.Contenido.txtFecEmis.Value THEN
	MESSAGEBOX("Atención, está queriendo emitir una nota de crédito con fecha anterior a la factura seleccionada", ;
		0+48, Thisform.Caption)
	RETURN .F.
ENDIF

lnDiasDif = DATE() - Thisform.Contenido.txtFecEmis.Value
IF lnDiasDif > 5 THEN
	MESSAGEBOX("Fecha de emisión fuera de rango.", 0+48, Thisform.Caption)
	Thisform.Contenido.txtFecEmis.SetFocus()
	RETURN .F.
ENDIF

IF lnDiasDif < 0 THEN
	MESSAGEBOX("Está intentado emitir facturas con fecha superior a la actual", 0+48, Thisform.Caption)
	Thisform.Contenido.txtFecEmis.SetFocus()
	RETURN .F.
ENDIF

RETURN .T.
ENDPROC
PROCEDURE Load
DODEFAULT()

&& Este cursor va a contener los pedidos pendientes de facturar para cuando
&& se quiera levantar los mismos a partir de una factura.
CREATE CURSOR cur_Cbtes (	;
	sel			L,;
	idVentasC	int,;
	fecEmision	D,;
	numCbte		varchar(20),;
	idCliente	int,;
	razSoc		varchar(60),;
	totFact		double,;
	idTipoDoc	int,;
	nroDoc		varchar(20)) 

SELECT cur_Cbtes
INDEX ON idVentasC TAG idVentasC ASCENDING
INDEX ON fecEmision TAG fecEmision ASCENDING ADDITIVE
INDEX ON numCbte TAG numCbte ASCENDING ADDITIVE
INDEX ON idCliente TAG idCliente ASCENDING ADDITIVE
INDEX ON razSoc TAG razSoc ASCENDING ADDITIVE
INDEX ON totFact TAG totFact ASCENDING ADDITIVE
ENDPROC


************************************************************
OBJETO: datos_cbtes
************************************************************
*** PROPIEDADES ***
Top = 456
Left = 96
Height = 17
Width = 19
Name = "datos_cbtes"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta1
************************************************************
*** PROPIEDADES ***
BorderStyle = 0
Caption = "Cliente:"
Height = 15
Left = 13
Top = 14
Width = 60
TabIndex = 4
Name = "Clsetiqueta1"

*** METODOS ***


************************************************************
OBJETO: sel_cliente
************************************************************
*** PROPIEDADES ***
Top = 9
Left = 73
TabIndex = 1
nombre_tabla = clientes
pkfield = idCliente
nombre_campo_codigo = idCliente
nombre_campo_desc = razSoc
esnumerico = .T.
Name = "sel_cliente"
txtCodigo.Name = "txtCodigo"
txtDescripcion.Name = "txtDescripcion"

*** METODOS ***
PROCEDURE recuperar_datos
LOCAL lo_rsSitIVA, lo_rsCondPago, lo_rsLocalidad, lo_rsPcia, lo_rsIIBB, lcSql
LOCAL loResult

DODEFAULT()

lo_rsSitIVA = CREATEOBJECT("odbc_result")
lo_rsCondPago = CREATEOBJECT("odbc_result")
lo_rsLocalidad = CREATEOBJECT("odbc_result")
lo_rsPcia = CREATEOBJECT("odbc_result")
lo_rsIIBB = CREATEOBJECT("odbc_result")
loResult = CREATEOBJECT("odbc_result")
lcSql = ""

SELECT clientes
lcSql = "SELECT * FROM tipodoc WHERE idTipoDoc = " + ALLTRIM(STR(clientes.idTipoDoc))

loResult.ActiveConnection = goConn.ActiveConnection
loResult.cursor_name = "cur_x"

IF !loResult.OpenQuery(lcSql) THEN
	MESSAGEBOX(loResult.Error_Message, 0+48, Thisform.Caption)
	RETURN
ENDIF

Thisform.cli_tipodoc = cur_x.tipodoc
Thisform.cli_idtipodoc = cur_x.idTipoDoc

loResult.Close_Query()

Thisform.cli_calle = clientes.direccion
Thisform.cli_cuit = clientes.nroCUIT
Thisform.cli_telefono = clientes.telefono
Thisform.cli_Id = clientes.idCliente
thisform.envcbte = clientes.envcbte
thisform.mailfc = clientes.mailfc
thisform.printcbte = clientes.printcbte

lcSql = "SELECT * FROM localidad WHERE idLocalid = " + ALLTRIM(STR(clientes.idLocalid))
lo_rsLocalidad.ActiveConnection = goConn.ActiveConnection
lo_rsLocalidad.Cursor_Name = "cur_Localid"
lo_rsLocalidad.OpenQuery(lcSql)

SELECT cur_Localid
Thisform.cli_localidad = cur_Localid.descripcio
Thisform.cli_codpostal = cur_Localid.codPostal

lcSql = "SELECT * FROM provincias WHERE idProvin = " + ALLTRIM(STR(cur_Localid.idProvin))
lo_rsPcia.ActiveConnection = goConn.ActiveConnection
lo_rsPcia.Cursor_Name = "cur_Pcia"
lo_rsPcia.OpenQuery(lcSql)

SELECT cur_Pcia
Thisform.cli_pcia = cur_Pcia.descripcio

lo_rsPcia.close_query()
lo_rsLocalidad.close_query()

lcSql = "SELECT * FROM sitiva WHERE idSitIVA = " + ALLTRIM(STR(clientes.idSitIVA))
lo_rsSitIVA.ActiveConnection = goConn.ActiveConnection
lo_rsSitIVA.Cursor_Name = "cur_SitIVA"
lo_rsSitIVA.OpenQuery(lcSql)

SELECT cur_SitIVA
Thisform.sitivacli = cur_SitIVA.idSitIVA
Thisform.CodIVAFiscal = cur_SitIVA.CodFiscal

lo_rsSitIVA.close_query()

lcSql = "SELECT * FROM condpagos WHERE idCondPago = " + ALLTRIM(STR(clientes.idCondPago))
lo_rsCondPago.ActiveConnection = goConn.ActiveConnection
lo_rsCondPago.Cursor_Name = "cur_CondPago"
lo_rsCondPago.OpenQuery(lcSql)

SELECT cur_CondPago
Thisform.cli_condpago = IIF(cur_CondPago.idCondPago = 1, "CONTADO", "CUENTAS CORRIENTES")

lo_rsCondPago.Close_Query();




ENDPROC


************************************************************
OBJETO: btnBuscarFC
************************************************************
*** PROPIEDADES ***
Top = 9
Left = 561
Height = 24
Width = 120
Caption = "\<Buscar Facturas"
TabIndex = 2
Name = "btnBuscarFC"

*** METODOS ***
PROCEDURE Click
LOCAL loForm
LOCAL lnSaldo

loForm = CREATEOBJECT("cls_busca_fcorigen_sf")
loForm.cbte = "NC"

SELECT cur_Cbtes
ZAP

IF Thisform.Contenido.sel_Cliente.txtCodigo.Value = 0 THEN
	MESSAGEBOX("Debe ingresar el código de cliente", 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

IF ALLTRIM(Thisform.cli_tipodoc) == "" THEN
	MESSAGEBOX("Atención: El cliente no tiene el tipo de documento cargado, por favor edite el cliente y vuelva a intentarlo", 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

IF ALLTRIM(Thisform.cli_cuit) == "" THEN
	MESSAGEBOX("Atención: El cliente no tiene el número de DNI/CUIT cargado, por favor edite el cliente y vuelva a intentarlo", 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

loForm.idCliente = Thisform.Contenido.sel_Cliente.valcpoid
=loForm.llenar_grilla()
=loForm.show()

&& Valido que loForm sea un objeto
IF ALLTRIM(TYPE('loForm')) == "O" THEN
	IF loForm.press_aceptar THEN
		Thisform.idOrigen = loForm.valor_id
		Thisform.saldo_fc = loForm.saldo
		Thisform.cli_idtipodoc = loForm.cli_idTipoDoc
		Thisform.cli_cuit = loForm.cli_nroDoc
		Thisform.cli_razsoc = loForm.cli_razsoc
		Thisform.fecemis_fc = loForm.fecEmision

		thisform.datos_cbtes.id_Vta_origen = loForm.valor_id
		IF !Thisform.datos_cbtes.recuperar_fc() THEN
			MESSAGEBOX(Thisform.datos_cbtes.error_message, 0+48, Thisform.Caption)
			RETURN .F.
		ENDIF
		
		=Thisform.Contenido.Paginas.page1.grdItems.Refresh()
		
		thisform.contenido.txtcbte.Value = thisform.datos_cbtes.cbte_origen
		thisform.contenido.txttipo.Value = thisform.datos_cbtes.tipodoc_origen
		thisform.contenido.txtnrocbte.Value = thisform.datos_cbtes.nrocbte_origen
		thisform.contenido.paginas.page2.txtFCImpDto1.Value = thisform.datos_cbtes.impdesc1
		thisform.contenido.paginas.page2.txtFCImpDto2.Value = thisform.datos_cbtes.impdesc2
		thisform.contenido.paginas.page2.txtFCImpDto3.Value = thisform.datos_cbtes.impdesc3
		thisform.contenido.paginas.page2.txtFCImpDto4.Value = thisform.datos_cbtes.impdesc4
		thisform.contenido.paginas.page2.txtFCImpFinal.Value = thisform.datos_cbtes.impfinal
		thisform.contenido.paginas.page2.txtFCImpIVA105.Value = thisform.datos_cbtes.impiva105
		thisform.contenido.paginas.page2.txtFCImpIVA21.Value = thisform.datos_cbtes.impiva21
		thisform.contenido.paginas.page2.txtFCImpNeto.Value = thisform.datos_cbtes.impneto
		thisform.contenido.paginas.page2.txtFCPorDto1.Value = thisform.datos_cbtes.pordesc1
		thisform.contenido.paginas.page2.txtFCPorDto2.Value = thisform.datos_cbtes.pordesc2
		thisform.contenido.paginas.page2.txtFCPorDto3.Value = thisform.datos_cbtes.pordesc3
		thisform.contenido.paginas.page2.txtFCPorDto4.Value = thisform.datos_cbtes.pordesc4
		thisform.contenido.paginas.page2.txtFCPorIIBB.Value = thisform.datos_cbtes.poriibb
		thisform.contenido.paginas.page2.txtFCimpIIBB.Value = thisform.datos_cbtes.impiibb
		thisform.contenido.paginas.page2.txtFCTotFact.Value = thisform.datos_cbtes.totfact
		thisform.contenido.paginas.page2.txtFCImpNeto.Value = thisform.datos_cbtes.impneto
		thisform.contenido.paginas.page2.txtFCporRec.Value = thisform.datos_cbtes.porRec
		thisform.contenido.paginas.page2.txtFCimpRec.Value = thisform.datos_cbtes.impRec
		
		lnSaldo = thisform.datos_cbtes.verificar_estado_fc()
		IF lnSaldo = 0 THEN
			thisform.contenido.lblEstadoCbte.Caption = "Este comprobante se encuentra cancelado"
		ELSE
			thisform.contenido.lblEstadoCbte.Caption = "Este comprobante tiene " ;
					+ "un saldo deudor de $" + ALLTRIM(STR(lnSaldo, 10, 2))
		ENDIF
		
		thisform.contenido.btnBuscarFC.Enabled = .F.
		thisform.contenido.paginas.page1.grdItems.SetFocus()
	ENDIF
ENDIF

RETURN .T.

ENDPROC


************************************************************
OBJETO: paginas
************************************************************
*** PROPIEDADES ***
ErasePage = .T.
Top = 63
Left = 13
Width = 1039
Height = 372
TabIndex = 5
Name = "paginas"
Page1.Caption = "Items"
Page1.Name = "Page1"
Page2.Caption = "Totales"
Page2.Name = "Page2"

*** METODOS ***


************************************************************
OBJETO: grdItems
************************************************************
*** PROPIEDADES ***
Height = 139
Left = 4
Top = 26
Width = 1027
permitir_busqueda = .F.
permitir_ordenamiento = .F.
Name = "grdItems"
COLUMN1.Header1.Name = "Header1"
COLUMN1.Text1.Name = "Text1"
COLUMN1.Name = "COLUMN1"
COLUMN2.Header1.Name = "Header1"
COLUMN2.Text1.Name = "Text1"
COLUMN2.Name = "COLUMN2"
COLUMN3.Header1.Name = "Header1"
COLUMN3.Text1.Name = "Text1"
COLUMN3.Name = "COLUMN3"
COLUMN4.Header1.Name = "Header1"
COLUMN4.Text1.Name = "Text1"
COLUMN4.Name = "COLUMN4"
COLUMN5.Header1.Name = "Header1"
COLUMN5.Text1.Name = "Text1"
COLUMN5.Name = "COLUMN5"
COLUMN6.Header1.Name = "Header1"
COLUMN6.Text1.Name = "Text1"
COLUMN6.Name = "COLUMN6"
COLUMN7.Header1.Name = "Header1"
COLUMN7.Text1.Name = "Text1"
COLUMN7.Name = "COLUMN7"
COLUMN8.Header1.Name = "Header1"
COLUMN8.Text1.Name = "Text1"
COLUMN8.Name = "COLUMN8"
COLUMN9.Header1.Name = "Header1"
COLUMN9.Text1.Name = "Text1"
COLUMN9.Name = "COLUMN9"
COLUMN10.Header1.Name = "Header1"
COLUMN10.Text1.Name = "Text1"
COLUMN10.Name = "COLUMN10"
COLUMN11.Header1.Name = "Header1"
COLUMN11.Text1.Name = "Text1"
COLUMN11.Name = "COLUMN11"
COLUMN12.Header1.Name = "Header1"
COLUMN12.Text1.Name = "Text1"
COLUMN12.Name = "COLUMN12"
COLUMN13.Header1.Name = "Header1"
COLUMN13.Text1.Name = "Text1"
COLUMN13.Name = "COLUMN13"
COLUMN14.Header1.Name = "Header1"
COLUMN14.Text1.Name = "Text1"
COLUMN14.Name = "COLUMN14"
COLUMN15.Header1.Name = "Header1"
COLUMN15.Text1.Name = "Text1"
COLUMN15.Name = "COLUMN15"
COLUMN16.Header1.Name = "Header1"
COLUMN16.Text1.Name = "Text1"
COLUMN16.Name = "COLUMN16"
COLUMN17.Header1.Name = "Header1"
COLUMN17.Text1.Name = "Text1"
COLUMN17.Name = "COLUMN17"
COLUMN18.Header1.Name = "Header1"
COLUMN18.Text1.Name = "Text1"
COLUMN18.Name = "COLUMN18"
COLUMN19.Header1.Name = "Header1"
COLUMN19.Text1.Name = "Text1"
COLUMN19.Name = "COLUMN19"
COLUMN20.Header1.Name = "Header1"
COLUMN20.Text1.Name = "Text1"
COLUMN20.Name = "COLUMN20"

*** METODOS ***
PROCEDURE COLUMN4.Text1.KeyPress
LPARAMETERS nKeyCode, nShiftAltCtrl

IF LASTKEY() = 13 THEN 
	nodefault
	KEYBOARD '{DNARROW}'
ENDIF 


ENDPROC


************************************************************
OBJETO: grdItemNC
************************************************************
*** PROPIEDADES ***
Height = 122
Left = 4
Top = 219
Width = 1027
permitir_busqueda = .F.
permitir_ordenamiento = .F.
Name = "grdItemNC"
COLUMN1.Header1.Name = "Header1"
COLUMN1.Text1.Name = "Text1"
COLUMN1.Name = "COLUMN1"
COLUMN2.Header1.Name = "Header1"
COLUMN2.Text1.Name = "Text1"
COLUMN2.Name = "COLUMN2"
COLUMN3.Header1.Name = "Header1"
COLUMN3.Text1.Name = "Text1"
COLUMN3.Name = "COLUMN3"
COLUMN4.Header1.Name = "Header1"
COLUMN4.Text1.Name = "Text1"
COLUMN4.Name = "COLUMN4"
COLUMN5.Header1.Name = "Header1"
COLUMN5.Text1.Name = "Text1"
COLUMN5.Name = "COLUMN5"
COLUMN6.Header1.Name = "Header1"
COLUMN6.Text1.Name = "Text1"
COLUMN6.Name = "COLUMN6"
COLUMN7.Header1.Name = "Header1"
COLUMN7.Text1.Name = "Text1"
COLUMN7.Name = "COLUMN7"
COLUMN8.Header1.Name = "Header1"
COLUMN8.Text1.Name = "Text1"
COLUMN8.Name = "COLUMN8"
COLUMN9.Header1.Name = "Header1"
COLUMN9.Text1.Name = "Text1"
COLUMN9.Name = "COLUMN9"
COLUMN10.Header1.Name = "Header1"
COLUMN10.Text1.Name = "Text1"
COLUMN10.Name = "COLUMN10"
COLUMN11.Header1.Name = "Header1"
COLUMN11.Text1.Name = "Text1"
COLUMN11.Name = "COLUMN11"
COLUMN12.Header1.Name = "Header1"
COLUMN12.Text1.Name = "Text1"
COLUMN12.Name = "COLUMN12"
COLUMN13.Header1.Name = "Header1"
COLUMN13.Text1.Name = "Text1"
COLUMN13.Name = "COLUMN13"
COLUMN14.Header1.Name = "Header1"
COLUMN14.Text1.Name = "Text1"
COLUMN14.Name = "COLUMN14"
COLUMN15.Header1.Name = "Header1"
COLUMN15.Text1.Name = "Text1"
COLUMN15.Name = "COLUMN15"
COLUMN16.Header1.Name = "Header1"
COLUMN16.Text1.Name = "Text1"
COLUMN16.Name = "COLUMN16"
COLUMN17.Header1.Name = "Header1"
COLUMN17.Text1.Name = "Text1"
COLUMN17.Name = "COLUMN17"
COLUMN18.Header1.Name = "Header1"
COLUMN18.Text1.Name = "Text1"
COLUMN18.Name = "COLUMN18"
COLUMN19.Header1.Name = "Header1"
COLUMN19.Text1.Name = "Text1"
COLUMN19.Name = "COLUMN19"
COLUMN20.Header1.Name = "Header1"
COLUMN20.Text1.Name = "Text1"
COLUMN20.Name = "COLUMN20"

*** METODOS ***
PROCEDURE COLUMN4.Text1.LostFocus
thisform.calcular_totales()
ENDPROC


************************************************************
OBJETO: Clsetiqueta1
************************************************************
*** PROPIEDADES ***
Caption = "Detalle de facturas"
Height = 15
Left = 8
Top = 9
Width = 123
Name = "Clsetiqueta1"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta2
************************************************************
*** PROPIEDADES ***
Caption = "Detalle de Nota de Crédito"
Height = 15
Left = 8
Top = 201
Width = 147
Name = "Clsetiqueta2"

*** METODOS ***


************************************************************
OBJETO: btnAceptar
************************************************************
*** PROPIEDADES ***
Top = 169
Left = 940
Height = 44
Width = 45
Anchor = 13
Name = "btnAceptar"

*** METODOS ***
PROCEDURE Click
IF !thisform.validar_cantidadnc()
	RETURN .F.
ENDIF 
thisform.calcular_totales()
Thisform.contenido.paginas.page1.grdItemNC.Refresh()
this.Enabled = .F.
ENDPROC


************************************************************
OBJETO: btnCancelar
************************************************************
*** PROPIEDADES ***
Top = 169
Left = 987
Height = 44
Width = 45
Anchor = 13
Caption = ""
Name = "btnCancelar"

*** METODOS ***
PROCEDURE Click
SELECT cur_detalle
ZAP
thisform.contenido.paginas.page1.grdItems.Refresh()
thisform.contenido.paginas.page1.btnAceptar.Enabled = .T.
thisform.contenido.lblEstadoCbte.Caption = ""
thisform.limpiar()
ENDPROC


************************************************************
OBJETO: Clsetiqueta1
************************************************************
*** PROPIEDADES ***
Caption = "Importe Neto:"
Height = 15
Left = 27
Top = 60
Name = "Clsetiqueta1"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta2
************************************************************
*** PROPIEDADES ***
Caption = "Desc. 1 (% / $):"
Height = 15
Left = 27
Top = 85
Width = 108
Name = "Clsetiqueta2"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta3
************************************************************
*** PROPIEDADES ***
Caption = "Desc. 2 (% / $):"
Height = 15
Left = 27
Top = 109
Width = 108
Name = "Clsetiqueta3"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta4
************************************************************
*** PROPIEDADES ***
Caption = "Desc. 3 (% / $):"
Height = 15
Left = 27
Top = 132
Width = 111
Name = "Clsetiqueta4"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta5
************************************************************
*** PROPIEDADES ***
Caption = "Desc. 4 (% / $):"
Height = 15
Left = 27
Top = 155
Width = 112
Name = "Clsetiqueta5"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta6
************************************************************
*** PROPIEDADES ***
Caption = "Importe Final:"
Height = 15
Left = 27
Top = 180
Width = 99
Name = "Clsetiqueta6"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta7
************************************************************
*** PROPIEDADES ***
Caption = "Imp. I.V.A. 21%:"
Height = 15
Left = 27
Top = 227
Width = 111
Name = "Clsetiqueta7"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta8
************************************************************
*** PROPIEDADES ***
Caption = "Imp. I.V.A. 10.5%:"
Height = 15
Left = 27
Top = 251
Width = 111
Name = "Clsetiqueta8"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta9
************************************************************
*** PROPIEDADES ***
Caption = "Total Facturado:"
Height = 15
Left = 27
Top = 299
Width = 96
Name = "Clsetiqueta9"

*** METODOS ***


************************************************************
OBJETO: Clslinea1
************************************************************
*** PROPIEDADES ***
Height = 307
Left = 284
Top = 16
Width = 0
Name = "Clslinea1"

*** METODOS ***


************************************************************
OBJETO: CLSLINEA2
************************************************************
*** PROPIEDADES ***
Height = 0
Left = 21
Top = 44
Width = 411
Name = "CLSLINEA2"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta10
************************************************************
*** PROPIEDADES ***
Caption = "Totales de la Factura"
Height = 15
Left = 135
Top = 22
Width = 123
Name = "Clsetiqueta10"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta11
************************************************************
*** PROPIEDADES ***
Caption = "Total de la Nota de Crédito"
Height = 15
Left = 288
Top = 22
Width = 150
Name = "Clsetiqueta11"

*** METODOS ***


************************************************************
OBJETO: txtFCImpNeto
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 137
ReadOnly = .T.
Top = 56
Width = 143
isnumeric = .T.
Name = "txtFCImpNeto"

*** METODOS ***


************************************************************
OBJETO: txtFCPorDto1
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 137
ReadOnly = .T.
Top = 80
Width = 72
isnumeric = .T.
Name = "txtFCPorDto1"

*** METODOS ***


************************************************************
OBJETO: txtFCPorDto2
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 137
ReadOnly = .T.
Top = 104
Width = 72
isnumeric = .T.
Name = "txtFCPorDto2"

*** METODOS ***


************************************************************
OBJETO: txtFCPorDto3
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 137
ReadOnly = .T.
Top = 128
Width = 72
isnumeric = .T.
Name = "txtFCPorDto3"

*** METODOS ***


************************************************************
OBJETO: txtFCPorDto4
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 137
ReadOnly = .T.
Top = 152
Width = 72
isnumeric = .T.
Name = "txtFCPorDto4"

*** METODOS ***


************************************************************
OBJETO: txtFCImpFinal
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 137
ReadOnly = .T.
Top = 176
Width = 142
isnumeric = .T.
Name = "txtFCImpFinal"

*** METODOS ***


************************************************************
OBJETO: txtFCImpIVA21
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 137
ReadOnly = .T.
Top = 224
Width = 143
isnumeric = .T.
Name = "txtFCImpIVA21"

*** METODOS ***


************************************************************
OBJETO: txtFCImpIVA105
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 137
ReadOnly = .T.
Top = 248
Width = 143
isnumeric = .T.
Name = "txtFCImpIVA105"

*** METODOS ***


************************************************************
OBJETO: txtFCTotFact
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 136
ReadOnly = .T.
Top = 296
Width = 144
isnumeric = .T.
Name = "txtFCTotFact"

*** METODOS ***


************************************************************
OBJETO: txtFCImpDto1
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 211
ReadOnly = .T.
Top = 80
Width = 69
isnumeric = .T.
Name = "txtFCImpDto1"

*** METODOS ***


************************************************************
OBJETO: txtFCImpDto2
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 211
ReadOnly = .T.
Top = 104
Width = 69
isnumeric = .T.
Name = "txtFCImpDto2"

*** METODOS ***


************************************************************
OBJETO: txtFCImpDto3
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 211
ReadOnly = .T.
Top = 128
Width = 69
isnumeric = .T.
Name = "txtFCImpDto3"

*** METODOS ***


************************************************************
OBJETO: txtFCImpDto4
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 211
ReadOnly = .T.
Top = 152
Width = 69
isnumeric = .T.
Name = "txtFCImpDto4"

*** METODOS ***


************************************************************
OBJETO: txtNCImpNeto
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 289
ReadOnly = .T.
Top = 56
Width = 148
isnumeric = .T.
Name = "txtNCImpNeto"

*** METODOS ***


************************************************************
OBJETO: txtNCPorDto1
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 288
ReadOnly = .T.
Top = 80
Width = 63
isnumeric = .T.
Name = "txtNCPorDto1"

*** METODOS ***


************************************************************
OBJETO: txtNCPorDto2
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 288
ReadOnly = .T.
Top = 104
Width = 63
isnumeric = .T.
Name = "txtNCPorDto2"

*** METODOS ***


************************************************************
OBJETO: txtNCPorDto3
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 288
ReadOnly = .T.
Top = 128
Width = 62
isnumeric = .T.
Name = "txtNCPorDto3"

*** METODOS ***


************************************************************
OBJETO: txtNCPorDto4
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 288
ReadOnly = .T.
Top = 152
Width = 62
isnumeric = .T.
Name = "txtNCPorDto4"

*** METODOS ***


************************************************************
OBJETO: txtNCImpFinal
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 289
ReadOnly = .T.
Top = 176
Width = 148
isnumeric = .T.
Name = "txtNCImpFinal"

*** METODOS ***


************************************************************
OBJETO: txtNCImpIVA21
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 289
ReadOnly = .T.
Top = 224
Width = 148
isnumeric = .T.
Name = "txtNCImpIVA21"

*** METODOS ***


************************************************************
OBJETO: txtNCImpIVA105
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 289
ReadOnly = .T.
Top = 248
Width = 148
isnumeric = .T.
Name = "txtNCImpIVA105"

*** METODOS ***


************************************************************
OBJETO: txtNCTotFact
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 289
ReadOnly = .T.
Top = 296
Width = 148
isnumeric = .T.
Name = "txtNCTotFact"

*** METODOS ***


************************************************************
OBJETO: txtNCImpDto1
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 353
ReadOnly = .T.
Top = 80
Width = 84
isnumeric = .T.
Name = "txtNCImpDto1"

*** METODOS ***


************************************************************
OBJETO: txtNCImpDto2
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 353
ReadOnly = .T.
Top = 104
Width = 84
isnumeric = .T.
Name = "txtNCImpDto2"

*** METODOS ***


************************************************************
OBJETO: txtNCImpDto3
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 353
ReadOnly = .T.
Top = 128
Width = 84
isnumeric = .T.
Name = "txtNCImpDto3"

*** METODOS ***


************************************************************
OBJETO: txtNCImpDto4
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 353
ReadOnly = .T.
Top = 152
Width = 84
isnumeric = .T.
Name = "txtNCImpDto4"

*** METODOS ***


************************************************************
OBJETO: Clslinea3
************************************************************
*** PROPIEDADES ***
Height = 307
Left = 125
Top = 17
Width = 0
Name = "Clslinea3"

*** METODOS ***


************************************************************
OBJETO: Clslinea4
************************************************************
*** PROPIEDADES ***
Height = 0
Left = 22
Top = 324
Width = 411
Name = "Clslinea4"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta12
************************************************************
*** PROPIEDADES ***
Caption = "I.I.B.B (% / $)"
Height = 15
Left = 28
Top = 275
Width = 113
Name = "Clsetiqueta12"

*** METODOS ***


************************************************************
OBJETO: txtFCPorIIBB
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 137
ReadOnly = .T.
Top = 272
Width = 72
isnumeric = .T.
Name = "txtFCPorIIBB"

*** METODOS ***


************************************************************
OBJETO: txtFCimpIIBB
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 211
ReadOnly = .T.
Top = 272
Width = 69
isnumeric = .T.
Name = "txtFCimpIIBB"

*** METODOS ***


************************************************************
OBJETO: txtNCPorIIBB
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 288
ReadOnly = .T.
Top = 272
Width = 63
isnumeric = .T.
Name = "txtNCPorIIBB"

*** METODOS ***


************************************************************
OBJETO: txtNCImpIIBB
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 353
ReadOnly = .T.
Top = 272
Width = 84
isnumeric = .T.
Name = "txtNCImpIIBB"

*** METODOS ***


************************************************************
OBJETO: txtNCporRec
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 288
ReadOnly = .T.
Top = 200
Width = 63
isnumeric = .T.
Name = "txtNCporRec"

*** METODOS ***


************************************************************
OBJETO: txtNCimpRec
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 353
ReadOnly = .T.
Top = 200
Width = 84
isnumeric = .T.
Name = "txtNCimpRec"

*** METODOS ***


************************************************************
OBJETO: txtFCporRec
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 137
ReadOnly = .T.
Top = 200
Width = 72
isnumeric = .T.
Name = "txtFCporRec"

*** METODOS ***


************************************************************
OBJETO: txtFCimpRec
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 211
ReadOnly = .T.
Top = 200
Width = 69
isnumeric = .T.
Name = "txtFCimpRec"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta13
************************************************************
*** PROPIEDADES ***
Caption = "Recargo:"
Height = 15
Left = 27
Top = 203
Width = 67
Name = "Clsetiqueta13"

*** METODOS ***


************************************************************
OBJETO: btnCerrar
************************************************************
*** PROPIEDADES ***
Top = 442
Left = 1004
Height = 44
Width = 45
Anchor = 12
TabIndex = 6
Name = "btnCerrar"

*** METODOS ***


************************************************************
OBJETO: btnGrabar
************************************************************
*** PROPIEDADES ***
Top = 442
Left = 957
Height = 44
Width = 45
Anchor = 12
TabIndex = 7
Name = "btnGrabar"

*** METODOS ***
PROCEDURE Click
LOCAL lnResp

thisform.datos_cbtes.id_vta_origen = thisform.idOrigen
thisform.datos_cbtes.lnncimpdesc1 = thisform.contenido.paginas.page2.txtNCImpDto1.Value
thisform.datos_cbtes.lnncimpdesc2 = thisform.contenido.paginas.page2.txtNCImpDto2.Value
thisform.datos_cbtes.lnncimpdesc3 = thisform.contenido.paginas.page2.txtNCImpDto3.Value
thisform.datos_cbtes.lnncimpdesc4 = thisform.contenido.paginas.page2.txtNCImpDto4.Value
thisform.datos_cbtes.lnncimpfinal = thisform.contenido.paginas.page2.txtNCImpFinal.Value
thisform.datos_cbtes.lnncporiibb = thisform.contenido.paginas.page2.txtNCPorIIBB.Value
thisform.datos_cbtes.lnncimpiibb = thisform.contenido.paginas.page2.txtNCImpIIBB.Value
thisform.datos_cbtes.lnncimpiva105 =  thisform.contenido.paginas.page2.txtNCImpIVA105.Value
thisform.datos_cbtes.lnncimpiva21 = thisform.contenido.paginas.page2.txtNCImpIVA21.Value
thisform.datos_cbtes.lnncimpneto = thisform.contenido.paginas.page2.txtNCImpNeto.Value
thisform.datos_cbtes.lnnctotfact = thisform.contenido.paginas.page2.txtNCTotFact.Value
thisform.datos_cbtes.lnncpordto1 = thisform.contenido.paginas.page2.txtNCPorDto1.Value
thisform.datos_cbtes.lnncpordto2 = thisform.contenido.paginas.page2.txtNCPorDto2.Value
thisform.datos_cbtes.lnncpordto3 = thisform.contenido.paginas.page2.txtNCPorDto3.Value
thisform.datos_cbtes.lnncpordto4 = thisform.contenido.paginas.page2.txtNCPorDto4.Value
thisform.datos_cbtes.lnncporrec = thisform.contenido.paginas.page2.txtNCporRec.Value
thisform.datos_cbtes.lnncimprec = thisform.contenido.paginas.page2.txtNCimpRec.Value
thisform.datos_cbtes.poriva21 = IIF(thisform.datos_cbtes.lnncimpiva21 <> 0, 21, 0)
thisform.datos_cbtes.poriva105 = IIF(thisform.datos_cbtes.lnncimpiva105 <> 0, 10.5, 0)

thisform.datos_cbtes.cli_razsoc = thisform.cli_razsoc
thisform.datos_cbtes.cli_nrodoc = thisform.cli_cuit
thisform.datos_cbtes.cli_tipodoc = thisform.cli_idtipodoc
thisform.datos_cbtes.esfe = 0
thisform.datos_cbtes.fecemision = Thisform.Contenido.txtFecEmis.Value

IF !thisform.validardetalle() THEN
	RETURN .F.
ENDIF

IF !thisform.datos_cbtes.grabar() THEN
	MESSAGEBOX(thisform.datos_cbtes.error_message, 0+48, Thisform.Caption)
	RETURN .F.
ELSE
	lnResp = MESSAGEBOX("¿Desea vincular esta nota de crédito " ;
		+ "al comprobante de origen?", 4+32, thisform.Caption)
	IF lnResp = 6 THEN
		thisform.datos_cbtes.vincular_cbte = .t.
	ELSE
		thisform.datos_cbtes.vincular_cbte = .f.
	ENDIF
	Thisform.datos_cbtes.grabar_ctacte()
ENDIF

thisform.imprimir()

MESSAGEBOX("El comprobante: " + ALLTRIM(thisform.datos_cbtes.cbte) + " " + ALLTRIM(thisform.datos_cbtes.tipodoc) + " " + REPLICATE("0", 4 - LEN(ALLTRIM(STR(thisform.datos_cbtes.ptovta)))) + ALLTRIM(STR(thisform.datos_cbtes.ptovta)) + "-" + ;
	REPLICATE("0", 8 - LEN(ALLTRIM(STR(thisform.datos_cbtes.numcbte)))) + ALLTRIM(STR(thisform.datos_cbtes.numcbte)) + " se ha generado exitosamente...", 0+64, Thisform.Caption)

Thisform.limpiar()

RETURN .T.
ENDPROC


************************************************************
OBJETO: btnNuevo
************************************************************
*** PROPIEDADES ***
Top = 442
Left = 15
Height = 44
Width = 45
Anchor = 6
Cancel = .T.
TabIndex = 8
Name = "btnNuevo"

*** METODOS ***
PROCEDURE Click
Thisform.limpiar()
ENDPROC


************************************************************
OBJETO: Clsetiqueta2
************************************************************
*** PROPIEDADES ***
BorderStyle = 0
Caption = "Comprobante Original:"
Height = 15
Left = 13
Top = 42
Width = 132
TabIndex = 9
Name = "Clsetiqueta2"

*** METODOS ***


************************************************************
OBJETO: txtcbte
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 144
TabIndex = 10
Top = 38
Width = 37
Name = "txtcbte"

*** METODOS ***


************************************************************
OBJETO: txttipo
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 184
TabIndex = 11
Top = 38
Width = 28
Name = "txttipo"

*** METODOS ***


************************************************************
OBJETO: txtnrocbte
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 215
TabIndex = 12
Top = 38
Width = 86
Name = "txtnrocbte"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta3
************************************************************
*** PROPIEDADES ***
BorderStyle = 0
Caption = "Fecha de Emisión:"
Height = 15
Left = 313
Top = 42
Width = 132
TabIndex = 13
Name = "Clsetiqueta3"

*** METODOS ***


************************************************************
OBJETO: txtFecEmis
************************************************************
*** PROPIEDADES ***
Left = 427
TabIndex = 3
Top = 38
isdatetime = .T.
Name = "txtFecEmis"

*** METODOS ***


************************************************************
OBJETO: lblEstadoCbte
************************************************************
*** PROPIEDADES ***
FontSize = 10
BorderStyle = 0
Caption = ""
Height = 19
Left = 533
Top = 39
Width = 511
ForeColor = 255,0,0
Name = "lblEstadoCbte"

*** METODOS ***


************************************************************
OBJETO: cls_ncdev_sf
************************************************************
*** PROPIEDADES ***
Arial, 0, 9, 5, 15, 12, 32, 3, 0
Arial, 1, 8, 5, 14, 11, 29, 3, 0

*** METODOS ***


************************************************************
OBJETO: frm_ncnd_cc_sf
************************************************************
*** PROPIEDADES ***
BorderStyle = 2
Height = 520
Width = 776
DoCreate = .T.
Caption = "Nota de crédito"
cbte = NC
idventascab = -1
cbteref = 
tipodocref = 
ptovtaref = 
numcbteref = 
importecbteref = 
idcliente = -1
idcc_cli = -1
printerdevice = 
idoper = 
imptotiva21 = 0.00
imptotiva105 = 0.00
poriva21 = 0.00
poriva105 = 0.00
ptovta = 
nrocbte = 
cli_calle = 
cli_codpostal = 
cli_localidad = 
cli_pcia = 
cli_sitiva = 
cli_razsoc = 
cli_cuit = 
fiscal_nrodoc = 0
usa_fiscal = .F.
sqlsrv = .F.
codabr = 
idcheque = 0
idsitiva = 0
cli_tipodoc = 
cli_idtipodoc = 0
Name = "frm_ncnd_cc_sf"

*** METODOS ***
PROCEDURE imprimir
LOCAL m.NroCli, m.RazSoc, m.Telefono, m.direccion, m.localidad, m.codPostal, m.pcia, m.TipoIVA, m.nroCUIT
LOCAL m.Total, m.tipoDoc, m.NroCbte, m.Fecha, m.leyenda, m.fecVto, m.tipoDoc, m.ptoVta
LOCAL m.porDesc1, m.porDesc2, m.porDesc3, m.porDesc4
LOCAL m.impDesc1, m.impDesc2, m.impDesc3, m.impDesc4
LOCAL m.impIVA105, m.impIVA21, m.impNeto, m.impFinal, m.porIIBB, m.impIIBB, m.observ
LOCAL lcSql, loNumerador, lcPrinterName, lnCantCpia
LOCAL loResCli, loResLoc, loResPcia
LOCAL lnIdNum

loNumerador = CREATEOBJECT("odbc_result")
loResCli = CREATEOBJECT("odbc_result")
loResLoc = CREATEOBJECT("odbc_result")
loResPcia = CREATEOBJECT("odbc_result")
loResSitIVA = CREATEOBJECT("odbc_result")
lcSql = ""
lnIdNum = 0

m.Total = 0.00
m.tipoDoc = ""
m.NroCbte = ""
m.leyenda = ""
m.Fecha = DATETIME()
m.impIVA105 = 0.00
m.impIVA21 = 0.00
m.impNeto = 0.00
m.impFinal = 0.00
m.tipoDoc = Thisform.tipodocref
m.ptoVta = Thisform.ptovta
m.NroCbte = Thisform.ptovta + "-" + Thisform.nrocbte
m.porIIBB = 0.00
m.impIIBB = 0.00
m.observ = ""

&& Me fijo cuantas copias tengo que imprimir
lcSql = "select * from numerador where cbte = '" + ALLTRIM(Thisform.cbte) + "' and tipoDoc = '" + ALLTRIM(m.tipoDoc) + "' AND ptoVta = " + ALLTRIM(STR(INT(VAL(m.ptoVta))))
loNumerador = CREATEOBJECT("odbc_result")
loNumerador.ActiveConnection = goConn.ActiveConnection
loNumerador.Cursor_Name = "cur_num"
loNumerador.OpenQuery(lcSql)

SELECT cur_num
m.NroCbte = m.ptoVta + "-" + REPLICATE("0", 8 - LEN(ALLTRIM(STR(cur_num.numActual)))) + ALLTRIM(STR(cur_num.numActual))
lnIdNum = cur_num.idNum
*lcPrinterName = cur_num.impresora
*lnCantCpia = cur_num.cantCpia

loNumerador.close_query()

lcSql = "SELECT * FROM impresoras WHERE hostName = '" + ALLTRIM(SYS(0)) + "' "
lcSql = lcSql + " AND idNum = " + ALLTRIM(STR(lnIdNum))

loNumerador.ActiveConnection = goConn.ActiveConnection
loNumerador.Cursor_Name = "cur_num"
loNumerador.OpenQuery(lcSql)

SELECT cur_num
IF RECCOUNT("cur_num") = 0 THEN
	MESSAGEBOX("La impresora no está instalada para este puesto de trabajo", 0+48, Thisform.Caption)
	RETURN
ENDIF

lcPrinterName = ALLTRIM(cur_num.impresora)
lnCantCpia = cur_num.copias

loNumerador.Close_Query()

&& Recupero los datos del cliente
lcSql = "SELECT * FROM clientes WHERE idCliente = " + ALLTRIM(STR(Thisform.idCliente))
loResCli.cursor_name = "cur_Cliente"
loResCli.ActiveConnection = goConn.ActiveConnection
loResCli.OpenQuery(lcSql)

m.NroCli = cur_Cliente.idCliente
m.RazSoc = cur_Cliente.razSoc
m.Telefono = cur_Cliente.telefono
m.direccion = cur_Cliente.direccion

&& Levanto los datos de la localidad que tiene asignada el cliente
lcSql = "SELECT * FROM localidad WHERE idLocalid = " + ALLTRIM(STR(cur_Cliente.idLocalid))
loResLoc.Cursor_Name = "cur_Loc"
loResLoc.ActiveConnection = goConn.ActiveConnection
loResLoc.OpenQuery(lcSql)

m.localidad = ALLTRIM(cur_Loc.descripcio)
m.codPostal = ALLTRIM(cur_Loc.codPostal)

&& Levanto los datos de la provincia que tiene asignada la localidad
lcSql = "SELECT * FROM provincias WHERE idProvin = " + ALLTRIM(STR(cur_Loc.idProvin))
loResPcia.Cursor_Name = "cur_Pcia"
loResPcia.ActiveConnection = goConn.ActiveConnection
loResPcia.OpenQuery(lcSql)

m.pcia = ALLTRIM(cur_Pcia.descripcio)

loResPcia.Close_Query()
loResLoc.Close_Query()

m.nroCUIT = cur_Cliente.nroCUIT

&& Levanto los datos de la situación de IVA que tiene el cliente
lcSql = "SELECT * FROM sitiva WHERE idSitIVA = " + ALLTRIM(STR(cur_Cliente.idSitIVA))
loResSitIVA.Cursor_Name = "cur_SitIVA"
loResSitIVA.ActiveConnection = goConn.ActiveConnection
loResSitIVA.OpenQuery(lcSql)

m.TipoIVA = cur_SitIVA.descripcio

loResSitIVA.Close_Query()
loResCli.Close_Query()


m.impIVA105 = Thisform.txtImpIVA105.Value 
m.impIVA21 = Thisform.txtImpIVA21.Value 
m.impNeto = Thisform.txtSubTotal.Value
m.impFinal = Thisform.txtTotal.Value
m.porIIBB = Thisform.txtporIIBB.Value 
m.impIIBB = Thisform.txtImpIIBB.Value 
m.observ = Thisform.txtobserv.Value
 
IF ALLTRIM(Thisform.Cbte) == "NC"
	m.Leyenda = "NOTA DE CREDITO"
	m.Total = Thisform.txtTotal.Value
ELSE
	IF ALLTRIM(Thisform.Cbte) == "ND"
		m.leyenda = "NOTA DE DEBITO"
		m.Total = Thisform.txtTotal.Value
	ENDIF
ENDIF

SET PRINTER TO NAME ALLTRIM(lcPrinterName)
SELECT vtadcp

FOR i = 1 TO lnCantCpia
	IF INT(VAL(gnDEMO)) = 1 THEN
		REPORT FORM "repncnd_x.frx" TO PRINTER NOCONSOLE
	ELSE
		IF ALLTRIM(m.tipodoc) == "A" THEN 
			REPORT FORM "repncnd.frx" TO PRINTER NOCONSOLE
		ELSE 
			REPORT FORM "repncnd_b.frx" TO PRINTER NOCONSOLE
		ENDIF
	ENDIF
NEXT


ENDPROC
PROCEDURE buscar_cheque
LOCAL loResult, lcSql
LOCAL lnIdBanco

loResult = CREATEOBJECT("odbc_result")
lcSql = ""

IF TYPE('Thisform.sel_Banco.valcpoid') == "C" THEN
	lnIdBanco = INT(VAL(Thisform.sel_Banco.valcpoid))
ELSE
	lnIdBanco = Thisform.sel_Banco.valcpoid
ENDIF

lcSql = "CALL cheques_buscarND (" ;
		+ "'" + ALLTRIM(thisform.txtNroCheque.Value) + "', " ;
		+ ALLTRIM(STR(lnIdBanco)) + ")"
loResult.Cursor_Name = "cur_Bco"
loResult.ActiveConnection = goConn.ActiveConnection
loResult.OpenQuery(lcSql)

SELECT cur_Bco
IF RECCOUNT("cur_Bco") > 0 THEN
	Thisform.IdCheque = cur_Bco.idCheque
	Thisform.txtImporteNeto.Value = cur_Bco.importe
ELSE
	MESSAGEBOX("Cheque no encontrado, por favor, ingrese bien los datos", 0+48, Thisform.Caption)
	Thisform.txtNroCheque.Value = ""
	Thisform.sel_Banco.txtCodigo.Value = ""
	Thisform.sel_Banco.txtDescripcion.Value = ""
ENDIF

loResult.Close_Query()

RETURN .T.

ENDPROC
PROCEDURE calcular_tipodoc
LOCAL lnSitIVACli

lnSitIvaEmp = 0
lnSitIvaEmp = VAL(ALLTRIM(getConfig("SITIVAEMP")))

IF lnSitIvaEmp = 1 .AND. Thisform.idSitIva = 1 THEN
	RETURN "A"
ENDIF

IF lnSitIvaEmp = 1 .AND. Thisform.idSitIva= 2 THEN
	RETURN "B"
ENDIF

IF lnSitIvaEmp = 1 .AND. Thisform.idSitIva = 3 THEN
	RETURN "B"
ENDIF

IF lnSitIvaEmp = 1 .AND. Thisform.idSitIva = 5 THEN
	RETURN "B"
ENDIF

IF lnSitIvaEmp = 1 .AND. Thisform.idSitIva = 6 THEN
	RETURN "B"
ENDIF

IF lnSitIvaEmp = 1 .AND. Thisform.idSitIva = 7 THEN
   	RETURN "B"
ENDIF

IF lnSitIvaEmp = 6 THEN
	RETURN "C"
ENDIF

ENDPROC
PROCEDURE calcular_ret_iibb
&& Calculo el importe de percepción de ingresos brutos y lo anexo al total
IF ALLTRIM(Thisform.cbte) == "NC" THEN
	Thisform.txtImpIIBB.Value = ROUND(Thisform.txtsubTotal.Value * (Thisform.txtPorIIBB.Value / 100), 2)
	Thisform.txttotal.Value = Thisform.txttotal.Value + Thisform.txtImpIIBB.Value
ENDIF 

ENDPROC
PROCEDURE sumar_items
LOCAL lnSubtotal, lnIVA21, lnIVA105, lnTotal

lnSubtotal = 0.00
lnIVA21 = 0.00
lnIVA105 = 0.00
lnTotal = 0.00

SELECT vtadcp
IF RECCOUNT("vtadcp") > 0
	GO TOP 
ENDIF 

DO WHILE !EOF()
	lnSubtotal = lnSubtotal + vtadcp.impNeto
	
	IF vtadcp.ivaPor = 21 THEN
		lnIVA21 = lnIVA21 + vtadcp.ivaImp
	ELSE
		lnIVA105 = lnIVA105  + vtadcp.ivaImp
	ENDIF
	
	lnTotal = lnTotal + vtadcp.total
	
	SELECT vtadcp
	SKIP 
ENDDO 

Thisform.txtsubTotal.Value = lnSubtotal
Thisform.txtImpIVA21.Value = lnIVA21
Thisform.txtImpIVA105.Value = lnIVA105
Thisform.txttotal.Value = lnTotal

SELECT vtadcp
IF RECCOUNT("vtadcp") > 0
	GO TOP 
ENDIF 


ENDPROC
PROCEDURE grabar_ctacte
PARAMETERS tnIdVentaC
	
LOCAL loCommand
LOCAL loRes
LOCAL loDateTime
LOCAL lcSql
LOCAL lnIdOper
LOCAL lnPtoVta
LOCAL lnNroCbte
LOCAL lnIdCondPago
LOCAL lnIdSitIVA
LOCAL lnIdVendedor
LOCAL lnIdCC_CliOrig

loCommand = CREATEOBJECT("odbc_command")
loRes = CREATEOBJECT("odbc_result")
loDateTime = CREATEOBJECT("datetime")
lnIdOper = 0
lnPtoVta = 0
lnNroCbte = 0
lnIdCondPago = 0
lnIdSitIVA = 0
lnIdVendedor = 0
lnIdCC_CliOrig = thisform.idcc_cli

lcSql = "SELECT ventascab.idVentasC, ventascab.ptoVta, ventascab.numCbte, "
lcSql = lcSql + "ventascab.idCondPago, ventascab.idSitIVA, ventascab.idVendedor "
lcSql = lcSql + "FROM ventascab "
lcSql = lcSql + "WHERE ventascab.idVentasC = " + ALLTRIM(STR(tnIdVentaC))
loRes.ActiveConnection = goConn.ActiveConnection
loRes.Cursor_Name = "cur_x"
IF !loRes.OpenQuery(lcSql) THEN
	MESSAGEBOX(loRes.Error_Message, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

lnPtoVta = cur_x.ptoVta
lnNroCbte = cur_x.numCbte
lnIdCondPago = cur_x.idCondPago
lnIdSitIVA = cur_x.idSitIVA
lnIdVendedor = cur_x.idVendedor
loRes.Close_Query()

IF lnIdCC_CliOrig <> -1 THEN
	lcSql = "SELECT * FROM cc_cli WHERE idCC_Cli = " + ALLTRIM(STR(lnIdCC_CliOrig))
	loRes.ActiveConnection = goConn.ActiveConnection
	loRes.Cursor_Name = "cur_x"
	IF !loRes.OpenQuery(lcSql) THEN
		MESSAGEBOX(loRes.Error_Message, 0+48, Thisform.Caption)
		RETURN .F.
	ENDIF

	lnIdCondPago = cur_x.idCondPago
	lnIdSitIVA = cur_x.idSitIVA
	lnIdVendedor = cur_x.idVendedor
	loRes.Close_Query()
ENDIF

&& Grabar el registro en CC_CLI vinculado por Id_Oper al cbte seleccionado
lnIdCC_Cli = goConn.GetNextID("cc_cli", "idCC_Cli")

IF Thisform.idOper = 0 THEN
	lnIdOper = goConn.GetNextID("cc_cli", "idOper")
ELSE
	lnIdOper = Thisform.idOper
ENDIF 

IF ALLTRIM(Thisform.cbte) == "NC" THEN
	lcSql = "INSERT INTO cc_cli ("
	lcSql = lcSql + "idCC_Cli, "
	lcSql = lcSql + "idCliente, "
	lcSql = lcSql + "idCC_Orig, "
	lcSql = lcSql + "idVentasC, "
	lcSql = lcSql + "cbte, "
	lcSql = lcSql + "tipoDoc, "
	lcSql = lcSql + "ptoVta, "
	lcSql = lcSql + "nroCbte, "
	lcSql = lcSql + "fecEmis, "
	lcSql = lcSql + "fecVto, "
	lcSql = lcSql + "idCondPago, "
	lcSql = lcSql + "idSitIVA, "
	lcSql = lcSql + "idVendedor, "
	lcSql = lcSql + "impDebe, "
	lcSql = lcSql + "impHaber, "
	lcSql = lcSql + "idOper, "
	lcSql = lcSql + "observ, "
	lcSql = lcSql + "usuAlta, "
	lcSql = lcSql + "fecAlta, "
	lcSql = lcSql + "idHostAlta) "
	lcSql = lcSql + "VALUES ("
	lcSql = lcSql + ALLTRIM(STR(lnIdCC_Cli)) + ", " + ;
			ALLTRIM(STR(Thisform.idCliente)) + ", " + ;
			IIF(lnIdCC_CliOrig <> -1, ALLTRIM(STR(lnIdCC_CliOrig)), "null") + ", " + ;
			ALLTRIM(STR(tnIdVentaC)) + "," + ;
			"'" + ALLTRIM(Thisform.cbte) + "', " + ;
			"'" + ALLTRIM(Thisform.TipoDocRef) + "', " + ;
			ALLTRIM(STR(lnPtoVta)) + ", " + ;
			ALLTRIM(STR(lnNroCbte)) + ", " + ;
			loDateTime.getDateTime() + ", " + ;
			loDateTime.getDateTime() + ", " + ;
			ALLTRIM(STR(lnIdCondPago)) + ", " + ;
			ALLTRIM(STR(lnIdSitIVA)) + ", " + ;
			ALLTRIM(STR(lnIdVendedor)) + ", " + ;
			"0, " + ;
			ALLTRIM(STR(Thisform.txtTotal.Value, 10, 2)) + ", " + ;
			ALLTRIM(STR(lnIdOPer)) + ", " + ;
			"'" + ALLTRIM(thisform.txtobserv.Value) + "', " + ;
			"'" + ALLTRIM(gcCodUsu) + "', " + ;
			loDateTime.getDateTime() + ", " + ;
			"'" + ALLTRIM(SYS(0)) + "')"
ELSE
	lcSql = "INSERT INTO cc_cli ("
	lcSql = lcSql + "idCC_Cli, "
	lcSql = lcSql + "idCliente, "
	lcSql = lcSql + "idCC_Orig, "
	lcSql = lcSql + "idVentasC, "
	lcSql = lcSql + "cbte, "
	lcSql = lcSql + "tipoDoc, "
	lcSql = lcSql + "ptoVta, "
	lcSql = lcSql + "nroCbte, "
	lcSql = lcSql + "fecEmis, "
	lcSql = lcSql + "fecVto, "
	lcSql = lcSql + "idCondPago, "
	lcSql = lcSql + "idSitIVA, "
	lcSql = lcSql + "idVendedor, "
	lcSql = lcSql + "impDebe, "
	lcSql = lcSql + "impHaber, "
	lcSql = lcSql + "idOper, "
	lcSql = lcSql + "observ, "
	lcSql = lcSql + "usuAlta, "
	lcSql = lcSql + "fecAlta, "
	lcSql = lcSql + "idHostAlta) "
	lcSql = lcSql + "VALUES ("
	lcSql = lcSql + ALLTRIM(STR(lnIdCC_Cli)) + ", " + ;
			ALLTRIM(STR(Thisform.idCliente)) + ", " + ;
			IIF(lnIdCC_CliOrig <> -1, ALLTRIM(STR(lnIdCC_CliOrig)), "null") + ", " + ;
			ALLTRIM(STR(tnIdVentaC)) + ", " + ;
			"'" + ALLTRIM(Thisform.cbte) + "', " + ;
			"'" + ALLTRIM(Thisform.TipoDocRef) + "', " + ;
			ALLTRIM(STR(lnPtoVta)) + ", " + ;
			ALLTRIM(STR(lnNroCbte)) + ", " + ;
			loDateTime.getDateTime() + ", " + ;
			loDateTime.getDateTime() + ", " + ;
			ALLTRIM(STR(lnIdCondPago)) + ", " + ;
			ALLTRIM(STR(lnIdSitIVA)) + ", " + ;
			ALLTRIM(STR(lnIdVendedor)) + ", " + ;
			ALLTRIM(STR(Thisform.txtTotal.Value, 10, 2)) + ", " + ;
			"0, " + ;
			ALLTRIM(STR(lnIdOper)) + ", " + ;
			"'" + ALLTRIM(thisform.txtobserv.Value) + "', " + ;
			"'" + ALLTRIM(gcCodUsu) + "', " + ;
			loDateTime.getDateTime() + ", " + ;
			"'" + ALLTRIM(SYS(0)) + "')"
ENDIF

loCommand.ActiveConnection = goConn.ActiveConnection
loCommand.CommandText = lcSql

IF !loCommand.Execute() THEN
	MESSAGEBOX(loCommand.ErrorMessage, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

RETURN .T.
ENDPROC
PROCEDURE Activate
LOCAL lo_rsIIBB

lo_rsIIBB = CREATEOBJECT("odbc_result")
lcSql = ""

&& Levanto el IIBB del cliente
lcSql = "SELECT * FROM padronib WHERE cuit = '" + ALLTRIM(STRTRAN(thisform.cli_cuit,"-","")) + "'"
lo_rsIIBB.ActiveConnection = goConn.ActiveConnection
lo_rsIIBB.Cursor_Name = "cur_PadronIB"
lo_rsIIBB.OpenQuery(lcSql)

SELECT cur_PadronIB
IF RECCOUNT("cur_PadronIB") > 0 THEN
	Thisform.txtPorIIBB.Value = cur_PadronIB.AlicuotaPer
ELSE 
	Thisform.txtPorIIBB.Value = 0.00
ENDIF 

lo_rsIIBB.close_query()

&& Si es cuenta dos no tildo IVA 21%
IF INT(VAL(ALLTRIM(getconfig("DEMO")))) == 0 THEN
	Thisform.chkIVA21.Value = 1
ENDIF

&&Thisform.chkIVA21.Value = 1
Thisform.txtPtoVta.Value = Thisform.ptovtaref
Thisform.txtNroCbte.Value = Thisform.numcbteref
Thisform.txtPorIVA105.Value = 10.50
Thisform.txtPorIVA21.Value = 21.00

IF ALLTRIM(Thisform.cbte) == "NC" THEN
	Thisform.txtOperacion.Value = "NOTA DE CREDITO"
ELSE
	Thisform.txtOperacion.Value = "NOTA DE DEBITO"
	Thisform.txtPorIIBB.Value = 0.00
ENDIF
ENDPROC
PROCEDURE Load
DODEFAULT()

&& Creo el cursor que contendrá el detalle del comprobante

CREATE CURSOR vtadcp (	;
	id_vtadcp	int	,;
	idVentasC	int ,;
	idPlanCta	int ,;
	idBanco		int ,;
	codPlanCta	varchar(20),;
	descPlan	varchar(60),;
	cheque_nro	varchar(8),;
	impNeto		float(10, 2),;
	ivaPor		float(10, 2),;
	ivaImp		float(10, 2),;
	total		float(10, 2) ;
)
	



ENDPROC
PROCEDURE Init
DODEFAULT()

&& Creo la grilla
SELECT vtadcp
Thisform.grdDetalle.RecordSource = "vtadcp"
Thisform.grdDetalle.list_controlsource = "codPlanCta,descPlan,cheque_nro,impNeto,ivaPor,ivaImp,total"
Thisform.grdDetalle.lista_ancho_cols = "100,250,100,70,70,70,70"
Thisform.grdDetalle.titulos_cabeceras = "Código,Descripción,Cheque,Imp. Neto,I.V.A,Imp. IVA,Total"
Thisform.grdDetalle.generar_grid()


IF ALLTRIM(GetConfig("USA_FISCAL")) == "S" THEN
	Thisform.usa_fiscal = .T.
ELSE
	Thisform.usa_fiscal = .F.
ENDIF

IF ALLTRIM(GetConfig("SQLSRV")) == "1" THEN
	Thisform.sqlsrv = .T.
ELSE
	Thisform.sqlsrv = .F.
ENDIF


ENDPROC


************************************************************
OBJETO: Clsetiqueta1
************************************************************
*** PROPIEDADES ***
Caption = "Operación"
Height = 15
Left = 12
Top = 12
Width = 72
TabIndex = 15
Name = "Clsetiqueta1"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta2
************************************************************
*** PROPIEDADES ***
Caption = "Factura de Referencia"
Height = 15
Left = 157
Top = 12
Width = 132
TabIndex = 16
Name = "Clsetiqueta2"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta3
************************************************************
*** PROPIEDADES ***
Caption = "Importe"
Height = 15
Left = 346
Top = 12
Width = 51
TabIndex = 17
Name = "Clsetiqueta3"

*** METODOS ***


************************************************************
OBJETO: txtOperacion
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 12
TabIndex = 18
Top = 28
Width = 120
Name = "txtOperacion"

*** METODOS ***


************************************************************
OBJETO: txtPtoVta
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 157
TabIndex = 19
Top = 28
Width = 43
Name = "txtPtoVta"

*** METODOS ***


************************************************************
OBJETO: txtNroCbte
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 204
TabIndex = 20
Top = 28
Width = 109
Name = "txtNroCbte"

*** METODOS ***


************************************************************
OBJETO: txtImporte
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 347
TabIndex = 21
Top = 28
Width = 86
Name = "txtImporte"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta4
************************************************************
*** PROPIEDADES ***
Caption = "Concepto:"
Height = 15
Left = 12
Top = 71
Width = 72
TabIndex = 23
Name = "Clsetiqueta4"

*** METODOS ***


************************************************************
OBJETO: sel_Conceptos
************************************************************
*** PROPIEDADES ***
Top = 63
Left = 91
Width = 557
Height = 25
TabIndex = 1
cfieldname = 
nombre_campo_codigo = codPlanCta
nombre_campo_desc = descripcio
nombre_tabla = planctas
pkfield = idPlanCta
autocompletar_ceros = .F.
Name = "sel_Conceptos"
txtCodigo.Height = 21
txtCodigo.Left = 2
txtCodigo.Top = 2
txtCodigo.Width = 172
txtCodigo.Name = "txtCodigo"
txtDescripcion.Left = 177
txtDescripcion.Top = 2
txtDescripcion.Name = "txtDescripcion"

*** METODOS ***
PROCEDURE recuperar_datos
thisform.codabr = planctas.codAbr

&& Si es cheque rechazado, habilito para que carguen el banco y el número
&& de cheque, en caso contrario, deshabilito los controles de cheques.
IF ALLTRIM(planctas.codAbr) == "CHR" THEN
	Thisform.sel_Banco.txtcodigo.Enabled = .T.
	Thisform.txtNroCheque.Enabled = .T.
ELSE
	Thisform.sel_Banco.txtcodigo.Enabled = .F.
	Thisform.txtNroCheque.Enabled = .F.
ENDIF
ENDPROC


************************************************************
OBJETO: Clsetiqueta5
************************************************************
*** PROPIEDADES ***
Caption = "Importe Neto"
Height = 15
Left = 87
Top = 146
Width = 79
TabIndex = 25
Name = "Clsetiqueta5"

*** METODOS ***


************************************************************
OBJETO: chkIVA21
************************************************************
*** PROPIEDADES ***
Top = 144
Left = 192
Height = 18
Width = 91
Alignment = 0
Caption = "I.V.A 21,00%"
TabIndex = 5
Name = "chkIVA21"

*** METODOS ***
PROCEDURE Click
IF this.Value = 1 THEN
	Thisform.txtIVA105.Value = 0.00
	Thisform.txtIVA21.Value = ROUND(Thisform.txtImporteNeto.Value * 0.21, 2)
	Thisform.txtImpTotal.Value = ROUND(Thisform.txtImporteNeto.Value + Thisform.txtIVA21.Value + Thisform.txtIVA105.Value, 2)
	Thisform.chkIVA105.Value = 0
ELSE
	Thisform.txtIVA21.Value = 0.00
	Thisform.txtImpTotal.Value = ROUND(Thisform.txtImporteNeto.Value + Thisform.txtIVA21.Value + Thisform.txtIVA105.Value, 2)
ENDIF
ENDPROC


************************************************************
OBJETO: chkIVA105
************************************************************
*** PROPIEDADES ***
Top = 144
Left = 300
Height = 18
Width = 92
Alignment = 0
Caption = "I.V.A 10,50%"
TabIndex = 6
Name = "chkIVA105"

*** METODOS ***
PROCEDURE Click
IF this.Value = 1 THEN
	Thisform.txtIVA21.Value = 0.00
	Thisform.txtIVA105.Value = ROUND(Thisform.txtImporteNeto.Value * 0.105, 2)
	Thisform.txtImpTotal.Value = ROUND(Thisform.txtImporteNeto.Value + Thisform.txtIVA21.Value + Thisform.txtIVA105.Value, 2)
	Thisform.chkIVA21.Value = 0
ELSE
	Thisform.txtIVA105.Value = 0.00
	Thisform.txtImpTotal.Value = ROUND(Thisform.txtImporteNeto.Value + Thisform.txtIVA21.Value + Thisform.txtIVA105.Value, 2)
ENDIF
ENDPROC


************************************************************
OBJETO: Clsetiqueta6
************************************************************
*** PROPIEDADES ***
Caption = "Importe Total"
Height = 15
Left = 412
Top = 146
Width = 79
TabIndex = 26
Name = "Clsetiqueta6"

*** METODOS ***


************************************************************
OBJETO: txtImporteNeto
************************************************************
*** PROPIEDADES ***
Left = 84
TabIndex = 4
Top = 162
isnumeric = .T.
Name = "txtImporteNeto"

*** METODOS ***
PROCEDURE LostFocus
IF thisform.chkIVA21.Value = 1 THEN
	Thisform.txtIVA105.Value = 0.00
	Thisform.txtIVA21.Value = ROUND(Thisform.txtImporteNeto.Value * 0.21, 2)
	Thisform.txtImpTotal.Value = ROUND(Thisform.txtImporteNeto.Value + Thisform.txtIVA21.Value + Thisform.txtIVA105.Value, 2)
ELSE
	IF thisform.txtIVA105.Value = 1 THEN
		Thisform.txtIVA21.Value = 0.00
		Thisform.txtIVA105.Value = ROUND(Thisform.txtImporteNeto.Value * 0.105, 2)
		Thisform.txtImpTotal.Value = ROUND(Thisform.txtImporteNeto.Value + Thisform.txtIVA21.Value + Thisform.txtIVA105.Value, 2)
	ELSE 
		Thisform.txtIVA21.Value = 0.00
		Thisform.txtIVA105.Value = 0.00
		Thisform.txtImpTotal.Value = ROUND(Thisform.txtImporteNeto.Value + Thisform.txtIVA21.Value + Thisform.txtIVA105.Value, 2)
	ENDIF 
ENDIF
ENDPROC


************************************************************
OBJETO: txtIVA21
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 192
TabIndex = 27
Top = 162
Width = 104
isnumeric = .T.
Name = "txtIVA21"

*** METODOS ***


************************************************************
OBJETO: txtIVA105
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 302
TabIndex = 28
Top = 162
Width = 101
isnumeric = .T.
Name = "txtIVA105"

*** METODOS ***


************************************************************
OBJETO: txtImpTotal
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 768
TabIndex = 29
Top = 288
Width = 101
isnumeric = .T.
Name = "txtImpTotal"

*** METODOS ***


************************************************************
OBJETO: btnAgregar
************************************************************
*** PROPIEDADES ***
Top = 143
Left = 680
Height = 44
Width = 45
TabIndex = 7
Name = "btnAgregar"

*** METODOS ***
PROCEDURE Click
IF Thisform.sel_Conceptos.valcpoid = 0 THEN
	MESSAGEBOX("Debe selecionar un concepto", 0+48, Thisform.Caption)
	Thisform.sel_Conceptos.txtCodigo.SetFocus()
	RETURN .F.
ENDIF

IF Thisform.txtImporteNeto.Value = 0 THEN
	MESSAGEBOX("Debe ingresar el importe neto", 0+48, Thisform.Caption)
	Thisform.txtImporteNeto.SetFocus()
	RETURN .F.
ENDIF

&& Si es cheque rechazado entonces valido que el usuario ingrese los datos
&& del cheque
IF ALLTRIM(Thisform.codAbr) == "CHR" THEN
	IF ALLTRIM(Thisform.Sel_Banco.txtCodigo.Value) == "" THEN
		MESSAGEBOX("Debe ingresar el banco", 0+48, Thisform.Caption)
		Thisform.sel_Banco.txtCodigo.SetFocus()
		RETURN .F.
	ENDIF
	
	IF ALLTRIM(Thisform.txtNroCheque.Value) == "" THEN
		MESSAGEBOX("Debe ingresar el número de cheque", 0+48, Thisform.Caption)
		Thisform.txtNroCheque.SetFocus()
		RETURN .F.
	ENDIF
	
	IF !Thisform.buscar_cheque() THEN
		Thisform.sel_Banco.txtCodigo.SetFocus()
		RETURN .F.
	ENDIF
ENDIF

SELECT vtadcp
APPEND BLANK
REPLACE vtadcp.id_vtadcp WITH 0
REPLACE vtadcp.idVentasC WITH 0 ADDITIVE
REPLACE vtadcp.idPlanCta WITH Thisform.sel_Conceptos.valcpoid ADDITIVE
REPLACE vtadcp.idBanco WITH Thisform.sel_Banco.valcpoid ADDITIVE
REPLACE vtadcp.codPlanCta WITH Thisform.sel_Conceptos.txtCodigo.Value ADDITIVE
REPLACE vtadcp.descPlan WITH Thisform.sel_Conceptos.txtDescripcion.Value ADDITIVE
REPLACE vtadcp.cheque_nro WITH Thisform.txtNroCheque.Value ADDITIVE
REPLACE	vtadcp.impNeto WITH ROUND(Thisform.txtImporteNeto.Value, 2) ADDITIVE

IF Thisform.txtIVA105.Value <> 0 THEN
	REPLACE vtadcp.ivaPor WITH 10.5 ADDITIVE
	REPLACE vtadcp.ivaImp WITH Thisform.txtIVA105.Value ADDITIVE
ELSE 
	IF Thisform.txtIVA21.Value <> 0 THEN
		REPLACE vtadcp.ivaPor WITH 21 ADDITIVE
		REPLACE vtadcp.ivaImp WITH Thisform.txtIVA21.Value ADDITIVE
	ELSE 
		REPLACE vtadcp.ivaPor WITH 0 ADDITIVE
		REPLACE vtadcp.ivaImp WITH 0 ADDITIVE
	ENDIF
ENDIF 

REPLACE vtadcp.total WITH Thisform.txtImpTotal.Value ADDITIVE

Thisform.grdDetalle.Refresh()

Thisform.sel_Conceptos.txtCodigo.Value = ""
Thisform.sel_Conceptos.txtdescripcion.Value = ""
Thisform.txtImporteNeto.Value = 0.00
Thisform.txtIVA105.Value = 0.00
Thisform.txtIVA21.Value = 0.00
Thisform.txtImpTotal.Value = 0.00
Thisform.sel_Conceptos.txtCodigo.SetFocus()
Thisform.chkIVA105.Value = 0
Thisform.chkIVA21.Value = 1

Thisform.sumar_items()
Thisform.calcular_ret_iibb()

RETURN .T.
ENDPROC


************************************************************
OBJETO: grdDetalle
************************************************************
*** PROPIEDADES ***
Height = 224
Left = 3
TabIndex = 30
Top = 189
Width = 769
Name = "grdDetalle"
COLUMN1.Header1.Name = "Header1"
COLUMN1.Text1.Name = "Text1"
COLUMN1.Name = "COLUMN1"
COLUMN2.Header1.Name = "Header1"
COLUMN2.Text1.Name = "Text1"
COLUMN2.Name = "COLUMN2"
COLUMN3.Header1.Name = "Header1"
COLUMN3.Text1.Name = "Text1"
COLUMN3.Name = "COLUMN3"
COLUMN4.Header1.Name = "Header1"
COLUMN4.Text1.Name = "Text1"
COLUMN4.Name = "COLUMN4"
COLUMN5.Header1.Name = "Header1"
COLUMN5.Text1.Name = "Text1"
COLUMN5.Name = "COLUMN5"
COLUMN6.Header1.Name = "Header1"
COLUMN6.Text1.Name = "Text1"
COLUMN6.Name = "COLUMN6"
COLUMN7.Header1.Name = "Header1"
COLUMN7.Text1.Name = "Text1"
COLUMN7.Name = "COLUMN7"
COLUMN8.Header1.Name = "Header1"
COLUMN8.Text1.Name = "Text1"
COLUMN8.Name = "COLUMN8"
COLUMN9.Header1.Name = "Header1"
COLUMN9.Text1.Name = "Text1"
COLUMN9.Name = "COLUMN9"
COLUMN10.Header1.Name = "Header1"
COLUMN10.Text1.Name = "Text1"
COLUMN10.Name = "COLUMN10"
COLUMN11.Header1.Name = "Header1"
COLUMN11.Text1.Name = "Text1"
COLUMN11.Name = "COLUMN11"
COLUMN12.Header1.Name = "Header1"
COLUMN12.Text1.Name = "Text1"
COLUMN12.Name = "COLUMN12"
COLUMN13.Header1.Name = "Header1"
COLUMN13.Text1.Name = "Text1"
COLUMN13.Name = "COLUMN13"
COLUMN14.Header1.Name = "Header1"
COLUMN14.Text1.Name = "Text1"
COLUMN14.Name = "COLUMN14"
COLUMN15.Header1.Name = "Header1"
COLUMN15.Text1.Name = "Text1"
COLUMN15.Name = "COLUMN15"
COLUMN16.Header1.Name = "Header1"
COLUMN16.Text1.Name = "Text1"
COLUMN16.Name = "COLUMN16"
COLUMN17.Header1.Name = "Header1"
COLUMN17.Text1.Name = "Text1"
COLUMN17.Name = "COLUMN17"
COLUMN18.Header1.Name = "Header1"
COLUMN18.Text1.Name = "Text1"
COLUMN18.Name = "COLUMN18"
COLUMN19.Header1.Name = "Header1"
COLUMN19.Text1.Name = "Text1"
COLUMN19.Name = "COLUMN19"
COLUMN20.Header1.Name = "Header1"
COLUMN20.Text1.Name = "Text1"
COLUMN20.Name = "COLUMN20"

*** METODOS ***


************************************************************
OBJETO: SubTotal
************************************************************
*** PROPIEDADES ***
Caption = "SubTotal"
Height = 15
Left = 12
Top = 422
Width = 60
TabIndex = 31
Name = "SubTotal"

*** METODOS ***


************************************************************
OBJETO: txtSubTotal
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 72
TabIndex = 9
Top = 418
Width = 86
isnumeric = .T.
Name = "txtSubTotal"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta9
************************************************************
*** PROPIEDADES ***
Caption = "Total:"
Height = 15
Left = 464
Top = 422
Width = 40
TabIndex = 34
Name = "Clsetiqueta9"

*** METODOS ***


************************************************************
OBJETO: txtTotal
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 504
TabIndex = 12
Top = 418
Width = 86
isnumeric = .T.
Name = "txtTotal"

*** METODOS ***


************************************************************
OBJETO: btnGrabar
************************************************************
*** PROPIEDADES ***
Top = 471
Left = 680
Height = 44
Width = 45
TabIndex = 13
Name = "btnGrabar"

*** METODOS ***
PROCEDURE Click
LOCAL lcSql, loCommand, lnIdVentaC, lnPtoVta, lnIdVtasRel, loResCli
LOCAL loNumerador, lnPtoVta, lnNroCbte, lnPorIVA21 
LOCAL lnPorIVA105, lnImpIVA21, lnImpIVA105, lnIdVtaCP, lnIdCC_Cli
LOCAL lnIdOper, lnSaldo, loDateTime
LOCAL lnIdCondPago, lnIdSitIVA, lnIdVendedor, lnPorIIBB, lnImpIIBB, lnIdCC_CliOrig 

lcSql = ""
loDateTime = CREATEOBJECT("datetime")
loCommand = CREATEOBJECT("odbc_command")
loResCli = CREATEOBJECT("odbc_result")
lnIdVentaC = 0
lnPtoVta = INT(VAL(ALLTRIM(getconfig("PTOVTA"))))
lnNroCbte = 0
lnIdVtaCP = 0
lnIdCC_Cli = 0
lnPorIVA21 = 0.00
lnImpIVA21 = 0.00
lnPorIVA105 = 0.00
lnImpIVA105 = 0.00
lnIdOper = 0
lnSaldo = 0.00
lnIdVtasRel = 0
lnIdCondPago = 0
lnIdSitIVA = 0
lnIdVendedor = 0
lnPorIIBB = 0.00
lnImpIIBB = 0.00
lnIdCC_CliOrig = thisform.idcc_cli


SELECT vtadcp
IF RECCOUNT("vtadcp") = 0 THEN
	MESSAGEBOX("Debe ingresar al menos un ítem del detalle", 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

lcSql = "SELECT * FROM clientes WHERE idCliente = " + ALLTRIM(STR(Thisform.idCliente))
loResCli.ActiveConnection = goConn.ActiveConnection
loResCli.Cursor_Name = "cur_cli"

IF !loResCli.OpenQuery(lcSql) THEN
	MESSAGEBOX(loResCli.Error_Message, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

SELECT cur_cli
lnIdCondPago = cur_cli.idCondPago
lnIdSitIVA = cur_cli.idSitIVA
lnIdVendedor = cur_cli.idVendedor

loResCli.Close_Query()

SELECT vtadcp
DO WHILE !EOF("vtadcp") 
	IF vtadcp.ivaPor = 21 THEN
		lnPorIVA21 = vtadcp.ivaPor
		lnImpIVA21 = lnImpIVA21 + vtadcp.ivaImp
	ELSE
		lnPorIVA105 = vtadcp.ivaPor
		lnImpIVA105 = lnImpIVA105 + vtadcp.ivaImp
	ENDIF	

	SELECT vtadcp
	SKIP	
ENDDO

lnPorIIBB = Thisform.txtporIIBB.Value
lnImpIIBB = Thisform.txtImpIIBB.Value

goConn.BeginTransaction()	&& Inicio la transacción
 
&& Calculo el tipo de comprobante
IF INT(VAL(ALLTRIM(getconfig("DEMO")))) == 0 THEN
	Thisform.Tipodocref = Thisform.calcular_tipodoc()
ELSE
	Thisform.Tipodocref = "X"
ENDIF

lcSql = "SELECT * FROM numerador WHERE cbte = '" + ALLTRIM(Thisform.cbte) + "' AND tipoDoc = '" + ALLTRIM(thisform.tipodocref) + "' AND ptoVta = " + ALLTRIM(STR(lnPtoVta))
loNumerador = CREATEOBJECT("odbc_result")
loNumerador.ActiveConnection = goConn.ActiveConnection
loNumerador.Cursor_Name = "cur_num"
loNumerador.OpenQuery(lcSql)
SELECT cur_num

IF RECCOUNT("cur_num") = 0 THEN
	MESSAGEBOX("No se encuentra configurado el numerador del comprobante " + ALLTRIM(Thisform.cbte) + " Punto de Venta: " + ALLTRIM(STR(lnPtoVta)) + " Letra: " + ALLTRIM(thisform.tipodocref), 0+48, thisform.Caption)
	loNumerador.close_query()
	RETURN .F.
ENDIF

SELECT cur_num
lnNroCbte = cur_num.numActual + 1
Thisform.printerDevice = cur_num.impresora

loNumerador.close_query()

&& Actualizo el numerador
lcSql = "update numerador set numActual = " + ALLTRIM(STR(lnNroCbte)) + ;
	" where cbte = '" + ALLTRIM(Thisform.cbte) + "' and tipoDoc = '" + ALLTRIM(thisform.tipodocref) + "'"

loCommand.ActiveConnection = goConn.ActiveConnection
loCommand.CommandText = lcSql

IF !loCommand.Execute()
	goConn.Rollback()
	RETURN .F.
ENDIF

lnIdVentaC = goConn.GetNextId("ventascab", "idVentasC")

lcSql = "INSERT INTO ventascab ( "
lcSql = lcSql + "idVentasC, idCliente, razSoc, idTipoDoc, nroDoc, fecEmision, fecVto, cbte, tipoDoc, ptoVta, numCbte, anulado, idCondPago, idSitIVA, idVendedor, "
lcSql = lcSql + "impNeto, impFinal, porIVA21, impIVA21, porIVA105, impIVA105, porDesc1, "
lcSql = lcSql + "porDesc2, porDesc3, porDesc4, impDesc1, impDesc2, impDesc3, impDesc4, totFact, Saldo, usuAlta, fecAlta, idHostAlta, porIIBB, impIIBB, observ) VALUES ("
lcSql = lcSql + ALLTRIM(STR(lnIdVentaC)) + ", "
lcSql = lcSql + ALLTRIM(STR(Thisform.idCliente)) + ", "
lcSql = lcSql + "'" + ALLTRIM(Thisform.cli_razsoc) + "', "
lcSql = lcSql + ALLTRIM(STR(Thisform.cli_idTipodoc)) + ", "
lcSql = lcSql + "'" + ALLTRIM(Thisform.cli_cuit) + "', "
lcSql = lcSql + IIF(Thisform.sqlsrv, "GETDATE(), " , "current_date, ")
lcSql = lcSql + IIF(Thisform.sqlsrv, "GETDATE(), " , "current_date, ")
lcSql = lcSql + "'" + ALLTRIM(Thisform.cbte) + "', "
lcSql = lcSql + "'" + ALLTRIM(Thisform.tipodocref) + "', "
lcSql = lcSql + ALLTRIM(STR(lnPtoVta)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnNroCbte)) + ", "
lcSql = lcSql + "0, "
lcSql = lcSql + ALLTRIM(STR(lnIdCondPago)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnIdSitIVA)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnIdVendedor)) + ", "
lcSql = lcSql + ALLTRIM(STR(Thisform.txtSubTotal.Value, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(Thisform.txtSubTotal.Value, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnPorIVA21, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpIVA21, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnPorIVA105, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpIVA105, 10, 2)) + ", "
lcSql = lcSql + "0, 0, 0, 0, 0, 0, 0, 0, "
lcSql = lcSql + ALLTRIM(STR(Thisform.txtTotal.Value, 10, 2)) + ", 0, "
lcSql = lcSql + "'" + ALLTRIM(gcCodUsu) + "', "
lcSql = lcSql + loDateTime.getDateTime() + ", "
lcSql = lcSql + "'" + SYS(0) + "', "
lcSql = lcSql + ALLTRIM(STR(lnPorIIBB, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpIIBB, 10, 2)) + ", "
lcSql = lcSql + "'" + ALLTRIM(thisform.txtobserv.Value) + "')"

loCommand.commandText = lcSql
loCommand.ActiveConnection = goConn.ActiveConnection

IF !loCommand.Execute() then
	goConn.Rollback()
	MESSAGEBOX(loCommand.ErrorMessage, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

&& Grabar el detalle en VTADCP
SELECT vtadcp
GO TOP
DO WHILE !EOF("vtadcp")
	lnIdVtaCP = goConn.GetNextID("vtadcp", "id_vtadcp")
	
	lcSql = "INSERT INTO vtadcp ( "
	lcSql = lcSql + "id_vtadcp, idVentasC, idPlanCta, impNeto, ivaPor, ivaImp, total) VALUES "
	lcSql = lcSql + "(" + ALLTRIM(STR(lnIdVtaCP)) + ", " + ALLTRIM(STR(lnIdVentaC)) + ", " + ALLTRIM(STR(vtadcp.idPlanCta)) + ", "
	lcSql = lcSql + ALLTRIM(STR(vtadcp.impNeto, 10, 2)) + ", " + ALLTRIM(STR(vtadcp.ivaPor, 10, 2)) + ", " + ALLTRIM(STR(vtadcp.ivaImp, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(vtadcp.total, 10, 2)) + ")"
	
	loCommand.ActiveConnection = goConn.ActiveConnection
	loCommand.CommandText = lcSql
	
	IF !loCommand.Execute() THEN
		goConn.Rollback()
		MESSAGEBOX(loCommand.ErrorMessage, 0+48, Thisform.Caption)
		RETURN .F.
	ENDIF
	
	&& Marco el cheque como cheque rechazado
	IF ALLTRIM(vtadcp.cheque_nro) != "" THEN
		lcSql = "UPDATE cheques SET estado = 'R' WHERE chq_nro = '" + ALLTRIM(vtadcp.cheque_nro) + "' AND idBanco = " + ALLTRIM(STR(vtadcp.idBanco))
		loCommand.ActiveConnection = goConn.ActiveConnection
		loCommand.CommandText = lcSql
		
		IF !loCommand.Execute() THEN
			goConn.Rollback()
			MESSAGEBOX(loCommand.ErrorMessage, 0+48, Thisform.Caption)
			RETURN .F.
		ENDIF
	ENDIF	

	SELECT vtadcp
	SKIP
ENDDO


&& Grabar el registro en CC_CLI vinculado por Id_Oper al cbte seleccionado
*!*	lnIdCC_Cli = goConn.GetNextID("cc_cli", "idCC_Cli")

*!*	IF Thisform.idOper = 0 THEN
*!*		lnIdOper = goConn.GetNextID("cc_cli", "idOper")
*!*	ELSE
*!*		lnIdOper = Thisform.idOper
*!*	ENDIF 

*!*	IF ALLTRIM(Thisform.cbte) == "NC" THEN
*!*		lcSql = "INSERT INTO cc_cli (idCC_Cli, idCliente, idCC_Orig, idVentasC, cbte, tipoDoc, ptoVta, nroCbte, fecEmis, fecVto, idCondPago, idSitIVA, idVendedor, "
*!*		lcSql = lcSql + "impDebe, impHaber, idOper, observ, usuAlta, fecAlta, idHostAlta) VALUES ( "
*!*		lcSql = lcSql + ALLTRIM(STR(lnIdCC_Cli)) + ", " + ALLTRIM(STR(Thisform.idCliente)) + ", " + IIF(lnIdCC_CliOrig <> -1, ALLTRIM(STR(lnIdCC_CliOrig)), "null") + ", "
*!*		lcSql = lcSql + ALLTRIM(STR(lnIdVentaC)) + ", '" + ALLTRIM(Thisform.cbte) + "', '" + ALLTRIM(Thisform.TipoDocRef) + "', "
*!*		lcSql = lcSql + ALLTRIM(STR(lnPtoVta)) + ", " + ALLTRIM(STR(lnNroCbte)) + ", " + loDateTime.getDateTime() + ", " + loDateTime.getDateTime() + ", " + ALLTRIM(STR(lnIdCondPago)) + ", "
*!*		lcSql = lcSql + ALLTRIM(STR(lnIdSitIVA)) + ", " + ALLTRIM(STR(lnIdVendedor)) + ", 0, " + ALLTRIM(STR(Thisform.txtTotal.Value, 10, 2)) + ", " + ALLTRIM(STR(lnIdOPer)) + ", '" + ALLTRIM(thisform.txtobserv.Value) + "', "
*!*		lcSql = lcSql + "'" + ALLTRIM(gcCodUsu) + "', " + loDateTime.getDateTime() + ", '" + ALLTRIM(SYS(0)) + "')"
*!*	ELSE
*!*		lcSql = "INSERT INTO cc_cli (idCC_Cli, idCliente, idCC_Orig, idVentasC, cbte, tipoDoc, ptoVta, nroCbte, fecEmis, fecVto, idCondPago, idSitIVA, idVendedor, "
*!*		lcSql = lcSql + "impDebe, impHaber, idOper, observ, usuAlta, fecAlta, idHostAlta) VALUES ( "
*!*		lcSql = lcSql + ALLTRIM(STR(lnIdCC_Cli)) + ", " + ALLTRIM(STR(Thisform.idCliente)) + ", " + IIF(lnIdCC_CliOrig <> -1, ALLTRIM(STR(lnIdCC_CliOrig)), "null") + ", "
*!*		lcSql = lcSql + ALLTRIM(STR(lnIdVentaC)) + ", '" + ALLTRIM(Thisform.cbte) + "', '" + ALLTRIM(Thisform.TipoDocRef) + "', "
*!*		lcSql = lcSql + ALLTRIM(STR(lnPtoVta)) + ", " + ALLTRIM(STR(lnNroCbte)) + ", " + loDateTime.getDateTime() + ", " + loDateTime.getDateTime() + ", " + ALLTRIM(STR(lnIdCondPago)) + ", "
*!*		lcSql = lcSql + ALLTRIM(STR(lnIdSitIVA)) + ", " + ALLTRIM(STR(lnIdVendedor)) + ", " + ALLTRIM(STR(Thisform.txtTotal.Value, 10, 2)) + ", 0, " + ALLTRIM(STR(lnIdOper)) + ", '" + ALLTRIM(thisform.txtobserv.Value) + "', "
*!*		lcSql = lcSql + "'" + ALLTRIM(gcCodUsu) + "', " + loDateTime.getDateTime() + ", '" + ALLTRIM(SYS(0)) + "')"
*!*	ENDIF

*!*	loCommand.ActiveConnection = goConn.ActiveConnection
*!*	loCommand.CommandText = lcSql

*!*	IF !loCommand.Execute() THEN
*!*		goConn.Rollback()
*!*		MESSAGEBOX(loCommand.ErrorMessage, 0+48, Thisform.Caption)
*!*		RETURN .F.
*!*	ENDIF

IF !Thisform.grabar_ctacte(lnIdVentaC) THEN
	goConn.Rollback()
	RETURN .F.
ENDIF

IF Thisform.idVentascab <> - 1 THEN

	&& Actualizar idOper del movimiento seleccionado
	lcSql = "UPDATE cc_cli SET idOper = " + ALLTRIM(STR(lnIdOper)) + ", "
	lcSql = lcSql + "usuModi = '" + ALLTRIM(gcCodUsu) + "', "
	lcSql = lcSql + "fecModi = " + loDateTime.getDateTime() + ", "
	lcSql = lcSql + "idHostModi = '" + ALLTRIM(SYS(0)) + "' "
	lcSql = lcSql + "WHERE idCC_Cli = " + ALLTRIM(STR(Thisform.idcc_cli))

	loCommand.CommandText = lcSql
	loCommand.ActiveConnection = goConn.ActiveConnection

	IF !loCommand.Execute()
		goConn.Rollback()
		RETURN .F.
	ENDIF

	&& Generar el registro de vinculación de comprobantes
	lnIdVtasRel = goConn.GetNextId("ventasrel", "idvtarel")

	&& Vinculo el comprobante de venta
	lcSql = "INSERT INTO ventasrel (idVtaRel, idVtaCO, idVtaCD) VALUES "
	lcSql = lcSql + "(" + ALLTRIM(STR(lnIdVtasRel)) + ", " + ALLTRIM(STR(Thisform.idventascab)) + ", " + ALLTRIM(STR(lnIdVentaC)) + ")"

	loCommand.ActiveConnection = goConn.ActiveConnection
	loCommand.CommandText = lcSql

	IF !loCommand.Execute()
		goConn.Rollback()
		RETURN .F.
	ENDIF
ENDIF 

&& Actualizar el saldo de la factura seleccionada
IF ALLTRIM(thisform.cbte) == "NC" THEN

	lcSql = "UPDATE ventascab SET Saldo = Saldo - " + ALLTRIM(STR(Thisform.txtTotal.Value, 10, 2)) + ", "
	lcSql = lcSql + "usuModi = '" + ALLTRIM(gcCodUsu) + "', "
	lcSql = lcSql + "fecModi = " + loDateTime.getDateTime() + ", "
	lcSql = lcSql + "idHostModi = '" + ALLTRIM(SYS(0)) + "' "
	lcSql = lcSql + "WHERE idVentasC IN (SELECT IdVentasC FROM cc_cli WHERE IdOper = " +  ALLTRIM(STR(lnIdOper)) + " AND cbte like 'FC%')"
ELSE 
	lcSql = "UPDATE ventascab SET Saldo = Saldo + " + ALLTRIM(STR(Thisform.txtTotal.Value, 10, 2)) + ", "
	lcSql = lcSql + "usuModi = '" + ALLTRIM(gcCodUsu) + "', "
	lcSql = lcSql + "fecModi = " + loDateTime.getDateTime() + ", "
	lcSql = lcSql + "idHostModi = '" + ALLTRIM(SYS(0)) + "' "
	lcSql = lcSql + "WHERE idVentasC IN (SELECT IdVentasC FROM cc_cli WHERE IdOper = " +  ALLTRIM(STR(lnIdOper)) + " AND cbte like 'FC%')"

ENDIF
	
loCommand.CommandText = lcSql
loCommand.ActiveConnection = goConn.ActiveConnection

IF !loCommand.Execute()
	goConn.Rollback()
	RETURN .F.
ENDIF 

goConn.Commit()

Thisform.ptovta = REPLICATE("0", 4 - LEN(ALLTRIM(STR(lnPtoVta)))) + ALLTRIM(STR(lnPtoVta))
Thisform.nrocbte = REPLICATE("0", 8 - LEN(ALLTRIM(STR(lnNroCbte)))) + ALLTRIM(STR(lnNroCbte))

MESSAGEBOX("El comprobante: " + ALLTRIM(Thisform.cbte) + " " + ALLTRIM(Thisform.Tipodocref) + " " + REPLICATE("0", 4 - LEN(ALLTRIM(STR(lnPtoVta)))) + ALLTRIM(STR(lnPtoVta)) + "-" + ;
	REPLICATE("0", 8 - LEN(ALLTRIM(STR(lnNroCbte)))) + ALLTRIM(STR(lnNroCbte)) + " se ha generado exitosamente...", 0+64, Thisform.Caption)

IF !Thisform.usa_fiscal THEN
	Thisform.imprimir()
ENDIF

Thisform.Release()
RETURN .T.
ENDPROC


************************************************************
OBJETO: btnCerrar
************************************************************
*** PROPIEDADES ***
Top = 471
Left = 727
Height = 44
Width = 45
Cancel = .T.
TabIndex = 14
Name = "btnCerrar"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta10
************************************************************
*** PROPIEDADES ***
Caption = "Banco:"
Height = 15
Left = 12
Top = 95
Width = 72
TabIndex = 22
Name = "Clsetiqueta10"

*** METODOS ***


************************************************************
OBJETO: Sel_Banco
************************************************************
*** PROPIEDADES ***
Top = 87
Left = 91
TabIndex = 2
esnumerico = .F.
cfieldname = codbco
nombre_campo_codigo = codbco
nombre_campo_desc = descripcio
nombre_tabla = bancos
pkfield = idBanco
autocompletar_ceros = .F.
Name = "Sel_Banco"
txtCodigo.Value = 
txtCodigo.Name = "txtCodigo"
txtDescripcion.Name = "txtDescripcion"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta11
************************************************************
*** PROPIEDADES ***
Caption = "Cheque Nº:"
Height = 15
Left = 576
Top = 92
Width = 72
TabIndex = 24
Name = "Clsetiqueta11"

*** METODOS ***


************************************************************
OBJETO: txtNroCheque
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 644
MaxLength = 8
TabIndex = 3
Top = 89
Width = 125
ischaracter = .T.
autocompleta = .T.
Name = "txtNroCheque"

*** METODOS ***
PROCEDURE LostFocus
DODEFAULT()

IF !Thisform.buscar_cheque() THEN
	Thisform.sel_Banco.txtCodigo.SetFocus()
ENDIF

ENDPROC


************************************************************
OBJETO: Clsetiqueta12
************************************************************
*** PROPIEDADES ***
Caption = "I.V.A 21:"
Height = 15
Left = 226
Top = 422
Width = 57
TabIndex = 33
Name = "Clsetiqueta12"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta13
************************************************************
*** PROPIEDADES ***
Caption = "I.V.A 10,5:"
Height = 15
Left = 226
Top = 445
Width = 72
TabIndex = 35
Name = "Clsetiqueta13"

*** METODOS ***


************************************************************
OBJETO: txtPorIVA21
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 297
ReadOnly = .T.
TabIndex = 41
Top = 418
Width = 44
isnumeric = .T.
Name = "txtPorIVA21"

*** METODOS ***


************************************************************
OBJETO: txtPorIVA105
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 297
ReadOnly = .T.
TabIndex = 42
Top = 441
Width = 44
isnumeric = .T.
Name = "txtPorIVA105"

*** METODOS ***


************************************************************
OBJETO: txtImpIVA21
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 342
ReadOnly = .T.
TabIndex = 44
Top = 418
Width = 75
isnumeric = .T.
Name = "txtImpIVA21"

*** METODOS ***


************************************************************
OBJETO: txtImpIVA105
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 342
ReadOnly = .T.
TabIndex = 45
Top = 441
Width = 75
isnumeric = .T.
Name = "txtImpIVA105"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta18
************************************************************
*** PROPIEDADES ***
Caption = "Perc. IIBB.:"
Height = 15
Left = 226
Top = 467
Width = 63
TabIndex = 34
Name = "Clsetiqueta18"

*** METODOS ***


************************************************************
OBJETO: txtPorIIBB
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 297
ReadOnly = .T.
TabIndex = 40
Top = 464
Width = 44
isnumeric = .T.
Name = "txtPorIIBB"

*** METODOS ***


************************************************************
OBJETO: txtImpIIBB
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 342
ReadOnly = .T.
TabIndex = 43
Top = 464
Width = 75
isnumeric = .T.
Name = "txtImpIIBB"

*** METODOS ***


************************************************************
OBJETO: Clsdelete
************************************************************
*** PROPIEDADES ***
Top = 143
Left = 727
Height = 44
Width = 45
Name = "Clsdelete"

*** METODOS ***
PROCEDURE Click
LOCAL lnResp

lnResp = MESSAGEBOX("Está seguro que desea eliminar este ítem?", 0+4, Thisform.Caption)

IF lnResp = 6 THEN
	SELECT vtadcp 
	DELETE 

	Thisform.grdDetalle.Refresh()

	Thisform.sumar_items()
	Thisform.calcular_ret_iibb()
ENDIF 
ENDPROC


************************************************************
OBJETO: Clsetiqueta7
************************************************************
*** PROPIEDADES ***
Caption = "Leyenda:"
Height = 15
Left = 11
Top = 118
Width = 72
TabIndex = 22
Name = "Clsetiqueta7"

*** METODOS ***


************************************************************
OBJETO: txtobserv
************************************************************
*** PROPIEDADES ***
Enabled = .T.
Height = 21
Left = 93
TabIndex = 18
Top = 113
Width = 550
Name = "txtobserv"

*** METODOS ***


************************************************************
OBJETO: frm_ncnd_cc_sf
************************************************************
*** PROPIEDADES ***
Arial, 0, 8, 5, 14, 11, 29, 3, 0
Arial, 1, 8, 5, 14, 11, 29, 3, 0
Arial, 0, 9, 5, 15, 12, 32, 3, 0

*** METODOS ***


************************************************************
OBJETO: cls_login_vend
************************************************************
*** PROPIEDADES ***
DoCreate = .T.
apelnom = 
Name = "cls_login_vend"
contenido.Clsetiqueta1.Name = "Clsetiqueta1"
contenido.Clsetiqueta2.Name = "Clsetiqueta2"
contenido.txtUsuario.Name = "txtUsuario"
contenido.txtPassword.Name = "txtPassword"
contenido.BTNCERRAR.Name = "BTNCERRAR"
contenido.Clsetiqueta3.Name = "Clsetiqueta3"
contenido.CLSLINEA1.Name = "CLSLINEA1"
contenido.btnlogin.Name = "btnlogin"
contenido.Name = "contenido"

*** METODOS ***
PROCEDURE contenido.btnlogin.Click
LOCAL lcUsuario, lcClave
LOCAL rsUser, lcSql

rsUser = CREATEOBJECT("odbc_result")
lcSql = ""

WITH Thisform.contenido
	IF ALLTRIM(.txtUsuario.Value) == ""
		MESSAGEBOX("Debe ingresar el usuario", 0+48, Thisform.Caption)
		.txtUsuario.SetFocus
		RETURN .F.
	ENDIF
	
	IF ALLTRIM(.txtPassword.Value) == ""
		MESSAGEBOX("Debe ingresar la clave", 0+48, Thisform.Caption)
		.txtPassword.SetFocus()
		RETURN .F.
	ENDIF
	
	lcUsuario = .txtUsuario.Value
	lcClave = .txtPassword.Value
ENDWITH

lcSql = "select idUsuario, CodUsu, ApelNom, Password, habilitado from usuarios where CodUsu = '" + ALLTRIM(lcUsuario) + "'"
rsUser.ActiveConnection = goConn.ActiveConnection
rsUser.Cursor_Name = "cur_User"

IF !rsUser.OpenQuery(lcSql) THEN
	MESSAGEBOX(rsUser.Error_Message, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

SELECT cur_User
IF RECCOUNT("cur_User") = 0
	MESSAGEBOX("Usuario incorrecto", 0+48, Thisform.Caption)
	rsUser.close_query()
	Thisform.Contenido.txtUsuario.SetFocus()
	RETURN .F.
ELSE
	IF !cur_User.habilitado THEN
		MESSAGEBOX("Este usuario no se encuentra habilitado", 0+48, Thisform.Caption)
		rsUser.close_query()
		thisform.contenido.txtUsuario.SetFocus()
		RETURN .F.
	ENDIF

	SET EXACT ON
	
	IF ALLTRIM(Thisform.Contenido.txtPassword.Value) != ALLTRIM(cur_User.Password)
		rsUser.close_query()
		MESSAGEBOX("Clave incorrecta", 0+48, Thisform.Caption)
		RETURN .F.
	ENDIF
	
	SET EXACT OFF
ENDIF

Thisform.IsAccept = .T.
Thisform.apelnom = ALLTRIM(cur_User.ApelNom)
gcCodUsu = cur_User.CodUsu

rsUser.close_query()
Thisform.Hide()

RETURN .T.
ENDPROC


************************************************************
OBJETO: cls_login_vend
************************************************************
*** PROPIEDADES ***
Arial, 0, 9, 5, 15, 12, 32, 3, 0
Arial, 1, 8, 5, 14, 11, 29, 3, 0

*** METODOS ***


************************************************************
OBJETO: clsform_consbjacbte_sf
************************************************************
*** PROPIEDADES ***
BorderStyle = 2
Height = 500
Width = 900
DoCreate = .T.
Caption = "Consulta y Baja de Comprobantes"
list_cbtes = 
consulta = .T.
tipo_consulta = 
Name = "clsform_consbjacbte_sf"
CONTENIDO.Top = 0
CONTENIDO.Left = 0
CONTENIDO.Width = 900
CONTENIDO.Height = 505
CONTENIDO.Name = "CONTENIDO"

*** METODOS ***
PROCEDURE cargar_combos
&& Cargo los combobox de cbte y tipo de acuerdo a los comprobante seteados en la propiedad list_cbtes

LOCAL lc_cbtes, ln, lc_cantcbtes, ln_cargoAB
DIMENSION la_vector[10]

lc_cbtes = thisform.list_cbtes
lc_cantcbtes = ALINES(la_vector,lc_cbtes,5,",")
ln_cargoAB = 0

Thisform.contenido.cmbTipo.AddItem("Todos")

FOR ln=1 TO lc_cantcbtes 
	IF ln == 1 THEN 
		IF lc_cantcbtes > 1
			Thisform.contenido.cmbCbte.AddItem("Todos")
		ENDIF 
	ENDIF 
	
	Thisform.contenido.cmbCbte.AddItem(STRTRAN(la_vector(ln),"'",""))
	
	IF STRTRAN(la_vector(ln),"'","") == "FC" OR STRTRAN(la_vector(ln),"'","") == "NC" OR STRTRAN(la_vector(ln),"'","") == "ND"
		IF ln_cargoAB = 0 THEN 
			Thisform.contenido.cmbTipo.AddItem("A")
			Thisform.contenido.cmbTipo.AddItem("B")
			ln_cargoAB = 1
		ENDIF 
	ELSE 
		IF STRTRAN(la_vector(ln),"'","") == "PED"
			Thisform.contenido.cmbTipo.AddItem("P")
		ENDIF 
	ENDIF 
ENDFOR 

IF INT(VAL(getConfig("SQLSRV"))) = 2 THEN
	THisform.contenido.cmbTipo.AddItem("X")
ENDIF

Thisform.contenido.cmbCbte.ListIndex = 1
Thisform.contenido.cmbTipo.ListIndex = 1

ENDPROC
PROCEDURE Load
DODEFAULT()

CREATE CURSOR cur_Cbtes( 	;
	idVentasC	int,;
	idCliente	int,;
	razSoc		C(60),;
	fecEmis		datetime,;
	nroDoc		C(20),;
	impFinal	F(10,2),;
	usualta		C(5),;
	idhostalta	C(50),;
	Observ		M)
	
	
SELECT cur_Cbtes
INDEX on idVentasC TAG idVentasC ASCENDING
INDEX on idCliente TAG idCliente ASCENDING ADDITIVE 
INDEX on razSoc TAG razSoc ASCENDING ADDITIVE 
INDEX on fecEmis TAG fecEmis ASCENDING ADDITIVE 
INDEX on nroDoc TAG nroDoc ASCENDING ADDITIVE 
INDEX on impFinal TAG impFinal ASCENDING ADDITIVE
INDEX on usualta TAG usualta ASCENDING ADDITIVE
INDEX on idhostalta TAG idhostalta ASCENDING ADDITIVE 
	
SELECT cur_Cbtes
SET ORDER TO TAG fecEmis ASCENDING
ENDPROC
PROCEDURE Init
&& Configuro según la funcionalidad del formulario

Thisform.cargar_combos()

IF thisform.consulta
	thisform.contenido.btnEliminar.Visible = .F.
ELSE
	thisform.contenido.btnEliminar.Visible = .T.
ENDIF

thisform.contenido.txtFecDesde.Value = DATE() - 30
thisform.contenido.txtFecHasta.Value = DATE()
thisform.contenido.txtptovta.Value = "0000"
thisform.contenido.txtnumero.Value = "00000000"
thisform.ShowTips = .T.

ENDPROC


************************************************************
OBJETO: stock
************************************************************
*** PROPIEDADES ***
Top = 468
Left = 384
Height = 17
Width = 36
Name = "stock"

*** METODOS ***


************************************************************
OBJETO: CLSETIQUETA1
************************************************************
*** PROPIEDADES ***
Caption = "Cliente Desde:"
Height = 15
Left = 5
Top = 13
TabIndex = 12
Name = "CLSETIQUETA1"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta2
************************************************************
*** PROPIEDADES ***
Caption = "Cliente Hasta:"
Height = 15
Left = 5
Top = 37
TabIndex = 13
Name = "Clsetiqueta2"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta3
************************************************************
*** PROPIEDADES ***
Caption = "Fecha Desde:"
Height = 15
Left = 5
Top = 89
Width = 84
TabIndex = 15
Name = "Clsetiqueta3"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta4
************************************************************
*** PROPIEDADES ***
Caption = "Fecha Hasta:"
Height = 15
Left = 202
Top = 89
Width = 84
TabIndex = 16
Name = "Clsetiqueta4"

*** METODOS ***


************************************************************
OBJETO: sel_cliDesde
************************************************************
*** PROPIEDADES ***
Top = 8
Left = 96
TabIndex = 1
cfieldname = idCliente
esnumerico = .T.
nombre_campo_codigo = idCliente
nombre_campo_desc = razSoc
nombre_tabla = clientes
pkfield = idCliente
requerido = .F.
criterio_filtro = clientes.fecBaja IS NULL
Name = "sel_cliDesde"
TXTCODIGO.Name = "TXTCODIGO"
TXTDESCRIPCION.Name = "TXTDESCRIPCION"

*** METODOS ***


************************************************************
OBJETO: sel_cliHasta
************************************************************
*** PROPIEDADES ***
Top = 32
Left = 96
TabIndex = 2
cfieldname = idCliente
esnumerico = .T.
nombre_campo_codigo = idCliente
nombre_campo_desc = razSoc
nombre_tabla = clientes
pkfield = idCliente
requerido = .F.
criterio_filtro = clientes.fecBaja IS NULL
Name = "sel_cliHasta"
TXTCODIGO.Name = "TXTCODIGO"
TXTDESCRIPCION.Name = "TXTDESCRIPCION"

*** METODOS ***


************************************************************
OBJETO: txtFecDesde
************************************************************
*** PROPIEDADES ***
Left = 98
TabIndex = 7
Top = 85
isdatetime = .T.
Name = "txtFecDesde"

*** METODOS ***


************************************************************
OBJETO: txtFecHasta
************************************************************
*** PROPIEDADES ***
Left = 292
TabIndex = 8
Top = 85
isdatetime = .T.
Name = "txtFecHasta"

*** METODOS ***


************************************************************
OBJETO: grdCbtes
************************************************************
*** PROPIEDADES ***
Height = 339
Left = 2
TabIndex = 17
Top = 112
Width = 895
alias_name = cur_Cbtes
permitir_busqueda = .T.
permitir_ordenamiento = .T.
list_controlsource = fecEmis,idCliente,razSoc,nroDoc,impFinal,usualta,idhostalta
lista_ancho_cols = 130,70,210,150,70,70,150
titulos_cabeceras = Fecha,Cliente,Razón Social,Nro. Comprobante,Importe,Usuario,Host
Name = "grdCbtes"
COLUMN1.HEADER1.Name = "HEADER1"
COLUMN1.TEXT1.Name = "TEXT1"
COLUMN1.Name = "COLUMN1"
COLUMN2.HEADER1.Name = "HEADER1"
COLUMN2.TEXT1.Name = "TEXT1"
COLUMN2.Name = "COLUMN2"
COLUMN3.HEADER1.Name = "HEADER1"
COLUMN3.TEXT1.Name = "TEXT1"
COLUMN3.Name = "COLUMN3"
COLUMN4.HEADER1.Name = "HEADER1"
COLUMN4.TEXT1.Name = "TEXT1"
COLUMN4.Name = "COLUMN4"
COLUMN5.HEADER1.Name = "HEADER1"
COLUMN5.TEXT1.Name = "TEXT1"
COLUMN5.Name = "COLUMN5"
COLUMN6.HEADER1.Name = "HEADER1"
COLUMN6.TEXT1.Name = "TEXT1"
COLUMN6.Name = "COLUMN6"
COLUMN7.HEADER1.Name = "HEADER1"
COLUMN7.TEXT1.Name = "TEXT1"
COLUMN7.Name = "COLUMN7"
COLUMN8.HEADER1.Name = "HEADER1"
COLUMN8.TEXT1.Name = "TEXT1"
COLUMN8.Name = "COLUMN8"
COLUMN9.HEADER1.Name = "HEADER1"
COLUMN9.TEXT1.Name = "TEXT1"
COLUMN9.Name = "COLUMN9"
COLUMN10.HEADER1.Name = "HEADER1"
COLUMN10.TEXT1.Name = "TEXT1"
COLUMN10.Name = "COLUMN10"
COLUMN11.HEADER1.Name = "HEADER1"
COLUMN11.TEXT1.Name = "TEXT1"
COLUMN11.Name = "COLUMN11"
COLUMN12.HEADER1.Name = "HEADER1"
COLUMN12.TEXT1.Name = "TEXT1"
COLUMN12.Name = "COLUMN12"
COLUMN13.HEADER1.Name = "HEADER1"
COLUMN13.TEXT1.Name = "TEXT1"
COLUMN13.Name = "COLUMN13"
COLUMN14.HEADER1.Name = "HEADER1"
COLUMN14.TEXT1.Name = "TEXT1"
COLUMN14.Name = "COLUMN14"
COLUMN15.HEADER1.Name = "HEADER1"
COLUMN15.TEXT1.Name = "TEXT1"
COLUMN15.Name = "COLUMN15"
COLUMN16.HEADER1.Name = "HEADER1"
COLUMN16.TEXT1.Name = "TEXT1"
COLUMN16.Name = "COLUMN16"
COLUMN17.HEADER1.Name = "HEADER1"
COLUMN17.TEXT1.Name = "TEXT1"
COLUMN17.Name = "COLUMN17"
COLUMN18.HEADER1.Name = "HEADER1"
COLUMN18.TEXT1.Name = "TEXT1"
COLUMN18.Name = "COLUMN18"
COLUMN19.HEADER1.Name = "HEADER1"
COLUMN19.TEXT1.Name = "TEXT1"
COLUMN19.Name = "COLUMN19"
COLUMN20.HEADER1.Name = "HEADER1"
COLUMN20.TEXT1.Name = "TEXT1"
COLUMN20.Name = "COLUMN20"

*** METODOS ***


************************************************************
OBJETO: btnAceptar
************************************************************
*** PROPIEDADES ***
Top = 66
Left = 852
Height = 44
Width = 45
TabIndex = 9
Name = "btnAceptar"

*** METODOS ***
PROCEDURE Click
LOCAL lcFecDesde, lcFecHasta, loDateTime, lcNroDoc 
LOCAL lnIdCliDesde, lnIdCliHasta, lcSql, loResult

loDateTime = CREATEOBJECT("datetime")
loResult = CREATEOBJECT("odbc_result")
lcFecDesde = loDateTime.toMySql(thisform.contenido.txtFecDesde.Value)
lcFecHasta = loDateTime.toMySql(thisform.contenido.txtFecHasta.Value)
lcNroDoc = "" 

IF thisform.contenido.sel_cliDesde.valcpoid <> 0 .AND. thisform.contenido.sel_CliHasta.valcpoid <> 0
	lnIdCliDesde = thisform.contenido.sel_cliDesde.valcpoid
	lnIdCliHasta = thisform.contenido.sel_CliHasta.valcpoid
ELSE
	lnIdCliDesde = 0
	lnIdCliHasta = 999999
ENDIF

SELECT cur_Cbtes
ZAP

lcSql = "CALL ventascab_consultar ( " ;
	+ "?tipoConsulta, " ;
	+ "?fechaDesde, " ;
	+ "?fechaHasta, " ;
	+ "?idClienteDesde, " ;
	+ "?idClienteHasta, " ;
	+ "?cbte, " ;
	+ "?tipoDoc, " ;
	+ "?ptoVta, " ;
	+ "?numCbte)"
	
lcSql = loResult.AddParameter(lcSql, "tipoConsulta", thisform.tipo_consulta, .t., .f.)
lcSql = loResult.AddParameter(lcSql, "fechaDesde", thisform.contenido.txtFecDesde.Value, .f., .t.)
lcSql = loResult.AddParameter(lcSql, "fechaHasta", thisform.contenido.txtFecHasta.Value, .f., .t.)
lcSql = loResult.AddParameter(lcSql, "idClienteDesde", ALLTRIM(STR(thisform.contenido.sel_cliDesde.valcpoid)), .f., .f.)
lcSql = loResult.AddParameter(lcSql, "idClienteHasta", ALLTRIM(STR(thisform.contenido.sel_cliHasta.valcpoid)), .f., .f.)
lcSql = loResult.AddParameter(lcSql, "cbte", ALLTRIM(UPPER(thisform.contenido.cmbCbte.Value)), .t., .f.)
lcSql = loResult.AddParameter(lcSql, "tipoDoc", ALLTRIM(UPPER(thisform.contenido.cmbTipo.Value)), .t., .f.)
lcSql = loResult.AddParameter(lcSql, "ptoVta", ALLTRIM(STR(INT(VAL(ALLTRIM(thisform.contenido.txtPtoVta.Value))))), .f., .f.)
lcSql = loResult.AddParameter(lcSql, "numCbte", ALLTRIM(STR(INT(VAL(ALLTRIM(thisform.contenido.txtNumero.Value))))), .f., .f.)

loResult.ActiveConnection = goConn.ActiveConnection
loResult.cursor_name = "cur_tempo"
loResult.OpenQuery(lcSql)
_cliptext = lcSql
SELECT cur_tempo
IF RECCOUNT() > 0
	GO TOP
ENDIF

SELECT cur_tempo
DO WHILE !EOF()
	lcNroDoc = ALLTRIM(cur_tempo.Cbte) + " " + ALLTRIM(cur_tempo.tipoDoc) + " "
	lcNroDoc = lcNroDoc + REPLICATE("0", 4 - LEN(ALLTRIM(STR(cur_tempo.ptoVta)))) + ALLTRIM(STR(cur_tempo.ptoVta)) + "-"
	lcNroDoc = lcNroDoc + REPLICATE("0", 8 - LEN(ALLTRIM(STR(cur_tempo.numCbte)))) + ALLTRIM(STR(cur_tempo.numCbte))

	SELECT cur_Cbtes
	APPEND BLANK
	REPLACE idVentasC WITH cur_tempo.idVentasC
	REPLACE idCliente WITH cur_tempo.idCliente ADDITIVE
	REPLACE razSoc WITH cur_tempo.razSoc ADDITIVE
	REPLACE fecEmis WITH cur_tempo.fecEmision ADDITIVE
	REPLACE nroDoc WITH lcNroDoc ADDITIVE
	REPLACE impFinal WITH cur_tempo.impFinal ADDITIVE
	REPLACE usualta WITH cur_tempo.usualta ADDITIVE
	REPLACE idhostalta WITH cur_tempo.idhostalta ADDITIVE
	REPLACE observ WITH IIF(ISNULL(cur_tempo.Observ), "", cur_tempo.Observ) ADDITIVE

	SELECT cur_tempo
	SKIP
ENDDO

loResult.close_query()

SELECT cur_Cbtes
IF RECCOUNT() > 0
	GO TOP
ENDIF

Thisform.Contenido.grdCbtes.Refresh()

ENDPROC


************************************************************
OBJETO: btnEliminar
************************************************************
*** PROPIEDADES ***
Top = 454
Left = 805
TabIndex = 12
Name = "btnEliminar"

*** METODOS ***
PROCEDURE Click
LOCAL lnResp, lcSql, loRes
LOCAL loCommand

lnResp = 0
lcSql = ""
loRes = CREATEOBJECT("odbc_result")
loCommand = CREATEOBJECT("odbc_command")

lnResp = MESSAGEBOX("¿Está seguro que desea anular el comprobante?", 4+32, Thisform.Caption)

IF lnResp = 6
	goConn.BeginTransaction()

	lcSql = "UPDATE ventascab "
	lcSql = lcSql + "SET anulado = 1, "
	lcSql = lcSql + "usuBaja = '" + ALLTRIM(gcCodUsu) + "', " 
	IF ALLTRIM(getconfig("SQLSRV")) == "0" THEN
		lcSql = lcSql + "fecBaja = current_timestamp, "
	ELSE
		lcSql = lcSql + "fecBaja = GETDATE(), "
	ENDIF
	lcSql = lcSql + "idHostBaja = '" + SYS(0) + "' "
	lcSql = lcSql + "WHERE idventasc = " + ALLTRIM(STR(cur_Cbtes.idventasc))
	
	loCommand.ActiveConnection = goConn.ActiveConnection
	loCommand.CommandText = lcSql
	
	IF !loCommand.execute()
		MESSAGEBOX("No se ha podido anular el comprobante", 0+64, thisform.Caption)
		goConn.Rollback()
		RETURN .F.
	ENDIF
	
	SELECT cur_Cbtes
	DELETE
	thisform.contenido.grdCbtes.Refresh()
		
	&& Si estoy eliminando una factura, entonces, tengo que dar de alta nuevamente
	&& el stock
	IF getGlobalCFG("STK_MODULE") THEN
		IF SUBSTR(cur_Cbtes.nroDoc, 1, 2) == "FC" .OR. SUBSTR(cur_Cbtes.nroDoc, 1, 2) == "PED" THEN
			lcSql = "select * from ventasdet where idVentasC = " + ALLTRIM(STR(cur_Cbtes.idVentasC))
			loRes.ActiveConnection = goConn.ActiveConnection
			loRes.Cursor_Name = "cur_x"
			
			IF !loRes.OpenQuery(lcSql) THEN
				MESSAGEBOX(loRes.Error_Message, 0+48, Thisform.Caption)
				goConn.Rollback()
				RETURN .F.
			ENDIF
			
			SELECT cur_x
			IF RECCOUNT() > 0 THEN
				GO TOP
			ENDIF
			
			DO WHILE !EOF("cur_x")
				thisform.stock.crear_cursor()
				thisform.stock.circuito = "V"
				thisform.stock.tipomov = "ENT"
				thisform.stock.cbte = ""
				thisform.stock.numcbte = "ANULACION " + SUBSTR(cur_Cbtes.nroDoc, 1, 2)
				thisform.stock.agregar_articulo(cur_x.idArticulo, cur_x.cantidad, IIF(ISNULL(cur_x.nroPart), "", cur_x.nroPart))
				
				IF !thisform.stock.grabar2() THEN
					MESSAGEBOX(thisform.stock.ErrorMessage, 0+48, thisform.Caption)
					goConn.Rollback()
					RETURN .F.
				ENDIF
			
				SELECT cur_x
				SKIP
			ENDDO
			
			loRes.Close_Query()
		ENDIF
	ENDIF
	
	&& Doy de baja la factura en la cuenta corriente del cliente
	lcSql = "update cc_cli "
	lcSql = lcSql + "set cc_cli.usuBaja = '" + ALLTRIM(gcCodUsu) + "', "
	lcSql = lcSql + "	fecBaja = " + IIF(INT(VAL(getConfig("SQLSRV"))) = 1, "getdate(), ", "current_timestamp, ")
	lcSql = lcSql + "	idHostBaja = '" + ALLTRIM(SYS(0)) + "' "
	lcSql = lcSql + "where idVentasC = " + ALLTRIM(STR(cur_Cbtes.idVentasC))
	
	loCommand.ActiveConnection = goConn.ActiveConnection
	loCommand.CommandText = lcSql
	
	IF !loCommand.Execute() THEN
		MESSAGEBOX(loCommand.ErrorMessage, 0+48, Thisform.Caption)
		goConn.Rollback()
		RETURN .F.
	ENDIF
	
	goConn.Commit()
ENDIF

RETURN .T.
ENDPROC


************************************************************
OBJETO: btnCerrar
************************************************************
*** PROPIEDADES ***
Top = 454
Left = 852
TabIndex = 13
Name = "btnCerrar"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta5
************************************************************
*** PROPIEDADES ***
Caption = "Comprobante:"
Height = 15
Left = 5
Top = 62
Width = 84
TabIndex = 14
Name = "Clsetiqueta5"

*** METODOS ***


************************************************************
OBJETO: txtptovta
************************************************************
*** PROPIEDADES ***
Alignment = 3
Value = 
Height = 21
Left = 208
MaxLength = 4
TabIndex = 5
Top = 59
Width = 45
autocompleta = .T.
ischaracter = .T.
Name = "txtptovta"

*** METODOS ***


************************************************************
OBJETO: cmbCbte
************************************************************
*** PROPIEDADES ***
Height = 24
Left = 98
TabIndex = 3
Top = 58
Width = 59
cfieldname = 
Name = "cmbCbte"

*** METODOS ***


************************************************************
OBJETO: cmbTipo
************************************************************
*** PROPIEDADES ***
Height = 24
Left = 160
TabIndex = 4
Top = 58
Width = 44
Name = "cmbTipo"

*** METODOS ***


************************************************************
OBJETO: txtnumero
************************************************************
*** PROPIEDADES ***
Alignment = 3
Value = 
Height = 21
Left = 256
MaxLength = 8
TabIndex = 6
Top = 59
Width = 90
ischaracter = .T.
autocompleta = .T.
Name = "txtnumero"

*** METODOS ***


************************************************************
OBJETO: btnVerDetalles
************************************************************
*** PROPIEDADES ***
Top = 453
Left = 5
TabIndex = 10
Name = "btnVerDetalles"

*** METODOS ***
PROCEDURE Click
DO FORM "frmImagenCbte"
ENDPROC


************************************************************
OBJETO: btnSeguimiento
************************************************************
*** PROPIEDADES ***
Top = 454
Left = 52
Height = 44
Width = 45
Picture = ..\imagen\my-documents.ico
TabIndex = 11
ToolTipText = "Seguimiento de Comprobantes"
Name = "btnSeguimiento"

*** METODOS ***
PROCEDURE Click
LOCAL loForm

loForm = CREATEOBJECT("cls_frm_linkedcbtes")

SELECT cur_Cbtes
loForm.idVentasC = cur_Cbtes.idVentasC
loForm.nrocbte = cur_Cbtes.nrodoc

loForm.leer_datos()

loForm.show()

ENDPROC


************************************************************
OBJETO: clsform_consbjacbte_sf
************************************************************
*** PROPIEDADES ***
Arial, 0, 9, 5, 15, 12, 32, 3, 0
Arial, 1, 8, 5, 14, 11, 29, 3, 0

*** METODOS ***


************************************************************
OBJETO: clsform_imagencbte_sf
************************************************************
*** PROPIEDADES ***
DataSession = 1
BorderStyle = 2
Height = 400
Width = 851
DoCreate = .T.
Comment = ""
Caption = "Consulta de Imagen del Comprobante"
idventascab = 0
tienedetalle = .F.
Name = "clsform_imagencbte_sf"
CONTENIDO.Top = -1
CONTENIDO.Left = -1
CONTENIDO.Width = 853
CONTENIDO.Height = 401
CONTENIDO.Name = "CONTENIDO"

*** METODOS ***
PROCEDURE calc_digito_verificador
&& El prefijo E1, E2, En... indica a la etapa del algoritmo que pertenece el coeficiente

PARAMETERS tcCodigo

LOCAL lnDigito
LOCAL lnSumaE1
LOCAL lnSumaE3
LOCAL lnProductoE2
LOCAL lnSumaE4
LOCAL lnMin
LOCAL lnPos

lnDigito = 0
lnSumaE1 = 0
lnSumaE3 = 0
lnSumaE4 = 0
lnMin = 0

FOR i = 1 TO LEN(ALLTRIM(tcCodigo))
	lnDigito = INT(VAL(SUBSTR(tcCodigo, i, 1)))
	
	IF MOD(i, 2) <> 0 THEN
		&& Etapa 1 (posiciones impares)
		lnSumaE1 = lnSumaE1 + lnDigito
	ELSE
		&& Etapa 3 (posiciones pares)
		lnSumaE3 = lnSumaE3 + lnDigito
	ENDIF
NEXT i

lnProductoE2 = lnSumaE1 * 3 && Etapa 2
lnSumaE4 = lnProductoE2 + lnSumaE3 && Etapa 4

&& Etapa 5
lnPos = 0
FOR i = 1 TO LEN(ALLTRIM(tcCodigo))
	lnDigito = INT(VAL(SUBSTR(tcCodigo, i, 1)))
	
	IF MOD(lnSumaE4 + lnDigito, 10) = 0 THEN
		IF lnPos = 0 THEN
			lnMin = lnDigito
		ELSE
			IF lnDigito < lnMin THEN
				lnMin = lnDigito
			ENDIF
		ENDIF
		
		lnPos = lnPos + 1
	ENDIF
NEXT i

RETURN lnMin
ENDPROC
PROCEDURE Init
DODEFAULT()
Thisform.Contenido.txtObserv.Value = cur_Cbtes.Observ
Thisform.Caption = Thisform.Caption + " " + cur_cbtes.NroDoc
ENDPROC
PROCEDURE Load
LOCAL lcSql, loResult, loVentas, cbte
LOCAL llTieneDetalle

lcSql = ""
loResult = CREATEOBJECT("odbc_result")
loVentas = CREATEOBJECT("odbc_result")
cbte = ""
llTieneDetalle = .F.

DODEFAULT()

CREATE CURSOR cur_Detalle (	;
	idDetalle		int			,;
	idArticulo		int 		,;
	codArt			C(20)		,;
	descripcio		C(60)		,;
	cantidad		float(10,2)	,;
	cantNC			float(10,2) ,;
	prVta			float(10,2)	,;
	prArtic			float(10, 2),;
	pDtoVta1		float(10,2)	,;
	pDtoVta2		float(10,2)	,;
	pDtoVta3		float(10,2)	,;
	pDtoVta4		float(10,2)	,;
	iDtoVta1		float(10,2)	,;
	iDtoVta2		float(10,2)	,;
	iDtoVta3		float(10,2)	,;
	iDtoVta4		float(10,2)	,;
	pDtoCli1		float(10,2)	,;
	pDtoCli2		float(10,2)	,;
	pDtoCli3		float(10,2)	,;
	pDtoCli4		float(10,2)	,;
	iDtoCli1		float(10,2)	,;
	iDtoCli2		float(10,2)	,;
	iDtoCli3		float(10,2)	,;
	iDtoCli4		float(10,2)	,;	
	alicIVA			float(10,2)	,;
	impIVA			float(10,2)	,;
	impNeto			float(10,2)	,;	
	totNeto			float(10,2)	,;
	subTotal		float(10, 2))
	
CREATE CURSOR cur_Aux (	;
	idDetalle		int			,;
	idArticulo		int 		,;
	codArt			C(20)		,;
	descripcio		C(60)		,;
	cantidad		float(10,2)	,;
	cantNC			float(10,2) ,;
	prVta			float(10,2)	,;
	prArtic			float(10,2)	,;
	pDtoVta1		float(10,2)	,;
	pDtoVta2		float(10,2)	,;
	pDtoVta3		float(10,2)	,;
	pDtoVta4		float(10,2)	,;
	iDtoVta1		float(10,2)	,;
	iDtoVta2		float(10,2)	,;
	iDtoVta3		float(10,2)	,;
	iDtoVta4		float(10,2)	,;
	pDtoCli1		float(10,2)	,;
	pDtoCli2		float(10,2)	,;
	pDtoCli3		float(10,2)	,;
	pDtoCli4		float(10,2)	,;
	iDtoCli1		float(10,2)	,;
	iDtoCli2		float(10,2)	,;
	iDtoCli3		float(10,2)	,;
	iDtoCli4		float(10,2)	,;	
	alicIVA			float(10,2)	,;
	impIVA			float(10,2)	,;
	impNeto			float(10,2)	,;	
	totNeto			float(10,2)	,;
	subTotal		float(10, 2))
	
CREATE CURSOR vtadcp (	;
	id_vtadcp		int,;
	idVentasC		int,;
	idPlanCta		int,;
	codPlanCta		varchar(20),;
	descPlan		varchar(60),;
	idBanco			int,;
	cheque_nro		varchar(20),;
	impNeto			float(10, 2),;
	ivaPor			float(10, 2),;
	ivaImp			float(10, 2),;
	total			float(10, 2))

lcSql = "CALL ventasdet_getByCab (?idVentasC)"
lcSql = loResult.AddParameter(lcSql, "idVentasC", ALLTRIM(STR(cur_Cbtes.idventasc)), .f., .f.)

loResult.ActiveConnection = goConn.ActiveConnection
loResult.cursor_name = "cur_tempo"
loResult.OpenQuery(lcSql)

lcSql = "CALL ventascab_getById (?idVentasC)"
lcSql = loVentas.AddParameter(lcSql, "idVentasC", ALLTRIM(STR(cur_cbtes.idventasc)), .f., .f.)
loVentas.Cursor_Name = "cur_vta"
loVentas.ActiveConnection = goConn.ActiveConnection
loVentas.OpenQuery(lcSql)
SELECT cur_vta	
cbte = cur_vta.cbte
loVentas.Close_Query()

SELECT cur_tempo
IF RECCOUNT() > 0 THEN
	GO TOP
ENDIF

IF ((ALLTRIM(cbte) == "NC") .OR. (ALLTRIM(cbte) == "FC") .OR. (ALLTRIM(cbte) == "PTO") .OR. (ALLTRIM(cbte) == "COT")) THEN
	SELECT cur_tempo
	DO WHILE !EOF()
		
		SELECT cur_aux
		APPEND BLANK	
		
		REPLACE cur_aux.idDetalle WITH cur_tempo.idVentasc
		REPLACE cur_aux.idArticulo WITH cur_tempo.idArticulo ADDITIVE
		REPLACE cur_aux.codArt WITH cur_tempo.codArt ADDITIVE
		REPLACE cur_aux.descripcio WITH cur_tempo.descripcio ADDITIVE
		REPLACE cur_aux.cantidad WITH cur_tempo.cantidad ADDITIVE
		REPLACE cur_aux.CantNC WITH cur_tempo.cantidad ADDITIVE
		REPLACE cur_aux.prVta WITH cur_tempo.prVenta ADDITIVE
		REPLACE cur_aux.prArtic WITH cur_tempo.prArtic ADDITIVE
		REPLACE cur_aux.pDtoVta1 WITH cur_tempo.pDtoVta1 ADDITIVE
		REPLACE cur_aux.pDtoVta2 WITH cur_tempo.pDtoVta2 ADDITIVE
		REPLACE cur_aux.pDtoVta3 WITH cur_tempo.pDtoVta3 ADDITIVE
		REPLACE cur_aux.pDtoVta4 WITH cur_tempo.pDtoVta4 ADDITIVE
		REPLACE cur_aux.iDtoVta1 WITH cur_tempo.iDtoVta1 ADDITIVE
		REPLACE cur_aux.iDtoVta2 WITH cur_tempo.iDtoVta2 ADDITIVE
		REPLACE cur_aux.iDtoVta3 WITH cur_tempo.iDtoVta3 ADDITIVE
		REPLACE cur_aux.iDtoVta4 WITH cur_tempo.iDtoVta4 ADDITIVE
		REPLACE cur_aux.pDtoCli1 WITH cur_tempo.porDesc1 ADDITIVE
		REPLACE cur_aux.pDtoCli2 WITH cur_tempo.porDesc2 ADDITIVE
		REPLACE cur_aux.pDtoCli3 WITH cur_tempo.porDesc3 ADDITIVE
		REPLACE cur_aux.pDtoCli4 WITH cur_tempo.porDesc4 ADDITIVE
		REPLACE cur_aux.iDtoCli1 WITH cur_tempo.impDesc1 ADDITIVE
		REPLACE cur_aux.iDtoCli2 WITH cur_tempo.impDesc2 ADDITIVE
		REPLACE cur_aux.iDtoCli3 WITH cur_tempo.impDesc3 ADDITIVE
		REPLACE cur_aux.iDtoCli4 WITH cur_tempo.impDesc4 ADDITIVE
		REPLACE cur_aux.alicIVA WITH cur_tempo.alicIVA ADDITIVE
		REPLACE cur_aux.impIVA WITH cur_tempo.impIVA ADDITIVE
		REPLACE cur_aux.impNeto WITH cur_tempo.impNeto ADDITIVE
		REPLACE cur_aux.totNeto WITH cur_tempo.totNeto ADDITIVE
		REPLACE cur_aux.subTotal WITH cur_tempo.subTotal ADDITIVE

		SELECT cur_tempo
		SKIP
	ENDDO
	
	SELECT cur_aux
	IF RECCOUNT() > 0
		GO TOP
	ENDIF
	
	thisform.contenido.grdDetalle.alias_name = "cur_aux"
	thisform.contenido.grdDetalle.RecordSource = "cur_aux"
	thisform.contenido.grdDetalle.list_controlsource = "cantidad,codArt,descripcio,prVta,AlicIVA,impIVA,totNeto,subTotal"
	thisform.contenido.grdDetalle.lista_ancho_cols = "70,100,200,70,70,70,70,70"
	thisform.contenido.grdDetalle.titulos_cabeceras = "Cantidad,Codigo,Descripción,Pr. Venta,Alic. I.V.A,Imp. I.V.A,Total Neto,SubTotal"
	thisform.contenido.grdDetalle.generar_grid()
	thisform.contenido.grdDetalle.Refresh()
ENDIF 

IF ALLTRIM(cbte) == "PED" THEN
	SELECT cur_tempo
	IF RECCOUNT() > 0
		GO TOP
	ENDIF

	SELECT cur_tempo
	DO WHILE !EOF()
		
		SELECT cur_detalle
		APPEND BLANK	
		
		REPLACE cur_detalle.idDetalle WITH cur_tempo.idVentasc
		REPLACE cur_detalle.idArticulo WITH cur_tempo.idArticulo ADDITIVE
		REPLACE cur_detalle.codArt WITH cur_tempo.codArt ADDITIVE
		REPLACE cur_detalle.descripcio WITH cur_tempo.descripcio ADDITIVE
		REPLACE cur_detalle.cantidad WITH cur_tempo.cantidad ADDITIVE
		REPLACE cur_detalle.CantNC WITH cur_tempo.cantidad ADDITIVE
		REPLACE cur_detalle.prVta WITH cur_tempo.prVenta ADDITIVE
		REPLACE cur_detalle.prArtic WITH cur_tempo.prArtic ADDITIVE
		REPLACE cur_detalle.pDtoVta1 WITH cur_tempo.pDtoVta1 ADDITIVE
		REPLACE cur_detalle.pDtoVta2 WITH cur_tempo.pDtoVta2 ADDITIVE
		REPLACE cur_detalle.pDtoVta3 WITH cur_tempo.pDtoVta3 ADDITIVE
		REPLACE cur_detalle.pDtoVta4 WITH cur_tempo.pDtoVta4 ADDITIVE
		REPLACE cur_detalle.iDtoVta1 WITH cur_tempo.iDtoVta1 ADDITIVE
		REPLACE cur_detalle.iDtoVta2 WITH cur_tempo.iDtoVta2 ADDITIVE
		REPLACE cur_detalle.iDtoVta3 WITH cur_tempo.iDtoVta3 ADDITIVE
		REPLACE cur_detalle.iDtoVta4 WITH cur_tempo.iDtoVta4 ADDITIVE
		REPLACE cur_detalle.pDtoCli1 WITH cur_tempo.porDesc1 ADDITIVE
		REPLACE cur_detalle.pDtoCli2 WITH cur_tempo.porDesc2 ADDITIVE
		REPLACE cur_detalle.pDtoCli3 WITH cur_tempo.porDesc3 ADDITIVE
		REPLACE cur_detalle.pDtoCli4 WITH cur_tempo.porDesc4 ADDITIVE
		REPLACE cur_detalle.iDtoCli1 WITH cur_tempo.impDesc1 ADDITIVE
		REPLACE cur_detalle.iDtoCli2 WITH cur_tempo.impDesc2 ADDITIVE
		REPLACE cur_detalle.iDtoCli3 WITH cur_tempo.impDesc3 ADDITIVE
		REPLACE cur_detalle.iDtoCli4 WITH cur_tempo.impDesc4 ADDITIVE
		REPLACE cur_detalle.alicIVA WITH cur_tempo.alicIVA ADDITIVE
		REPLACE cur_detalle.impIVA WITH cur_tempo.impIVA ADDITIVE
		REPLACE cur_detalle.impNeto WITH cur_tempo.impNeto ADDITIVE
		REPLACE cur_detalle.totNeto WITH cur_tempo.totNeto ADDITIVE
		REPLACE cur_detalle.subTotal WITH cur_tempo.subTotal ADDITIVE

		SELECT cur_tempo
		SKIP
	ENDDO

	SELECT cur_Detalle
	IF RECCOUNT() > 0
		GO TOP
	ENDIF

	thisform.contenido.grdDetalle.alias_name = "cur_detalle"
	thisform.contenido.grdDetalle.RecordSource = "cur_detalle"
	thisform.contenido.grdDetalle.list_controlsource = "cantidad,codArt,descripcio,prVta,AlicIVA,impIVA,totNeto,subTotal"
	thisform.contenido.grdDetalle.lista_ancho_cols = "70,100,200,70,70,70,70,70"
	thisform.contenido.grdDetalle.titulos_cabeceras = "Cantidad,Codigo,Descripción,Pr. Venta,Alic. I.V.A,Imp. I.V.A,Total Neto,SubTotal"
	thisform.contenido.grdDetalle.generar_grid()
	thisform.contenido.grdDetalle.Refresh()	
ENDIF

IF RECCOUNT("cur_tempo") > 0 THEN
	llTieneDetalle = .T.
ELSE
	llTieneDetalle = .F.
ENDIF

thisform.tienedetalle = llTieneDetalle

loResult.close_query()

&& Si no tiene detalle en ventasdet, entonces, tiene que tener concepto.
IF !llTieneDetalle THEN
	lcSql = "CALL vtadcp_getByCab ( ?idVentasC )"
	lcSql = loResult.AddParameter(lcSql, "idVentasC", ALLTRIM(STR(cur_cbtes.idventasc)), .f., .f.)	
	loResult.ActiveConnection = goConn.ActiveConnection
	loResult.Cursor_Name = "cur_tempo"

	IF !loResult.OpenQuery(lcSql) THEN
		MESSAGEBOX(loResult.Error_Message, 0+48, Thisform.Caption)
		RETURN .F.
	ENDIF
	
	SELECT cur_tempo
	DO WHILE !EOF("cur_tempo")
		SELECT vtadcp
		APPEND BLANK
		REPLACE vtadcp.id_vtadcp WITH cur_tempo.id_vtadcp
		REPLACE vtadcp.idVentasC WITH cur_tempo.idVentasC ADDITIVE
		REPLACE vtadcp.idPlanCta WITH cur_tempo.idPlanCta ADDITIVE
		REPLACE vtadcp.codPlanCta WITH cur_tempo.codPlanCta ADDITIVE
		REPLACE vtadcp.descPlan WITH cur_tempo.descripcio ADDITIVE
		REPLACE vtadcp.idBanco WITH IIF(ISNULL(cur_tempo.idBanco), 0, cur_tempo.idBanco) ADDITIVE
		REPLACE vtadcp.cheque_nro WITH IIF(ISNULL(cur_tempo.cheque_nro), "", cur_tempo.cheque_nro) ADDITIVE
		REPLACE vtadcp.impNeto WITH cur_tempo.impNeto ADDITIVE
		REPLACE vtadcp.ivaPor WITH cur_tempo.ivaPor ADDITIVE
		REPLACE vtadcp.ivaImp WITH cur_tempo.ivaImp ADDITIVE
		REPLACE vtadcp.total WITH cur_tempo.total ADDITIVE
		
		SELECT cur_tempo
		SKIP
	ENDDO
	
	IF RECCOUNT("cur_tempo") > 0 THEN
		GO TOP
	ENDIF
	
	thisform.contenido.grdDetalle.alias_name = "vtadcp"
	thisform.contenido.grdDetalle.RecordSource = "vtadcp"
	thisform.contenido.grdDetalle.list_controlsource = "codPlanCta,descPlan,impNeto,ivaPor,ivaImp,total"
	thisform.contenido.grdDetalle.lista_ancho_cols = "100,300,70,70,70,70"
	thisform.contenido.grdDetalle.titulos_cabeceras = "Código,Descripción,Pr. Neto, IVA(%), IVA($),Total"
	thisform.contenido.grdDetalle.generar_grid()
	thisform.contenido.grdDetalle.Refresh()		
ENDIF
ENDPROC


************************************************************
OBJETO: grdDetalle
************************************************************
*** PROPIEDADES ***
Height = 289
Left = 5
TabIndex = 1
Top = 3
Width = 844
alias_name = cur_Detalle
list_controlsource = cantidad,codArt,descripcio,prVta,AlicIVA,impIVA,totNeto,subTotal
lista_ancho_cols = 70,100,200,70,70,70,70,70
permitir_busqueda = .F.
permitir_ordenamiento = .F.
titulos_cabeceras = Cantidad,Codigo,Descripción,Pr. Venta,Alic. I.V.A,Imp. I.V.A,Total Neto,SubTotal
Name = "grdDetalle"
COLUMN1.HEADER1.Name = "HEADER1"
COLUMN1.TEXT1.Name = "TEXT1"
COLUMN1.Name = "COLUMN1"
COLUMN2.HEADER1.Name = "HEADER1"
COLUMN2.TEXT1.Name = "TEXT1"
COLUMN2.Name = "COLUMN2"
COLUMN3.HEADER1.Name = "HEADER1"
COLUMN3.TEXT1.Name = "TEXT1"
COLUMN3.Name = "COLUMN3"
COLUMN4.HEADER1.Name = "HEADER1"
COLUMN4.TEXT1.Name = "TEXT1"
COLUMN4.Name = "COLUMN4"
COLUMN5.HEADER1.Name = "HEADER1"
COLUMN5.TEXT1.Name = "TEXT1"
COLUMN5.Name = "COLUMN5"
COLUMN6.HEADER1.Name = "HEADER1"
COLUMN6.TEXT1.Name = "TEXT1"
COLUMN6.Name = "COLUMN6"
COLUMN7.HEADER1.Name = "HEADER1"
COLUMN7.TEXT1.Name = "TEXT1"
COLUMN7.Name = "COLUMN7"
COLUMN8.HEADER1.Name = "HEADER1"
COLUMN8.TEXT1.Name = "TEXT1"
COLUMN8.Name = "COLUMN8"
COLUMN9.HEADER1.Name = "HEADER1"
COLUMN9.TEXT1.Name = "TEXT1"
COLUMN9.Name = "COLUMN9"
COLUMN10.HEADER1.Name = "HEADER1"
COLUMN10.TEXT1.Name = "TEXT1"
COLUMN10.Name = "COLUMN10"
COLUMN11.HEADER1.Name = "HEADER1"
COLUMN11.TEXT1.Name = "TEXT1"
COLUMN11.Name = "COLUMN11"
COLUMN12.HEADER1.Name = "HEADER1"
COLUMN12.TEXT1.Name = "TEXT1"
COLUMN12.Name = "COLUMN12"
COLUMN13.HEADER1.Name = "HEADER1"
COLUMN13.TEXT1.Name = "TEXT1"
COLUMN13.Name = "COLUMN13"
COLUMN14.HEADER1.Name = "HEADER1"
COLUMN14.TEXT1.Name = "TEXT1"
COLUMN14.Name = "COLUMN14"
COLUMN15.HEADER1.Name = "HEADER1"
COLUMN15.TEXT1.Name = "TEXT1"
COLUMN15.Name = "COLUMN15"
COLUMN16.HEADER1.Name = "HEADER1"
COLUMN16.TEXT1.Name = "TEXT1"
COLUMN16.Name = "COLUMN16"
COLUMN17.HEADER1.Name = "HEADER1"
COLUMN17.TEXT1.Name = "TEXT1"
COLUMN17.Name = "COLUMN17"
COLUMN18.HEADER1.Name = "HEADER1"
COLUMN18.TEXT1.Name = "TEXT1"
COLUMN18.Name = "COLUMN18"
COLUMN19.HEADER1.Name = "HEADER1"
COLUMN19.TEXT1.Name = "TEXT1"
COLUMN19.Name = "COLUMN19"
COLUMN20.HEADER1.Name = "HEADER1"
COLUMN20.TEXT1.Name = "TEXT1"
COLUMN20.Name = "COLUMN20"

*** METODOS ***


************************************************************
OBJETO: CLSCERRAR1
************************************************************
*** PROPIEDADES ***
Top = 349
Left = 804
Height = 44
Width = 45
TabIndex = 4
Name = "CLSCERRAR1"

*** METODOS ***


************************************************************
OBJETO: txtObserv
************************************************************
*** PROPIEDADES ***
Height = 48
Left = 6
ReadOnly = .T.
TabIndex = 2
Top = 295
Width = 843
Name = "txtObserv"

*** METODOS ***


************************************************************
OBJETO: btnImprimir
************************************************************
*** PROPIEDADES ***
Top = 349
Left = 756
TabIndex = 3
Name = "btnImprimir"

*** METODOS ***
PROCEDURE Click
LOCAL m.NroCli, m.RazSoc, m.Telefono,  m.direccion, m.localidad, m.codPostal, m.pcia, m.tipoIVA, m.nroCuit
LOCAL m.Total, m.tipoDoc, m.NroCbte, m.Fecha, m.leyenda, m.fecVto, m.tipoDoc, m.ptoVta
LOCAL m.porDesc1, m.porDesc2, m.porDesc3, m.porDesc4, m.porRec
LOCAL m.impDesc1, m.impDesc2, m.impDesc3, m.impDesc4
LOCAL m.porIIBB, m.impIIBB, m.observ, m.vendedor
LOCAL m.porIVA105, m.impIVA105, m.porIVA21, m.impIVA21, m.impNeto, m.impFinal
LOCAL lcSql, loCV, loCD, lcPrinterName
LOCAL lo_rsSitIVA, lo_rsCondPago, lo_rsLocalidad, lo_rsPcia
LOCAL m.cae, m.caevto, m.condPago
LOCAL m.codigoCbte, m.barcode, m.code
LOCAL lcDia, lcMes, lcAnio, m.nroOC

loCV = CREATEOBJECT("odbc_result")
lo_rsSitIVA = CREATEOBJECT("odbc_result")
lo_rsCondPago = CREATEOBJECT("odbc_result")
lo_rsLocalidad = CREATEOBJECT("odbc_result")
lo_rsPcia = CREATEOBJECT("odbc_result")
lo_rsCliente = CREATEOBJECT("odbc_result")

lcSql = ""
m.NroCli = ""
m.RazSoc = ""
m.Telefono = ""
m.direccion = ""
m.localidad = ""
m.codPostal = ""
m.pcia = ""
m.nroCuit = ""
m.tipoIVA = ""
m.Total = 0.00
m.tipoDoc = ""
m.NroCbte = ""
m.leyenda = ""
m.Fecha = cur_cbtes.fecemis
m.porIVA105 = 0.00
m.porIVA21 = 0.00
m.impIVA105 = 0.00
m.impIVA21 = 0.00
m.impNeto = 0.00
m.impFinal = 0.00
m.fecVto =  {}
m.tipoDoc = ""
m.ptoVta = ""
m.porIIBB = 0.00
m.impIIBB = 0.00
lnCantCpia = 0
m.observ = ""
m.vendedor = ""
m.barcode = ""
m.code = ""
m.nroOC = ""

lcDia = ""
lcMes = ""
lcAnio = ""

***********************************************************************************
&& Busco la cabecera de venta, cliente, localidad, provincia, cond pago, sir iva

lcSql = "CALL ventascab_getById (?idVentasC)"
lcSql = loCV.AddParameter(lcSql, "idVentasC", ALLTRIM(STR(cur_cbtes.idventasc)), .f., .f.)
loCV.Cursor_Name = "cur_venta"
loCV.ActiveConnection = goConn.ActiveConnection
loCV.OpenQuery(lcSql)

m.cae = cur_venta.aut_CAE
m.caevto = DTOC(cur_venta.aut_CAE_vto)
m.codigoCbte = ALLTRIM(cur_venta.aut_tipoCbte)
m.nroOC = ALLTRIM(STR(cur_venta.nroOC))

lcDia = REPLICATE("0", 2 - LEN(ALLTRIM(STR(DAY(cur_venta.aut_CAE_vto))))) + ALLTRIM(STR(DAY(cur_venta.aut_CAE_vto)))
lcMes = REPLICATE("0", 2 - LEN(ALLTRIM(STR(MONTH(cur_venta.aut_CAE_vto))))) + ALLTRIM(STR(MONTH(cur_venta.aut_CAE_vto)))
lcAnio = ALLTRIM(STR(YEAR(cur_venta.aut_CAE_vto)))

lcSql = "CALL clientes_getById (?idCliente)"
lcSql = lo_rsCliente.AddParameter(lcSql, "idCliente", ALLTRIM(STR(cur_venta.idCliente)), .f., .f.)
lo_rsCliente.ActiveConnection = goConn.ActiveConnection
lo_rsCliente.Cursor_Name = "cur_Cliente"
lo_rsCliente.OpenQuery(lcSql)

SELECT cur_Cliente
m.NroCli = cur_Cliente.idcliente
m.RazSoc = cur_venta.razsoc
m.Telefono = cur_Cliente.telefono
m.direccion = cur_Cliente.direccion
m.nroCuit = cur_venta.nrodoc

* lcSql = "SELECT * FROM localidad WHERE idLocalid = " + ALLTRIM(STR(cur_Cliente.idLocalid))
lcSql = "CALL localidad_getById ( ?idVentasC)"
lcSql = lo_rsLocalidad.AddParameter(lcSql, "idVentasC", ALLTRIM(STR(cur_Cliente.idLocalid)), .f., .f.)
lo_rsLocalidad.ActiveConnection = goConn.ActiveConnection
lo_rsLocalidad.Cursor_Name = "cur_Localid"
lo_rsLocalidad.OpenQuery(lcSql)

SELECT cur_Localid
m.localidad = cur_Localid.descripcio
m.codpostal = ALLTRIM(cur_Localid.codPostal)

*lcSql = "SELECT * FROM provincias WHERE idProvin = " + ALLTRIM(STR(cur_Localid.idProvin))
lcSql = "CALL provincias_getById (?id)"
lcSql = lo_rsPcia.AddParameter(lcSql, "id", ALLTRIM(STR(cur_Localid.idProvin)), .f., .f.)
lo_rsPcia.ActiveConnection = goConn.ActiveConnection
lo_rsPcia.Cursor_Name = "cur_Pcia"
lo_rsPcia.OpenQuery(lcSql)

SELECT cur_Pcia
m.pcia = cur_Pcia.descripcio

lo_rsPcia.close_query()
lo_rsLocalidad.close_query()
lo_rsCliente.close_query()

*lcSql = "SELECT * FROM sitiva WHERE idSitIVA = " + ALLTRIM(STR(cur_venta.idSitIVA))
lcSql = "CALL sitiva_getById (?id)"
lcSql = lo_rsSitIVA.AddParameter(lcSql, "id", ALLTRIM(STR(cur_venta.idSitIVA)), .f., .f.)
lo_rsSitIVA.ActiveConnection = goConn.ActiveConnection
lo_rsSitIVA.Cursor_Name = "cur_SitIVA"
lo_rsSitIVA.OpenQuery(lcSql)

SELECT cur_SitIVA
m.tipoIVA = cur_SitIVA.descripcio

lo_rsSitIVA.close_query()

*!*	lcSql = "SELECT * FROM condpagos WHERE idCondPago = " + ALLTRIM(STR(cur_venta.idCondPago))
*!*	lo_rsCondPago.ActiveConnection = goConn.ActiveConnection
*!*	lo_rsCondPago.Cursor_Name = "cur_CondPago"
*!*	lo_rsCondPago.OpenQuery(lcSql)

*!*	SELECT cur_CondPago
*!*	m.fecVto = TTOD(cur_venta.fecEmision) + cur_CondPago.cntDias

*!*	lo_rsCondPago.close_query()
***********************************************************************************
m.fecVto = TTOD(cur_venta.fecVto)

IF ALLTRIM(cur_venta.cbte) == "COT"
	m.leyenda = "COTIZACION"
	m.Total = cur_venta.totfact
ELSE 
	IF (ALLTRIM(cur_venta.cbte) == "PTO") .OR. (ALLTRIM(cur_venta.cbte) == "FC" .AND. ALLTRIM(cur_venta.tipodoc)  == "X") THEN  
		m.leyenda = "PRESUPUESTO"
		m.Total = cur_venta.totfact
	ELSE
		IF ALLTRIM(cur_venta.cbte) == "PED"
			m.leyenda = "NOTA DE PEDIDO"
			m.tipoDoc = "P"
			m.Total = cur_venta.totfact
		ELSE
			IF ALLTRIM(cur_venta.Cbte) == "FC"
				m.leyenda = "FACTURA"
				m.Total = cur_venta.totfact
				&& Aca tengo que agregar el calculo de la letra
			ELSE
				IF ALLTRIM(cur_venta.Cbte) == "NC"
					m.Leyenda = "NOTA DE CREDITO"
					m.Total = cur_venta.totfact
					&& Aca tengo que agregar el calculo de la letra
				ELSE
					IF ALLTRIM(cur_venta.Cbte) == "ND"
						m.leyenda = "NOTA DE DEBITO"
						m.Total = cur_venta.totfact
						&& Aca tengo que agregar el calculo de la letra
					ENDIF
				ENDIF
			ENDIF
		ENDIF
	ENDIF
ENDIF 

SELECT cur_venta

m.tipoDoc = cur_venta.tipodoc
m.ptoVta = REPLICATE("0", 4 - LEN(ALLTRIM(STR(cur_venta.ptovta)))) + ALLTRIM(STR(cur_venta.ptovta))
m.NroCbte = m.ptoVta + "-" + REPLICATE("0", 8 - LEN(ALLTRIM(STR(cur_venta.numcbte)))) + ALLTRIM(STR(cur_venta.numcbte))
m.porDesc1 = cur_venta.porDesc1
m.porDesc2 = cur_venta.porDesc2
m.porDesc3 = cur_venta.porDesc3
m.porDesc4 = cur_venta.porDesc4
m.impDesc1 = cur_venta.impDesc1
m.impDesc2 = cur_venta.impDesc2
m.impDesc3 = cur_venta.impDesc3
m.impDesc4 = cur_venta.impDesc4
m.porRec = cur_venta.porRec
m.porIVA105 = cur_venta.porIVA105
m.porIVA21 = cur_venta.porIVA21
m.impIVA105 = cur_venta.impIVA105
m.impIVA21 = cur_venta.impIVA21
m.impNeto = cur_venta.impFinal
m.impFinal = cur_venta.impFinal
m.porIIBB = cur_venta.porIIBB
m.impIIBB = cur_venta.impIIBB
m.vendedor = cur_venta.usuAlta
m.condPago = IIF(cur_venta.idCondPago = 1, "CONTADO", "CUENTAS CORRIENTES")
m.observ = Thisform.Contenido.txtObserv.Value + " "

IF thisform.tienedetalle THEN
	IF ALLTRIM(cur_venta.cbte) == "COT" THEN
		&& Imprime una cotizacion
		SELECT cur_aux	
		REPORT FORM "repcot.frx" TO PRINTER PROMPT PREVIEW 
	ELSE 
		IF (ALLTRIM(cur_venta.cbte) == "PTO") .OR. (ALLTRIM(cur_venta.cbte) == "FC" .AND. ALLTRIM(cur_venta.tipodoc)  == "X") .OR. (ALLTRIM(cur_venta.cbte) == "NC" .AND. ALLTRIM(cur_venta.tipodoc)  == "X") THEN  
			&& Imprime un presupuesto
			SELECT cur_aux
			REPORT FORM "reppto.frx" TO PRINTER PROMPT PREVIEW 
		ELSE
			&& Si el comprobante es "PED" entonces, tiene que enviar a imprimir una nota de pedido
			IF ALLTRIM(cur_venta.cbte) == "PED" THEN
				m.observ = Thisform.contenido.txtObserv.Value
				SELECT cur_detalle
				REPORT FORM "reppedido.frx" TO PRINTER PROMPT PREVIEW 
			ELSE 
				IF ALLTRIM(cur_venta.tipodoc) == "A" THEN
					&& Regenero el código de barras
					m.barcode = ALLTRIM(m.nroCuit)
					m.barcode = m.barcode + ALLTRIM(m.codigoCbte)
					m.barcode = m.barcode + ALLTRIM(m.ptoVta)
					m.barcode = m.barcode + ALLTRIM(m.cae)
					m.barcode = m.barcode + ALLTRIM(lcAnio)
					m.barcode = m.barcode + ALLTRIM(lcMes)
					m.barcode = m.barcode + ALLTRIM(lcDia)
					m.barcode = m.barcode + ALLTRIM(STR(Thisform.calc_digito_verificador(m.barcode)))
					m.code = m.barcode
					m.barcode = getcodbarras(m.barcode)					
					
					&& Imprime el comprobante de tipo "A"
					SELECT cur_aux
					REPORT FORM "repcbtesvta.frx" TO PRINTER PROMPT PREVIEW
				ELSE
					&& Regenero el código de barras
					m.barcode = ALLTRIM(m.nroCuit)
					m.barcode = m.barcode + ALLTRIM(m.codigoCbte)
					m.barcode = m.barcode + ALLTRIM(m.ptoVta)
					m.barcode = m.barcode + ALLTRIM(m.cae)
					m.barcode = m.barcode + ALLTRIM(lcAnio)
					m.barcode = m.barcode + ALLTRIM(lcMes)
					m.barcode = m.barcode + ALLTRIM(lcDia)
					m.barcode = m.barcode + ALLTRIM(STR(Thisform.calc_digito_verificador(m.barcode)))
					m.code = m.barcode
					m.barcode = getcodbarras(m.barcode)					
									
					&& Imprime el comprobante de tipo "B"
					SELECT cur_aux	
					REPORT FORM "repcbtesvta_b.frx" TO PRINTER PROMPT PREVIEW 
				ENDIF
			ENDIF
		ENDIF
	ENDIF 
ELSE
	IF INT(VAL(gnDEMO)) = 1 THEN
			SELECT vtadcp
			REPORT FORM 'repncnd_x' TO PRINTER PROMPT PREVIEW		
	ELSE
		IF ALLTRIM(cur_venta.tipodoc) == "A" THEN
			&& Regenero el código de barras
			m.barcode = ALLTRIM(m.nroCuit)
			m.barcode = m.barcode + ALLTRIM(m.codigoCbte)
			m.barcode = m.barcode + ALLTRIM(m.ptoVta)
			m.barcode = m.barcode + ALLTRIM(m.cae)
			m.barcode = m.barcode + ALLTRIM(lcAnio)
			m.barcode = m.barcode + ALLTRIM(lcMes)
			m.barcode = m.barcode + ALLTRIM(lcDia)
			m.barcode = m.barcode + ALLTRIM(STR(Thisform.calc_digito_verificador(m.barcode)))
			m.code = m.barcode
			m.barcode = getcodbarras(m.barcode)			
		
			SELECT vtadcp
			REPORT FORM 'repncnd' TO PRINTER PROMPT PREVIEW
		ELSE
			&& Regenero el código de barras
			m.barcode = ALLTRIM(m.nroCuit)
			m.barcode = m.barcode + ALLTRIM(m.codigoCbte)
			m.barcode = m.barcode + ALLTRIM(m.ptoVta)
			m.barcode = m.barcode + ALLTRIM(m.cae)
			m.barcode = m.barcode + ALLTRIM(lcAnio)
			m.barcode = m.barcode + ALLTRIM(lcMes)
			m.barcode = m.barcode + ALLTRIM(lcDia)
			m.barcode = m.barcode + ALLTRIM(STR(Thisform.calc_digito_verificador(m.barcode)))
			m.code = m.barcode
			m.barcode = getcodbarras(m.barcode)

			SELECT vtadcp
			REPORT FORM 'repncnd_b' TO PRINTER PROMPT PREVIEW
		ENDIF
	ENDIF
ENDIF

loCV.close_query()

ENDPROC


************************************************************
OBJETO: clsform_imagencbte_sf
************************************************************
*** PROPIEDADES ***
Arial, 0, 9, 5, 15, 12, 32, 3, 0
Arial, 1, 8, 5, 14, 11, 29, 3, 0

*** METODOS ***


************************************************************
OBJETO: clsformcbtes_fe
************************************************************
*** PROPIEDADES ***
DoCreate = .T.
aut_cae = 
aut_cae_vto = 
aut_resultado = 
aut_motivo = 
aut_numero = 
codigo_cbte = 0
error_message = 
id_ventasc = 0
nrocbte = 
cbte = FC
mailfc = 
Name = "clsformcbtes_fe"
contenido.Clsetiqueta1.TabIndex = 40
contenido.Clsetiqueta1.Name = "Clsetiqueta1"
contenido.sel_Cliente.txtCodigo.Name = "txtCodigo"
contenido.sel_Cliente.txtDescripcion.Name = "txtDescripcion"
contenido.sel_Cliente.TabIndex = 1
contenido.sel_Cliente.Name = "sel_Cliente"
contenido.Clsetiqueta2.TabIndex = 42
contenido.Clsetiqueta2.Name = "Clsetiqueta2"
contenido.Clsetiqueta3.TabIndex = 43
contenido.Clsetiqueta3.Name = "Clsetiqueta3"
contenido.txtSitIVA.TabIndex = 31
contenido.txtSitIVA.Name = "txtSitIVA"
contenido.sel_FormaPago.txtCodigo.Name = "txtCodigo"
contenido.sel_FormaPago.txtDescripcion.Name = "txtDescripcion"
contenido.sel_FormaPago.TabIndex = 3
contenido.sel_FormaPago.Name = "sel_FormaPago"
contenido.Clslinea1.Name = "Clslinea1"
contenido.Clsetiqueta4.TabIndex = 44
contenido.Clsetiqueta4.Name = "Clsetiqueta4"
contenido.sel_Articulo.txtCodigo.Name = "txtCodigo"
contenido.sel_Articulo.txtDescripcion.Name = "txtDescripcion"
contenido.sel_Articulo.TabIndex = 6
contenido.sel_Articulo.Name = "sel_Articulo"
contenido.Clsetiqueta5.TabIndex = 46
contenido.Clsetiqueta5.Name = "Clsetiqueta5"
contenido.txtCantidad.TabIndex = 8
contenido.txtCantidad.Name = "txtCantidad"
contenido.btnAgregar.TabIndex = 9
contenido.btnAgregar.Name = "btnAgregar"
contenido.grdDetalles.COLUMN1.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN1.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN1.Name = "COLUMN1"
contenido.grdDetalles.COLUMN2.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN2.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN2.Name = "COLUMN2"
contenido.grdDetalles.COLUMN3.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN3.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN3.Name = "COLUMN3"
contenido.grdDetalles.COLUMN4.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN4.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN4.Name = "COLUMN4"
contenido.grdDetalles.COLUMN5.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN5.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN5.Name = "COLUMN5"
contenido.grdDetalles.COLUMN6.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN6.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN6.Name = "COLUMN6"
contenido.grdDetalles.COLUMN7.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN7.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN7.Name = "COLUMN7"
contenido.grdDetalles.COLUMN8.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN8.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN8.Name = "COLUMN8"
contenido.grdDetalles.COLUMN9.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN9.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN9.Name = "COLUMN9"
contenido.grdDetalles.COLUMN10.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN10.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN10.Name = "COLUMN10"
contenido.grdDetalles.COLUMN11.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN11.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN11.Name = "COLUMN11"
contenido.grdDetalles.COLUMN12.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN12.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN12.Name = "COLUMN12"
contenido.grdDetalles.COLUMN13.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN13.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN13.Name = "COLUMN13"
contenido.grdDetalles.COLUMN14.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN14.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN14.Name = "COLUMN14"
contenido.grdDetalles.COLUMN15.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN15.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN15.Name = "COLUMN15"
contenido.grdDetalles.COLUMN16.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN16.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN16.Name = "COLUMN16"
contenido.grdDetalles.COLUMN17.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN17.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN17.Name = "COLUMN17"
contenido.grdDetalles.COLUMN18.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN18.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN18.Name = "COLUMN18"
contenido.grdDetalles.COLUMN19.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN19.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN19.Name = "COLUMN19"
contenido.grdDetalles.COLUMN20.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN20.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN20.Name = "COLUMN20"
contenido.grdDetalles.TabIndex = 47
contenido.grdDetalles.Name = "grdDetalles"
contenido.btnGrabar.TabIndex = 11
contenido.btnGrabar.Name = "btnGrabar"
contenido.btnCancelar.TabIndex = 13
contenido.btnCancelar.Name = "btnCancelar"
contenido.Clscerrar1.TabIndex = 12
contenido.Clscerrar1.Name = "Clscerrar1"
contenido.Clsetiqueta10.TabIndex = 70
contenido.Clsetiqueta10.Name = "Clsetiqueta10"
contenido.txtPrMay.TabIndex = 29
contenido.txtPrMay.Name = "txtPrMay"
contenido.Clsetiqueta11.TabIndex = 72
contenido.Clsetiqueta11.Name = "Clsetiqueta11"
contenido.txtPrMinorista.TabIndex = 28
contenido.txtPrMinorista.Name = "txtPrMinorista"
contenido.Clsetiqueta12.TabIndex = 78
contenido.Clsetiqueta12.Name = "Clsetiqueta12"
contenido.txtAlicIVA.TabIndex = 79
contenido.txtAlicIVA.Name = "txtAlicIVA"
contenido.chkCalcIVA.Alignment = 0
contenido.chkCalcIVA.TabIndex = 33
contenido.chkCalcIVA.Name = "chkCalcIVA"
contenido.btnEliminar.TabIndex = 10
contenido.btnEliminar.Name = "btnEliminar"
contenido.chkImprimeDup.Alignment = 0
contenido.chkImprimeDup.TabIndex = 86
contenido.chkImprimeDup.Name = "chkImprimeDup"
contenido.btnCbteOrigen.TabIndex = 30
contenido.btnCbteOrigen.Name = "btnCbteOrigen"
contenido.txtObserv.TabIndex = 27
contenido.txtObserv.Name = "txtObserv"
contenido.Clsetiqueta6.TabIndex = 49
contenido.Clsetiqueta6.Name = "Clsetiqueta6"
contenido.Clsetiqueta7.TabIndex = 53
contenido.Clsetiqueta7.Name = "Clsetiqueta7"
contenido.Clsetiqueta8.TabIndex = 55
contenido.Clsetiqueta8.Name = "Clsetiqueta8"
contenido.Clsetiqueta9.TabIndex = 56
contenido.Clsetiqueta9.Name = "Clsetiqueta9"
contenido.txtTotNeto.TabIndex = 58
contenido.txtTotNeto.Name = "txtTotNeto"
contenido.txtPorIVA21.TabIndex = 61
contenido.txtPorIVA21.Name = "txtPorIVA21"
contenido.txtPorIVA105.TabIndex = 62
contenido.txtPorIVA105.Name = "txtPorIVA105"
contenido.txtImpIVA21.TabIndex = 64
contenido.txtImpIVA21.Name = "txtImpIVA21"
contenido.txtImpIVA105.TabIndex = 65
contenido.txtImpIVA105.Name = "txtImpIVA105"
contenido.txtTotal.TabIndex = 66
contenido.txtTotal.Name = "txtTotal"
contenido.Clsetiqueta14.TabIndex = 81
contenido.Clsetiqueta14.Name = "Clsetiqueta14"
contenido.txtDesc1.ReadOnly = .F.
contenido.txtDesc1.TabIndex = 15
contenido.txtDesc1.Name = "txtDesc1"
contenido.txtDesc2.ReadOnly = .F.
contenido.txtDesc2.TabIndex = 17
contenido.txtDesc2.Name = "txtDesc2"
contenido.txtDesc3.ReadOnly = .F.
contenido.txtDesc3.TabIndex = 18
contenido.txtDesc3.Name = "txtDesc3"
contenido.txtDesc4.ReadOnly = .F.
contenido.txtDesc4.TabIndex = 19
contenido.txtDesc4.Name = "txtDesc4"
contenido.txtImpDesc1.TabIndex = 35
contenido.txtImpDesc1.Visible = .F.
contenido.txtImpDesc1.Name = "txtImpDesc1"
contenido.txtImpDesc2.TabIndex = 36
contenido.txtImpDesc2.Visible = .F.
contenido.txtImpDesc2.Name = "txtImpDesc2"
contenido.txtImpDesc3.TabIndex = 37
contenido.txtImpDesc3.Visible = .F.
contenido.txtImpDesc3.Name = "txtImpDesc3"
contenido.txtImpDesc4.TabIndex = 38
contenido.txtImpDesc4.Visible = .F.
contenido.txtImpDesc4.Name = "txtImpDesc4"
contenido.Clsetiqueta15.TabIndex = 80
contenido.Clsetiqueta15.Name = "Clsetiqueta15"
contenido.Clsetiqueta16.TabIndex = 83
contenido.Clsetiqueta16.Name = "Clsetiqueta16"
contenido.Clsetiqueta17.TabIndex = 57
contenido.Clsetiqueta17.Name = "Clsetiqueta17"
contenido.txtTotFact.TabIndex = 67
contenido.txtTotFact.Name = "txtTotFact"
contenido.Clsetiqueta18.TabIndex = 54
contenido.Clsetiqueta18.Name = "Clsetiqueta18"
contenido.txtPorIIBB.TabIndex = 60
contenido.txtPorIIBB.Name = "txtPorIIBB"
contenido.txtImpIIBB.TabIndex = 63
contenido.txtImpIIBB.Name = "txtImpIIBB"
contenido.Clsetiqueta19.TabIndex = 82
contenido.Clsetiqueta19.Name = "Clsetiqueta19"
contenido.txtST.TabIndex = 59
contenido.txtST.Name = "txtST"
contenido.Clsetiqueta20.TabIndex = 69
contenido.Clsetiqueta20.Name = "Clsetiqueta20"
contenido.txtPorDesc1.ReadOnly = .F.
contenido.txtPorDesc1.TabIndex = 23
contenido.txtPorDesc1.Name = "txtPorDesc1"
contenido.txtImpDescItem1.TabIndex = 87
contenido.txtImpDescItem1.Name = "txtImpDescItem1"
contenido.txtPorDesc2.ReadOnly = .F.
contenido.txtPorDesc2.TabIndex = 24
contenido.txtPorDesc2.Name = "txtPorDesc2"
contenido.txtImpDescItem2.TabIndex = 88
contenido.txtImpDescItem2.Name = "txtImpDescItem2"
contenido.txtPorDesc3.ReadOnly = .F.
contenido.txtPorDesc3.TabIndex = 25
contenido.txtPorDesc3.Name = "txtPorDesc3"
contenido.txtImpDescItem3.TabIndex = 89
contenido.txtImpDescItem3.Name = "txtImpDescItem3"
contenido.txtPorDesc4.ReadOnly = .F.
contenido.txtPorDesc4.TabIndex = 26
contenido.txtPorDesc4.Name = "txtPorDesc4"
contenido.txtImpDescItem4.TabIndex = 90
contenido.txtImpDescItem4.Name = "txtImpDescItem4"
contenido.Clsetiqueta21.TabIndex = 77
contenido.Clsetiqueta21.Name = "Clsetiqueta21"
contenido.txtImpIVA.TabIndex = 91
contenido.txtImpIVA.Name = "txtImpIVA"
contenido.Clsetiqueta22.TabIndex = 73
contenido.Clsetiqueta22.Name = "Clsetiqueta22"
contenido.txtSTNeto.TabIndex = 75
contenido.txtSTNeto.Name = "txtSTNeto"
contenido.Clsetiqueta13.TabIndex = 84
contenido.Clsetiqueta13.Name = "Clsetiqueta13"
contenido.txtSubTotal.TabIndex = 85
contenido.txtSubTotal.Name = "txtSubTotal"
contenido.Clsetiqueta23.TabIndex = 71
contenido.Clsetiqueta23.Name = "Clsetiqueta23"
contenido.txtPrNeto.TabIndex = 74
contenido.txtPrNeto.Name = "txtPrNeto"
contenido.lblExistencia.TabIndex = 76
contenido.lblExistencia.Name = "lblExistencia"
contenido.txtExistencia.TabIndex = 92
contenido.txtExistencia.Name = "txtExistencia"
contenido.Clsetiqueta24.TabIndex = 51
contenido.Clsetiqueta24.Name = "Clsetiqueta24"
contenido.txtPorRec.TabIndex = 14
contenido.txtPorRec.Name = "txtPorRec"
contenido.txtImpRec.TabIndex = 93
contenido.txtImpRec.Name = "txtImpRec"
contenido.txtRecItem.TabIndex = 39
contenido.txtRecItem.Visible = .F.
contenido.txtRecItem.Name = "txtRecItem"
contenido.Clsetiqueta25.TabIndex = 41
contenido.Clsetiqueta25.Name = "Clsetiqueta25"
contenido.txtTelefono.TabIndex = 32
contenido.txtTelefono.Name = "txtTelefono"
contenido.Clsetiqueta26.TabIndex = 21
contenido.Clsetiqueta26.Name = "Clsetiqueta26"
contenido.txtcuit.TabIndex = 2
contenido.txtcuit.Name = "txtcuit"
contenido.Clsetiqueta27.TabIndex = 45
contenido.Clsetiqueta27.Name = "Clsetiqueta27"
contenido.cboUnidVta.TabIndex = 7
contenido.cboUnidVta.Name = "cboUnidVta"
contenido.txtCantPack.TabIndex = 22
contenido.txtCantPack.Name = "txtCantPack"
contenido.Clsetiqueta28.TabIndex = 50
contenido.Clsetiqueta28.Name = "Clsetiqueta28"
contenido.txtOC.TabIndex = 34
contenido.txtOC.Name = "txtOC"
contenido.Clsetiqueta29.TabIndex = 68
contenido.Clsetiqueta29.Name = "Clsetiqueta29"
contenido.txtPorRecItem.TabIndex = 20
contenido.txtPorRecItem.Name = "txtPorRecItem"
contenido.Clsetiqueta30.TabIndex = 48
contenido.Clsetiqueta30.Name = "Clsetiqueta30"
contenido.TXTFECEMIS.TabIndex = 4
contenido.TXTFECEMIS.Name = "TXTFECEMIS"
contenido.Clsetiqueta31.TabIndex = 52
contenido.Clsetiqueta31.Name = "Clsetiqueta31"
contenido.txtMailFC.TabIndex = 5
contenido.txtMailFC.Name = "txtMailFC"
contenido.chkEnviarMail.Alignment = 0
contenido.chkEnviarMail.TabIndex = 16
contenido.chkEnviarMail.Name = "chkEnviarMail"
contenido.TabIndex = 1
contenido.Name = "contenido"
mov_stock.Name = "mov_stock"
faltantes.Name = "faltantes"

*** METODOS ***
PROCEDURE enviar_wsafipfe
LOCAL llRes
LOCAL lnPtoVta
LOCAL lnTipoDoc, lcTipoDoc
LOCAL lnRetAlva
LOCAL lnCantIVA
LOCAL lnImpBase21
LOCAL lnImpBase105
LOCAL lcNumero
LOCAL lcMensaje
LOCAL lnModo
LOCAL lnTotalIVA
LOCAL lnImpBaseSIVA
LOCAL lnIndice
LOCAL lcMensaje

lnTipoDoc = 0
lcTipoDoc = ""
lnPtoVta = INT(VAL(getConfig("PTOVTA")))
lnRetAlva = 0
lnCantIVA = 0
lnImpBase21 = 0
lnImpBase105 = 0
lnImpBaseSIVA = 0
lcNumero = ""
lcMensaje = ""
lnTotalIVA = 0.00
lnIndice = 0
Thisform.error_message = ""

lcMensaje = lcMensaje + DTOC(DATETIME()) + " - Iniciando autoriazción" + CHR(13) + CHR(10)
IF !Thisform.verificar_cbte() THEN
	Thisform.error_message = "Por alguna razón el comprobante no se ha grabado."
	RETURN .F.
ENDIF

lcTipoDoc = Thisform.calcular_tipodoc()

&& Tengo que acordarme que en el tercer parámetro tengo que pasar
&& la ruta y el nombre de archivo del certificado.

lnModo = IIF(getGlobalCFG("FEDEBUG"), 0, 1)
llRes = Thisform.fe.iniciar(lnModo, getGlobalCFG("FECUIT"), SYS(5) + SYS(2003) + "\wsafip\" + getGlobalCFG("FE_FILE"), ALLTRIM(getGlobalCFG("FE_LIC")))

IF !llRes THEN
	Thisform.error_message = "Falló al iniciar: " + Thisform.fe.ultimoMensajeError
	RETURN .F.
ENDIF

Thisform.fe.ArchivoCertificadoPassWord = ALLTRIM(getGlobalCFG("FE_PWD"))
IF !Thisform.ticket_valido() THEN
	MESSAGEBOX("No se pudo generar Ticket de Acceso", 0+48, Thisform.Caption)
	Thisform.error_message = "No se pudo crear el ticket de acceso, por favor verifique que la unidad de red "
	Thisform.error_message = Thisform.error_message + "se encuentre accesible."
	RETURN .F.
ENDIF

Thisform.fe.ArchivoXMLRecibido = SYS(5) + SYS(2003) + "\wsafip\xml\" + ALLTRIM(STR(thisform.id_ventasc)) + "_rec_" + ALLTRIM(STR(YEAR(DATETIME()))) + ;
	ALLTRIM(STR(MONTH(DATETIME()))) + ALLTRIM(STR(DAY(DATETIME()))) + ALLTRIM(STR(HOUR(DATETIME()))) + ;
	ALLTRIM(STR(MINUTE(DATETIME()))) + ALLTRIM(STR(SEC(DATETIME()))) + ".xml"
	
Thisform.fe.archivoXMLEnviado = SYS(5) + SYS(2003) + "\wsafip\xml\" + ALLTRIM(STR(thisform.id_ventasc)) + "_env_" + ALLTRIM(STR(YEAR(DATETIME()))) + ;
	ALLTRIM(STR(MONTH(DATETIME()))) + ALLTRIM(STR(DAY(DATETIME()))) + ALLTRIM(STR(HOUR(DATETIME()))) + ;
	ALLTRIM(STR(MINUTE(DATETIME()))) + ALLTRIM(STR(SEC(DATETIME()))) + ".xml"
	
lnRetAlva = Thisform.fe.f1CompUltimoAutorizado(lnPtoVta, Thisform.fe_get_tipocbte_afip(ALLTRIM(lcTipoDoc)))

Thisform.fe.F1CabeceraCantReg = 1
Thisform.fe.F1CabeceraPtoVta = lnPtoVta
Thisform.fe.F1CabeceraCbteTipo = Thisform.fe_get_tipocbte_afip(ALLTRIM(lcTipoDoc))
Thisform.codigo_cbte = Thisform.fe.F1CabeceraCbteTipo
Thisform.fe.F1DetalleDocTipo = Thisform.fe_convertir_tipodoc(ALLTRIM(Thisform.cli_tipodoc))
Thisform.fe.F1DetalleDocNro = Thisform.cli_cuit
Thisform.fe.F1DetalleCbteDesde = lnRetAlva + 1
Thisform.fe.F1DetalleCbteHasta = lnRetAlva + 1

*Thisform.fe.F1DetalleCbteFch = ALLTRIM(STR(YEAR(DATE()))) + IIF(LEN(ALLTRIM(STR(MONTH(DATE())))) < 2, "0" + ALLTRIM(STR(MONTH(DATE()))), ALLTRIM(STR(MONTH(DATE())))) + ;
	IIF(LEN(ALLTRIM(STR(DAY(DATE())))) < 2, "0" + ALLTRIM(STR(DAY(DATE()))), ALLTRIM(STR(DAY(DATE()))))

Thisform.fe.F1DetalleCbteFch = ALLTRIM(STR(YEAR(Thisform.Contenido.txtFecEmis.Value))) + ;
	IIF(LEN(ALLTRIM(STR(MONTH(Thisform.Contenido.txtFecEmis.Value)))) < 2, "0" + ;
	ALLTRIM(STR(MONTH(Thisform.Contenido.txtFecEmis.Value))), ;
	ALLTRIM(STR(MONTH(Thisform.Contenido.txtFecEmis.Value)))) + ;
	IIF(LEN(ALLTRIM(STR(DAY(Thisform.Contenido.txtFecEmis.Value)))) < 2, "0" + ;
	ALLTRIM(STR(DAY(Thisform.Contenido.txtFecEmis.Value))), ALLTRIM(STR(DAY(Thisform.Contenido.txtFecEmis.Value))))

&& Tengo que calcular la suma del neto de los articulos con 21 de IVA y con el 10.5 de IVA por separado

SELECT cur_aux
GO TOP
DO WHILE !EOF("cur_aux")
	IF cur_aux.alicIVA = 21 THEN
		lnImpBase21 = lnImpBase21 + cur_aux.TotNeto
	ENDIF
	
	IF cur_aux.alicIVA = 10.5 THEN
		lnImpBase105 = lnImpBase105 + cur_aux.TotNeto
	ENDIF
	
	IF cur_aux.alicIVA = 0 THEN
		lnImpBaseSIVA = lnImpBaseSIVA + cur_aux.TotNeto
	ENDIF

	SELECT cur_aux
	SKIP
ENDDO


lnIndice = 0
lnTotalIVA = 0.00
IF lnImpBase21 <> 0 THEN
	Thisform.fe.F1DetalleIvaItemCantidad = 1
	Thisform.fe.f1IndiceItem = lnIndice
	Thisform.fe.F1DetalleIvaId = 5
	Thisform.fe.F1DetalleIvaBaseImp = ROUND(lnImpBase21, 2)
	Thisform.fe.F1DetalleIvaImporte = cur_subtotal.impIVA21
	lnTotalIVA = lnTotalIVA + cur_subtotal.impIVA21
	lnIndice = lnIndice + 1
ENDIF

IF lnImpBase105 <> 0 THEN
	Thisform.fe.F1DetalleIvaItemCantidad = Thisform.fe.F1DetalleIvaItemCantidad + 1
	Thisform.fe.f1IndiceItem = lnIndice
	Thisform.fe.F1DetalleIvaId = 4
	Thisform.fe.F1DetalleIvaBaseImp = ROUND(lnImpBase105, 2)
	Thisform.fe.F1DetalleIvaImporte = cur_subtotal.impIVA105
	lnTotalIVA = lnTotalIVA + cur_subtotal.impIVA105
	lnIndice = lnIndice + 1
ENDIF

IF lnImpBaseSIVA <> 0 THEN
	Thisform.fe.F1DetalleIvaItemCantidad = Thisform.fe.F1DetalleIvaItemCantidad + 1
	Thisform.fe.f1IndiceItem = lnIndice
	Thisform.fe.F1DetalleIvaId = 3
	Thisform.fe.F1DetalleIvaBaseImp = ROUND(lnImpBaseSIVA, 2)
ENDIF

&& Agrego los conceptos de IIBB

IF Thisform.Contenido.txtPorIIBB.Value <> 0 THEN
	Thisform.FE.F1DetalleTributoItemCantidad = 1
	Thisform.FE.f1IndiceItem = 0
	Thisform.FE.F1DetalleTributoId = 2
	Thisform.FE.F1DetalleTributoDesc = "IIBB Pcia Bs AS"
	Thisform.FE.F1DetalleTributoBaseImp = cur_subtotal.impfinal
	Thisform.FE.F1DetalleTributoAlic = cur_subtotal.porIIBB
	Thisform.FE.F1DetalleTributoImporte = cur_subtotal.impIIBB
ENDIF

Thisform.fe.F1DetalleConcepto = 1
Thisform.fe.F1DetalleImpNeto = cur_subtotal.impfinal
Thisform.fe.F1DetalleImpTotalConc = 0
Thisform.fe.F1DetalleImpIva = lnTotalIVA
Thisform.fe.F1DetalleImpOpEx = 0
Thisform.fe.F1DetalleImpTrib = Thisform.FE.F1DetalleTributoImporte
Thisform.fe.F1DetalleMonId = "PES"
Thisform.fe.F1DetalleMonCotiz = 1
Thisform.fe.F1DetalleImpTotal = cur_subtotal.totfact


llRes = Thisform.fe.f1CAESolicitar()

IF llRes THEN
	lcNumero = REPLICATE("0", 4 - LEN(ALLTRIM(STR(lnPtoVta)))) + ALLTRIM(STR(lnPtoVta)) + "-" + ;
		REPLICATE("0", 8 - LEN(ALLTRIM(STR(Thisform.fe.F1RespuestaDetalleCbteDesde)))) + ALLTRIM(STR(Thisform.fe.F1RespuestaDetalleCbteDesde))
	
	Thisform.ptovta = lnPtoVta
	Thisform.nrocbte = INT(VAL(Thisform.fe.F1RespuestaDetalleCbteDesdeS))
	
	lcMensaje = "CAE: " + Thisform.fe.F1RespuestaDetalleCae + CHR(13)+ CHR(10)
	lcMensaje = lcMensaje + "FECHA VTO: " + Thisform.fe.F1RespuestaDetalleCaeFchVto + CHR(13) + CHR(10)
	lcMensaje = lcMensaje + "MOTIVO: " + Thisform.fe.F1RespuestaDetalleObservacionMsg + CHR(13) + CHR(10)
	lcMensaje = lcMensaje + "RESULTADO: " + Thisform.fe.F1RespuestaREsultado + CHR(13) + CHR(10)
	lcMensaje = lcMensaje + "PROCESO: " + Thisform.fe.F1RespuestaReProceso
	MESSAGEBOX(lcMensaje, 0+64, Thisform.Caption)
	
	Thisform.aut_numero = lcNumero
	Thisform.aut_cae = Thisform.fe.F1RespuestaDetalleCae
	Thisform.aut_cae_vto = Thisform.fe.F1RespuestaDetalleCaeFchVto
	Thisform.aut_resultado = Thisform.fe.F1RespuestaResultado
	Thisform.aut_motivo = Thisform.fe.F1RespuestaDetalleObservacionMsg
ELSE
	IF !(ISNULL(Thisform.fe.F1RespuestaReProceso) .OR. Thisform.fe.F1RespuestaReProceso == "R") THEN
		lcNumero = REPLICATE("0", 4 - LEN(ALLTRIM(STR(lnPtoVta)))) + ALLTRIM(STR(lnPtoVta)) + "-" + ;
			REPLICATE("0", 4 - LEN(ALLTRIM(STR(Thisform.fe.F1RespuestaDetalleCbteDesde)))) + ALLTRIM(STR(Thisform.fe.F1RespuestaDetalleCbteDesde))
		
		&& lcMensaje = "CAE: " + Thisform.fe.F1RespuestaDetalleCae + CHR(13)+ CHR(10)
		lcMensaje = "ATENCION: Factura rechazada por el AFIP" + CHR(13) + CHR(10)
		&&lcMensaje = lcMensaje + "FECHA VTO: " + Thisform.fe.F1RespuestaDetalleCaeFchVto + CHR(13) + CHR(10)		
		lcMensaje = lcMensaje + "MOTIVO: " + Thisform.fe.F1RespuestaDetalleObservacionMsg + CHR(13) + CHR(10)
		&&lcMensaje = lcMensaje + "PROCESO: " + Thisform.fe.F1RespuestaReProceso
		MESSAGEBOX(lcMensaje, 0+64, Thisform.Caption)
		
		Thisform.aut_numero = lcNumero
		Thisform.aut_cae = Thisform.fe.F1RespuestaDetalleCae
		Thisform.aut_cae_vto = Thisform.fe.F1RespuestaDetalleCaeFchVto
		Thisform.aut_resultado = Thisform.fe.F1RespuestaResultado
		Thisform.aut_motivo = Thisform.fe.F1RespuestaDetalleObservacionMsg
		
		Thisform.error_message = lcMensaje + ". Se recomienda eliminar este comprobante y volver a generarlo"
		
		RETURN .F.
	ELSE
		lcMensaje = "MOTIVO: " + Thisform.fe.F1RespuestaDetalleObservacionMsg + CHR(13) + CHR(10)
		lcMensaje = lcMensaje + "ERROR: " + Thisform.fe.f1ErrorMsg1 + CHR(13) + CHR(10)
		lcMensaje = lcMensaje + "ULTIMO: " + Thisform.fe.UltimoMensajeError
		MESSAGEBOX(lcMensaje, 0+64, Thisform.Caption)
				
		Thisform.aut_numero = lcNumero
		Thisform.aut_cae = ""
		Thisform.aut_cae_vto = ""
		Thisform.aut_resultado = Thisform.fe.F1RespuestaResultado
		Thisform.aut_motivo = Thisform.fe.F1RespuestaDetalleObservacionMsg
		
		Thisform.error_message = lcMensaje
		
		RETURN .F.
	ENDIF
ENDIF

RETURN .T.
ENDPROC
PROCEDURE fe_convertir_tipodoc
PARAMETERS tcTipoDoc
LOCAL lnResultado

lnResultado = 99 && Código que corresponde a sin identificación en el diccionario

DO CASE
	CASE ALLTRIM(tcTipoDoc) == "CUIT"
		lnResultado = 80
	CASE ALLTRIM(tcTipoDoc) == "CUIL"
		lnResultado = 86
	CASE ALLTRIM(tcTipoDoc) == "CI"
		lnResultado = 87
	CASE ALLTRIM(tcTipoDoc) == "LE"
		lnResultado = 89
	CASE ALLTRIM(tcTipoDoc) == "LC"
		lnResultado = 90
	CASE ALLTRIM(tcTipoDoc) == "CIE"
		lnResultado = 91
	CASE ALLTRIM(tcTipoDoc) == "PAS"
		lnResultado = 94
	CASE ALLTRIM(tcTipoDoc) == "DNI"
		lnResultado = 96
ENDCASE

RETURN lnResultado
ENDPROC
PROCEDURE fe_get_tipocbte_afip
PARAMETERS tc_letra

DO CASE
	CASE ALLTRIM(thisform.cbte) == "FC"
		DO CASE
			CASE ALLTRIM(tc_letra) == "A"
				RETURN 1
			CASE ALLTRIM(tc_letra) == "B"
				RETURN 6
			CASE ALLTRIM(tc_letra) == "C" 
				RETURN 11
		ENDCASE
	CASE ALLTRIM(thisform.cbte) == "ND"
		DO CASE
			CASE ALLTRIM(tc_letra) == "A"
				RETURN 2
			CASE ALLTRIM(tc_letra) == "B"
				RETURN 7
			CASE ALLTRIM(tc_letra) == "C"
				RETURN 12
		ENDCASE
	CASE ALLTRIM(thisform.cbte) == "NC"
		DO CASE
			CASE ALLTRIM(tc_letra) == "A"
				RETURN 3
			CASE ALLTRIM(tc_letra) == "B"
				RETURN 8
			CASE ALLTRIM(tc_letra) == "C"
				RETURN 13
		ENDCASE	
ENDCASE

RETURN -1
ENDPROC
PROCEDURE fe_set_cae
LOCAL loCommand, lcSql
LOCAL loDT, ldFecVto
LOCAL lcAnio, lcMes, lcDia

loDT = CREATEOBJECT("datetime")
loCommand = CREATEOBJECT("odbc_command")
lcSql = ""

lcAnio = SUBSTR(Thisform.aut_cae_vto, 1, 4)
lcMes = SUBSTR(Thisform.aut_cae_vto, 5, 2)
lcDia = SUBSTR(Thisform.aut_cae_vto, 7, 2)

lcSql = "update ventascab "
lcSql = lcSql + "set "
lcSql = lcSql + "	ptoVta = " + ALLTRIM(STR(Thisform.ptovta)) + ", "
lcSql = lcSql + "	numCbte = " + ALLTRIM(STR(Thisform.nrocbte)) + ", "
lcSql = lcSql + "	aut_CAE = '" + ALLTRIM(Thisform.aut_cae) + "', "
lcSql = lcSql + "	aut_CAE_vto = " + loDT.toMySql(CTOD(lcDia + "/" + lcMes + "/" + lcAnio)) + ", "
lcSql = lcSql + "	aut_Resultado = '" + ALLTRIM(Thisform.aut_resultado) + "', "
lcSql = lcSql + "	aut_Motivo = '" + ALLTRIM(Thisform.aut_motivo) + "', "
lcSql = lcsql + "	aut_tipoCbte = '" + REPLICATE("0", 2 - LEN(ALLTRIM(STR(Thisform.fe.F1CabeceraCbteTipo)))) + ALLTRIM(STR(Thisform.fe.F1CabeceraCbteTipo)) + "' "
lcSql = lcSql + "where idVentasC = " + ALLTRIM(STR(Thisform.id_ventasc))

goConn.BeginTransaction()

loCommand.ActiveConnection = goConn.ActiveConnection
loCommand.CommandText = lcSql

IF !loCommand.Execute() THEN
	MESSAGEBOX(loCommand.ErrorMessage, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

lcSql = "update cc_cli set nroCbte = " + ALLTRIM(STR(Thisform.nrocbte)) + " "
lcSql = lcSql + "WHERE idVentasC = " + ALLTRIM(STR(Thisform.id_ventasc))

loCommand.ActiveConnection = goConn.ActiveConnection
loCommand.CommandText = lcSql

IF !loCommand.Execute() THEN
	goConn.Rollback()
	MESSAGEBOX(loCommand.ErrorMessage, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

&& Si el sistema está configurado para llevar el stock, entonces,
&& una vez autorizado el comprobante genero los movimientos de stock
&& asginando el número de comprobante devuelto por el AFIP.
IF getGlobalCFG("STK_MODULE") .AND. ALLTRIM(Thisform.cbte) == "FC" THEN
	Thisform.mov_stock.circuito = "V"
	Thisform.mov_stock.idcliente = thisform.contenido.sel_Cliente.valcpoid
	Thisform.mov_stock.idprov = 0
	Thisform.mov_stock.tipodoc = Thisform.tipodoc
	Thisform.mov_stock.cbte = IIF(ALLTRIM(Thisform.cbte) == "PTO", "SAL", Thisform.cbte )
	Thisform.mov_stock.numcbte =  REPLICATE("0", 4 - LEN(ALLTRIM(STR(Thisform.ptovta)))) + ;
			ALLTRIM(STR(Thisform.Ptovta)) + "-" + ;
			REPLICATE("0", 8 - LEN(ALLTRIM(STR(Thisform.nrocbte)))) + ALLTRIM(STR(Thisform.nrocbte))		
	IF !Thisform.mov_stock.grabar2() THEN
		MESSAGEBOX(Thisform.mov_stock.ErrorMessage, 0+48, Thisform.Caption)
		thisform.desbloq_numerador()
		goConn.Rollback()
		RETURN .F.
	ENDIF
ENDIF

goConn.Commit()

RETURN .T.
ENDPROC
PROCEDURE calc_digito_verificador
&& El prefijo E1, E2, En... indica a la etapa del algoritmo que pertenece el coeficiente

PARAMETERS tcCodigo

LOCAL lnDigito
LOCAL lnSumaE1
LOCAL lnSumaE3
LOCAL lnProductoE2
LOCAL lnSumaE4
LOCAL lnMin
LOCAL lnPos

lnDigito = 0
lnSumaE1 = 0
lnSumaE3 = 0
lnSumaE4 = 0
lnMin = 0

FOR i = 1 TO LEN(ALLTRIM(tcCodigo))
	lnDigito = INT(VAL(SUBSTR(tcCodigo, i, 1)))
	
	IF MOD(i, 2) <> 0 THEN
		&& Etapa 1 (posiciones impares)
		lnSumaE1 = lnSumaE1 + lnDigito
	ELSE
		&& Etapa 3 (posiciones pares)
		lnSumaE3 = lnSumaE3 + lnDigito
	ENDIF
NEXT i

lnProductoE2 = lnSumaE1 * 3 && Etapa 2
lnSumaE4 = lnProductoE2 + lnSumaE3 && Etapa 4

&& Etapa 5
lnPos = 0
FOR i = 1 TO LEN(ALLTRIM(tcCodigo))
	lnDigito = INT(VAL(SUBSTR(tcCodigo, i, 1)))
	
	IF MOD(lnSumaE4 + lnDigito, 10) = 0 THEN
		IF lnPos = 0 THEN
			lnMin = lnDigito
		ELSE
			IF lnDigito < lnMin THEN
				lnMin = lnDigito
			ENDIF
		ENDIF
		
		lnPos = lnPos + 1
	ENDIF
NEXT i

RETURN lnMin
ENDPROC
PROCEDURE ticket_valido
LOCAL llTkValido
LOCAL lcTicket
LOCAL lcFileTicket
LOCAL lcTK
LOCAL hndFile

llTkValido = .F.
lcTicket = ""
lcTK = ""
lcFileTicket = getGlobalCFG("FE_TICKACC")

IF FILE(ALLTRIM(lcFileTicket)) THEN
	hndFile = FOPEN(lcFileTicket, 12)
	IF hndFile < 0 THEN
		=MESSAGEBOX("Error al intentar leer el ticket de acceso", 0+48, Thisform.Caption)
		=FCLOSE(hndFile)
	ELSE
		=FCLOSE(hndFile)
		
		lcTK = FILETOSTR(ALLTRIM(lcFileTicket))
		Thisform.fe.f1RestaurarTicketAcceso(lcTK)
		
		IF Thisform.fe.f1TicketEsValido THEN
			llTkValido = .T.
		ELSE
			llTkValido = .F.
		ENDIF
	ENDIF
	
	IF !llTkValido THEN
		DELETE FILE ALLTRIM(lcFileTicket)
		
		IF Thisform.fe.f1ObtenerTicketAcceso() THEN
			lcTK = Thisform.fe.f1GuardarTicketAcceso()
			hndFile = FCREATE(lcFileTicket)
			
			IF hndFile < 0 THEN
				=MESSAGEBOX("Error al generar el archivo, por favor verifique la ruta se encuentre accesible", 0+16, Thisform.Caption)
			ELSE
				=FWRITE(hndFile, lcTK)
				llTkValido = .T.
			ENDIF
			
			=FCLOSE(hndFile)
		ELSE
			MESSAGEBOX("Fallo de acceso: " + ALLTRIM(Thisform.fe.ultimoMensajeError), 0+16, Thisform.Caption)
			llTkValido = .F.
		ENDIF
	ENDIF
ELSE
	IF Thisform.fe.f1ObtenerTicketAcceso() THEN
		lcTK = Thisform.fe.f1GuardarTicketAcceso()
		hndFile = FCREATE(lcFileTicket)
		
		IF hndFile < 0 THEN
			=MESSAGEBOX("Error al generar el archivo, por favor verifique la ruta se encuentre accesible", 0+48, Thisform.Caption)
		ELSE
			=FWRITE(hndFile, lcTK)
			llTkValido = .T.
		ENDIF
		
		=FCLOSE(hndFile)
	ELSE
		MESSAGEBOX("Fallo de acceso: " + ALLTRIM(Thisform.fe.ultimoMensajeError), 0+16, Thisform.Caption)
		llTkValido = .F.			
	ENDIF
ENDIF

RETURN llTkValido
ENDPROC
PROCEDURE verificar_cbte
LOCAL loRes
LOCAL lcSql

loRes = CREATEOBJECT("odbc_result")
lcSql = ""

lcSql = "SELECT idVentasC "
lcSql = lcSql + "FROM ventascab "
lcSql = lcSql + "WHERE ventascab.idVentasC = " + ALLTRIM(STR(Thisform.id_ventasc))

loRes.ActiveConnection = goConn.ActiveConnection
loRes.Cursor_Name = "cur_tempo"

IF !loRes.OpenQuery(lcSql) THEN
	Thisform.error_message = loRes.Error_Message
	RETURN .F.
ENDIF

SELECT cur_tempo
IF RECCOUNT("cur_tempo") = 0 THEN
	loRes.Close_Query()
	RETURN .F.
ENDIF

loRes.Close_Query()

RETURN .T.

ENDPROC
PROCEDURE particionar_cbte
************************************************************************************
** Esta función permite grabar una factura cada 25 items.
** Pablo Díaz
************************************************************************************

LOCAL ln_cantitems

ln_cantitems = 0

SELECT cur_aux
ZAP 

IF !(ALLTRIM(thisform.cbte) == "COT") .AND. getGlobalCFG("STK_MODULE") THEN
	IF !thisform.validar_stk_en_grabado() THEN
		goConn.Rollback()
		RETURN .F.
	ENDIF
ENDIF

SELECT cur_detalle
IF RECCOUNT() > 0 THEN 
	GO TOP
ELSE 
	RETURN .F.
ENDIF 

************************************************************************************
** Paso de a 25 items del cursor de detalle al cursor auxiliar
************************************************************************************
SELECT cur_detalle
DO WHILE !EOF()
	ln_cantitems = ln_cantitems + 1
	
	SELECT cur_aux
	APPEND BLANK	
	
	REPLACE cur_aux.idDetalle WITH cur_detalle.idDetalle
	REPLACE cur_aux.idArticulo WITH cur_detalle.idArticulo ADDITIVE
	REPLACE cur_aux.codArt WITH cur_detalle.codArt ADDITIVE
	REPLACE cur_aux.descripcio WITH cur_detalle.descripcio ADDITIVE
	REPLACE cur_aux.nroPart WITH cur_detalle.nroPart ADDITIVE
	REPLACE cur_aux.cantidad WITH cur_detalle.cantidad ADDITIVE
	REPLACE cur_aux.prVta WITH cur_detalle.prVta ADDITIVE
	REPLACE cur_aux.pDtoVta1 WITH cur_detalle.pDtoVta1 ADDITIVE
	REPLACE cur_aux.pDtoVta2 WITH cur_detalle.pDtoVta2 ADDITIVE
	REPLACE cur_aux.pDtoVta3 WITH cur_detalle.pDtoVta3 ADDITIVE
	REPLACE cur_aux.pDtoVta4 WITH cur_detalle.pDtoVta4 ADDITIVE
	REPLACE cur_aux.iDtoVta1 WITH cur_detalle.iDtoVta1 ADDITIVE
	REPLACE cur_aux.iDtoVta2 WITH cur_detalle.iDtoVta2 ADDITIVE
	REPLACE cur_aux.iDtoVta3 WITH cur_detalle.iDtoVta3 ADDITIVE
	REPLACE cur_aux.iDtoVta4 WITH cur_detalle.iDtoVta4 ADDITIVE
	REPLACE cur_aux.pDtoCli1 WITH cur_detalle.pDtoCli1 ADDITIVE
	REPLACE cur_aux.pDtoCli2 WITH cur_detalle.pDtoCli2 ADDITIVE
	REPLACE cur_aux.pDtoCli3 WITH cur_detalle.pDtoCli3 ADDITIVE
	REPLACE cur_aux.pDtoCli4 WITH cur_detalle.pDtoCli4 ADDITIVE
	REPLACE cur_aux.iDtoCli1 WITH cur_detalle.iDtoCli1 ADDITIVE
	REPLACE cur_aux.iDtoCli2 WITH cur_detalle.iDtoCli2 ADDITIVE
	REPLACE cur_aux.iDtoCli3 WITH cur_detalle.iDtoCli3 ADDITIVE
	REPLACE cur_aux.iDtoCli4 WITH cur_detalle.iDtoCli4 ADDITIVE
	REPLACE cur_aux.alicIVA WITH cur_detalle.alicIVA ADDITIVE
	REPLACE cur_aux.impIVA WITH cur_detalle.impIVA ADDITIVE
	REPLACE cur_aux.impNeto WITH cur_detalle.impNeto ADDITIVE
	REPLACE cur_aux.totNeto WITH cur_detalle.totNeto ADDITIVE
	REPLACE cur_aux.subTotal WITH cur_detalle.subTotal ADDITIVE
	REPLACE cur_aux.prArtic WITH cur_detalle.prArtic ADDITIVE
	REPLACE cur_aux.esOferta WITH cur_detalle.esOferta ADDITIVE
	REPLACE cur_aux.pRecVta WITH cur_detalle.pRecVta ADDITIVE 
	REPLACE cur_aux.iRecVta WITH cur_detalle.iRecVta ADDITIVE
	REPLACE cur_aux.uniDesp WITH cur_detalle.uniDesp ADDITIVE
	REPLACE cur_aux.cantPack WITH cur_detalle.cantPack ADDITIVE 
	REPLACE cur_aux.uniMed WITH cur_detalle.uniMed ADDITIVE
	
	&& Agrego los recargos
	REPLACE cur_aux.pRecItem WITH cur_detalle.pRecItem ADDITIVE
	REPLACE cur_aux.iRecItem WITH cur_detalle.iRecItem ADDITIVE
	
	&& Si lleva stock agrege los movimientos que hay que generar.
	IF ALLTRIM(cur_detalle.nropart) == "" THEN
		IF getGlobalCFG("STK_MODULE") THEN
			IF !(RIGHT(ALLTRIM(cur_detalle.codArt), 3) == "ARX") THEN
				Thisform.mov_stock.agregar_articulo(cur_detalle.idArticulo, ;
						cur_detalle.Cantidad, "")
			ENDIF
		ENDIF
	ELSE
		IF getGlobalCFG("STK_MODULE") THEN
			IF !(RIGHT(ALLTRIM(cur_detalle.codArt), 3) == "ARX") THEN
				Thisform.mov_stock.agregar_articulo(cur_detalle.idArticulo, ;
						cur_detalle.Cantidad, cur_detalle.nropart)
			ENDIF
		ENDIF	
	ENDIF	
	
	&& Cuando el contador llegue a 25 items grabo una factura nueva.
	IF ln_cantitems = 25
		&& tengo que hacer el calculo de los totales y el grabado		
		Thisform.calc_subtot_cur_aux()
		
		IF !thisform.grabar_cbte_part()
			RETURN .F.
		ENDIF	
		
		&& Verifico que el comprobante haya sido grabado correctamente
		&& antes de enviar a autorizar
		IF !thisform.enviar_wsafipfe() THEN
			MESSAGEBOX(Thisform.error_message, 0+48, Thisform.Caption)
			*RETURN .F.
		ELSE
			IF thisform.fe_set_cae() THEN
				&& Si se asignó el número de CAE, entonces procedo a hacer el grabado
				&& de la cuenta corriente.
				thisform.grabar_ctacte(thisform.id_ventasc)
				thisform.imprimir()
			ENDIF
		ENDIF
		
		ln_cantitems = 0
		
		SELECT cur_aux
		ZAP
		Thisform.mov_stock.limpiar()	
	ENDIF 
	
	SELECT cur_detalle
	SKIP  
ENDDO 

&& En el caso que la ultima factura no haya llegado a los 25 items
&& tengo que hacer una nueva factura con los items restantes.
IF ln_cantitems <> 0 
	&& tengo que hacer el calculo de los totales y el grabado
	Thisform.calc_subtot_cur_aux()
		
	IF !thisform.grabar_cbte_part()
		RETURN .F.
	ENDIF	
	
	IF !thisform.enviar_wsafipfe() THEN
		MESSAGEBOX(Thisform.error_message, 0+48, Thisform.Caption)
		RETURN .F.
	ELSE
		IF thisform.fe_set_cae() THEN
			&& Si se asignó el número de CAE, entonces procedo a hacer el grabado
			&& de la cuenta corriente.
			thisform.grabar_ctacte(thisform.id_ventasc)
			thisform.imprimir()
			thisform.id_ventasc = 0
		ENDIF
	ENDIF
	
	Thisform.mov_stock.limpiar()
ENDIF 

RETURN .T.
ENDPROC
PROCEDURE grabar_cbte_part
&& Grabo la info en la base

LOCAL lnIdVentasC, lnIdCliente, lcFecEmis, lcCbte, lcTipoDoc, lnPtoVta
LOCAL lnNroCbte, llAnulado, lnImpNeto, lnImpFinal, lnPorIVA21, lnImpIVA21
LOCAL lnPorIVA105, lnImpIVA105, lnPorDesc1, lnPorDesc2, lnPorDesc3, lnPorDesc4
LOCAL lnImpDesc1, lnImpDesc2, lnImpDesc3, lnImpDesc4, lnTotFact
LOCAL lnIdVentasD, lnIdArticulo, lnCantidad, lnCostoRep, lnPrVenta, lnAlicIVA, lnImpIVA
LOCAL lnTotNeto, lnSubTotal, lnSaldo, lcObserv, lnPorIIBB, lnImpIIBB
LOCAL lnPDtoVta1, lnPDtoVta2, lnPDtoVta3, lnPDtoVta4, lnIDtoVta1, lnIDtoVta2, lnIDtoVta3, lnIDtoVta4
LOCAL lnIdCondPago, lnIdSitIVA, lnPrArtic, lnPorRec, lnImpRec, lnUnidDesp, lnCantPack, lcUniMed
LOCAL lnPRecItem, lnIRecItem
LOCAL ldFecVto, lnIdOper, oDT, lnOC
LOCAL loNumerador, lcSql, loCommand, loArtic, loOper, lnSqlSrv, lnPrNeto, lnIdCCOrig, loCliente, lnIdVendedor
LOCAL loConDMO, loResCli, lcSql, lnIntentos

&& Inicializo las variables del detalle

lnIdVentasD = 0
lnIdArticulo = 0
lnCantidad = 0.00
lnCostoRep = 0.00
lnPrVenta = 0.00
lnAlicIVA = 0.00
lnImpIVA = 0.00
lnTotNeto = 0.00
lnSubTotal = 0.00
ldFecVto = {}
lnIdOper = 0
lnSaldo = 0
oDT = CREATEOBJECT("datetime")
loArtic = CREATEOBJECT("odbc_result")
loOper = CREATEOBJECT("odbc_result")
loCliente = CREATEOBJECT("odbc_result")
loCommand = CREATEOBJECT("odbc_command")
lnSqlSrv = INT(VAL(getconfig("SQLSRV")))
lcObserv = Thisform.Contenido.txtObserv.Value
lnPorIIBB = 0.00
lnImpIIBB = 0.00
lnPDtoVta1 = 0.00
lnPDtoVta2 = 0.00
lnPDtoVta3 = 0.00
lnPDtoVta4 = 0.00
lnIDtoVta1 = 0.00
lnIDtoVta2 = 0.00
lnIDtoVta3 = 0.00
lnIDtoVta4 = 0.00
lnPrNeto = 0.00
lnIdCondPago = 0
lnIdSitIVA = 0
lnIdVendedor = 0
loConDMO = CREATEOBJECT("odbc_connect")
lnPrArtic = 0.00
lnPorRec = 0.00
lnImpRec = 0.00
lcSql = ""
loResCli = CREATEOBJECT("odbc_result") && Este objeto lo uso para validar que el cliente exista
lnUniDesp = 0.00
lnCantPack = 0.00
lcUniMed = ""
lnOC = Thisform.Contenido.txtOC.Value 
lnPRecItem = 0.00
lnIRecItem = 0.00

lcCbte = Thisform.Cbte
lnIdCliente = Thisform.Contenido.sel_Cliente.ValCpoId

IF ALLTRIM(lcCbte) == "PTO" THEN
	&& Si es un comprobante PTO, entonces, abro la base DMO para generar el registro.

	loConDMO.ConnectionString = ALLTRIM(getConfig("DMO_CC"))

	IF !loConDMO.Open() THEN
		MESSAGEBOX(loConDMO.ErrorMessage, 0+48, Thisform.Caption)
		RETURN .F.
	ENDIF
	
	lcSql = "SELECT COUNT(*) AS cantCli FROM clientes WHERE idCliente = " + ALLTRIM(STR(lnIdCliente))
	loResCli.ActiveConnection = loConDMO.ActiveConnection
	loResCli.Cursor_Name = "cur_x"
	
	IF !loResCli.OpenQuery(lcSql) THEN
		MESSAGEBOX(loResCli.Error_Message, 0+48, Thisform.Caption)
		RETURN .F.
	ENDIF
	
	IF TYPE('cur_x.cantCli') != "C" THEN
		IF cur_x.cantCli = 0 THEN
			MESSAGEBOX("El cliente no existe en DMO, actualice la base y vuelva a intentar", 0+48, Thisform.Caption)
			loResCli.Close_Query()
			RETURN .F.
		ENDIF
	ELSE
		IF INT(VAL(cur_x.cantCli)) = 0 THEN
			MESSAGEBOX("El cliente no existe en DMO, actualice la base y vuelva a intentar", 0+48, Thisform.Caption)
			loResCli.Close_Query()
			RETURN .F.
		ENDIF	
	ENDIF
	
	loResCli.Close_Query()
ENDIF


&& Asigno el idvendedor
lcSql = "SELECT * FROM clientes WHERE idCliente = " + ALLTRIM(STR(lnIdCliente))
loCliente.ActiveConnection = goConn.ActiveConnection
loCliente.Cursor_Name = "cur_cliente"
loCliente.OpenQuery(lcSql)

lnIdVendedor = cur_cliente.idVendedor

loCliente.Close_Query()

lcFecEmis = ALLTRIM(STR(YEAR(DATETIME()))) + "-" + ALLTRIM(STR(MONTH(DATETIME()))) + " - " + ;
	ALLTRIM(STR(DAY(DATETIME())))

IF lcCbte == "COT"
	lcTipoDoc = "X"
	Thisform.tipodoc = lcTipoDoc
ELSE
	&& Aca tengo que agregar el cálculo en caso que sea
	&& comprobante fiscal
	IF lcCbte == "PED"
		lcTipoDoc = "P"
		Thisform.tipodoc = lcTipoDoc
	ELSE
		lcTipoDoc = thisform.calcular_tipodoc()
		Thisform.tipodoc = lcTipoDoc
	ENDIF
ENDIF

IF lcCbte == "PTO" THEN
	lnPtoVta = 9999
	lcTipoDoc = "X"
	Thisform.tipodoc = lcTipoDoc
ELSE
	lnPtoVta = INT(VAL(ALLTRIM(getconfig("PTOVTA"))))
ENDIF

Thisform.ptovta = REPLICATE("0", 4 - LEN(ALLTRIM(STR(lnPtoVta)))) + ALLTRIM(STR(lnPtoVta))

llAnulado = .F.
lnImpNeto = cur_Subtotal.impNeto
lnImpFinal = cur_Subtotal.impFinal
lnPorIVA21 = cur_Subtotal.porIVA21
lnPorIVA105 = cur_Subtotal.porIVA105
lnImpIVA21 = cur_Subtotal.impIVA21
lnImpIVA105 = cur_Subtotal.impIVA105
lnPorIIBB= cur_Subtotal.porIIBB
lnImpIIBB = cur_Subtotal.impIIBB
lnPorDesc1 = cur_Subtotal.porDesc1
lnPorDesc2 = cur_Subtotal.porDesc2
lnPorDesc3 = cur_Subtotal.porDesc3
lnPorDesc4 = cur_Subtotal.porDesc4
lnImpDesc1 = cur_Subtotal.impDesc1
lnImpDesc2 = cur_Subtotal.impDesc2
lnImpDesc3 = cur_Subtotal.impDesc3
lnImpDesc4 = cur_Subtotal.impDesc4
lnTotFact = cur_Subtotal.totFact
lnPorRec = cur_Subtotal.porRec
lnImpRec = cur_Subtotal.impRec
lnIdCondPago = clientes.idCondPago
lnIdSitIVA = clientes.idSitIVA

IF ALLTRIM(thisform.cbte) == "PTO"
	lnIdVentasC = loConDMO.GetNextID("ventascab", "idVentasC")
ELSE
	lnIdVentasC = goConn.GetNextID("ventascab", "idVentasC")
ENDIF

Thisform.id_ventasc = lnIdVentasC
lnNroCbte = 0

&& Calculo la fecha de vencimiento correspondiente a la factura
IF ALLTRIM(Thisform.cbte) == "FC" .OR. ALLTRIM(Thisform.cbte) == "PTO" THEN 
	IF thisform.cp_cntdias <> 0 THEN
		ldFecVto = Thisform.contenido.txtFecEmis.Value + thisform.cp_cntdias
	ELSE
		ldFecVto = Thisform.contenido.txtFecEmis.Value
	ENDIF 
ELSE
	ldFecVto = Thisform.contenido.txtFecEmis.Value
ENDIF

IF ALLTRIM(Thisform.cbte) == "FC" .OR. ALLTRIM(Thisform.cbte) == "PTO" THEN
	lnSaldo = lnTotFact
ELSE
	lnSaldo = 0
ENDIF

lcSql = "INSERT INTO ventascab ( "
lcSql = lcSql + "idVentasC, idCliente, razSoc, idTipoDoc, nroDoc, fecEmision, cbte, tipoDoc, ptoVta, numCbte, anulado, idCondPago, idSitIVA, idVendedor,"
lcSql = lcSql + "impNeto, impFinal, porIVA21, impIVA21, porIVA105, impIVA105, porDesc1, "
lcSql = lcSql + "porDesc2, porDesc3, porDesc4, impDesc1, impDesc2, impDesc3, impDesc4, totFact, Saldo, usuAlta, fecAlta, idHostAlta, observ, porIIBB, impIIBB, fecVto, porRec, impRec, nroOC) VALUES ("
lcSql = lcSql + ALLTRIM(STR(lnIdVentasC)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnIdCliente)) + ", "
lcSql = lcSql + "'" + STRTRAN(ALLTRIM(Thisform.contenido.sel_Cliente.txtDescripcion.Value), "'", "''") + "', "
lcSql = lcSql + ALLTRIM(STR(Thisform.cli_idTipoDoc)) + ", "
lcSql = lcSql + "'" + ALLTRIM(Thisform.contenido.txtCuit.Value) + "', "
*lcSql = lcSql + oDT.getDateTime() + ", "
lcSql = lcSql + oDT.toMySql(Thisform.contenido.txtFecEmis.Value) + ", "
lcSql = lcSql + "'" + IIF(ALLTRIM(lcCbte) == "PTO", "FC", ALLTRIM(lcCbte)) + "', "
lcSql = lcSql + "'" + ALLTRIM(lcTipoDoc) + "', "
lcSql = lcSql + ALLTRIM(STR(lnPtoVta)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnNroCbte)) + ", "
lcSql = lcSql + IIF(lnSqlSrv = 0, "false", "0") + ", "
lcSql = lcSql + ALLTRIM(STR(lnIdCondPago)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnIdSitIVA)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnIdVendedor)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpNeto, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpFinal, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnPorIVA21, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpIVA21, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnPorIVA105, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpIVA105, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnPorDesc1, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnPorDesc2, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnPorDesc3, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnPorDesc4, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpDesc1, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpDesc2, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpDesc3, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpDesc4, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnTotFact, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnSaldo, 10, 2)) + ", "
lcSql = lcSql + "'" + ALLTRIM(gcCodUsu) + "', " 
lcSql = lcSql + oDT.getDateTime() + ", "
lcSql = lcSql + "'" + SYS(0) + "', '" + ALLTRIM(lcObserv) + "', "
lcSql = lcSql + ALLTRIM(STR(lnPorIIBB, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpIIBB, 10, 2)) + ", "

IF INT(VAL(getconfig("SQLSRV"))) = 1 THEN
	lcSql = lcSql + oDT.getDateTime() + " + " + ALLTRIM(STR(thisform.cp_cntdias)) + ", "
ELSE
	lcSql = lcSql + oDT.toMySql(ldFecVto) + ", "
ENDIF

lcSql = lcSql + ALLTRIM(STR(lnPorRec, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpRec, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnOC)) + ")"

loCommand.CommandText = lcSql

IF ALLTRIM(lcCbte) == "PTO" THEN
	loCommand.ActiveConnection = loConDMO.ActiveConnection
	
	IF !loCommand.Execute()
		thisform.desbloq_numerador()
		loConDMO.Rollback()
		RETURN .F.
	ENDIF	
ELSE
	loCommand.ActiveConnection = goConn.ActiveConnection
	IF !loCommand.Execute()
		thisform.desbloq_numerador()
		goConn.Rollback()
		RETURN .F.
	ENDIF
ENDIF

&& Grabo el detalle del comprobante

SELECT cur_aux
IF RECCOUNT() > 0
	GO TOP
ENDIF

lnIdVentasD = 0

DO WHILE !EOF()
	lnIdVentasD = lnIdVentasD + 1
	
	lnIdArticulo = cur_aux.idArticulo
	lnCantidad = cur_aux.cantidad
	lnAlicIVA = cur_aux.alicIVA
	lnPrVenta = cur_aux.PrVta
	lnImpIVA = cur_aux.impIVA
	lnPrNeto = cur_aux.impNeto
	lnTotNeto = cur_aux.totNeto
	lnSubTotal = cur_aux.subTotal
	lnPDtoVta1 = cur_aux.pDtoVta1
	lnPDtoVta2 = cur_aux.pDtoVta2
	lnPDtoVta3 = cur_aux.pDtoVta3
	lnPDtoVta4 = cur_aux.pDtoVta4
	lnIDtoVta1 = cur_aux.iDtoVta1
	lnIDtoVta2 = cur_aux.iDtoVta2
	lnIDtoVta3 = cur_aux.iDtoVta3
	lnIDtoVta4 = cur_aux.iDtoVta4
	
	lnPorDesc1 = cur_aux.pDtoCli1
	lnPorDesc2 = cur_aux.pDtoCli2
	lnPorDesc3 = cur_aux.pDtoCli3
	lnPorDesc4 = cur_aux.pDtoCli4
	lnImpDesc1 = cur_aux.iDtoCli1
	lnImpDesc2 = cur_aux.iDtoCli2
	lnImpDesc3 = cur_aux.iDtoCli3
	lnImpDesc4 = cur_aux.iDtoCli4
	
	lnPrArtic = cur_aux.prArtic
	lnPorRec = cur_aux.pRecVta
	lnImpRec = cur_aux.iRecVta
	lnUniDesp = cur_aux.uniDesp
	lnCantPack = cur_aux.cantPack
	lcUniMed = cur_aux.uniMed
	lnPRecItem = cur_aux.pRecItem
	lnIRecItem = cur_aux.iRecItem
	
	lcSql = "SELECT * FROM articulos WHERE idArticulo = " + ALLTRIM(STR(lnIdArticulo))
	
	IF ALLTRIM(lcCbte) == "PTO" THEN
		loArtic.ActiveConnection = loConDMO.ActiveConnection
	ELSE
		loArtic.ActiveConnection = goConn.ActiveConnection
	ENDIF
	
	loArtic.Cursor_Name = "cur_Artic"
	loArtic.OpenQuery(lcSql)
	
	SELECT cur_Artic
	lnCostoRep = cur_Artic.costoRep
	
	loArtic.close_query()

	lcSql = "INSERT INTO ventasdet ( "
	lcSql = lcSql + "idVentasD, "
	lcSql = lcSql + "idVentasC, "
	lcSql = lcSql + "idArticulo, "
	lcSql = lcSql + "descripcio, "
	lcSql = lcSQl + "nroPart, "
	lcSql = lcSql + "Cantidad, "
	
	IF ALLTRIM(lcCbte) == "PED" THEN
		lcSql = lcSql + "cant_pri1, "
	ENDIF
	
	lcSql = lcSql + "costoRep, "
	lcSql = lcSql + "prVenta, "
	lcSql = lcSql + "alicIVA, "
	lcSql = lcSql + "impIVA, "
	lcSql = lcSql + "subTotal, "
	lcSql = lcSql + "porDesc1, "
	lcSql = lcSql + "porDesc2, "
	lcSql = lcSql + "porDesc3, "
	lcSql = lcSql + "porDesc4, "
	lcSql = lcSql + "impDesc1, "
	lcSql = lcSql + "impDesc2, "
	lcSql = lcSql + "impDesc3, "
	lcSql = lcSql + "impDesc4, "
	lcSql = lcSql + "pDtoVta1, "
	lcSql = lcSql + "pDtoVta2, "
	lcSql = lcSql + "pDtoVta3, "
	lcSql = lcSql + "pDtoVta4, "
	lcSql = lcSql + "iDtoVta1, "
	lcSql = lcSql + "iDtoVta2, "
	lcSql = lcSql + "iDtoVta3, "
	lcSql = lcSql + "iDtoVta4, "
	lcSql = lcSql + "pRecItem, "
	lcSql = lcSql + "iRecItem, "
	lcSql = lcSql + "impNeto, "
	lcSql = lcSql + "totNeto, "
	lcSql = lcSql + "prArtic, "
	lcSql = lcSql + "esOferta, "
	lcSql = lcSql + "pRecVta, "
	lcSql = lcSql + "iRecVta, "
	lcSql = lcSql + "uniDesp, "
	lcSql = lcSql + "cantPack, "
	lcSql = lcSql + "codUM) VALUES ( "
	lcSql = lcSql + ALLTRIM(STR(lnIdVentasD)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIdVentasC)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIdArticulo)) + ", "
	lcSql = lcSql + "'" + STRTRAN(ALLTRIM(cur_aux.descripcio), "'", "''") + "', "
	lcSql = lcSql + "'" + ALLTRIM(cur_aux.nroPart) + "', "
	lcSql = lcSql + ALLTRIM(STR(lnCantidad, 10, 2)) + ", "
	
	IF ALLTRIM(lcCbte) == "PED" THEN
		lcSql = lcSql + ALLTRIM(STR(lnCantidad, 10, 2)) + ", "
	ENDIF	
	
	lcSql = lcSql + ALLTRIM(STR(lnCostoRep, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPrVenta, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnAlicIVA, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnImpIVA, 10, 4)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnSubTotal, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPorDesc1, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPorDesc2, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPorDesc3, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPorDesc4, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnImpDesc1, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnImpDesc2, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnImpDesc3, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnImpDesc4, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPDtoVta1, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPDtoVta2, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPDtoVta3, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPDtoVta4, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIDtoVta1, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIDtoVta2, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIDtoVta3, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIDtoVta4, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPRecItem, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIRecItem, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPrNeto, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnTotNeto, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPrArtic, 10, 2)) + ", "
	lcSql = lcSql + IIF(cur_detalle.esOferta, "1", "0") + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPorRec, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnImpRec, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnUniDesp, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnCantPack, 10, 2)) + ", "
	lcSql = lcSql + "'" + ALLTRIM(lcUniMed) + "')"
	
	*******************************************************************************************
	
	loCommand.CommandText = lcSql

	IF ALLTRIM(lcCbte) == "PTO" 
		loCommand.ActiveConnection = loConDMO.ActiveConnection
		IF !loCommand.Execute()
			thisform.desbloq_numerador()
			loConDMO.Rollback()
			RETURN .F.
		ENDIF	
	ELSE
		loCommand.ActiveConnection = goConn.ActiveConnection
		IF !loCommand.Execute()
			thisform.desbloq_numerador()
			goConn.Rollback()
			RETURN .F.
		ENDIF
	ENDIF	
	
	&& Si es nota de crédito entonces, actualizo la cantidad de NC en los
	&& items de la factura.
	&& Actualizar este dato tiene como objetivo de que si se hace más una NC
	&& que no se pueda hacer dos veces sobre la misma cantidad de un producto
	&& sino que por el resto.
	
	IF ALLTRIM(Thisform.cbte) == "NC" THEN
		lcSql = "UPDATE ventasdet SET cantNC = cantNC + " + ALLTRIM(STR(lnCantidad, 10, 2)) + " "
		lcSql = lcSql + "WHERE idVentasC = " + ALLTRIM(STR(Thisform.idorigen)) + " "
		lcSql = lcSql + " AND idArticulo = " + ALLTRIM(STR(cur_aux.idArticulo))
		
		loCommand.ActiveConnection = goConn.ActiveConnection
		loCommand.CommandText = lcSql
		
		IF !loCommand.Execute() THEN
			thisform.desbloq_numerador()
			goConn.Rollback()
			RETURN .F.
		ENDIF
	ENDIF
	
	SELECT cur_aux
	SKIP
ENDDO

IF ALLTRIM(thisform.cbte) == "PTO" THEN
	lnProxID = loConDMO.GetNextId("cc_cli", "idCC_Cli")
	lnIdOper = loConDMO.GetNextID("cc_cli", "idOper")		
	lnIdCliente = Thisform.contenido.sel_Cliente.valcpoid

	&& Inserto el registro correspondiente a la factura en la tabla de cuentas corrientes
	lcSql = "INSERT INTO cc_cli (idCC_Cli, idCliente, idCC_Orig, cbte, nroCbte, tipoDoc, ptoVta, idCondPago, idSitIVA, idVendedor, "
	lcSql = lcSql + "fecEmis, fecVto, impDebe, impHaber, idOper, idVentasC, usuAlta, fecAlta, idHostAlta) VALUES ( "
	lcSql = lcSql + ALLTRIM(STR(lnProxID)) + ", " + ALLTRIM(STR(lnIdCliente)) + ", null, '" + IIF(ALLTRIM(lcCbte) == "PTO", "FC", ALLTRIM(lcCbte)) + "', "
	lcSql = lcSql + ALLTRIM(STR(lnNroCbte)) + ", '" + ALLTRIM(lcTipoDoc) + "', " + ALLTRIM(STR(lnPtoVta)) + ", " + ALLTRIM(STR(lnIdCondPago)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIdSitIVA)) + ", " + ALLTRIM(STR(lnIdVendedor)) + ", " + oDT.toMySql(Thisform.contenido.txtFecEmis.Value) + ", "
	lcSql = lcsql + IIF(INT(VAL(getconfig("SQLSRV"))) = 1, oDT.getDateTime() + " + " + ALLTRIM(STR(thisform.cp_cntdias)), oDT.toMySql(ldFecVto)) + ", " + ALLTRIM(STR(lnTotFact, 10, 2)) + ", 0, " + ALLTRIM(STR(lnIdOper)) + ", " + ALLTRIM(STR(lnIdVentasC)) + ", "
	lcSql = lcSql + "'" + ALLTRIM(gcCodUsu) + "', " + oDT.getDateTime() + ", '" + ALLTRIM(SYS(0)) + "')"

	loCommand.ActiveConnection = loConDMO.ActiveConnection	
	loCommand.CommandText = lcSql
	
	IF !loCommand.Execute()	
		thisform.desbloq_numerador()
		goConn.Rollback()
		RETURN .F.
	ENDIF
ENDIF

&& Ahora tengo que generar la relación entre el comprobante de origen con el comprobante
&& de destino
IF (ALLTRIM(Thisform.Cbte) == "FC") .OR. (ALLTRIM(Thisform.cbte) == "PTO") THEN
	SELECT cur_cbtes
	IF RECCOUNT("cur_cbtes") > 0 THEN
		GO TOP
	ENDIF
	
	DO WHILE !EOF("cur_cbtes")
		IF cur_cbtes.sel THEN
			IF ALLTRIM(thisform.cbte) == "PTO" THEN
				lnProxID = loConDMO.GetNextId("ventasrel", "idVtaRel")
			ELSE
				lnProxID = goConn.GetNextId("ventasrel", "idVtaRel")
			ENDIF
			
			lcSql = "INSERT INTO ventasrel (idVtaRel, idVtaCO, idVtaCD) VALUES ("
			lcSql = lcSql + ALLTRIM(STR(lnProxID)) + ", " + ALLTRIM(STR(cur_cbtes.idVentasC)) + ", " + ALLTRIM(STR(lnIdVentasC)) + ")"
			
			loCommand.CommandText = lcSql

			IF ALLTRIM(lcCbte) == "PTO" 
				loCommand.ActiveConnection = loConDMO.ActiveConnection
				IF !loCommand.Execute()
					thisform.desbloq_numerador()
					loConDMO.Rollback()
					RETURN .F.
				ENDIF	
			ELSE
				loCommand.ActiveConnection = goConn.ActiveConnection
				IF !loCommand.Execute()
					thisform.desbloq_numerador()
					goConn.Rollback()
					RETURN .F.
				ENDIF
			ENDIF
		ENDIF
		
		SELECT cur_cbtes
		SKIP
	ENDDO
ENDIF

************************************************************************************************
* Solo se procede a hacer el grabado de stock si es PTO.
************************************************************************************************
IF getGlobalCFG("STK_MODULE") .AND. (ALLTRIM(Thisform.Cbte) <> "COT" .OR. ALLTRIM(THisform.Cbte) <> "NC") THEN
	IF ALLTRIM(thisform.cbte) == "PTO" THEN
		Thisform.mov_stock.circuito = "S"
		Thisform.mov_stock.tipodoc = ""
		Thisform.mov_stock.cbte = ""
		IF !Thisform.mov_stock.grabar2() THEN
			MESSAGEBOX(Thisform.mov_stock.ErrorMessage, 0+48, Thisform.Caption)
			thisform.desbloq_numerador()
			goConn.Rollback()
			RETURN .F.
		ENDIF
	ENDIF	
ENDIF

IF ALLTRIM(thisform.cbte) == "PTO" THEN
	loConDMO.Commit()
	loConDMO.close()	
ELSE
	goConn.Commit()
ENDIF

thisform.desbloq_numerador()
thisform.id_ventasc = lnIdVentasC

RETURN .T.
ENDPROC
PROCEDURE imprimir
LOCAL m.NroCli, m.RazSoc, m.Telefono, m.direccion, m.localidad, m.codPostal, m.pcia, m.TipoIVA, m.nroCUIT
LOCAL m.Total, m.tipoDoc, m.NroCbte, m.Fecha, m.leyenda, m.fecVto, m.tipoDoc, m.ptoVta
LOCAL m.porDesc1, m.porDesc2, m.porDesc3, m.porDesc4, m.porRec
LOCAL m.impDesc1, m.impDesc2, m.impDesc3, m.impDesc4
LOCAL m.porIIBB, m.impIIBB, m.observ, m.vendedor
LOCAL m.porIVA105, m.impIVA105, m.porIVA21, m.impIVA21, m.impNeto, m.impFinal
LOCAL lcSql, loNumerador, lcPrinterName, lnCantCpia
LOCAL m.cae, m.caevto, lcDia, lcMes, lcAnio
LOCAL m.codigoCbte, m.barcode, m.code, m.condPago
LOCAL lnIdNum, lnResp, m.NroRto, m.nroOC
LOCAL loPDF, lcMailMsg
LOCAL lcNomEmp

loNumerador = CREATEOBJECT("odbc_result")
lcSql = ""
m.NroCli = Thisform.contenido.sel_Cliente.txtCodigo.Value
m.RazSoc = Thisform.contenido.sel_Cliente.txtDescripcion.Value
m.Telefono = ALLTRIM(Thisform.cli_telefono)
m.direccion = ALLTRIM(Thisform.cli_calle)
m.localidad = ALLTRIM(Thisform.cli_localidad)
m.codPostal = ALLTRIM(Thisform.cli_codPostal)
m.pcia = ALLTRIM(Thisform.cli_Pcia)
m.nroCUIT = ALLTRIM(Thisform.contenido.txtCuit.Value)
m.TipoIVA = Thisform.Contenido.txtSitIVA.Value
m.Total = 0.00
m.tipoDoc = ""
m.ptoVta = ""
m.NroCbte = ""
m.leyenda = ""
m.Fecha = Thisform.Contenido.txtFecEmis.Value
m.porIVA105 = 0.00
m.porIVA21 = 0.00
m.impIVA105 = 0.00
m.impIVA21 = 0.00
m.impNeto = 0.00
m.impFinal = 0.00
m.fecVto = Thisform.Contenido.txtFecEmis.Value + thisform.cp_cntdias
m.tipoDoc = Thisform.tipodoc
m.porIIBB = 0.00
m.impIIBB = 0.00
lnCantCpia = 0
m.observ = ""
m.vendedor = thisform.nombre_usuario
m.cae = thisform.aut_cae
m.codigoCbte = REPLICATE("0", 2 - LEN(ALLTRIM(STR(Thisform.codigo_cbte)))) + ALLTRIM(STR(Thisform.codigo_cbte))
m.barcode = ""
m.code = ""
lnIdNum = 0
lnResp = 0
m.NroRto = ""
m.nroOC = Thisform.contenido.txtoc.Value
lcNomEmp = getconfig("NOMEMP")
m.condPago = IIF(This.idCondPago = 1, "CONTADO", "CUENTAS CORRIENTES")

lcAnio = SUBSTR(Thisform.aut_cae_vto, 1, 4)
lcMes = SUBSTR(Thisform.aut_cae_vto, 5, 2)
lcDia = SUBSTR(Thisform.aut_cae_vto, 7, 2)

m.caevto = lcDia + "/" + lcMes + "/" + lcAnio
m.ptovta = INT(VAL(ALLTRIM(getconfig("PTOVTA"))))

&& Levanto el talonario del numerador solo para tomar la configuración de la impresora
lcSql = "select * from numerador where cbte = '" + ALLTRIM(Thisform.cbte) + "' and tipoDoc = '" + ALLTRIM(m.tipoDoc) + "' AND ptoVta = " + ALLTRIM(STR(m.ptoVta))
loNumerador = CREATEOBJECT("odbc_result")
loNumerador.ActiveConnection = goConn.ActiveConnection
loNumerador.Cursor_Name = "cur_num"
loNumerador.OpenQuery(lcSql)

SELECT cur_num
GO TOP
lnIdNum = cur_num.idNum

loNumerador.close_query()

&& Levanto la impresora configurada en el puesto de trabajo actual
lcSql = "SELECT * FROM impresoras WHERE hostName = '" + ALLTRIM(SYS(0)) + "' AND "
lcSql = lcSql + "idNum = " + ALLTRIM(STR(lnIdNum))

loNumerador.ActiveConnection = goConn.ActiveConnection
loNumerador.Cursor_Name = "cur_imp"

IF !loNumerador.OpenQuery(lcSql) THEN
	MESSAGEBOX(loNumerador.Error_Message, 0+48, Thisform.Caption)
	RETURN
ENDIF

SELECT cur_imp
IF RECCOUNT("cur_imp") = 0 THEN
	MESSAGEBOX("La impresora no se encuentra configurada en el puesto de trabajo actual", 0+48, Thisform.Caption)
	loNumerador.Close_Query()
	RETURN
ENDIF

lcPrinterName = ALLTRIM(cur_imp.impresora)
lnCantCpia = cur_imp.copias

loNumerador.Close_Query()

m.NroCbte = REPLICATE("0", 4 - LEN(ALLTRIM(STR(Thisform.ptovta)))) + ALLTRIM(STR(Thisform.ptovta)) + "-" + REPLICATE("0", 8 - LEN(ALLTRIM(STR(Thisform.nrocbte)))) + ALLTRIM(STR(Thisform.nrocbte))

IF ALLTRIM(Thisform.cbte) == "COT"
	m.leyenda = "COTIZACION"
	m.tipoDoc = "X"
	m.Total = cur_Subtotal.totFact
ELSE 
	IF ALLTRIM(Thisform.cbte) == "PTO"
		m.leyenda = "PRESUPUESTO"
		m.tipoDoc = "X"
		m.Total = cur_Subtotal.impFinal
	ELSE
		IF ALLTRIM(Thisform.cbte) == "PED"
			m.leyenda = "NOTA DE PEDIDO"
			m.tipoDoc = "P"
			m.Total = Thisform.contenido.txtTotFact.Value
		ELSE
			IF ALLTRIM(Thisform.Cbte) == "FC"
				m.leyenda = "FACTURA"
				m.Total = cur_Subtotal.totFact
			ELSE
				IF ALLTRIM(Thisform.Cbte) == "NC"
					m.Leyenda = "NOTA DE CREDITO"
					m.Total = cur_Subtotal.totFact
				ELSE
					IF ALLTRIM(Thisform.Cbte) == "ND"
						m.leyenda = "NOTA DE DEBITO"
						m.Total = cur_Subtotal.totFact
					ENDIF
				ENDIF
			ENDIF
		ENDIF
	ENDIF
ENDIF

IF (ALLTRIM(Thisform.cbte) == "NC") .OR. (ALLTRIM(Thisform.cbte) == "FC") .OR. (ALLTRIM(Thisform.cbte) == "PTO") .OR. (ALLTRIM(Thisform.cbte) == "COT") THEN
	m.porDesc1 = cur_Subtotal.porDesc1 
	m.porDesc2 = cur_Subtotal.porDesc2 
	m.porDesc3 = cur_Subtotal.porDesc3 
	m.porDesc4 = cur_Subtotal.porDesc4 
	m.impDesc1 = cur_Subtotal.impDesc1
	m.impDesc2 = cur_Subtotal.impDesc2
	m.impDesc3 = cur_Subtotal.impDesc3
	m.impDesc4 = cur_Subtotal.impDesc4
	m.porIVA105 = cur_Subtotal.porIVA105
	m.porIVA21 = cur_Subtotal.porIVA21
	m.impIVA105 = cur_Subtotal.impIVA105
	m.impIVA21 = cur_Subtotal.impIVA21
	m.impNeto = cur_Subtotal.impFinal
	m.impFinal = cur_Subtotal.impFinal
	m.porIIBB = cur_Subtotal.porIIBB
	m.impIIBB = cur_Subtotal.impIIBB
	m.porRec = cur_Subtotal.porRec
	
	SELECT cur_aux
ELSE 
	m.porDesc1 = Thisform.Contenido.txtDesc1.Value
	m.porDesc2 = Thisform.Contenido.txtDesc2.Value
	m.porDesc3 = Thisform.Contenido.txtDesc3.Value
	m.porDesc4 = Thisform.Contenido.txtDesc4.Value
	m.impDesc1 = Thisform.Contenido.txtImpDesc1.Value
	m.impDesc2 = Thisform.Contenido.txtImpDesc2.Value
	m.impDesc3 = Thisform.Contenido.txtImpDesc3.Value
	m.impDesc4 = Thisform.Contenido.txtImpDesc4.Value
	m.porIVA105 = Thisform.contenido.txtPorIVA105.Value
	m.porIVA21 = Thisform.Contenido.txtPorIVA21.value
	m.impIVA105 = Thisform.Contenido.txtImpIVA105.Value
	m.impIVA21 = Thisform.Contenido.txtImpIVA21.Value
	m.impNeto = Thisform.Contenido.txtST.Value
	m.impFinal = Thisform.Contenido.txtTotFact.Value
	m.porIIBB = Thisform.Contenido.txtPorIIBB.Value
	m.impIIBB = Thisform.Contenido.txtImpIIBB.Value
	m.porRec = Thisform.contenido.txtPorRec.Value
	
	SELECT cur_detalle
ENDIF 

m.observ = thisform.contenido.txtObserv.Value + ""

&& Mando a imprimir los remitos
IF getglobalcfg("PRINT_RTO") THEN
	IF This.cbte <> "COT" THEN
		lnResp = MESSAGEBOX("¿Desea emitir remito?", 32+4, Thisform.Caption)
		IF lnResp = 6 THEN
			IF Thisform.getprinterrto() THEN
				m.NroRto = Thisform.rto_numero
				SET PRINTER TO NAME ALLTRIM(Thisform.rto_printer)
				SELECT cur_aux
			
				FOR i = 1 TO This.rto_cantcpias
					REPORT FORM "rep_rtos.frx" TO PRINTER NOCONSOLE
				NEXT 
			ENDIF
		ENDIF
	ENDIF
ENDIF

&& Generación del código de barra
m.barcode = ALLTRIM(Thisform.cli_cuit)
m.barcode = m.barcode + ALLTRIM(m.codigoCbte)
m.barcode = m.barcode + REPLICATE("0", 4 - LEN(ALLTRIM(STR(m.ptovta)))) + ALLTRIM(STR(m.ptovta))
m.barcode = m.barcode + ALLTRIM(m.cae)
m.barcode = m.barcode + ALLTRIM(lcAnio)
m.barcode = m.barcode + REPLICATE("0", 2 - LEN(ALLTRIM(lcMes))) + ALLTRIM(lcMes)
m.barcode = m.barcode + REPLICATE("0", 2 - LEN(ALLTRIM(lcDia))) + ALLTRIM(lcDia)
m.barcode = m.barcode + ALLTRIM(STR(Thisform.calc_digito_verificador(m.barcode)))
m.code = m.barcode
m.barcode = getcodbarras(m.barcode)

IF thisform.printcbte THEN
	SET PRINTER TO NAME ALLTRIM(lcPrinterName)

	FOR i = 1 TO lnCantCpia 
		IF ALLTRIM(Thisform.tipodoc) == "A" THEN
			&& Imprime el comprobante de tipo "A"
			SELECT cur_aux
			REPORT FORM "repcbtesvta.frx" TO PRINTER NOCONSOLE
		ELSE
			&& Imprime el comprobante de tipo "B"
			SELECT cur_aux
			REPORT FORM "repcbtesvta_b.frx" TO PRINTER NOCONSOLE
		ENDIF
	NEXT
ENDIF

IF thisform.envcbte THEN
	lcFileName = SYS(5) + SYS(2003) + "\wsafip\ComprobantesPDF\" + this.cbte + "_" + m.NroCbte + ".pdf"
	
	loPDF = CREATEOBJECT("Bullzip.PDFPrinterSettings")
		loPDF.SetValue('output', lcFileName)
		loPDF.SetValue('DisableOptionDialog', 'no') 
		loPDF.SetValue('ConfirmOverwrite', 'no')
		loPDF.SetValue('Showsettings', 'never') 
		loPDF.SetValue('ShowSaveAS', 'nofile') 
		loPDF.SetValue('ShowPdf', 'no') 
		loPDF.WriteSettings(.t.)
	
	SET CONSOLE OFF
	SET PRINTER TO NAME("Bullzip PDF Printer")
	IF ALLTRIM(Thisform.tipodoc) == "A" THEN
		&& Imprime el comprobante de tipo "A"
		SELECT cur_aux
		REPORT FORM "repcbtesvta.frx" NOCONSOLE TO PRINTER
	ELSE
		&& Imprime el comprobante de tipo "B"
		SELECT cur_aux
		REPORT FORM "repcbtesvta_b.frx" NOCONSOLE TO PRINTER
	ENDIF
	SET PRINTER TO DEFAULT
	SET CONSOLE ON
	
	WAIT WINDOW "El archivo PDF se está generando, aguarde unos segundos..." NOWAIT
	DO WHILE !FILE(lcFileName)
		
	ENDDO
	
	&&MESSAGEBOX("Archivo generado en " + lcFileName, 0+64, thisform.Caption)
	
	TEXT TO lcMailMsg NOSHOW
	Estimado cliente,
	
	Le adjuntamos el comprobante electrónico de su compra en formato PDF.
	
	Muchas gracias!
	
	
	Saludos cordiales,
	Danilo Ghio
	
	ENDTEXT
	lcMailMsg = lcMailMsg + lcNomEmp

	&& Procedo a hacer el envío de mail
	DO LOCFILE("FoxyPreviewer.App")
	WITH _screen.oFoxyPreviewer	
		.cEmailType = "PDF"
		.nEmailMode = 2
		.cEMailTo = thisform.mailfc
		.cSMTPServer = "smtp.gmail.com"
		.cEmailFrom = lcNomEmp + "<noresponder.linfow@gmail.com>"
		.cEMailSubject = "Comprobante Electrónico " + this.cbte + " " + m.NroCbte
		.nSMTPPort = 465
		.lSMTPUseSSL = .t.
		.cSMTPUserName = "noresponder.linfow@gmail.com"
		.cSMTPPassword = "22ldz904"
		.lReadReceipt  = .F.
		.lPriority = .F.
		.cEmailBody = lcMailMsg
		.SendEmailUsingCDO(lcFileName)
	ENDWITH	
ENDIF

DO FoxyPreviewer.App WITH "Release"
ENDPROC
PROCEDURE validarcampos
LOCAL lnDiasDif
LOCAL loRes
LOCAL lcSql
LOCAL loDT
LOCAL lnPtoVta

lnDiasDif = 0
loRes = CREATEOBJECT("odbc_result")
loDT = CREATEOBJECT("datetime")
lnPtoVta = INT(VAL(ALLTRIM(getconfig("PTOVTA"))))

IF !DODEFAULT() THEN
	RETURN .F.
ENDIF

IF thisform.id_ventasc <> 0 THEN
	MESSAGEBOX("El comprobante ya se ha grabado, dirijase a autorización de comprobantes.", 0+64, Thisform.Caption)
	RETURN .F.
ENDIF

lnDiasDif = DATE() - Thisform.Contenido.txtFecEmis.Value
IF lnDiasDif > 5 THEN
	MESSAGEBOX("Fecha de emisión fuera de rango.", 0+48, Thisform.Caption)
	Thisform.Contenido.txtFecEmis.SetFocus()
	RETURN .F.
ENDIF

IF lnDiasDif < 0 THEN
	MESSAGEBOX("Está intentado emitir facturas con fecha superior a la actual", 0+48, Thisform.Caption)
	Thisform.Contenido.txtFecEmis.SetFocus()
	RETURN .F.
ENDIF

lcSql = "SELECT fecEmision FROM ventascab "
lcSql = lcSql + "WHERE CAST(fecEmision AS DATE) > " + loDT.ToMySql(Thisform.Contenido.txtFecEmis.Value) + " "
lcSql = lcSql + " AND ventascab.ptoVta = " + ALLTRIM(STR(lnPtoVta)) + " "
lcSql = lcSql + " AND ventascab.cbte = 'FC' "
loRes.ActiveConnection = goConn.ActiveConnection
loRes.Cursor_Name = "cur_tmp"
IF !loRes.OpenQuery(lcSql) THEN
	MESSAGEBOX(loRes.Error_Message, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

SELECT cur_tmp
IF RECCOUNT("cur_tmp") > 0 THEN
	MESSAGEBOX("Hay facturas emitidas posterior a la fecha ingresada en el punto de venta: " + ;
		ALLTRIM(STR(lnPtoVta)), 0+48, Thisform.Caption)
	Thisform.Contenido.txtFecEmis.SetFocus()
	loRes.Close_Query()
	RETURN .F.
ENDIF

loRes.Close_Query()

RETURN .T.

ENDPROC


************************************************************
OBJETO: fe
************************************************************
*** PROPIEDADES ***
Top = 492
Left = 624
Height = 24
Width = 36
Name = "fe"

*** METODOS ***


************************************************************
OBJETO: clsformcbtes_fe
************************************************************
*** PROPIEDADES ***
Arial, 0, 9, 5, 15, 12, 32, 3, 0
Arial, 1, 8, 5, 14, 11, 29, 3, 0
Arial, 1, 9, 6, 15, 12, 32, 3, 0

*** METODOS ***


************************************************************
OBJETO: cls_ctrl_salida_ped
************************************************************
*** PROPIEDADES ***
BorderStyle = 2
Height = 571
Width = 946
DoCreate = .T.
Caption = "Control de salida de pedidos"
WindowState = 0
Name = "cls_ctrl_salida_ped"
contenido.Name = "contenido"

*** METODOS ***
PROCEDURE abrir_pedido
LOCAL loRes, lcSql

loRes = CREATEOBJECT("odbc_result")
lcSql = ""
Thisform.contenido.pgf.page2.txtNroPedido.Value = ALLTRIM(cur_pedidos.numCbte)
Thisform.contenido.pgf.page2.txtCliente.Value = ALLTRIM(cur_pedidos.razSoc)

lcSql = "CALL ventasdet_abrirPedido (?idVentasC)"
lcSql = loRes.AddParameter(lcSql, "idVentasC", ALLTRIM(STR(cur_pedidos.idVentasC)), .f., .f.)

SELECT cur_detalle
ZAP

loRes.ActiveConnection = goConn.ActiveConnection
loRes.Cursor_Name = "cur_x"

IF !loRes.OpenQuery(lcSql) THEN
	MESSAGEBOX(loRes.Error_Message, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

SELECT cur_x
GO TOP
DO WHILE !EOF("cur_x")
	SELECT cur_detalle
	APPEND BLANK
	REPLACE cur_detalle.idVentasC WITH cur_x.idVentasC
	REPLACE cur_detalle.idVentasD WITH cur_x.idVentasD ADDITIVE
	REPLACE cur_detalle.idArticulo WITH cur_x.idArticulo ADDITIVE
	REPLACE cur_detalle.codArt WITH cur_x.codArt ADDITIVE
	REPLACE cur_detalle.descripcio WITH cur_x.descripcio ADDITIVE
	REPLACE cur_detalle.cantidad WITH cur_x.cantidad ADDITIVE
	REPLACE cur_detalle.cant_pri1 WITH IIF(ISNULL(cur_x.cant_pri1), 0, cur_x.cant_pri1) ADDITIVE
	REPLACE cur_detalle.cant_pri2 WITH IIF(ISNULL(cur_x.cant_pri2), 0, cur_x.cant_pri2) ADDITIVE
	REPLACE cur_detalle.cant_falt WITH IIF(ISNULL(cur_x.cant_falt), 0, cur_x.cant_falt) ADDITIVE

	SELECT cur_x
	SKIP
ENDDO

loRes.Close_Query()

SELECT cur_detalle
GO TOP

Thisform.Contenido.pgf.page2.grdDetalles.Refresh()
Thisform.Contenido.pgf.page2.SetFocus()
Thisform.Contenido.pgf.page2.grdDetalles.SetFocus()
ENDPROC
PROCEDURE eliminar_faltantes
LOCAL loCommand

loCommand = CREATEOBJECT("odbc_command")
loCommand.CommandText = "CALL faltantes_delete ( ?idVentasC )"
loCommand.AddParameter("idVentasC", ALLTRIM(STR(cur_detalle.idVentasC)), .f., .f.)
loCommand.ActiveConnection = goConn.ActiveConnection
IF !loCommand.Execute() THEN
	MESSAGEBOX(loCommand.ErrorMessage, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF
RETURN .T.
ENDPROC
PROCEDURE grabar_cambios_detalles
LOCAL loCommand

loCommand = CREATEOBJECT("odbc_command")
loCommand.CommandText = "CALL ventasdet_ctrlSalidaGrabar ( " ;
	+ "?idVentasD, " ;
	+ "?idVentasC, " ;
	+ "?cant_pri1, " ;
	+ "?cant_pri2, " ;
	+ "?cant_falt, " ;
	+ "?usuModi,  " ;
	+ "?idHostModi)"
loCommand.AddParameter("idVentasD", ALLTRIM(STR(cur_detalle.idVentasD)), .f., .f.)
loCommand.AddParameter("idVentasC", ALLTRIM(STR(cur_detalle.idVentasC)), .f., .f.)
loCommand.AddParameter("cant_pri1", ALLTRIM(STR(cur_detalle.cant_pri1, 10, 2)), .f., .f.)
loCommand.AddParameter("cant_pri2", ALLTRIM(STR(cur_detalle.cant_pri2, 10, 2)), .f., .f.)
loCommand.AddParameter("cant_falt", ALLTRIM(STR(cur_detalle.cant_falt, 10, 2)), .f., .f.)
loCommand.AddParameter("usuModi", ALLTRIM(gcCodUsu), .t., .f.)
loCommand.AddParameter("idHostModi", ALLTRIM(SYS(0)), .t., .f.)		
loCommand.ActiveConnection = goConn.ActiveConnection	
IF !loCommand.Execute() THEN
	MESSAGEBOX(loCommand.ErrorMessage, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

RETURN .T.

ENDPROC
PROCEDURE grabar_faltantes
LOCAL loCommand

IF cur_detalle.cant_falt > 0 THEN
	loCommand = CREATEOBJECT("odbc_command")
	loCommand.ActiveConnection = goConn.ActiveConnection
	loCommand.CommandText = "CALL faltantes_insert (" ;
		+ "?idArticulo, " ;
		+ "?idCliente, 	" ;
		+ "?idVentasC, 	" ;
		+ "?codArt,		" ;
		+ "0,			" ;
		+ "?cantidad, 	" ;
		+ "0, 			" ;
		+ "null,		" ;
		+ "?usuAlta,	" ;
		+ "?idHostAlta)"
	loCommand.AddParameter("idArticulo", ALLTRIM(STR(cur_detalle.idArticulo)), .f., .f.)
	loCommand.AddParameter("idCliente", ALLTRIM(STR(cur_pedidos.idCliente)), .f., .f.)
	loCommand.AddParameter("idVentasC", ALLTRIM(STR(cur_pedidos.idVentasC)), .f., .f.)
	loCommand.AddParameter("codArt", ALLTRIM(cur_detalle.codArt), .t., .f.)
	loCommand.AddParameter("cantidad", ALLTRIM(STR(cur_detalle.cant_falt, 10, 2)), .f., .f.)
	loCommand.AddParameter("usuAlta", ALLTRIM(gcCodUsu), .t., .f.)
	loCommand.AddParameter("idHostAlta", ALLTRIM(SYS(0)), .t., .f.)
	IF !loCommand.Execute() THEN
		MESSAGEBOX(loCommand.ErrorMessage, 0+48, Thisform.Caption)
		RETURN .F.
	ENDIF
ENDIF
RETURN .T.

ENDPROC
PROCEDURE Load
DODEFAULT()


CREATE CURSOR cur_pedidos ( ;
	idVentasC	int,;
	fecEmision	datetime,;
	idCliente	int,;
	razSoc		varchar(60),;
	cbte		varchar(4),;
	numCbte		varchar(13))
	

CREATE CURSOR cur_detalle (	;
	idVentasC	int,;
	idVentasD	int,;
	idArticulo	int,;
	codArt		varchar(20),;
	descripcio	varchar(100),;
	cantidad	float(10, 2),;
	cant_pri1	float(10, 2),;
	cant_pri2	float(10, 2),;
	cant_falt	float(10, 2))
	
SELECT cur_pedidos
INDEX ON idVentasC TAG idVentasC ASCENDING
INDEX ON cbte TAG cbte ASCENDING
INDEX ON numCbte TAG numCbte ASCENDING
INDEX ON fecEmision TAG fecEmision ASCENDING
INDEX ON idCliente TAG idCliente ASCENDING
INDEX ON razSoc TAG razSoc ASCENDING

ENDPROC
PROCEDURE Init
LOCAL loRes, lcSql

lcSql = ""
loRes = CREATEOBJECT("odbc_result")

lcSql = "CALL ventascab_getControlSalida()"
loRes.ActiveConnection = goConn.ActiveConnection
loRes.Cursor_Name = "cur_x"
IF !loRes.OpenQuery(lcSql) THEN
	MESSAGEBOX(loRes.Error_Message, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF
SELECT cur_pedidos
APPEND FROM DBF("cur_x")

loRes.Close_Query()

SELECT cur_pedidos
GO TOP

SELECT cur_pedidos
Thisform.contenido.pgf.page1.grdPedidos.alias_name = "cur_pedidos"
Thisform.contenido.pgf.page1.grdPedidos.RecordSource = "cur_pedidos"
Thisform.contenido.pgf.page1.grdPedidos.titulos_cabeceras = "Fecha,Cliente,Razón Social,Comp.,Número"
Thisform.contenido.pgf.page1.grdPedidos.list_controlsource = "fecEmision,idCliente,razSoc,cbte,numCbte"
Thisform.contenido.pgf.page1.grdPedidos.lista_ancho_cols = "150,100,300,100,100"
Thisform.contenido.pgf.page1.grdPedidos.generar_grid()

&& Configuro la grilla que contiene el detalle
SELECT cur_detalle
Thisform.Contenido.pgf.page2.grdDetalles.alias_name = "cur_detalle"
Thisform.Contenido.pgf.page2.grdDetalles.RecordSource = "cur_detalle"
Thisform.Contenido.pgf.page2.grdDetalles.titulos_cabeceras = "Código,Descripción,Cantidad,Prioridad 1,Prioridad 2,Faltantes"
Thisform.Contenido.pgf.page2.grdDetalles.list_controlsource = "codArt,descripcio,cantidad,cant_pri1,cant_pri2,cant_falt"
Thisform.Contenido.pgf.page2.grdDetalles.lista_ancho_cols = "100,300,100,100,100,100"
Thisform.Contenido.pgf.page2.grdDetalles.generar_grid()

Thisform.Contenido.pgf.page2.grdDetalles.Columns[4].ReadOnly = .F.
Thisform.Contenido.pgf.page2.grdDetalles.Columns[5].ReadOnly = .F.
Thisform.Contenido.pgf.page2.grdDetalles.Columns[6].ReadOnly = .F.

Thisform.Contenido.pgf.page1.grdPedidos.SetFocus()

RETURN .T.
ENDPROC
PROCEDURE grabar
goConn.BeginTransaction()
IF !thisform.eliminar_faltantes() THEN
	goConn.Rollback()
	RETURN .F.
ENDIF
SELECT cur_detalle
GO TOP
DO WHILE !EOF("cur_detalle")
	IF !thisform.grabar_cambios_detalles() THEN
		goConn.Rollback()
		RETURN .F.
	ENDIF		
	IF !thisform.grabar_faltantes() THEN
		goConn.Rollback()
		RETURN .F.
	ENDIF	
	SELECT cur_detalle
	SKIP
ENDDO
goConn.Commit()

SELECT cur_detalle
ZAP
Thisform.Contenido.pgf.page1.SetFocus()
Thisform.Contenido.pgf.page1.grdPedidos.SetFocus()
RETURN .T.
ENDPROC
PROCEDURE actualizar_cursor
PARAMETERS tnValue, tcTipoCol

LOCAL lnCant
LOCAL lnResp
LOCAL lnTotCant
LOCAL lcTexto

lnCant = 0.00
lnTotCant = 0.00

lnTotCant = cur_detalle.cant_pri1 + cur_detalle.cant_pri2 + cur_detalle.cant_falt
IF lnTotCant = cur_detalle.cantidad THEN
	RETURN .T.
ENDIF

IF ALLTRIM(tcTipoCol) == "p1" THEN
	&& Pasa por acá si la columna que se está modificando
	&& corresponde a prioridad 1
	
	lnCant = cur_detalle.cant_pri2 + cur_detalle.cant_falt
	
	IF lnCant <> 0 THEN
		IF tnValue = cur_detalle.cantidad THEN
			SELECT cur_detalle
			LOCK()
			REPLACE cur_detalle.cant_pri2 WITH 0
			REPLACE cur_detalle.cant_falt WITH 0 ADDITIVE
			UNLOCK
		ELSE
			IF cur_detalle.cant_pri2 <> 0 .AND. cur_detalle.cant_falt <> 0 THEN
				lnResp = MESSAGEBOX("¿Desea restar la cantidad de la columna faltantes?", 4+32, Thisform.Caption)
				
				IF lnResp = 6 THEN	
					SELECT cur_detalle
					LOCK()
					REPLACE cur_detalle.cant_pri2 WITH lnCant - tnValue
					UNLOCK
				ELSE
					SELECT cur_detalle
					LOCK()
					REPLACE cur_detalle.cant_falt WITH lnCant - tnValue
					UNLOCK
				ENDIF
			ELSE
				IF cur_detalle.cant_pri2 <> 0 .AND. cur_detalle.cant_falt = 0 THEN
					SELECT cur_detalle
					LOCK()
					REPLACE cur_detalle.cant_pri2 WITH lnCant - tnValue
					UNLOCK
				ELSE
					SELECT cur_detalle
					LOCK()
					REPLACE cur_detalle.cant_falt WITH lnCant - tnValue
					UNLOCK
				ENDIF		
			ENDIF
		ENDIF
	ENDIF
ELSE
	IF ALLTRIM(tcTipoCol) == "p2" THEN
		&& Pasa por acá si la columna que se está modificando
		&& corresponde a prioridad 2
		lnCant = cur_detalle.cant_pri1 + cur_detalle.cant_falt
		
		IF lnCant <> 0 THEN
			IF tnValue = cur_detalle.cantidad THEN
				SELECT cur_detalle
				LOCK()
				REPLACE cur_detalle.cant_pri1 WITH 0
				REPLACE cur_detalle.cant_falt WITH 0 ADDITIVE
				UNLOCK
			ELSE
				IF cur_detalle.cant_pri1 <> 0 .AND. cur_detalle.cant_falt <> 0 THEN
					lnResp = MESSAGEBOX("¿Desea restar la cantidad de la columna prioridad 1?", 4+32, Thisform.Caption)
					
					IF lnResp = 6 THEN	
						SELECT cur_detalle
						LOCK()
						REPLACE cur_detalle.cant_pri1 WITH cur_detalle.cant_pri1 - tnValue
						UNLOCK
					ELSE
						SELECT cur_detalle
						LOCK()
						REPLACE cur_detalle.cant_falt WITH cur_detalle.cant_falt - tnValue
						UNLOCK
					ENDIF
				ELSE
					IF cur_detalle.cant_pri1 <> 0 .AND. cur_detalle.cant_falt = 0 THEN
						SELECT cur_detalle
						LOCK()
						REPLACE cur_detalle.cant_pri1 WITH cur_detalle.cant_pri1 - tnValue
						UNLOCK
					ELSE
						SELECT cur_detalle
						LOCK()
						REPLACE cur_detalle.cant_falt WITH cur_detalle.cant_falt - tnValue
						UNLOCK
					ENDIF		
				ENDIF
			ENDIF
		ENDIF
	ELSE
		&& Pasa por acá si la columna que se está modificando
		&& corresponde a faltantes
		
		lnCant = cur_detalle.cant_pri1 + cur_detalle.cant_pri2
		
		IF lnCant <> 0 THEN
			IF tnValue = cur_detalle.cantidad THEN
				SELECT cur_detalle
				LOCK()
				REPLACE cur_detalle.cant_pri1 WITH 0
				REPLACE cur_detalle.cant_pri2 WITH 0 ADDITIVE
				UNLOCK
			ELSE
				IF cur_detalle.cant_pri1 <> 0 .AND. cur_detalle.cant_pri2 <> 0 THEN
					lnResp = MESSAGEBOX("¿Desea restar la cantidad de la columna prioridad 1?", 4+32, Thisform.Caption)
					
					IF lnResp = 6 THEN	
						SELECT cur_detalle
						LOCK()
						REPLACE cur_detalle.cant_pri1 WITH cur_detalle.cant_pri1 - tnValue
						UNLOCK
					ELSE
						SELECT cur_detalle
						LOCK()
						REPLACE cur_detalle.cant_pri2 WITH cur_detalle.cant_pri2 - tnValue
						UNLOCK
					ENDIF
				ELSE
					IF cur_detalle.cant_pri1 <> 0 .AND. cur_detalle.cant_pri2 = 0 THEN
						SELECT cur_detalle
						LOCK()
						REPLACE cur_detalle.cant_pri1 WITH cur_detalle.cant_pri1 - tnValue
						UNLOCK
					ELSE
						SELECT cur_detalle
						LOCK()
						REPLACE cur_detalle.cant_pri2 WITH cur_detalle.cant_pri2 - tnValue
						UNLOCK
					ENDIF
				ENDIF
			ENDIF
		ENDIF
	ENDIF
ENDIF

lnTotCant = cur_detalle.cant_pri1 + cur_detalle.cant_pri2 + cur_detalle.cant_falt
IF lnTotCant <> cur_detalle.cantidad THEN
	lcTexto = "La suma de las tres columnas no coincide con la cantidad total, "
	lcTexto = lcTexto + "ingrese las cantidades de las tres columnas nuevamente para evitar errores."
	MESSAGEBOX(lcTexto, 0+48, Thisform.Caption)
	
	SELECT cur_detalle
	LOCK()
	REPLACE cur_detalle.cant_pri1 WITH 0
	REPLACE cur_detalle.cant_pri2 WITH 0 ADDITIVE
	REPLACE cur_detalle.cant_falt WITH 0 ADDITIVE
	UNLOCK
ENDIF

RETURN .T.
ENDPROC


************************************************************
OBJETO: btnCerrar
************************************************************
*** PROPIEDADES ***
Top = 524
Left = 897
Name = "btnCerrar"

*** METODOS ***


************************************************************
OBJETO: pgf
************************************************************
*** PROPIEDADES ***
ErasePage = .T.
Top = 4
Left = 5
Width = 941
Height = 518
Name = "pgf"
Page1.Caption = "Seleccionar pedido"
Page1.Name = "Page1"
Page2.Caption = "Edición de pedidos"
Page2.Name = "Page2"

*** METODOS ***
PROCEDURE Page2.Activate
SELECT cur_pedidos
Thisform.abrir_pedido()
ENDPROC


************************************************************
OBJETO: grdPedidos
************************************************************
*** PROPIEDADES ***
Height = 477
Left = 6
Top = 9
Width = 929
permitir_ordenamiento = .T.
permitir_busqueda = .T.
Name = "grdPedidos"
COLUMN1.Header1.Name = "Header1"
COLUMN1.Text1.Name = "Text1"
COLUMN1.Name = "COLUMN1"
COLUMN2.Header1.Name = "Header1"
COLUMN2.Text1.Name = "Text1"
COLUMN2.Name = "COLUMN2"
COLUMN3.Header1.Name = "Header1"
COLUMN3.Text1.Name = "Text1"
COLUMN3.Name = "COLUMN3"
COLUMN4.Header1.Name = "Header1"
COLUMN4.Text1.Name = "Text1"
COLUMN4.Name = "COLUMN4"
COLUMN5.Header1.Name = "Header1"
COLUMN5.Text1.Name = "Text1"
COLUMN5.Name = "COLUMN5"
COLUMN6.Header1.Name = "Header1"
COLUMN6.Text1.Name = "Text1"
COLUMN6.Name = "COLUMN6"
COLUMN7.Header1.Name = "Header1"
COLUMN7.Text1.Name = "Text1"
COLUMN7.Name = "COLUMN7"
COLUMN8.Header1.Name = "Header1"
COLUMN8.Text1.Name = "Text1"
COLUMN8.Name = "COLUMN8"
COLUMN9.Header1.Name = "Header1"
COLUMN9.Text1.Name = "Text1"
COLUMN9.Name = "COLUMN9"
COLUMN10.Header1.Name = "Header1"
COLUMN10.Text1.Name = "Text1"
COLUMN10.Name = "COLUMN10"
COLUMN11.Header1.Name = "Header1"
COLUMN11.Text1.Name = "Text1"
COLUMN11.Name = "COLUMN11"
COLUMN12.Header1.Name = "Header1"
COLUMN12.Text1.Name = "Text1"
COLUMN12.Name = "COLUMN12"
COLUMN13.Header1.Name = "Header1"
COLUMN13.Text1.Name = "Text1"
COLUMN13.Name = "COLUMN13"
COLUMN14.Header1.Name = "Header1"
COLUMN14.Text1.Name = "Text1"
COLUMN14.Name = "COLUMN14"
COLUMN15.Header1.Name = "Header1"
COLUMN15.Text1.Name = "Text1"
COLUMN15.Name = "COLUMN15"
COLUMN16.Header1.Name = "Header1"
COLUMN16.Text1.Name = "Text1"
COLUMN16.Name = "COLUMN16"
COLUMN17.Header1.Name = "Header1"
COLUMN17.Text1.Name = "Text1"
COLUMN17.Name = "COLUMN17"
COLUMN18.Header1.Name = "Header1"
COLUMN18.Text1.Name = "Text1"
COLUMN18.Name = "COLUMN18"
COLUMN19.Header1.Name = "Header1"
COLUMN19.Text1.Name = "Text1"
COLUMN19.Name = "COLUMN19"
COLUMN20.Header1.Name = "Header1"
COLUMN20.Text1.Name = "Text1"
COLUMN20.Name = "COLUMN20"

*** METODOS ***
PROCEDURE press_enter
SELECT cur_pedidos
Thisform.abrir_pedido()
ENDPROC


************************************************************
OBJETO: grdDetalles
************************************************************
*** PROPIEDADES ***
Height = 394
Left = 6
TabIndex = 3
Top = 38
Width = 924
permitir_busqueda = .F.
permitir_ordenamiento = .F.
Name = "grdDetalles"
COLUMN1.Header1.Name = "Header1"
COLUMN1.Text1.Name = "Text1"
COLUMN1.Name = "COLUMN1"
COLUMN2.Header1.Name = "Header1"
COLUMN2.Text1.Name = "Text1"
COLUMN2.Name = "COLUMN2"
COLUMN3.Header1.Name = "Header1"
COLUMN3.Text1.Name = "Text1"
COLUMN3.Name = "COLUMN3"
COLUMN4.Header1.Name = "Header1"
COLUMN4.Text1.Name = "Text1"
COLUMN4.Name = "COLUMN4"
COLUMN5.Header1.Name = "Header1"
COLUMN5.Text1.Name = "Text1"
COLUMN5.Name = "COLUMN5"
COLUMN6.Header1.Name = "Header1"
COLUMN6.Text1.Name = "Text1"
COLUMN6.Name = "COLUMN6"
COLUMN7.Header1.Name = "Header1"
COLUMN7.Text1.Name = "Text1"
COLUMN7.Name = "COLUMN7"
COLUMN8.Header1.Name = "Header1"
COLUMN8.Text1.Name = "Text1"
COLUMN8.Name = "COLUMN8"
COLUMN9.Header1.Name = "Header1"
COLUMN9.Text1.Name = "Text1"
COLUMN9.Name = "COLUMN9"
COLUMN10.Header1.Name = "Header1"
COLUMN10.Text1.Name = "Text1"
COLUMN10.Name = "COLUMN10"
COLUMN11.Header1.Name = "Header1"
COLUMN11.Text1.Name = "Text1"
COLUMN11.Name = "COLUMN11"
COLUMN12.Header1.Name = "Header1"
COLUMN12.Text1.Name = "Text1"
COLUMN12.Name = "COLUMN12"
COLUMN13.Header1.Name = "Header1"
COLUMN13.Text1.Name = "Text1"
COLUMN13.Name = "COLUMN13"
COLUMN14.Header1.Name = "Header1"
COLUMN14.Text1.Name = "Text1"
COLUMN14.Name = "COLUMN14"
COLUMN15.Header1.Name = "Header1"
COLUMN15.Text1.Name = "Text1"
COLUMN15.Name = "COLUMN15"
COLUMN16.Header1.Name = "Header1"
COLUMN16.Text1.Name = "Text1"
COLUMN16.Name = "COLUMN16"
COLUMN17.Header1.Name = "Header1"
COLUMN17.Text1.Name = "Text1"
COLUMN17.Name = "COLUMN17"
COLUMN18.Header1.Name = "Header1"
COLUMN18.Text1.Name = "Text1"
COLUMN18.Name = "COLUMN18"
COLUMN19.Header1.Name = "Header1"
COLUMN19.Text1.Name = "Text1"
COLUMN19.Name = "COLUMN19"
COLUMN20.Header1.Name = "Header1"
COLUMN20.Text1.Name = "Text1"
COLUMN20.Name = "COLUMN20"

*** METODOS ***
PROCEDURE COLUMN4.Text1.KeyPress
LPARAMETERS nKeyCode, nShiftAltCtrl

IF LASTKEY() = 13 THEN 
	nodefault
	KEYBOARD '{DNARROW}'
ENDIF 


ENDPROC
PROCEDURE COLUMN4.Text1.Valid
*LOCAL lnCant
*
*IF this.Value < 0 THEN
*	MESSAGEBOX("No se puede ingresar valores negativos", 0+48, Thisform.Caption)
*	RETURN .F.
*ENDIF

*lnCant = cur_detalle.cantidad - This.Value
*SELECT cur_detalle
*LOCK()
*REPLACE cur_detalle.cant_pri2 WITH lnCant
*UNLOCK

*This.Parent.Parent.Refresh()
*
*IF lnCant < 0 THEN
*	MESSAGEBOX("La cantidad ingresada no es correcta, prioridad_1 + prioridad_2 debe ser igual a cantidad", 0+48, Thisform.Caption)
*	RETURN .F.
*ENDIF

RETURN Thisform.actualizar_cursor(this.Value, "p1")

* RETURN .T.
ENDPROC
PROCEDURE COLUMN5.Text1.KeyPress
LPARAMETERS nKeyCode, nShiftAltCtrl

IF LASTKEY() = 13 THEN 
	nodefault
	KEYBOARD '{DNARROW}'
ENDIF 


ENDPROC
PROCEDURE COLUMN5.Text1.Valid
*LOCAL lnCant
*
*IF This.Value <> 0 THEN
*	IF cur_detalle.cant_falt > 0 THEN
*		MESSAGEBOX("Atención, tiene cantidad asignada en prioridad 2, se pasará esta cantidad a prioridad 3", 0+64, Thisform.Caption)
*		This.Value = cur_detalle.cant_falt
*		
*		SELECT cur_detalle
*		LOCK()
*		REPLACE cur_detalle.cant_falt WITH 0
*		UNLOCK
*	ENDIF
*
*	lnCant = cur_detalle.cantidad - This.Value
*	SELECT cur_detalle
*	LOCK()
*	REPLACE cur_detalle.cant_pri1 WITH lnCant
*	UNLOCK
*
*	This.Parent.Parent.Refresh()
*
*	IF (This.Value + cur_detalle.cant_pri1) > cur_detalle.cantidad THEN
*		MESSAGEBOX("La cantidad ingresada no es correcta, prioridad_1 + faltantes debe ser igual a cantidad", 0+48, Thisform.Caption)
*		RETURN .F.
*	ENDIF
*ENDIF

*RETURN .T.
RETURN Thisform.actualizar_cursor(this.Value, "p2")
ENDPROC
PROCEDURE COLUMN6.Text1.Valid
*LOCAL lnCant
*
*IF this.Value < 0 THEN
*	MESSAGEBOX("No se puede ingresar valores negativos", 0+48, Thisform.Caption)
*	RETURN .F.
*ENDIF

*IF cur_detalle.cantidad <> 0 THEN
*	lnCant = cur_detalle.cantidad - This.Value
*	
*	SELECT cur_detalle
*	LOCK()
*	REPLACE cur_detalle.cant_pri2 WITH lnCant
*	UNLOCK
*ELSE
*	IF cur_detalle.cant_pri1 <> 0 THEN
*		lnCant = cur_detalle.cant_pri1 - This.Value
*		
*		SELECT cur_detalle
*		LOCK()
*		REPLACE cur_detalle.cant_pri2 WITH lnCant
*		UNLOCK
*	ELSE
*		lnCant = cur_detalle.cant_pri2 - This.Value
*		
*		SELECT cur_detalle
*		LOCK()
*		REPLACE cur_detalle.cant_pri2 WITH lnCant
*		UNLOCK
*	ENDIF
*ENDIF

*This.Parent.Parent.Refresh()

*IF lnCant < 0 THEN
*	MESSAGEBOX("La cantidad ingresada no es correcta, prioridad_1 + prioridad_2 debe ser igual a cantidad", 0+48, Thisform.Caption)
*	RETURN .F.
*ENDIF

*RETURN .T.
RETURN Thisform.actualizar_cursor(this.Value, "falt")
ENDPROC


************************************************************
OBJETO: btnGrabar
************************************************************
*** PROPIEDADES ***
Top = 441
Left = 838
TabIndex = 4
Name = "btnGrabar"

*** METODOS ***
PROCEDURE Click
Thisform.grabar()
ENDPROC


************************************************************
OBJETO: btnCancelar
************************************************************
*** PROPIEDADES ***
Top = 441
Left = 885
TabIndex = 5
Name = "btnCancelar"

*** METODOS ***
PROCEDURE Click
SELECT cur_detalle
ZAP

Thisform.Contenido.pgf.page1.SetFocus()
Thisform.Contenido.pgf.page1.grdPedidos.SetFocus()
ENDPROC


************************************************************
OBJETO: CLSETIQUETA1
************************************************************
*** PROPIEDADES ***
Caption = "Nº Pedido:"
Height = 15
Left = 17
Top = 13
Width = 74
TabIndex = 6
Name = "CLSETIQUETA1"

*** METODOS ***


************************************************************
OBJETO: txtNroPedido
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 93
TabIndex = 1
Top = 10
Width = 226
Name = "txtNroPedido"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta2
************************************************************
*** PROPIEDADES ***
Caption = "Cliente:"
Height = 15
Left = 335
Top = 13
Width = 56
TabIndex = 7
Name = "Clsetiqueta2"

*** METODOS ***


************************************************************
OBJETO: txtCliente
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 388
TabIndex = 2
Top = 10
Width = 542
Name = "txtCliente"

*** METODOS ***


************************************************************
OBJETO: cls_ctrl_salida_ped
************************************************************
*** PROPIEDADES ***
Arial, 0, 9, 5, 15, 12, 32, 3, 0
Arial, 1, 8, 5, 14, 11, 29, 3, 0

*** METODOS ***


************************************************************
OBJETO: clsformcbtes_sf
************************************************************
*** PROPIEDADES ***
BorderStyle = 2
Height = 561
Width = 991
DoCreate = .T.
Comment = ""
Caption = "Ingreso de Comprobantes de Ventas"
MinButton = .T.
Visible = .T.
ClipControls = .T.
WindowState = 0
cbte = 
usar_fiscal = .F.
pciomaydef = .T.
cp_cntdias = 0
sitivacli = 0
saldo_fc = 0.00
idorigen = 0
cli_calle = 
cli_localidad = 
cli_codpostal = 
cli_pcia = 
cli_tipoiva = 
cli_cuit = 
cli_telefono = 
cli_id = 0
printerdevice = 
tipodoc = X
ptovta = 
codivafiscal = 0
fis_numcbte = 0
idpedarch = 0
pr_mayorista = 0.00
pr_minorista = 0.00
pr_oferta = 0.00
nrocbte = 
cant_copias = .F.
saldodeudor = 0.00
pedido_automatica = .F.
unimed = 
nombre_usuario = 
prarti_x = 0.00
nroitem = 0
cli_tipodoc = 
cli_idtipodoc = 0
idnum = 0
codusu = 
rto_printer = 
rto_cantcpias = 0
rto_numero = 0
rto_ptovta = 0
envcbte = .F.
mailfc = 
printcbte = .F.
idcondpago = 0
id_ventasc = 0
idpedcab = 0
Name = "clsformcbtes_sf"
contenido.Top = 0
contenido.Left = 0
contenido.Width = 990
contenido.Height = 574
contenido.TabIndex = 1
contenido.Name = "contenido"

*** METODOS ***
PROCEDURE sumar_items
LOCAL lnTotal, lnTotImpIVA21, lnTotImpIVA105, lnTotRec
LOCAL lnTotNeto, lnSubTotal, lnTotal, lnImpDesc1, lnImpDesc2, lnImpDesc3, lnImpDesc4

lnTotNeto = 0.00
lnTotal = 0.00
lnTotImpIVA21 = 0.00
lnTotImpIVA105 = 0.00
lnSubTotal = 0.00
lnTotRec = 0.00
lnTotRec = 0.00
lnImpDesc1 = 0.00 
lnImpDesc2 = 0.00
lnImpDesc3 = 0.00
lnImpDesc4 = 0.00

SELECT cur_Deta_View
IF RECCOUNT("cur_Deta_View") > 0 THEN
	GO TOP
ENDIF

DO WHILE !EOF()
	lnTotNeto = lnTotNeto + ROUND(cur_Deta_View.prArtic * cur_Deta_View.cantidad, 2)
	lnImpDesc1 = lnImpDesc1 + ROUND(cur_Deta_View.iDtoCli1 * cur_Deta_View.cantidad, 2)
	lnImpDesc2 = lnImpDesc2 + ROUND(cur_Deta_View.iDtoCli2 * cur_Deta_View.cantidad, 2)
	lnImpDesc3 = lnImpDesc3 + ROUND(cur_Deta_View.iDtoCli3 * cur_Deta_View.cantidad, 2)
	lnImpDesc4 = lnImpDesc4 + ROUND(cur_Deta_View.iDtoCli4 * cur_Deta_View.cantidad, 2)
	lnTotRec = lnTotRec + ROUND(cur_Deta_View.iRecVta * cur_Deta_View.cantidad, 2)
	lnSubTotal = lnSubTotal + cur_Deta_View.totNeto
	lnTotal = lnTotal + cur_Deta_View.SubTotal
		
	IF cur_Deta_View.alicIVA = 21
		Thisform.contenido.txtPorIVA21.Value = cur_Deta_View.alicIVA
		lnTotImpIVA21 = lnTotImpIVA21 + cur_Deta_View.impIVA
	ELSE
		IF cur_Deta_View.alicIVA = 10.5
			Thisform.contenido.txtPorIVA105.Value = cur_Deta_View.alicIVA
			lnTotImpIVA105 = lnTotImpIVA105 + cur_Deta_View.impIVA
		ENDIF
	ENDIF

	SELECT cur_Deta_View
	SKIP
ENDDO

Thisform.Contenido.txtImpDesc1.Value = ROUND(lnImpDesc1, 2) 
Thisform.Contenido.txtImpDesc2.Value = ROUND(lnImpDesc2, 2)
Thisform.Contenido.txtImpDesc3.Value = ROUND(lnImpDesc3, 2)
Thisform.Contenido.txtImpDesc4.Value = ROUND(lnImpDesc4, 2)
Thisform.contenido.txtImpRec.Value = ROUND(lnTotRec, 2)
Thisform.contenido.txtTotNeto.Value = ROUND(lnTotNeto, 2)
Thisform.contenido.txtST.Value = ROUND(lnSubTotal, 2)
Thisform.contenido.txtTotal.Value = ROUND(lnTotal, 2)
Thisform.contenido.txtImpIVA105.Value = ROUND(lnTotImpIVA105, 2)
Thisform.contenido.txtImpIVA21.Value = ROUND(lnTotImpIVA21, 2)
Thisform.contenido.txtTotFact.Value = ROUND(lnSubTotal + lnTotImpIVA21 + lnTotImpIVA105, 2)

SELECT cur_Deta_View
IF RECCOUNT() > 0
	GO TOP
ENDIF

ENDPROC
PROCEDURE blanquear
Thisform.id_ventasc = 0
Thisform.Contenido.sel_Cliente.blanquear()
thisform.contenido.sel_Cliente.valcpoid = 0
Thisform.contenido.txtcuit.Value = ""
Thisform.Contenido.txtSitIVA.Value = ""
Thisform.conteNIDO.txttelefono.Value = ""
Thisform.Contenido.sel_FormaPago.blanquear()
Thisform.contenido.sel_Articulo.blanquear()
Thisform.contenido.sel_Articulo.valcpoid = 0
Thisform.Contenido.txtCantidad.Value = 0.00
Thisform.Contenido.txtPrMay.Value = 0.00
Thisform.Contenido.txtPrMinorista.Value = 0.00
Thisform.Contenido.txtDesc1.Value = 0.00
Thisform.Contenido.txtDesc2.Value = 0.00
Thisform.Contenido.txtDesc3.Value = 0.00
Thisform.Contenido.txtDesc4.Value = 0.00
Thisform.Contenido.txtImpDesc1.Value = 0.00
Thisform.Contenido.txtImpDesc2.Value = 0.00
Thisform.Contenido.txtImpDesc3.Value = 0.00
Thisform.Contenido.txtImpDesc4.Value = 0.00
Thisform.contenido.txtPorDesc1.Value = 0.00
Thisform.contenido.txtPorDesc2.Value = 0.00
Thisform.contenido.txtPorDesc3.Value = 0.00
Thisform.contenido.txtPorDesc4.Value = 0.00
Thisform.contenido.txtImpDescItem1.Value = 0.00
Thisform.contenido.txtImpDescItem2.Value = 0.00
Thisform.contenido.txtImpDescItem3.Value = 0.00
Thisform.contenido.txtImpDescItem4.Value = 0.00
Thisform.contenido.txtPorRecItem.Value = 0.00
Thisform.contenido.txtPrNeto.Value = 0.00
Thisform.contenido.txtSTNeto.Value = 0.00
Thisform.Contenido.txtAlicIVA.Value = 0.00
Thisform.contenido.txtImpIva.Value = 0.00
Thisform.Contenido.txtSubTotal.Value = 0.00
Thisform.contenido.txtporrec.Value = 0.00
Thisform.contenido.txtimprec.Value = 0.00
Thisform.contenido.txtrecItem.Value = 0.00

Thisform.Contenido.txtTotNeto.Value = 0.00
Thisform.Contenido.txtTotal.Value = 0.00
Thisform.contenido.txtST.Value = 0.00
Thisform.Contenido.txtPorIVA21.Value = 0.00
Thisform.Contenido.txtPorIVA105.Value = 0.00
Thisform.Contenido.txtPorIIBB.Value = 0.00
Thisform.Contenido.txtImpIVA21.Value = 0.00
Thisform.Contenido.txtImpIVA105.Value = 0.00
Thisform.Contenido.txtImpIIBB.Value = 0.00
Thisform.Contenido.txtTotFact.Value = 0.00
Thisform.Contenido.txtOC.Value = 0

thisform.pedido_automatica = .F.
Thisform.Contenido.txtObserv.Value = ""
thisform.contenido.txtFecEmis.Value = DATE()

SELECT cur_Detalle
ZAP
Thisform.Contenido.grdDetalles.Refresh()
Thisform.contenido.btnCbteOrigen.Enabled = .T.
Thisform.Contenido.sel_Cliente.txtCodigo.SetFocus()
Thisform.mov_stock.limpiar()

SELECT cur_Deta_View
ZAP

SELECT cur_DetPart
ZAP

SELECT cur_cbtes
ZAP

ENDPROC
PROCEDURE imprimir
LOCAL m.NroCli, m.RazSoc, m.Telefono, m.direccion, m.localidad, m.codPostal, m.pcia, m.TipoIVA, m.nroCUIT
LOCAL m.Total, m.tipoDoc, m.NroCbte, m.Fecha, m.leyenda, m.fecVto, m.tipoDoc, m.ptoVta
LOCAL m.porDesc1, m.porDesc2, m.porDesc3, m.porDesc4, m.porRec
LOCAL m.impDesc1, m.impDesc2, m.impDesc3, m.impDesc4
LOCAL m.porIIBB, m.impIIBB, m.observ, m.vendedor, m.condPago
LOCAL m.porIVA105, m.impIVA105, m.porIVA21, m.impIVA21, m.impNeto, m.impFinal
LOCAL m.NroRto, m.nroOC
LOCAL lcSql, loNumerador, lcPrinterName, lnCantCpia
LOCAL llEnvMail

loNumerador = CREATEOBJECT("odbc_result")
lcSql = ""
m.NroCli = Thisform.contenido.sel_Cliente.txtCodigo.Value
m.RazSoc = Thisform.contenido.sel_Cliente.txtDescripcion.Value
m.Telefono = ALLTRIM(Thisform.cli_telefono)
m.direccion = ALLTRIM(Thisform.cli_calle)
m.localidad = ALLTRIM(Thisform.cli_localidad)
m.codPostal = ALLTRIM(Thisform.cli_codPostal)
m.pcia = ALLTRIM(Thisform.cli_Pcia)
m.nroCUIT = ALLTRIM(Thisform.contenido.txtCuit.Value)
m.TipoIVA = Thisform.Contenido.txtSitIVA.Value
m.Total = 0.00
m.tipoDoc = ""
m.ptoVta = ""
m.NroCbte = ""
m.leyenda = ""
m.Fecha = DATETIME()
m.porIVA105 = 0.00
m.porIVA21 = 0.00
m.impIVA105 = 0.00
m.impIVA21 = 0.00
m.impNeto = 0.00
m.impFinal = 0.00
m.fecVto = DATE() + thisform.cp_cntdias
m.tipoDoc = Thisform.tipodoc
m.porIIBB = 0.00
m.impIIBB = 0.00
lnCantCpia = 0
m.observ = ""
m.vendedor = thisform.nombre_usuario
m.NroRto = ""
m.nroOC = Thisform.contenido.txtoc.Value
m.porRec = Thisform.Contenido.txtPorRec.Value
m.condPago = IIF(This.idCondPago = 1, "CONTADO", "CUENTAS CORRIENTES")

m.NroCbte = Thisform.ptovta + "-" + Thisform.nrocbte

&& Levanto la configuración de impresora para este puesto de trabajo

lcSql = "SELECT * FROM impresoras "
lcSql = lcSql + "WHERE hostName = '" + ALLTRIM(SYS(0)) + "' "
lcSql = lcSql + "	AND idNum = " + ALLTRIM(STR(Thisform.idNum))

loNumerador.ActiveConnection = goConn.ActiveConnection
loNumerador.Cursor_Name = "cur_num"

IF !loNumerador.OpenQuery(lcSql) THEN
	MESSAGEBOX(loNumerador.Error_Message, 0+48, Thisform.Caption)
	RETURN
ENDIF

SELECT cur_num
IF RECCOUNT("cur_num") = 0 THEN
	MESSAGEBOX("No hay impresora configurada para este puesto de trabajo", 0+48, Thisform.Caption)
	loNumerador.Close_Query()
	RETURN
ENDIF

lcPrinterName = ALLTRIM(cur_Num.impresora)
lnCantCpia = cur_Num.copias

loNumerador.Close_Query()

IF ALLTRIM(Thisform.cbte) == "COT"
	m.leyenda = "COTIZACION"
	m.tipoDoc = "X"
	m.Total = cur_Subtotal.totFact
ELSE 
	IF ALLTRIM(Thisform.cbte) == "PTO"
		m.leyenda = "PRESUPUESTO"
		m.tipoDoc = "X"
		m.Total = cur_Subtotal.impFinal
	ELSE
		IF ALLTRIM(Thisform.cbte) == "PED"
			m.leyenda = "NOTA DE PEDIDO"
			m.tipoDoc = "P"
			m.Total = Thisform.contenido.txtTotFact.Value
		ELSE
			IF ALLTRIM(Thisform.Cbte) == "FC"
				m.leyenda = "FACTURA"
				m.Total = cur_Subtotal.totFact
			ELSE
				IF ALLTRIM(Thisform.Cbte) == "NC"
					m.Leyenda = "NOTA DE CREDITO"
					m.Total = cur_Subtotal.totFact
				ELSE
					IF ALLTRIM(Thisform.Cbte) == "ND"
						m.leyenda = "NOTA DE DEBITO"
						m.Total = cur_Subtotal.totFact
					ENDIF
				ENDIF
			ENDIF
		ENDIF
	ENDIF
ENDIF 

IF (ALLTRIM(Thisform.cbte) == "NC") .OR. (ALLTRIM(Thisform.cbte) == "FC") .OR. (ALLTRIM(Thisform.cbte) == "PTO") .OR. (ALLTRIM(Thisform.cbte) == "COT") THEN
	m.porDesc1 = cur_Subtotal.porDesc1 
	m.porDesc2 = cur_Subtotal.porDesc2 
	m.porDesc3 = cur_Subtotal.porDesc3 
	m.porDesc4 = cur_Subtotal.porDesc4 
	m.impDesc1 = cur_Subtotal.impDesc1
	m.impDesc2 = cur_Subtotal.impDesc2
	m.impDesc3 = cur_Subtotal.impDesc3
	m.impDesc4 = cur_Subtotal.impDesc4
	m.porIVA105 = cur_Subtotal.porIVA105
	m.porIVA21 = cur_Subtotal.porIVA21
	m.impIVA105 = cur_Subtotal.impIVA105
	m.impIVA21 = cur_Subtotal.impIVA21
	m.impNeto = cur_Subtotal.impFinal
	m.impFinal = cur_Subtotal.impFinal
	m.porIIBB = cur_Subtotal.porIIBB
	m.impIIBB = cur_Subtotal.impIIBB
	
	SET PRINTER TO NAME ALLTRIM(lcPrinterName)
	SELECT cur_aux
ELSE 
	m.porDesc1 = Thisform.Contenido.txtDesc1.Value
	m.porDesc2 = Thisform.Contenido.txtDesc2.Value
	m.porDesc3 = Thisform.Contenido.txtDesc3.Value
	m.porDesc4 = Thisform.Contenido.txtDesc4.Value
	m.impDesc1 = Thisform.Contenido.txtImpDesc1.Value
	m.impDesc2 = Thisform.Contenido.txtImpDesc2.Value
	m.impDesc3 = Thisform.Contenido.txtImpDesc3.Value
	m.impDesc4 = Thisform.Contenido.txtImpDesc4.Value
	m.porIVA105 = Thisform.contenido.txtPorIVA105.Value
	m.porIVA21 = Thisform.Contenido.txtPorIVA21.value
	m.impIVA105 = Thisform.Contenido.txtImpIVA105.Value
	m.impIVA21 = Thisform.Contenido.txtImpIVA21.Value
	m.impNeto = Thisform.Contenido.txtST.Value
	m.impFinal = Thisform.Contenido.txtTotFact.Value
	m.porIIBB = Thisform.Contenido.txtPorIIBB.Value
	m.impIIBB = Thisform.Contenido.txtImpIIBB.Value
	
	SET PRINTER TO NAME ALLTRIM(lcPrinterName)
	SELECT cur_detalle
ENDIF 

IF !(TYPE("thisform.contenido.txtObserv.Value") == "C") THEN
	m.observ = ""
ELSE
	m.observ = thisform.contenido.txtObserv.Value + " "
ENDIF

&& Mando a imprimir los remitos
IF getglobalcfg("PRINT_RTO") THEN
	IF This.cbte <> "COT" .AND. This.cbte <> "PED" THEN
		lnResp = MESSAGEBOX("¿Desea emitir remito?", 32+4, Thisform.Caption)
		IF lnResp = 6 THEN
			IF Thisform.getprinterrto() THEN
				m.NroRto = Thisform.rto_numero
				SET PRINTER TO NAME ALLTRIM(Thisform.rto_printer)
				SELECT cur_aux
			
				FOR i = 1 TO This.rto_cantcpias
					REPORT FORM "rep_rtos.frx" TO PRINTER NOCONSOLE
				NEXT 
			ENDIF
		ENDIF
	ENDIF
ENDIF

FOR i = 1 TO lnCantCpia
	SET PRINTER TO NAME ALLTRIM(lcPrinterName)
	
	IF (this.cbte == "COT") THEN
		&& Imprime una cotizacion
		SELECT cur_aux
		REPORT FORM "repcot.frx" TO PRINTER NOCONSOLE
	ELSE
		IF (this.cbte == "PTO") THEN
			&& Imprime un presupuesto
			SELECT cur_aux
			REPORT FORM "reppto.frx" TO PRINTER NOCONSOLE			
		ELSE
			&& Si el comprobante es "PED" entonces, tiene que enviar a imprimir una nota de pedido
			IF ALLTRIM(Thisform.cbte) == "PED" THEN
				SET PRINTER TO NAME ALLTRIM(lcPrinterName)
				SELECT cur_detalle
				m.observ = Thisform.contenido.txtObserv.Value
				REPORT FORM "reppedido.frx" TO PRINTER NOCONSOLE
			ELSE 
				IF ALLTRIM(Thisform.tipodoc) == "A" THEN
					&& Imprime el comprobante de tipo "A"
					SELECT cur_aux
					REPORT FORM "repcbtesvta.frx" TO PRINTER NOCONSOLE
				ELSE
					&& Imprime el comprobante de tipo "B"
					SELECT cur_aux
					REPORT FORM "repcbtesvta_b.frx" TO PRINTER NOCONSOLE
				ENDIF
			ENDIF
		ENDIF
	ENDIF
NEXT

IF TYPE("Thisform.Contenido.chkEnviarMail.Value") == "L" THEN
	llEnvMail = Thisform.Contenido.chkEnviarMail.Value
ELSE
	IF Thisform.Contenido.chkEnviarMail.Value = 1 THEN
		llEnvMail = .T.
	ELSE
		llEnvMail = .F.
	ENDIF
ENDIF

IF llEnvMail THEN
	IF (this.cbte == "COT") THEN
		&& Imprime una cotizacion
		SELECT cur_aux
		=enviar_cbtemail("repcot.frx", ALLTRIM(Thisform.cbte),;
				m.tipoDoc, m.NroCbte, ALLTRIM(Thisform.Contenido.txtMailFC.Value),;
				m.Fecha, m.nroCli, m.razSoc, m.direccion, m.codPostal,;
				m.localidad, m.pcia, m.tipoIVA, m.fecVto, m.nroCUIT	,;
				m.nroOC, m.leyenda, m.impNeto, m.Total, m.impIVA21,;
				m.impIVA105, m.porIIBB, m.impIIBB, m.Total, m.observ)
	ELSE
		IF (this.cbte == "PTO") THEN
			&& Imprime un presupuesto
			SELECT cur_aux
			enviar_cbtemail("reppto.frx",  ALLTRIM(Thisform.cbte),;
					m.tipoDoc, m.NroCbte, ALLTRIM(Thisform.Contenido.txtMailFC.Value),;
					m.Fecha, m.nroCli, m.razSoc, m.direccion, m.codPostal,;
					m.localidad, m.pcia, m.tipoIVA, m.fecVto, m.nroCUIT	,;
					m.nroOC, m.leyenda, m.impNeto, m.Total, m.impIVA21,;
					m.impIVA105, m.porIIBB, m.impIIBB, m.Total, m.observ)
		ELSE
			&& Si el comprobante es "PED" entonces, tiene que enviar a imprimir una nota de pedido
			IF ALLTRIM(Thisform.cbte) == "PED" THEN
				SET PRINTER TO NAME ALLTRIM(lcPrinterName)
				SELECT cur_detalle
				m.observ = Thisform.contenido.txtObserv.Value
				enviar_cbtemail("reppedido.frx",  ALLTRIM(Thisform.cbte),;
						m.tipoDoc, m.NroCbte, ALLTRIM(Thisform.Contenido.txtMailFC.Value),;
						m.Fecha, m.nroCli, m.razSoc, m.direccion, m.codPostal,;
						m.localidad, m.pcia, m.tipoIVA, m.fecVto, m.nroCUIT	,;
						m.nroOC, m.leyenda, m.impNeto, m.Total, m.impIVA21,;
						m.impIVA105, m.porIIBB, m.impIIBB, m.Total, m.observ)
			ELSE 
				IF ALLTRIM(Thisform.tipodoc) == "A" THEN
					&& Imprime el comprobante de tipo "A"
					SELECT cur_aux
					enviar_cbtemail("repcbtesvta.frx",  ALLTRIM(Thisform.cbte),;
							m.tipoDoc, m.NroCbte, ALLTRIM(Thisform.Contenido.txtMailFC.Value),;
							m.Fecha, m.nroCli, m.razSoc, m.direccion, m.codPostal,;
							m.localidad, m.pcia, m.tipoIVA, m.fecVto, m.nroCUIT	,;
							m.nroOC, m.leyenda, m.impNeto, m.Total, m.impIVA21,;
							m.impIVA105, m.porIIBB, m.impIIBB, m.Total, m.observ)
				ELSE
					&& Imprime el comprobante de tipo "B"
					SELECT cur_aux
					enviar_cbtemail("repcbtesvta_b.frx",  ALLTRIM(Thisform.cbte),;
							m.tipoDoc, m.NroCbte, ALLTRIM(Thisform.Contenido.txtMailFC.Value),;
							m.Fecha, m.nroCli, m.razSoc, m.direccion, m.codPostal,;
							m.localidad, m.pcia, m.tipoIVA, m.fecVto, m.nroCUIT	,;
							m.nroOC, m.leyenda, m.impNeto, m.Total, m.impIVA21,;
							m.impIVA105, m.porIIBB, m.impIIBB, m.Total, m.observ)
				ENDIF
			ENDIF
		ENDIF
	ENDIF
ENDIF
ENDPROC
PROCEDURE calcular_tipodoc
LOCAL lnSitIVACli

lnSitIvaEmp = 0
lnSitIvaEmp = VAL(ALLTRIM(getConfig("SITIVAEMP")))

IF lnSitIvaEmp = 1 .AND. Thisform.sitivacli = 1 THEN
	RETURN "A"
ENDIF

IF lnSitIvaEmp = 1 .AND. Thisform.sitivacli = 2 THEN
	RETURN "B"
ENDIF

IF lnSitIvaEmp = 1 .AND. Thisform.sitivacli = 3 THEN
	RETURN "B"
ENDIF

IF lnSitIvaEmp = 1 .AND. Thisform.sitivacli = 5 THEN
	RETURN "B"
ENDIF

IF lnSitIvaEmp = 1 .AND. Thisform.sitivacli = 6 THEN
	RETURN "B"
ENDIF

IF lnSitIvaEmp = 1 .AND. Thisform.sitivacli = 7 THEN
   	RETURN "B"
ENDIF

IF lnSitIvaEmp = 6 THEN
	RETURN "C"
ENDIF

ENDPROC
PROCEDURE recuperar_fc
&& Este método permite recuperar la factura a la que se le va 
&& a aplicar la nota de crédito

LOCAL lcSql, loResult, loResArt, lcCodArt, lcDescripcio

loResult = CREATEOBJECT("odbc_result")
loResArt = CREATEOBJECT("odbc_result")
lcSql = ""

&& Levanto el detalle del comprobante filtrando los ítems que son válidos para
&& hacerle Nota de crédito
lcSql = "SELECT * FROM ventasdet WHERE idVentasC = " + ALLTRIM(STR(Thisform.idorigen)) + " "
lcSql = lcSql + " AND (ventasdet.Cantidad - ventasdet.cantNC) <> 0"

loResult.ActiveConnection = goConn.ActiveConnection
loResult.cursor_name = "cur_Vtas"
loResult.OpenQuery(lcSql)

SELECT cur_Vtas
IF RECCOUNT("cur_Vtas") > 0 THEN 
	GO TOP 
ELSE 
	MESSAGEBOX("Esta Factura ya no posee items a los cuales se les pueda aplicar Nota de Crédito.",0+48,thisform.Caption)
	loResult.Close_Query()
	RETURN 
ENDIF 

SELECT cur_Vtas
DO WHILE !EOF("cur_Vtas")
	lcSql = "SELECT * FROM articulos WHERE idArticulo = " + ALLTRIM(STR(cur_Vtas.idArticulo))
	loResArt.ActiveConnection = goConn.ActiveConnection
	loResArt.cursor_name = "cur_artic"
	
	IF !loResArt.OpenQuery(lcSql)
		MESSAGEBOX(loResArt.error_message, 0+48, Thisform.Caption)
		RETURN .F.
	ENDIF
	
	SELECT cur_artic
	IF RECCOUNT("cur_artic") > 0 THEN 
		GO TOP 
	ENDIF  
	
	SELECT cur_artic
	lcCodArt = cur_artic.codArt
	lcDescripcio = cur_artic.descripcio
	
	loResArt.Close_Query()

	SELECT cur_Deta_View
	APPEND BLANK
	REPLACE cur_Deta_View.idDetalle	WITH cur_Vtas.idVentasD
	REPLACE cur_Deta_View.idArticulo 	WITH cur_Vtas.idArticulo ADDITIVE
	REPLACE cur_Deta_View.codArt 		WITH lcCodArt ADDITIVE
	REPLACE cur_Deta_View.descripcio 	WITH lcDescripcio ADDITIVE
	REPLACE cur_Deta_View.cantidad 	WITH cur_Vtas.cantidad - cur_Vtas.cantNC ADDITIVE
	REPLACE cur_Deta_View.prVta		WITH cur_Vtas.prVenta ADDITIVE
	REPLACE cur_Deta_View.pDtoVta1	WITH cur_Vtas.pDtoVta1 ADDITIVE 
	REPLACE cur_Deta_View.pDtoVta2	WITH cur_Vtas.pDtoVta2 ADDITIVE 
	REPLACE cur_Deta_View.pDtoVta3	WITH cur_Vtas.pDtoVta3 ADDITIVE 
	REPLACE cur_Deta_View.pDtoVta4	WITH cur_Vtas.pDtoVta4 ADDITIVE 
	REPLACE cur_Deta_View.iDtoVta1	WITH cur_Vtas.iDtoVta1 ADDITIVE 
	REPLACE cur_Deta_View.iDtoVta2	WITH cur_Vtas.iDtoVta2 ADDITIVE 
	REPLACE cur_Deta_View.iDtoVta3	WITH cur_Vtas.iDtoVta3 ADDITIVE 
	REPLACE cur_Deta_View.iDtoVta4	WITH cur_Vtas.iDtoVta4 ADDITIVE 
	REPLACE cur_Deta_View.pDtoCli1	WITH cur_Vtas.porDesc1 ADDITIVE 
	REPLACE cur_Deta_View.pDtoCli2	WITH cur_Vtas.porDesc2 ADDITIVE 
	REPLACE cur_Deta_View.pDtoCli3	WITH cur_Vtas.porDesc3 ADDITIVE 
	REPLACE cur_Deta_View.pDtoCli4	WITH cur_Vtas.porDesc4 ADDITIVE 
	REPLACE cur_Deta_View.iDtoCli1	WITH cur_Vtas.impDesc1 ADDITIVE 
	REPLACE cur_Deta_View.iDtoCli2	WITH cur_Vtas.impDesc2 ADDITIVE 
	REPLACE cur_Deta_View.iDtoCli3	WITH cur_Vtas.impDesc3 ADDITIVE 
	REPLACE cur_Deta_View.iDtoCli4	WITH cur_Vtas.impDesc4 ADDITIVE 
	REPLACE cur_Deta_View.alicIVA 	WITH cur_Vtas.alicIVA ADDITIVE
	REPLACE cur_Deta_View.impIVA 	WITH cur_Vtas.impIVA ADDITIVE
	REPLACE cur_Deta_View.impNeto 	WITH cur_Vtas.impNeto ADDITIVE
	REPLACE cur_Deta_View.totNeto 	WITH cur_Vtas.totNeto ADDITIVE
	REPLACE cur_Deta_View.subTotal 	WITH cur_Vtas.subTotal ADDITIVE
	REPLACE cur_Deta_View.esOferta 	WITH cur_Vtas.esOferta ADDITIVE
	REPLACE cur_Deta_View.prArtic	WITH cur_Vtas.prArtic ADDITIVE	
	REPLACE cur_Deta_View.pRecVta 	WITH cur_Vtas.pRecVta ADDITIVE 
	REPLACE cur_Deta_View.iRecVta	WITH cur_Vtas.iRecVta ADDITIVE
	
	IF getGlobalCFG("STK_MODULE") THEN
		********************************************************************************************
		* Agrego el item al detalle de stock
		********************************************************************************************
		IF !Thisform.mov_Stock.agregar_articulo(cur_Vtas.idArticulo, cur_Vtas.cantidad - cur_Vtas.cantNC) THEN
			MESSAGEBOX(Thisform.mov_stock.ErrorMessage, 0+48, Thisform.Caption)
			loResult.Close_Query()
			RETURN .F.
		ENDIF

	ENDIF
		
	SELECT cur_Vtas
	SKIP
ENDDO

loResult.Close_Query()

SELECT cur_Deta_View
IF RECCOUNT("cur_Deta_View") > 0 THEN
	GO TOP
ENDIF

Thisform.contenido.txtdesc1.Value = cur_Deta_View.pDtoCli1
Thisform.contenido.txtdesc2.Value = cur_Deta_View.pDtoCli2
Thisform.contenido.txtdesc3.Value = cur_Deta_View.pDtoCli3
Thisform.contenido.txtdesc4.Value = cur_Deta_View.pDtoCli4
Thisform.contenido.txtporrec.Value = cur_Deta_View.pRecVta

Thisform.Contenido.grdDetalles.Refresh()
Thisform.sumar_items()
Thisform.calcular_ret_iibb()

Thisform.recalcular_todo()
RETURN .T.
ENDPROC
PROCEDURE calcular_ret_iibb
&& Calculo el importe de percepción de ingresos brutos y lo anexo al total
IF (ALLTRIM(Thisform.cbte) == "PTO") THEN
	Thisform.Contenido.txtImpIIBB.Value = 0.00
ELSE 
	Thisform.Contenido.txtImpIIBB.Value = ROUND(Thisform.Contenido.txtST.Value * (Thisform.Contenido.txtPorIIBB.Value / 100), 2)
	Thisform.Contenido.txtTotFact.Value = Thisform.Contenido.txtTotFact.Value + Thisform.Contenido.txtImpIIBB.Value
ENDIF 

ENDPROC
PROCEDURE importar_pedido
LOCAL lcFileName, loExcel, lnFilas, loFormPed
LOCAL lnIndex, loResult, lcSql, llOk, loSoapCli
LOCAL lnTotItem, i, lcReg, loProgress, lnPrecio, lnPrVta
LOCAL lnPDtoCli1, lnPDtoCli2, lnPDtoCli3, lnPDtoCli4
LOCAL lnIDtoCli1, lnIDtoCli2, lnIDtoCli3, lnIDtoCli4
LOCAL loSoap
LOCAL lcMensaje, lcSalto
LOCAL lnPorRec, lnImpRec, lnImpNeto

IF Thisform.Contenido.sel_Cliente.txtCodigo.Value = 0
	MESSAGEBOX("Debe ingresar el cliente para poder importar el pedido", 0+48, Thisform.Caption)
	Thisform.Contenido.sel_Cliente.txtCodigo.SetFocus()
	RETURN .F.
ENDIF

lcFileName = ""
lnFilas = 0
lnIndex = 0
lcSql = ""
llOk = .T.
loResult = CREATEOBJECT("odbc_Result")
loFormPed = CREATEOBJECT("cls_busca_pedido_sf")
lnTotItem = 0
loProgress = CREATEOBJECT("_thermometer")
lcSalto = CHR(13) + CHR(10)
lcMensaje = "Cliente: " + ALLTRIM(getConfig("NOMEMP")) ;
		+ " - HostName: " + ALLTRIM(SYS(0)) + " - Usuario: " ;
		+ ALLTRIM(gcCodUsu) + lcSalto + lcSalto
lnPDtoCli1 = Thisform.contenido.txtDesc1.Value
lnPDtoCli2 = Thisform.contenido.txtDesc2.Value
lnPDtoCli3 = Thisform.contenido.txtDesc3.Value
lnPDtoCli4 = Thisform.contenido.txtDesc4.Value
lnIDtoCli1 = 0.00
lnIDtoCli2 = 0.00
lnIDtoCli3 = 0.00
lnIDtoCli4 = 0.00
lnPrecio = 0.00
lnPrVta = 0.00
lnPorRec = Thisform.contenido.txtporrec.Value 
lnImpRec = 0.00
lnImpNeto = 0.00

loFormPed.idcliente = Thisform.contenido.sel_cliente.valcpoid
loFormPed.leer_datos()
loFormPed.Show()
IF loFormPed.Cancelar THEN
	RETURN .F.
ENDIF

thisform.idpedcab = loFormPed.idpedcab
lcSql = "CALL pedext_getPedByCab (?idPedCab)"
lcSql = loResult.AddParameter(lcSql, "idPedCab", ALLTRIM(STR(Thisform.idpedcab)), .f., .f.)
loResult.ActiveConnection = goConn.ActiveConnection
loResult.Cursor_Name = "cur_temp"
IF !loResult.OpenQuery(lcSql) THEN
	MESSAGEBOX(loResult.Error_Message, 0+48, Thisform.Caption)
	RETURN
ENDIF
Thisform.Contenido.txtObserv.Value = ALLTRIM(loFormPed.Observ)
loFormPed.Release()
SELECT cur_PedExt
ZAP
DO WHILE !EOF("cur_temp")
	SELECT cur_PedExt
	APPEND BLANK
	REPLACE idPedExt WITH cur_temp.idPedExt
	REPLACE idArticulo WITH cur_temp.idArticulo ADDITIVE
	REPLACE codArt WITH cur_temp.codArt ADDITIVE
	REPLACE cantidad WITH cur_temp.cantidad ADDITIVE
	
	SELECT cur_temp
	SKIP
ENDDO

SELECT cur_Deta_View
ZAP

SELECT cur_PedExt
IF RECCOUNT("cur_PedExt") > 0
	GO TOP
ENDIF

lnIndex = 0
llOk = .T.
DO WHILE !EOF("cur_PedExt")
	lcSql = "CALL articulos_getById (" + ALLTRIM(STR(cur_PedExt.idArticulo)) + ")"
	loResult.ActiveConnection = goConn.ActiveConnection
	loResult.Cursor_Name = "cur_TmpArt"
	
	IF !loResult.OpenQuery(lcSql) THEN
		MESSAGEBOX(loResult.Error_Message, 0+48, Thisform.Caption)
		RETURN .F.
	ENDIF
	
	SELECT cur_TmpArt
	IF RECCOUNT("cur_TmpArt") > 0	
		&& Verifico cuando levanta el pedido que levante la oferta.
		lnPrecio = thisform.get_precio_oferta_2(cur_TmpArt.idArticulo)
		SELECT cur_Deta_View
		APPEND BLANK
		REPLACE cur_Deta_View.idDetalle	WITH lnIndex + 1
		REPLACE cur_Deta_View.idArticulo 	WITH cur_TmpArt.idArticulo ADDITIVE
		REPLACE cur_Deta_View.codArt 		WITH cur_PedExt.codArt ADDITIVE
		REPLACE cur_Deta_View.descripcio 	WITH cur_TmpArt.descripcio ADDITIVE
		REPLACE cur_Deta_View.cantidad 		WITH cur_PedExt.cantidad ADDITIVE
		REPLACE cur_Deta_View.alicIVA 		WITH cur_TmpArt.alicIVA ADDITIVE
		IF lnPrecio = 0 THEN
			IF clientes.mayorista
				lnPrecio = cur_TmpArt.prVentaMax			
			ELSE
				lnPrecio = cur_TmpArt.prVentaMin
			ENDIF
			
			REPLACE cur_Deta_View.esOferta WITH .F. ADDITIVE
		ELSE
			REPLACE cur_Deta_View.esOferta WITH .T. ADDITIVE
		ENDIF
		&& Calculo los descuentos del cliente
		lnIDtoCli1 = ROUND(lnPrecio * (lnPDtoCli1 / 100), 2)
		lnIDtoCli2 = ROUND((lnPrecio - lnIDtoCli1) * (lnPDtoCli2 / 100), 2)
		lnIDtoCli3 = ROUND((lnPrecio - lnIDtoCli1 - lnIDtoCli2) * (lnPDtoCli3 / 100), 2)
		lnIDtoCli4 = ROUND((lnPrecio - lnIDtoCli1 - lnIDtoCli2 - lnIDtoCli3) * (lnPDtoCli4 / 100), 2)
		lnPrVta = lnPrecio - lnIDtoCli1 - lnIDtoCli2 - lnIDtoCli3 - lnIDtoCli4
		REPLACE cur_Deta_View.pDtoCli1 	WITH lnPDtoCli1 ADDITIVE
		REPLACE cur_Deta_View.pDtoCli2 	WITH lnPDtoCli2 ADDITIVE
		REPLACE cur_Deta_View.pDtoCli3 	WITH lnPDtoCli3 ADDITIVE
		REPLACE cur_Deta_View.pDtoCli4 	WITH lnPDtoCli4 ADDITIVE
		REPLACE cur_Deta_View.iDtoCli1 	WITH lnIDtoCli1 ADDITIVE
		REPLACE cur_Deta_View.iDtoCli2 	WITH lnIDtoCli2 ADDITIVE
		REPLACE cur_Deta_View.iDtoCli3 	WITH lnIDtoCli3 ADDITIVE
		REPLACE cur_Deta_View.iDtoCli4 	WITH lnIDtoCli4 ADDITIVE
		REPLACE cur_Deta_View.pDtoVta1	WITH 0.00
		REPLACE cur_Deta_View.pDtoVta2 	WITH 0.00
		REPLACE cur_Deta_View.pDtoVta3	WITH 0.00
		REPLACE cur_Deta_View.pDtoVta4	WITH 0.00
		REPLACE cur_Deta_View.iDtoVta1	WITH 0.00
		REPLACE cur_Deta_View.iDtoVta2	WITH 0.00
		REPLACE cur_Deta_View.iDtoVta3	WITH 0.00
		REPLACE cur_Deta_View.iDtoVta4	WITH 0.00
		
		&& Calculo el recargo
		
		lnImpNeto = lnPrVta
		lnImpRec = ROUND(lnImpNeto * (lnPorRec / 100), 2)
		lnImpNeto = lnImpNeto + lnImpRec
		
		REPLACE cur_Deta_View.pRecVta WITH lnPorRec ADDITIVE
		REPLACE cur_Deta_View.iRecVta WITH lnImpRec ADDITIVE
		REPLACE cur_Deta_View.prArtic	WITH lnPrecio ADDITIVE
		REPLACE cur_Deta_View.prVta 	WITH lnPrVta ADDITIVE
		REPLACE cur_Deta_View.impNeto	WITH lnImpNeto ADDITIVE
		REPLACE cur_Deta_View.totNeto 	WITH ROUND(lnImpNeto * cur_PedExt.Cantidad, 2) ADDITIVE
		REPLACE cur_Deta_View.impIVA 	WITH ROUND(cur_Deta_View.totneto * (cur_TmpArt.alicIVA / 100), 2) ADDITIVE
		REPLACE cur_Deta_View.subTotal 	WITH cur_Deta_View.totNeto + cur_Deta_View.impIVA ADDITIVE
		
		&& El siguiente código reemplazarlo para cuando se haya incorporado las unidades de medida
		&& en el sistema de cliente.
		REPLACE cur_Deta_View.uniDesp WITH 1 ADDITIVE
		REPLACE cur_Deta_View.cantPack WITH ROUND(cur_PedExt.Cantidad, 2) ADDITIVE
		REPLACE cur_Deta_View.uniMed WITH 'UNI' ADDITIVE
		
		lnIndex = lnIndex + 1
	ELSE
		IF !(ALLTRIM(cur_PedExt.codArt) == "") THEN
			MESSAGEBOX("El código " + ALLTRIM(cur_PedExt.codArt) + " no existe, verifique el mismo y vuelva a intentarlo", 0+48, Thisform.Caption)
			
			&& Vuelvo a dejar el detalle vacío
			USE IN cur_TmpArt
			SELECT cur_PedExt
			ZAP
			
			SELECT cur_Deta_View
			ZAP		
		ELSE
			lcMensaje = lcMensaje + "El código de artículo está vacío, verificar el pedido"
			lcWSMail = "http://siscom.hol.es/" + ALLTRIM(getConfig("WS_ADDR")) + "/sendErrorMails.php?wsdl"
			loSoap.MSSoapInit(lcWSMail)
			lnResult = loSoap.sendMail("Error SISCOM2013", lcMensaje, "from:noreplay@siscom2013.com.ar")						
		ENDIF
		
		RETURN .F.
	ENDIF
	
	USE IN cur_TmpArt
	
	SELECT cur_PedExt
	SKIP
ENDDO

SELECT cur_PedExt
GO TOP

SELECT cur_Deta_View
IF RECCOUNT("cur_Deta_View") > 0
	GO TOP
ENDIF

Thisform.Contenido.grdDetalles.Refresh()
Thisform.sumar_items()
Thisform.calcular_ret_iibb()

RETURN .T.


ENDPROC
PROCEDURE abrir_cbteorigen
LOCAL loForm

loForm = CREATEOBJECT("cls_busca_fcorigen_sf")
loForm.cbte = Thisform.cbte

IF Thisform.Contenido.sel_Cliente.txtCodigo.Value = 0 THEN
	MESSAGEBOX("Debe ingresar el código de cliente", 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

loForm.idCliente = Thisform.Contenido.sel_Cliente.valcpoid
loForm.llenar_grilla()
loForm.show()

IF loForm.press_aceptar
	SELECT cur_cbtes
	IF RECCOUNT("cur_cbtes") > 0 THEN
		GO TOP
	ENDIF
	
	Thisform.nroitem = 1
	DO WHILE !EOF("cur_cbtes")
		IF cur_cbtes.sel THEN
			Thisform.idOrigen = cur_cbtes.idVentasC
			Thisform.saldo_fc = loForm.saldo
			
			IF ALLTRIM(Thisform.Cbte) == "FC" .OR. ALLTRIM(Thisform.Cbte) == "PTO" THEN
				Thisform.recuperar_ped()
			ELSE
				IF ALLTRIM(thisform.cbte) == "NC" THEN 
					Thisform.recuperar_fc()
				ENDIF 
			ENDIF
		ENDIF
		
		SELECT cur_cbtes
		SKIP
	ENDDO
ENDIF

loForm.release()
Thisform.contenido.btnCbteOrigen.Enabled = .F.

RETURN .T.

ENDPROC
PROCEDURE calc_item_desc
LOCAL lnDesc1, lnDesc2, lnDesc3, lnDesc4, lnNeto
LOCAL lnImpDesc1, lnImpDesc2, lnImpDesc3, lnImpDesc4
LOCAL lnImpIVA, lnAlicIVA
LOCAL lnPorRec, lnImpRec, lnPorRecItem, lnImpRecItem

lnImpDesc1 = 0.00
lnImpDesc2 = 0.00
lnImpDesc3 = 0.00
lnImpDesc4 = 0.00
lnPorRec = 0.00
lnImpRec = 0.00
lnPorRecItem = 0.00
lnImpRecItem = 0.00

lnDesc1 = Thisform.contenido.txtPorDesc1.Value
lnDesc2 = Thisform.contenido.txtPorDesc2.Value
lnDesc3 = Thisform.contenido.txtPorDesc3.Value
lnDesc4 = Thisform.contenido.txtPorDesc4.Value

lnAlicIVA = Thisform.contenido.txtAlicIva.Value
lnPorRec = Thisform.contenido.txtPorRec.Value 
lnPorRecItem  = Thisform.contenido.txtPorRecItem.Value

IF RIGHT(ALLTRIM(Thisform.contenido.sel_Articulo.txtCodigo.Value), 3) == "ARX" THEN
	&& Si es artículo X tomo siempre el precio minorista ya que es el que habilito para modificar.
	lnNeto = Thisform.contenido.txtPrMinorista.Value
ELSE
	IF clientes.mayorista THEN
		lnNeto = Thisform.contenido.txtPrMay.Value
	ELSE
		lnNeto = Thisform.contenido.txtPrMinorista.Value
	ENDIF
ENDIF

lnImpDesc1 = ROUND(lnNeto * (lnDesc1 / 100),2)
lnImpDesc2 = ROUND((lnNeto - lnImpDesc1) * (lnDesc2 / 100),2)
lnImpDesc3 = ROUND((lnNeto - lnImpDesc1 - lnImpDesc2) * (lnDesc3 / 100),2)
lnImpDesc4 = ROUND((lnNeto - lnImpDesc1 - lnImpDesc2 - lnImpDesc3) * (lnDesc4 /100),2)
	
lnNeto = lnNeto - lnImpDesc1 - lnImpDesc2 - lnImpDesc3 - lnImpDesc4

****************************************************
&& Hago el recargo
lnImpRec = ROUND(lnNeto * (lnPorRec / 100), 2)

lnNeto = lnNeto + lnImpRec
****************************************************
&& Calculo el recargo por item
lnImpRecItem = ROUND(lnNeto * (lnPorRecItem/ 100), 2)

lnNeto = lnNeto + lnImpRecItem

Thisform.contenido.txtImpDescItem1.Value = lnImpDesc1
Thisform.contenido.txtImpDescItem2.Value = lnImpDesc2
Thisform.contenido.txtImpDescItem3.Value = lnImpDesc3
Thisform.contenido.txtImpDescItem4.Value = lnImpDesc4
Thisform.contenido.txtRecItem.Value = lnImpRecItem 

Thisform.contenido.txtPrNeto.Value = lnNeto
Thisform.contenido.txtSTNeto.Value = ROUND(lnNeto * thisform.contenido.txtcantidad.value, 2)

* Calculo el IVA
IF (ALLTRIM(Thisform.cbte) == "PTO") THEN 
	Thisform.contenido.txtSubTotal.Value = Thisform.contenido.txtSTNeto.Value + Thisform.contenido.txtImpIVA.Value
ELSE 
	lnImpIVA = ROUND(Thisform.contenido.txtSTNeto.Value * (lnAlicIVA / 100), 2)
	Thisform.contenido.txtImpIva.Value = lnImpIVA
	Thisform.contenido.txtSubTotal.Value = Thisform.contenido.txtSTNeto.Value + Thisform.contenido.txtImpIVA.Value
ENDIF 

ENDPROC
PROCEDURE recalcular_todo
LOCAL lo_artic, lcSql
LOCAL lnPorDesc1, lnPorDesc2, lnPorDesc3, lnPorDesc4
LOCAL lnImpDesc1, lnImpDesc2, lnImpDesc3, lnImpDesc4
LOCAL lnPrVtaMax, lnPrVtaMin, lnPrecio, lnNeto, lnSubTotNeto
LOCAL lnPorRec, lnImpRec, lnPrOferta, llEsOferta, lnImpRecItem

lcSql = ""
lo_artic = CREATEOBJECT("odbc_result")
lnPrOferta = 0.00
llEsOferta = .F.

SELECT cur_Deta_View
IF RECCOUNT("cur_Deta_View") > 0 THEN
	GO TOP
ENDIF

&& Recalculo los datos de la grilla
DO WHILE !EOF("cur_Deta_View")
	lcSql = "SELECT * FROM articulos WHERE articulos.idArticulo = " + ALLTRIM(STR(cur_Deta_View.idArticulo))

	lo_artic.ActiveConnection = goConn.ActiveConnection
	lo_artic.cursor_name = "tmp_artic"
	
	IF !lo_artic.OpenQuery(lcSql) THEN
		MESSAGEBOX(lo_artic.error_Message, 0+16, Thisform.Caption)
		RETURN .F.
	ENDIF
	lnPrOferta = thisform.getoferta_byart(cur_Deta_View.idArticulo)
	SELECT tmp_artic
	IF RECCOUNT() > 0 THEN
		SELECT cur_Deta_View
		LOCK()
		
*******************************************************************************************************************************
* Recalculo los precios mayorista y minorista segun los descuentos del cliente
*******************************************************************************************************************************

		lnPorDesc1 = Thisform.contenido.txtDesc1.Value
		lnPorDesc2 = Thisform.contenido.txtDesc2.Value
		lnPorDesc3 = Thisform.contenido.txtDesc3.Value
		lnPorDesc4 = Thisform.contenido.txtDesc4.Value
		lnImpDesc1 = 0.00
		lnImpDesc2 = 0.00
		lnImpDesc3 = 0.00
		lnImpDesc4 = 0.00

		SELECT tmp_artic
		lnPrVtaMax = tmp_artic.prVentaMax
		lnPrVtaMin = tmp_artic.prVentaMin
				
		IF RIGHT(ALLTRIM(cur_Deta_View.codArt), 3) == "ARX" THEN
			lnPrecio = cur_Deta_View.prArtic
		ELSE
			IF clientes.mayorista THEN 
				SELECT cur_Deta_View
				
				
				IF lnPrOferta = 0 THEN
					lnPrecio = lnPrVtaMax
					llEsOferta = .F.
				ELSE 
					lnPrecio = lnPrOferta
					llEsOferta = .T.
				ENDIF 
			ELSE 
				lnPrecio = lnPrVtaMin
				llEsOferta = .F.
			ENDIF 
		ENDIF
		
		REPLACE cur_Deta_View.prArtic WITH lnPrecio ADDITIVE
		
		*******************************************************************************************************************************
		* Calculo el descuento del cliente en el ítem para grabar
		*******************************************************************************************************************************
		lnImpDesc1 = ROUND(lnPrecio * (lnPorDesc1 / 100),2)
		lnImpDesc2 = ROUND((lnPrecio - lnImpDesc1 ) * (lnPorDesc2 / 100),2)
		lnImpDesc3 = ROUND((lnPrecio - lnImpDesc1 - lnImpDesc2 ) * (lnPorDesc3 / 100),2)
		lnImpDesc4 = ROUND((lnPrecio - lnImpDesc1 - lnImpDesc2 - lnImpDesc3) * (lnPorDesc4 / 100),2)
		
		lnPrecio = lnPrecio - lnImpDesc1 - lnImpDesc2 - lnImpDesc3 - lnImpDesc4
		
		REPLACE cur_Deta_View.prVta WITH lnPrecio ADDITIVE  
		
		REPLACE cur_Deta_View.pDtoCli1 WITH lnPorDesc1 ADDITIVE
		REPLACE cur_Deta_View.pDtoCli2 WITH lnPorDesc2 ADDITIVE
		REPLACE cur_Deta_View.pDtoCli3 WITH lnPorDesc3 ADDITIVE
		REPLACE cur_Deta_View.pDtoCli4 WITH lnPorDesc4 ADDITIVE
		REPLACE cur_Deta_View.iDtoCli1 WITH lnImpDesc1 ADDITIVE
		REPLACE cur_Deta_View.iDtoCli2 WITH lnImpDesc2 ADDITIVE
		REPLACE cur_Deta_View.iDtoCli3 WITH lnImpDesc3 ADDITIVE
		REPLACE cur_Deta_View.iDtoCli4 WITH lnImpDesc4 ADDITIVE
		REPLACE cur_Deta_View.esOferta WITH llEsOferta ADDITIVE
		
		*******************************************************************************************************************************
		&& Calculo los descuentos por item
		*******************************************************************************************************************************

		lnPorDesc1 = cur_Deta_View.pDtoVta1
		lnPorDesc2 = cur_Deta_View.pDtoVta2
		lnPorDesc3 = cur_Deta_View.pDtoVta3
		lnPorDesc4 = cur_Deta_View.pDtoVta4
		lnImpDesc1 = 0.00
		lnImpDesc2 = 0.00
		lnImpDesc3 = 0.00
		lnImpDesc4 = 0.00
		lnNeto = 0.00

		lnImpDesc1 = ROUND(lnPrecio * (lnPorDesc1 / 100),2)
		lnImpDesc2 = ROUND((lnPrecio - lnImpDesc1 ) * (lnPorDesc2 / 100),2)
		lnImpDesc3 = ROUND((lnPrecio - lnImpDesc1 - lnImpDesc2 ) * (lnPorDesc3 / 100),2)
		lnImpDesc4 = ROUND((lnPrecio - lnImpDesc1 - lnImpDesc2 - lnImpDesc3) * (lnPorDesc4 / 100),2)
		
		lnNeto = lnPrecio - lnImpDesc1 - lnImpDesc2 - lnImpDesc3 - lnImpDesc4
		
		REPLACE cur_Deta_View.iDtoVta1 WITH lnImpDesc1 ADDITIVE
		REPLACE cur_Deta_View.iDtoVta2 WITH lnImpDesc2 ADDITIVE
		REPLACE cur_Deta_View.iDtoVta3 WITH lnImpDesc3 ADDITIVE
		REPLACE cur_Deta_View.iDtoVta4 WITH lnImpDesc4 ADDITIVE
		
		*******************************************************************************************************************************
		* Agrego el recargo del cliente en el item
		*******************************************************************************************************************************
		lnPorRec = Thisform.contenido.txtporrec.Value 
		
		lnImpRec = ROUND(lnNeto * (lnPorRec / 100), 2)
		
		lnNeto = lnNeto + lnImpRec

		REPLACE cur_Deta_View.pRecVta WITH lnPorRec ADDITIVE
		REPLACE cur_Deta_View.iRecVta WITH lnImpRec ADDITIVE

		*******************************************************************************************************************************
		&& Incluyo el recargo por ítem.
		*******************************************************************************************************************************
		lnImpRecItem = ROUND(lnNeto * (cur_Deta_View.pRecItem / 100),2)		
		
		lnNeto = lnNeto + lnImpRecItem

		REPLACE cur_Deta_View.pRecItem WITH cur_Deta_View.pRecItem ADDITIVE
		REPLACE cur_Deta_View.iRecItem WITH lnImpRecItem ADDITIVE
		
		*******************************************************************************************************************************
		* Recalculo el IVA y los Subtotales
		*******************************************************************************************************************************
		REPLACE cur_Deta_View.impNeto WITH lnNeto ADDITIVE 
		
		lnSubTotNeto = ROUND(lnNeto * cur_Deta_View.cantidad, 2)
		
		IF (ALLTRIM(Thisform.cbte) == "PTO") THEN
			REPLACE cur_Deta_View.impIVA WITH 0 ADDITIVE
			REPLACE cur_Deta_View.alicIVA WITH 0 ADDITIVE
		ELSE
			REPLACE cur_Deta_View.impIVA WITH ROUND(lnSubTotNeto * (tmp_artic.alicIVA / 100), 2) ADDITIVE
			REPLACE cur_Deta_View.alicIVA WITH tmp_artic.alicIVA ADDITIVE
		ENDIF
		
		REPLACE cur_Deta_View.totNeto WITH lnSubTotNeto ADDITIVE
		
		IF (ALLTRIM(Thisform.cbte) == "PTO") THEN
			REPLACE cur_Deta_View.subTotal WITH cur_Deta_View.totNeto ADDITIVE		
		ELSE 
			REPLACE cur_Deta_View.subTotal WITH cur_Deta_View.totNeto + cur_Deta_View.impIVA ADDITIVE
		ENDIF 
		UNLOCK
	ENDIF

	lo_artic.close_query()
		
	SELECT cur_Deta_View
	SKIP
ENDDO

IF !(ALLTRIM(Thisform.contenido.sel_Articulo.txtCodigo.Value) == "") THEN
	Thisform.contenido.sel_Articulo.recuperar_datos()
	Thisform.contenido.sel_Articulo.txtCodigo.Valid()
ENDIF

SELECT cur_Deta_View
IF RECCOUNT("cur_Deta_View") > 0 THEN
	GO TOP
ENDIF

Thisform.contenido.grdDetalles.Refresh()
Thisform.sumar_items()
Thisform.calcular_ret_iibb()

RETURN .T.

ENDPROC
PROCEDURE recuperar_ped
&& Este método permite recuperar los pedidos para facturar.

LOCAL lcSql, loResult, loResArt, lcCodArt, lcDescripcio, lnContOfta
LOCAL lnCantidad
LOCAL lnImpNeto, lnTotNeto

loResult = CREATEOBJECT("odbc_result")
loResArt = CREATEOBJECT("odbc_result")
lcSql = ""
lnContOfta = 0
lnCantidad = 0
lnImpNeto = 0.00
lnTotNeto = 0.00

&& Levanto el detalle del comprobante 
lcSql = "SELECT * FROM ventasdet WHERE idVentasC = " + ALLTRIM(STR(Thisform.idorigen)) + " "

loResult.ActiveConnection = goConn.ActiveConnection
loResult.cursor_name = "cur_Vtas"
loResult.OpenQuery(lcSql)

SELECT cur_Vtas
IF RECCOUNT("cur_Vtas") > 0 THEN 
	GO TOP 
ENDIF 

SELECT cur_Vtas
DO WHILE !EOF("cur_Vtas")
	lcSql = "SELECT * FROM articulos WHERE idArticulo = " + ALLTRIM(STR(cur_Vtas.idArticulo))
	loResArt.ActiveConnection = goConn.ActiveConnection
	loResArt.cursor_name = "cur_artic"
	
	IF !loResArt.OpenQuery(lcSql)
		MESSAGEBOX(loResArt.error_message, 0+48, Thisform.Caption)
		RETURN .F.
	ENDIF
	
	SELECT cur_artic
	IF RECCOUNT("cur_artic") > 0 THEN 
		GO TOP 
	ENDIF  
	
	SELECT cur_artic
	lcCodArt = cur_artic.codArt
	lcDescripcio = cur_Vtas.descripcio
	
	IF ALLTRIM(Thisform.cbte) == "FC" THEN
		lnCantidad = cur_Vtas.cant_pri1 - cur_Vtas.cantNC
	ELSE
		IF ALLTRIM(Thisform.cbte) == "PTO" THEN
			lnCantidad = cur_Vtas.cant_pri2 - cur_Vtas.cantNC
		ELSE
			lnCantidad = cur_Vtas.cantidad - cur_Vtas.cantNC
		ENDIF
	ENDIF	
	
	loResArt.Close_Query()
	
	IF lnCantidad <> 0 THEN
		SELECT cur_Deta_View
		APPEND BLANK
		REPLACE cur_Deta_View.idDetalle		WITH Thisform.nroitem
		REPLACE cur_Deta_View.idArticulo 	WITH cur_Vtas.idArticulo ADDITIVE
		REPLACE cur_Deta_View.codArt 		WITH lcCodArt ADDITIVE
		REPLACE cur_Deta_View.descripcio 	WITH lcDescripcio ADDITIVE
		REPLACE cur_Deta_View.cantidad 		WITH lnCantidad ADDITIVE 
		REPLACE cur_Deta_View.prVta			WITH cur_Vtas.prVenta ADDITIVE
		REPLACE cur_Deta_View.pDtoVta1		WITH cur_Vtas.pDtoVta1 ADDITIVE 
		REPLACE cur_Deta_View.pDtoVta2		WITH cur_Vtas.pDtoVta2 ADDITIVE 
		REPLACE cur_Deta_View.pDtoVta3		WITH cur_Vtas.pDtoVta3 ADDITIVE 
		REPLACE cur_Deta_View.pDtoVta4		WITH cur_Vtas.pDtoVta4 ADDITIVE
		REPLACE cur_Deta_View.iDtoVta1		WITH cur_Vtas.iDtoVta1 ADDITIVE 
		REPLACE cur_Deta_View.iDtoVta2		WITH cur_Vtas.iDtoVta2 ADDITIVE 
		REPLACE cur_Deta_View.iDtoVta3		WITH cur_Vtas.iDtoVta3 ADDITIVE 
		REPLACE cur_Deta_View.iDtoVta4		WITH cur_Vtas.iDtoVta4 ADDITIVE 
		REPLACE cur_Deta_View.pDtoCli1		WITH cur_Vtas.porDesc1 ADDITIVE 
		REPLACE cur_Deta_View.pDtoCli2		WITH cur_Vtas.porDesc2 ADDITIVE 
		REPLACE cur_Deta_View.pDtoCli3		WITH cur_Vtas.porDesc3 ADDITIVE 
		REPLACE cur_Deta_View.pDtoCli4		WITH cur_Vtas.porDesc4 ADDITIVE 		
		REPLACE cur_Deta_View.iDtoCli1		WITH cur_Vtas.impDesc1 ADDITIVE 
		REPLACE cur_Deta_View.iDtoCli2		WITH cur_Vtas.impDesc2 ADDITIVE 
		REPLACE cur_Deta_View.iDtoCli3		WITH cur_Vtas.impDesc3 ADDITIVE 
		REPLACE cur_Deta_View.iDtoCli4		WITH cur_Vtas.impDesc4 ADDITIVE
		REPLACE cur_Deta_View.pRecItem		WITH cur_Vtas.pRecItem ADDITIVE
		REPLACE cur_Deta_View.iRecItem		WITH cur_Vtas.iRecItem ADDITIVE		
		REPLACE cur_Deta_View.alicIVA 		WITH cur_Vtas.alicIVA ADDITIVE
		REPLACE cur_Deta_View.impIVA 		WITH cur_Vtas.impIVA ADDITIVE
		REPLACE cur_Deta_View.impNeto 		WITH cur_Vtas.impNeto ADDITIVE
		REPLACE cur_Deta_View.totNeto 		WITH cur_Vtas.totNeto ADDITIVE
		REPLACE cur_Deta_View.subTotal 		WITH cur_Vtas.subTotal ADDITIVE
		REPLACE cur_Deta_View.esOferta 		WITH cur_Vtas.esOferta ADDITIVE
		REPLACE cur_Deta_View.prArtic		WITH cur_Vtas.prArtic ADDITIVE
		REPLACE cur_Deta_View.pRecVta 		WITH cur_Vtas.pRecVta ADDITIVE 
		REPLACE cur_Deta_View.iRecVta		WITH cur_Vtas.iRecVta ADDITIVE
		REPLACE cur_Deta_View.uniDesp		WITH cur_Vtas.uniDesp ADDITIVE
		REPLACE cur_Deta_View.cantPack		WITH cur_Vtas.cantPack ADDITIVE
		REPLACE cur_Deta_View.uniMed		WITH cur_Vtas.codUM ADDITIVE
		
		Thisform.nroitem = Thisform.nroitem + 1
	ENDIF
	
	IF cur_Vtas.esOferta THEN
		lnContOfta = lnContOfta + 1
	ENDIF
	
	SELECT cur_Vtas
	SKIP
ENDDO

loResult.Close_Query()

SELECT cur_Deta_View
IF RECCOUNT("cur_Deta_View") > 0 THEN
	GO TOP
ENDIF

Thisform.contenido.txtdesc1.Value = cur_Deta_View.pDtoCli1
Thisform.contenido.txtdesc2.Value = cur_Deta_View.pDtoCli2
Thisform.contenido.txtdesc3.Value = cur_Deta_View.pDtoCli3
Thisform.contenido.txtdesc4.Value = cur_Deta_View.pDtoCli4
Thisform.contenido.txtporrec.Value = cur_Deta_View.pRecVta

Thisform.Contenido.grdDetalles.Refresh()

IF lnContOfta > 0 THEN
	MESSAGEBOX("Este pedido tiene " + ALLTRIM(STR(lnContOfta)) + " artículo(s) en oferta", 0+64, Thisform.Caption)
ENDIF

thisform.recalcular_todo()

RETURN .T.
ENDPROC
PROCEDURE particionar_cbte
************************************************************************************
** Esta función permite grabar una factura cada 25 items.
** Pablo Díaz
************************************************************************************

LOCAL ln_cantitems

ln_cantitems = 0

SELECT cur_aux
ZAP 

IF !(ALLTRIM(thisform.cbte) == "COT") .AND. getGlobalCFG("STK_MODULE") THEN
	IF !thisform.validar_stk_en_grabado() THEN
		goConn.Rollback()
		RETURN .F.
	ENDIF
ENDIF

SELECT cur_detalle
IF RECCOUNT() > 0 THEN 
	GO TOP
ELSE 
	RETURN .F.
ENDIF 

************************************************************************************
** Paso de a 25 items del cursor de detalle al cursor auxiliar
************************************************************************************
SELECT cur_detalle
DO WHILE !EOF()
	ln_cantitems = ln_cantitems + 1
	
	SELECT cur_aux
	APPEND BLANK	
	
	REPLACE cur_aux.idDetalle WITH cur_detalle.idDetalle
	REPLACE cur_aux.idArticulo WITH cur_detalle.idArticulo ADDITIVE
	REPLACE cur_aux.codArt WITH cur_detalle.codArt ADDITIVE
	REPLACE cur_aux.descripcio WITH cur_detalle.descripcio ADDITIVE
	REPLACE cur_aux.nroPart WITH cur_detalle.nroPart ADDITIVE
	REPLACE cur_aux.cantidad WITH cur_detalle.cantidad ADDITIVE
	REPLACE cur_aux.prVta WITH cur_detalle.prVta ADDITIVE
	REPLACE cur_aux.pDtoVta1 WITH cur_detalle.pDtoVta1 ADDITIVE
	REPLACE cur_aux.pDtoVta2 WITH cur_detalle.pDtoVta2 ADDITIVE
	REPLACE cur_aux.pDtoVta3 WITH cur_detalle.pDtoVta3 ADDITIVE
	REPLACE cur_aux.pDtoVta4 WITH cur_detalle.pDtoVta4 ADDITIVE
	REPLACE cur_aux.iDtoVta1 WITH cur_detalle.iDtoVta1 ADDITIVE
	REPLACE cur_aux.iDtoVta2 WITH cur_detalle.iDtoVta2 ADDITIVE
	REPLACE cur_aux.iDtoVta3 WITH cur_detalle.iDtoVta3 ADDITIVE
	REPLACE cur_aux.iDtoVta4 WITH cur_detalle.iDtoVta4 ADDITIVE
	REPLACE cur_aux.pDtoCli1 WITH cur_detalle.pDtoCli1 ADDITIVE
	REPLACE cur_aux.pDtoCli2 WITH cur_detalle.pDtoCli2 ADDITIVE
	REPLACE cur_aux.pDtoCli3 WITH cur_detalle.pDtoCli3 ADDITIVE
	REPLACE cur_aux.pDtoCli4 WITH cur_detalle.pDtoCli4 ADDITIVE
	REPLACE cur_aux.iDtoCli1 WITH cur_detalle.iDtoCli1 ADDITIVE
	REPLACE cur_aux.iDtoCli2 WITH cur_detalle.iDtoCli2 ADDITIVE
	REPLACE cur_aux.iDtoCli3 WITH cur_detalle.iDtoCli3 ADDITIVE
	REPLACE cur_aux.iDtoCli4 WITH cur_detalle.iDtoCli4 ADDITIVE
	
	&& Incorporo el recargo por ítem
	REPLACE cur_aux.pRecItem WITH cur_detalle.pRecItem ADDITIVE
	REPLACE cur_aux.iRecItem WITH cur_detalle.iRecItem ADDITIVE
	
	REPLACE cur_aux.alicIVA WITH cur_detalle.alicIVA ADDITIVE
	REPLACE cur_aux.impIVA WITH cur_detalle.impIVA ADDITIVE
	REPLACE cur_aux.impNeto WITH cur_detalle.impNeto ADDITIVE
	REPLACE cur_aux.totNeto WITH cur_detalle.totNeto ADDITIVE
	REPLACE cur_aux.subTotal WITH cur_detalle.subTotal ADDITIVE
	REPLACE cur_aux.prArtic WITH cur_detalle.prArtic ADDITIVE
	REPLACE cur_aux.esOferta WITH cur_detalle.esOferta ADDITIVE
	REPLACE cur_aux.pRecVta WITH cur_detalle.pRecVta ADDITIVE 
	REPLACE cur_aux.iRecVta WITH cur_detalle.iRecVta ADDITIVE
	REPLACE cur_aux.uniDesp WITH cur_detalle.uniDesp ADDITIVE
	REPLACE cur_aux.cantPack WITH cur_detalle.cantPack ADDITIVE 
	REPLACE cur_aux.uniMed WITH cur_detalle.uniMed ADDITIVE
	
	&& Si lleva stock agrege los movimientos que hay que generar.
	IF ALLTRIM(cur_detalle.nropart) == "" THEN
		IF getGlobalCFG("STK_MODULE") THEN
			IF !(RIGHT(ALLTRIM(cur_detalle.codArt), 3) == "ARX") THEN
				Thisform.mov_stock.agregar_articulo(cur_detalle.idArticulo, ;
						cur_detalle.Cantidad, "")
			ENDIF
		ENDIF
	ELSE
		IF getGlobalCFG("STK_MODULE") THEN
			IF !(RIGHT(ALLTRIM(cur_detalle.codArt), 3) == "ARX") THEN
				Thisform.mov_stock.agregar_articulo(cur_detalle.idArticulo, ;
						cur_detalle.Cantidad, cur_detalle.nropart)
			ENDIF
		ENDIF	
	ENDIF
	
	&& Cuando el contador llegue a 25 items grabo una factura nueva.
	IF ln_cantitems = 25
		&& tengo que hacer el calculo de los totales y el grabado		
		Thisform.calc_subtot_cur_aux()
		
		IF !thisform.grabar_cbte_part()
			RETURN .F.
		ENDIF	

		&& Imprimo el comprobante
		IF !thisform.usar_fiscal
			Thisform.imprimir()
		ENDIF
		
		ln_cantitems = 0
		
		SELECT cur_aux
		ZAP
		Thisform.mov_stock.limpiar()
	ENDIF 
	
	SELECT cur_detalle
	SKIP  
ENDDO 

&& En el caso que la ultima factura no haya llegado a los 25 items
&& tengo que hacer una nueva factura con los items restantes.
IF ln_cantitems <> 0 
	&& tengo que hacer el calculo de los totales y el grabado
	Thisform.calc_subtot_cur_aux()
	
	IF !thisform.grabar_cbte_part()
		RETURN .F.
	ENDIF	
	
	&& Imprimo el comprobante
	IF !thisform.usar_fiscal
		Thisform.imprimir()
	ENDIF
	
	Thisform.mov_stock.limpiar()
ENDIF 

RETURN .T.

	
	




ENDPROC
PROCEDURE grabar_cbte_part
&& Grabo la info en la base

LOCAL lnIdVentasC, lnIdCliente, lcFecEmis, lcCbte, lcTipoDoc, lnPtoVta
LOCAL lnNroCbte, llAnulado, lnImpNeto, lnImpFinal, lnPorIVA21, lnImpIVA21
LOCAL lnPorIVA105, lnImpIVA105, lnPorDesc1, lnPorDesc2, lnPorDesc3, lnPorDesc4
LOCAL lnImpDesc1, lnImpDesc2, lnImpDesc3, lnImpDesc4, lnTotFact
LOCAL lnIdVentasD, lnIdArticulo, lnCantidad, lnCostoRep, lnPrVenta, lnAlicIVA, lnImpIVA
LOCAL lnTotNeto, lnSubTotal, lnSaldo, lcObserv, lnPorIIBB, lnImpIIBB
LOCAL lnPDtoVta1, lnPDtoVta2, lnPDtoVta3, lnPDtoVta4, lnIDtoVta1, lnIDtoVta2, lnIDtoVta3, lnIDtoVta4
LOCAL lnIdCondPago, lnIdSitIVA, lnPrArtic, lnPorRec, lnImpRec, lnUnidDesp, lnCantPack, lcUniMed
LOCAL lnPRecItem, lnIRecItem
LOCAL ldFecVto, lnIdOper, oDT, lnOC
LOCAL loNumerador, lcSql, loCommand, loArtic, loOper, lnSqlSrv, lnPrNeto, lnIdCCOrig, loCliente, lnIdVendedor
LOCAL loConDMO, loResCli, lcSql, lnIntentos

&& Inicializo las variables del detalle

lnIdVentasD = 0
lnIdArticulo = 0
lnCantidad = 0.00
lnCostoRep = 0.00
lnPrVenta = 0.00
lnAlicIVA = 0.00
lnImpIVA = 0.00
lnTotNeto = 0.00
lnSubTotal = 0.00
ldFecVto = {}
lnIdOper = 0
lnSaldo = 0
oDT = CREATEOBJECT("datetime")
loArtic = CREATEOBJECT("odbc_result")
loOper = CREATEOBJECT("odbc_result")
loCliente = CREATEOBJECT("odbc_result")
loCommand = CREATEOBJECT("odbc_command")
lnSqlSrv = INT(VAL(getconfig("SQLSRV")))
lcObserv = Thisform.Contenido.txtObserv.Value
lnPorIIBB = 0.00
lnImpIIBB = 0.00
lnPDtoVta1 = 0.00
lnPDtoVta2 = 0.00
lnPDtoVta3 = 0.00
lnPDtoVta4 = 0.00
lnIDtoVta1 = 0.00
lnIDtoVta2 = 0.00
lnIDtoVta3 = 0.00
lnIDtoVta4 = 0.00
lnPrNeto = 0.00
lnIdCondPago = 0
lnIdSitIVA = 0
lnIdVendedor = 0
loConDMO = CREATEOBJECT("odbc_connect")
lnPrArtic = 0.00
lnPorRec = 0.00
lnImpRec = 0.00
lcSql = ""
loResCli = CREATEOBJECT("odbc_result") && Este objeto lo uso para validar que el cliente exista
lnUniDesp = 0.00
lnCantPack = 0.00
lcUniMed = ""
lnOC = Thisform.Contenido.txtOC.Value
lnPRecItem = 0.00
lnIRecItem = 0.00

lcCbte = Thisform.Cbte


lnIdCliente = Thisform.Contenido.sel_Cliente.ValCpoId

IF ALLTRIM(lcCbte) == "PTO" THEN
	&& Si es un comprobante PTO, entonces, abro la base DMO para generar el registro.

	loConDMO.ConnectionString = ALLTRIM(getConfig("DMO_CC"))

	IF !loConDMO.Open() THEN
		MESSAGEBOX(loConDMO.ErrorMessage, 0+48, Thisform.Caption)
		RETURN .F.
	ENDIF
	
	lcSql = "SELECT COUNT(*) AS cantCli FROM clientes WHERE idCliente = " + ALLTRIM(STR(lnIdCliente))
	loResCli.ActiveConnection = loConDMO.ActiveConnection
	loResCli.Cursor_Name = "cur_x"
	
	IF !loResCli.OpenQuery(lcSql) THEN
		MESSAGEBOX(loResCli.Error_Message, 0+48, Thisform.Caption)
		RETURN .F.
	ENDIF
	
	IF TYPE('cur_x.cantCli') != "C" THEN
		IF cur_x.cantCli = 0 THEN
			MESSAGEBOX("El cliente no existe en DMO, actualice la base y vuelva a intentar", 0+48, Thisform.Caption)
			loResCli.Close_Query()
			RETURN .F.
		ENDIF
	ELSE
		IF INT(VAL(cur_x.cantCli)) = 0 THEN
			MESSAGEBOX("El cliente no existe en DMO, actualice la base y vuelva a intentar", 0+48, Thisform.Caption)
			loResCli.Close_Query()
			RETURN .F.
		ENDIF	
	ENDIF
	
	loResCli.Close_Query()
ENDIF


&& Asigno el idvendedor
lcSql = "SELECT * FROM clientes WHERE idCliente = " + ALLTRIM(STR(lnIdCliente))
loCliente.ActiveConnection = goConn.ActiveConnection
loCliente.Cursor_Name = "cur_cliente"
loCliente.OpenQuery(lcSql)

lnIdVendedor = cur_cliente.idVendedor

loCliente.Close_Query()

lcFecEmis = ALLTRIM(STR(YEAR(DATETIME()))) + "-" + ALLTRIM(STR(MONTH(DATETIME()))) + " - " + ;
	ALLTRIM(STR(DAY(DATETIME())))

IF lcCbte == "COT"
	lcTipoDoc = "X"
	Thisform.tipodoc = lcTipoDoc
ELSE
	&& Aca tengo que agregar el cálculo en caso que sea
	&& comprobante fiscal
	IF lcCbte == "PED"
		lcTipoDoc = "P"
		Thisform.tipodoc = lcTipoDoc
	ELSE
		lcTipoDoc = thisform.calcular_tipodoc()
		Thisform.tipodoc = lcTipoDoc
	ENDIF
ENDIF

IF lcCbte == "PTO" THEN
	lnPtoVta = 9999
	lcTipoDoc = "X"
	Thisform.tipodoc = lcTipoDoc
ELSE
	lnPtoVta = INT(VAL(ALLTRIM(getconfig("PTOVTA"))))
ENDIF

Thisform.ptovta = REPLICATE("0", 4 - LEN(ALLTRIM(STR(lnPtoVta)))) + ALLTRIM(STR(lnPtoVta))
	
lcSql = "select * from numerador where cbte = '" + ALLTRIM(lcCbte) + "' and tipoDoc = '" + ALLTRIM(lcTipoDoc) + "' AND ptoVta = " + ALLTRIM(STR(lnPtoVta))
loNumerador = CREATEOBJECT("odbc_result")

&& Si es PTO entonces asigno la conexión activa correspondiente a la base DMO
&& En caso contrario, apunto a la base REAL
IF ALLTRIM(lcCbte) == "PTO" THEN
	loNumerador.ActiveConnection = loConDMO.ActiveConnection
ELSE
	loNumerador.ActiveConnection = goConn.ActiveConnection
ENDIF

loNumerador.Cursor_Name = "cur_num"
loNumerador.OpenQuery(lcSql)
SELECT cur_num

IF RECCOUNT("cur_num") = 0 THEN
	MESSAGEBOX("No se encuentra configurado el numerador del comprobante " + ALLTRIM(lcCbte) + " Punto de Venta: " + ALLTRIM(STR(lnPtoVta)) + " Letra: " + ALLTRIM(lcTipoDoc), 0+48, thisform.Caption)
	loNumerador.close_query()
	RETURN .F.
ENDIF

IF !ALLTRIM(thisform.cbte) == "PTO" THEN
	IF DATE() > cur_Num.fecVto THEN
		MESSAGEBOX("El talonario actual está vencido, por favor, verifique que su talonario se encuentre en orden", 0+48, Thisform.Caption)
		loNumerador.close_query()
		RETURN .F.
	ENDIF
ENDIF

SELECT cur_num
lnNroCbte = cur_num.numActual + 1
Thisform.idNum = cur_num.idNum
Thisform.nrocbte = REPLICATE("0", 8 - LEN(ALLTRIM(STR(lnNroCbte)))) + ALLTRIM(STR(lnNroCbte))
* Thisform.printerDevice = cur_num.impresora
* Thisform.cant_copias = cur_num.cantCpia

loNumerador.close_query()	

&& Esta rutina genera intentos
lnIntentos = 0 
DO WHILE thisform.num_bloqueado()
	WAIT WINDOW "OTRO USUARIO ESTA EMITIENDO UNA FACTURA,AGUARDE POR FAVOR... (Intetnos: " + ALLTRIM(STR(lnIntentos)) + ")"  NOWAIT
	lnIntentos = lnIntentos + 1
ENDDO

&& Bloqueo el numerador
thisform.bloquear_numerador()

IF ALLTRIM(lcCbte) == "PTO" THEN
	loConDMO.BeginTransaction()	
ELSE
	goConn.BeginTransaction()
ENDIF

&& Actualizo el numerador
lcSql = "update numerador set numActual = " + ALLTRIM(STR(lnNroCbte)) + ;
	" where cbte = '" + ALLTRIM(lcCbte) + "' and tipoDoc = '" + ALLTRIM(lcTipoDoc) + "' and ptoVta = " + ALLTRIM(STR(lnPtoVta))

IF ALLTRIM(lcCbte) == "PTO" THEN
	loCommand.ActiveConnection = loConDMO.ActiveConnection
	loCommand.CommandText = lcSql

	IF !loCommand.Execute()
		thisform.desbloq_numerador()
		loConDMO.Rollback()
		RETURN .F.
	ENDIF	
ELSE
	loCommand.ActiveConnection = goConn.ActiveConnection
	loCommand.CommandText = lcSql

	IF !loCommand.Execute()
		thisform.desbloq_numerador()
		goConn.Rollback()
		RETURN .F.
	ENDIF	
ENDIF

llAnulado = .F.
lnImpNeto = cur_Subtotal.impNeto
lnImpFinal = cur_Subtotal.impFinal
lnPorIVA21 = cur_Subtotal.porIVA21
lnPorIVA105 = cur_Subtotal.porIVA105
lnImpIVA21 = cur_Subtotal.impIVA21
lnImpIVA105 = cur_Subtotal.impIVA105
lnPorIIBB= cur_Subtotal.porIIBB
lnImpIIBB = cur_Subtotal.impIIBB
lnPorDesc1 = cur_Subtotal.porDesc1
lnPorDesc2 = cur_Subtotal.porDesc2
lnPorDesc3 = cur_Subtotal.porDesc3
lnPorDesc4 = cur_Subtotal.porDesc4
lnImpDesc1 = cur_Subtotal.impDesc1
lnImpDesc2 = cur_Subtotal.impDesc2
lnImpDesc3 = cur_Subtotal.impDesc3
lnImpDesc4 = cur_Subtotal.impDesc4
lnTotFact = cur_Subtotal.totFact
lnPorRec = cur_Subtotal.porRec
lnImpRec = cur_Subtotal.impRec
lnIdCondPago = clientes.idCondPago
lnIdSitIVA = clientes.idSitIVA

IF ALLTRIM(thisform.cbte) == "PTO"
	lnIdVentasC = loConDMO.GetNextID("ventascab", "idVentasC")
ELSE
	lnIdVentasC = goConn.GetNextID("ventascab", "idVentasC")
ENDIF

&& Calculo la fecha de vencimiento correspondiente a la factura
&& Calculo la fecha de vencimiento correspondiente a la factura
IF ALLTRIM(Thisform.cbte) == "FC" .OR. ALLTRIM(Thisform.cbte) == "PTO" THEN 
	IF thisform.cp_cntdias <> 0 THEN
		ldFecVto = Thisform.contenido.txtFecEmis.Value + thisform.cp_cntdias
	ELSE
		ldFecVto = Thisform.contenido.txtFecEmis.Value
	ENDIF 
ELSE
	ldFecVto = Thisform.contenido.txtFecEmis.Value
ENDIF

IF ALLTRIM(Thisform.cbte) == "FC" .OR. ALLTRIM(Thisform.cbte) == "PTO" THEN
	lnSaldo = lnTotFact
ELSE
	lnSaldo = 0
ENDIF
	
lcSql = "INSERT INTO ventascab ( "
lcSql = lcSql + "idVentasC, idCliente, razSoc, idTipoDoc, nroDoc, fecEmision, cbte, tipoDoc, ptoVta, numCbte, anulado, idCondPago, idSitIVA, idVendedor,"
lcSql = lcSql + "impNeto, impFinal, porIVA21, impIVA21, porIVA105, impIVA105, porDesc1, "
lcSql = lcSql + "porDesc2, porDesc3, porDesc4, impDesc1, impDesc2, impDesc3, impDesc4, totFact, Saldo, usuAlta, fecAlta, idHostAlta, observ, porIIBB, impIIBB, fecVto, porRec, impRec, nroOC) VALUES ("
lcSql = lcSql + ALLTRIM(STR(lnIdVentasC)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnIdCliente)) + ", "
lcSql = lcSql + "'" + STRTRAN(ALLTRIM(Thisform.contenido.sel_Cliente.txtDescripcion.Value), "'", "''") + "', "
lcSql = lcSql + ALLTRIM(STR(Thisform.cli_idTipoDoc)) + ", "
lcSql = lcSql + "'" + ALLTRIM(Thisform.contenido.txtCuit.Value) + "', "
*lcSql = lcSql + oDT.getDateTime() + ", "
lcSql = lcSql + oDT.toMySql(Thisform.contenido.txtFecEmis.Value) + ", "
lcSql = lcSql + "'" + IIF(ALLTRIM(lcCbte) == "PTO", "FC", ALLTRIM(lcCbte)) + "', "
lcSql = lcSql + "'" + ALLTRIM(lcTipoDoc) + "', "
lcSql = lcSql + ALLTRIM(STR(lnPtoVta)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnNroCbte)) + ", "
lcSql = lcSql + IIF(lnSqlSrv = 0, "false", "0") + ", "
lcSql = lcSql + ALLTRIM(STR(lnIdCondPago)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnIdSitIVA)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnIdVendedor)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpNeto, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpFinal, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnPorIVA21, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpIVA21, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnPorIVA105, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpIVA105, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnPorDesc1, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnPorDesc2, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnPorDesc3, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnPorDesc4, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpDesc1, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpDesc2, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpDesc3, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpDesc4, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnTotFact, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnSaldo, 10, 2)) + ", "
lcSql = lcSql + "'" + ALLTRIM(gcCodUsu) + "', " 
lcSql = lcSql + oDT.getDateTime() + ", "
lcSql = lcSql + "'" + SYS(0) + "', '" + ALLTRIM(lcObserv) + "', "
lcSql = lcSql + ALLTRIM(STR(lnPorIIBB, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpIIBB, 10, 2)) + ", "

IF INT(VAL(getconfig("SQLSRV"))) = 1 THEN
	lcSql = lcSql + oDT.getDateTime() + " + " + ALLTRIM(STR(thisform.cp_cntdias)) + ", "
ELSE
	lcSql = lcSql + oDT.toMySql(ldFecVto) + ", "
ENDIF

lcSql = lcSql + ALLTRIM(STR(lnPorRec, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpRec, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnOC)) + ")"

loCommand.CommandText = lcSql

IF ALLTRIM(lcCbte) == "PTO" THEN
	loCommand.ActiveConnection = loConDMO.ActiveConnection
	
	IF !loCommand.Execute()
		thisform.desbloq_numerador()
		loConDMO.Rollback()
		RETURN .F.
	ENDIF	
ELSE
	loCommand.ActiveConnection = goConn.ActiveConnection
	IF !loCommand.Execute()
		thisform.desbloq_numerador()
		goConn.Rollback()
		RETURN .F.
	ENDIF
ENDIF

&& Grabo el detalle del comprobante

SELECT cur_aux
IF RECCOUNT() > 0
	GO TOP
ENDIF

lnIdVentasD = 0

DO WHILE !EOF()
	lnIdVentasD = lnIdVentasD + 1
	
	lnIdArticulo = cur_aux.idArticulo
	lnCantidad = cur_aux.cantidad
	lnAlicIVA = cur_aux.alicIVA
	lnPrVenta = cur_aux.PrVta
	lnImpIVA = cur_aux.impIVA
	lnPrNeto = cur_aux.impNeto
	lnTotNeto = cur_aux.totNeto
	lnSubTotal = cur_aux.subTotal
	lnPDtoVta1 = cur_aux.pDtoVta1
	lnPDtoVta2 = cur_aux.pDtoVta2
	lnPDtoVta3 = cur_aux.pDtoVta3
	lnPDtoVta4 = cur_aux.pDtoVta4
	lnIDtoVta1 = cur_aux.iDtoVta1
	lnIDtoVta2 = cur_aux.iDtoVta2
	lnIDtoVta3 = cur_aux.iDtoVta3
	lnIDtoVta4 = cur_aux.iDtoVta4
	
	lnPorDesc1 = cur_aux.pDtoCli1
	lnPorDesc2 = cur_aux.pDtoCli2
	lnPorDesc3 = cur_aux.pDtoCli3
	lnPorDesc4 = cur_aux.pDtoCli4
	lnImpDesc1 = cur_aux.iDtoCli1
	lnImpDesc2 = cur_aux.iDtoCli2
	lnImpDesc3 = cur_aux.iDtoCli3
	lnImpDesc4 = cur_aux.iDtoCli4
	
	lnPrArtic = cur_aux.prArtic
	lnPorRec = cur_aux.pRecVta
	lnImpRec = cur_aux.iRecVta
	lnUniDesp = cur_aux.uniDesp
	lnCantPack = cur_aux.cantPack
	lcUniMed = cur_aux.uniMed
	lnPRecItem = cur_aux.pRecItem
	lnIRecItem = cur_aux.iRecItem
	
	lcSql = "SELECT * FROM articulos WHERE idArticulo = " + ALLTRIM(STR(lnIdArticulo))
	
	IF ALLTRIM(lcCbte) == "PTO" THEN
		loArtic.ActiveConnection = loConDMO.ActiveConnection
	ELSE
		loArtic.ActiveConnection = goConn.ActiveConnection
	ENDIF
	
	loArtic.Cursor_Name = "cur_Artic"
	loArtic.OpenQuery(lcSql)
	
	SELECT cur_Artic
	lnCostoRep = cur_Artic.costoRep
	
	loArtic.close_query()

	lcSql = "INSERT INTO ventasdet ( "
	lcSql = lcSql + "idVentasD, "
	lcSql = lcSql + "idVentasC, "
	lcSql = lcSql + "idArticulo, "
	lcSql = lcSql + "descripcio, "
	lcSql = lcSQl + "nroPart, "
	lcSql = lcSql + "Cantidad, "
	
	IF ALLTRIM(lcCbte) == "PED"  .OR. ALLTRIM(lcCbte) == "COT" THEN
		lcSql = lcSql + "cant_pri1, "
	ENDIF
	
	lcSql = lcSql + "costoRep, "
	lcSql = lcSql + "prVenta, "
	lcSql = lcSql + "alicIVA, "
	lcSql = lcSql + "impIVA, "
	lcSql = lcSql + "subTotal, "
	lcSql = lcSql + "porDesc1, "
	lcSql = lcSql + "porDesc2, "
	lcSql = lcSql + "porDesc3, "
	lcSql = lcSql + "porDesc4, "
	lcSql = lcSql + "impDesc1, "
	lcSql = lcSql + "impDesc2, "
	lcSql = lcSql + "impDesc3, "
	lcSql = lcSql + "impDesc4, "
	lcSql = lcSql + "pDtoVta1, "
	lcSql = lcSql + "pDtoVta2, "
	lcSql = lcSql + "pDtoVta3, "
	lcSql = lcSql + "pDtoVta4, "
	lcSql = lcSql + "iDtoVta1, "
	lcSql = lcSql + "iDtoVta2, "
	lcSql = lcSql + "iDtoVta3, "
	lcSql = lcSql + "iDtoVta4, "
	lcSql = lcSql + "pRecItem, "
	lcSql = lcSql + "iRecItem, "
	lcSql = lcSql + "impNeto, "
	lcSql = lcSql + "totNeto, "
	lcSql = lcSql + "prArtic, "
	lcSql = lcSql + "esOferta, "
	lcSql = lcSql + "pRecVta, "
	lcSql = lcSql + "iRecVta, "
	lcSql = lcSql + "uniDesp, "
	lcSql = lcSql + "cantPack, "
	lcSql = lcSql + "codUM) VALUES ( "
	lcSql = lcSql + ALLTRIM(STR(lnIdVentasD)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIdVentasC)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIdArticulo)) + ", "
	lcSql = lcSql + "'" + STRTRAN(ALLTRIM(cur_aux.descripcio), "'", "''") + "', "
	lcSql = lcSql + "'" + ALLTRIM(cur_aux.nroPart) + "', "
	lcSql = lcSql + ALLTRIM(STR(lnCantidad, 10, 2)) + ", "
	
	IF ALLTRIM(lcCbte) == "PED" .OR. ALLTRIM(lcCbte) == "COT" THEN
		lcSql = lcSql + ALLTRIM(STR(lnCantidad, 10, 2)) + ", "
	ENDIF	
	
	lcSql = lcSql + ALLTRIM(STR(lnCostoRep, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPrVenta, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnAlicIVA, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnImpIVA, 10, 4)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnSubTotal, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPorDesc1, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPorDesc2, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPorDesc3, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPorDesc4, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnImpDesc1, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnImpDesc2, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnImpDesc3, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnImpDesc4, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPDtoVta1, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPDtoVta2, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPDtoVta3, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPDtoVta4, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIDtoVta1, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIDtoVta2, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIDtoVta3, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIDtoVta4, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPRecItem, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIRecItem, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPrNeto, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnTotNeto, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPrArtic, 10, 2)) + ", "
	lcSql = lcSql + IIF(cur_detalle.esOferta, "1", "0") + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPorRec, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnImpRec, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnUniDesp, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnCantPack, 10, 2)) + ", "
	lcSql = lcSql + "'" + ALLTRIM(lcUniMed) + "')"
	
	*******************************************************************************************
	
	loCommand.CommandText = lcSql

	IF ALLTRIM(lcCbte) == "PTO" 
		loCommand.ActiveConnection = loConDMO.ActiveConnection
		IF !loCommand.Execute()
			thisform.desbloq_numerador()
			loConDMO.Rollback()
			RETURN .F.
		ENDIF	
	ELSE
		loCommand.ActiveConnection = goConn.ActiveConnection
		IF !loCommand.Execute()
			thisform.desbloq_numerador()
			goConn.Rollback()
			RETURN .F.
		ENDIF
	ENDIF	
	
	&& Si es nota de crédito entonces, actualizo la cantidad de NC en los
	&& items de la factura.
	&& Actualizar este dato tiene como objetivo de que si se hace más una NC
	&& que no se pueda hacer dos veces sobre la misma cantidad de un producto
	&& sino que por el resto.
	
	IF ALLTRIM(Thisform.cbte) == "NC" THEN
		lcSql = "UPDATE ventasdet SET cantNC = cantNC + " + ALLTRIM(STR(lnCantidad, 10, 2)) + " "
		lcSql = lcSql + "WHERE idVentasC = " + ALLTRIM(STR(Thisform.idorigen)) + " "
		lcSql = lcSql + " AND idArticulo = " + ALLTRIM(STR(cur_aux.idArticulo))
		
		loCommand.ActiveConnection = goConn.ActiveConnection
		loCommand.CommandText = lcSql
		
		IF !loCommand.Execute() THEN
			thisform.desbloq_numerador()
			goConn.Rollback()
			RETURN .F.
		ENDIF
	ENDIF
	
	SELECT cur_aux
	SKIP
ENDDO

IF ALLTRIM(thisform.cbte) == "FC" .OR. ALLTRIM(thisform.cbte) == "PTO" THEN
	IF ALLTRIM(thisform.cbte) == "PTO" THEN
		lnProxID = loConDMO.GetNextId("cc_cli", "idCC_Cli")
		lnIdOper = loConDMO.GetNextID("cc_cli", "idOper")		
	ELSE
		lnProxID = goConn.GetNextId("cc_cli", "idCC_Cli")
		lnIdOper = goConn.GetNextID("cc_cli", "idOper")
	ENDIF
	
	lnIdCliente = Thisform.contenido.sel_Cliente.valcpoid

	&& Inserto el registro correspondiente a la factura en la tabla de cuentas corrientes
	lcSql = "INSERT INTO cc_cli (idCC_Cli, idCliente, idCC_Orig, cbte, nroCbte, tipoDoc, ptoVta, idCondPago, idSitIVA, idVendedor, "
	lcSql = lcSql + "fecEmis, fecVto, impDebe, impHaber, idOper, idVentasC, usuAlta, fecAlta, idHostAlta) VALUES ( "
	lcSql = lcSql + ALLTRIM(STR(lnProxID)) + ", " + ALLTRIM(STR(lnIdCliente)) + ", null, '" + IIF(ALLTRIM(lcCbte) == "PTO", "FC", ALLTRIM(lcCbte)) + "', "
	lcSql = lcSql + ALLTRIM(STR(lnNroCbte)) + ", '" + ALLTRIM(lcTipoDoc) + "', " + ALLTRIM(STR(lnPtoVta)) + ", " + ALLTRIM(STR(lnIdCondPago)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIdSitIVA)) + ", " + ALLTRIM(STR(lnIdVendedor)) + ", " + oDT.getDateTime() + ", "
	lcSql = lcsql + IIF(INT(VAL(getconfig("SQLSRV"))) = 1, oDT.getDateTime() + " + " + ALLTRIM(STR(thisform.cp_cntdias)), oDT.toMySql(ldFecVto)) + ", " + ALLTRIM(STR(lnTotFact, 10, 2)) + ", 0, " + ALLTRIM(STR(lnIdOper)) + ", " + ALLTRIM(STR(lnIdVentasC)) + ", "
	lcSql = lcSql + "'" + ALLTRIM(gcCodUsu) + "', " + oDT.getDateTime() + ", '" + ALLTRIM(SYS(0)) + "')"

	IF ALLTRIM(thisform.cbte) == "PTO" THEN	
		loCommand.ActiveConnection = loConDMO.ActiveConnection
	ELSE
		loCommand.ActiveConnection = goConn.ActiveConnection
	ENDIF
	
	loCommand.CommandText = lcSql
	
	IF !loCommand.Execute()	
		thisform.desbloq_numerador()
		goConn.Rollback()
		RETURN .F.
	ENDIF
ELSE
	IF ALLTRIM(Thisform.cbte) == "NC" THEN
		&& Verifico si tiene numero de operación asignado
		lcSql = "SELECT idCC_Cli, idOper FROM cc_cli WHERE idVentasC = " + ALLTRIM(STR(Thisform.idorigen))
		loOper.ActiveConnection = goConn.ActiveConnection
		loOper.Cursor_Name = "cur_Oper"
		loOper.OpenQuery(lcSql)
		
		lnIdCCOrig = cur_Oper.idCC_Cli
		lnIdOper = cur_Oper.idOper
		
		loOper.Close_Query()
		
		&& Tengo que calcular el Id de Operación para vincular ambos comprobantes
		IF lnIdOper = 0 THEN
			lcSql = "SELECT MAX(cc_cli.idOper) AS maxIdOper FROM cc_cli"
			loOper.ActiveConnection = goConn.ActiveConnection
			loOper.Cursor_Name = "cur_Oper"
			loOper.OpenQuery(lcSql)
			
			lnIdOper = cur_Oper.maxIdOper + 1
			
			loOper.Close_Query()
		
			&& Actualizo el comprobante de origen con el Id de Operación calculado
			lcSql = "UPDATE cc_cli SET idOper = " + ALLTRIM(STR(lnIdOper)) + " WHERE idVentasC = " + ALLTRIM(STR(Thisform.idorigen))
			loCommand.ActiveConnection = goConn.ActiveConnection
			loCommand.CommandText = lcSql
		
			IF !loCommand.Execute()
				thisform.desbloq_numerador()
				goConn.Rollback()
				RETURN .F.
			ENDIF	
		ENDIF
		
		&& Genero el registro de la nota de crédito en las cuentas corrientes del cliente
		
		lnProxID = goConn.GetNextId("cc_cli", "idCC_Cli")
		lnIdCliente = Thisform.contenido.sel_Cliente.valcpoid	
		
		lcSql = "INSERT INTO cc_cli (idCC_Cli, idCliente, idCC_Orig, cbte, nroCbte, tipoDoc, ptoVta, idCondPago, idSitIVA, idVendedor, "
		lcSql = lcSql + "fecEmis, fecvto, impDebe, impHaber, idOper, idVentasC, usuAlta, fecAlta, idHostAlta) VALUES ( "
		lcSql = lcSql + ALLTRIM(STR(lnProxID)) + ", " + ALLTRIM(STR(lnIdCliente)) + ", " + ALLTRIM(STR(lnIdCCOrig)) + ", '" + ALLTRIM(lcCbte) + "', "
		lcSql = lcSql + ALLTRIM(STR(lnNroCbte)) + ", '" + ALLTRIM(lcTipoDoc) + "', " + ALLTRIM(STR(lnPtoVta)) + ", " + ALLTRIM(STR(lnIdCondPago)) + ", "
		lcSql = lcSql + ALLTRIM(STR(lnIdSitIVA)) + ", " + ALLTRIM(STR(lnIdVendedor)) + ", " + oDT.toMySql(Thisform.contenido.txtFecEmis.Value) + ", "
		lcSql = lcsql + IIF(INT(VAL(getconfig("SQLSRV"))) = 1, oDT.getDateTime() + " + " + ALLTRIM(STR(thisform.cp_cntdias)), oDT.toMySql(ldFecVto)) + ", 0, " + ALLTRIM(STR(lnTotFact, 10, 2)) + ", " + ALLTRIM(STR(lnIdOper)) + ", " + ALLTRIM(STR(lnIdVentasC)) + ", "
		lcSql = lcSql + "'" + ALLTRIM(gcCodUsu) + "', " + oDT.getDateTime() + ", '" + ALLTRIM(SYS(0)) + "')"
		
		loCommand.ActiveConnection = goConn.ActiveConnection
		loCommand.CommandText = lcSql
		
		IF !loCommand.Execute()
			thisform.desbloq_numerador()
			goConn.Rollback()
			RETURN .F.
		ENDIF
		
		lnSaldo = Thisform.saldo_fc - lnTotFact 
		
		&& Actualizo el Saldo en la factura para validar que no se pueda
		&& aplicar un importe superior al saldo.
		lcSql = "UPDATE ventascab SET saldo = " + ALLTRIM(STR(lnSaldo, 10, 2)) + ", "
		lcSql = lcSql + "usuModi = '" + ALLTRIM(gcCodUsu) + "', "
		lcSql = lcSql + "fecModi = " + oDT.getDateTime() + ", "
		lcSql = lcSql + "idHostModi = '" + ALLTRIM(SYS(0)) + "' " 				
		lcSql = lcSql + "WHERE idVentasC = " + ALLTRIM(STR(Thisform.idorigen))
		
		loCommand.ActiveConnection = goConn.ActiveConnection
		
		loCommand.CommandText = lcSql
		IF !loCommand.Execute()
			thisform.desbloq_numerador()
			goConn.Rollback()
			RETURN .F.
		ENDIF	
	ENDIF
ENDIF

&& Ahora tengo que generar la relación entre el comprobante de origen con el comprobante
&& de destino
IF (ALLTRIM(Thisform.cbte) == "NC") .OR. (ALLTRIM(Thisform.Cbte) == "FC") .OR. (ALLTRIM(Thisform.cbte) == "PTO") THEN
	SELECT cur_cbtes
	IF RECCOUNT("cur_cbtes") > 0 THEN
		GO TOP
	ENDIF
	
	DO WHILE !EOF("cur_cbtes")
		IF cur_cbtes.sel THEN
			IF ALLTRIM(thisform.cbte) == "PTO" THEN
				lnProxID = loConDMO.GetNextId("ventasrel", "idVtaRel")
			ELSE
				lnProxID = goConn.GetNextId("ventasrel", "idVtaRel")
			ENDIF
			
			lcSql = "INSERT INTO ventasrel (idVtaRel, idVtaCO, idVtaCD) VALUES ("
			lcSql = lcSql + ALLTRIM(STR(lnProxID)) + ", " + ALLTRIM(STR(cur_cbtes.idVentasC)) + ", " + ALLTRIM(STR(lnIdVentasC)) + ")"
			
			loCommand.CommandText = lcSql

			IF ALLTRIM(lcCbte) == "PTO" 
				loCommand.ActiveConnection = loConDMO.ActiveConnection
				IF !loCommand.Execute()
					thisform.desbloq_numerador()
					loConDMO.Rollback()
					RETURN .F.
				ENDIF	
			ELSE
				loCommand.ActiveConnection = goConn.ActiveConnection
				IF !loCommand.Execute()
					thisform.desbloq_numerador()
					goConn.Rollback()
					RETURN .F.
				ENDIF
			ENDIF
		ENDIF
		
		SELECT cur_cbtes
		SKIP
	ENDDO
ENDIF

************************************************************************************************
* Agrego que se genere el movimiento de stock al grabar la operación
* siempre y cuando el sistema se encuentre configurado para soportar esta funcionalidad
************************************************************************************************
IF getGlobalCFG("STK_MODULE") .AND. (ALLTRIM(THisform.Cbte) <> "COT" .OR. ALLTRIM(THisform.Cbte) <> "NC") THEN
	IF ALLTRIM(thisform.cbte) == "PTO" THEN
		Thisform.mov_stock.circuito = "S"
		Thisform.mov_stock.tipodoc = ""
		Thisform.mov_stock.cbte = ""
	ELSE
		Thisform.mov_stock.circuito = "V"
		Thisform.mov_stock.idcliente = thisform.contenido.sel_Cliente.valcpoid
		Thisform.mov_stock.idprov = 0
		Thisform.mov_stock.tipodoc = Thisform.tipodoc
		Thisform.mov_stock.cbte = IIF(ALLTRIM(lcCbte) == "PTO", "SAL", lcCbte)
		Thisform.mov_stock.numcbte =  REPLICATE("0", 4 - LEN(ALLTRIM(STR(lnPtoVta)))) + ALLTRIM(STR(lnPtoVta)) + "-" + REPLICATE("0", 8 - LEN(ALLTRIM(STR(lnNroCbte)))) + ALLTRIM(STR(lnNroCbte))		
	ENDIF
	
	IF !(ALLTRIM(Thisform.cbte) == "COT") THEN
		IF !(ALLTRIM(Thisform.cbte) == "PED") THEN
			IF !Thisform.mov_stock.grabar2() THEN
				MESSAGEBOX(Thisform.mov_stock.ErrorMessage, 0+48, Thisform.Caption)
				thisform.desbloq_numerador()
				goConn.Rollback()
				RETURN .F.
			ENDIF
		ENDIF	
	ENDIF
ENDIF

IF ALLTRIM(thisform.cbte) == "PTO" THEN
	loConDMO.Commit()
	loConDMO.close()	
ELSE
	goConn.Commit()
ENDIF

thisform.desbloq_numerador()

MESSAGEBOX("El comprobante: " + ALLTRIM(lcCbte) + " " + ALLTRIM(lcTipoDoc) + " " + REPLICATE("0", 4 - LEN(ALLTRIM(STR(lnPtoVta)))) + ALLTRIM(STR(lnPtoVta)) + "-" + ;
	REPLICATE("0", 8 - LEN(ALLTRIM(STR(lnNroCbte)))) + ALLTRIM(STR(lnNroCbte)) + " se ha generado exitosamente...", 0+64, Thisform.Caption)

IF getGlobalCFG("NOTIF_TAL") THEN
	MESSAGEBOX("Insertar Talonario '" + ALLTRIM(thisform.cbte) + "' del tipo '" + ALLTRIM(thisform.tipodoc) + "' en la impresora y luego haga clic en continuar.", 0+64, Thisform.Caption)
ENDIF

RETURN .T.
ENDPROC
PROCEDURE calc_subtot_cur_aux
LOCAL lnImpNeto, lnImpFinal, lnPorIVA21, lnImpIVA21, lnPorIVA105, lnImpIVA105
LOCAL lnPorDesc1, lnPorDesc2, lnPorDesc3, lnPorDesc4, lnImpDesc1, lnImpDesc2, lnImpDesc3, lnImpDesc4, lnTotFact
LOCAL lnPorIIBB, lnImpIIBB, lnImpRec, lnPorRec

lnImpNeto = 0.00
lnImpFinal = 0.00
lnImpIVA21 = 0.00
lnImpIVA105 = 0.00 
lnImpDesc1 = 0.00
lnImpDesc2 = 0.00
lnImpDesc3 = 0.00
lnImpDesc4 = 0.00
lnTotFact = 0.00
lnImpRec = 0.00
lnPorRec = Thisform.Contenido.txtPorRec.Value

SELECT cur_subtotal
ZAP 

&& Recorro el cursor cur_aux y voy sumando y guardando en variables los campos
SELECT cur_aux
GO TOP

DO WHILE !EOF()
 	lnImpNeto = lnImpNeto + ROUND(cur_aux.prArtic * cur_aux.cantidad, 2)
 	lnImpDesc1 = lnImpDesc1 + ROUND(cur_aux.iDtoCli1 * cur_aux.cantidad, 2)
	lnImpDesc2 = lnImpDesc2 + ROUND(cur_aux.iDtoCli2 * cur_aux.cantidad, 2)
	lnImpDesc3 = lnImpDesc3 + ROUND(cur_aux.iDtoCli3 * cur_aux.cantidad, 2)
	lnImpDesc4 = lnImpDesc4 + ROUND(cur_aux.iDtoCli4 * cur_aux.cantidad, 2)
 	lnImpRec = lnImpRec + ROUND(cur_aux.iRecVta * cur_aux.cantidad, 2)
 	
	lnImpFinal = lnImpFinal + cur_aux.totneto
	&&lnTotFact = lnTotFact + cur_aux.subtotal
	*lnTotFact = lnTotFact + cur_aux.totneto + cur_aux.impiva
	
	IF cur_aux.alicIVA = 21
		lnImpIVA21 = lnImpIVA21 + cur_aux.impiva
	ELSE 
		IF cur_aux.alicIVA = 10.5
			lnImpIVA105 = lnImpIVA105 + cur_aux.impiva
		ENDIF 
	ENDIF
	
	SELECT cur_aux
	SKIP 
ENDDO

lnTotFact = ROUND(lnImpFinal + lnImpIVA21 + lnImpIVA105, 2)

&& Guardo en el cursor cur_subtotal los subtotales que calcule
SELECT cur_subtotal
APPEND BLANK

REPLACE cur_subtotal.impneto WITH lnImpNeto
REPLACE cur_subtotal.impfinal WITH lnImpFinal ADDITIVE
REPLACE cur_subtotal.porIVA21 WITH Thisform.contenido.txtporIVA21.Value ADDITIVE 
REPLACE cur_subtotal.impIVA21 WITH ROUND(lnImpIVA21,2) ADDITIVE 
REPLACE cur_subtotal.porIVA105 WITH Thisform.contenido.txtporIVA105.Value ADDITIVE 
REPLACE cur_subtotal.impIVA105 WITH ROUND(lnImpIVA105,2) ADDITIVE 
REPLACE cur_subtotal.porDesc1 WITH Thisform.contenido.txtdesc1.Value ADDITIVE 
REPLACE cur_subtotal.porDesc2 WITH Thisform.contenido.txtdesc2.Value ADDITIVE 
REPLACE cur_subtotal.porDesc3 WITH Thisform.contenido.txtdesc3.Value ADDITIVE 
REPLACE cur_subtotal.porDesc4 WITH Thisform.contenido.txtdesc4.Value ADDITIVE 
REPLACE cur_subtotal.impDesc1 WITH lnImpDesc1 ADDITIVE 
REPLACE cur_subtotal.impDesc2 WITH lnImpDesc2 ADDITIVE 
REPLACE cur_subtotal.impDesc3 WITH lnImpDesc3 ADDITIVE 
REPLACE cur_subtotal.impDesc4 WITH lnImpDesc4 ADDITIVE  
REPLACE cur_subtotal.porIIBB WITH Thisform.contenido.txtporIIBB.Value ADDITIVE 
REPLACE cur_subtotal.impIIBB WITH ROUND(lnImpFinal * (cur_subtotal.porIIBB / 100) ,2) ADDITIVE
REPLACE cur_subtotal.totfact WITH ROUND(lnTotFact + cur_subtotal.impIIBB, 3) ADDITIVE 
REPLACE cur_subtotal.porRec WITH thisform.contenido.txtPorRec.Value ADDITIVE
REPLACE cur_subtotal.impRec WITH lnImpRec ADDITIVE

ENDPROC
PROCEDURE asignar_partida
PARAMETERS tnIdArticulo, tnCantidad

LOCAL lcSql, loResult, lnResto, lnCant

lcSql = ""
loResult = CREATEOBJECT("odbc_result")
lnResto = 0.00
lnCant = 0.00

SELECT cur_DetPart
ZAP

lcSql = "SELECT		nroPart, "
lcSql = lcSql + "	MIN(fecha) AS fecha, "
lcSql = lcSql + "	SUM(cantidad) AS totCant "
lcSql = lcSql + "FROM	stk_part "
lcSql = lcSql + "WHERE	idArticulo = " + ALLTRIM(STR(tnIdArticulo)) + " "
lcSql = lcSql + "GROUP BY nroPart "
lcSql = lcSql + "HAVING SUM(cantidad) <> 0 "
lcSql = lcSql + "ORDER BY MIN(fecha), nroPart "

loResult.ActiveConnection = goConn.ActiveConnection
loResult.Cursor_Name = "cur_partida"

IF !loResult.OpenQuery(lcSql) THEN
	MESSAGEBOX(loResult.Error_Message, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

lnResto = tnCantidad

SELECT cur_partida
GO TOP

DO WHILE !EOF("cur_partida") 
	IF lnResto > cur_partida.totCant THEN
		lnCant = cur_partida.totCant
		lnResto = lnResto - cur_partida.totCant
	ELSE
		lnCant = lnResto
		lnResto = lnResto - cur_partida.totCant
	ENDIF
	
	SELECT cur_DetPart
	APPEND BLANK
	REPLACE cur_DetPart.idArticulo WITH tnIdArticulo 
	REPLACE cur_DetPart.nroPart WITH cur_partida.nroPart ADDITIVE
	REPLACE cur_DetPart.cantidad WITH ROUND(lnCant, 2) ADDITIVE
		
	IF lnResto <= 0  THEN
		EXIT
	ENDIF
	
	SELECT cur_partida
	SKIP
ENDDO

&& Verifico si el resto es mayor a cero, si lo es significa que no tengo mas stock por partida 
&& y lo tengo que sacar normalmente.
SELECT cur_partida
GO TOP

IF RECCOUNT("cur_partida") > 0
	IF lnResto > 0
		SELECT cur_DetPart
		APPEND BLANK
		REPLACE cur_DetPart.idArticulo WITH tnIdArticulo 
		REPLACE cur_DetPart.nroPart WITH "" ADDITIVE
		REPLACE cur_DetPart.cantidad WITH ROUND(lnResto, 2) ADDITIVE
	ENDIF 
ENDIF 

loResult.Close_Query()

SELECT cur_DetPart
GO TOP

RETURN .T.
ENDPROC
PROCEDURE agregar_item
LOCAL loResult, lcSql, lnSTNeto, lnAlicIva

loResult = CREATEOBJECT("odbc_result")
lcSql = ""
lnSTNeto = 0.00
lnAlicIva = 0.00

SELECT cur_detalle
ZAP 

IF glVersionBeta THEN
	SELECT cur_Deta_View
	IF RECCOUNT() >= 5 THEN
		MESSAGEBOX("Usted está utilizando una versión límitada del sistema, si desea comprarlo envíe un mail a ldz.software@gmail.com", 0+64, Thisform.Caption)
		RETURN .F.
	ENDIF
ENDIF

* Valido si el artículo ya se encuentra cargado en el presupuesto

SELECT cur_Deta_View
IF RECCOUNT("cur_Deta_View") > 0 THEN
	GO TOP
ENDIF

DO WHILE !EOF("cur_Deta_View")
	IF (ALLTRIM(Thisform.cbte) != "PED") THEN 
		IF !thisform.asignar_partida(cur_Deta_View.idArticulo, cur_Deta_View.Cantidad) THEN
			MESSAGEBOX("Ha ocurrido un error al intentar asignar partidas", 0+48, thisform.Caption)
			RETURN .F.
		ENDIF
	ENDIF  
	
	&& Si cur_DetPart es 0 (Cero)
	SELECT cur_DetPart
	IF RECCOUNT("cur_DetPart") = 0 THEN
		SELECT cur_Detalle
		APPEND BLANK
		REPLACE cur_Detalle.idDetalle WITH RECCOUNT("cur_Detalle") + 1
		REPLACE cur_Detalle.idArticulo WITH cur_Deta_View.idArticulo 			ADDITIVE
		REPLACE cur_Detalle.codArt WITH ALLTRIM(cur_Deta_View.codArt)			ADDITIVE
		REPLACE cur_Detalle.descripcio WITH ALLTRIM(cur_Deta_View.descripcio) 	ADDITIVE
		REPLACE cur_Detalle.nroPart WITH "" 									ADDITIVE
		REPLACE cur_Detalle.cantidad WITH cur_Deta_View.cantidad 				ADDITIVE
		REPLACE cur_Detalle.prVta WITH cur_Deta_View.prVta						ADDITIVE
		REPLACE cur_Detalle.prArtic WITH cur_Deta_View.prArtic					ADDITIVE
		REPLACE cur_Detalle.pDtoVta1 WITH cur_Deta_View.pDtoVta1				ADDITIVE
		REPLACE cur_Detalle.pDtoVta2 WITH cur_Deta_View.pDtoVta2				ADDITIVE
		REPLACE cur_Detalle.pDtoVta3 WITH cur_Deta_View.pDtoVta3				ADDITIVE
		REPLACE cur_Detalle.pDtoVta4 WITH cur_Deta_View.pDtoVta4				ADDITIVE
		REPLACE cur_Detalle.iDtoVta1 WITH cur_Deta_View.iDtoVta1				ADDITIVE
		REPLACE cur_Detalle.iDtoVta2 WITH cur_Deta_View.iDtoVta2				ADDITIVE
		REPLACE cur_Detalle.iDtoVta3 WITH cur_Deta_View.iDtoVta3				ADDITIVE
		REPLACE cur_Detalle.iDtoVta4 WITH cur_Deta_View.iDtoVta4				ADDITIVE
		REPLACE cur_Detalle.impNeto WITH cur_Deta_View.impNeto					ADDITIVE
		
		&& Hago el cálculo del IVA y establezco 4 decimales. Hago el calculo aca porque en el cur_deta_view lo tengo en 2 decimales.
		IF (ALLTRIM(Thisform.cbte) == "PTO") THEN
			REPLACE cur_Detalle.impIVA WITH 0 ADDITIVE
			REPLACE cur_Detalle.alicIVA WITH 0 ADDITIVE
		ELSE
			lnAlicIva = cur_Deta_View.alicIVA
			REPLACE cur_Detalle.impIVA WITH ROUND(cur_Deta_View.totNeto * (lnAlicIva / 100), 4) ADDITIVE
			REPLACE cur_Detalle.alicIVA WITH lnAlicIva ADDITIVE
		ENDIF
			
		REPLACE cur_Detalle.totNeto WITH cur_Deta_View.totNeto					ADDITIVE
		REPLACE cur_Detalle.subTotal WITH cur_Deta_View.subTotal				ADDITIVE
		REPLACE cur_Detalle.pDtoCli1 WITH cur_Deta_View.pDtoCli1 				ADDITIVE
		REPLACE cur_Detalle.pDtoCli2 WITH cur_Deta_View.pDtoCli2 				ADDITIVE
		REPLACE cur_Detalle.pDtoCli3 WITH cur_Deta_View.pDtoCli3 				ADDITIVE
		REPLACE cur_Detalle.pDtoCli4 WITH cur_Deta_View.pDtoCli4 				ADDITIVE
		REPLACE cur_Detalle.iDtoCli1 WITH cur_Deta_View.iDtoCli1 				ADDITIVE
		REPLACE cur_Detalle.iDtoCli2 WITH cur_Deta_View.iDtoCli2 				ADDITIVE
		REPLACE cur_Detalle.iDtoCli3 WITH cur_Deta_View.iDtoCli3 				ADDITIVE
		REPLACE cur_Detalle.iDtoCli4 WITH cur_Deta_View.iDtoCli4 				ADDITIVE
		REPLACE cur_Detalle.esOferta WITH cur_Deta_View.esOferta 				ADDITIVE
		REPLACE cur_Detalle.pRecVta WITH cur_Deta_View.pRecVta					ADDITIVE 
		REPLACE cur_Detalle.iRecVta WITH cur_Deta_View.iRecVta					ADDITIVE 
		
		&& Incorporo el recargo por ítem
		REPLACE cur_Detalle.pRecItem WITH cur_Deta_View.pRecItem				ADDITIVE
		REPLACE cur_Detalle.iRecItem WITH cur_Deta_View.iRecItem				ADDITIVE		
		
		REPLACE cur_Detalle.uniDesp WITH cur_Deta_View.uniDesp					ADDITIVE
		REPLACE cur_Detalle.cantPack WITH cur_Deta_View.cantPack				ADDITIVE
		REPLACE cur_Detalle.uniMed WITH cur_Deta_View.uniMed					ADDITIVE		
	ELSE
		*************************************************************************************************
		* Paso por aca en el caso de que el artículo lleve número de partida
		*************************************************************************************************
		SELECT cur_DetPart
		GO TOP

		DO WHILE !EOF("cur_DetPart")
			SELECT cur_Detalle
			APPEND BLANK
			REPLACE cur_Detalle.idDetalle WITH RECCOUNT("cur_Detalle") + 1
			REPLACE cur_Detalle.idArticulo WITH cur_Deta_View.idArticulo 	ADDITIVE
			REPLACE cur_Detalle.codArt WITH cur_Deta_View.codArt	ADDITIVE
			REPLACE cur_Detalle.descripcio WITH IIF(ALLTRIM(cur_DetPart.nroPart) == "", ALLTRIM(cur_Deta_View.Descripcio), ALLTRIM(SUBSTR(cur_Deta_View.Descripcio, 1, 20)) + " (" + ALLTRIM(cur_DetPart.nroPart) + ")") ADDITIVE
			REPLACE cur_Detalle.nroPart WITH cur_DetPart.nroPart ADDITIVE
			REPLACE cur_Detalle.cantidad WITH cur_DetPart.cantidad ADDITIVE
			REPLACE cur_Detalle.prVta WITH cur_Deta_View.prVta ADDITIVE
			REPLACE cur_Detalle.prArtic WITH cur_Deta_View.prArtic ADDITIVE			
			REPLACE cur_Detalle.pDtoVta1 WITH cur_Deta_View.pDtoVta1				ADDITIVE
			REPLACE cur_Detalle.pDtoVta2 WITH cur_Deta_View.pDtoVta2				ADDITIVE
			REPLACE cur_Detalle.pDtoVta3 WITH cur_Deta_View.pDtoVta3				ADDITIVE
			REPLACE cur_Detalle.pDtoVta4 WITH cur_Deta_View.pDtoVta4				ADDITIVE
			REPLACE cur_Detalle.iDtoVta1 WITH cur_Deta_View.iDtoVta1				ADDITIVE
			REPLACE cur_Detalle.iDtoVta2 WITH cur_Deta_View.iDtoVta2				ADDITIVE
			REPLACE cur_Detalle.iDtoVta3 WITH cur_Deta_View.iDtoVta3				ADDITIVE
			REPLACE cur_Detalle.iDtoVta4 WITH cur_Deta_View.iDtoVta4				ADDITIVE
			REPLACE cur_Detalle.impNeto  WITH cur_Deta_View.impNeto					ADDITIVE

			lnSTNeto = ROUND(cur_Deta_View.impNeto * cur_DetPart.Cantidad, 2)
			
			&& Hago el cálculo del IVA y establezco 4 decimales. 
			IF (ALLTRIM(Thisform.cbte) == "PTO") THEN
				REPLACE cur_Detalle.impIVA WITH 0 ADDITIVE
				REPLACE cur_Detalle.alicIVA WITH 0 ADDITIVE
			ELSE
				lnAlicIva = cur_Deta_View.alicIVA
				REPLACE cur_Detalle.impIVA WITH ROUND(lnSTNeto  * (lnAlicIva / 100), 4) ADDITIVE
				REPLACE cur_Detalle.alicIVA WITH lnAlicIva ADDITIVE
			ENDIF
			
			REPLACE cur_Detalle.totNeto WITH lnSTNeto ADDITIVE
			REPLACE cur_Detalle.subTotal WITH lnSTNeto + cur_Detalle.impIVA ADDITIVE

			REPLACE cur_Detalle.pDtoCli1 WITH cur_Deta_View.pDtoCli1 ADDITIVE
			REPLACE cur_Detalle.pDtoCli2 WITH cur_Deta_View.pDtoCli2 ADDITIVE
			REPLACE cur_Detalle.pDtoCli3 WITH cur_Deta_View.pDtoCli3 ADDITIVE
			REPLACE cur_Detalle.pDtoCli4 WITH cur_Deta_View.pDtoCli4 ADDITIVE
			REPLACE cur_Detalle.iDtoCli1 WITH cur_Deta_View.iDtoCli1 ADDITIVE
			REPLACE cur_Detalle.iDtoCli2 WITH cur_Deta_View.iDtoCli2 ADDITIVE
			REPLACE cur_Detalle.iDtoCli3 WITH cur_Deta_View.iDtoCli3 ADDITIVE
			REPLACE cur_Detalle.iDtoCli4 WITH cur_Deta_View.iDtoCli4 ADDITIVE
			REPLACE cur_Detalle.esOferta WITH cur_Deta_View.esOferta ADDITIVE
			REPLACE cur_Detalle.pRecVta WITH cur_Deta_View.pRecVta ADDITIVE 
			REPLACE cur_Detalle.iRecVta WITH cur_Deta_View.iRecVta ADDITIVE 
			
			&& Incorporo el recargo por ítem
			REPLACE cur_Detalle.pRecItem WITH cur_Deta_View.pRecItem ADDITIVE
			REPLACE cur_Detalle.iRecItem WITH cur_Deta_View.iRecItem ADDITIVE
			
			REPLACE cur_Detalle.uniDesp WITH cur_Deta_View.uniDesp ADDITIVE
			REPLACE cur_Detalle.cantPack WITH cur_Deta_View.cantPack ADDITIVE
			REPLACE cur_Detalle.uniMed WITH cur_Deta_View.uniMed ADDITIVE	
					
			SELECT cur_DetPart
			SKIP
		ENDDO	
	ENDIF
	
	SELECT cur_Deta_View
	SKIP
ENDDO

RETURN .T.

ENDPROC
PROCEDURE agregar_item_viewer
LOCAL lnPDtoCli1, lnPDtoCli2, lnPDtoCli3, lnPDtoCli4
LOCAL lnIDtoCli1, lnIDtoCli2, lnIDtoCli3, lnIDtoCli4, lnCantAnt
LOCAL loResult, lcSql, lnPrecio, llEsOferta, lnproferta, lnAlicIva
LOCAL lnPrVta

lnPDtoCli1 = Thisform.contenido.txtDesc1.Value
lnPDtoCli2 = Thisform.contenido.txtDesc2.Value
lnPDtoCli3 = Thisform.contenido.txtDesc3.Value
lnPDtoCli4 = Thisform.contenido.txtDesc4.Value
lnIDtoCli1 = 0.00
lnIDtoCli2 = 0.00
lnIDtoCli3 = 0.00
lnIDtoCli4 = 0.00
lnPrecio = 0.00
loResult = CREATEOBJECT("odbc_result")
lcSql = ""
llEsOferta = .F.
lnproferta = 0.00
lnAlicIva = 0.00
lnCantAnt = 0.00

IF !Thisform.ValidarDetalle()
	RETURN .F.
ENDIF

lcSql = "SELECT * FROM articulos WHERE idArticulo = " + ALLTRIM(STR(Thisform.contenido.sel_Articulo.valcpoid))
loResult.ActiveConnection = goConn.ActiveConnection
loResult.Cursor_Name = "cur_Art"
loResult.OpenQuery(lcSql)

IF RIGHT(ALLTRIM(Thisform.Contenido.sel_Articulo.txtCodigo.Value), 3) == "ARX" THEN
	lnPrecio = Thisform.prarti_x
ELSE	
	IF clientes.mayorista THEN 
		lnPrecio = thisform.get_precio_oferta()
		lnproferta = lnPrecio
		
		IF lnPrecio = 0 THEN
			lnPrecio = cur_Art.prVentaMax
			llEsOferta = .F.
		ELSE
			llEsOferta = .T.
		ENDIF
	ELSE
		lnPrecio = cur_Art.prVentaMin
		llEsOferta = .F.
	ENDIF		
ENDIF

loResult.Close_Query()

IF glVersionBeta THEN
	SELECT cur_Deta_View
	IF RECCOUNT() = 5 THEN
		MESSAGEBOX("Usted está utilizando una versión límitada del sistema, si desea comprarlo envíe un mail a ldz.software@gmail.com", 0+64, Thisform.Caption)
		RETURN .F.
	ENDIF
ENDIF

* Valido si el artículo ya se encuentra cargado en el presupuesto
SELECT cur_Deta_View
IF RECCOUNT() > 0
	GO TOP
ENDIF

SELECT cur_Deta_View
DO WHILE !EOF()
	IF ALLTRIM(cur_Deta_View.codArt) == ALLTRIM(Thisform.contenido.sel_Articulo.txtCodigo.Value) THEN
		IF MESSAGEBOX("El artículo ya se encuentra cargado, ¿Desea acumular la cantidad?",4+32, Thisform.Caption) == 6 THEN
			lnCantAnt = Thisform.contenido.txtcantidad.Value
			Thisform.contenido.txtcantidad.Value = Thisform.contenido.txtcantidad.Value + cur_Deta_View.cantidad
			
			&& Vuelvo a verificar el stock nuevamente al acumular la cantidad 
			IF (ALLTRIM(Thisform.cbte) != "COT") .AND. (ALLTRIM(Thisform.cbte) != "NC") THEN
				&& Valido el stock solo en caso que no sea artículo X
				IF RIGHT(ALLTRIM(Thisform.Contenido.sel_Articulo.txtCodigo.Value), 3) != "ARX" THEN
					IF getGlobalCFG("STK_MODULE") THEN
						IF Thisform.mov_stock.get_exist_byart(Thisform.Contenido.sel_Articulo.valcpoid, "") <= 0 THEN
							Thisform.Contenido.sel_Articulo.txtCodigo.SetFocus()
							
							MESSAGEBOX("No hay stock disponible", 0+48, Thisform.Caption)				
							thisform.contenido.txtCantidad.Value = lnCantAnt
							thisform.contenido.txtCantidad.SetFocus()
							RETURN .F.
						ENDIF
						
						&& Valido si está o no cubierto al 100%
						IF Thisform.Contenido.txtCantidad.Value > Thisform.Contenido.txtExistencia.Value THEN
							MESSAGEBOX("No hay stock suficiente para cubrir la cantidad ingresada", 0+48, Thisform.Caption)
							thisform.contenido.txtCantidad.Value = lnCantAnt
							thisform.contenido.txtCantidad.SetFocus()
							RETURN .F.
						ENDIF
					ENDIF
				ENDIF
			ENDIF			
			
			Thisform.calc_item_desc()
			
			SELECT cur_Deta_View
			DELETE
		ELSE 
			Thisform.contenido.sel_Articulo.txtCodigo.SetFocus()
			RETURN .F.
		ENDIF 
	ENDIF

	SELECT cur_Deta_View
	SKIP
ENDDO

SELECT cur_Deta_View
APPEND BLANK
REPLACE cur_Deta_View.idDetalle WITH RECCOUNT("cur_Deta_View")
REPLACE cur_Deta_View.idArticulo WITH Thisform.contenido.sel_Articulo.valcpoid ADDITIVE	
REPLACE cur_Deta_View.codArt WITH Thisform.contenido.sel_Articulo.txtCodigo.Value ADDITIVE
REPLACE cur_Deta_View.descripcio WITH Thisform.contenido.sel_Articulo.txtDescripcion.Value ADDITIVE
REPLACE cur_Deta_View.cantidad WITH Thisform.contenido.txtCantidad.Value ADDITIVE

*******************************************************************************************************************************
* Verifico el tipo de cliente que es para saber desde donde tomar el precio
*******************************************************************************************************************************
IF RIGHT(ALLTRIM(Thisform.Contenido.sel_Articulo.txtCodigo.Value), 3) == "ARX" THEN
	&& Si es artículo X, siempre cargo el contenido de lo que el usuario haya ingresado
	REPLACE cur_Deta_View.prVta WITH Thisform.contenido.txtPrMinorista.Value ADDITIVE
	REPLACE cur_Deta_View.prArtic WITH Thisform.prarti_x ADDITIVE
ELSE
	IF clientes.mayorista THEN
		REPLACE cur_Deta_View.prVta WITH Thisform.contenido.txtPrMay.Value ADDITIVE
		
		IF lnproferta = 0 THEN
			REPLACE cur_Deta_View.prArtic WITH thisform.pr_mayorista ADDITIVE
		ELSE
			REPLACE cur_Deta_View.prArtic WITH thisform.pr_oferta ADDITIVE
		ENDIF
	ELSE
		REPLACE cur_Deta_View.prVta WITH Thisform.contenido.txtPrMinorista.Value ADDITIVE
		REPLACE cur_Deta_View.prArtic WITH Thisform.pr_minorista ADDITIVE
	ENDIF
	
	* Levanto el stock actual solo en caso que no sea ARX
	REPLACE cur_Deta_View.stkDisp  WITH Thisform.mov_stock.get_exist_byart(Thisform.contenido.sel_Articulo.valcpoid, "") ADDITIVE
ENDIF

*******************************************************************************************************************************
* Calculo el descuento del cliente en el ítem para grabar
*******************************************************************************************************************************
lnIDtoCli1 = ROUND(lnPrecio * (lnPDtoCli1 / 100),2)
lnIDtoCli2 = ROUND((lnPrecio - lnIDtoCli1) * (lnPDtoCli2 / 100),2)
lnIDtoCli3 = ROUND((lnPrecio - lnIDtoCli1 - lnIDtoCli2) * (lnPDtoCli3 / 100),2)
lnIDtoCli4 = ROUND((lnPrecio - lnIDtoCli1 - lnIDtoCli2 - lnIDtoCli3) * (lnPDtoCli4 / 100),2)

REPLACE cur_Deta_View.pDtoCli1 WITH lnPDtoCli1 ADDITIVE
REPLACE cur_Deta_View.pDtoCli2 WITH lnPDtoCli2 ADDITIVE
REPLACE cur_Deta_View.pDtoCli3 WITH lnPDtoCli3 ADDITIVE
REPLACE cur_Deta_View.pDtoCli4 WITH lnPDtoCli4 ADDITIVE
REPLACE cur_Deta_View.iDtoCli1 WITH lnIDtoCli1 ADDITIVE
REPLACE cur_Deta_View.iDtoCli2 WITH lnIDtoCli2 ADDITIVE
REPLACE cur_Deta_View.iDtoCli3 WITH lnIDtoCli3 ADDITIVE
REPLACE cur_Deta_View.iDtoCli4 WITH lnIDtoCli4 ADDITIVE
REPLACE cur_Deta_View.esOferta WITH llEsOferta ADDITIVE

*******************************************************************************************************************************
&& Calculo los descuentos por item
*******************************************************************************************************************************
REPLACE cur_Deta_View.pDtoVta1 WITH Thisform.contenido.txtPorDesc1.Value
REPLACE cur_Deta_View.pDtoVta2 WITH Thisform.contenido.txtPorDesc2.Value
REPLACE cur_Deta_View.pDtoVta3 WITH Thisform.contenido.txtPorDesc3.Value
REPLACE cur_Deta_View.pDtoVta4 WITH Thisform.contenido.txtPorDesc4.Value
REPLACE cur_Deta_View.iDtoVta1 WITH Thisform.contenido.txtImpDescItem1.Value
REPLACE cur_Deta_View.iDtoVta2 WITH Thisform.contenido.txtImpDescItem2.Value 
REPLACE cur_Deta_View.iDtoVta3 WITH Thisform.contenido.txtImpDescItem3.Value
REPLACE cur_Deta_View.iDtoVta4 WITH Thisform.contenido.txtImpDescItem4.Value

*******************************************************************************************************************************
* Agrego el recargo del cliente en el item
*******************************************************************************************************************************
REPLACE cur_Deta_View.pRecVta WITH Thisform.contenido.txtporrec.Value ADDITIVE
REPLACE cur_Deta_View.iRecVta WITH ROUND((lnPrecio - lnIDtoCli1 - lnIDtoCli2 - lnIDtoCli3 - lnIDtoCli4) * (Thisform.contenido.txtporrec.Value/ 100), 2) ADDITIVE

*******************************************************************************************************************************
&& Incluyo el recargo por ítem.
*******************************************************************************************************************************
REPLACE cur_Deta_View.pRecItem WITH Thisform.contenido.txtPorRecItem.Value ADDITIVE
REPLACE cur_Deta_View.iRecItem WITH Thisform.contenido.txtRecItem.Value ADDITIVE

REPLACE cur_Deta_View.impNeto WITH Thisform.contenido.txtPrNeto.Value ADDITIVE

*******************************************************************************************************************************
* Hago el cálculo del IVA
*******************************************************************************************************************************
IF (ALLTRIM(Thisform.cbte) == "PTO") THEN
	REPLACE cur_Deta_View.impIVA WITH 0 ADDITIVE
	REPLACE cur_Deta_View.alicIVA WITH 0 ADDITIVE
ELSE
	REPLACE cur_Deta_View.alicIVA WITH Thisform.contenido.txtAlicIVA.Value ADDITIVE
	REPLACE cur_Deta_View.impIVA WITH Thisform.contenido.txtImpIVA.Value ADDITIVE 
ENDIF

REPLACE cur_Deta_View.totNeto WITH Thisform.contenido.txtSTNeto.Value ADDITIVE
REPLACE cur_Deta_View.subTotal WITH Thisform.contenido.txtSubTotal.Value ADDITIVE


REPLACE cur_Deta_View.uniDesp WITH VAL(Thisform.contenido.cboUnidVta.Value) ADDITIVE
REPLACE cur_Deta_View.cantPack WITH Thisform.contenido.txtCantPack.Value ADDITIVE
REPLACE cur_Deta_View.uniMed WITH Thisform.unimed ADDITIVE

SELECT cur_Deta_View

RETURN .T.


ENDPROC
PROCEDURE get_precio_oferta
LOCAL lnPrecio, loResult, lcSql, loDT

loDT = CREATEOBJECT("datetime")
loResult = CREATEOBJECT("odbc_result")
lcSql = ""
lnPrecio = 0.00

lcSql = "SELECT * FROM ofertas "
lcSql = lcSql + "WHERE idArticulo = " + ALLTRIM(STR(thisform.contenido.sel_articulo.valcpoid)) + " "
lcSql = lcSql + "AND fecVigDD <= " + loDT.toMySql(DATE()) + " "
lcSql = lcSql + "AND fecVigHH >= " + loDT.toMySql(DATE())

loResult.ActiveConnection = goConn.ActiveConnection
loResult.Cursor_Name = "cur_tmpofta"

IF !loResult.OpenQuery(lcSql) THEN
	MESSAGEBOX(loResult.Error_Message, 0+48, Thisform.Caption)
	RETURN -1
ENDIF

SELECT cur_tmpofta
IF RECCOUNT("cur_tmpofta") > 0 THEN
	lnPrecio = cur_tmpofta.impOfert
ENDIF

loResult.Close_Query()

RETURN lnPrecio
ENDPROC
PROCEDURE validar_stk_en_grabado
LOCAL lnExistencia, loForm

lnExistencia = 0.00
loForm = CREATEOBJECT("cl_stk_insufi")

&& Limpio el cursor para refrescar la validación.
SELECT cur_StkInsu
ZAP

SELECT cur_Detalle
IF RECCOUNT("cur_Detalle") > 0 THEn
	GO TOP
ENDIF

DO WHILE !EOF("cur_Detalle")
	IF RIGHT(ALLTRIM(cur_Detalle.codArt), 3) != "ARX" THEN
		lnExistencia = thisform.mov_stock.get_exist_byart(cur_Detalle.idArticulo, '')
		
		IF cur_Detalle.cantidad > lnExistencia THEN
			SELECT cur_StkInsu
			APPEND BLANK
			REPLACE idArticulo WITH cur_Detalle.idArticulo
			REPLACE codArt WITH cur_Detalle.codArt ADDITIVE
			REPLACE descripcio WITH cur_Detalle.descripcio ADDITIVE
			REPLACE stock_disp WITH lnExistencia ADDITIVE
			REPLACE cantFC WITH cur_Detalle.cantidad ADDITIVE
		ENDIF
	ENDIF
	
	SELECT cur_Detalle
	SKIP
ENDDO

SELECT cur_StkInsu
IF RECCOUNT("cur_StkInsu") > 0 THEN
	GO TOP
ENDIF

SELECT cur_Detalle
IF RECCOUNT("cur_Detalle") > 0 THEN
	GO TOP 
ENDIF

IF RECCOUNT("cur_StkInsu") > 0 THEN
	loForm.llenar_datos()
	loForm.show()
	RETURN .F.
ENDIF

RETURN .T.


ENDPROC
PROCEDURE recalcular_renglones
LOCAL lnId

SELECT cur_deta_view
IF RECCOUNT("cur_deta_view") > 0 THEN
	GO TOP
ENDIF

lnId = 1
DO WHILE !EOF("cur_deta_view")
	SELECT cur_deta_view
	LOCK()
	REPLACE cur_deta_view.idDetalle WITH lnId
	UNLOCK
	
	lnId = lnId + 1
	SELECT cur_deta_view
	SKIP
ENDDO

SELECT cur_deta_view
IF RECCOUNT("cur_deta_view") > 0 THEN
	GO TOP
ENDIF

SELECT cur_deta_view
thisform.contenido.grdDetalles.Refresh()
ENDPROC
PROCEDURE num_bloqueado
LOCAL loRes, lcSql
LOCAL lnPtoVta, lcTipoDoc, lcCbte, loConDMO

loConDMO = CREATEOBJECT("odbc_connect")
loRes = CREATEOBJECT("odbc_result")
lcSql = ""
lnPtoVta = INT(VAL(ALLTRIM(getconfig("PTOVTA"))))
lcTipoDoc = thisform.tipodoc
lcCbte = thisform.cbte


IF ALLTRIM(lcCbte) == "PTO" THEN
	&& Si es un comprobante PTO, entonces, abro la base DMO para generar el registro.
	loConDMO.ConnectionString = ALLTRIM(getConfig("DMO_CC"))
	IF !loConDMO.open() THEN
		MESSAGEBOX(loConDMO.ErrorMessage, 0+48, Thisform.Caption)
		RETURN .F.
	ENDIF
ENDIF

lcSql = "SELECT bloqueado FROM numerador WHERE ptoVta = " + ALLTRIM(STR(lnPtoVta)) + " AND " + ;
	"tipoDoc = '" + ALLTRIM(thisform.tipodoc) + "' AND cbte = '" + ALLTRIM(thisform.cbte) + "'"
	
loRes.ActiveConnection = IIF(ALLTRIM(lcCbte) == "PTO", loConDMO.ActiveConnection,  goConn.ActiveConnection)
loRes.Cursor_Name = "_BLOQ"

IF !loRes.OpenQuery(lcSql) THEN
	MESSAGEBOX(loRes.Error_Message, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

SELECT _BLOQ
IF !_BLOQ.bloqueado THEN
	loRes.Close_Query()
	RETURN .F.
ENDIF

loRes.Close_Query()

RETURN .T.


ENDPROC
PROCEDURE bloquear_numerador
LOCAL lcSql, lnPtoVta, lcTipoDoc, lcCbte
LOCAL loCommand, loConDMO

loConDMO = CREATEOBJECT("odbc_connect")
loCommand = CREATEOBJECT("odbc_command")
lcSql = ""
lnPtoVta = INT(VAL(ALLTRIM(getconfig("PTOVTA"))))
lcTipoDoc = thisform.tipodoc
lcCbte = thisform.cbte

IF ALLTRIM(lcCbte) == "PTO" THEN
	&& Si es un comprobante PTO, entonces, abro la base DMO para generar el registro.
	loConDMO.ConnectionString = ALLTRIM(getConfig("DMO_CC"))
	IF !loConDMO.open() THEN
		MESSAGEBOX(loConDMO.ErrorMessage, 0+48, Thisform.Caption)
		RETURN .F.
	ENDIF
ENDIF

lcSql = "UPDATE numerador SET bloqueado = 1 WHERE ptoVta = " + ALLTRIM(STR(lnPtoVta)) + " AND " + ;
	"tipoDoc = '" + ALLTRIM(thisform.tipodoc) + "' AND cbte = '" + ALLTRIM(thisform.cbte) + "'"
	
goConn.BeginTransaction()
loCommand.ActiveConnection = IIF(ALLTRIM(lcCbte) == "PTO", loConDMO.ActiveConnection,  goConn.ActiveConnection)
loCommand.CommandText = lcSql

IF !loCommand.execute() THEN
	MESSAGEBOX(loCommand.ErrorMessage, 0+48, Thisform.Caption)
	goConn.Rollback()
	RETURN .F.
ENDIF

goConn.Commit()
RETURN .T.
ENDPROC
PROCEDURE desbloq_numerador
LOCAL lcSql, lnPtoVta, lcTipoDoc, lcCbte
LOCAL loCommand, loConDMO

loConDMO = CREATEOBJECT("odbc_connect")
loCommand = CREATEOBJECT("odbc_command")
lcSql = ""
lnPtoVta = INT(VAL(ALLTRIM(getconfig("PTOVTA"))))
lcTipoDoc = thisform.tipodoc
lcCbte = thisform.cbte

IF ALLTRIM(lcCbte) == "PTO" THEN
	&& Si es un comprobante PTO, entonces, abro la base DMO para generar el registro.
	loConDMO.ConnectionString = ALLTRIM(getConfig("DMO_CC"))
	IF !loConDMO.open() THEN
		MESSAGEBOX(loConDMO.ErrorMessage, 0+48, Thisform.Caption)
		RETURN .F.
	ENDIF
ENDIF

lcSql = "UPDATE numerador SET bloqueado = 0 WHERE ptoVta = " + ALLTRIM(STR(lnPtoVta)) + " AND " + ;
	"tipoDoc = '" + ALLTRIM(thisform.tipodoc) + "' AND cbte = '" + ALLTRIM(thisform.cbte) + "'"
	
goConn.BeginTransaction()
loCommand.ActiveConnection = IIF(ALLTRIM(lcCbte) == "PTO", loConDMO.ActiveConnection,  goConn.ActiveConnection)
loCommand.CommandText = lcSql

IF !loCommand.execute() THEN
	MESSAGEBOX(loCommand.ErrorMessage, 0+48, Thisform.Caption)
	goConn.Rollback()
	RETURN .F.
ENDIF

goConn.Commit()
RETURN .T.
ENDPROC
PROCEDURE mostrar_morosidad
LOCAL loRes, lcSql, loForm

loRes = CREATEOBJECT("odbc_result")
lcSql = ""

CREATE CURSOR cur_cbtemoro (	;
	idVentasC		int,;
	cbte			varchar(3),;
	tipoDoc			varchar(1),;
	ptoVta			varchar(4),;
	numCbte			varchar(8),;
	fecEmis			D,;
	fecVto			D,;
	saldo 			float(10, 2))

lcSql = "SELECT		ventascab.idVentasC, "
lcSql = lcSql + "	ventascab.cbte, "
lcSql = lcSql + "	ventascab.tipoDoc, "
lcSql = lcSql + "	ventascab.ptoVta, "
lcSql = lcSql + "	ventascab.numCbte, "
lcSql = lcSql + "	ventascab.fecEmision, "
lcSql = lcSql + "	ventascab.fecVto,  "
lcSql = lcSql + "	ventascab.saldo "
lcSql = lcSql + "FROM	ventascab "
lcSql = lcSql + "WHERE	" + IIF(INT(VAL(getConfig("SQLSRV"))) = 1, "GETDATE()", "current_date") + " > ventascab.fecVto "
lcSql = lcSql + "	AND ventascab.idCliente = " + ALLTRIM(STR(thisform.contenido.sel_Cliente.valcpoid))
lcSql = lcSql + "	AND ventascab.cbte = 'FC' "
lcSql = lcSql + "	AND ventascab.fecBaja IS NULL "
lcSql = lcSql + "	AND ventascab.idVentasC IN ( "
lcSql = lcSql + "		SELECT	MAX(idVentasC) "
lcSql = lcSql + "		FROM	cc_cli  "
lcSql = lcSql + "		WHERE	idCliente = " + ALLTRIM(STR(thisform.contenido.sel_cliente.valcpoid)) + " "
lcSql = lcSql + "		GROUP BY idOper "
lcSql = lcSql + "		HAVING (SUM(impDebe) - SUM(impHaber)) <> 0) "

loRes.ActiveConnection = goConn.ActiveConnection
loRes.Cursor_Name = "cur_moro"

IF !loRes.OpenQuery(lcSql) THEN
	MESSAGEBOX(loRes.Error_Message, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

SELECT cur_cbtemoro
ZAP

SELECT cur_moro
IF RECCOUNT("cur_moro") > 0 THEN
	GO TOP
ENDIF

DO WHILE !EOF("cur_moro")
	SELECT cur_cbtemoro
	APPEND BLANK
	REPLACE cur_cbtemoro.idVentasC 	WITH cur_moro.idVentasC
	REPLACE cur_cbtemoro.cbte 		WITH cur_moro.cbte ADDITIVE
	REPLACE cur_cbtemoro.tipoDoc 	WITH cur_moro.tipoDoc ADDITIVE
	REPLACE cur_cbtemoro.ptoVta 	WITH REPLICATE("0", 4 - LEN(ALLTRIM(STR(cur_moro.ptoVta)))) + ALLTRIM(STR(cur_moro.ptoVta)) ADDITIVE
	REPLACE cur_cbtemoro.numCbte 	WITH REPLICATE("0", 8 - LEN(ALLTRIM(STR(cur_moro.numCbte)))) + ALLTRIM(STR(cur_moro.numCbte)) ADDITIVE
	REPLACE cur_cbtemoro.fecEmis 	WITH cur_moro.fecEmision ADDITIVE
	REPLACE cur_cbtemoro.fecVto 	WITH cur_moro.fecVto ADDITIVE
	REPLACE cur_cbtemoro.saldo 		WITH cur_moro.saldo ADDITIVE
	
	thisform.saldodeudor = thisform.saldodeudor + cur_moro.saldo

	SELECT cur_moro
	SKIP
ENDDO

SELECT cur_cbtemoro
IF RECCOUNT("cur_cbtemoro") > 0 THEN
	GO TOP
	
	loForm = CREATEOBJECT("cls_cbte_moro")
	loForm.generar_registros()
	loForm.show()
ELSE
	RETURN .F.
ENDIF

USE IN cur_cbtemoro 

RETURN .T.
ENDPROC
PROCEDURE calcular_saldo_dedudor
LOCAL loRes, lcSql

loRes = CREATEOBJECT("odbc_result")
lcSql = ""

lcSql = "SELECT		ventascab.idVentasC, "
lcSql = lcSql + "	ventascab.cbte, "
lcSql = lcSql + "	ventascab.tipoDoc, "
lcSql = lcSql + "	ventascab.ptoVta, "
lcSql = lcSql + "	ventascab.numCbte, "
lcSql = lcSql + "	ventascab.fecEmision, "
lcSql = lcSql + "	ventascab.fecVto,  "
lcSql = lcSql + "	ventascab.saldo "
lcSql = lcSql + "FROM	ventascab "
lcSql = lcSql + "WHERE ventascab.idCliente = " + ALLTRIM(STR(thisform.contenido.sel_cliente.valcpoid))
lcSql = lcSql + "	AND ventascab.idVentasC IN ( "
lcSql = lcSql + "			SELECT	MAX(idVentasC) "
lcSql = lcSql + "			FROM	cc_cli  "
lcSql = lcSql + "			WHERE	idCliente = " + ALLTRIM(STR(thisform.contenido.sel_cliente.valcpoid)) + " "
lcSql = lcSql + "			GROUP BY idOper "
lcSql = lcSql + "			HAVING (SUM(impDebe) - SUM(impHaber)) <> 0) "

loRes.ActiveConnection = goConn.ActiveConnection
loRes.Cursor_Name = "cur_moro"

IF !loRes.OpenQuery(lcSql) THEN
	MESSAGEBOX(loRes.Error_Message, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF


thisform.saldodeudor = 0.00

SELECT cur_moro
IF RECCOUNT("cur_moro") > 0 THEN
	GO TOP
ENDIF

DO WHILE !EOF("cur_moro")
	
	thisform.saldodeudor = thisform.saldodeudor + cur_moro.saldo

	SELECT cur_moro
	SKIP
ENDDO

loRes.Close_Query()

RETURN .T.
ENDPROC
PROCEDURE leer_unid_desp
PARAMETERS tcCodigos, tcCampoCodigo

LOCAL loResult, lcSql
LOCAL lcCodArt

loResult = CREATEOBJECT("odbc_result")
lcSql = ""
lcCodArt = ""

lcSql = "select * from codiart "
lcSql = lcSql + "where " + tcCampoCodigo + " = '" + ALLTRIM(tcCodigos) + "' "
lcSql = lcSql + "	and (circuito = 'V' OR circuito = 'CV') "
lcSql = lcSql + "order by cantiDesp asc "

loResult.ActiveConnection = goConn.ActiveConnection
loResult.Cursor_Name = "cur_uv"

IF !loResult.OpenQuery(lcSql) THEN
	MESSAGEBOX(loResult.Error_Message, 0+48, Thisform.Caption)
	lcCodArt = "ERROR"
	RETURN lcCodArt
ENDIF

thisform.contenido.cboUnidVta.Clear()
SELECT cur_uv
IF RECCOUNT("cur_uv") > 0 THEN
	GO TOP
ELSE
	loResult.close_query()
	lcCodArt = "X"			&& Pongo un código cualquiera para que abra el buscador
	RETURN lcCodArt
ENDIF

DO WHILE !EOF("cur_uv")

	thisform.contenido.cboUnidVta.AddItem(ALLTRIM(STR(cur_uv.cantiDesp, 10, 2)))
	lcCodArt = cur_uv.codArt

	SELECT cur_uv
	SKIP
ENDDO

IF RECCOUNT("cur_uv") = 1 THEN
	thisform.contenido.cboUnidVta.Enabled = .F.
ELSE
	thisform.contenido.cboUnidVta.Enabled = .T.
ENDIF

loResult.close_query()
thisform.contenido.cboUnidVta.ListIndex = 1

RETURN lcCodArt


ENDPROC
PROCEDURE grabar_faltantes
SELECT cur_faltantes
IF RECCOUNT("cur_faltantes") > 0 THEN
	GO TOP
ENDIF

DO WHILE !EOF("cur_faltantes")
	Thisform.faltantes.grabar(0, cur_faltantes.idArticulo, cur_faltantes.codArt, ;
		cur_faltantes.uniDesp, cur_faltantes.cantidad, cur_faltantes.idCliente)

	SELECT cur_faltantes
	SKIP
ENDDO

MESSAGEBOX("Los faltantes fueron grabado con éxito", 0+64, Thisform.Caption)
ENDPROC
PROCEDURE marcar_ped_proc
LOCAL loCommand, lcSql

lcSql = ""
loCommand = CREATEOBJECT("odbc_command")

goConn.BeginTransaction()

SELECT cur_Cbtes
IF RECCOUNT("cur_Cbtes") > 0 THEN
	GO TOP
ENDIF

DO WHILE !EOF("cur_Cbtes")
	IF cur_Cbtes.sel THEN
		lcSql = "update ventascab set procesado = 1 "
		lcSql = lcSql + "where idVentasC = " + ALLTRIM(STR(cur_Cbtes.idVentasC))

		loCommand.ActiveConnection = goConn.ActiveConnection
		loCommand.CommandText = lcSql

		IF !loCommand.Execute() THEN
			goConn.Rollback()
			MESSAGEBOX(loCommand.ErrorMessage, 0+48, Thisform.Caption)
		ENDIF
	ENDIF

	SELECT cur_Cbtes
	SKIP
ENDDO

goConn.Commit()
ENDPROC
PROCEDURE getoferta_byart
PARAMETERS tnIdArticulo

LOCAL lnPrecio, loResult, lcSql, loDT

loDT = CREATEOBJECT("datetime")
loResult = CREATEOBJECT("odbc_result")
lcSql = ""
lnPrecio = 0.00

lcSql = "SELECT * FROM ofertas "
lcSql = lcSql + "WHERE idArticulo = " + ALLTRIM(STR(tnIdArticulo)) + " "
lcSql = lcSql + "AND fecVigDD <= " + loDT.toMySql(DATE()) + " "
lcSql = lcSql + "AND fecVigHH >= " + loDT.toMySql(DATE())

loResult.ActiveConnection = goConn.ActiveConnection
loResult.Cursor_Name = "cur_tmpofta"

IF !loResult.OpenQuery(lcSql) THEN
	MESSAGEBOX(loResult.Error_Message, 0+48, Thisform.Caption)
	RETURN -1
ENDIF

SELECT cur_tmpofta
IF RECCOUNT("cur_tmpofta") > 0 THEN
	lnPrecio = cur_tmpofta.impOfert
ENDIF

loResult.Close_Query()

RETURN lnPrecio
ENDPROC
PROCEDURE validar_pto
LOCAL loConDMO
LOCAL loResult
LOCAL lcSql
LOCAL lnCantReg 

loConDMO = CREATEOBJECT("odbc_connect")
loResult = CREATEOBJECT("odbc_result")
lcSql = ""
lnCantReg = 0

loConDMO.ConnectionString = ALLTRIM(getConfig("DMO_CC"))
IF !loConDMO.Open()
	MESSAGEBOX(loConDMO.ErrorMessage, 1+16, "Database Connection")
	RETURN .F.
ENDIF

lcSql = "SELECT COUNT(*) AS cantidad FROM clientes WHERE idCliente = " + ALLTRIM(STR(Thisform.contenido.sel_Cliente.valcpoid))
loResult.ActiveConnection = loConDMO.ActiveConnection
loResult.Cursor_Name = "cur_x"
 
IF !loResult.OpenQuery(lcSql) THEN
	MESSAGEBOX(loResult.Error_Message, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

IF TYPE("cur_x.cantidad") != "C" THEN
	SELECT cur_x
	lnCantReg = cur_x.cantidad
ELSE
	SELECT cur_x
	lnCantReg = INT(VAL(cur_x.cantidad))
ENDIF

loResult.Close_Query()

IF lnCantReg = 0 THEN
	MESSAGEBOX("Faltan datos, actualice la versión DMO", 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

SELECT cur_Deta_View
GO TOP
DO WHILE !EOF("cur_Deta_View")
	lcSql = "SELECT COUNT(*) AS cantidad FROM articulos WHERE idArticulo = " + STR(cur_Deta_View.idArticulo)
	loResult.ActiveConnection = loConDMO.ActiveConnection
	loResult.Cursor_Name = "cur_x"
	
	IF !loResult.OpenQuery(lcSql) THEN
		MESSAGEBOX(loResult.Error_Message, 0+48, Thisform.Caption)
		SELECT cur_Deta_View
		GO TOP
		RETURN .F.
	ENDIF
	
	SELECT cur_x
	IF TYPE("cur_x.cantidad") != "C" THEN
		lnCantReg = cur_x.cantidad
	ELSE
		lnCantReg = INT(VAL(cur_x.cantidad))
	ENDIF
	
	loResult.Close_Query()
	
	IF lnCantReg = 0 THEN
		MESSAGEBOX("Faltan datos, actualice la versión DMO", 0+48, Thisform.Caption)
		SELECT cur_Deta_View
		GO TOP
		RETURN .F.
	ENDIF

	SELECT cur_Deta_View
	SKIP
ENDDO

SELECT cur_Deta_View
GO TOP

Thisform.Contenido.grdDetalles.Refresh()
loConDMO.Close()

RETURN .T.

ENDPROC
PROCEDURE get_precio_oferta_2
PARAMETERS tnIdArticulo

LOCAL lnPrecio, loResult, lcSql, loDT

loDT = CREATEOBJECT("datetime")
loResult = CREATEOBJECT("odbc_result")
lcSql = ""
lnPrecio = 0.00

*!*	lcSql = "SELECT * FROM ofertas "
*!*	lcSql = lcSql + "WHERE idArticulo = " + ALLTRIM(STR(tnIdArticulo)) + " "
*!*	lcSql = lcSql + "AND fecVigDD <= " + loDT.toMySql(DATE()) + " "
*!*	lcSql = lcSql + "AND fecVigHH >= " + loDT.toMySql(DATE())

lcSql = "CALL ofertas_getVigenteByArt (" + ALLTRIM(STR(tnIdArticulo)) + ")"
loResult.ActiveConnection = goConn.ActiveConnection
loResult.Cursor_Name = "cur_tmpofta"

IF !loResult.OpenQuery(lcSql) THEN
	MESSAGEBOX(loResult.Error_Message, 0+48, Thisform.Caption)
	RETURN -1
ENDIF

SELECT cur_tmpofta
IF RECCOUNT("cur_tmpofta") > 0 THEN
	lnPrecio = cur_tmpofta.impOfert
ENDIF

loResult.Close_Query()

RETURN lnPrecio
ENDPROC
PROCEDURE grabar_ctacte
PARAMETERS tnIdVentasC
 
LOCAL loCommand
LOCAL loRes
LOCAL oDT
LOCAL lcSql
LOCAL lnIdCliente, lcCbte, lnNroCbte, lcTipoDoc, lnPtoVta, lnIdCondPago
LOCAL lnIdSitIVA, lnIdVendedor, ldFecVto, lnTotFact, lnIdOper
 
loCommand = CREATEOBJECT("odbc_command")
loRes = CREATEOBJECT("odbc_result")
oDT = CREATEOBJECT("datetime")
lcSql = ""
lnIdCliente = 0
lcCbte = ""
lnNroCbte = 0
lcTipoDoc = ""
lnPtoVta = 0
lnIdCondPago = 0
lnIdSitIVA = 0
lnIdVendedor = 0
ldFecVto = {}
lnTotFact = 0.00
lnIdOper = 0
 
lcSql = "SELECT * FROM ventascab WHERE idVentasC = " + ALLTRIM(STR(tnIdVentasC))
loRes.ActiveConnection = goConn.ActiveConnection
loRes.Cursor_Name = "cur_vtas"
 
IF !loRes.OpenQuery(lcSql) THEN
      MESSAGEBOX(loRes.Error_Message, 0+48, Thisform.Caption)
      RETURN .F.
ENDIF
 
SELECT cur_vtas
IF RECCOUNT("cur_vtas") > 0 THEN
      lnIdCliente = cur_vtas.idCliente
      lcCbte = cur_vtas.cbte
      lnNroCbte = cur_vtas.numCbte
      lcTipoDoc = cur_vtas.tipoDoc
      lnPtoVta = cur_vtas.ptoVta
      lnIdCondPago = cur_vtas.idCondPago
      lnIdSitIVA = cur_vtas.idSitIVA
      lnIdVendedor = cur_vtas.idVendedor
      ldFecVto = cur_vtas.fecVto
      lnTotFact = cur_vtas.totFact
ENDIF
 
loRes.Close_Query()
 
lnProxID = goConn.GetNextId("cc_cli", "idCC_Cli")
lnIdOper = goConn.GetNextID("cc_cli", "idOper")
 
&& Inserto el registro correspondiente a la factura en la tabla de cuentas corrientes
lcSql = "INSERT INTO cc_cli (idCC_Cli, idCliente, idCC_Orig, cbte, nroCbte, tipoDoc, ptoVta, idCondPago, idSitIVA, idVendedor, "
lcSql = lcSql + "fecEmis, fecVto, impDebe, impHaber, idOper, idVentasC, usuAlta, fecAlta, idHostAlta) VALUES ( "
lcSql = lcSql + ALLTRIM(STR(lnProxID)) + ", " + ALLTRIM(STR(lnIdCliente)) + ", null, '" + ALLTRIM(lcCbte) + "', "
lcSql = lcSql + ALLTRIM(STR(lnNroCbte)) + ", '" + ALLTRIM(lcTipoDoc) + "', " + ALLTRIM(STR(lnPtoVta)) + ", " + ALLTRIM(STR(lnIdCondPago)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnIdSitIVA)) + ", " + ALLTRIM(STR(lnIdVendedor)) + ", " + oDT.getDateTime() + ", "
lcSql = lcsql + oDT.toMySql(ldFecVto) + ", " + ALLTRIM(STR(lnTotFact, 10, 2)) + ", 0, " + ALLTRIM(STR(lnIdOper)) + ", " + ALLTRIM(STR(tnIdVentasC)) + ", "
lcSql = lcSql + "'" + ALLTRIM(gcCodUsu) + "', " + oDT.getDateTime() + ", '" + ALLTRIM(SYS(0)) + "')"
 
goConn.BeginTransaction()
 
loCommand.ActiveConnection = goConn.ActiveConnection
loCommand.CommandText = lcSql
 
IF !loCommand.Execute()
      goConn.Rollback()
      RETURN .F.
ENDIF
 
goConn.Commit()
RETURN .T.
ENDPROC
PROCEDURE getprinterrto
LOCAL loRes
LOCAL loCommand
LOCAL lcSql
LOCAL lnPtoVta
LOCAL lnIdNum
LOCAL lnNro

loRes = CREATEOBJECT("odbc_result")
loCommand = CREATEOBJECT("odbc_command")
lcSql = ""
lnPtoVta = INT(VAL(getConfig("PTOVTA")))
lnIdNum = 0

lcSql = "SELECT * FROM numerador "
lcSql = lcSql + "WHERE cbte = 'RTO' "
lcSql = lcSql + "	AND ptoVta = " + ALLTRIM(STR(lnPtoVta))

loRes.ActiveConnection = goConn.ActiveConnection
loRes.Cursor_Name = "cur_num"

IF !loRes.OpenQuery(lcSql) THEN
	MESSAGEBOX(loRes.Error_Message, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

IF RECCOUNT("cur_num") > 0 THEN
	lnNro = cur_num.numActual + 1
	Thisform.rto_numero = REPLICATE("0", 4 - LEN(ALLTRIM(STR(lnPtoVta)))) + ALLTRIM(STR(lnPtoVta)) ;
			+ "-" + REPLICATE("0", 8 - LEN(ALLTRIM(STR(lnNro)))) + ALLTRIM(STR(lnNro))
	
	lnIdNum = cur_num.idNum
ELSE
	MESSAGEBOX("El numerador no se encuentra configurado", 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

loRes.Close_Query()

lcSql = "SELECT * FROM impresoras "
lcSql = lcSql + "WHERE hostName = '" + ALLTRIM(SYS(0)) + "' "
lcSql = lcSql + "	AND impresoras.idNum = " + ALLTRIM(STR(lnIdNum))

loRes.ActiveConnection = goConn.ActiveConnection
loRes.Cursor_Name = "cur_printer"

IF !loRes.OpenQuery(lcSql) THEN
	MESSAGEBOX(loRes.Error_Message, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

SELECT cur_printer
IF RECCOUNT("cur_printer") > 0 THEN
	Thisform.rto_printer = ALLTRIM(cur_printer.impresora)
	Thisform.rto_cantcpias = cur_printer.copias
ELSE
	MESSAGEBOX("El remito no tiene impresora configurada", 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

loRes.Close_Query()

&& Actualizo el numero de remito
goConn.BeginTransaction()
lcSql = "UPDATE numerador "
lcSql = lcSql + "SET numActual = " + ALLTRIM(STR(lnNro)) + " "
lcSql = lcSql + "WHERE idNum = " + ALLTRIM(STR(lnIdNum))

loCommand.ActiveConnection = goConn.ActiveConnection
loCommand.CommandText = lcSql

IF !loCommand.Execute() THEN
	goConn.Rollback()
	MESSAGEBOX(loCommand.Error_Message, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

goConn.Commit()

RETURN .T.
ENDPROC
PROCEDURE leer_faltantes
LOCAL lcSql, loResFalt, loResArt
LOCAL lnPDtoCli1, lnPDtoCli2, lnPDtoCli3, lnPDtoCli4
LOCAL lnIDtoCli1, lnIDtoCli2, lnIDtoCli3, lnIDtoCli4
LOCAL lnTotItem, i, lnPrecio, lnPrVta
LOCAL lnPorRec, lnImpRec, lnImpNeto

loResFalt = CREATEOBJECT("odbc_result")
loResArt = CREATEOBJECT("odbc_result")
lcSql = ""
lnPDtoCli1 = Thisform.contenido.txtDesc1.Value
lnPDtoCli2 = Thisform.contenido.txtDesc2.Value
lnPDtoCli3 = Thisform.contenido.txtDesc3.Value
lnPDtoCli4 = Thisform.contenido.txtDesc4.Value
lnIDtoCli1 = 0.00
lnIDtoCli2 = 0.00
lnIDtoCli3 = 0.00
lnIDtoCli4 = 0.00
lnPrecio = 0.00
lnPrVta = 0.00
lnPorRec = Thisform.contenido.txtporrec.Value 
lnImpRec = 0.00
lnImpNeto = 0.00

lcSql = "SELECT * FROM faltantes "
lcSql = lcSql + "WHERE idCliente = " + ALLTRIM(STR(Thisform.Contenido.sel_cliente.valcpoid)) + " "
lcSql = lcSql + " AND fecBaja IS NULL "

loResFalt.ActiveConnection = goConn.ActiveConnection
loResFalt.Cursor_Name = "cur_f"

IF !loResFalt.OpenQuery(lcSql) THEN
	MESSAGEBOX(loRes.ErrorMessage, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

SELECT cur_f
GO TOP

DO WHILE !EOF("cur_f")
	lcSql = "SELECT * FROM articulos "
	lcSql = lcSql + "WHERE idArticulo = " + ALLTRIM(STR(cur_f.idArticulo))
	loResArt.ActiveConnection = goConn.ActiveConnection
	loResArt.Cursor_Name = "cur_TmpArt"
	
	IF !loResArt.OpenQuery(lcSql) THEN
		MESSAGEBOX(loResArt.ErrorMessage, 0+48, THisform.Caption)
		RETURN .F.
	ENDIF
	
	SELECT cur_TmpArt
	IF RECCOUNT("cur_TmpArt") > 0 THEN
		&& Verifico cuando levanta el pedido que levante la oferta.
		lnPrecio = thisform.get_precio_oferta_2(cur_TmpArt.idArticulo)
		
		SELECT cur_Deta_View
		APPEND BLANK
		REPLACE cur_Deta_View.idArticulo 	WITH cur_TmpArt.idArticulo
		REPLACE cur_Deta_View.codArt 		WITH cur_f.codArt ADDITIVE
		REPLACE cur_Deta_View.descripcio 	WITH cur_TmpArt.descripcio ADDITIVE
		REPLACE cur_Deta_View.cantidad 		WITH cur_f.cantidad ADDITIVE
		REPLACE cur_Deta_View.alicIVA 		WITH cur_TmpArt.alicIVA ADDITIVE
			
		IF lnPrecio = 0 THEN
			IF clientes.mayorista
				lnPrecio = cur_TmpArt.prVentaMax			
			ELSE
				lnPrecio = cur_TmpArt.prVentaMin
			ENDIF
			
			REPLACE cur_Deta_View.esOferta WITH .F. ADDITIVE
		ELSE
			REPLACE cur_Deta_View.esOferta WITH .T. ADDITIVE
		ENDIF
		
		&& Calculo los descuentos del cliente
		lnIDtoCli1 = ROUND(lnPrecio * (lnPDtoCli1 / 100), 2)
		lnIDtoCli2 = ROUND((lnPrecio - lnIDtoCli1) * (lnPDtoCli2 / 100), 2)
		lnIDtoCli3 = ROUND((lnPrecio - lnIDtoCli1 - lnIDtoCli2) * (lnPDtoCli3 / 100), 2)
		lnIDtoCli4 = ROUND((lnPrecio - lnIDtoCli1 - lnIDtoCli2 - lnIDtoCli3) * (lnPDtoCli4 / 100), 2)
		lnPrVta = lnPrecio - lnIDtoCli1 - lnIDtoCli2 - lnIDtoCli3 - lnIDtoCli4

		REPLACE cur_Deta_View.pDtoCli1 	WITH lnPDtoCli1 ADDITIVE
		REPLACE cur_Deta_View.pDtoCli2 	WITH lnPDtoCli2 ADDITIVE
		REPLACE cur_Deta_View.pDtoCli3 	WITH lnPDtoCli3 ADDITIVE
		REPLACE cur_Deta_View.pDtoCli4 	WITH lnPDtoCli4 ADDITIVE
		REPLACE cur_Deta_View.iDtoCli1 	WITH lnIDtoCli1 ADDITIVE
		REPLACE cur_Deta_View.iDtoCli2 	WITH lnIDtoCli2 ADDITIVE
		REPLACE cur_Deta_View.iDtoCli3 	WITH lnIDtoCli3 ADDITIVE
		REPLACE cur_Deta_View.iDtoCli4 	WITH lnIDtoCli4 ADDITIVE
		
		REPLACE cur_Deta_View.pDtoVta1	WITH 0.00
		REPLACE cur_Deta_View.pDtoVta2 	WITH 0.00
		REPLACE cur_Deta_View.pDtoVta3	WITH 0.00
		REPLACE cur_Deta_View.pDtoVta4	WITH 0.00
		REPLACE cur_Deta_View.iDtoVta1	WITH 0.00
		REPLACE cur_Deta_View.iDtoVta2	WITH 0.00
		REPLACE cur_Deta_View.iDtoVta3	WITH 0.00
		REPLACE cur_Deta_View.iDtoVta4	WITH 0.00
		
		&& Calculo el recargo
		
		lnImpNeto = lnPrVta
		lnImpRec = ROUND(lnImpNeto * (lnPorRec / 100), 2)
		lnImpNeto = lnImpNeto + lnImpRec
		
		REPLACE cur_Deta_View.pRecVta WITH lnPorRec ADDITIVE
		REPLACE cur_Deta_View.iRecVta WITH lnImpRec ADDITIVE
		
		REPLACE cur_Deta_View.prArtic	WITH lnPrecio ADDITIVE
		REPLACE cur_Deta_View.prVta 	WITH lnPrVta ADDITIVE
		REPLACE cur_Deta_View.impNeto	WITH lnImpNeto ADDITIVE
		REPLACE cur_Deta_View.totNeto 	WITH ROUND(lnImpNeto * cur_f.Cantidad, 2) ADDITIVE
		REPLACE cur_Deta_View.impIVA 	WITH ROUND(cur_Deta_View.totneto * (cur_TmpArt.alicIVA / 100), 2) ADDITIVE
		REPLACE cur_Deta_View.subTotal 	WITH cur_Deta_View.totNeto + cur_Deta_View.impIVA ADDITIVE
		
		&& El siguiente código reemplazarlo para cuando se haya incorporado las unidades de medida
		&& en el sistema de cliente.
		REPLACE cur_Deta_View.uniDesp WITH 1 ADDITIVE
		REPLACE cur_Deta_View.cantPack WITH ROUND(cur_f.Cantidad, 2) ADDITIVE
		REPLACE cur_Deta_View.uniMed WITH 'UNI' ADDITIVE
		
		************************************************************************************************************************
		* Agrego los artículos en stock
		************************************************************************************************************************
*!*			IF !Thisform.mov_stock.agregar_articulo(cur_TmpArt.idArticulo, cur_PedExt.cantidad) THEN
*!*				MESSAGEBOX(Thisform.mov_stock.ErrorMessage, 0+48, Thisform.Caption)
*!*				RETURN .F.
*!*			ENDIF		
	ENDIF
	
	loResArt.Close_Query()
	
	&& Agrego el faltante para ser dado de baja
	SELECT cur_BajaFalt
	APPEND BLANK
	REPLACE cur_BajaFalt.idFaltante WITH cur_f.idFaltante

	SELECT cur_f
	SKIP
ENDDO

loResFalt.Close_Query()

SELECT cur_Deta_View
IF RECCOUNT("cur_Deta_View") > 0
	GO TOP
ENDIF

Thisform.Contenido.grdDetalles.Refresh()
Thisform.sumar_items()
Thisform.calcular_ret_iibb()
RETURN .T.

ENDPROC
PROCEDURE baja_faltantes
LOCAL lcSql, loCommand

lcSql = ""
loCommand = CREATEOBJECT("odbc_command")

SELECT cur_BajaFalt
GO TOP
DO WHILE !EOF("cur_BajaFalt")
	lcSql = "UPDATE faltantes "
	lcSql = lcSql + "SET usuBaja = '" + ALLTRIM(gcCodUsu) + "', "
	lcSql = lcSql + "	fecBaja = current_timestamp, "
	lcSql = lcSql + "	idHostBaja = '" + ALLTRIM(SYS(0)) + "' "
	lcSql = lcSql + "WHERE idFaltante = " + ALLTRIM(STR(cur_BajaFalt.idFaltante))
	
	loCommand.ActiveConnection = goConn.ActiveConnection
	loCommand.CommandText = lcSql
	
	IF !loCommand.Execute() THEN
		MESSAGEBOX(loCommand.ErrorMessage, 0+48, Thisform.Caption)
		RETURN .F.
	ENDIF
	
	SELECT cur_BajaFalt
	SKIP
ENDDO

RETURN .T.
ENDPROC
PROCEDURE verificar_cbte



ENDPROC
PROCEDURE robot_facturar
** Este procedimiento es un algoritmo inteligente
** para automatizar el testing del ingreso de comprobantes
** y facilitar el circuito.

LOCAL lnCantCbte
LOCAL lnCantItems
LOCAL loForm
LOCAL lcSql
LOCAL loRes
LOCAL lnPosCli
LOCAL lnPosArtic
LOCAL lnTotCli
LOCAL lnTotArtic
LOCAL lnCantidad
LOCAL lnPorRec
LOCAL lnPorDesc1
LOCAL lnPorDesc2
LOCAL lnPorDesc3
LOCAL lnPorDesc4
LOCAL i
LOCAL j

lnCantCbte = 0
lnCantItems = 0
lnCantidad = 0.00
loForm = CREATEOBJECT("_cls_debug_ingcbtes")
loForm.show()

IF !loForm.press_aceptar THEN
	loForm.Release()
	RETURN
ENDIF

lnCantCbte = loForm.cant_cbtes
lnCantItems = loForm.cant_items
lnPorRec = loForm.por_rec
lnPorDesc1 = loForm.pordesc1
lnPorDesc2 = loForm.pordesc2
lnPorDesc3 = loForm.pordesc3
lnPorDesc4 = loForm.pordesc4

loForm.release()

lnTotCli = RECCOUNT("clientes")
lnTotArtic = RECCOUNT("articulos")

FOR i = 1 TO lnCantCbte
	lnPosCli = ROUND(1 + RAND() * (lnTotCli - 1), 0)
	
	IF lnPosCli < lnTotCli THEN
		SELECT clientes
		GO lnPosCli
		
		Thisform.contenido.sel_cliente.txtCodigo.Value = clientes.idCliente
		Thisform.contenido.sel_cliente.txtCodigo.LostFocus()
		
		Thisform.contenido.txtPorRec.Value = lnPorRec
		Thisform.contenido.txtPorRec.Valid()
		
		Thisform.contenido.txtPorDesc1.Value = lnPorDesc1
		Thisform.contenido.txtPorDesc1.LostFocus()
		
		Thisform.contenido.txtPorDesc2.Value = lnPorDesc2
		Thisform.contenido.txtPorDesc2.LostFocus()
		
		Thisform.contenido.txtPorDesc3.Value = lnPorDesc3
		Thisform.contenido.txtPorDesc3.LostFocus()
		
		Thisform.contenido.txtPorDesc4.Value = lnPorDesc4
		Thisform.contenido.txtPorDesc4.LostFocus()
		
		Thisform.contenido.sel_Articulo.txtCodigo.SetFocus()
				
		FOR j = 1 TO lnCantItems
			lnPosArtic = ROUND(1 + RAND() * lnTotArtic, 0)
		
			IF lnPosArtic < lnTotArtic THEN				
				SELECT articulos
				GO lnPosArtic
				
				Thisform.contenido.sel_Articulo.txtCodigo.Value = articulos.codart
				Thisform.contenido.txtCantidad.SetFocus()
								
				lnCantidad = ROUND(1 + RAND() * 20, 0)
				
				Thisform.contenido.txtCantidad.Value = lnCantidad
				Thisform.contenido.btnAgregar.SetFocus()
				Thisform.contenido.btnAgregar.Click()
			ENDIF		
		NEXT j
		
		Thisform.contenido.btnGrabar.Click()
	ENDIF
NEXT i
ENDPROC
PROCEDURE marcar_procesado
LOCAL loCmd
LOCAL lcSql

loCmd = CREATEOBJECT("odbc_command")
lcSql = ""

SELECT cur_PedExt
GO TOP
DO WHILE !EOF("cur_PedExt")
	lcSql = "UPDATE pedext "
	lcSql = lcSql + "SET pedext.procesado = 1 "
	lcSql = lcSql + "WHERE pedext.idPedExt = " + ALLTRIM(STR(cur_PedExt.idPedExt))
	
	loCmd.CommandText = lcSql
	loCmd.ActiveConnection = goConn.ActiveConnection
	
	IF !loCmd.Execute() THEN
		MESSAGEBOX(loCmd.ErrorMessage, 0+48, Thisform.Caption)
		RETURN .F.
	ENDIF

	SELECT cur_PedExt
	SKIP
ENDDO

SELECT cur_PedExt
GO TOP

RETURN .T.
ENDPROC
PROCEDURE eliminar_ped_from_pedext
LOCAL loRes
LOCAL lcSql
LOCAL lcResult

loRes = CREATEOBJECT("odbc_result")
lcSql = "CALL pedext_eliminarPed (?idPedCab)"
lcSql = loRes.AddParameter(lcSql, "idPedCab", ALLTRIM(STR(thisform.idpedcab)), .f., .f.)
loRes.ActiveConnection = goConn.ActiveConnection
loRes.Cursor_Name = "cur_res"
loRes.OpenQuery(lcSql)
SELECT cur_res
lcResult = cur_res.result
loRes.Close_Query()

IF !(ALLTRIM(lcResult) == "OK") THEN
	MESSAGEBOX(lcResult, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

RETURN .T.

ENDPROC
PROCEDURE grabar
&& Grabo la info en la base

LOCAL lnIdVentasC, lnIdCliente, lcFecEmis, lcCbte, lcTipoDoc, lnPtoVta
LOCAL lnNroCbte, llAnulado, lnImpNeto, lnImpFinal, lnPorIVA21, lnImpIVA21
LOCAL lnPorIVA105, lnImpIVA105, lnPorDesc1, lnPorDesc2, lnPorDesc3, lnPorDesc4
LOCAL lnImpDesc1, lnImpDesc2, lnImpDesc3, lnImpDesc4, lnTotFact
LOCAL lnIdVentasD, lnIdArticulo, lnCantidad, lnCostoRep, lnPrVenta, lnAlicIVA, lnImpIVA
LOCAL lnTotNeto, lnSubTotal, lnSaldo, lcObserv, lnPorIIBB, lnImpIIBB
LOCAL lnPDtoVta1, lnPDtoVta2, lnPDtoVta3, lnPDtoVta4, lnIDtoVta1, lnIDtoVta2, lnIDtoVta3, lnIDtoVta4
LOCAL lnIdCondPago, lnIdSitIVA, lnPrArtic, lnPorRec, lnImpRec, lnUniDesp, lnCantPack, lcUniMed
LOCAL lnPRecItem, lnIRecItem
LOCAL ldFecVto, lnIdOper, oDT, lnOC
LOCAL loNumerador, lcSql, loCommand, loArtic, loOper, lnSqlSrv, lnPrNeto, lnIdCCOrig, loCliente, lnIdVendedor

&& Inicializo las variables del detalle

lnIdVentasD = 0
lnIdArticulo = 0
lnCantidad = 0.00
lnCostoRep = 0.00
lnPrVenta = 0.00
lnAlicIVA = 0.00
lnImpIVA = 0.00
lnTotNeto = 0.00
lnSubTotal = 0.00
ldFecVto = {}
lnIdOper = 0
lnSaldo = 0
oDT = CREATEOBJECT("datetime")
loArtic = CREATEOBJECT("odbc_result")
loOper = CREATEOBJECT("odbc_result")
loCliente = CREATEOBJECT("odbc_result")
loCommand = CREATEOBJECT("odbc_command")
lnSqlSrv = INT(VAL(getconfig("SQLSRV")))
lcObserv = Thisform.Contenido.txtObserv.Value
lnPorIIBB = 0.00
lnImpIIBB = 0.00
lnPDtoVta1 = 0.00
lnPDtoVta2 = 0.00
lnPDtoVta3 = 0.00
lnPDtoVta4 = 0.00
lnIDtoVta1 = 0.00
lnIDtoVta2 = 0.00
lnIDtoVta3 = 0.00
lnIDtoVta4 = 0.00
lnImpDesc1 = 0.00
lnImpDesc2 = 0.00
lnImpDesc3 = 0.00
lnImpDesc4 = 0.00
lnPrNeto = 0.00
lnIdCondPago = 0
lnIdSitIVA = 0
lnIdVendedor = 0
lnPrArtic = 0.00
lnPorRec = 0.00
lnImpRec = 0.00
lcUniMed = ""
lnOC = Thisform.Contenido.txtOC.Value
lnPRecItem = 0.00
lnIRecItem = 0.00 

&& Inicio la transacción
goConn.BeginTransaction()

&& Asigno los valores de la cabecera

lnIdCliente = Thisform.Contenido.sel_Cliente.ValCpoId

&& Asigno el idvendedor
lcSql = "SELECT * FROM clientes WHERE idCliente = " + ALLTRIM(STR(lnIdCliente))
loCliente.ActiveConnection = goConn.ActiveConnection
loCliente.Cursor_Name = "cur_cliente"
loCliente.OpenQuery(lcSql)

lnIdVendedor = cur_cliente.idVendedor

loCliente.Close_Query()

lcFecEmis = ALLTRIM(STR(YEAR(DATETIME()))) + "-" + ALLTRIM(STR(MONTH(DATETIME()))) + " - " + ;
	ALLTRIM(STR(DAY(DATETIME())))
	
lcCbte = Thisform.Cbte

IF lcCbte == "COT"
	lcTipoDoc = "X"
	Thisform.tipodoc = lcTipoDoc
ELSE
	&& Aca tengo que agregar el cálculo en caso que sea
	&& comprobante fiscal
	IF lcCbte == "PED"
		lcTipoDoc = "P"
		Thisform.tipodoc = lcTipoDoc
	ELSE
		lcTipoDoc = thisform.calcular_tipodoc()
		Thisform.tipodoc = lcTipoDoc
	ENDIF
ENDIF

IF lcCbte == "PTO" THEN
	lnPtoVta = 9999
	lcTipoDoc = "X"
	Thisform.tipodoc = lcTipoDoc
ELSE
	lnPtoVta = INT(VAL(ALLTRIM(getconfig("PTOVTA"))))
ENDIF

IF !(lcCbte == "COT") .AND. getGlobalCFG("STK_MODULE") THEN
	IF !thisform.validar_stk_en_grabado() THEN
		goConn.Rollback()
		RETURN .F.
	ENDIF
ENDIF

Thisform.ptovta = REPLICATE("0", 4 - LEN(ALLTRIM(STR(lnPtoVta)))) + ALLTRIM(STR(lnPtoVta))

IF Thisform.usar_fiscal THEN
	Thisform.enviar_fiscal()
	lnNroCbte = Thisform.fis_numcbte
	
	IF lnNroCbte = 0 THEN
		MESSAGEBOX("Error en el controlador fiscal, la factura no se grabará", 0+48, Thisform.Caption)
		RETURN .F.
	ENDIF
ELSE
	&& En caso que el sistema no use controlador fiscal, entonces,
	&& el número debe generarlo a partir de la tabla numerador de la
	&& base de datos
	
	lcSql = "select * from numerador where cbte = '" + ALLTRIM(lcCbte) + "' and tipoDoc = '" + ALLTRIM(lcTipoDoc) + "' AND ptoVta = " + ALLTRIM(STR(lnPtoVta))
	loNumerador = CREATEOBJECT("odbc_result")
	loNumerador.ActiveConnection = goConn.ActiveConnection
	loNumerador.Cursor_Name = "cur_num"
	loNumerador.OpenQuery(lcSql)
	SELECT cur_num

	IF RECCOUNT("cur_num") = 0 THEN
		MESSAGEBOX("No se encuentra configurado el numerador del comprobante " + ALLTRIM(lcCbte) + " Punto de Venta: " + ALLTRIM(STR(lnPtoVta)) + " Letra: " + ALLTRIM(lcTipoDoc), 0+48, thisform.Caption)
		loNumerador.close_query()
		RETURN .F.
	ENDIF

	SELECT cur_num
	lnNroCbte = cur_num.numActual + 1
	Thisform.nrocbte = REPLICATE("0", 8 - LEN(ALLTRIM(STR(lnNroCbte)))) + ALLTRIM(STR(lnNroCbte))
	Thisform.idNum = cur_num.idNum
	*Thisform.printerDevice = cur_num.impresora
	*Thisform.cant_copias = cur_num.cantCpia

	loNumerador.close_query()	
	
	&& Actualizo el numerador
	lcSql = "update numerador set numActual = " + ALLTRIM(STR(lnNroCbte)) + ;
		" where cbte = '" + ALLTRIM(lcCbte) + "' and tipoDoc = '" + ALLTRIM(lcTipoDoc) + "' " + ;
		"	and ptoVta = " + ALLTRIM(STR(lnPtoVta))

	loCommand.ActiveConnection = goConn.ActiveConnection
	loCommand.CommandText = lcSql

	IF !loCommand.Execute()
		goConn.Rollback()
		RETURN .F.
	ENDIF	
ENDIF

llAnulado = .F.
lnImpNeto = Thisform.Contenido.txtTotNeto.Value
lnImpFinal = Thisform.Contenido.txtST.Value
lnPorIVA21 = Thisform.Contenido.txtPorIVA21.Value
lnPorIVA105 = Thisform.Contenido.txtPorIVA105.Value
lnImpIVA21 = Thisform.Contenido.txtImpIva21.Value
lnImpIVA105 = Thisform.Contenido.txtImpIva105.Value
lnPorIIBB= Thisform.contenido.txtPorIIBB.Value
lnImpIIBB = thisform.contenido.txtImpIIBB.Value
lnPorDesc1 = thisform.contenido.txtDesc1.Value
lnPorDesc2 = thisform.contenido.txtdesc2.Value
lnPorDesc3 = Thisform.contenido.txtdesc3.Value
lnPorDesc4 = Thisform.contenido.txtdesc4.Value
lnPorRec = Thisform.contenido.txtporrec.Value
lnImpRec = Thisform.contenido.txtimprec.Value  

SELECT cur_detalle
GO TOP 
DO WHILE !EOF()
	lnImpDesc1 = lnImpDesc1 + ROUND(cur_detalle.iDtoCli1 * cur_detalle.cantidad, 2)
	lnImpDesc2 = lnImpDesc2 + ROUND(cur_detalle.iDtoCli2 * cur_detalle.cantidad, 2)
	lnImpDesc3 = lnImpDesc3 + ROUND(cur_detalle.iDtoCli3 * cur_detalle.cantidad, 2)
	lnImpDesc4 = lnImpDesc4 + ROUND(cur_detalle.iDtoCli4 * cur_detalle.cantidad, 2)
	
	SELECT cur_detalle
	SKIP 
ENDDO ´

lnTotFact = Thisform.Contenido.txtTotFact.Value
lnIdCondPago = clientes.idCondPago
lnIdSitIVA = clientes.idSitIVA

lnIdVentasC = goConn.GetNextID("ventascab", "idVentasC")

&& Calculo la fecha de vencimiento correspondiente a la factura
IF ALLTRIM(Thisform.cbte) == "FC" THEN 
	IF thisform.cp_cntdias <> 0 THEN
		ldFecVto = DATE() + thisform.cp_cntdias
	ELSE
		ldFecVto = DATE()		
	ENDIF 
ELSE
	ldFecVto = DATE()
ENDIF

IF ALLTRIM(Thisform.cbte) == "FC" THEN
	lnSaldo = Thisform.Contenido.txtTotFact.Value
ELSE
	lnSaldo = 0
ENDIF
	
lcSql = "INSERT INTO ventascab ( "
lcSql = lcSql + "idVentasC, idCliente, razSoc, idTipoDoc, nroDoc, fecEmision, cbte, tipoDoc, ptoVta, numCbte, anulado, idCondPago, idSitIVA, idVendedor,"
lcSql = lcSql + "impNeto, impFinal, porIVA21, impIVA21, porIVA105, impIVA105, porDesc1, "
lcSql = lcSql + "porDesc2, porDesc3, porDesc4, impDesc1, impDesc2, impDesc3, impDesc4, totFact, Saldo, usuAlta, fecAlta, idHostAlta, observ, porIIBB, impIIBB, fecVto, porRec, impRec, nroOC) VALUES ("
lcSql = lcSql + ALLTRIM(STR(lnIdVentasC)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnIdCliente)) + ", "
lcSql = lcSql + "'" + STRTRAN(ALLTRIM(Thisform.contenido.sel_Cliente.txtDescripcion.Value), "'", "''") + "', "
lcSql = lcSql + ALLTRIM(STR(Thisform.cli_idTipoDoc)) + ", "
lcSql = lcSql + "'" + ALLTRIM(Thisform.contenido.txtCuit.Value) + "', "
*lcSql = lcSql + oDT.getDateTime() + ", "
lcSql = lcSql + oDT.toMySql(Thisform.contenido.txtFecEmis.Value) + ", "
lcSql = lcSql + "'" + ALLTRIM(lcCbte) + "', "
lcSql = lcSql + "'" + ALLTRIM(lcTipoDoc) + "', "
lcSql = lcSql + ALLTRIM(STR(lnPtoVta)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnNroCbte)) + ", "
lcSql = lcSql + IIF(lnSqlSrv = 0, "false", "0") + ", "
lcSql = lcSql + ALLTRIM(STR(lnIdCondPago)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnIdSitIVA)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnIdVendedor)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpNeto, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpFinal, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnPorIVA21, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpIVA21, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnPorIVA105, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpIVA105, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnPorDesc1, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnPorDesc2, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnPorDesc3, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnPorDesc4, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpDesc1, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpDesc2, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpDesc3, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpDesc4, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnTotFact, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnSaldo, 10, 2)) + ", "
lcSql = lcSql + "'" + ALLTRIM(gcCodUsu) + "', " 
lcSql = lcSql + oDT.getDateTime() + ", "
lcSql = lcSql + "'" + SYS(0) + "', '" + ALLTRIM(lcObserv) + "', "
lcSql = lcSql + ALLTRIM(STR(lnPorIIBB, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpIIBB, 10, 2)) + ", "
lcSql = lcSql + IIF(INT(VAL(getconfig("SQLSRV"))) = 1, oDT.getDateTime() + " + " + ALLTRIM(STR(thisform.cp_cntdias)), oDT.toMySql(ldFecVto)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnPorRec, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpRec, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnOC)) + ")"

loCommand.ActiveConnection = goConn.ActiveConnection
loCommand.CommandText = lcSql

IF !loCommand.Execute()
	goConn.Rollback()
	RETURN .F.
ENDIF

&& Grabo el detalle del comprobante

SELECT cur_Detalle
IF RECCOUNT() > 0
	GO TOP
ENDIF

lnIdVentasD = 0

DO WHILE !EOF()
	lnIdVentasD = lnIdVentasD + 1
	
	lnIdArticulo = cur_Detalle.idArticulo
	lnCantidad = cur_Detalle.cantidad
	lnAlicIVA = cur_Detalle.alicIVA
	lnPrVenta = cur_Detalle.PrVta
	lnImpIVA = cur_Detalle.impIVA
	lnPrNeto = cur_Detalle.impNeto
	lnTotNeto = cur_Detalle.totNeto
	lnSubTotal = cur_Detalle.subTotal
	lnPDtoVta1 = cur_Detalle.pDtoVta1
	lnPDtoVta2 = cur_Detalle.pDtoVta2
	lnPDtoVta3 = cur_Detalle.pDtoVta3
	lnPDtoVta4 = cur_Detalle.pDtoVta4
	lnIDtoVta1 = cur_Detalle.iDtoVta1
	lnIDtoVta2 = cur_Detalle.iDtoVta2
	lnIDtoVta3 = cur_Detalle.iDtoVta3
	lnIDtoVta4 = cur_Detalle.iDtoVta4
	
	lnPorDesc1 = cur_Detalle.pDtoCli1
	lnPorDesc2 = cur_Detalle.pDtoCli2
	lnPorDesc3 = cur_Detalle.pDtoCli3
	lnPorDesc4 = cur_Detalle.pDtoCli4
	lnImpDesc1 = cur_Detalle.iDtoCli1
	lnImpDesc2 = cur_Detalle.iDtoCli2
	lnImpDesc3 = cur_Detalle.iDtoCli3
	lnImpDesc4 = cur_Detalle.iDtoCli4
	
	lnPrArtic = cur_Detalle.prArtic
	lnPorRec = cur_Detalle.pRecVta
	lnImpRec = cur_Detalle.iRecVta
	lnUniDesp = cur_Detalle.uniDesp
	lnCantPack = cur_Detalle.cantPack
	lcUniMed = cur_Detalle.uniMed
	lnPRecItem = cur_Detalle.pRecItem
	lnIRecItem = cur_Detalle.iRecItem
	
	lcSql = "SELECT * FROM articulos WHERE idArticulo = " + ALLTRIM(STR(lnIdArticulo))
	loArtic.ActiveConnection = goConn.ActiveConnection
	loArtic.Cursor_Name = "cur_Artic"
	loArtic.OpenQuery(lcSql)
	
	SELECT cur_Artic
	lnCostoRep = cur_Artic.costoRep
	
	loArtic.close_query()

	lcSql = "INSERT INTO ventasdet ( "
	lcSql = lcSql + "idVentasD, "
	lcSql = lcSql + "idVentasC, "
	lcSql = lcSql + "idArticulo, "
	lcSql = lcSql + "descripcio, "
	lcSql = lcSql + "nroPart, "
	lcSql = lcSql + "Cantidad, "

	IF ALLTRIM(lcCbte) == "PED" THEN
		lcSql = lcSql + "cant_pri1, "
	ENDIF	
	
	lcSql = lcSql + "costoRep, "
	lcSql = lcSql + "prVenta, "
	lcSql = lcSql + "alicIVA, "
	lcSql = lcSql + "impIVA, "
	lcSql = lcSql + "subTotal, "
	lcSql = lcSql + "porDesc1, "
	lcSql = lcSql + "porDesc2, "
	lcSql = lcSql + "porDesc3, "
	lcSql = lcSql + "porDesc4, "
	lcSql = lcSql + "impDesc1, "
	lcSql = lcSql + "impDesc2, "
	lcSql = lcSql + "impDesc3, "
	lcSql = lcSql + "impDesc4, "
	lcSql = lcSql + "pDtoVta1, "
	lcSql = lcSql + "pDtoVta2, "
	lcSql = lcSql + "pDtoVta3, "
	lcSql = lcSql + "pDtoVta4, "
	lcSql = lcSql + "iDtoVta1, "
	lcSql = lcSql + "iDtoVta2, "
	lcSql = lcSql + "iDtoVta3, "
	lcSql = lcSql + "iDtoVta4, "
	lcSql = lcSql + "pRecItem, "
	lcSql = lcSql + "iRecItem, "
	lcSql = lcSql + "impNeto, "
	lcSql = lcSql + "totNeto, "
	lcSql = lcSql + "prArtic, "
	lcSql = lcSql + "esOferta, "
	lcSql = lcSql + "pRecVta, "
	lcSql = lcSql + "iRecVta, "
	lcSql = lcSql + "uniDesp, "
	lcSql = lcSql + "cantPack, "
	lcSql = lcSql + "codUM) VALUES ( "
	lcSql = lcSql + ALLTRIM(STR(lnIdVentasD)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIdVentasC)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIdArticulo)) + ", "
	lcSql = lcSql + "'" + STRTRAN(ALLTRIM(cur_detalle.descripcio), "'", "''") + "', "
	lcSql = lcSql + "'" + ALLTRIM(cur_detalle.nroPart) + "', "
	lcSql = lcSql + ALLTRIM(STR(lnCantidad, 10, 2)) + ", "
	
	IF ALLTRIM(lcCbte) == "PED" THEN
		lcSql = lcSql + ALLTRIM(STR(lnCantidad, 10, 2)) + ", "
	ENDIF	
	
	lcSql = lcSql + ALLTRIM(STR(lnCostoRep, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPrVenta, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnAlicIVA, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnImpIVA, 10, 4)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnSubTotal, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPorDesc1, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPorDesc2, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPorDesc3, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPorDesc4, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnImpDesc1, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnImpDesc2, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnImpDesc3, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnImpDesc4, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPDtoVta1, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPDtoVta2, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPDtoVta3, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPDtoVta4, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIDtoVta1, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIDtoVta2, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIDtoVta3, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIDtoVta4, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPRecItem, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIRecItem, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPrNeto, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnTotNeto, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPrArtic, 10, 2)) + ", "
	lcSql = lcSql + IIF(cur_detalle.esOferta, "1", "0") + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPorRec, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnImpRec, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnUniDesp, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnCantPack, 10, 2)) + ", "
	lcSql = lcSql + "'" + ALLTRIM(lcUniMed) + "')"
	
	*******************************************************************************************
	
	loCommand.ActiveConnection = goConn.ActiveConnection
	loCommand.CommandText = lcSql
	
	IF !loCommand.Execute()
		goConn.Rollback()
		RETURN .F.
	ENDIF
	
	&& Si es nota de crédito entonces, actualizo la cantidad de NC en los
	&& items de la factura.
	&& Actualizar este dato tiene como objetivo de que si se hace más una NC
	&& que no se pueda hacer dos veces sobre la misma cantidad de un producto
	&& sino que por el resto.
	
	IF ALLTRIM(Thisform.cbte) == "NC" THEN
		lcSql = "UPDATE ventasdet SET cantNC = cantNC + " + ALLTRIM(STR(lnCantidad)) + " "
		lcSql = lcSql + "WHERE idVentasC = " + ALLTRIM(STR(Thisform.idorigen)) + " "
		lcSql = lcSql + " AND idArticulo = " + ALLTRIM(STR(cur_Detalle.idArticulo))
		
		loCommand.ActiveConnection = goConn.ActiveConnection
		loCommand.CommandText = lcSql
		
		IF !loCommand.Execute() THEN
			goConn.Rollback()
			RETURN .F.
		ENDIF
	ENDIF
	
	SELECT cur_Detalle
	SKIP
ENDDO

IF ALLTRIM(thisform.cbte) == "FC" THEN
	lnProxID = goConn.GetNextId("cc_cli", "idCC_Cli")
	lnIdCliente = Thisform.contenido.sel_Cliente.valcpoid
	lnIdOper = goConn.GetNextID("cc_cli", "idOper")
	
	&& Inserto el registro correspondiente a la factura en la tabla de cuentas corrientes
	lcSql = "INSERT INTO cc_cli (idCC_Cli, idCliente, idCC_Orig, cbte, nroCbte, tipoDoc, ptoVta, idCondPago, idSitIVA, idVendedor, "
	lcSql = lcSql + "fecEmis, fecVto, impDebe, impHaber, idOper, idVentasC, usuAlta, fecAlta, idHostAlta) VALUES ( "
	lcSql = lcSql + ALLTRIM(STR(lnProxID)) + ", " + ALLTRIM(STR(lnIdCliente)) + ", null, '" + ALLTRIM(lcCbte) + "', "
	lcSql = lcSql + ALLTRIM(STR(lnNroCbte)) + ", '" + ALLTRIM(lcTipoDoc) + "', " + ALLTRIM(STR(lnPtoVta)) + ", " + ALLTRIM(STR(lnIdCondPago)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIdSitIVA)) + ", " + ALLTRIM(STR(lnIdVendedor)) + ", " + oDT.getDateTime() + ", "
	lcSql = lcsql + IIF(INT(VAL(getconfig("SQLSRV"))) = 1, oDT.getDateTime() + " + " + ALLTRIM(STR(thisform.cp_cntdias)), oDT.toMySql(ldFecVto)) + ", " + ALLTRIM(STR(lnTotFact, 10, 2)) + ", 0, " + ALLTRIM(STR(lnIdOper)) + ", " + ALLTRIM(STR(lnIdVentasC)) + ", "
	lcSql = lcSql + "'" + ALLTRIM(gcCodUsu) + "', " + oDT.getDateTime() + ", '" + ALLTRIM(SYS(0)) + "')"
	
	loCommand.ActiveConnection = goConn.ActiveConnection
	loCommand.CommandText = lcSql
	
	IF !loCommand.Execute()
		goConn.Rollback()
		RETURN .F.
	ENDIF
ELSE
	IF ALLTRIM(Thisform.cbte) == "NC" THEN
		&& Verifico si tiene numero de operación asignado
		lcSql = "SELECT idCC_Cli, idOper FROM cc_cli WHERE idVentasC = " + ALLTRIM(STR(Thisform.idorigen))
		loOper.ActiveConnection = goConn.ActiveConnection
		loOper.Cursor_Name = "cur_Oper"
		loOper.OpenQuery(lcSql)
		
		lnIdCCOrig = cur_Oper.idCC_Cli
		lnIdOper = cur_Oper.idOper
		
		loOper.Close_Query()
		
		&& Tengo que calcular el Id de Operación para vincular ambos comprobantes
		IF lnIdOper = 0 THEN
			lcSql = "SELECT MAX(cc_cli.idOper) AS maxIdOper FROM cc_cli"
			loOper.ActiveConnection = goConn.ActiveConnection
			loOper.Cursor_Name = "cur_Oper"
			loOper.OpenQuery(lcSql)
			
			lnIdOper = cur_Oper.maxIdOper + 1
			
			loOper.Close_Query()
		
			&& Actualizo el comprobante de origen con el Id de Operación calculado
			lcSql = "UPDATE cc_cli SET idOper = " + ALLTRIM(STR(lnIdOper)) + " WHERE idVentasC = " + ALLTRIM(STR(Thisform.idorigen))
			loCommand.ActiveConnection = goConn.ActiveConnection
			loCommand.CommandText = lcSql
		
			IF !loCommand.Execute()
				goConn.Rollback()
				RETURN .F.
			ENDIF	
		ENDIF
		
		&& Genero el registro de la nota de crédito en las cuentas corrientes del cliente
		
		lnProxID = goConn.GetNextId("cc_cli", "idCC_Cli")
		lnIdCliente = Thisform.contenido.sel_Cliente.valcpoid	
		
		lcSql = "INSERT INTO cc_cli (idCC_Cli, idCliente, idCC_Orig, cbte, nroCbte, tipoDoc, ptoVta, idCondPago, idSitIVA, idVendedor, "
		lcSql = lcSql + "fecEmis, fecvto, impDebe, impHaber, idOper, idVentasC, usuAlta, fecAlta, idHostAlta) VALUES ( "
		lcSql = lcSql + ALLTRIM(STR(lnProxID)) + ", " + ALLTRIM(STR(lnIdCliente)) + ", " + ALLTRIM(STR(lnIdCCOrig)) + ", '" + ALLTRIM(lcCbte) + "', "
		lcSql = lcSql + ALLTRIM(STR(lnNroCbte)) + ", '" + ALLTRIM(lcTipoDoc) + "', " + ALLTRIM(STR(lnPtoVta)) + ", " + ALLTRIM(STR(lnIdCondPago)) + ", "
		lcSql = lcSql + ALLTRIM(STR(lnIdSitIVA)) + ", " + ALLTRIM(STR(lnIdVendedor)) + ", " + oDT.getDateTime() + ", "
		lcSql = lcsql + IIF(INT(VAL(getconfig("SQLSRV"))) = 1, oDT.getDateTime() + " + " + ALLTRIM(STR(thisform.cp_cntdias)), oDT.toMySql(ldFecVto)) + ", 0, " + ALLTRIM(STR(lnTotFact, 10, 2)) + ", " + ALLTRIM(STR(lnIdOper)) + ", " + ALLTRIM(STR(lnIdVentasC)) + ", "
		lcSql = lcSql + "'" + ALLTRIM(gcCodUsu) + "', " + oDT.getDateTime() + ", '" + ALLTRIM(SYS(0)) + "')"
		
		loCommand.ActiveConnection = goConn.ActiveConnection
		loCommand.CommandText = lcSql
		
		IF !loCommand.Execute()
			goConn.Rollback()
			RETURN .F.
		ENDIF
		
		lnSaldo = Thisform.saldo_fc - thisform.Contenido.txtTotFact.Value
		
		&& Actualizo el Saldo en la factura para validar que no se pueda
		&& aplicar un importe superior al saldo.
		lcSql = "UPDATE ventascab SET saldo = " + ALLTRIM(STR(lnSaldo, 10, 2)) + ", "
		lcSql = lcSql + "usuModi = '" + ALLTRIM(gcCodUsu) + "', "
		lcSql = lcSql + "fecModi = " + oDT.getDateTime() + ", "
		lcSql = lcSql + "idHostModi = '" + ALLTRIM(SYS(0)) + "' " 				
		lcSql = lcSql + "WHERE idVentasC = " + ALLTRIM(STR(Thisform.idorigen))
		
		loCommand.ActiveConnection = goConn.ActiveConnection
		loCommand.CommandText = lcSql
		
		IF !loCommand.Execute()
			goConn.Rollback()
			RETURN .F.
		ENDIF	
	ENDIF
ENDIF

&& Ahora tengo que generar la relación entre el comprobante de origen con el comprobante
&& de destino
IF (ALLTRIM(Thisform.cbte) == "NC") .OR. (ALLTRIM(Thisform.Cbte) == "FC") .OR. (ALLTRIM(Thisform.cbte) == "PTO") THEN
	SELECT cur_cbtes
	IF RECCOUNT("cur_cbtes") > 0 THEN
		GO TOP
	ENDIF
	
	DO WHILE !EOF("cur_cbtes")
		IF cur_cbtes.sel THEN
			IF ALLTRIM(thisform.cbte) == "PTO" THEN
				lnProxID = loConDMO.GetNextId("ventasrel", "idVtaRel")
			ELSE
				lnProxID = goConn.GetNextId("ventasrel", "idVtaRel")
			ENDIF
			
			lcSql = "INSERT INTO ventasrel (idVtaRel, idVtaCO, idVtaCD) VALUES ("
			lcSql = lcSql + ALLTRIM(STR(lnProxID)) + ", " + ALLTRIM(STR(cur_cbtes.idVentasC)) + ", " + ALLTRIM(STR(lnIdVentasC)) + ")"
			
			loCommand.CommandText = lcSql

			IF ALLTRIM(lcCbte) == "PTO" 
				loCommand.ActiveConnection = loConDMO.ActiveConnection
				IF !loCommand.Execute()
					thisform.desbloq_numerador()
					loConDMO.Rollback()
					RETURN .F.
				ENDIF	
			ELSE
				loCommand.ActiveConnection = goConn.ActiveConnection
				IF !loCommand.Execute()
					thisform.desbloq_numerador()
					goConn.Rollback()
					RETURN .F.
				ENDIF
			ENDIF
		ENDIF
		
		SELECT cur_cbtes
		SKIP
	ENDDO
ENDIF

IF ALLTRIM(Thisform.Cbte) == "PED" THEN
	IF thisform.pedido_automatica THEN
*		IF getglobalcfg("TRANS_PED") THEN
*			loSoapCli = CREATEOBJECT("MSSOAP.SoapClient30")
*			loSoapCli.MSSoapInit(gcUrlWS)
*			loSoapCli.marcarProcesado(Thisform.idPedarch)
*			thisform.marcar_procesado()
*		ENDIF
	ENDIF
ENDIF

************************************************************************************************
* Agrego que se genere el movimiento de stock al grabar la operación
* siempre y cuando el sistema se encuentre configurado para soportar esta funcionalidad
************************************************************************************************
IF getGlobalCFG("STK_MODULE") .AND. (ALLTRIM(THisform.Cbte) <> "COT" .OR. ALLTRIM(THisform.Cbte) <> "NC") THEN
	Thisform.mov_stock.idcliente = thisform.contenido.sel_Cliente.valcpoid
	Thisform.mov_stock.idprov = 0
	Thisform.mov_stock.tipodoc = Thisform.tipodoc
	Thisform.mov_stock.cbte = lcCbte
	Thisform.mov_stock.numcbte =  REPLICATE("0", 4 - LEN(ALLTRIM(STR(lnPtoVta)))) + ALLTRIM(STR(lnPtoVta)) + "-" + REPLICATE("0", 8 - LEN(ALLTRIM(STR(lnNroCbte)))) + ALLTRIM(STR(lnNroCbte))

	IF !(ALLTRIM(Thisform.cbte) == "COT") THEN
		IF !(ALLTRIM(Thisform.cbte) == "PED") THEN
			IF !Thisform.mov_stock.grabar2() THEN
				MESSAGEBOX(Thisform.mov_stock.ErrorMessage, 0+48, Thisform.Caption)
				goConn.Rollback()
				RETURN .F.
			ENDIF
		ENDIF	
	ENDIF
ENDIF

IF ALLTRIM(Thisform.cbte) == "PED" THEN
	IF !Thisform.marcar_procesado() THEN
		goConn.Rollback()
	ENDIF
ENDIF

goConn.Commit()

MESSAGEBOX("El comprobante: " + ALLTRIM(lcCbte) + " " + ALLTRIM(lcTipoDoc) + " " + REPLICATE("0", 4 - LEN(ALLTRIM(STR(lnPtoVta)))) + ALLTRIM(STR(lnPtoVta)) + "-" + ;
	REPLICATE("0", 8 - LEN(ALLTRIM(STR(lnNroCbte)))) + ALLTRIM(STR(lnNroCbte)) + " se ha generado exitosamente...", 0+64, Thisform.Caption)

RETURN .T.
ENDPROC
PROCEDURE validardetalle
IF ALLTRIM(Thisform.Contenido.sel_Articulo.txtCodigo.Value) == "" THEN
	MESSAGEBOX("Debe ingresar el artículo", 0+48, Thisform.Caption)
	Thisform.Contenido.sel_Articulo.txtCodigo.SetFocus()
	RETURN .F.
ENDIF

IF Thisform.Contenido.txtCantidad.Value = 0 THEN
	MESSAGEBOX("Falta ingresar la cantidad", 0+48, Thisform.Caption)
	Thisform.Contenido.txtCantidad.SetFocus()
	RETURN .F.
ENDIF

IF Thisform.Contenido.txtCantidad.Value < 0 THEN
	MESSAGEBOX("La cantidad ingresada no puede ser un valor negativo", 0+48, Thisform.Caption)
	Thisform.Contenido.txtCantidad.SetFocus()
	RETURN .F.
ENDIF

IF RIGHT(ALLTRIM(Thisform.Contenido.sel_Articulo.txtCodigo.Value), 3) != "ARX" THEN
	IF clientes.mayorista THEN
		IF Thisform.contenido.txtPrMay.Value = 0 THEN
			MESSAGEBOX("El precio del artículo se encuentra en cero, corregir artículo.", 0+48, Thisform.Caption)
			Thisform.contenido.txtPrMay.SetFocus()
			RETURN .F.
		ENDIF
	ELSE
		IF Thisform.contenido.txtPrMinorista.Value = 0 THEN
			MESSAGEBOX("El precio del artículo se encuentra en cero, corregir artículo.", 0+48, Thisform.Caption)
			Thisform.contenido.txtPrMay.SetFocus()
			RETURN .F.
		ENDIF
	ENDIF
ENDIF

IF (ALLTRIM(Thisform.cbte) != "COT") .AND. (ALLTRIM(Thisform.cbte) != "NC") THEN
	&& Valido el stock solo en caso que no sea artículo X
	IF RIGHT(ALLTRIM(Thisform.Contenido.sel_Articulo.txtCodigo.Value), 3) != "ARX" THEN
		IF getGlobalCFG("STK_MODULE") THEN
			IF Thisform.mov_stock.get_exist_byart(Thisform.Contenido.sel_Articulo.valcpoid) <= 0 THEN
				MESSAGEBOX("No hay stock disponible.", 0+48, Thisform.Caption)
				Thisform.Contenido.sel_Articulo.txtCodigo.SetFocus()
				RETURN .F.
			ENDIF
			
			&& Valido si está o no cubierto al 100%
			IF Thisform.Contenido.txtCantidad.Value > Thisform.Contenido.txtExistencia.Value THEN
				MESSAGEBOX("No hay stock suficiente para cubrir la cantidad ingresada.", 0+48, Thisform.Caption)
				Thisform.Contenido.sel_Articulo.txtCodigo.SetFocus()
				RETURN .F.
			ENDIF
		ENDIF
	ENDIF
ENDIF

RETURN .T.


ENDPROC
PROCEDURE validarcampos
IF Thisform.Contenido.Sel_Cliente.estavacio() .AND. ALLTRIM(Thisform.Contenido.Sel_Cliente.txtDescripcion.Value) == ""
	MESSAGEBOX("Debe ingresar el cliente", 0+48, Thisform.Caption)
	Thisform.Contenido.sel_Cliente.txtCodigo.SetFocus()
	RETURN .F.
ENDIF

&& Valido que los datos de identificacion del cliente estén bien
&& cargados

IF ALLTRIM(Thisform.cli_tipodoc) == "" THEN
	MESSAGEBOX("Atención: El tipo de documento del cliente no tiene ningún valor, edite al cliente y corrija este dato para poder seguir", 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

IF ALLTRIM(Thisform.cli_cuit) == "" THEN
	MESSAGEBOX("Atención: No se encuentra cargado el número de DNI/CUIT del cliente. Por favor, edite el mismo para poder continuar", 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

IF Thisform.Contenido.sel_FormaPago.EstaVacio()
	MESSAGEBOX("Debe ingresar la forma de pago", 0+48, Thisform.Caption)
	Thisform.Contenido.sel_FormaPago.txtCodigo.SetFocus()
	RETURN .F.
ENDIF


SELECT cur_Deta_View
IF RECCOUNT() = 0
	MESSAGEBOX("Debe ingresar al menos un artículo", 0+48, Thisform.Caption)
	Thisform.Contenido.sel_Articulo.txtCodigo.SetFocus()
	RETURN .F.
ENDIF

IF ALLTRIM(Thisform.cbte) == "NC" THEN
	IF thisform.saldo_fc <> 0 THEN
		IF Thisform.Contenido.txtTotFact.Value > thisform.saldo_fc THEN
			MESSAGEBOX("No puede realizar una nota de crédito mayor al saldo de cuenta corriente de la factura", 0+48, Thisform.Caption)
			RETURN .F.
		ENDIF
	ENDIF
	
	IF Thisform.idOrigen = 0 THEN
		MESSAGEBOX("No se puede generar una nota de crédito por devolución sin Factura. Vaya a Cbte. Origen y seleccione la factura.", 0+48, Thisform.Caption)
		RETURN .F.
	ENDIF 
ENDIF

IF ALLTRIM(Thisform.cbte) == "FC" THEN
	IF Thisform.Contenido.txtTotFact.Value >= 1000 THEN
		IF LEN(ALLTRIM(Thisform.contenido.txtCuit.Value)) < 7 THEN
			MESSAGEBOX("Esta venta supera los $1000, por favor solicite el número de documento", 0+48, Thisform.Caption)
			Thisform.contenido.txtCuit.SetFocus()
			RETURN .F.
		ENDIF
		
		IF VAL(Thisform.contenido.txtCuit.Value) = 1 THEN
			MESSAGEBOX("Esta venta supera los $1000, por favor solicite el número de documento", 0+48, Thisform.Caption)
			Thisform.Contenido.txtCuit.SetFocus()
			RETURN .F.
		ENDIF
		
		IF ALLTRIM(Thisform.Contenido.txtCuit.Value) == "" THEN
			MESSAGEBOX("Esta venta supera los $1000, por favor solicite el número de documento", 0+48, Thisform.Caption)
			Thisform.Contenido.txtCuit.SetFocus()
			RETURN .F.
		ENDIF
	ENDIF
ENDIF

RETURN .T.

ENDPROC
PROCEDURE Load
DODEFAULT()

CREATE CURSOR cur_PedExt (	;
	idPedExt		int,;
	idArticulo		int,;
	codArt			varchar(20),;
	cantidad		int)

CREATE CURSOR cur_Detalle (	;
	idDetalle		int			,;
	idArticulo		int 		,;
	codArt			C(20)		,;
	descripcio		C(60)		,;
	nroPart			varchar(30)	,;
	cantidad		float(10,2)	,;
	prVta			float(10,2)	,;
	pDtoVta1		float(10,2)	,;
	pDtoVta2		float(10,2)	,;
	pDtoVta3		float(10,2)	,;
	pDtoVta4		float(10,2)	,;
	iDtoVta1		float(10,2)	,;
	iDtoVta2		float(10,2)	,;
	iDtoVta3		float(10,2)	,;
	iDtoVta4		float(10,2)	,;
	pDtoCli1		float(10,2)	,;
	pDtoCli2		float(10,2)	,;
	pDtoCli3		float(10,2)	,;
	pDtoCli4		float(10,2)	,;
	iDtoCli1		float(10,2)	,;
	iDtoCli2		float(10,2)	,;
	iDtoCli3		float(10,2)	,;
	iDtoCli4		float(10,2)	,;
	pRecItem		float(10,2)	,;
	iRecItem		float(10,2)	,;	
	alicIVA			float(10,2)	,;
	impIVA			float(10,4)	,;
	impNeto			float(10,2)	,;	
	totNeto			float(10,2)	,;
	subTotal		float(10,2)	,;
	stkDisp			float(10,2)	,;
	prArtic			float(10,2)	,;
	esOferta		l,;
	pRecVta			float(10,2)	,;
	iRecVta			float(10,2)	,;
	uniDesp			float(10,2)	,;
	cantPack		float(10,2)	,;
	uniMed			varchar(3))

CREATE CURSOR cur_Aux (	;
	idDetalle		int			,;
	idArticulo		int 		,;
	codArt			C(20)		,;
	descripcio		C(60)		,;
	nroPart			varchar(30) ,;
	cantidad		float(10,2)	,;
	prVta			float(10,2)	,;
	pDtoVta1		float(10,2)	,;
	pDtoVta2		float(10,2)	,;
	pDtoVta3		float(10,2)	,;
	pDtoVta4		float(10,2)	,;
	iDtoVta1		float(10,2)	,;
	iDtoVta2		float(10,2)	,;
	iDtoVta3		float(10,2)	,;
	iDtoVta4		float(10,2)	,;
	pDtoCli1		float(10,2)	,;
	pDtoCli2		float(10,2)	,;
	pDtoCli3		float(10,2)	,;
	pDtoCli4		float(10,2)	,;
	iDtoCli1		float(10,2)	,;
	iDtoCli2		float(10,2)	,;
	iDtoCli3		float(10,2)	,;
	iDtoCli4		float(10,2)	,;	
	pRecItem		float(10,2)	,;
	iRecItem		float(10,2)	,;		
	alicIVA			float(10,2)	,;
	impIVA			float(10,2)	,;
	impNeto			float(10,2)	,;	
	totNeto			float(10,2)	,;
	subTotal		float(10,2)	,;
	prArtic			float(10,2)	,;
	esOferta		l,;
	pRecVta			float(10,2) ,;
	iRecVta			float(10,2) ,;
	uniDesp			float(10,2) ,;
	cantPack		float(10,2) ,;
	uniMed			varchar(3))

&& Ese cursor es para mostrar en la grilla el detalle sin importar
&& de que partida se saque
CREATE CURSOR cur_Deta_View (	;
	idDetalle		int			,;
	idArticulo		int 		,;
	codArt			C(20)		,;
	descripcio		C(60)		,;
	cantidad		float(10, 2),;
	prVta			float(10, 2),;
	pDtoVta1		float(10, 2),;
	pDtoVta2		float(10, 2),;
	pDtoVta3		float(10, 2),;
	pDtoVta4		float(10, 2),;
	iDtoVta1		float(10, 2),;
	iDtoVta2		float(10, 2),;
	iDtoVta3		float(10, 2),;
	iDtoVta4		float(10, 2),;
	pDtoCli1		float(10, 2),;
	pDtoCli2		float(10, 2),;
	pDtoCli3		float(10, 2),;
	pDtoCli4		float(10, 2),;
	iDtoCli1		float(10, 2),;
	iDtoCli2		float(10, 2),;
	iDtoCli3		float(10, 2),;
	iDtoCli4		float(10, 2),;
	pRecItem		float(10, 2),;
	iRecItem		float(10, 2),;			
	alicIVA			float(10, 2),;
	impIVA			float(10, 2),;
	impNeto			float(10, 2),;	
	totNeto			float(10, 2),;
	subTotal		float(10, 2),;
	stkDisp			float(10, 2),;
	prArtic			float(10, 2),;
	esOferta		l,;
	pRecVta			float(10, 2),;
	iRecVta			float(10, 2),;
	uniDesp			float(10, 2),;
	cantPack		float(10, 2),;
	uniMed			varchar(3),;
	apli_PRG		l)	

CREATE CURSOR cur_Subtotal(	;
	impNeto			float(10, 2),;
	impFinal		float(10, 2),;
	porIVA21		float(10, 2),;
	impIVA21		float(10, 4),;
	porIVA105		float(10, 2),;
	impIVA105		float(10, 4),;
	porDesc1		float(10, 2),;
	porDesc2		float(10, 2),;
	porDesc3		float(10, 2),;
	porDesc4		float(10, 2),;
	impDesc1		float(10, 2),;
	impDesc2		float(10, 2),;
	impDesc3		float(10, 2),;
	impDesc4		float(10, 2),;
	totFact			float(10, 2),;
	porRec			float(10, 2),;
	impRec			float(10, 2),;
	porIIBB			float(10, 2),;
	impIIBB			float(10, 2))
	
&& Agrego este cursor por partida
CREATE CURSOR cur_DetPart (	;
	idArticulo		int,;
	nroPart			varchar(30),;
	cantidad		float(10, 2))
	
&& El siguiente cursor es para mostrar los stocks insuficiente
CREATE CURSOR cur_StkInsu (	;
	idArticulo		int,;
	codArt			varchar(20),;
	descripcio		varchar(60),;
	stock_disp		float(10, 2),;
	cantFC			float(10, 2))
	
&& Este cursor va a contener los pedidos pendientes de facturar para cuando
&& se quiera levantar los mismos a partir de una factura.
CREATE CURSOR cur_Cbtes (	;
	sel			L,;
	idVentasC	int,;
	fecEmision	D,;
	numCbte		varchar(20),;
	idCliente	int,;
	razSoc		varchar(60) NULL,;
	totFact		float(10,2),;
	idTipoDoc	int NULL,;
	nroDoc	varchar(20) NULL) 

SELECT cur_Cbtes
INDEX ON idVentasC TAG idVentasC ASCENDING
INDEX ON fecEmision TAG fecEmision ASCENDING ADDITIVE
INDEX ON numCbte TAG numCbte ASCENDING ADDITIVE
INDEX ON idCliente TAG idCliente ASCENDING ADDITIVE
INDEX ON razSoc TAG razSoc ASCENDING ADDITIVE
INDEX ON totFact TAG totFact ASCENDING ADDITIVE

SET ORDER TO TAG fecEmision ASCENDING

&& Agrego el cursor que voy a administrar los faltantes
CREATE CURSOR cur_faltantes (	;
	idArticulo	int,;
	idCliente	int,;
	codArt		varchar(20),;
	uniDesp		float(10, 2),;
	cantidad	float(10, 2))
	
&& El siguiente cursor que agrego es para dar de baja los faltantes
CREATE CURSOR cur_BajaFalt ( ;
	idFaltante int)
		
&& Si usa impresora fiscal, agrego estas líneas para que el formulario
&& tenga soporte a los eventos del control OCX que se inserto para el
&& manejo de impresoras fiscales
IF ALLTRIM(GetConfig("USA_FISCAL")) == "S" THEN
	SYS(2333, 0)
	_VFP.AutoYield = .F.
	
	RETURN
ENDIF


ENDPROC
PROCEDURE Init
LOCAL lnResp

DODEFAULT()

Thisform.mov_stock.circuito = "V"
Thisform.mov_stock.crear_cursor()

IF getConfig("PRIOSAL") == "ON" THEN
	Thisform.Contenido.chkCalcIVA.Visible = .T.
ELSE
	Thisform.Contenido.chkCalcIVA.Visible = .F.
ENDIF

IF ALLTRIM(Thisform.cbte) == "PTO" THEN
	Thisform.mov_stock.tipomov = "SAL"
ELSE 
	IF ALLTRIM(Thisform.cbte) == "NC" THEN
		Thisform.Contenido.btnCbteOrigen.Visible = .T.
		Thisform.contenido.txtdesc1.Enabled = .F.
	    Thisform.contenido.txtdesc2.Enabled = .F.
		Thisform.contenido.txtdesc3.Enabled = .F.
		Thisform.contenido.txtdesc4.Enabled = .F.
		Thisform.mov_stock.tipomov = "ENT"
	ELSE
		IF ALLTRIM(Thisform.cbte) == "FC" .OR. ALLTRIM(Thisform.cbte) == "PTO" THEN
			Thisform.Contenido.btnCbteOrigen.Visible = .T.
			Thisform.Contenido.btnCbteOrigen.Caption = "Leer Pedido"
			Thisform.mov_stock.tipomov = "SAL"
		ELSE
			IF ALLTRIM(Thisform.cbte) == "PED" THEN
				Thisform.Contenido.btnCbteOrigen.Visible = .T.
				Thisform.Contenido.btnCbteOrigen.Caption = "Bajar Pedido"
			ELSE
				Thisform.Contenido.btnCbteOrigen.Visible = .F.
			ENDIF
		ENDIF
	ENDIF
ENDIF

Thisform.saldo_fc = 0.00
Thisform.idorigen = 0

IF getGlobalCFG("STK_MODULE") THEN
	Thisform.Contenido.lblExistencia.Visible = .T.
	Thisform.Contenido.txtExistencia.Visible = .T.
ELSE
	Thisform.Contenido.lblExistencia.Visible = .F.
	Thisform.Contenido.txtExistencia.Visible = .F.
ENDIF

SELECT cur_Deta_View
thisform.contenido.grdDetalles.RecordSource = "cur_Deta_View"
thisform.contenido.grdDetalles.alias_name = "cur_Deta_View"
thisform.contenido.grdDetalles.list_controlsource = "idDetalle,codArt,descripcio,cantidad,prVta,pDtoVta1,pDtoVta2,pDtoVta3,pDtoVta4,totNeto,alicIVA,impIVA,subTotal"
thisform.contenido.grdDetalles.lista_ancho_cols = "40,150,200,70,70,50,50,50,50,50,50,50,58"
thisform.contenido.grdDetalles.titulos_cabeceras = "#,Código,Descripción,Cantidad,Pr. Vta.,Desc.1,Desc.2,Desc.3,Desc.4,Neto,I.V.A.,Imp.IVA,Total"
thisform.contenido.grdDetalles.generar_grid()
thisform.contenido.grdDetalles.Columns[4].ReadOnly = .F.

&& Seteo los inputmask de las columnas numericas que van desde la 4 hasta las 13
thisform.contenido.grdDetalles.Columns[4].inputMask = "999999999.99"
thisform.contenido.grdDetalles.Columns[5].inputMask = "999999999.99"
thisform.contenido.grdDetalles.Columns[6].inputMask = "999999999.99"
thisform.contenido.grdDetalles.Columns[7].inputMask = "999999999.99"
thisform.contenido.grdDetalles.Columns[8].inputMask = "999999999.99"
thisform.contenido.grdDetalles.Columns[9].inputMask = "999999999.99"
thisform.contenido.grdDetalles.Columns[10].inputMask = "999999999.99"
thisform.contenido.grdDetalles.Columns[11].inputMask = "999999999.99"
thisform.contenido.grdDetalles.Columns[12].inputMask = "999999999.99"
thisform.contenido.grdDetalles.Columns[13].inputMask = "999999999.99"

thisform.pedido_automatica = .F.
thisform.contenido.txtFecEmis.Value = DATE()
IF ALLTRIM(Thisform.cbte) == "PED" .OR. ALLTRIM(Thisform.cbte) == "PTO" THEN
	Thisform.Contenido.txtFecEmis.Enabled = .F.
ENDIF

ENDPROC


************************************************************
OBJETO: mov_stock
************************************************************
*** PROPIEDADES ***
Top = 528
Left = 780
Height = 17
Width = 38
Name = "mov_stock"

*** METODOS ***


************************************************************
OBJETO: faltantes
************************************************************
*** PROPIEDADES ***
Top = 528
Left = 720
Height = 17
Width = 31
Name = "faltantes"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta1
************************************************************
*** PROPIEDADES ***
Caption = "Cliente:"
Height = 15
Left = 9
Top = 20
Width = 69
TabIndex = 40
Name = "Clsetiqueta1"

*** METODOS ***


************************************************************
OBJETO: sel_Cliente
************************************************************
*** PROPIEDADES ***
Top = 13
Left = 111
Width = 530
Height = 25
TabIndex = 1
cfieldname = 
esnumerico = .T.
nombre_tabla = clientes
pkfield = idCliente
nombre_campo_codigo = idCliente
nombre_campo_desc = razSoc
msgerror = Debe ingresar el cliente
autocompletar_ceros = .F.
permitir_agregar_regs = .F.
nombre_alta_form = frmaltaartic
criterio_filtro = clientes.fecBaja IS NULL
Name = "sel_Cliente"
txtCodigo.Name = "txtCodigo"
txtDescripcion.Height = 21
txtDescripcion.Left = 106
txtDescripcion.Top = 2
txtDescripcion.Width = 423
txtDescripcion.Name = "txtDescripcion"

*** METODOS ***
PROCEDURE recuperar_datos
LOCAL lo_rsSitIVA, lo_rsCondPago, lo_rsLocalidad, lo_rsPcia, lo_rsIIBB, lcSql
LOCAL lo_rsTipoDoc, lnResp, lorsFalt

lo_rsSitIVA = CREATEOBJECT("odbc_result")
lo_rsCondPago = CREATEOBJECT("odbc_result")
lo_rsLocalidad = CREATEOBJECT("odbc_result")
lo_rsPcia = CREATEOBJECT("odbc_result")
lo_rsIIBB = CREATEOBJECT("odbc_result")
lo_rsTipoDoc = CREATEOBJECT("odbc_result")
loRsFalt = CREATEOBJECT("odbc_result")
lcSql = ""

IF Thisform.contenido.sel_Cliente.txtCodigo.Value == 0 THEN 
	Thisform.contenido.sel_Cliente.txtDescripcion.Value = ""
	RETURN .F.
ENDIF 

SELECT clientes
IF !clientes.habilitado THEN 
	MESSAGEBOX("Este cliente no está habilitado, por favor, verifique el estado del cliente", 0+48, Thisform.Caption)
	this.valcpoid = 0
	this.blanquear()
	this.txtcodigo.SetFocus()
	
	RETURN .F.
ENDIF 

IF ALLTRIM(thisform.cbte) == "FC" .OR. ALLTRIM(thisform.cbte) == "PED" THEN
	IF clientes.contrCM THEN
		thisform.calcular_saldo_dedudor()
		
		IF thisform.saldodeudor > clientes.credMax THEN
			MESSAGEBOX("El saldo deudor supera al crédito máximo otorgado", 0+48, Thisform.Caption)
			RETURN .F.
		ENDIF
	ENDIF
ENDIF

Thisform.contenido.txtDesc1.Value = clientes.desc1
Thisform.contenido.txtDesc2.Value = clientes.desc2
Thisform.contenido.txtDesc3.Value = clientes.desc3
Thisform.contenido.txtDesc4.Value = clientes.desc4
Thisform.cli_calle = clientes.direccion
Thisform.cli_cuit = clientes.nroCUIT
Thisform.cli_telefono = clientes.telefono
Thisform.cli_Id = clientes.idCliente
Thisform.contenido.txttelefono.Value = clientes.telefono
Thisform.contenido.txtcuit.Value = clientes.nrocuit
Thisform.envcbte = clientes.envcbte
Thisform.contenido.chkEnviarMail.Value = clientes.envcbte
Thisform.mailfc = ALLTRIM(clientes.mailFC)
Thisform.Contenido.txtMailFC.Value = ALLTRIM(clientes.mailFC)
Thisform.printcbte = clientes.printcbte

&& Levanto el codigo de tipo de documento
lcSql = "SELECT * FROM tipodoc WHERE idTipoDoc = " + ALLTRIM(STR(clientes.idTipoDoc))
lo_rsTipoDoc.ActiveConnection = goConn.ActiveConnection
lo_rsTipoDoc.Cursor_Name = "cur_tipodoc"
lo_rsTipoDoc.OpenQuery(lcSql)

SELECT cur_tipodoc
Thisform.cli_tipodoc = cur_tipodoc.tipodoc
Thisform.cli_idtipodoc = clientes.idTipoDoc

IF !(ALLTRIM(Thisform.cli_tipodoc) == "CUIT" .OR. ALLTRIM(Thisform.cli_tipodoc) == "CUIL") THEN
	This.Parent.txtCuit.InputMask = ""
ELSE
	This.Parent.txtCuit.InputMask = "XX-XXXXXXXX-XX"
ENDIF

lo_rsTipoDoc.close_query()

lcSql = "SELECT * FROM localidad WHERE idLocalid = " + ALLTRIM(STR(clientes.idLocalid))
lo_rsLocalidad.ActiveConnection = goConn.ActiveConnection
lo_rsLocalidad.Cursor_Name = "cur_Localid"
lo_rsLocalidad.OpenQuery(lcSql)

SELECT cur_Localid
Thisform.cli_localidad = cur_Localid.descripcio
Thisform.cli_codpostal = cur_Localid.codPostal

lcSql = "SELECT * FROM provincias WHERE idProvin = " + ALLTRIM(STR(cur_Localid.idProvin))
lo_rsPcia.ActiveConnection = goConn.ActiveConnection
lo_rsPcia.Cursor_Name = "cur_Pcia"
lo_rsPcia.OpenQuery(lcSql)

SELECT cur_Pcia
Thisform.cli_pcia = cur_Pcia.descripcio

lo_rsPcia.close_query()
lo_rsLocalidad.close_query()

lcSql = "SELECT * FROM sitiva WHERE idSitIVA = " + ALLTRIM(STR(clientes.idSitIVA))
lo_rsSitIVA.ActiveConnection = goConn.ActiveConnection
lo_rsSitIVA.Cursor_Name = "cur_SitIVA"
lo_rsSitIVA.OpenQuery(lcSql)

SELECT cur_SitIVA
Thisform.contenido.txtSitIVA.Value = cur_SitIVA.descripcio
Thisform.sitivacli = cur_SitIVA.idSitIVA
Thisform.CodIVAFiscal = cur_SitIVA.CodFiscal

lo_rsSitIVA.close_query()

lcSql = "SELECT * FROM condpagos WHERE idCondPago = " + ALLTRIM(STR(clientes.idCondPago))
lo_rsCondPago.ActiveConnection = goConn.ActiveConnection
lo_rsCondPago.Cursor_Name = "cur_CondPago"
lo_rsCondPago.OpenQuery(lcSql)

SELECT cur_CondPago
Thisform.contenido.sel_FormaPago.valcpoid = cur_CondPago.idCondPago
Thisform.contenido.sel_FormaPago.txtCodigo.Value = cur_CondPago.idCondPago
Thisform.contenido.sel_FormaPago.txtDescripcion.Value = cur_CondPago.Descripcio
Thisform.cp_cntdias = cur_CondPago.cntDias
Thisform.idCondPago = cur_CondPago.idCondPago

lo_rsCondPago.close_query()

IF ALLTRIM(Thisform.cbte) <> "PTO" THEN 
	lcSql = "SELECT * FROM padronib WHERE cuit = '" + ALLTRIM(STRTRAN(clientes.nrocuit,"-","")) + "'"
	lo_rsIIBB.ActiveConnection = goConn.ActiveConnection
	lo_rsIIBB.Cursor_Name = "cur_PadronIB"
	lo_rsIIBB.OpenQuery(lcSql)

	SELECT cur_PadronIB
	IF RECCOUNT("cur_PadronIB") > 0 THEN
		Thisform.contenido.txtPorIIBB.Value = cur_PadronIB.AlicuotaPer
	ELSE 
		Thisform.contenido.txtPorIIBB.Value = 0.00
	ENDIF 

	lo_rsIIBB.close_query()
ENDIF 

Thisform.contenido.txtPorRec.Value = IIF(ISNULL(clientes.recargo), 0.00, clientes.recargo)

IF ALLTRIM(thisform.cbte) != "NC" THEN 
	thisform.recalcular_todo()
ENDIF

IF ALLTRIM(thisform.cbte) == "FC" .OR. ALLTRIM(thisform.cbte) == "PED" THEN
	IF clientes.ctrMoro THEN
		thisform.mostrar_morosidad()
	ENDIF	
ENDIF

IF This.valcpoid = getglobalcfg("CLI_CF") THEN
	This.txtDescripcion.ReadOnly = .F.
	This.txtDescripcion.Enabled = .T.
	This.txtDescripcion.SetFocus()
	Thisform.contenido.txtPrMinorista.ReadOnly = .F.
	Thisform.contenido.txtPrMinorista.Enabled = .T.
	Thisform.contenido.txtCuit.Enabled = .T.		
	Thisform.contenido.txtCuit.ReadOnly = .F.
ELSE
	This.txtDescripcion.ReadOnly = .T.
	This.txtDescripcion.Enabled = .F.
	Thisform.contenido.txtPrMinorista.ReadOnly = .T.
	Thisform.contenido.txtPrMinorista.Enabled = .F.
	Thisform.contenido.txtCuit.Enabled = .F.
	Thisform.contenido.txtCuit.ReadOnly = .T.
	
	IF ALLTRIM(thisform.cbte) == "PED" THEN
		lcSql = "SELECT * "
		lcSql = lcSql + "FROM faltantes "
		lcSql = lcSql + "WHERE idCliente = " + ALLTRIM(STR(This.valcpoid)) + " "
		lcSql = lcSql + "	AND fecBaja IS NULL"
		
		loRsFalt.ActiveConnection = goConn.ActiveConnection
		loRsFalt.Cursor_Name = "cur_x"
		
		IF !loRsFalt.OpenQuery(lcSql) THEN
			MESSAGEBOX(loRsFalt.Error_Message, 0+48, Thisform.Caption)
		ELSE
			SELECT cur_x
			IF RECCOUNT("cur_x") > 0 THEN
				lnResp = MESSAGEBOX("Este cliente tiene faltantes de pedidos anteriores, ¿desea incorporarlos?", 4+32, Thisform.Caption)
				IF lnResp = 6 THEN
					Thisform.leer_faltantes()
				ENDIF
			ENDIF
		
			loRsFalt.Close_Query()
		ENDIF
	ENDIF
ENDIF
ENDPROC


************************************************************
OBJETO: Clsetiqueta2
************************************************************
*** PROPIEDADES ***
Caption = "Situación I.V.A:"
Height = 15
Left = 9
Top = 42
Width = 96
TabIndex = 42
Name = "Clsetiqueta2"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta3
************************************************************
*** PROPIEDADES ***
Caption = "Forma de Pago:"
Height = 15
Left = 10
Top = 65
Width = 96
TabIndex = 43
Name = "Clsetiqueta3"

*** METODOS ***


************************************************************
OBJETO: txtSitIVA
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 113
ReadOnly = .T.
TabIndex = 31
Top = 38
Width = 212
Name = "txtSitIVA"

*** METODOS ***


************************************************************
OBJETO: sel_FormaPago
************************************************************
*** PROPIEDADES ***
Top = 59
Left = 111
Width = 367
Height = 25
TabIndex = 3
nombre_campo_codigo = idCondPago
nombre_campo_desc = descripcio
nombre_tabla = condpagos
pkfield = idCondPago
esnumerico = .T.
autocompletar_ceros = .F.
Name = "sel_FormaPago"
txtCodigo.Name = "txtCodigo"
txtDescripcion.Height = 21
txtDescripcion.Left = 106
txtDescripcion.Top = 2
txtDescripcion.Width = 258
txtDescripcion.Name = "txtDescripcion"

*** METODOS ***
PROCEDURE recuperar_datos
SELECT condpagos
thisform.cp_cntdias = condpagos.cntDias
Thisform.idCondPago = condpagos.idCondPago
ENDPROC


************************************************************
OBJETO: Clslinea1
************************************************************
*** PROPIEDADES ***
Height = 0
Left = 8
Top = 113
Width = 978
Name = "Clslinea1"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta4
************************************************************
*** PROPIEDADES ***
Caption = "Artículo:"
Left = 9
Top = 121
TabIndex = 45
Name = "Clsetiqueta4"

*** METODOS ***


************************************************************
OBJETO: sel_Articulo
************************************************************
*** PROPIEDADES ***
Top = 115
Left = 112
Width = 564
Height = 25
TabIndex = 6
autocompletar_ceros = .F.
esnumerico = .F.
nombre_campo_codigo = codArt
nombre_campo_desc = descripcio
nombre_tabla = articulos
permitir_agregar_regs = .F.
pkfield = idArticulo
requerido = .F.
alternative_cols = prFinalMax,prFinalMin
anchos_cols = 400,70,70
title_cols = Descripción,Precio May, Precio Min
criterio_filtro = articulos.habilitado = 1 AND articulos.fecBaja IS NULL
Name = "sel_Articulo"
txtCodigo.Height = 21
txtCodigo.Left = 2
txtCodigo.Top = 2
txtCodigo.Width = 181
txtCodigo.Name = "txtCodigo"
txtDescripcion.Left = 185
txtDescripcion.Top = 2
txtDescripcion.Name = "txtDescripcion"

*** METODOS ***
PROCEDURE recuperar_datos
LOCAL lnPorDesc1, lnPorDesc2, lnPorDesc3, lnPorDesc4
LOCAL lnImpDesc1, lnImpDesc2, lnImpDesc3, lnImpDesc4
LOCAL lnPrVtaMax, lnPrVtaMin, lnImpOfert
LOCAL loResult, lcSql

lnPorDesc1 = Thisform.contenido.txtDesc1.Value
lnPorDesc2 = Thisform.contenido.txtDesc2.Value
lnPorDesc3 = Thisform.contenido.txtDesc3.Value
lnPorDesc4 = Thisform.contenido.txtDesc4.Value
lnImpDesc1 = 0.00
lnImpDesc2 = 0.00
lnImpDesc3 = 0.00
lnImpDesc4 = 0.00
lnPrVtaMax = 0.00
lnPrVtaMin = 0.00
lnImpOfert = 0.00
lcSql = ""
loResult = CREATEOBJECT("odbc_result")

SELECT articulos
IF !articulos.habilitado THEN
	MESSAGEBOX("Este artículo no se puede facturar ya que está inhabilitado, dirijase a Archivos / Artículos y " + ;
		"habilitelo para poder facturar o comuniquese con la persona responsable que haya deshabilitado el mismo.", 0+48, Thisform.Caption)
		
	this.txtCodigo.SetFocus()
	RETURN .F.
ENDIF

lcSql = "select * from unidmed where idUniMed = " + ALLTRIM(STR(articulos.idUniMed))

loResult.ActiveConnection = goConn.ActiveConnection
loResult.Cursor_Name = "cur_x"

IF !loResult.OpenQuery(lcSql) THEN
	MESSAGEBOX(loResult.Error_Message, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

SELECT cur_x
IF RECCOUNT("cur_x") > 0 THEN
	thisform.unimed = cur_x.codUM
ENDIF

loResult.close_query()

lnImpOfert = thisform.get_precio_oferta()

IF lnImpOfert = 0 THEN
	SELECT articulos
	lnPrVtaMax = articulos.prVentaMax
ELSE
	lnPrVtaMax = lnImpOfert
	thisform.pr_oferta = lnImpOfert
ENDIF

SELECT articulos
lnPrVtaMin = articulos.prVentaMin

thisform.pr_mayorista = lnPrVtaMax
thisform.pr_minorista = lnPrVtaMin

lnImpDesc1 = ROUND(lnPrVtaMax * (lnPorDesc1 / 100),2)
lnImpDesc2 = ROUND((lnPrVtaMax - lnImpDesc1) * (lnPorDesc2 / 100),2)
lnImpDesc3 = ROUND((lnPrVtaMax - lnImpDesc1 - lnImpDesc2) * (lnPorDesc3 / 100),2)
lnImpDesc4 = ROUND((lnPrVtaMax - lnImpDesc1 - lnImpDesc2 - lnImpDesc3) * (lnPorDesc4 /100),2)

lnPrVtaMax = lnPrVtaMax - lnImpDesc1 - lnImpDesc2 - lnImpDesc3 - lnImpDesc4
Thisform.contenido.txtPrMay.Value = lnPrVtaMax 

lnImpDesc1 = ROUND(lnPrVtaMin * (lnPorDesc1 / 100),2)
lnImpDesc2 = ROUND((lnPrVtaMin - lnImpDesc1) * (lnPorDesc2 / 100),2)
lnImpDesc3 = ROUND((lnPrVtaMin - lnImpDesc1 - lnImpDesc2) * (lnPorDesc3 / 100),2)
lnImpDesc4 = ROUND((lnPrVtaMin - lnImpDesc1 - lnImpDesc2 - lnImpDesc3) * (lnPorDesc4 /100),2)

lnPrVtaMin = lnPrVtaMin - lnImpDesc1 - lnImpDesc2 - lnImpDesc3 - lnImpDesc4
Thisform.contenido.txtPrMinorista.Value = lnPrVtaMin 

thisform.contenido.txtAlicIVA.Value = articulos.alicIVA

Thisform.Contenido.txtExistencia.Value = Thisform.mov_stock.get_exist_byart(Thisform.contenido.sel_Articulo.valcpoid, "")

* Agrego esto para el artículo "X"
IF RIGHT(ALLTRIM(This.txtCodigo.Value), 3) == "ARX" THEN
	This.txtDescripcion.Enabled = .T.
	This.txtDescripcion.ReadOnly = .F.
	This.Parent.txtPrMinorista.Enabled = .T.
	This.Parent.txtPrMinorista.ReadOnly = .F.
ENDIF

Thisform.calc_item_desc()



ENDPROC
PROCEDURE txtCodigo.LostFocus
LOCAL lcCodArt
LOCAL loResult, lcSql

lcCodArt = ""
lcSql = ""
loResult = CREATEOBJECT("odbc_result")

IF !(ALLTRIM(this.Value) == "") THEN
	lcSql = "select codArt, cantiDesp from codiart "
	lcSql = lcSql + "where codigos = '" + ALLTRIM(this.Value) + "' "
	lcSql = lcSql + "	and (circuito = 'V' or circuito = 'CV')"

	loResult.ActiveConnection = goConn.ActiveConnection
	loResult.Cursor_Name = "cur_x"
	
	IF !loResult.OpenQuery(lcSql) THEN
		MESSAGEBOX(loResult.Error_Message, 0+48, Thisform.Caption)
		RETURN .F.
	ENDIF

	SELECT cur_x
	IF RECCOUNT("cur_x") > 0 THEN
		GO TOP
		
		IF RECCOUNT("cur_x") = 1 THEN
			&& Paso por aca en caso que solo encuentre un registro puntual
			lcCodArt = thisform.leer_unid_desp(this.Value, "codigos")
			loResult.close_query()
			this.Value = lcCodArt
			DODEFAULT()
			
			RETURN .F.
		ELSE 
			&& En caso de que devuelva más de un registro, recupero el codigo de artículo
			&& para que haga la búsqueda normal
			lcCodArt = cur_x.codArt
			loResult.close_query()
			
			this.Value = lcCodArt
			DODEFAULT()	
			lcCodArt = thisform.leer_unid_desp(this.Value, "codigos")
		ENDIF
	ELSE
		&& Si no encuentra nada en codiart entonces sigue la busqueda
		&& estandar
		
		DODEFAULT()
		lcCodArt = thisform.leer_unid_desp(this.Value, "codArt")
	ENDIF
	
	IF USED("cur_x") THEN
		loResult.close_query()
	ENDIF

	IF ALLTRIM(lcCodArt) == "ERROR" THEN
		RETURN .F.
	ENDIF
ENDIF

RETURN .T.
ENDPROC


************************************************************
OBJETO: Clsetiqueta5
************************************************************
*** PROPIEDADES ***
Caption = "Cantidad:"
Height = 15
Left = 856
Top = 121
Width = 53
TabIndex = 48
Name = "Clsetiqueta5"

*** METODOS ***


************************************************************
OBJETO: txtCantidad
************************************************************
*** PROPIEDADES ***
Enabled = .T.
Height = 21
Left = 909
TabIndex = 8
Top = 117
Width = 75
isnumeric = .T.
Name = "txtCantidad"

*** METODOS ***
PROCEDURE LostFocus
DODEFAULT()
Thisform.calc_item_desc()

IF RIGHT(ALLTRIM(This.Parent.sel_Articulo.txtCodigo.Value), 3) == "ARX" THEN
	Thisform.contenido.txtPrMinorista.SetFocus()
ENDIF
ENDPROC
PROCEDURE KeyPress
LPARAMETERS nKeyCode, nShiftAltCtrl


ENDPROC
PROCEDURE Valid
LOCAL lnUnidVta

lnUnidVta = 0.00

lnUnidVta = VAL(this.Parent.cboUnidVta.Value)

IF lnUnidVta <> 0 THEN
	IF (this.Value % lnUnidVta) <> 0 THEN
		MESSAGEBOX("La cantidad debe ser múltiplo de " + ALLTRIM(STR(lnUnidVta, 10, 2)), 0+48, Thisform.Caption)
		RETURN .F.
	ELSE	
		this.Parent.txtCantPack.Value = ROUND(this.Value / lnUnidVta, 2)
	ENDIF
ENDIF

RETURN .T.
ENDPROC


************************************************************
OBJETO: btnAgregar
************************************************************
*** PROPIEDADES ***
Top = 189
Left = 904
Height = 38
Width = 42
TabIndex = 9
Name = "btnAgregar"

*** METODOS ***
PROCEDURE Click
IF thisform.agregar_item_viewer() THEN
	Thisform.contenido.sel_Articulo.blanquear()
	Thisform.contenido.txtprMay.Value = 0.00
	Thisform.contenido.txtPrMinorista.Value = 0.00
	Thisform.contenido.txtCantidad.Value = 0.00
	Thisform.contenido.txtPrNeto.Value = 0.00
	Thisform.contenido.txtSubTotal.Value = 0.00
	Thisform.contenido.txtAlicIVA.Value = 0.00
	Thisform.contenido.txtImpIVA.Value = 0.00
	Thisform.contenido.txtSTNeto.Value = 0.00
	Thisform.contenido.txtPorDesc1.Value = 0.00
	Thisform.contenido.txtPorDesc2.Value = 0.00
	Thisform.contenido.txtPorDesc3.Value = 0.00
	Thisform.contenido.txtPorDesc4.Value = 0.00
	Thisform.contenido.txtImpDescItem1.Value = 0.00
	Thisform.contenido.txtImpDescItem2.Value = 0.00
	Thisform.contenido.txtImpDescItem3.Value = 0.00
	Thisform.contenido.txtImpDescItem4.Value = 0.00
	Thisform.pr_mayorista = 0.00
	Thisform.pr_minorista = 0.00
	Thisform.contenido.txtCantPack.Value = 0.00
	Thisform.contenido.cboUnidVta.Clear()
	Thisform.unimed = ""
	Thisform.prarti_x = 0.00
	Thisform.contenido.txtPorRecItem.Value = 0.00

	Thisform.sumar_items()
	Thisform.calcular_ret_iibb()
	
	SELECT cur_Deta_View 
	GO BOTTOM
	Thisform.contenido.grdDetalles.Refresh()

	Thisform.contenido.sel_Articulo.txtDescripcion.Enabled = .F.
	Thisform.contenido.txtPrMinorista.Enabled = .F.
	Thisform.contenido.sel_Articulo.txtCodigo.SetFocus()
ENDIF
ENDPROC


************************************************************
OBJETO: grdDetalles
************************************************************
*** PROPIEDADES ***
Height = 190
Left = 6
TabIndex = 49
Top = 230
Width = 981
permitir_busqueda = .F.
permitir_ordenamiento = .F.
alias_name = 
list_controlsource = 
lista_ancho_cols = 
titulos_cabeceras = 
Name = "grdDetalles"
COLUMN1.Header1.Name = "Header1"
COLUMN1.Text1.Name = "Text1"
COLUMN1.Name = "COLUMN1"
COLUMN2.Header1.Name = "Header1"
COLUMN2.Text1.Name = "Text1"
COLUMN2.Name = "COLUMN2"
COLUMN3.Header1.Name = "Header1"
COLUMN3.Text1.Name = "Text1"
COLUMN3.Name = "COLUMN3"
COLUMN4.Header1.Name = "Header1"
COLUMN4.Text1.Name = "Text1"
COLUMN4.Name = "COLUMN4"
COLUMN5.Header1.Name = "Header1"
COLUMN5.Text1.Name = "Text1"
COLUMN5.Name = "COLUMN5"
COLUMN6.Header1.Name = "Header1"
COLUMN6.Text1.Name = "Text1"
COLUMN6.Name = "COLUMN6"
COLUMN7.Header1.Name = "Header1"
COLUMN7.Text1.Name = "Text1"
COLUMN7.Name = "COLUMN7"
COLUMN8.Header1.Name = "Header1"
COLUMN8.Text1.Name = "Text1"
COLUMN8.Name = "COLUMN8"
COLUMN9.Header1.Name = "Header1"
COLUMN9.Text1.Name = "Text1"
COLUMN9.Name = "COLUMN9"
COLUMN10.Header1.Name = "Header1"
COLUMN10.Text1.Name = "Text1"
COLUMN10.Name = "COLUMN10"
COLUMN11.Header1.Alignment = 2
COLUMN11.Header1.Name = "Header1"
COLUMN11.Text1.Name = "Text1"
COLUMN11.Name = "COLUMN11"
COLUMN12.Header1.Alignment = 2
COLUMN12.Header1.Name = "Header1"
COLUMN12.Text1.Name = "Text1"
COLUMN12.Name = "COLUMN12"
COLUMN13.Header1.Alignment = 2
COLUMN13.Header1.Name = "Header1"
COLUMN13.Text1.Name = "Text1"
COLUMN13.Name = "COLUMN13"
COLUMN14.Header1.Name = "Header1"
COLUMN14.Text1.Name = "Text1"
COLUMN14.Name = "COLUMN14"
COLUMN15.Header1.Name = "Header1"
COLUMN15.Text1.Name = "Text1"
COLUMN15.Name = "COLUMN15"
COLUMN16.Header1.Name = "Header1"
COLUMN16.Text1.Name = "Text1"
COLUMN16.Name = "COLUMN16"
COLUMN17.Header1.Name = "Header1"
COLUMN17.Text1.Name = "Text1"
COLUMN17.Name = "COLUMN17"
COLUMN18.Header1.Name = "Header1"
COLUMN18.Text1.Name = "Text1"
COLUMN18.Name = "COLUMN18"
COLUMN19.Header1.Name = "Header1"
COLUMN19.Text1.Name = "Text1"
COLUMN19.Name = "COLUMN19"
COLUMN20.Header1.Name = "Header1"
COLUMN20.Text1.Name = "Text1"
COLUMN20.Name = "COLUMN20"

*** METODOS ***
PROCEDURE COLUMN4.Text1.Valid
LOCAL lnCurrentRow

IF this.Value = 0 THEN
	RETURN .F.
ENDIF

SELECT cur_deta_view

IF (ALLTRIM(Thisform.cbte) != "COT") .AND. (ALLTRIM(Thisform.cbte) != "NC") THEN
	&& Valido el stock solo en caso que no sea artículo X
	IF RIGHT(ALLTRIM(cur_deta_view.codArt), 3) != "ARX" THEN
		IF getGlobalCFG("STK_MODULE") THEN
			IF Thisform.mov_stock.get_exist_byart(cur_deta_view.idArticulo, "") <= 0 THEN
				MESSAGEBOX("No hay stock disponible", 0+48, Thisform.Caption)	
				RETURN .F.
			ENDIF
			
			&& Valido si está o no cubierto al 100%
			IF this.Value > Thisform.mov_stock.get_exist_byart(cur_deta_view.idArticulo, "") THEN
				MESSAGEBOX("No hay stock suficiente para cubrir la cantidad ingresada", 0+48, Thisform.Caption)
				RETURN .F.
			ENDIF
		ENDIF
	ENDIF
ENDIF

SELECT cur_deta_view
lnCurrentRow = RECNO("cur_deta_view")

thisform.recalcular_todo()

SELECT cur_deta_view
GO lnCurrentRow

RETURN .T.
ENDPROC


************************************************************
OBJETO: btnGrabar
************************************************************
*** PROPIEDADES ***
Top = 514
Left = 893
Height = 44
Width = 45
TabIndex = 11
Name = "btnGrabar"

*** METODOS ***
PROCEDURE Click
IF !Thisform.ValidarCampos()
	RETURN .F.
ENDIF


&& Si es un presupuesto lo que se está creando entonces tengo que
&& validar que los datos existan en la base de cuenta 2.
IF ALLTRIM(Thisform.cbte) == "PTO" THEN
	IF !Thisform.validar_pto() THEN
		RETURN .F.
	ENDIF
ENDIF


IF !thisform.agregar_item() THEN
	MESSAGEBOX("Ha ocurrido un error mientras se estaba preparando los ítems para facturar", 0+48, thisform.Caption)
	RETURN .F.
ENDIF

SELECT cur_Detalle
GO TOP

&& Si los comprobantes son NC, FC, PTO o COT imprimo un cbte cada 25 items
&& sino hago
IF (ALLTRIM(Thisform.cbte) == "NC") .OR. (ALLTRIM(Thisform.cbte) == "FC") ;
		.OR. (ALLTRIM(Thisform.cbte) == "PTO") .OR. (ALLTRIM(Thisform.cbte) == "COT") THEN
	
	IF !Thisform.particionar_cbte()
		MESSAGEBOX("Error al intentar grabar el comprobante", 0+16, Thisform.Caption)
		RETURN .F.
	ENDIF 
ELSE 
	IF !thisform.grabar()
		MESSAGEBOX("Error al intentar grabar el comprobante", 0+16, Thisform.Caption)
		RETURN .F.
	ENDIF
	IF !thisform.usar_fiscal 
		Thisform.imprimir()
	ENDIF
	IF ALLTRIM(Thisform.cbte) == "PED" THEN
		IF Thisform.idpedcab <> 0 THEN
			Thisform.eliminar_ped_from_pedext()
			Thisform.idpedcab = 0
		ENDIF
	ENDIF
ENDIF


&& Grabo los faltantes que se hayan cargado si el sistema está configurado para
&& ingresar los faltantes desde la FC
IF getglobalcfg("INGFCFALT") THEN
	thisform.grabar_faltantes()
ENDIF

IF (ALLTRIM(Thisform.cbte) == "NC") .OR. (ALLTRIM(Thisform.cbte) == "FC") THEN
	Thisform.Contenido.btnCbteOrigen.Enabled = .T.
ENDIF

thisform.pedido_automatica = .F.

&& Si es presupuesto marco el pedido como procesado
&& para que no se vuelva a levantar desde el ingreso de presupuestos
IF ALLTRIM(Thisform.cbte) == "PTO" THEN
	Thisform.marcar_ped_proc()
ENDIF

&& Si hay transacciones para dar de baja, los doy de baja
IF ALLTRIM(Thisform.cbte) == "PED" THEN
	Thisform.baja_faltantes()
ENDIF

Thisform.Blanquear()

&& Inicializo nuevamente el tipo de movimiento de stock
IF ALLTRIM(Thisform.cbte) == "PTO" THEN
	Thisform.mov_stock.tipomov = "SAL"
ELSE 
	IF ALLTRIM(Thisform.cbte) == "NC" THEN
		Thisform.mov_stock.tipomov = "ENT"
	ELSE
		IF ALLTRIM(thisform.cbte) == "FC" THEN
			Thisform.mov_stock.tipomov = "SAL"
		ENDIF
	ENDIF
ENDIF 

RETURN .T.
ENDPROC


************************************************************
OBJETO: btnCancelar
************************************************************
*** PROPIEDADES ***
Top = 513
Left = 7
Height = 44
Width = 45
Cancel = .T.
TabIndex = 13
Name = "btnCancelar"

*** METODOS ***
PROCEDURE Click
Thisform.Blanquear()

&& Inicializo nuevamente el tipo de movimiento de stock
IF ALLTRIM(Thisform.cbte) == "PTO" THEN
	Thisform.mov_stock.tipomov = "SAL"
ELSE 
	IF ALLTRIM(Thisform.cbte) == "NC" THEN
		Thisform.mov_stock.tipomov = "ENT"
	ELSE
		IF ALLTRIM(thisform.cbte) == "FC" THEN
			Thisform.mov_stock.tipomov = "SAL"
		ENDIF
	ENDIF
ENDIF 
ENDPROC


************************************************************
OBJETO: Clscerrar1
************************************************************
*** PROPIEDADES ***
Top = 514
Left = 941
Height = 44
Width = 45
TabIndex = 12
Name = "Clscerrar1"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta10
************************************************************
*** PROPIEDADES ***
Caption = "Precio Mayorista:"
Height = 15
Left = 9
Top = 144
Width = 101
TabIndex = 70
Name = "Clsetiqueta10"

*** METODOS ***


************************************************************
OBJETO: txtPrMay
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 114
TabIndex = 29
Top = 140
Width = 100
isnumeric = .T.
Name = "txtPrMay"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta11
************************************************************
*** PROPIEDADES ***
Caption = "Precio Minorista:"
Height = 15
Left = 223
Top = 144
Width = 101
TabIndex = 72
Name = "Clsetiqueta11"

*** METODOS ***


************************************************************
OBJETO: txtPrMinorista
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 328
TabIndex = 28
Top = 140
Width = 104
isnumeric = .T.
Name = "txtPrMinorista"

*** METODOS ***
PROCEDURE LostFocus
LOCAL lnPorDesc1, lnPorDesc2, lnPorDesc3, lnPorDesc4
LOCAL lnImpDesc1, lnImpDesc2, lnImpDesc3, lnImpDesc4, lnPrVtaMin

lnPorDesc1 = Thisform.contenido.txtDesc1.Value * -1
lnPorDesc2 = Thisform.contenido.txtDesc2.Value * -1
lnPorDesc3 = Thisform.contenido.txtDesc3.Value * -1
lnPorDesc4 = Thisform.contenido.txtDesc4.Value * -1
lnImpDesc1 = 0.00
lnImpDesc2 = 0.00
lnImpDesc3 = 0.00
lnImpDesc4 = 0.00
lnPrVtaMin = Thisform.contenido.txtPrMinorista.Value

DODEFAULT()

IF RIGHT(ALLTRIM(This.Parent.sel_Articulo.txtCodigo.Value), 3) == "ARX" THEN
	thisform.prarti_x = this.Value
	
	&& Calculo el precio minorista con descuento
	lnImpDesc1 = lnPrVtaMin + (lnPrVtaMin * (lnPorDesc1 / 100))
	lnImpDesc2 = lnImpDesc1 + (lnImpDesc1 * (lnPorDesc2 / 100))
	lnImpDesc3 = lnImpDesc2 + (lnImpDesc2 * (lnPorDesc3 / 100))
	lnImpDesc4 = lnImpDesc3 + (lnImpDesc3 * (lnPorDesc4 / 100))
	Thisform.contenido.txtPrMinorista.Value = ROUND(lnImpDesc4, 2)
	thisform.contenido.txtAlicIVA.Value = articulos.alicIVA	
	
	Thisform.calc_item_desc()
	thisform.contenido.btnAgregar.SetFocus()
ENDIF
ENDPROC


************************************************************
OBJETO: Clsetiqueta12
************************************************************
*** PROPIEDADES ***
Caption = "Alícuota I.V.A.:"
Height = 15
Left = 207
Top = 190
Width = 96
TabIndex = 78
Name = "Clsetiqueta12"

*** METODOS ***


************************************************************
OBJETO: txtAlicIVA
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 290
TabIndex = 79
TabStop = .F.
Top = 186
Width = 66
isnumeric = .T.
Name = "txtAlicIVA"

*** METODOS ***


************************************************************
OBJETO: chkCalcIVA
************************************************************
*** PROPIEDADES ***
Top = 141
Left = 720
Height = 18
Width = 120
Alignment = 0
Caption = "Prioridad de Salida"
Value = 1
TabIndex = 33
Name = "chkCalcIVA"

*** METODOS ***
PROCEDURE Click
&&Thisform.calc_stitem()
ENDPROC


************************************************************
OBJETO: btnEliminar
************************************************************
*** PROPIEDADES ***
Top = 189
Left = 946
Height = 38
Width = 42
TabIndex = 10
Name = "btnEliminar"

*** METODOS ***
PROCEDURE Click
LOCAL lnResp

lnResp = MESSAGEBOX("Está seguro que desea eliminar este ítem?", 4+32, Thisform.Caption)

IF lnResp = 6 THEN
	IF getglobalcfg("INGFCFALT") THEN
		lnResp = MESSAGEBOX("Desea ingresar el artículo como faltante", 4+32,  Thisform.Caption)
		IF lnResp = 6 THEN
			SELECT cur_faltantes
			APPEND BLANK
			REPLACE cur_faltantes.idArticulo WITH cur_Deta_View.idArticulo
			REPLACE cur_faltantes.idCliente WITH Thisform.Contenido.sel_cliente.valcpoid ADDITIVE
			REPLACE cur_faltantes.codArt WITH cur_Deta_View.codArt ADDITIVE
			REPLACE cur_faltantes.uniDesp WITH cur_Deta_View.uniDesp ADDITIVE
			REPLACE cur_faltantes.cantidad WITH cur_Deta_View.cantidad ADDITIVE
		ENDIF
	ENDIF
	
	SELECT cur_Deta_View
	DELETE
	
	Thisform.Contenido.grdDetalles.Refresh()
	Thisform.sumar_items()
	Thisform.calcular_ret_iibb()	
	Thisform.recalcular_renglones()
ENDIF

ENDPROC


************************************************************
OBJETO: chkImprimeDup
************************************************************
*** PROPIEDADES ***
Top = 460
Left = 624
Height = 18
Width = 216
Alignment = 0
Caption = "Emitir comprobante por duplicado"
TabIndex = 86
Visible = .F.
Name = "chkImprimeDup"

*** METODOS ***


************************************************************
OBJETO: btnCbteOrigen
************************************************************
*** PROPIEDADES ***
Top = 13
Left = 828
Height = 24
Width = 130
Caption = "\<Cbte. Origen"
TabIndex = 30
Name = "btnCbteOrigen"

*** METODOS ***
PROCEDURE Click
IF ALLTRIM(Thisform.Cbte) != "PED" THEN
	Thisform.abrir_cbteorigen()
ELSE
	Thisform.importar_pedido()
	Thisform.pedido_automatica = .T.
ENDIF

Thisform.contenido.sel_Articulo.SetFocus()
ENDPROC


************************************************************
OBJETO: txtObserv
************************************************************
*** PROPIEDADES ***
Height = 35
Left = 6
TabIndex = 27
Top = 419
Width = 981
Name = "txtObserv"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta6
************************************************************
*** PROPIEDADES ***
Caption = "Neto:"
Height = 15
Left = 8
Top = 461
Width = 36
TabIndex = 50
Name = "Clsetiqueta6"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta7
************************************************************
*** PROPIEDADES ***
Caption = "I.V.A 21:"
Height = 15
Left = 316
Top = 461
Width = 57
TabIndex = 53
Name = "Clsetiqueta7"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta8
************************************************************
*** PROPIEDADES ***
Caption = "I.V.A 10,5:"
Height = 15
Left = 316
Top = 484
Width = 72
TabIndex = 55
Name = "Clsetiqueta8"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta9
************************************************************
*** PROPIEDADES ***
Caption = "Final:"
Height = 15
Left = 8
Top = 485
Visible = .F.
Width = 38
TabIndex = 56
Name = "Clsetiqueta9"

*** METODOS ***


************************************************************
OBJETO: txtTotNeto
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 44
ReadOnly = .T.
TabIndex = 58
TabStop = .F.
Top = 457
Width = 83
isnumeric = .T.
Name = "txtTotNeto"

*** METODOS ***


************************************************************
OBJETO: txtPorIVA21
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 387
ReadOnly = .T.
TabIndex = 61
TabStop = .F.
Top = 457
Width = 78
isnumeric = .T.
Name = "txtPorIVA21"

*** METODOS ***


************************************************************
OBJETO: txtPorIVA105
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 387
ReadOnly = .T.
TabIndex = 62
TabStop = .F.
Top = 480
Width = 78
isnumeric = .T.
Name = "txtPorIVA105"

*** METODOS ***


************************************************************
OBJETO: txtImpIVA21
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 469
ReadOnly = .T.
TabIndex = 64
TabStop = .F.
Top = 457
Width = 75
isnumeric = .T.
Name = "txtImpIVA21"

*** METODOS ***


************************************************************
OBJETO: txtImpIVA105
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 469
ReadOnly = .T.
TabIndex = 65
TabStop = .F.
Top = 480
Width = 75
isnumeric = .T.
Name = "txtImpIVA105"

*** METODOS ***


************************************************************
OBJETO: txtTotal
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 44
ReadOnly = .T.
TabIndex = 66
TabStop = .F.
Top = 480
Visible = .F.
Width = 83
isnumeric = .T.
Name = "txtTotal"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta14
************************************************************
*** PROPIEDADES ***
Caption = "Descuentos"
Height = 15
Left = 613
Top = 65
Width = 77
TabIndex = 81
Name = "Clsetiqueta14"

*** METODOS ***


************************************************************
OBJETO: txtDesc1
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 704
ReadOnly = .F.
TabIndex = 16
Top = 61
Width = 70
isnumeric = .T.
Name = "txtDesc1"

*** METODOS ***
PROCEDURE LostFocus
DODEFAULT()
Thisform.recalcular_todo()
ENDPROC


************************************************************
OBJETO: txtDesc2
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 775
ReadOnly = .F.
TabIndex = 17
Top = 61
Width = 70
isnumeric = .T.
Name = "txtDesc2"

*** METODOS ***
PROCEDURE LostFocus
DODEFAULT()
Thisform.recalcular_todo()

ENDPROC


************************************************************
OBJETO: txtDesc3
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 846
ReadOnly = .F.
TabIndex = 18
Top = 61
Width = 70
isnumeric = .T.
Name = "txtDesc3"

*** METODOS ***
PROCEDURE LostFocus
DODEFAULT()
Thisform.recalcular_todo()

ENDPROC


************************************************************
OBJETO: txtDesc4
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 917
ReadOnly = .F.
TabIndex = 19
Top = 61
Width = 70
isnumeric = .T.
Name = "txtDesc4"

*** METODOS ***
PROCEDURE LostFocus
DODEFAULT()
Thisform.recalcular_todo()

ENDPROC


************************************************************
OBJETO: txtImpDesc1
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 95
ReadOnly = .T.
TabIndex = 35
TabStop = .F.
Top = 537
Visible = .F.
Width = 72
isnumeric = .T.
Name = "txtImpDesc1"

*** METODOS ***


************************************************************
OBJETO: txtImpDesc2
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 170
ReadOnly = .T.
TabIndex = 36
TabStop = .F.
Top = 537
Visible = .F.
Width = 72
isnumeric = .T.
Name = "txtImpDesc2"

*** METODOS ***


************************************************************
OBJETO: txtImpDesc3
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 245
ReadOnly = .T.
TabIndex = 37
TabStop = .F.
Top = 537
Visible = .F.
Width = 72
isnumeric = .T.
Name = "txtImpDesc3"

*** METODOS ***


************************************************************
OBJETO: txtImpDesc4
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 320
ReadOnly = .T.
TabIndex = 38
TabStop = .F.
Top = 537
Visible = .F.
Width = 72
isnumeric = .T.
Name = "txtImpDesc4"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta15
************************************************************
*** PROPIEDADES ***
Caption = "%:"
Height = 15
Left = 684
Top = 65
Width = 15
TabIndex = 80
Name = "Clsetiqueta15"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta16
************************************************************
*** PROPIEDADES ***
Caption = "$:"
Height = 15
Left = 77
Top = 540
Visible = .F.
Width = 15
TabIndex = 83
Name = "Clsetiqueta16"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta17
************************************************************
*** PROPIEDADES ***
Caption = "Total:"
Height = 15
Left = 868
Top = 461
Width = 40
TabIndex = 57
Name = "Clsetiqueta17"

*** METODOS ***


************************************************************
OBJETO: txtTotFact
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 911
ReadOnly = .T.
TabIndex = 67
TabStop = .F.
Top = 457
Width = 76
isnumeric = .T.
Name = "txtTotFact"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta18
************************************************************
*** PROPIEDADES ***
Caption = "Perc. IIBB.:"
Height = 15
Left = 316
Top = 506
Width = 63
TabIndex = 54
Name = "Clsetiqueta18"

*** METODOS ***


************************************************************
OBJETO: txtPorIIBB
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 387
ReadOnly = .T.
TabIndex = 60
TabStop = .F.
Top = 503
Width = 78
isnumeric = .T.
Name = "txtPorIIBB"

*** METODOS ***


************************************************************
OBJETO: txtImpIIBB
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 469
ReadOnly = .T.
TabIndex = 63
TabStop = .F.
Top = 503
Width = 75
isnumeric = .T.
Name = "txtImpIIBB"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta19
************************************************************
*** PROPIEDADES ***
Caption = "Subtotal:"
Height = 15
Left = 148
Top = 461
Width = 59
TabIndex = 82
Name = "Clsetiqueta19"

*** METODOS ***


************************************************************
OBJETO: txtST
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 207
ReadOnly = .T.
TabIndex = 59
TabStop = .F.
Top = 457
Width = 83
isnumeric = .T.
Name = "txtST"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta20
************************************************************
*** PROPIEDADES ***
Caption = "Descuento Item:"
Height = 15
Left = 9
Top = 166
Width = 101
TabIndex = 69
Name = "Clsetiqueta20"

*** METODOS ***


************************************************************
OBJETO: txtPorDesc1
************************************************************
*** PROPIEDADES ***
Enabled = .T.
Height = 21
Left = 114
ReadOnly = .F.
TabIndex = 23
Top = 163
Width = 66
isnumeric = .T.
Name = "txtPorDesc1"

*** METODOS ***
PROCEDURE InteractiveChange
thisform.calc_item_desc()
ENDPROC


************************************************************
OBJETO: txtImpDescItem1
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 182
ReadOnly = .F.
TabIndex = 87
TabStop = .F.
Top = 163
Width = 66
isnumeric = .T.
Name = "txtImpDescItem1"

*** METODOS ***


************************************************************
OBJETO: txtPorDesc2
************************************************************
*** PROPIEDADES ***
Enabled = .T.
Height = 21
Left = 250
ReadOnly = .F.
TabIndex = 24
Top = 163
Width = 66
isnumeric = .T.
Name = "txtPorDesc2"

*** METODOS ***
PROCEDURE InteractiveChange
thisform.calc_item_desc()
ENDPROC


************************************************************
OBJETO: txtImpDescItem2
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 319
ReadOnly = .F.
TabIndex = 88
TabStop = .F.
Top = 163
Width = 66
isnumeric = .T.
Name = "txtImpDescItem2"

*** METODOS ***


************************************************************
OBJETO: txtPorDesc3
************************************************************
*** PROPIEDADES ***
Enabled = .T.
Height = 21
Left = 387
ReadOnly = .F.
TabIndex = 25
Top = 163
Width = 66
isnumeric = .T.
Name = "txtPorDesc3"

*** METODOS ***
PROCEDURE InteractiveChange
thisform.calc_item_desc()
ENDPROC


************************************************************
OBJETO: txtImpDescItem3
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 455
ReadOnly = .F.
TabIndex = 89
TabStop = .F.
Top = 163
Width = 66
isnumeric = .T.
Name = "txtImpDescItem3"

*** METODOS ***


************************************************************
OBJETO: txtPorDesc4
************************************************************
*** PROPIEDADES ***
Enabled = .T.
Height = 21
Left = 523
ReadOnly = .F.
TabIndex = 26
Top = 163
Width = 66
isnumeric = .T.
Name = "txtPorDesc4"

*** METODOS ***
PROCEDURE InteractiveChange
thisform.calc_item_desc()
ENDPROC


************************************************************
OBJETO: txtImpDescItem4
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 591
ReadOnly = .F.
TabIndex = 90
TabStop = .F.
Top = 163
Width = 66
isnumeric = .T.
Name = "txtImpDescItem4"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta21
************************************************************
*** PROPIEDADES ***
Caption = "Imp. I.V.A.:"
Height = 15
Left = 363
Top = 189
Width = 67
TabIndex = 77
Name = "Clsetiqueta21"

*** METODOS ***


************************************************************
OBJETO: txtImpIVA
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 430
ReadOnly = .F.
TabIndex = 91
TabStop = .F.
Top = 186
Width = 66
isnumeric = .T.
Name = "txtImpIVA"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta22
************************************************************
*** PROPIEDADES ***
Caption = "Subtot. c/ Desc.:"
Height = 15
Left = 9
Top = 190
Width = 101
TabIndex = 73
Name = "Clsetiqueta22"

*** METODOS ***


************************************************************
OBJETO: txtSTNeto
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 114
TabIndex = 75
TabStop = .F.
Top = 186
Width = 85
isnumeric = .T.
Name = "txtSTNeto"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta13
************************************************************
*** PROPIEDADES ***
FontSize = 9
Caption = "Tot. C/I.V.A.:"
Height = 15
Left = 505
Top = 190
Width = 100
TabIndex = 84
ForeColor = 255,0,0
Name = "Clsetiqueta13"

*** METODOS ***


************************************************************
OBJETO: txtSubTotal
************************************************************
*** PROPIEDADES ***
FontSize = 9
Enabled = .F.
Left = 579
TabIndex = 85
TabStop = .F.
Top = 186
ForeColor = 255,0,0
DisabledForeColor = 255,0,0
isnumeric = .T.
Name = "txtSubTotal"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta23
************************************************************
*** PROPIEDADES ***
Caption = "Precio Neto:"
Height = 15
Left = 811
Top = 166
Width = 69
TabIndex = 71
Name = "Clsetiqueta23"

*** METODOS ***


************************************************************
OBJETO: txtPrNeto
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 886
TabIndex = 74
TabStop = .F.
Top = 163
Width = 100
isnumeric = .T.
Name = "txtPrNeto"

*** METODOS ***


************************************************************
OBJETO: lblExistencia
************************************************************
*** PROPIEDADES ***
Caption = "Existencia:"
Height = 15
Left = 711
Top = 189
Width = 67
TabIndex = 76
Name = "lblExistencia"

*** METODOS ***


************************************************************
OBJETO: txtExistencia
************************************************************
*** PROPIEDADES ***
Enabled = .T.
Height = 21
Left = 778
ReadOnly = .T.
TabIndex = 92
TabStop = .F.
Top = 186
Width = 81
isnumeric = .T.
Name = "txtExistencia"

*** METODOS ***
PROCEDURE InteractiveChange
thisform.capc_item_desc()
ENDPROC


************************************************************
OBJETO: Clsetiqueta24
************************************************************
*** PROPIEDADES ***
Caption = "Recargo %:"
Height = 15
Left = 613
Top = 42
Width = 70
TabIndex = 52
Name = "Clsetiqueta24"

*** METODOS ***


************************************************************
OBJETO: txtPorRec
************************************************************
*** PROPIEDADES ***
Enabled = .T.
Height = 21
Left = 704
TabIndex = 15
Top = 38
Width = 70
isnumeric = .T.
Name = "txtPorRec"

*** METODOS ***
PROCEDURE Valid
IF this.Value < 0 THEN
	MESSAGEBOX("Solo se puede cargar recargos no descuentos", 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

RETURN .T.
ENDPROC
PROCEDURE LostFocus
DODEFAULT()
thisform.recalcular_todo()

Thisform.contenido.sel_Articulo.txtCodigo.SetFocus()
ENDPROC


************************************************************
OBJETO: txtImpRec
************************************************************
*** PROPIEDADES ***
Enabled = .T.
Height = 21
Left = 775
ReadOnly = .T.
TabIndex = 93
TabStop = .F.
Top = 38
Visible = .T.
Width = 70
isnumeric = .T.
Name = "txtImpRec"

*** METODOS ***


************************************************************
OBJETO: txtRecItem
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 408
ReadOnly = .T.
TabIndex = 39
TabStop = .F.
Top = 536
Visible = .F.
Width = 72
isnumeric = .T.
Name = "txtRecItem"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta25
************************************************************
*** PROPIEDADES ***
Caption = "Teléfono:"
Height = 15
Left = 333
Top = 42
Width = 63
TabIndex = 41
Name = "Clsetiqueta25"

*** METODOS ***


************************************************************
OBJETO: txtTelefono
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 389
ReadOnly = .T.
TabIndex = 32
Top = 38
Width = 202
Name = "txtTelefono"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta26
************************************************************
*** PROPIEDADES ***
Caption = "Nro. Doc.:"
Height = 15
Left = 649
Top = 20
Width = 51
TabIndex = 21
Name = "Clsetiqueta26"

*** METODOS ***


************************************************************
OBJETO: txtcuit
************************************************************
*** PROPIEDADES ***
Format = "R"
Height = 21
InputMask = "XX-XXXXXXXX-XX"
Left = 704
ReadOnly = .T.
TabIndex = 2
Top = 15
Width = 120
Name = "txtcuit"

*** METODOS ***
PROCEDURE LostFocus
thisform.cli_cuit = this.Value 
ENDPROC


************************************************************
OBJETO: Clsetiqueta27
************************************************************
*** PROPIEDADES ***
Caption = "Unid. Vta.:"
Height = 15
Left = 674
Top = 121
Width = 60
TabIndex = 46
Name = "Clsetiqueta27"

*** METODOS ***


************************************************************
OBJETO: cboUnidVta
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 732
TabIndex = 7
Top = 117
Width = 59
Name = "cboUnidVta"

*** METODOS ***
PROCEDURE InteractiveChange
LOCAL lnUnidVta

lnUnidVta = 0.00

lnUnidVta = VAL(this.Parent.cboUnidVta.Value)

this.Parent.txtCantidad.Value = ROUND(lnUnidVta * this.Parent.txtCantPack.Value, 2)
ENDPROC


************************************************************
OBJETO: txtCantPack
************************************************************
*** PROPIEDADES ***
Enabled = .F.
Height = 21
Left = 794
TabIndex = 22
Top = 117
Width = 57
isnumeric = .T.
Name = "txtCantPack"

*** METODOS ***
PROCEDURE KeyPress
LPARAMETERS nKeyCode, nShiftAltCtrl


ENDPROC


************************************************************
OBJETO: Clsetiqueta28
************************************************************
*** PROPIEDADES ***
Caption = "OC:"
Height = 15
Left = 489
Top = 66
Width = 34
TabIndex = 51
Name = "Clsetiqueta28"

*** METODOS ***


************************************************************
OBJETO: txtOC
************************************************************
*** PROPIEDADES ***
Enabled = .T.
Height = 21
Left = 516
TabIndex = 34
Top = 61
Width = 75
isinteger = .T.
Name = "txtOC"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta29
************************************************************
*** PROPIEDADES ***
Caption = "Rec. Item (%):"
Height = 15
Left = 661
Top = 167
Width = 79
TabIndex = 68
Name = "Clsetiqueta29"

*** METODOS ***


************************************************************
OBJETO: txtPorRecItem
************************************************************
*** PROPIEDADES ***
Enabled = .T.
Height = 21
Left = 744
ReadOnly = .F.
TabIndex = 20
Top = 163
Width = 63
isnumeric = .T.
Name = "txtPorRecItem"

*** METODOS ***
PROCEDURE InteractiveChange
thisform.calc_item_desc()
ENDPROC


************************************************************
OBJETO: Clsetiqueta30
************************************************************
*** PROPIEDADES ***
Caption = "Fecha Emisión:"
Height = 15
Left = 10
Top = 87
Width = 96
TabIndex = 44
Name = "Clsetiqueta30"

*** METODOS ***


************************************************************
OBJETO: txtFecEmis
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 113
TabIndex = 4
Top = 84
Width = 128
isdatetime = .T.
Name = "txtFecEmis"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta31
************************************************************
*** PROPIEDADES ***
Caption = "Enviar mail a:"
Height = 15
Left = 245
Top = 88
Width = 77
TabIndex = 47
Name = "Clsetiqueta31"

*** METODOS ***


************************************************************
OBJETO: txtMailFC
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 321
TabIndex = 5
Top = 84
Width = 287
Name = "txtMailFC"

*** METODOS ***


************************************************************
OBJETO: chkEnviarMail
************************************************************
*** PROPIEDADES ***
Top = 86
Left = 629
Height = 18
Width = 214
Alignment = 0
Caption = "Enviar este comprobante por mail."
TabIndex = 14
Name = "chkEnviarMail"

*** METODOS ***


************************************************************
OBJETO: clsformcbtes_sf
************************************************************
*** PROPIEDADES ***
Arial, 0, 9, 5, 15, 12, 32, 3, 0
Arial, 1, 8, 5, 14, 11, 29, 3, 0
Arial, 1, 9, 6, 15, 12, 32, 3, 0

*** METODOS ***


************************************************************
OBJETO: cls_pedido_online
************************************************************
*** PROPIEDADES ***
BorderStyle = 3
Height = 514
Width = 323
DoCreate = .T.
Caption = "Descarga de pedidos SISCLI"
MaxButton = .T.
MinButton = .T.
WindowType = 0
Dockable = 1
siscli_connection = 
siscli_cnnstr = 
Name = "cls_pedido_online"

*** METODOS ***
PROCEDURE connect_to_cloud
Thisform.siscli_connection.ConnectionString = thisform.siscli_cnnstr
IF !Thisform.siscli_connection.Open() THEN
	MESSAGEBOX(Thisform.siscli_connection.ErrorMessage, 0+16, Thisform.Caption)
	RETURN .F.
ENDIF
RETURN .T.
ENDPROC
PROCEDURE disconnect_from_cloud
thisform.siscli_connection.close()
ENDPROC
PROCEDURE descargar
LOCAL loRes
LOCAL lcSql
LOCAL lnResult

loRes = CREATEOBJECT("odbc_result")

goConn.BeginTransaction()

Thisform.connect_to_cloud()
SELECT cur_cabped
GO TOP
DO WHILE !EOF("cur_cabped")
	lcSql = "CALL peddet_getByCab (?idPedCab)"
	lcSql = loRes.AddParameter(lcSql, "idPedCab", ALLTRIM(STR(cur_cabped.idPedCab)), .f., .f.)
	loRes.ActiveConnection = Thisform.siscli_connection.ActiveConnection
	loRes.Cursor_Name = "cur_detalle"
	loRes.OpenQuery(lcSql)
	
	SELECT cur_detalle
	GO TOP
	DO WHILE !EOF("cur_detalle")
		Thisform.insert_to_pedext()
		SELECT cur_detalle
		SKIP
	ENDDO
	
	IF !Thisform.marcar_procesado() THEN
		Thisform.Disconnect_from_cloud()
		RETURN .F.
	ENDIF	
	
	loRes.Close_Query()
	SELECT  cur_cabped
	SKIP
ENDDO
goConn.Commit()
Thisform.Disconnect_from_cloud()
RETURN .T.
ENDPROC
PROCEDURE obtener_pedidos
LOCAL loRes
LOCAL lcSql

thisform.connect_to_cloud()
lcSql = "CALL pedcab_getPendientes()"
loRes = CREATEOBJECT("odbc_result")
loRes.ActiveConnection = Thisform.siscli_connection.ActiveConnection
loRes.Cursor_Name = "cur_x"
loRes.OpenQuery(lcSql)
SELECT cur_cabped
ZAP
APPEND FROM DBF("cur_x")
loRes.Close_Query()
thisform.disconnect_from_cloud()
SELECT cur_cabped
GO TOP


ENDPROC
PROCEDURE marcar_procesado
LOCAL loCmd

loCmd = CREATEOBJECT("odbc_command")
loCmd.ActiveConnection = this.siscli_connection.ActiveConnection
loCmd.CommandText = "CALL pedcab_marcarProcesado (?idPedCab)"
loCmd.AddParameter("idPedCab", ALLTRIM(STR(cur_cabped.idPedCab)), .f., .f.)
IF !loCmd.Execute() THEN
	RETURN .F.
ENDIF
RETURN .T.
ENDPROC
PROCEDURE listar_bajados
LOCAL loRes
LOCAL lcSql

lcSql = "CALL pedext_getDescargados()"
loRes = CREATEOBJECT("odbc_result")
loRes.ActiveConnection = goConn.ActiveConnection
loRes.Cursor_Name = "cur_x"
loRes.OpenQuery(lcSql)
SELECT cur_bajados
ZAP
APPEND FROM DBF("cur_x")
loRes.Close_Query()
SELECT cur_bajados
GO TOP
ENDPROC
PROCEDURE insert_to_pedext
LOCAL loCmd

loCmd = CREATEOBJECT("odbc_command")
loCmd.CommandText = "CALL pedext_insert ( " ;
	+ "?idPedCab, ?idCliente, ?idArticulo, ?fecEmis, " ;
	+ "?codArt, ?cantidad, ?observ)"
loCmd.AddParameter("idPedCab", ALLTRIM(STR(cur_detalle.idPedCab)), .f., .f.)
loCmd.AddParameter("idCliente", ALLTRIM(STR(cur_cabped.idCliente)), .f., .f.)
loCmd.AddParameter("idArticulo", ALLTRIM(STR(cur_detalle.idArticulo)), .f., .f.)
loCmd.AddParameter("fecEmis", cur_cabped.fecEmis, .f., .t.)
loCmd.AddParameter("codArt", ALLTRIM(cur_detalle.codArt), .t., .f.)
loCmd.AddParameter("cantidad", ALLTRIM(STR(cur_detalle.cantidad, 10, 2)), .f., .f.)
loCmd.AddParameter("observ", ALLTRIM(cur_cabped.observ), .t., .f.)

loCmd.ActiveConnection = goConn.ActiveConnection
IF (!loCmd.Execute()) THEN
	goConn.Rollback()
	Thisform.disconnect_from_cloud()
	RETURN .F.
ENDIF
RETURN .T.
ENDPROC
PROCEDURE Load
DODEFAULT()

CREATE CURSOR cur_cabped ( ;
	idPedCab int,;
	idCliente int,;
	fecEmis D,;
	observ M null,;
	estado varchar(1),;
	procesado L,;
	razSoc varchar(60))

CREATE CURSOR cur_bajados ( ;
	idPedCab int,;
	idCliente int,;
	fecEmis D,;
	razSoc varchar(60))
	
Thisform.Dock(2)
ENDPROC
PROCEDURE Init
thisform.siscli_connection = CREATEOBJECT("odbc_connect")
thisform.siscli_cnnstr = getconfig("SCWCONN")

SELECT cur_cabped
Thisform.grdPedidos.RecordSource = "cur_cabped"
Thisform.grdPedidos.alias_name = "cur_pedcab"
Thisform.grdPedidos.list_controlsource = "fecEmis,idCliente,razSoc"
Thisform.grdPedidos.Lista_ancho_cols = "70,70,120"
Thisform.grdPedidos.titulos_cabeceras = "Fecha,Cliente,Razón Social"
Thisform.grdPedidos.generar_grid()
Thisform.obtener_pedidos()
THisform.grdPedidos.Refresh()

SELECT cur_bajados
Thisform.grdBajados.RecordSource = "cur_bajados"
Thisform.grdBajados.Alias_name = "cur_bajados"
Thisform.grdBajados.list_controlsource = "fecEmis,idCliente,razSoc"
Thisform.grdBajados.lista_ancho_cols = "70,70,120"
Thisform.grdBajados.titulos_cabeceras = "Fecha,Cliente,Razón Social"
Thisform.grdBajados.generar_grid()
Thisform.listar_bajados()
Thisform.grdBajados.Refresh()

ENDPROC


************************************************************
OBJETO: grdPedidos
************************************************************
*** PROPIEDADES ***
Anchor = 11
Height = 207
Left = 4
TabIndex = 1
Top = 22
Width = 312
Name = "grdPedidos"
COLUMN1.HEADER1.Name = "HEADER1"
COLUMN1.TEXT1.Name = "TEXT1"
COLUMN1.Name = "COLUMN1"
COLUMN2.HEADER1.Name = "HEADER1"
COLUMN2.TEXT1.Name = "TEXT1"
COLUMN2.Name = "COLUMN2"
COLUMN3.HEADER1.Name = "HEADER1"
COLUMN3.TEXT1.Name = "TEXT1"
COLUMN3.Name = "COLUMN3"
COLUMN4.HEADER1.Name = "HEADER1"
COLUMN4.TEXT1.Name = "TEXT1"
COLUMN4.Name = "COLUMN4"
COLUMN5.HEADER1.Name = "HEADER1"
COLUMN5.TEXT1.Name = "TEXT1"
COLUMN5.Name = "COLUMN5"
COLUMN6.HEADER1.Name = "HEADER1"
COLUMN6.TEXT1.Name = "TEXT1"
COLUMN6.Name = "COLUMN6"
COLUMN7.HEADER1.Name = "HEADER1"
COLUMN7.TEXT1.Name = "TEXT1"
COLUMN7.Name = "COLUMN7"
COLUMN8.HEADER1.Name = "HEADER1"
COLUMN8.TEXT1.Name = "TEXT1"
COLUMN8.Name = "COLUMN8"
COLUMN9.HEADER1.Name = "HEADER1"
COLUMN9.TEXT1.Name = "TEXT1"
COLUMN9.Name = "COLUMN9"
COLUMN10.HEADER1.Name = "HEADER1"
COLUMN10.TEXT1.Name = "TEXT1"
COLUMN10.Name = "COLUMN10"
COLUMN11.HEADER1.Name = "HEADER1"
COLUMN11.TEXT1.Name = "TEXT1"
COLUMN11.Name = "COLUMN11"
COLUMN12.HEADER1.Name = "HEADER1"
COLUMN12.TEXT1.Name = "TEXT1"
COLUMN12.Name = "COLUMN12"
COLUMN13.HEADER1.Name = "HEADER1"
COLUMN13.TEXT1.Name = "TEXT1"
COLUMN13.Name = "COLUMN13"
COLUMN14.HEADER1.Name = "HEADER1"
COLUMN14.TEXT1.Name = "TEXT1"
COLUMN14.Name = "COLUMN14"
COLUMN15.HEADER1.Name = "HEADER1"
COLUMN15.TEXT1.Name = "TEXT1"
COLUMN15.Name = "COLUMN15"
COLUMN16.HEADER1.Name = "HEADER1"
COLUMN16.TEXT1.Name = "TEXT1"
COLUMN16.Name = "COLUMN16"
COLUMN17.HEADER1.Name = "HEADER1"
COLUMN17.TEXT1.Name = "TEXT1"
COLUMN17.Name = "COLUMN17"
COLUMN18.HEADER1.Name = "HEADER1"
COLUMN18.TEXT1.Name = "TEXT1"
COLUMN18.Name = "COLUMN18"
COLUMN19.HEADER1.Name = "HEADER1"
COLUMN19.TEXT1.Name = "TEXT1"
COLUMN19.Name = "COLUMN19"
COLUMN20.HEADER1.Name = "HEADER1"
COLUMN20.TEXT1.Name = "TEXT1"
COLUMN20.Name = "COLUMN20"

*** METODOS ***


************************************************************
OBJETO: btnDescargar
************************************************************
*** PROPIEDADES ***
Top = 464
Left = 224
Anchor = 12
Picture = ..\imagen\download.ico
TabIndex = 2
ToolTipText = "Descargar pedidos"
Name = "btnDescargar"

*** METODOS ***
PROCEDURE Click
WAIT WINDOW "Descargando pedidos, espere por favor..." NOWAIT
IF thisform.descargar() THEN
	MESSAGEBOX("El pedido se descargó satisfactoriamente", 0+64, Thisform.Caption)
	Thisform.obtener_pedidos()
	Thisform.grdPedidos.Refresh()
	Thisform.listar_bajados()
	Thisform.grdBajados.Refresh()
ELSE
	MESSAGEBOX("Ha ocurrido un error durante la descarga de los pedidos", 0+48, Thisform.Caption)
ENDIF
ENDPROC


************************************************************
OBJETO: btnCerrar
************************************************************
*** PROPIEDADES ***
Top = 464
Left = 272
Anchor = 12
TabIndex = 3
Name = "btnCerrar"

*** METODOS ***


************************************************************
OBJETO: btnRefrescar
************************************************************
*** PROPIEDADES ***
Top = 464
Left = 143
Anchor = 12
TabIndex = 4
Name = "btnRefrescar"

*** METODOS ***
PROCEDURE Click
Thisform.obtener_pedidos()
Thisform.grdPedidos.Refresh()
Thisform.listar_bajados()
Thisform.grdBajados.Refresh()
ENDPROC


************************************************************
OBJETO: grdBajados
************************************************************
*** PROPIEDADES ***
Anchor = 15
Height = 208
Left = 4
TabIndex = 5
Top = 252
Width = 312
Name = "grdBajados"
COLUMN1.HEADER1.Name = "HEADER1"
COLUMN1.TEXT1.Name = "TEXT1"
COLUMN1.Name = "COLUMN1"
COLUMN2.HEADER1.Name = "HEADER1"
COLUMN2.TEXT1.Name = "TEXT1"
COLUMN2.Name = "COLUMN2"
COLUMN3.HEADER1.Name = "HEADER1"
COLUMN3.TEXT1.Name = "TEXT1"
COLUMN3.Name = "COLUMN3"
COLUMN4.HEADER1.Name = "HEADER1"
COLUMN4.TEXT1.Name = "TEXT1"
COLUMN4.Name = "COLUMN4"
COLUMN5.HEADER1.Name = "HEADER1"
COLUMN5.TEXT1.Name = "TEXT1"
COLUMN5.Name = "COLUMN5"
COLUMN6.HEADER1.Name = "HEADER1"
COLUMN6.TEXT1.Name = "TEXT1"
COLUMN6.Name = "COLUMN6"
COLUMN7.HEADER1.Name = "HEADER1"
COLUMN7.TEXT1.Name = "TEXT1"
COLUMN7.Name = "COLUMN7"
COLUMN8.HEADER1.Name = "HEADER1"
COLUMN8.TEXT1.Name = "TEXT1"
COLUMN8.Name = "COLUMN8"
COLUMN9.HEADER1.Name = "HEADER1"
COLUMN9.TEXT1.Name = "TEXT1"
COLUMN9.Name = "COLUMN9"
COLUMN10.HEADER1.Name = "HEADER1"
COLUMN10.TEXT1.Name = "TEXT1"
COLUMN10.Name = "COLUMN10"
COLUMN11.HEADER1.Name = "HEADER1"
COLUMN11.TEXT1.Name = "TEXT1"
COLUMN11.Name = "COLUMN11"
COLUMN12.HEADER1.Name = "HEADER1"
COLUMN12.TEXT1.Name = "TEXT1"
COLUMN12.Name = "COLUMN12"
COLUMN13.HEADER1.Name = "HEADER1"
COLUMN13.TEXT1.Name = "TEXT1"
COLUMN13.Name = "COLUMN13"
COLUMN14.HEADER1.Name = "HEADER1"
COLUMN14.TEXT1.Name = "TEXT1"
COLUMN14.Name = "COLUMN14"
COLUMN15.HEADER1.Name = "HEADER1"
COLUMN15.TEXT1.Name = "TEXT1"
COLUMN15.Name = "COLUMN15"
COLUMN16.HEADER1.Name = "HEADER1"
COLUMN16.TEXT1.Name = "TEXT1"
COLUMN16.Name = "COLUMN16"
COLUMN17.HEADER1.Name = "HEADER1"
COLUMN17.TEXT1.Name = "TEXT1"
COLUMN17.Name = "COLUMN17"
COLUMN18.HEADER1.Name = "HEADER1"
COLUMN18.TEXT1.Name = "TEXT1"
COLUMN18.Name = "COLUMN18"
COLUMN19.HEADER1.Name = "HEADER1"
COLUMN19.TEXT1.Name = "TEXT1"
COLUMN19.Name = "COLUMN19"
COLUMN20.HEADER1.Name = "HEADER1"
COLUMN20.TEXT1.Name = "TEXT1"
COLUMN20.Name = "COLUMN20"

*** METODOS ***


************************************************************
OBJETO: CLSETIQUETA1
************************************************************
*** PROPIEDADES ***
Anchor = 3
Caption = "Pedidos descargados"
Height = 15
Left = 4
Top = 236
Width = 123
TabIndex = 6
Name = "CLSETIQUETA1"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta2
************************************************************
*** PROPIEDADES ***
Anchor = 3
Caption = "Pedidos pendientes de descargar"
Height = 15
Left = 4
Top = 5
Width = 204
TabIndex = 7
Name = "Clsetiqueta2"

*** METODOS ***


************************************************************
OBJETO: btnActualizarWeb
************************************************************
*** PROPIEDADES ***
Top = 464
Left = 8
Anchor = 6
Picture = ..\imagen\iconos bajados\flecha-hacia-arriba-icono-6320.ico
TabIndex = 8
Name = "btnActualizarWeb"

*** METODOS ***
PROCEDURE Click
RUN /N "siscli_upd\SISCLI_UpdaterApplication.exe"
ENDPROC


************************************************************
OBJETO: cls_pedido_online
************************************************************
*** PROPIEDADES ***
Arial, 0, 8, 5, 14, 11, 29, 3, 0
Arial, 1, 8, 5, 14, 11, 29, 3, 0
Arial, 0, 9, 5, 15, 12, 32, 3, 0

*** METODOS ***


