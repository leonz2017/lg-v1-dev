************************************************************
OBJETO: Dataenvironment
************************************************************
*** PROPIEDADES ***
Top = 0
Left = 0
Width = 0
Height = 0
DataSource = .NULL.
Name = "Dataenvironment"

*** METODOS ***


************************************************************
OBJETO: FRM_PTO_C2
************************************************************
*** PROPIEDADES ***
Height = 595
Width = 989
DoCreate = .T.
BorderStyle = 2
Caption = "Confección de Presupuestos"
cbte = PTO
Name = "FRM_PTO_C2"
contenido.Clsetiqueta1.Name = "Clsetiqueta1"
contenido.sel_Cliente.txtCodigo.Name = "txtCodigo"
contenido.sel_Cliente.txtDescripcion.Name = "txtDescripcion"
contenido.sel_Cliente.Name = "sel_Cliente"
contenido.Clsetiqueta2.Name = "Clsetiqueta2"
contenido.Clsetiqueta3.Name = "Clsetiqueta3"
contenido.txtSitIVA.Name = "txtSitIVA"
contenido.sel_FormaPago.txtCodigo.Name = "txtCodigo"
contenido.sel_FormaPago.txtDescripcion.Name = "txtDescripcion"
contenido.sel_FormaPago.Name = "sel_FormaPago"
contenido.Clslinea1.Name = "Clslinea1"
contenido.Clsetiqueta4.Name = "Clsetiqueta4"
contenido.sel_Articulo.txtCodigo.Name = "txtCodigo"
contenido.sel_Articulo.txtDescripcion.Name = "txtDescripcion"
contenido.sel_Articulo.Name = "sel_Articulo"
contenido.Clsetiqueta5.Name = "Clsetiqueta5"
contenido.txtCantidad.Name = "txtCantidad"
contenido.btnAgregar.Top = 212
contenido.btnAgregar.Left = 896
contenido.btnAgregar.Height = 39
contenido.btnAgregar.Width = 45
contenido.btnAgregar.Picture = ..\..\clases\imagen\iconos bajados\aceptar-comprobar-si-puede-icono-9389.ico
contenido.btnAgregar.Name = "btnAgregar"
contenido.grdDetalles.COLUMN1.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN1.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN1.Name = "COLUMN1"
contenido.grdDetalles.COLUMN2.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN2.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN2.Name = "COLUMN2"
contenido.grdDetalles.COLUMN3.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN3.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN3.Name = "COLUMN3"
contenido.grdDetalles.COLUMN4.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN4.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN4.Name = "COLUMN4"
contenido.grdDetalles.COLUMN5.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN5.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN5.Name = "COLUMN5"
contenido.grdDetalles.COLUMN6.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN6.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN6.Name = "COLUMN6"
contenido.grdDetalles.COLUMN7.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN7.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN7.Name = "COLUMN7"
contenido.grdDetalles.COLUMN8.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN8.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN8.Name = "COLUMN8"
contenido.grdDetalles.COLUMN9.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN9.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN9.Name = "COLUMN9"
contenido.grdDetalles.COLUMN10.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN10.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN10.Name = "COLUMN10"
contenido.grdDetalles.COLUMN11.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN11.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN11.Name = "COLUMN11"
contenido.grdDetalles.COLUMN12.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN12.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN12.Name = "COLUMN12"
contenido.grdDetalles.COLUMN13.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN13.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN13.Name = "COLUMN13"
contenido.grdDetalles.COLUMN14.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN14.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN14.Name = "COLUMN14"
contenido.grdDetalles.COLUMN15.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN15.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN15.Name = "COLUMN15"
contenido.grdDetalles.COLUMN16.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN16.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN16.Name = "COLUMN16"
contenido.grdDetalles.COLUMN17.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN17.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN17.Name = "COLUMN17"
contenido.grdDetalles.COLUMN18.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN18.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN18.Name = "COLUMN18"
contenido.grdDetalles.COLUMN19.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN19.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN19.Name = "COLUMN19"
contenido.grdDetalles.COLUMN20.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN20.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN20.Name = "COLUMN20"
contenido.grdDetalles.Left = 6
contenido.grdDetalles.Top = 253
contenido.grdDetalles.Name = "grdDetalles"
contenido.btnGrabar.Top = 547
contenido.btnGrabar.Left = 894
contenido.btnGrabar.Height = 44
contenido.btnGrabar.Picture = ..\..\clases\imagen\iconos bajados\disquetes-excepto-icono-7120-32.png
contenido.btnGrabar.Name = "btnGrabar"
contenido.btnCancelar.Top = 545
contenido.btnCancelar.Left = 7
contenido.btnCancelar.Height = 44
contenido.btnCancelar.Picture = ..\..\clases\imagen\iconos bajados\deshacer-icono-5403.ico
contenido.btnCancelar.Name = "btnCancelar"
contenido.Clscerrar1.Top = 547
contenido.Clscerrar1.Left = 941
contenido.Clscerrar1.Height = 44
contenido.Clscerrar1.Picture = ..\..\clases\imagen\iconos bajados\salir-de-mi-perfil-icono-3964.ico
contenido.Clscerrar1.Name = "Clscerrar1"
contenido.Clsetiqueta10.Name = "Clsetiqueta10"
contenido.txtPrMay.Name = "txtPrMay"
contenido.Clsetiqueta11.Name = "Clsetiqueta11"
contenido.txtPrMinorista.Name = "txtPrMinorista"
contenido.Clsetiqueta12.Name = "Clsetiqueta12"
contenido.txtAlicIVA.Name = "txtAlicIVA"
contenido.btnEliminar.Top = 212
contenido.btnEliminar.Left = 942
contenido.btnEliminar.Height = 39
contenido.btnEliminar.Width = 45
contenido.btnEliminar.Picture = ..\..\clases\imagen\iconos bajados\eliminar-cancelar-icono-4935 (1).ico
contenido.btnEliminar.Name = "btnEliminar"
contenido.chkImprimeDup.Top = 563
contenido.chkImprimeDup.Left = 552
contenido.chkImprimeDup.Alignment = 0
contenido.chkImprimeDup.Name = "chkImprimeDup"
contenido.btnCbteOrigen.Caption = "\<Leer pedido"
contenido.btnCbteOrigen.Visible = .T.
contenido.btnCbteOrigen.Name = "btnCbteOrigen"
contenido.txtObserv.Left = 6
contenido.txtObserv.Top = 442
contenido.txtObserv.Name = "txtObserv"
contenido.Clsetiqueta6.Left = 8
contenido.Clsetiqueta6.Top = 484
contenido.Clsetiqueta6.Name = "Clsetiqueta6"
contenido.Clsetiqueta7.Left = 316
contenido.Clsetiqueta7.Top = 484
contenido.Clsetiqueta7.Name = "Clsetiqueta7"
contenido.Clsetiqueta8.Left = 316
contenido.Clsetiqueta8.Top = 507
contenido.Clsetiqueta8.Name = "Clsetiqueta8"
contenido.Clsetiqueta9.Left = 8
contenido.Clsetiqueta9.Top = 508
contenido.Clsetiqueta9.Name = "Clsetiqueta9"
contenido.txtTotNeto.Left = 44
contenido.txtTotNeto.Top = 480
contenido.txtTotNeto.Name = "txtTotNeto"
contenido.txtPorIVA21.Left = 387
contenido.txtPorIVA21.Top = 480
contenido.txtPorIVA21.Name = "txtPorIVA21"
contenido.txtPorIVA105.Left = 387
contenido.txtPorIVA105.Top = 503
contenido.txtPorIVA105.Name = "txtPorIVA105"
contenido.txtImpIVA21.Left = 469
contenido.txtImpIVA21.Top = 480
contenido.txtImpIVA21.Name = "txtImpIVA21"
contenido.txtImpIVA105.Left = 469
contenido.txtImpIVA105.Top = 503
contenido.txtImpIVA105.Name = "txtImpIVA105"
contenido.txtTotal.Left = 44
contenido.txtTotal.Top = 503
contenido.txtTotal.Name = "txtTotal"
contenido.Clsetiqueta14.Name = "Clsetiqueta14"
contenido.txtDesc1.Name = "txtDesc1"
contenido.txtDesc2.Enabled = .F.
contenido.txtDesc2.Name = "txtDesc2"
contenido.txtDesc3.Enabled = .F.
contenido.txtDesc3.Name = "txtDesc3"
contenido.txtDesc4.Enabled = .F.
contenido.txtDesc4.Name = "txtDesc4"
contenido.txtImpDesc1.Left = 95
contenido.txtImpDesc1.Top = 560
contenido.txtImpDesc1.Name = "txtImpDesc1"
contenido.txtImpDesc2.Left = 170
contenido.txtImpDesc2.Top = 560
contenido.txtImpDesc2.Name = "txtImpDesc2"
contenido.txtImpDesc3.Left = 245
contenido.txtImpDesc3.Top = 560
contenido.txtImpDesc3.Name = "txtImpDesc3"
contenido.txtImpDesc4.Left = 320
contenido.txtImpDesc4.Top = 560
contenido.txtImpDesc4.Name = "txtImpDesc4"
contenido.Clsetiqueta15.Name = "Clsetiqueta15"
contenido.Clsetiqueta16.Left = 77
contenido.Clsetiqueta16.Top = 563
contenido.Clsetiqueta16.Name = "Clsetiqueta16"
contenido.Clsetiqueta17.FontSize = 11
contenido.Clsetiqueta17.Height = 20
contenido.Clsetiqueta17.Left = 769
contenido.Clsetiqueta17.Top = 484
contenido.Clsetiqueta17.Width = 45
contenido.Clsetiqueta17.ForeColor = 255,0,0
contenido.Clsetiqueta17.Name = "Clsetiqueta17"
contenido.txtTotFact.FontSize = 11
contenido.txtTotFact.Height = 28
contenido.txtTotFact.Left = 813
contenido.txtTotFact.Top = 480
contenido.txtTotFact.Width = 174
contenido.txtTotFact.ForeColor = 255,0,0
contenido.txtTotFact.Name = "txtTotFact"
contenido.Clsetiqueta18.Left = 316
contenido.Clsetiqueta18.Top = 529
contenido.Clsetiqueta18.Name = "Clsetiqueta18"
contenido.txtPorIIBB.Left = 387
contenido.txtPorIIBB.Top = 526
contenido.txtPorIIBB.Name = "txtPorIIBB"
contenido.txtImpIIBB.Left = 469
contenido.txtImpIIBB.Top = 526
contenido.txtImpIIBB.Name = "txtImpIIBB"
contenido.Clsetiqueta19.Left = 148
contenido.Clsetiqueta19.Top = 484
contenido.Clsetiqueta19.Name = "Clsetiqueta19"
contenido.txtST.Left = 207
contenido.txtST.Top = 480
contenido.txtST.Name = "txtST"
contenido.Clsetiqueta20.Name = "Clsetiqueta20"
contenido.txtPorDesc1.ReadOnly = .T.
contenido.txtPorDesc1.Name = "txtPorDesc1"
contenido.txtImpDescItem1.Name = "txtImpDescItem1"
contenido.txtPorDesc2.ReadOnly = .T.
contenido.txtPorDesc2.Name = "txtPorDesc2"
contenido.txtImpDescItem2.Name = "txtImpDescItem2"
contenido.txtPorDesc3.ReadOnly = .T.
contenido.txtPorDesc3.Name = "txtPorDesc3"
contenido.txtImpDescItem3.Name = "txtImpDescItem3"
contenido.txtPorDesc4.ReadOnly = .T.
contenido.txtPorDesc4.Name = "txtPorDesc4"
contenido.txtImpDescItem4.Name = "txtImpDescItem4"
contenido.Clsetiqueta21.Name = "Clsetiqueta21"
contenido.txtImpIVA.Name = "txtImpIVA"
contenido.Clsetiqueta22.Name = "Clsetiqueta22"
contenido.txtSTNeto.Name = "txtSTNeto"
contenido.Clsetiqueta13.Name = "Clsetiqueta13"
contenido.txtSubTotal.Name = "txtSubTotal"
contenido.Clsetiqueta23.Name = "Clsetiqueta23"
contenido.txtPrNeto.Name = "txtPrNeto"
contenido.lblExistencia.Name = "lblExistencia"
contenido.txtExistencia.Name = "txtExistencia"
contenido.Clsetiqueta24.Name = "Clsetiqueta24"
contenido.txtPorRec.Name = "txtPorRec"
contenido.txtImpRec.Name = "txtImpRec"
contenido.txtRecItem.Left = 408
contenido.txtRecItem.Top = 559
contenido.txtRecItem.Name = "txtRecItem"
contenido.Clsetiqueta25.Name = "Clsetiqueta25"
contenido.txtTelefono.Name = "txtTelefono"
contenido.Clsetiqueta26.Name = "Clsetiqueta26"
contenido.txtcuit.Name = "txtcuit"
contenido.Clsetiqueta27.Name = "Clsetiqueta27"
contenido.cboUnidVta.Name = "cboUnidVta"
contenido.txtCantPack.Name = "txtCantPack"
contenido.Clsetiqueta28.Name = "Clsetiqueta28"
contenido.txtOC.Name = "txtOC"
contenido.Clsetiqueta29.Name = "Clsetiqueta29"
contenido.txtPorRecItem.Name = "txtPorRecItem"
contenido.Clsetiqueta30.Name = "Clsetiqueta30"
contenido.txtFecEmis.Name = "txtFecEmis"
contenido.Clsetiqueta31.Name = "Clsetiqueta31"
contenido.txtMailFC.Name = "txtMailFC"
contenido.chkEnviarMail.Alignment = 0
contenido.chkEnviarMail.Name = "chkEnviarMail"
contenido.lblPrecioUnitFinal.Name = "lblPrecioUnitFinal"
contenido.txtPrUnitFinal.Name = "txtPrUnitFinal"
contenido.chkImprimirCbte.Alignment = 0
contenido.chkImprimirCbte.Name = "chkImprimirCbte"
contenido.btnAgregarCliente.Name = "btnAgregarCliente"
contenido.Clsetiqueta32.Name = "Clsetiqueta32"
contenido.txt_subtotal_no_grav.Name = "txt_subtotal_no_grav"
contenido.Clsetiqueta33.Left = 588
contenido.Clsetiqueta33.Top = 484
contenido.Clsetiqueta33.Name = "Clsetiqueta33"
contenido.txt_total_no_grav.Left = 668
contenido.txt_total_no_grav.Top = 480
contenido.txt_total_no_grav.Name = "txt_total_no_grav"
contenido.Top = 0
contenido.Left = 0
contenido.Width = 990
contenido.Height = 595
contenido.BackColor = 217,234,228
contenido.Name = "contenido"
mov_stock.Name = "mov_stock"
faltantes.Name = "faltantes"

*** METODOS ***
PROCEDURE calc_item_desc
LOCAL lnDesc1, lnDesc2, lnDesc3, lnDesc4, lnNeto
LOCAL lnImpDesc1, lnImpDesc2, lnImpDesc3, lnImpDesc4
LOCAL lnImpIVA, lnAlicIVA
LOCAL lnPorRec, lnImpRec, lnPorRecItem, lnImpRecItem

lnImpDesc1 = 0.00
lnImpDesc2 = 0.00
lnImpDesc3 = 0.00
lnImpDesc4 = 0.00
lnPorRec = 0.00
lnImpRec = 0.00
lnPorRecItem = 0.00
lnImpRecItem = 0.00

lnDesc1 = Thisform.contenido.txtPorDesc1.Value
lnDesc2 = Thisform.contenido.txtPorDesc2.Value
lnDesc3 = Thisform.contenido.txtPorDesc3.Value
lnDesc4 = Thisform.contenido.txtPorDesc4.Value

lnAlicIVA = Thisform.contenido.txtAlicIva.Value
lnPorRec = Thisform.contenido.txtPorRec.Value 
lnPorRecItem  = Thisform.contenido.txtPorRecItem.Value

IF RIGHT(ALLTRIM(Thisform.contenido.sel_Articulo.txtCodigo.Value), 3) == "ARX" THEN
	&& Si es artículo X tomo siempre el precio minorista ya que es el que habilito para modificar.
	lnNeto = Thisform.contenido.txtPrMinorista.Value
ELSE
	IF clientes.mayorista THEN
		lnNeto = Thisform.contenido.txtPrMay.Value
	ELSE
		lnNeto = Thisform.contenido.txtPrMinorista.Value
	ENDIF
ENDIF

lnImpDesc1 = ROUND(lnNeto * (lnDesc1 / 100),2)
lnImpDesc2 = ROUND((lnNeto - lnImpDesc1) * (lnDesc2 / 100),2)
lnImpDesc3 = ROUND((lnNeto - lnImpDesc1 - lnImpDesc2) * (lnDesc3 / 100),2)
lnImpDesc4 = ROUND((lnNeto - lnImpDesc1 - lnImpDesc2 - lnImpDesc3) * (lnDesc4 /100),2)
	
lnNeto = lnNeto - lnImpDesc1 - lnImpDesc2 - lnImpDesc3 - lnImpDesc4

****************************************************
&& Hago el recargo
lnImpRec = ROUND(lnNeto * (lnPorRec / 100), 2)

lnNeto = lnNeto + lnImpRec
****************************************************
&& Calculo el recargo por item
lnImpRecItem = ROUND(lnNeto * (lnPorRecItem/ 100), 2)

lnNeto = lnNeto + lnImpRecItem

Thisform.contenido.txtImpDescItem1.Value = lnImpDesc1
Thisform.contenido.txtImpDescItem2.Value = lnImpDesc2
Thisform.contenido.txtImpDescItem3.Value = lnImpDesc3
Thisform.contenido.txtImpDescItem4.Value = lnImpDesc4
Thisform.contenido.txtRecItem.Value = lnImpRecItem 

Thisform.contenido.txtPrNeto.Value = lnNeto
Thisform.contenido.txtSTNeto.Value = ROUND(lnNeto * thisform.contenido.txtcantidad.value, 2)

* Calculo el IVA
lnImpIVA = ROUND(Thisform.contenido.txtSTNeto.Value * (lnAlicIVA / 100), 2)
Thisform.contenido.txtImpIva.Value = lnImpIVA
Thisform.contenido.txtSubTotal.Value = Thisform.contenido.txtSTNeto.Value + Thisform.contenido.txtImpIVA.Value

*!*	IF (ALLTRIM(Thisform.cbte) == "PTO") THEN 
*!*		Thisform.contenido.txtSubTotal.Value = Thisform.contenido.txtSTNeto.Value + Thisform.contenido.txtImpIVA.Value
*!*	ELSE 
*!*		lnImpIVA = ROUND(Thisform.contenido.txtSTNeto.Value * (lnAlicIVA / 100), 2)
*!*		Thisform.contenido.txtImpIva.Value = lnImpIVA
*!*		Thisform.contenido.txtSubTotal.Value = Thisform.contenido.txtSTNeto.Value + Thisform.contenido.txtImpIVA.Value
*!*	ENDIF 

ENDPROC
PROCEDURE particionar_cbte
************************************************************************************
** Esta función permite grabar una factura cada 25 items.
** Pablo Díaz
************************************************************************************

LOCAL ln_cantitems
LOCAL lnResp
LOCAL lnImprimirPTO

ln_cantitems = 0

lnResp = 0
IF getGlobalCFG("PRINT_RTO") THEN
	lnResp = MESSAGEBOX("Desea imprimir remitos para este cliente", 4+32, Thisform.Caption)
ENDIF

SELECT cur_aux
ZAP 

*!*	IF !(ALLTRIM(thisform.cbte) == "COT") .AND. getGlobalCFG("STK_MODULE") THEN
*!*		IF !thisform.validar_stk_en_grabado() THEN
*!*			goConn.Rollback()
*!*			RETURN .F.
*!*		ENDIF
*!*	ENDIF

SELECT cur_detalle
IF RECCOUNT() > 0 THEN 
	GO TOP
ELSE 
	RETURN .F.
ENDIF 

************************************************************************************
** Paso de a 25 items del cursor de detalle al cursor auxiliar
************************************************************************************
SELECT cur_detalle
DO WHILE !EOF()
	ln_cantitems = ln_cantitems + 1
	
	SELECT cur_aux
	APPEND BLANK	
	
	REPLACE cur_aux.idDetalle WITH cur_detalle.idDetalle
	REPLACE cur_aux.idArticulo WITH cur_detalle.idArticulo ADDITIVE
	REPLACE cur_aux.codArt WITH cur_detalle.codArt ADDITIVE
	REPLACE cur_aux.descripcio WITH cur_detalle.descripcio ADDITIVE
	REPLACE cur_aux.nroPart WITH cur_detalle.nroPart ADDITIVE
	REPLACE cur_aux.cantidad WITH cur_detalle.cantidad ADDITIVE
	REPLACE cur_aux.prVta WITH cur_detalle.prVta ADDITIVE
	REPLACE cur_aux.pDtoVta1 WITH cur_detalle.pDtoVta1 ADDITIVE
	REPLACE cur_aux.pDtoVta2 WITH cur_detalle.pDtoVta2 ADDITIVE
	REPLACE cur_aux.pDtoVta3 WITH cur_detalle.pDtoVta3 ADDITIVE
	REPLACE cur_aux.pDtoVta4 WITH cur_detalle.pDtoVta4 ADDITIVE
	REPLACE cur_aux.iDtoVta1 WITH cur_detalle.iDtoVta1 ADDITIVE
	REPLACE cur_aux.iDtoVta2 WITH cur_detalle.iDtoVta2 ADDITIVE
	REPLACE cur_aux.iDtoVta3 WITH cur_detalle.iDtoVta3 ADDITIVE
	REPLACE cur_aux.iDtoVta4 WITH cur_detalle.iDtoVta4 ADDITIVE
	REPLACE cur_aux.pDtoCli1 WITH cur_detalle.pDtoCli1 ADDITIVE
	REPLACE cur_aux.pDtoCli2 WITH cur_detalle.pDtoCli2 ADDITIVE
	REPLACE cur_aux.pDtoCli3 WITH cur_detalle.pDtoCli3 ADDITIVE
	REPLACE cur_aux.pDtoCli4 WITH cur_detalle.pDtoCli4 ADDITIVE
	REPLACE cur_aux.iDtoCli1 WITH cur_detalle.iDtoCli1 ADDITIVE
	REPLACE cur_aux.iDtoCli2 WITH cur_detalle.iDtoCli2 ADDITIVE
	REPLACE cur_aux.iDtoCli3 WITH cur_detalle.iDtoCli3 ADDITIVE
	REPLACE cur_aux.iDtoCli4 WITH cur_detalle.iDtoCli4 ADDITIVE
	
	&& Incorporo el recargo por ítem
	REPLACE cur_aux.pRecItem WITH cur_detalle.pRecItem ADDITIVE
	REPLACE cur_aux.iRecItem WITH cur_detalle.iRecItem ADDITIVE
	
	REPLACE cur_aux.alicIVA WITH cur_detalle.alicIVA ADDITIVE
	REPLACE cur_aux.impIVA WITH cur_detalle.impIVA ADDITIVE
	REPLACE cur_aux.impNeto WITH cur_detalle.impNeto ADDITIVE
	REPLACE cur_aux.totNeto WITH cur_detalle.totNeto ADDITIVE
	REPLACE cur_aux.subTotal WITH cur_detalle.subTotal ADDITIVE
	REPLACE cur_aux.prArtic WITH cur_detalle.prArtic ADDITIVE
	REPLACE cur_aux.esOferta WITH cur_detalle.esOferta ADDITIVE
	REPLACE cur_aux.pRecVta WITH cur_detalle.pRecVta ADDITIVE 
	REPLACE cur_aux.iRecVta WITH cur_detalle.iRecVta ADDITIVE
	REPLACE cur_aux.uniDesp WITH cur_detalle.uniDesp ADDITIVE
	REPLACE cur_aux.cantPack WITH cur_detalle.cantPack ADDITIVE 
	REPLACE cur_aux.uniMed WITH cur_detalle.uniMed ADDITIVE
	
	&& Si lleva stock agrege los movimientos que hay que generar.
	IF ALLTRIM(cur_detalle.nropart) == "" THEN
		IF getGlobalCFG("STK_MODULE") THEN
			IF !(RIGHT(ALLTRIM(cur_detalle.codArt), 3) == "ARX") THEN
				Thisform.mov_stock.agregar_articulo(cur_detalle.idArticulo, ;
						cur_detalle.Cantidad, "")
			ENDIF
		ENDIF
	ELSE
		IF getGlobalCFG("STK_MODULE") THEN
			IF !(RIGHT(ALLTRIM(cur_detalle.codArt), 3) == "ARX") THEN
				Thisform.mov_stock.agregar_articulo(cur_detalle.idArticulo, ;
						cur_detalle.Cantidad, cur_detalle.nropart)
			ENDIF
		ENDIF	
	ENDIF
	
	&& Cuando el contador llegue a 25 items grabo una factura nueva.
	IF ln_cantitems = 25
		&& tengo que hacer el calculo de los totales y el grabado		
		Thisform.calc_subtot_cur_aux()
		IF !thisform.grabar_cbte_part()
			RETURN .F.
		ENDIF	

		&& Verifica si usa impresora fiscal
		IF !thisform.usar_fiscal
			Thisform.imprimir()
		ENDIF
		IF lnResp = 6 .AND. getGlobalCFG("PRINT_RTO") THEN
			thisform.imprimir_rtos()
		ENDIF		
		this.add_faccob(thisform.id_ventasc)
		ln_cantitems = 0
		SELECT cur_aux
		ZAP
		Thisform.mov_stock.limpiar()
	ENDIF 
	
	SELECT cur_detalle
	SKIP  
ENDDO 

&& En el caso que la ultima factura no haya llegado a los 25 items
&& tengo que hacer una nueva factura con los items restantes.
IF ln_cantitems <> 0 
	&& tengo que hacer el calculo de los totales y el grabado
	Thisform.calc_subtot_cur_aux()
	IF !thisform.grabar_cbte_part()
		RETURN .F.
	ENDIF	
	
	&& Verifico que no use fiscal para enviar a imprimir
	IF !thisform.usar_fiscal
		Thisform.imprimir()
	ENDIF
	IF lnResp = 6 .AND. getGlobalCFG("PRINT_RTO") THEN
		thisform.imprimir_rtos()
	ENDIF		
	this.add_faccob(thisform.id_ventasc)
	Thisform.mov_stock.limpiar()
ENDIF

IF getGlobalCFG("PAGCTDO") .AND. This.cp_cntdias = 0 THEN
	this.realizar_cobranza_mostrador()
ENDIF

RETURN .T.
ENDPROC
PROCEDURE recalcular_todo
local lo_artic, lcSql
local lnPorDesc1, lnPorDesc2, lnPorDesc3, lnPorDesc4
local lnImpDesc1, lnImpDesc2, lnImpDesc3, lnImpDesc4
local lnPrVtaMax, lnPrVtaMin, lnPrecio, lnNeto, lnSubTotNeto
local lnPorRec, lnImpRec, lnPrOferta, llEsOferta, lnImpRecItem

lcSql = ""
lo_artic = createobject("odbc_result")
lnPrOferta = 0.00
llEsOferta = .f.

select cur_Deta_View
if reccount("cur_Deta_View") > 0 then
	go top
endif

&& Recalculo los datos de la grilla
do while !eof("cur_Deta_View")
	lcSql = "SELECT * FROM articulos WHERE articulos.idArticulo = " + alltrim(str(cur_Deta_View.idArticulo))

	lo_artic.ActiveConnection = goConn.ActiveConnection
	lo_artic.cursor_name = "tmp_artic"

	if !lo_artic.OpenQuery(lcSql) then
		messagebox(lo_artic.error_Message, 0+16, thisform.caption)
		return .f.
	endif
	lnPrOferta = thisform.getoferta_byart(cur_Deta_View.idArticulo)
	select tmp_artic
	if reccount() > 0 then
		select cur_Deta_View
		lock()

		*******************************************************************************
		* Recalculo los precios mayorista y minorista segun los descuentos del cliente
		*******************************************************************************

		lnPorDesc1 = thisform.contenido.txtDesc1.value
		lnPorDesc2 = thisform.contenido.txtDesc2.value
		lnPorDesc3 = thisform.contenido.txtDesc3.value
		lnPorDesc4 = thisform.contenido.txtDesc4.value
		lnImpDesc1 = 0.00
		lnImpDesc2 = 0.00
		lnImpDesc3 = 0.00
		lnImpDesc4 = 0.00

		select tmp_artic
		lnPrVtaMax = tmp_artic.prVentaMax
		lnPrVtaMin = tmp_artic.prVentaMin

		if right(alltrim(cur_Deta_View.codArt), 3) == "ARX" then
			lnPrecio = cur_Deta_View.prArtic
		else
			if clientes.mayorista then
				select cur_Deta_View


				if lnPrOferta = 0 then
					lnPrecio = lnPrVtaMax
					llEsOferta = .f.
				else
					lnPrecio = lnPrOferta
					llEsOferta = .t.
				endif
			else
				lnPrecio = lnPrVtaMin
				llEsOferta = .f.
			endif
		endif

		replace cur_Deta_View.prArtic with lnPrecio additive

		***********************************************************
		* Calculo el descuento del cliente en el ítem para grabar
		***********************************************************
		lnImpDesc1 = round(lnPrecio * (lnPorDesc1 / 100), 2)
		if !llEsOferta then
			lnImpDesc2 = round((lnPrecio - lnImpDesc1 ) * (lnPorDesc2 / 100),2)
			lnImpDesc3 = round((lnPrecio - lnImpDesc1 - lnImpDesc2 ) * (lnPorDesc3 / 100),2)
			lnImpDesc4 = round((lnPrecio - lnImpDesc1 - lnImpDesc2 - lnImpDesc3) * (lnPorDesc4 / 100),2)
		endif

		lnPrecio = lnPrecio - lnImpDesc1 - lnImpDesc2 - lnImpDesc3 - lnImpDesc4

		replace cur_Deta_View.prVta with lnPrecio additive

		replace cur_Deta_View.pDtoCli1 with lnPorDesc1 additive
		replace cur_Deta_View.pDtoCli2 with lnPorDesc2 additive
		replace cur_Deta_View.pDtoCli3 with lnPorDesc3 additive
		replace cur_Deta_View.pDtoCli4 with lnPorDesc4 additive
		replace cur_Deta_View.iDtoCli1 with lnImpDesc1 additive
		replace cur_Deta_View.iDtoCli2 with lnImpDesc2 additive
		replace cur_Deta_View.iDtoCli3 with lnImpDesc3 additive
		replace cur_Deta_View.iDtoCli4 with lnImpDesc4 additive
		replace cur_Deta_View.esOferta with llEsOferta additive

		*************************************
		&& Calculo los descuentos por item
		*************************************

		lnPorDesc1 = cur_Deta_View.pDtoVta1
		lnPorDesc2 = cur_Deta_View.pDtoVta2
		lnPorDesc3 = cur_Deta_View.pDtoVta3
		lnPorDesc4 = cur_Deta_View.pDtoVta4
		lnImpDesc1 = 0.00
		lnImpDesc2 = 0.00
		lnImpDesc3 = 0.00
		lnImpDesc4 = 0.00
		lnNeto = 0.00

		lnImpDesc1 = round(lnPrecio * (lnPorDesc1 / 100),2)
		lnImpDesc2 = round((lnPrecio - lnImpDesc1 ) * (lnPorDesc2 / 100),2)
		lnImpDesc3 = round((lnPrecio - lnImpDesc1 - lnImpDesc2 ) * (lnPorDesc3 / 100),2)
		lnImpDesc4 = round((lnPrecio - lnImpDesc1 - lnImpDesc2 - lnImpDesc3) * (lnPorDesc4 / 100),2)

		lnNeto = lnPrecio - lnImpDesc1 - lnImpDesc2 - lnImpDesc3 - lnImpDesc4

		replace cur_Deta_View.iDtoVta1 with lnImpDesc1 additive
		replace cur_Deta_View.iDtoVta2 with lnImpDesc2 additive
		replace cur_Deta_View.iDtoVta3 with lnImpDesc3 additive
		replace cur_Deta_View.iDtoVta4 with lnImpDesc4 additive

		************************************************
		* Agrego el recargo del cliente en el item
		************************************************
		lnPorRec = thisform.contenido.txtporrec.value

		lnImpRec = round(lnNeto * (lnPorRec / 100), 2)

		lnNeto = lnNeto + lnImpRec

		replace cur_Deta_View.pRecVta with lnPorRec additive
		replace cur_Deta_View.iRecVta with lnImpRec additive

		******************************************************************
		&& Incluyo el recargo por ítem.
		******************************************************************
		lnImpRecItem = round(lnNeto * (cur_Deta_View.pRecItem / 100),2)

		lnNeto = lnNeto + lnImpRecItem

		replace cur_Deta_View.pRecItem with cur_Deta_View.pRecItem additive
		replace cur_Deta_View.iRecItem with lnImpRecItem additive

		****************************************************
		* Recalculo el IVA y los Subtotales
		****************************************************
		replace cur_Deta_View.impNeto with lnNeto additive

		lnSubTotNeto = round(lnNeto * cur_Deta_View.cantidad, 2)
		
		if alltrim(thisform.cbte) == "PTO" then
			if getGlobalCFG("PTOINCIVA") then
				* Tengo que contemplar el IVA
				select cur_Deta_View
				replace cur_deta_view.totNeto WITH lnSubTotNeto additive
				replace cur_Deta_View.impIVA with ROUND(lnSubTotNeto * (tmp_artic.alicIVA / 100), 2) additive
				replace cur_Deta_View.alicIVA with tmp_artic.alicIVA additive
				replace cur_deta_view.subTotal WITH ROUND(lnSubTotNeto + cur_deta_view.impIVA, 2) additive
*!*					replace cur_Deta_View.subTotal with cur_Deta_View.totNeto + cur_Deta_View.impIVA additive	
				
			else
				* No tengo que contemplar le IVA
				select cur_Deta_View
				replace cur_Deta_View.impIVA with 0 additive
				replace cur_Deta_View.alicIVA with 0 additive
				replace cur_Deta_View.subTotal with cur_Deta_View.totNeto additive	
			endif
		endif
		unlock
	endif

	lo_artic.close_query()

	select cur_Deta_View
	skip
enddo

if !(alltrim(thisform.contenido.sel_Articulo.txtCodigo.value) == "") then
	thisform.contenido.sel_Articulo.recuperar_datos()
	thisform.contenido.sel_Articulo.txtCodigo.valid()
endif

select cur_Deta_View
if reccount("cur_Deta_View") > 0 then
	go top
endif

thisform.contenido.grdDetalles.refresh()
thisform.sumar_items()
thisform.calcular_ret_iibb()

return .t.

ENDPROC
PROCEDURE get_precio_oferta
LOCAL lnPrecio, loResult, lcSql, loDT
LOCAL lnPorDesc1, lnPorDesc2, lnPorDesc3, lnPorDesc4
LOCAL lnPorOferta

loDT = CREATEOBJECT("datetime")
loResult = CREATEOBJECT("odbc_result")
lcSql = ""
lnPrecio = 0.00

lnPorDesc1 = Thisform.contenido.txtDesc1.Value
lnPorDesc2 = Thisform.contenido.txtDesc2.Value
lnPorDesc3 = Thisform.contenido.txtDesc3.Value
lnPorDesc4 = Thisform.contenido.txtDesc4.Value

lcSql = "SELECT * FROM ofertas "
lcSql = lcSql + "WHERE idArticulo = " + ALLTRIM(STR(thisform.contenido.sel_articulo.valcpoid)) + " "
lcSql = lcSql + "AND fecVigDD <= " + loDT.toMySql(DATE()) + " "
lcSql = lcSql + "AND fecVigHH >= " + loDT.toMySql(DATE())

loResult.ActiveConnection = goConn.ActiveConnection
loResult.Cursor_Name = "cur_tmpofta"

IF !loResult.OpenQuery(lcSql) THEN
	MESSAGEBOX(loResult.Error_Message, 0+48, Thisform.Caption)
	RETURN -1
ENDIF

SELECT cur_tmpofta
IF RECCOUNT("cur_tmpofta") > 0 THEN
	lnPorOferta = cur_tmpofta.porOfert
	IF lnPorOferta >= lnPorDesc2 THEN
		lnPrecio = cur_tmpofta.impOfert
	ELSE
		lnPrecio = 0
	ENDIF
ENDIF

loResult.Close_Query()

RETURN lnPrecio
ENDPROC
PROCEDURE agregar_item_viewer
LOCAL lnPDtoCli1, lnPDtoCli2, lnPDtoCli3, lnPDtoCli4
LOCAL lnIDtoCli1, lnIDtoCli2, lnIDtoCli3, lnIDtoCli4, lnCantAnt
LOCAL loResult, lcSql, lnPrecio, llEsOferta, lnproferta, lnAlicIva
LOCAL lnPrVta

lnPDtoCli1 = Thisform.contenido.txtDesc1.Value
lnPDtoCli2 = Thisform.contenido.txtDesc2.Value
lnPDtoCli3 = Thisform.contenido.txtDesc3.Value
lnPDtoCli4 = Thisform.contenido.txtDesc4.Value
lnIDtoCli1 = 0.00
lnIDtoCli2 = 0.00
lnIDtoCli3 = 0.00
lnIDtoCli4 = 0.00
lnPrecio = 0.00
loResult = CREATEOBJECT("odbc_result")
lcSql = ""
llEsOferta = .F.
lnproferta = 0.00
lnAlicIva = 0.00
lnCantAnt = 0.00
llTomaOferta = .F.

IF !Thisform.ValidarDetalle()
	RETURN .F.
ENDIF

lcSql = "SELECT * FROM articulos WHERE idArticulo = " + ALLTRIM(STR(Thisform.contenido.sel_Articulo.valcpoid))
loResult.ActiveConnection = goConn.ActiveConnection
loResult.Cursor_Name = "cur_Art"
loResult.OpenQuery(lcSql)

IF RIGHT(ALLTRIM(Thisform.Contenido.sel_Articulo.txtCodigo.Value), 3) == "ARX" THEN
	lnPrecio = Thisform.prarti_x
ELSE	
	IF clientes.mayorista THEN 
		lnPrecio = thisform.get_precio_oferta()
		lnproferta = lnPrecio
		
		IF lnPrecio = 0 THEN
			lnPrecio = cur_Art.prVentaMax
			llEsOferta = .F.
		ELSE
			llEsOferta = .T.
		ENDIF
	ELSE
		lnPrecio = cur_Art.prVentaMin
		llEsOferta = .F.
	ENDIF		
ENDIF

loResult.Close_Query()

IF glVersionBeta THEN
	SELECT cur_Deta_View
	IF RECCOUNT() = 5 THEN
		MESSAGEBOX("Usted está utilizando una versión límitada del sistema, si desea comprarlo envíe un mail a ldz.software@gmail.com", 0+64, Thisform.Caption)
		RETURN .F.
	ENDIF
ENDIF

* Valido si el artículo ya se encuentra cargado en el presupuesto
SELECT cur_Deta_View
IF RECCOUNT() > 0
	GO TOP
ENDIF

SELECT cur_Deta_View
DO WHILE !EOF()
	IF ALLTRIM(cur_Deta_View.codArt) == ALLTRIM(Thisform.contenido.sel_Articulo.txtCodigo.Value) THEN
		IF MESSAGEBOX("El artículo ya se encuentra cargado, ¿Desea acumular la cantidad?",4+32, Thisform.Caption) == 6 THEN
			lnCantAnt = Thisform.contenido.txtcantidad.Value
			Thisform.contenido.txtcantidad.Value = Thisform.contenido.txtcantidad.Value + cur_Deta_View.cantidad
			
			&& Vuelvo a verificar el stock nuevamente al acumular la cantidad 
			IF (ALLTRIM(Thisform.cbte) != "COT") .AND. (ALLTRIM(Thisform.cbte) != "NC") THEN
				&& Valido el stock solo en caso que no sea artículo X
				IF RIGHT(ALLTRIM(Thisform.Contenido.sel_Articulo.txtCodigo.Value), 3) != "ARX" THEN
					IF getGlobalCFG("STK_MODULE") THEN
						IF Thisform.mov_stock.get_exist_byart(Thisform.Contenido.sel_Articulo.valcpoid) <= 0 THEN
							Thisform.Contenido.sel_Articulo.txtCodigo.SetFocus()
							
							MESSAGEBOX("No hay stock disponible", 0+48, Thisform.Caption)				
							thisform.contenido.txtCantidad.Value = lnCantAnt
							thisform.contenido.txtCantidad.SetFocus()
							RETURN .F.
						ENDIF
						
						&& Valido si está o no cubierto al 100%
						IF Thisform.Contenido.txtCantidad.Value > Thisform.Contenido.txtExistencia.Value THEN
							MESSAGEBOX("No hay stock suficiente para cubrir la cantidad ingresada", 0+48, Thisform.Caption)
							thisform.contenido.txtCantidad.Value = lnCantAnt
							thisform.contenido.txtCantidad.SetFocus()
							RETURN .F.
						ENDIF
					ENDIF
				ENDIF
			ENDIF			
			
			Thisform.calc_item_desc()
			
			SELECT cur_Deta_View
			DELETE
		ELSE 
			Thisform.contenido.sel_Articulo.txtCodigo.SetFocus()
			RETURN .F.
		ENDIF 
	ENDIF

	SELECT cur_Deta_View
	SKIP
ENDDO

SELECT cur_Deta_View
APPEND BLANK
REPLACE cur_Deta_View.idDetalle WITH RECCOUNT("cur_Deta_View")
REPLACE cur_Deta_View.idArticulo WITH Thisform.contenido.sel_Articulo.valcpoid ADDITIVE	
REPLACE cur_Deta_View.codArt WITH Thisform.contenido.sel_Articulo.txtCodigo.Value ADDITIVE
REPLACE cur_Deta_View.descripcio WITH Thisform.contenido.sel_Articulo.txtDescripcion.Value ADDITIVE
REPLACE cur_Deta_View.cantidad WITH Thisform.contenido.txtCantidad.Value ADDITIVE

*******************************************************************************************************************************
* Verifico el tipo de cliente que es para saber desde donde tomar el precio
*******************************************************************************************************************************
IF RIGHT(ALLTRIM(Thisform.Contenido.sel_Articulo.txtCodigo.Value), 3) == "ARX" THEN
	&& Si es artículo X, siempre cargo el contenido de lo que el usuario haya ingresado
	REPLACE cur_Deta_View.prVta WITH Thisform.contenido.txtPrMinorista.Value ADDITIVE
	REPLACE cur_Deta_View.prArtic WITH Thisform.prarti_x ADDITIVE
ELSE
	IF clientes.mayorista THEN
		REPLACE cur_Deta_View.prVta WITH Thisform.contenido.txtPrMay.Value ADDITIVE
		
		IF !llEsOferta THEN
			REPLACE cur_Deta_View.prArtic WITH thisform.pr_mayorista ADDITIVE
		ELSE
			REPLACE cur_Deta_View.prArtic WITH thisform.pr_oferta ADDITIVE
		ENDIF
	ELSE
		REPLACE cur_Deta_View.prVta WITH Thisform.contenido.txtPrMinorista.Value ADDITIVE
		REPLACE cur_Deta_View.prArtic WITH Thisform.pr_minorista ADDITIVE
	ENDIF
	
	* Levanto el stock actual solo en caso que no sea ARX
	REPLACE cur_Deta_View.stkDisp  WITH Thisform.mov_stock.get_exist_byart(Thisform.contenido.sel_Articulo.valcpoid) ADDITIVE
ENDIF

*******************************************************************************************************************************
* Calculo el descuento del cliente en el ítem para grabar
*******************************************************************************************************************************
lnIDtoCli1 = ROUND(lnPrecio * (lnPDtoCli1 / 100),2)
IF !llEsOferta THEN
	lnIDtoCli2 = ROUND((lnPrecio - lnIDtoCli1) * (lnPDtoCli2 / 100),2)
	lnIDtoCli3 = ROUND((lnPrecio - lnIDtoCli1 - lnIDtoCli2) * (lnPDtoCli3 / 100),2)
	lnIDtoCli4 = ROUND((lnPrecio - lnIDtoCli1 - lnIDtoCli2 - lnIDtoCli3) * (lnPDtoCli4 / 100),2)
ENDIF

REPLACE cur_Deta_View.pDtoCli1 WITH lnPDtoCli1 ADDITIVE
REPLACE cur_Deta_View.pDtoCli2 WITH lnPDtoCli2 ADDITIVE
REPLACE cur_Deta_View.pDtoCli3 WITH lnPDtoCli3 ADDITIVE
REPLACE cur_Deta_View.pDtoCli4 WITH lnPDtoCli4 ADDITIVE
REPLACE cur_Deta_View.iDtoCli1 WITH lnIDtoCli1 ADDITIVE
REPLACE cur_Deta_View.iDtoCli2 WITH lnIDtoCli2 ADDITIVE
REPLACE cur_Deta_View.iDtoCli3 WITH lnIDtoCli3 ADDITIVE
REPLACE cur_Deta_View.iDtoCli4 WITH lnIDtoCli4 ADDITIVE
REPLACE cur_Deta_View.esOferta WITH llEsOferta ADDITIVE

*******************************************************************************************************************************
&& Calculo los descuentos por item
*******************************************************************************************************************************
REPLACE cur_Deta_View.pDtoVta1 WITH Thisform.contenido.txtPorDesc1.Value
REPLACE cur_Deta_View.pDtoVta2 WITH Thisform.contenido.txtPorDesc2.Value
REPLACE cur_Deta_View.pDtoVta3 WITH Thisform.contenido.txtPorDesc3.Value
REPLACE cur_Deta_View.pDtoVta4 WITH Thisform.contenido.txtPorDesc4.Value
REPLACE cur_Deta_View.iDtoVta1 WITH Thisform.contenido.txtImpDescItem1.Value
REPLACE cur_Deta_View.iDtoVta2 WITH Thisform.contenido.txtImpDescItem2.Value 
REPLACE cur_Deta_View.iDtoVta3 WITH Thisform.contenido.txtImpDescItem3.Value
REPLACE cur_Deta_View.iDtoVta4 WITH Thisform.contenido.txtImpDescItem4.Value

*******************************************************************************************************************************
* Agrego el recargo del cliente en el item
*******************************************************************************************************************************
REPLACE cur_Deta_View.pRecVta WITH Thisform.contenido.txtporrec.Value ADDITIVE
REPLACE cur_Deta_View.iRecVta WITH ROUND((lnPrecio - lnIDtoCli1 - lnIDtoCli2 - lnIDtoCli3 - lnIDtoCli4) * (Thisform.contenido.txtporrec.Value/ 100), 2) ADDITIVE

*******************************************************************************************************************************
&& Incluyo el recargo por ítem.
*******************************************************************************************************************************
REPLACE cur_Deta_View.pRecItem WITH Thisform.contenido.txtPorRecItem.Value ADDITIVE
REPLACE cur_Deta_View.iRecItem WITH Thisform.contenido.txtRecItem.Value ADDITIVE

REPLACE cur_Deta_View.impNeto WITH Thisform.contenido.txtPrNeto.Value ADDITIVE

*******************************************************************************************************************************
* Hago el cálculo del IVA
*******************************************************************************************************************************
REPLACE cur_Deta_View.alicIVA WITH Thisform.contenido.txtAlicIVA.Value ADDITIVE
REPLACE cur_Deta_View.impIVA WITH Thisform.contenido.txtImpIVA.Value ADDITIVE
*!*	IF (ALLTRIM(Thisform.cbte) == "PTO") THEN
*!*		REPLACE cur_Deta_View.impIVA WITH 0 ADDITIVE
*!*		REPLACE cur_Deta_View.alicIVA WITH 0 ADDITIVE
*!*	ELSE
*!*		REPLACE cur_Deta_View.alicIVA WITH Thisform.contenido.txtAlicIVA.Value ADDITIVE
*!*		REPLACE cur_Deta_View.impIVA WITH Thisform.contenido.txtImpIVA.Value ADDITIVE 
*!*	ENDIF

REPLACE cur_Deta_View.totNeto WITH Thisform.contenido.txtSTNeto.Value ADDITIVE
REPLACE cur_Deta_View.subTotal WITH Thisform.contenido.txtSubTotal.Value ADDITIVE


REPLACE cur_Deta_View.uniDesp WITH VAL(Thisform.contenido.cboUnidVta.Value) ADDITIVE
REPLACE cur_Deta_View.cantPack WITH Thisform.contenido.txtCantPack.Value ADDITIVE
REPLACE cur_Deta_View.uniMed WITH Thisform.unimed ADDITIVE

SELECT cur_Deta_View

RETURN .T.


ENDPROC
PROCEDURE getoferta_byart
PARAMETERS tnIdArticulo

LOCAL lnPrecio, loResult, lcSql, loDT

loDT = CREATEOBJECT("datetime")
loResult = CREATEOBJECT("odbc_result")
lcSql = ""
lnPrecio = 0.00
lnPorDesc2 = Thisform.Contenido.txtDesc2.Value

lcSql = "SELECT * FROM ofertas "
lcSql = lcSql + "WHERE idArticulo = " + ALLTRIM(STR(tnIdArticulo)) + " "
lcSql = lcSql + "AND fecVigDD <= " + loDT.toMySql(DATE()) + " "
lcSql = lcSql + "AND fecVigHH >= " + loDT.toMySql(DATE())

loResult.ActiveConnection = goConn.ActiveConnection
loResult.Cursor_Name = "cur_tmpofta"

IF !loResult.OpenQuery(lcSql) THEN
	MESSAGEBOX(loResult.Error_Message, 0+48, Thisform.Caption)
	RETURN -1
ENDIF

SELECT cur_tmpofta
IF RECCOUNT("cur_tmpofta") > 0 THEN
	IF cur_tmpofta.porOfert >= lnPorDesc2 THEN
		lnPrecio = cur_tmpofta.impOfert
	ELSE
		lnPrecio = 0
	ENDIF
ENDIF

loResult.Close_Query()

RETURN lnPrecio
ENDPROC
PROCEDURE Init
DODEFAULT()
Thisform.contenido.sel_Cliente.txtCodigo.SetFocus()
Thisform.contenido.sel_Cliente.txtCodigo.Value = getGlobalCFG("CLI_CF")
Thisform.contenido.sel_Articulo.txtCodigo.SetFocus()
Thisform.contenido.txtCuit.Value = "11111111"

IF getGlobalCFG("MODOMOST") THEN
	Thisform.contenido.txtCantidad.Enabled = .F.
ENDIF
ENDPROC
PROCEDURE blanquear
DODEFAULT()
Thisform.contenido.sel_Cliente.txtCodigo.SetFocus()
Thisform.contenido.sel_Cliente.txtCodigo.Value = getGlobalCFG("CLI_CF")
Thisform.contenido.sel_Articulo.txtCodigo.SetFocus()
Thisform.contenido.txtCuit.Value = "11111111"

ENDPROC
PROCEDURE imprimir
LOCAL m.NroCli, m.RazSoc, m.Telefono, m.direccion, m.localidad, m.codPostal, m.pcia, m.TipoIVA, m.nroCUIT
LOCAL m.Total, m.tipoDoc, m.NroCbte, m.Fecha, m.leyenda, m.fecVto, m.tipoDoc, m.ptoVta
LOCAL m.porDesc1, m.porDesc2, m.porDesc3, m.porDesc4, m.porRec
LOCAL m.impDesc1, m.impDesc2, m.impDesc3, m.impDesc4
LOCAL m.porIIBB, m.impIIBB, m.observ, m.vendedor, m.condPago
LOCAL m.porIVA105, m.impIVA105, m.porIVA21, m.impIVA21, m.impNeto, m.impFinal
LOCAL m.NroRto, m.nroOC
LOCAL lcSql, loNumerador, lcPrinterName, lnCantCpia
LOCAL llEnvMail, llUsaTicket

loNumerador = CREATEOBJECT("odbc_result")
lcSql = ""
m.NroCli = Thisform.contenido.sel_Cliente.txtCodigo.Value
m.RazSoc = Thisform.contenido.sel_Cliente.txtDescripcion.Value
m.Telefono = ALLTRIM(Thisform.cli_telefono)
m.direccion = ALLTRIM(Thisform.cli_calle)
m.localidad = ALLTRIM(Thisform.cli_localidad)
m.codPostal = ALLTRIM(Thisform.cli_codPostal)
m.pcia = ALLTRIM(Thisform.cli_Pcia)
m.nroCUIT = ALLTRIM(Thisform.contenido.txtCuit.Value)
m.TipoIVA = Thisform.Contenido.txtSitIVA.Value
m.Total = 0.00
m.tipoDoc = ""
m.ptoVta = ""
m.NroCbte = ""
m.leyenda = ""
m.Fecha = DATETIME()
m.porIVA105 = 0.00
m.porIVA21 = 0.00
m.impIVA105 = 0.00
m.impIVA21 = 0.00
m.impNeto = 0.00
m.impFinal = 0.00
m.fecVto = DATE() + thisform.cp_cntdias
m.tipoDoc = Thisform.tipodoc
m.porIIBB = 0.00
m.impIIBB = 0.00
lnCantCpia = 0
m.observ = ""
m.vendedor = thisform.nombre_usuario
m.NroRto = ""
m.nroOC = Thisform.contenido.txtoc.Value
m.porRec = Thisform.Contenido.txtPorRec.Value
m.condPago = IIF(This.idCondPago = 1, "CONTADO", "CUENTAS CORRIENTES")
m.NroCbte = Thisform.ptovta + "-" + Thisform.nrocbte

&& Levanto la configuración de impresora para este puesto de trabajo

lcSql = "SELECT * FROM impresoras "
lcSql = lcSql + "WHERE hostName = '" + ALLTRIM(SYS(0)) + "' "
lcSql = lcSql + "	AND idNum = " + ALLTRIM(STR(Thisform.idNum))

loNumerador.ActiveConnection = goConn.ActiveConnection
loNumerador.Cursor_Name = "cur_num"

IF !loNumerador.OpenQuery(lcSql) THEN
	MESSAGEBOX(loNumerador.Error_Message, 0+48, Thisform.Caption)
	RETURN
ENDIF

SELECT cur_num
IF RECCOUNT("cur_num") = 0 THEN
	MESSAGEBOX("No hay impresora configurada para este puesto de trabajo", 0+48, Thisform.Caption)
	loNumerador.Close_Query()
	RETURN
ENDIF

lcPrinterName = ALLTRIM(cur_Num.impresora)
lnCantCpia = cur_Num.copias
llUsaTicket = cur_Num.usa_ticket

loNumerador.Close_Query()

IF ALLTRIM(Thisform.cbte) == "COT"
	m.leyenda = "COTIZACION"
	m.tipoDoc = "X"
	m.Total = Thisform.contenido.txtTotFact.Value
ELSE 
	IF ALLTRIM(Thisform.cbte) == "PTO"
		m.leyenda = "PRESUPUESTO"
		m.tipoDoc = "X"
		m.Total = Thisform.contenido.txtTotFact.Value
	ELSE
		IF ALLTRIM(Thisform.cbte) == "PED"
			m.leyenda = "NOTA DE PEDIDO"
			m.tipoDoc = "P"
			m.Total = Thisform.contenido.txtTotFact.Value
		ELSE
			IF ALLTRIM(Thisform.Cbte) == "FC"
				m.leyenda = "FACTURA"
				m.Total = cur_Subtotal.totFact
			ELSE
				IF ALLTRIM(Thisform.Cbte) == "NC"
					m.Leyenda = "NOTA DE CREDITO"
					m.Total = cur_Subtotal.totFact
				ELSE
					IF ALLTRIM(Thisform.Cbte) == "ND"
						m.leyenda = "NOTA DE DEBITO"
						m.Total = cur_Subtotal.totFact
					ENDIF
				ENDIF
			ENDIF
		ENDIF
	ENDIF
ENDIF 

IF (ALLTRIM(Thisform.cbte) == "NC") .OR. (ALLTRIM(Thisform.cbte) == "FC") .OR. (ALLTRIM(Thisform.cbte) == "PTO") .OR. (ALLTRIM(Thisform.cbte) == "COT") THEN
	m.porDesc1 = cur_Subtotal.porDesc1 
	m.porDesc2 = cur_Subtotal.porDesc2 
	m.porDesc3 = cur_Subtotal.porDesc3 
	m.porDesc4 = cur_Subtotal.porDesc4 
	m.impDesc1 = cur_Subtotal.impDesc1
	m.impDesc2 = cur_Subtotal.impDesc2
	m.impDesc3 = cur_Subtotal.impDesc3
	m.impDesc4 = cur_Subtotal.impDesc4
	m.porIVA105 = cur_Subtotal.porIVA105
	m.porIVA21 = cur_Subtotal.porIVA21
	m.impIVA105 = cur_Subtotal.impIVA105
	m.impIVA21 = cur_Subtotal.impIVA21
	m.impNeto = cur_Subtotal.impFinal
	m.impFinal = cur_Subtotal.impFinal
	m.porIIBB = cur_Subtotal.porIIBB
	m.impIIBB = cur_Subtotal.impIIBB
	
	SET PRINTER TO NAME ALLTRIM(lcPrinterName)
	SELECT cur_aux
ELSE 
	m.porDesc1 = Thisform.Contenido.txtDesc1.Value
	m.porDesc2 = Thisform.Contenido.txtDesc2.Value
	m.porDesc3 = Thisform.Contenido.txtDesc3.Value
	m.porDesc4 = Thisform.Contenido.txtDesc4.Value
	m.impDesc1 = Thisform.Contenido.txtImpDesc1.Value
	m.impDesc2 = Thisform.Contenido.txtImpDesc2.Value
	m.impDesc3 = Thisform.Contenido.txtImpDesc3.Value
	m.impDesc4 = Thisform.Contenido.txtImpDesc4.Value
	m.porIVA105 = Thisform.contenido.txtPorIVA105.Value
	m.porIVA21 = Thisform.Contenido.txtPorIVA21.value
	m.impIVA105 = Thisform.Contenido.txtImpIVA105.Value
	m.impIVA21 = Thisform.Contenido.txtImpIVA21.Value
	m.impNeto = Thisform.Contenido.txtST.Value
	m.impFinal = Thisform.Contenido.txtTotFact.Value
	m.porIIBB = Thisform.Contenido.txtPorIIBB.Value
	m.impIIBB = Thisform.Contenido.txtImpIIBB.Value
	
	SET PRINTER TO NAME ALLTRIM(lcPrinterName)
	SELECT cur_detalle
ENDIF 

IF !(TYPE("thisform.contenido.txtObserv.Value") == "C") THEN
	m.observ = ""
ELSE
	m.observ = thisform.contenido.txtObserv.Value + " "
ENDIF

* Verifico si el checkbox imprimir está activado, si lo está entonces mando el
* presupuesto a la impresora.
IF estandarizar_checkbox_value(Thisform.contenido.chkImprimirCbte.Value) = 1 THEN
	FOR i = 1 TO lnCantCpia
		IF !llUsaTicket THEN
			SET PRINTER TO NAME ALLTRIM(lcPrinterName)
			
			IF (this.cbte == "COT") THEN
				&& Imprime una cotizacion
				SELECT cur_aux
				REPORT FORM "repcot.frx" TO PRINTER NOCONSOLE
			ELSE
				IF (this.cbte == "PTO") THEN
					&& Imprime un presupuesto
					SELECT cur_aux
					REPORT FORM "reppto.frx" TO PRINTER NOCONSOLE			
				ELSE
					&& Si el comprobante es "PED" entonces, tiene que enviar a imprimir una nota de pedido
					IF ALLTRIM(Thisform.cbte) == "PED" THEN
						SET PRINTER TO NAME ALLTRIM(lcPrinterName)
						SELECT cur_detalle
						m.observ = Thisform.contenido.txtObserv.Value
						REPORT FORM "reppedido.frx" TO PRINTER NOCONSOLE
					ELSE 
						IF ALLTRIM(Thisform.tipodoc) == "A" THEN
							&& Imprime el comprobante de tipo "A"
							SELECT cur_aux
							REPORT FORM "repcbtesvta.frx" TO PRINTER NOCONSOLE
						ELSE
							&& Imprime el comprobante de tipo "B"
							SELECT cur_aux
							REPORT FORM "repcbtesvta_b.frx" TO PRINTER NOCONSOLE
						ENDIF
					ENDIF
				ENDIF
			ENDIF
		ELSE
			* Ejecuto el siguiente código si está configurado para usar ticket.
			SET PRINTER TO NAME ALLTRIM(lcPrinterName)
			
			****************************************************************************
			* Envío a imprimir el ticket
			****************************************************************************
			Thisform.oticket = CREATEOBJECT("cls_tickets")
			Thisform.oticket.con_corte = getGlobalCFG("TKT_CORTE")
			Thisform.oticket.crear_cursor()
			Thisform.oticket.limpiar_datos()
			Thisform.oticket.codigo_cbte = "XX"
			Thisform.oticket.leyenda = m.leyenda
			Thisform.oticket.letra = m.tipoDoc
			Thisform.oticket.nro_cbte = m.nroCbte
			Thisform.oticket.fecha_cbte = m.fecha
			Thisform.oticket.fecha_vencimiento = m.fecVto
			Thisform.oticket.numero_cliente = m.NroCli
			Thisform.oticket.razon_social = m.razSoc
			Thisform.oticket.direccion = m.direccion
			Thisform.oticket.codigo_postal = m.codPostal 
			Thisform.oticket.localidad = m.localidad
			Thisform.oticket.provincia = m.pcia
			Thisform.oticket.tipo_iva = m.TipoIVA
			SELECT cur_aux
			GO TOP
			DO WHILE !EOF("cur_aux")
				Thisform.oticket.add_item(cur_aux.codArt, cur_aux.descripcio, cur_aux.cantidad,;
						cur_aux.alicIVA, ROUND(cur_aux.impNeto + cur_aux.impNeto * (cur_aux.alicIVA / 100),2), cur_aux.subtotal)
				SELECT cur_aux
				SKIP
			ENDDO
			Thisform.oticket.total_neto = m.impNeto
			Thisform.oticket.total_imp_iva21 = m.impIVA21
			Thisform.oticket.total_imp_iva105 = m.impIVA105
			Thisform.oticket.total = m.Total
			Thisform.oticket.nro_cae = ""
			THisform.oticket.vto_cae = ""
			Thisform.oticket.imprimir()		
		ENDIF
	NEXT
ENDIF

* Verifico si el enviar mail está activado. Si lo está entonces envío el comprobante
* por mail.
IF estandarizar_checkbox_value(Thisform.Contenido.chkEnviarMail.Value) = 1 THEN
	IF (this.cbte == "COT") THEN
		&& Imprime una cotizacion
		SELECT cur_aux
		=enviar_cbtemail("repcot.frx", ALLTRIM(Thisform.cbte),;
				m.tipoDoc, m.NroCbte, ALLTRIM(Thisform.Contenido.txtMailFC.Value),;
				m.Fecha, m.nroCli, m.razSoc, m.direccion, m.codPostal,;
				m.localidad, m.pcia, m.tipoIVA, m.fecVto, m.nroCUIT	,;
				m.nroOC, m.leyenda, m.impNeto, m.Total, m.impIVA21,;
				m.impIVA105, m.porIIBB, m.impIIBB, m.Total, m.observ)
	ELSE
		IF (this.cbte == "PTO") THEN
			&& Imprime un presupuesto
			SELECT cur_aux
			enviar_cbtemail("reppto.frx",  ALLTRIM(Thisform.cbte),;
					m.tipoDoc, m.NroCbte, ALLTRIM(Thisform.Contenido.txtMailFC.Value),;
					m.Fecha, m.nroCli, m.razSoc, m.direccion, m.codPostal,;
					m.localidad, m.pcia, m.tipoIVA, m.fecVto, m.nroCUIT	,;
					m.nroOC, m.leyenda, m.impNeto, m.Total, m.impIVA21,;
					m.impIVA105, m.porIIBB, m.impIIBB, m.Total, m.observ)
		ELSE
			&& Si el comprobante es "PED" entonces, tiene que enviar a imprimir una nota de pedido
			IF ALLTRIM(Thisform.cbte) == "PED" THEN
				SET PRINTER TO NAME ALLTRIM(lcPrinterName)
				SELECT cur_detalle
				m.observ = Thisform.contenido.txtObserv.Value
				enviar_cbtemail("reppedido.frx",  ALLTRIM(Thisform.cbte),;
						m.tipoDoc, m.NroCbte, ALLTRIM(Thisform.Contenido.txtMailFC.Value),;
						m.Fecha, m.nroCli, m.razSoc, m.direccion, m.codPostal,;
						m.localidad, m.pcia, m.tipoIVA, m.fecVto, m.nroCUIT	,;
						m.nroOC, m.leyenda, m.impNeto, m.Total, m.impIVA21,;
						m.impIVA105, m.porIIBB, m.impIIBB, m.Total, m.observ)
			ELSE 
				IF ALLTRIM(Thisform.tipodoc) == "A" THEN
					&& Imprime el comprobante de tipo "A"
					SELECT cur_aux
					enviar_cbtemail("repcbtesvta.frx",  ALLTRIM(Thisform.cbte),;
							m.tipoDoc, m.NroCbte, ALLTRIM(Thisform.Contenido.txtMailFC.Value),;
							m.Fecha, m.nroCli, m.razSoc, m.direccion, m.codPostal,;
							m.localidad, m.pcia, m.tipoIVA, m.fecVto, m.nroCUIT	,;
							m.nroOC, m.leyenda, m.impNeto, m.Total, m.impIVA21,;
							m.impIVA105, m.porIIBB, m.impIIBB, m.Total, m.observ)
				ELSE
					&& Imprime el comprobante de tipo "B"
					SELECT cur_aux
					enviar_cbtemail("repcbtesvta_b.frx",  ALLTRIM(Thisform.cbte),;
							m.tipoDoc, m.NroCbte, ALLTRIM(Thisform.Contenido.txtMailFC.Value),;
							m.Fecha, m.nroCli, m.razSoc, m.direccion, m.codPostal,;
							m.localidad, m.pcia, m.tipoIVA, m.fecVto, m.nroCUIT	,;
							m.nroOC, m.leyenda, m.impNeto, m.Total, m.impIVA21,;
							m.impIVA105, m.porIIBB, m.impIIBB, m.Total, m.observ)
				ENDIF
			ENDIF
		ENDIF
	ENDIF
ENDIF
ENDPROC
PROCEDURE agregar_item
LOCAL loResult, lcSql, lnSTNeto, lnAlicIva

loResult = CREATEOBJECT("odbc_result")
lcSql = ""
lnSTNeto = 0.00
lnAlicIva = 0.00

SELECT cur_detalle
ZAP 

IF glVersionBeta THEN
	SELECT cur_Deta_View
	IF RECCOUNT() >= 5 THEN
		MESSAGEBOX("Usted está utilizando una versión límitada del sistema, si desea comprarlo envíe un mail a ldz.software@gmail.com", 0+64, Thisform.Caption)
		RETURN .F.
	ENDIF
ENDIF

* Valido si el artículo ya se encuentra cargado en el presupuesto

SELECT cur_Deta_View
IF RECCOUNT("cur_Deta_View") > 0 THEN
	GO TOP
ENDIF

DO WHILE !EOF("cur_Deta_View")
	IF (ALLTRIM(Thisform.cbte) != "PED") THEN 
		IF !thisform.asignar_partida(cur_Deta_View.idArticulo, cur_Deta_View.Cantidad) THEN
			MESSAGEBOX("Ha ocurrido un error al intentar asignar partidas", 0+48, thisform.Caption)
			RETURN .F.
		ENDIF
	ENDIF  
	
	&& Si cur_DetPart es 0 (Cero)
	SELECT cur_DetPart
	IF RECCOUNT("cur_DetPart") = 0 THEN
		SELECT cur_Detalle
		APPEND BLANK
		REPLACE cur_Detalle.idDetalle WITH RECCOUNT("cur_Detalle") + 1
		REPLACE cur_Detalle.idArticulo WITH cur_Deta_View.idArticulo 			ADDITIVE
		REPLACE cur_Detalle.codArt WITH ALLTRIM(cur_Deta_View.codArt)			ADDITIVE
		REPLACE cur_Detalle.descripcio WITH ALLTRIM(cur_Deta_View.descripcio) 	ADDITIVE
		REPLACE cur_Detalle.nroPart WITH "" 									ADDITIVE
		REPLACE cur_Detalle.cantidad WITH cur_Deta_View.cantidad 				ADDITIVE
		REPLACE cur_Detalle.prVta WITH cur_Deta_View.prVta						ADDITIVE
		REPLACE cur_Detalle.prArtic WITH cur_Deta_View.prArtic					ADDITIVE
		REPLACE cur_Detalle.pDtoVta1 WITH cur_Deta_View.pDtoVta1				ADDITIVE
		REPLACE cur_Detalle.pDtoVta2 WITH cur_Deta_View.pDtoVta2				ADDITIVE
		REPLACE cur_Detalle.pDtoVta3 WITH cur_Deta_View.pDtoVta3				ADDITIVE
		REPLACE cur_Detalle.pDtoVta4 WITH cur_Deta_View.pDtoVta4				ADDITIVE
		REPLACE cur_Detalle.iDtoVta1 WITH cur_Deta_View.iDtoVta1				ADDITIVE
		REPLACE cur_Detalle.iDtoVta2 WITH cur_Deta_View.iDtoVta2				ADDITIVE
		REPLACE cur_Detalle.iDtoVta3 WITH cur_Deta_View.iDtoVta3				ADDITIVE
		REPLACE cur_Detalle.iDtoVta4 WITH cur_Deta_View.iDtoVta4				ADDITIVE
		REPLACE cur_Detalle.impNeto WITH cur_Deta_View.impNeto					ADDITIVE
		
		&& Hago el cálculo del IVA y establezco 4 decimales. Hago el calculo aca porque en el cur_deta_view lo tengo en 2 decimales.
		lnAlicIva = cur_Deta_View.alicIVA
		REPLACE cur_Detalle.impIVA WITH ROUND(cur_Deta_View.totNeto * (lnAlicIva / 100), 4) ADDITIVE
		REPLACE cur_Detalle.alicIVA WITH lnAlicIva ADDITIVE
		
*!*			IF (ALLTRIM(Thisform.cbte) == "PTO") THEN
*!*				REPLACE cur_Detalle.impIVA WITH 0 ADDITIVE
*!*				REPLACE cur_Detalle.alicIVA WITH 0 ADDITIVE
*!*			ELSE
*!*				lnAlicIva = cur_Deta_View.alicIVA
*!*				REPLACE cur_Detalle.impIVA WITH ROUND(cur_Deta_View.totNeto * (lnAlicIva / 100), 4) ADDITIVE
*!*				REPLACE cur_Detalle.alicIVA WITH lnAlicIva ADDITIVE
*!*			ENDIF
			
		REPLACE cur_Detalle.totNeto WITH cur_Deta_View.totNeto					ADDITIVE
		REPLACE cur_Detalle.subTotal WITH cur_Deta_View.subTotal				ADDITIVE
		REPLACE cur_Detalle.pDtoCli1 WITH cur_Deta_View.pDtoCli1 				ADDITIVE
		REPLACE cur_Detalle.pDtoCli2 WITH cur_Deta_View.pDtoCli2 				ADDITIVE
		REPLACE cur_Detalle.pDtoCli3 WITH cur_Deta_View.pDtoCli3 				ADDITIVE
		REPLACE cur_Detalle.pDtoCli4 WITH cur_Deta_View.pDtoCli4 				ADDITIVE
		REPLACE cur_Detalle.iDtoCli1 WITH cur_Deta_View.iDtoCli1 				ADDITIVE
		REPLACE cur_Detalle.iDtoCli2 WITH cur_Deta_View.iDtoCli2 				ADDITIVE
		REPLACE cur_Detalle.iDtoCli3 WITH cur_Deta_View.iDtoCli3 				ADDITIVE
		REPLACE cur_Detalle.iDtoCli4 WITH cur_Deta_View.iDtoCli4 				ADDITIVE
		REPLACE cur_Detalle.esOferta WITH cur_Deta_View.esOferta 				ADDITIVE
		REPLACE cur_Detalle.pRecVta WITH cur_Deta_View.pRecVta					ADDITIVE 
		REPLACE cur_Detalle.iRecVta WITH cur_Deta_View.iRecVta					ADDITIVE 
		
		&& Incorporo el recargo por ítem
		REPLACE cur_Detalle.pRecItem WITH cur_Deta_View.pRecItem				ADDITIVE
		REPLACE cur_Detalle.iRecItem WITH cur_Deta_View.iRecItem				ADDITIVE		
		
		REPLACE cur_Detalle.uniDesp WITH cur_Deta_View.uniDesp					ADDITIVE
		REPLACE cur_Detalle.cantPack WITH cur_Deta_View.cantPack				ADDITIVE
		REPLACE cur_Detalle.uniMed WITH cur_Deta_View.uniMed					ADDITIVE		
	ELSE
		*************************************************************************************************
		* Paso por aca en el caso de que el artículo lleve número de partida
		*************************************************************************************************
		SELECT cur_DetPart
		GO TOP

		DO WHILE !EOF("cur_DetPart")
			SELECT cur_Detalle
			APPEND BLANK
			REPLACE cur_Detalle.idDetalle WITH RECCOUNT("cur_Detalle") + 1
			REPLACE cur_Detalle.idArticulo WITH cur_Deta_View.idArticulo 	ADDITIVE
			REPLACE cur_Detalle.codArt WITH cur_Deta_View.codArt	ADDITIVE
			REPLACE cur_Detalle.descripcio WITH IIF(ALLTRIM(cur_DetPart.nroPart) == "", ALLTRIM(cur_Deta_View.Descripcio), ALLTRIM(SUBSTR(cur_Deta_View.Descripcio, 1, 20)) + " (" + ALLTRIM(cur_DetPart.nroPart) + ")") ADDITIVE
			REPLACE cur_Detalle.nroPart WITH cur_DetPart.nroPart ADDITIVE
			REPLACE cur_Detalle.cantidad WITH cur_DetPart.cantidad ADDITIVE
			REPLACE cur_Detalle.prVta WITH cur_Deta_View.prVta ADDITIVE
			REPLACE cur_Detalle.prArtic WITH cur_Deta_View.prArtic ADDITIVE			
			REPLACE cur_Detalle.pDtoVta1 WITH cur_Deta_View.pDtoVta1				ADDITIVE
			REPLACE cur_Detalle.pDtoVta2 WITH cur_Deta_View.pDtoVta2				ADDITIVE
			REPLACE cur_Detalle.pDtoVta3 WITH cur_Deta_View.pDtoVta3				ADDITIVE
			REPLACE cur_Detalle.pDtoVta4 WITH cur_Deta_View.pDtoVta4				ADDITIVE
			REPLACE cur_Detalle.iDtoVta1 WITH cur_Deta_View.iDtoVta1				ADDITIVE
			REPLACE cur_Detalle.iDtoVta2 WITH cur_Deta_View.iDtoVta2				ADDITIVE
			REPLACE cur_Detalle.iDtoVta3 WITH cur_Deta_View.iDtoVta3				ADDITIVE
			REPLACE cur_Detalle.iDtoVta4 WITH cur_Deta_View.iDtoVta4				ADDITIVE
			REPLACE cur_Detalle.impNeto  WITH cur_Deta_View.impNeto					ADDITIVE

			lnSTNeto = ROUND(cur_Deta_View.impNeto * cur_DetPart.Cantidad, 2)
			
			&& Hago el cálculo del IVA y establezco 4 decimales. 
			IF (ALLTRIM(Thisform.cbte) == "PTO") THEN
				REPLACE cur_Detalle.impIVA WITH 0 ADDITIVE
				REPLACE cur_Detalle.alicIVA WITH 0 ADDITIVE
			ELSE
				lnAlicIva = cur_Deta_View.alicIVA
				REPLACE cur_Detalle.impIVA WITH ROUND(lnSTNeto  * (lnAlicIva / 100), 4) ADDITIVE
				REPLACE cur_Detalle.alicIVA WITH lnAlicIva ADDITIVE
			ENDIF
			
			REPLACE cur_Detalle.totNeto WITH lnSTNeto ADDITIVE
			REPLACE cur_Detalle.subTotal WITH lnSTNeto + cur_Detalle.impIVA ADDITIVE

			REPLACE cur_Detalle.pDtoCli1 WITH cur_Deta_View.pDtoCli1 ADDITIVE
			REPLACE cur_Detalle.pDtoCli2 WITH cur_Deta_View.pDtoCli2 ADDITIVE
			REPLACE cur_Detalle.pDtoCli3 WITH cur_Deta_View.pDtoCli3 ADDITIVE
			REPLACE cur_Detalle.pDtoCli4 WITH cur_Deta_View.pDtoCli4 ADDITIVE
			REPLACE cur_Detalle.iDtoCli1 WITH cur_Deta_View.iDtoCli1 ADDITIVE
			REPLACE cur_Detalle.iDtoCli2 WITH cur_Deta_View.iDtoCli2 ADDITIVE
			REPLACE cur_Detalle.iDtoCli3 WITH cur_Deta_View.iDtoCli3 ADDITIVE
			REPLACE cur_Detalle.iDtoCli4 WITH cur_Deta_View.iDtoCli4 ADDITIVE
			REPLACE cur_Detalle.esOferta WITH cur_Deta_View.esOferta ADDITIVE
			REPLACE cur_Detalle.pRecVta WITH cur_Deta_View.pRecVta ADDITIVE 
			REPLACE cur_Detalle.iRecVta WITH cur_Deta_View.iRecVta ADDITIVE 
			
			&& Incorporo el recargo por ítem
			REPLACE cur_Detalle.pRecItem WITH cur_Deta_View.pRecItem ADDITIVE
			REPLACE cur_Detalle.iRecItem WITH cur_Deta_View.iRecItem ADDITIVE
			
			REPLACE cur_Detalle.uniDesp WITH cur_Deta_View.uniDesp ADDITIVE
			REPLACE cur_Detalle.cantPack WITH cur_Deta_View.cantPack ADDITIVE
			REPLACE cur_Detalle.uniMed WITH cur_Deta_View.uniMed ADDITIVE	
					
			SELECT cur_DetPart
			SKIP
		ENDDO	
	ENDIF
	
	SELECT cur_Deta_View
	SKIP
ENDDO

RETURN .T.

ENDPROC
PROCEDURE contenido.sel_Cliente.recuperar_datos
LOCAL lo_rsSitIVA, lo_rsCondPago, lo_rsLocalidad, lo_rsPcia, lo_rsIIBB, lcSql
LOCAL lo_rsTipoDoc, lnResp, lorsFalt

lo_rsSitIVA = CREATEOBJECT("odbc_result")
lo_rsCondPago = CREATEOBJECT("odbc_result")
lo_rsLocalidad = CREATEOBJECT("odbc_result")
lo_rsPcia = CREATEOBJECT("odbc_result")
lo_rsIIBB = CREATEOBJECT("odbc_result")
lo_rsTipoDoc = CREATEOBJECT("odbc_result")
loRsFalt = CREATEOBJECT("odbc_result")
lcSql = ""

IF Thisform.contenido.sel_Cliente.txtCodigo.Value == 0 THEN 
	Thisform.contenido.sel_Cliente.txtDescripcion.Value = ""
	RETURN .F.
ENDIF 

SELECT clientes
IF !clientes.habilitado THEN 
	MESSAGEBOX("Este cliente no está habilitado, por favor, verifique el estado del cliente", 0+48, Thisform.Caption)
	this.valcpoid = 0
	this.blanquear()
	this.txtcodigo.SetFocus()
	
	RETURN .F.
ENDIF 

IF ALLTRIM(thisform.cbte) == "FC" .OR. ALLTRIM(thisform.cbte) == "PED" THEN
	IF clientes.contrCM THEN
		thisform.calcular_saldo_dedudor()
		
		IF thisform.saldodeudor > clientes.credMax THEN
			MESSAGEBOX("El saldo deudor supera al crédito máximo otorgado", 0+48, Thisform.Caption)
			RETURN .F.
		ENDIF
	ENDIF
ENDIF

Thisform.contenido.txtDesc1.Value = clientes.desc1
Thisform.contenido.txtDesc2.Value = clientes.desc2
Thisform.contenido.txtDesc3.Value = clientes.desc3
Thisform.contenido.txtDesc4.Value = clientes.desc4
Thisform.cli_calle = clientes.direccion
Thisform.cli_cuit = clientes.nroCUIT
Thisform.cli_telefono = clientes.telefono
Thisform.cli_Id = clientes.idCliente
Thisform.contenido.txttelefono.Value = clientes.telefono
Thisform.contenido.txtcuit.Value = clientes.nrocuit
Thisform.envcbte = clientes.envcbte
Thisform.contenido.chkEnviarMail.Value = clientes.envcbte
Thisform.mailfc = ALLTRIM(clientes.mailFC)
Thisform.contenido.chkImprimirCbte.Value = clientes.printcbte
Thisform.Contenido.txtMailFC.Value = ALLTRIM(clientes.mailFC)
Thisform.printcbte = clientes.printcbte

&& Levanto el codigo de tipo de documento
lcSql = "SELECT * FROM tipodoc WHERE idTipoDoc = " + ALLTRIM(STR(clientes.idTipoDoc))
lo_rsTipoDoc.ActiveConnection = goConn.ActiveConnection
lo_rsTipoDoc.Cursor_Name = "cur_tipodoc"
lo_rsTipoDoc.OpenQuery(lcSql)

SELECT cur_tipodoc
Thisform.cli_tipodoc = cur_tipodoc.tipodoc
Thisform.cli_idtipodoc = clientes.idTipoDoc

IF !(ALLTRIM(Thisform.cli_tipodoc) == "CUIT" .OR. ALLTRIM(Thisform.cli_tipodoc) == "CUIL") THEN
	This.Parent.txtCuit.InputMask = ""
ELSE
	This.Parent.txtCuit.InputMask = "XX-XXXXXXXX-XX"
ENDIF

lo_rsTipoDoc.close_query()

lcSql = "SELECT * FROM localidad WHERE idLocalid = " + ALLTRIM(STR(clientes.idLocalid))
lo_rsLocalidad.ActiveConnection = goConn.ActiveConnection
lo_rsLocalidad.Cursor_Name = "cur_Localid"
lo_rsLocalidad.OpenQuery(lcSql)

SELECT cur_Localid
Thisform.cli_localidad = cur_Localid.descripcio
Thisform.cli_codpostal = cur_Localid.codPostal

lcSql = "SELECT * FROM provincias WHERE idProvin = " + ALLTRIM(STR(cur_Localid.idProvin))
lo_rsPcia.ActiveConnection = goConn.ActiveConnection
lo_rsPcia.Cursor_Name = "cur_Pcia"
lo_rsPcia.OpenQuery(lcSql)

SELECT cur_Pcia
Thisform.cli_pcia = cur_Pcia.descripcio

lo_rsPcia.close_query()
lo_rsLocalidad.close_query()

lcSql = "SELECT * FROM sitiva WHERE idSitIVA = " + ALLTRIM(STR(clientes.idSitIVA))
lo_rsSitIVA.ActiveConnection = goConn.ActiveConnection
lo_rsSitIVA.Cursor_Name = "cur_SitIVA"
lo_rsSitIVA.OpenQuery(lcSql)

SELECT cur_SitIVA
Thisform.contenido.txtSitIVA.Value = cur_SitIVA.descripcio
Thisform.sitivacli = cur_SitIVA.idSitIVA
Thisform.CodIVAFiscal = cur_SitIVA.CodFiscal

lo_rsSitIVA.close_query()

lcSql = "SELECT * FROM condpagos WHERE idCondPago = " + ALLTRIM(STR(clientes.idCondPago))
lo_rsCondPago.ActiveConnection = goConn.ActiveConnection
lo_rsCondPago.Cursor_Name = "cur_CondPago"
lo_rsCondPago.OpenQuery(lcSql)

SELECT cur_CondPago
Thisform.contenido.sel_FormaPago.valcpoid = cur_CondPago.idCondPago
Thisform.contenido.sel_FormaPago.txtCodigo.Value = cur_CondPago.idCondPago
Thisform.contenido.sel_FormaPago.txtDescripcion.Value = cur_CondPago.Descripcio
Thisform.cp_cntdias = cur_CondPago.cntDias
Thisform.idCondPago = cur_CondPago.idCondPago

lo_rsCondPago.close_query()

IF ALLTRIM(Thisform.cbte) <> "PTO" THEN 
	lcSql = "SELECT * FROM padronib WHERE cuit = '" + ALLTRIM(STRTRAN(clientes.nrocuit,"-","")) + "'"
	lo_rsIIBB.ActiveConnection = goConn.ActiveConnection
	lo_rsIIBB.Cursor_Name = "cur_PadronIB"
	lo_rsIIBB.OpenQuery(lcSql)

	SELECT cur_PadronIB
	IF RECCOUNT("cur_PadronIB") > 0 THEN
		Thisform.contenido.txtPorIIBB.Value = cur_PadronIB.AlicuotaPer
	ELSE 
		Thisform.contenido.txtPorIIBB.Value = 0.00
	ENDIF 

	lo_rsIIBB.close_query()
ENDIF 

Thisform.contenido.txtPorRec.Value = IIF(ISNULL(clientes.recargo), 0.00, clientes.recargo)

IF ALLTRIM(thisform.cbte) != "NC" THEN 
	thisform.recalcular_todo()
ENDIF

IF ALLTRIM(thisform.cbte) == "FC" .OR. ALLTRIM(thisform.cbte) == "PED" THEN
	IF clientes.ctrMoro THEN
		thisform.mostrar_morosidad()
	ENDIF	
ENDIF

IF This.valcpoid = getglobalcfg("CLI_CF") THEN
	This.txtDescripcion.ReadOnly = .F.
	This.txtDescripcion.Enabled = .T.
	Thisform.contenido.txtCuit.Enabled = .T.		
	Thisform.contenido.txtCuit.ReadOnly = .F.
ELSE
	This.txtDescripcion.ReadOnly = .T.
	This.txtDescripcion.Enabled = .F.
	Thisform.contenido.txtPrMinorista.ReadOnly = .T.
	Thisform.contenido.txtPrMinorista.Enabled = .F.
	Thisform.contenido.txtCuit.Enabled = .F.
	Thisform.contenido.txtCuit.ReadOnly = .T.
	
	IF ALLTRIM(thisform.cbte) == "PED" THEN
		lcSql = "SELECT * "
		lcSql = lcSql + "FROM faltantes "
		lcSql = lcSql + "WHERE idCliente = " + ALLTRIM(STR(This.valcpoid)) + " "
		lcSql = lcSql + "	AND fecBaja IS NULL"
		
		loRsFalt.ActiveConnection = goConn.ActiveConnection
		loRsFalt.Cursor_Name = "cur_x"
		
		IF !loRsFalt.OpenQuery(lcSql) THEN
			MESSAGEBOX(loRsFalt.Error_Message, 0+48, Thisform.Caption)
		ELSE
			SELECT cur_x
			IF RECCOUNT("cur_x") > 0 THEN
				lnResp = MESSAGEBOX("Este cliente tiene faltantes de pedidos anteriores, ¿desea incorporarlos?", 4+32, Thisform.Caption)
				IF lnResp = 6 THEN
					Thisform.leer_faltantes()
				ENDIF
			ENDIF
		
			loRsFalt.Close_Query()
		ENDIF
	ENDIF
ENDIF
ENDPROC
PROCEDURE contenido.sel_Articulo.recuperar_datos
LOCAL lnPorDesc1, lnPorDesc2, lnPorDesc3, lnPorDesc4
LOCAL lnImpDesc1, lnImpDesc2, lnImpDesc3, lnImpDesc4
LOCAL lnPrVtaMax, lnPrVtaMin, lnImpOfert
LOCAL loResult, lcSql

lnPorDesc1 = Thisform.contenido.txtDesc1.Value
lnPorDesc2 = Thisform.contenido.txtDesc2.Value
lnPorDesc3 = Thisform.contenido.txtDesc3.Value
lnPorDesc4 = Thisform.contenido.txtDesc4.Value
lnImpDesc1 = 0.00
lnImpDesc2 = 0.00
lnImpDesc3 = 0.00
lnImpDesc4 = 0.00
lnPrVtaMax = 0.00
lnPrVtaMin = 0.00
lnImpOfert = 0.00
lcSql = ""
loResult = CREATEOBJECT("odbc_result")

SELECT articulos
IF !articulos.habilitado THEN
	MESSAGEBOX("Este artículo no se puede facturar ya que está inhabilitado, dirijase a Archivos / Artículos y " + ;
		"habilitelo para poder facturar o comuniquese con la persona responsable que haya deshabilitado el mismo.", 0+48, Thisform.Caption)
		
	this.txtCodigo.SetFocus()
	RETURN .F.
ENDIF

lcSql = "select * from unidmed where idUniMed = " + ALLTRIM(STR(articulos.idUniMed))

loResult.ActiveConnection = goConn.ActiveConnection
loResult.Cursor_Name = "cur_x"

IF !loResult.OpenQuery(lcSql) THEN
	MESSAGEBOX(loResult.Error_Message, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

SELECT cur_x
IF RECCOUNT("cur_x") > 0 THEN
	thisform.unimed = cur_x.codUM
ENDIF

loResult.close_query()

lnImpOfert = thisform.get_precio_oferta()

IF lnImpOfert = 0 THEN
	SELECT articulos
	lnPrVtaMax = articulos.prVentaMax
	lnPrVtaMin = articulos.prVentaMin
ELSE
	lnPrVtaMin = lnImpOfert
	thisform.pr_oferta = lnImpOfert
ENDIF

SELECT articulos
lnPrVtaMax = articulos.prVentaMax

thisform.pr_mayorista = lnPrVtaMax
thisform.pr_minorista = lnPrVtaMin

lnImpDesc1 = ROUND(lnPrVtaMax * (lnPorDesc1 / 100),2)
IF lnImpOfert = 0 THEN
	lnImpDesc2 = ROUND((lnPrVtaMax - lnImpDesc1) * (lnPorDesc2 / 100),2)
	lnImpDesc3 = ROUND((lnPrVtaMax - lnImpDesc1 - lnImpDesc2) * (lnPorDesc3 / 100),2)
	lnImpDesc4 = ROUND((lnPrVtaMax - lnImpDesc1 - lnImpDesc2 - lnImpDesc3) * (lnPorDesc4 /100),2)
ENDIF

lnPrVtaMax = lnPrVtaMax - lnImpDesc1 - lnImpDesc2 - lnImpDesc3 - lnImpDesc4
Thisform.contenido.txtPrMay.Value = lnPrVtaMax 

lnImpDesc1 = ROUND(lnPrVtaMin * (lnPorDesc1 / 100),2)
lnImpDesc2 = ROUND((lnPrVtaMin - lnImpDesc1) * (lnPorDesc2 / 100),2)
lnImpDesc3 = ROUND((lnPrVtaMin - lnImpDesc1 - lnImpDesc2) * (lnPorDesc3 / 100),2)
lnImpDesc4 = ROUND((lnPrVtaMin - lnImpDesc1 - lnImpDesc2 - lnImpDesc3) * (lnPorDesc4 /100),2)

lnPrVtaMin = lnPrVtaMin - lnImpDesc1 - lnImpDesc2 - lnImpDesc3 - lnImpDesc4
Thisform.contenido.txtPrMinorista.Value = lnPrVtaMin
Thisform.prFinalAnt = lnPrVtaMin

thisform.contenido.txtAlicIVA.Value = articulos.alicIVA
Thisform.Contenido.txtExistencia.Value = Thisform.mov_stock.get_exist_byart(Thisform.contenido.sel_Articulo.valcpoid)
IF clientes.mayorista THEN
	Thisform.contenido.txtPrUnitFinal.Value = lnPrVtaMax * (1 + (articulos.alicIVA / 100))
ELSE
	Thisform.contenido.txtPrUnitFinal.Value = lnPrVtaMin * (1 + (articulos.alicIVA / 100))
ENDIF

* Agrego esto para el artículo "X"
IF RIGHT(ALLTRIM(This.txtCodigo.Value), 3) == "ARX" THEN
	This.txtDescripcion.Enabled = .T.
	This.txtDescripcion.ReadOnly = .F.
*!*		This.Parent.txtPrMinorista.Enabled = .T.
*!*		This.Parent.txtPrMinorista.ReadOnly = .F.
ELSE
	This.Parent.txtPrMinorista.Enabled = .F.
	This.Parent.txtPrMinorista.ReadOnly = .T.
ENDIF

Thisform.calc_item_desc()



ENDPROC


************************************************************
OBJETO: 
************************************************************
*** PROPIEDADES ***
Arial, 0, 9, 5, 15, 12, 32, 3, 0
Arial, 1, 8, 5, 14, 11, 29, 3, 0
Arial, 1, 11, 7, 18, 14, 39, 4, 0
Arial, 1, 9, 6, 15, 12, 32, 3, 0

*** METODOS ***


