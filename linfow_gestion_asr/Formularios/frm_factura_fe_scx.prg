************************************************************
OBJETO: Dataenvironment
************************************************************
*** PROPIEDADES ***
Top = 0
Left = 0
Width = 0
Height = 0
DataSource = .NULL.
Name = "Dataenvironment"

*** METODOS ***


************************************************************
OBJETO: FRM_FACTURA_FE
************************************************************
*** PROPIEDADES ***
DoCreate = .T.
cbte = FC
Name = "FRM_FACTURA_FE"
contenido.Clsetiqueta1.TabIndex = 41
contenido.Clsetiqueta1.Name = "Clsetiqueta1"
contenido.sel_Cliente.txtCodigo.Name = "txtCodigo"
contenido.sel_Cliente.txtDescripcion.Name = "txtDescripcion"
contenido.sel_Cliente.TabIndex = 1
contenido.sel_Cliente.Name = "sel_Cliente"
contenido.Clsetiqueta2.TabIndex = 43
contenido.Clsetiqueta2.Name = "Clsetiqueta2"
contenido.Clsetiqueta3.TabIndex = 44
contenido.Clsetiqueta3.Name = "Clsetiqueta3"
contenido.txtSitIVA.TabIndex = 32
contenido.txtSitIVA.Name = "txtSitIVA"
contenido.sel_FormaPago.txtCodigo.Name = "txtCodigo"
contenido.sel_FormaPago.txtDescripcion.Name = "txtDescripcion"
contenido.sel_FormaPago.TabIndex = 3
contenido.sel_FormaPago.Name = "sel_FormaPago"
contenido.Clslinea1.Name = "Clslinea1"
contenido.Clsetiqueta4.TabIndex = 45
contenido.Clsetiqueta4.Name = "Clsetiqueta4"
contenido.sel_Articulo.txtCodigo.Name = "txtCodigo"
contenido.sel_Articulo.txtDescripcion.Name = "txtDescripcion"
contenido.sel_Articulo.TabIndex = 5
contenido.sel_Articulo.Name = "sel_Articulo"
contenido.Clsetiqueta5.TabIndex = 47
contenido.Clsetiqueta5.Name = "Clsetiqueta5"
contenido.txtCantidad.TabIndex = 7
contenido.txtCantidad.Name = "txtCantidad"
contenido.btnAgregar.TabIndex = 10
contenido.btnAgregar.Name = "btnAgregar"
contenido.grdDetalles.COLUMN1.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN1.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN1.Name = "COLUMN1"
contenido.grdDetalles.COLUMN2.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN2.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN2.Name = "COLUMN2"
contenido.grdDetalles.COLUMN3.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN3.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN3.Name = "COLUMN3"
contenido.grdDetalles.COLUMN4.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN4.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN4.Name = "COLUMN4"
contenido.grdDetalles.COLUMN5.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN5.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN5.Name = "COLUMN5"
contenido.grdDetalles.COLUMN6.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN6.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN6.Name = "COLUMN6"
contenido.grdDetalles.COLUMN7.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN7.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN7.Name = "COLUMN7"
contenido.grdDetalles.COLUMN8.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN8.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN8.Name = "COLUMN8"
contenido.grdDetalles.COLUMN9.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN9.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN9.Name = "COLUMN9"
contenido.grdDetalles.COLUMN10.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN10.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN10.Name = "COLUMN10"
contenido.grdDetalles.COLUMN11.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN11.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN11.Name = "COLUMN11"
contenido.grdDetalles.COLUMN12.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN12.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN12.Name = "COLUMN12"
contenido.grdDetalles.COLUMN13.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN13.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN13.Name = "COLUMN13"
contenido.grdDetalles.COLUMN14.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN14.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN14.Name = "COLUMN14"
contenido.grdDetalles.COLUMN15.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN15.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN15.Name = "COLUMN15"
contenido.grdDetalles.COLUMN16.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN16.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN16.Name = "COLUMN16"
contenido.grdDetalles.COLUMN17.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN17.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN17.Name = "COLUMN17"
contenido.grdDetalles.COLUMN18.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN18.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN18.Name = "COLUMN18"
contenido.grdDetalles.COLUMN19.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN19.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN19.Name = "COLUMN19"
contenido.grdDetalles.COLUMN20.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN20.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN20.Name = "COLUMN20"
contenido.grdDetalles.TabIndex = 48
contenido.grdDetalles.Name = "grdDetalles"
contenido.btnGrabar.TabIndex = 12
contenido.btnGrabar.Name = "btnGrabar"
contenido.btnCancelar.TabIndex = 15
contenido.btnCancelar.Name = "btnCancelar"
contenido.Clscerrar1.TabIndex = 13
contenido.Clscerrar1.Name = "Clscerrar1"
contenido.Clsetiqueta10.TabIndex = 71
contenido.Clsetiqueta10.Name = "Clsetiqueta10"
contenido.txtPrMay.TabIndex = 30
contenido.txtPrMay.Name = "txtPrMay"
contenido.Clsetiqueta11.TabIndex = 73
contenido.Clsetiqueta11.Name = "Clsetiqueta11"
contenido.txtPrMinorista.TabIndex = 8
contenido.txtPrMinorista.Name = "txtPrMinorista"
contenido.Clsetiqueta12.TabIndex = 80
contenido.Clsetiqueta12.Name = "Clsetiqueta12"
contenido.txtAlicIVA.TabIndex = 81
contenido.txtAlicIVA.Name = "txtAlicIVA"
contenido.btnEliminar.TabIndex = 11
contenido.btnEliminar.Name = "btnEliminar"
contenido.chkImprimeDup.Alignment = 0
contenido.chkImprimeDup.TabIndex = 88
contenido.chkImprimeDup.Name = "chkImprimeDup"
contenido.btnCbteOrigen.TabIndex = 31
contenido.btnCbteOrigen.Name = "btnCbteOrigen"
contenido.txtObserv.TabIndex = 29
contenido.txtObserv.Name = "txtObserv"
contenido.Clsetiqueta6.TabIndex = 50
contenido.Clsetiqueta6.Name = "Clsetiqueta6"
contenido.Clsetiqueta7.TabIndex = 54
contenido.Clsetiqueta7.Name = "Clsetiqueta7"
contenido.Clsetiqueta8.TabIndex = 56
contenido.Clsetiqueta8.Name = "Clsetiqueta8"
contenido.Clsetiqueta9.TabIndex = 57
contenido.Clsetiqueta9.Name = "Clsetiqueta9"
contenido.txtTotNeto.TabIndex = 59
contenido.txtTotNeto.Name = "txtTotNeto"
contenido.txtPorIVA21.TabIndex = 62
contenido.txtPorIVA21.Name = "txtPorIVA21"
contenido.txtPorIVA105.TabIndex = 63
contenido.txtPorIVA105.Name = "txtPorIVA105"
contenido.txtImpIVA21.TabIndex = 65
contenido.txtImpIVA21.Name = "txtImpIVA21"
contenido.txtImpIVA105.TabIndex = 66
contenido.txtImpIVA105.Name = "txtImpIVA105"
contenido.txtTotal.TabIndex = 67
contenido.txtTotal.Name = "txtTotal"
contenido.Clsetiqueta14.TabIndex = 83
contenido.Clsetiqueta14.Name = "Clsetiqueta14"
contenido.txtDesc1.TabIndex = 17
contenido.txtDesc1.Name = "txtDesc1"
contenido.txtDesc2.TabIndex = 19
contenido.txtDesc2.Name = "txtDesc2"
contenido.txtDesc3.TabIndex = 20
contenido.txtDesc3.Name = "txtDesc3"
contenido.txtDesc4.TabIndex = 21
contenido.txtDesc4.Name = "txtDesc4"
contenido.txtImpDesc1.TabIndex = 36
contenido.txtImpDesc1.Name = "txtImpDesc1"
contenido.txtImpDesc2.TabIndex = 37
contenido.txtImpDesc2.Name = "txtImpDesc2"
contenido.txtImpDesc3.TabIndex = 38
contenido.txtImpDesc3.Name = "txtImpDesc3"
contenido.txtImpDesc4.TabIndex = 39
contenido.txtImpDesc4.Name = "txtImpDesc4"
contenido.Clsetiqueta15.TabIndex = 82
contenido.Clsetiqueta15.Name = "Clsetiqueta15"
contenido.Clsetiqueta16.TabIndex = 85
contenido.Clsetiqueta16.Name = "Clsetiqueta16"
contenido.Clsetiqueta17.FontSize = 11
contenido.Clsetiqueta17.Height = 15
contenido.Clsetiqueta17.Left = 765
contenido.Clsetiqueta17.Top = 463
contenido.Clsetiqueta17.Width = 56
contenido.Clsetiqueta17.TabIndex = 58
contenido.Clsetiqueta17.ForeColor = 255,0,0
contenido.Clsetiqueta17.Name = "Clsetiqueta17"
contenido.txtTotFact.FontSize = 11
contenido.txtTotFact.Height = 29
contenido.txtTotFact.Left = 813
contenido.txtTotFact.TabIndex = 68
contenido.txtTotFact.Top = 457
contenido.txtTotFact.Width = 174
contenido.txtTotFact.ForeColor = 255,0,0
contenido.txtTotFact.Name = "txtTotFact"
contenido.Clsetiqueta18.TabIndex = 55
contenido.Clsetiqueta18.Name = "Clsetiqueta18"
contenido.txtPorIIBB.TabIndex = 61
contenido.txtPorIIBB.Name = "txtPorIIBB"
contenido.txtImpIIBB.TabIndex = 64
contenido.txtImpIIBB.Name = "txtImpIIBB"
contenido.Clsetiqueta19.TabIndex = 84
contenido.Clsetiqueta19.Name = "Clsetiqueta19"
contenido.txtST.TabIndex = 60
contenido.txtST.Name = "txtST"
contenido.Clsetiqueta20.TabIndex = 70
contenido.Clsetiqueta20.Name = "Clsetiqueta20"
contenido.txtPorDesc1.TabIndex = 25
contenido.txtPorDesc1.Name = "txtPorDesc1"
contenido.txtImpDescItem1.TabIndex = 89
contenido.txtImpDescItem1.Name = "txtImpDescItem1"
contenido.txtPorDesc2.TabIndex = 26
contenido.txtPorDesc2.Name = "txtPorDesc2"
contenido.txtImpDescItem2.TabIndex = 90
contenido.txtImpDescItem2.Name = "txtImpDescItem2"
contenido.txtPorDesc3.TabIndex = 27
contenido.txtPorDesc3.Name = "txtPorDesc3"
contenido.txtImpDescItem3.TabIndex = 91
contenido.txtImpDescItem3.Name = "txtImpDescItem3"
contenido.txtPorDesc4.TabIndex = 28
contenido.txtPorDesc4.Name = "txtPorDesc4"
contenido.txtImpDescItem4.TabIndex = 92
contenido.txtImpDescItem4.Name = "txtImpDescItem4"
contenido.Clsetiqueta21.TabIndex = 79
contenido.Clsetiqueta21.Name = "Clsetiqueta21"
contenido.txtImpIVA.TabIndex = 93
contenido.txtImpIVA.Name = "txtImpIVA"
contenido.Clsetiqueta22.TabIndex = 74
contenido.Clsetiqueta22.Name = "Clsetiqueta22"
contenido.txtSTNeto.TabIndex = 77
contenido.txtSTNeto.Name = "txtSTNeto"
contenido.Clsetiqueta13.TabIndex = 86
contenido.Clsetiqueta13.Name = "Clsetiqueta13"
contenido.txtSubTotal.TabIndex = 87
contenido.txtSubTotal.Name = "txtSubTotal"
contenido.Clsetiqueta23.TabIndex = 72
contenido.Clsetiqueta23.Name = "Clsetiqueta23"
contenido.txtPrNeto.TabIndex = 76
contenido.txtPrNeto.Name = "txtPrNeto"
contenido.lblExistencia.TabIndex = 78
contenido.lblExistencia.Name = "lblExistencia"
contenido.txtExistencia.TabIndex = 94
contenido.txtExistencia.Name = "txtExistencia"
contenido.Clsetiqueta24.TabIndex = 52
contenido.Clsetiqueta24.Name = "Clsetiqueta24"
contenido.txtPorRec.TabIndex = 16
contenido.txtPorRec.Name = "txtPorRec"
contenido.txtImpRec.TabIndex = 95
contenido.txtImpRec.Name = "txtImpRec"
contenido.txtRecItem.TabIndex = 40
contenido.txtRecItem.Name = "txtRecItem"
contenido.Clsetiqueta25.TabIndex = 42
contenido.Clsetiqueta25.Name = "Clsetiqueta25"
contenido.txtTelefono.TabIndex = 33
contenido.txtTelefono.Name = "txtTelefono"
contenido.Clsetiqueta26.TabIndex = 23
contenido.Clsetiqueta26.Name = "Clsetiqueta26"
contenido.txtcuit.TabIndex = 2
contenido.txtcuit.Name = "txtcuit"
contenido.Clsetiqueta27.TabIndex = 46
contenido.Clsetiqueta27.Name = "Clsetiqueta27"
contenido.cboUnidVta.TabIndex = 6
contenido.cboUnidVta.Name = "cboUnidVta"
contenido.txtCantPack.TabIndex = 24
contenido.txtCantPack.Name = "txtCantPack"
contenido.Clsetiqueta28.TabIndex = 51
contenido.Clsetiqueta28.Name = "Clsetiqueta28"
contenido.txtOC.TabIndex = 35
contenido.txtOC.Name = "txtOC"
contenido.Clsetiqueta29.TabIndex = 69
contenido.Clsetiqueta29.Name = "Clsetiqueta29"
contenido.txtPorRecItem.TabIndex = 22
contenido.txtPorRecItem.Name = "txtPorRecItem"
contenido.Clsetiqueta30.TabIndex = 49
contenido.Clsetiqueta30.Name = "Clsetiqueta30"
contenido.txtFecEmis.TabIndex = 4
contenido.txtFecEmis.Name = "txtFecEmis"
contenido.CLSETIQUETA31.TabIndex = 53
contenido.CLSETIQUETA31.Name = "CLSETIQUETA31"
contenido.TXTMAILFC.TabIndex = 14
contenido.TXTMAILFC.Name = "TXTMAILFC"
contenido.CHKENVIARMAIL.Alignment = 0
contenido.CHKENVIARMAIL.TabIndex = 18
contenido.CHKENVIARMAIL.Name = "CHKENVIARMAIL"
contenido.lblPrecioUnitFinal.TabIndex = 75
contenido.lblPrecioUnitFinal.Name = "lblPrecioUnitFinal"
contenido.txtPrUnitFinal.TabIndex = 9
contenido.txtPrUnitFinal.Name = "txtPrUnitFinal"
contenido.chkImprimirCbte.Alignment = 0
contenido.chkImprimirCbte.Name = "chkImprimirCbte"
contenido.btnAgregarCliente.Name = "btnAgregarCliente"
contenido.CLSETIQUETA32.Name = "CLSETIQUETA32"
contenido.TXT_SUBTOTAL_NO_GRAV.Name = "TXT_SUBTOTAL_NO_GRAV"
contenido.CLSETIQUETA33.Name = "CLSETIQUETA33"
contenido.TXT_TOTAL_NO_GRAV.Name = "TXT_TOTAL_NO_GRAV"
contenido.Name = "contenido"
mov_stock.Name = "mov_stock"
faltantes.Name = "faltantes"
fe.Top = 444
fe.Left = 624
fe.Height = 24
fe.Width = 36
fe.Name = "fe"

*** METODOS ***
PROCEDURE Init
DODEFAULT()
Thisform.contenido.sel_Cliente.txtCodigo.SetFocus()
Thisform.contenido.sel_Cliente.txtCodigo.Value = getGlobalCFG("CLI_CF")
Thisform.contenido.sel_Articulo.txtCodigo.SetFocus()
Thisform.contenido.txtCuit.Value = "11111111"

ENDPROC
PROCEDURE recalcular_todo
LOCAL lo_artic, lcSql
LOCAL lnPorDesc1, lnPorDesc2, lnPorDesc3, lnPorDesc4
LOCAL lnImpDesc1, lnImpDesc2, lnImpDesc3, lnImpDesc4
LOCAL lnPrVtaMax, lnPrVtaMin, lnPrecio, lnNeto, lnSubTotNeto
LOCAL lnPorRec, lnImpRec, lnPrOferta, llEsOferta, lnImpRecItem
LOCAL lnBaseGrav, lnSubtNoGrav, lnImpIVA

lcSql = ""
lo_artic = CREATEOBJECT("odbc_result")
lnPrOferta = 0.00
llEsOferta = .F.
lnBaseGrav = 0.00
lnSubtNoGrav = 0.00
lnImpIVA = 0.00

SELECT cur_Deta_View
IF RECCOUNT("cur_Deta_View") > 0 THEN
	GO TOP
ENDIF

&& Recalculo los datos de la grilla
DO WHILE !EOF("cur_Deta_View")
	lcSql = "SELECT * FROM articulos WHERE articulos.idArticulo = " + ALLTRIM(STR(cur_Deta_View.idArticulo))

	lo_artic.ActiveConnection = goConn.ActiveConnection
	lo_artic.cursor_name = "tmp_artic"
	
	IF !lo_artic.OpenQuery(lcSql) THEN
		MESSAGEBOX(lo_artic.error_Message, 0+16, Thisform.Caption)
		RETURN .F.
	ENDIF
	lnPrOferta = thisform.getoferta_byart(cur_Deta_View.idArticulo)
	SELECT tmp_artic
	IF RECCOUNT() > 0 THEN
		SELECT cur_Deta_View
		LOCK()
		
*******************************************************************************************************************************
* Recalculo los precios mayorista y minorista segun los descuentos del cliente
*******************************************************************************************************************************

		lnPorDesc1 = Thisform.contenido.txtDesc1.Value
		lnPorDesc2 = Thisform.contenido.txtDesc2.Value
		lnPorDesc3 = Thisform.contenido.txtDesc3.Value
		lnPorDesc4 = Thisform.contenido.txtDesc4.Value
		lnImpDesc1 = 0.00
		lnImpDesc2 = 0.00
		lnImpDesc3 = 0.00
		lnImpDesc4 = 0.00

		SELECT tmp_artic
		lnPrVtaMax = tmp_artic.prVentaMax
		lnPrVtaMin = tmp_artic.prVentaMin
				
		IF RIGHT(ALLTRIM(cur_Deta_View.codArt), 3) == "ARX" THEN
			lnPrecio = cur_Deta_View.prArtic
		ELSE
			IF clientes.mayorista THEN 
				SELECT cur_Deta_View
				
				
				IF lnPrOferta = 0 THEN
					lnPrecio = lnPrVtaMax
					llEsOferta = .F.
				ELSE 
					lnPrecio = lnPrOferta
					llEsOferta = .T.
				ENDIF 
			ELSE 
				lnPrecio = lnPrVtaMin
				llEsOferta = .F.
			ENDIF 
		ENDIF
		
		REPLACE cur_Deta_View.prArtic WITH lnPrecio ADDITIVE
		
		*******************************************************************************************************************************
		* Calculo el descuento del cliente en el ítem para grabar
		*******************************************************************************************************************************
		lnImpDesc1 = ROUND(lnPrecio * (lnPorDesc1 / 100), 2)
		IF !llEsOferta THEN
			lnImpDesc2 = ROUND((lnPrecio - lnImpDesc1 ) * (lnPorDesc2 / 100),2)
			lnImpDesc3 = ROUND((lnPrecio - lnImpDesc1 - lnImpDesc2 ) * (lnPorDesc3 / 100),2)
			lnImpDesc4 = ROUND((lnPrecio - lnImpDesc1 - lnImpDesc2 - lnImpDesc3) * (lnPorDesc4 / 100),2)
		ENDIF
		
		lnPrecio = lnPrecio - lnImpDesc1 - lnImpDesc2 - lnImpDesc3 - lnImpDesc4
		
		REPLACE cur_Deta_View.prVta WITH lnPrecio ADDITIVE  
		
		REPLACE cur_Deta_View.pDtoCli1 WITH lnPorDesc1 ADDITIVE
		REPLACE cur_Deta_View.pDtoCli2 WITH lnPorDesc2 ADDITIVE
		REPLACE cur_Deta_View.pDtoCli3 WITH lnPorDesc3 ADDITIVE
		REPLACE cur_Deta_View.pDtoCli4 WITH lnPorDesc4 ADDITIVE
		REPLACE cur_Deta_View.iDtoCli1 WITH lnImpDesc1 ADDITIVE
		REPLACE cur_Deta_View.iDtoCli2 WITH lnImpDesc2 ADDITIVE
		REPLACE cur_Deta_View.iDtoCli3 WITH lnImpDesc3 ADDITIVE
		REPLACE cur_Deta_View.iDtoCli4 WITH lnImpDesc4 ADDITIVE
		REPLACE cur_Deta_View.esOferta WITH llEsOferta ADDITIVE
		
		*******************************************************************************************************************************
		&& Calculo los descuentos por item
		*******************************************************************************************************************************

		lnPorDesc1 = cur_Deta_View.pDtoVta1
		lnPorDesc2 = cur_Deta_View.pDtoVta2
		lnPorDesc3 = cur_Deta_View.pDtoVta3
		lnPorDesc4 = cur_Deta_View.pDtoVta4
		lnImpDesc1 = 0.00
		lnImpDesc2 = 0.00
		lnImpDesc3 = 0.00
		lnImpDesc4 = 0.00
		lnNeto = 0.00

		lnImpDesc1 = ROUND(lnPrecio * (lnPorDesc1 / 100),2)
		lnImpDesc2 = ROUND((lnPrecio - lnImpDesc1 ) * (lnPorDesc2 / 100),2)
		lnImpDesc3 = ROUND((lnPrecio - lnImpDesc1 - lnImpDesc2 ) * (lnPorDesc3 / 100),2)
		lnImpDesc4 = ROUND((lnPrecio - lnImpDesc1 - lnImpDesc2 - lnImpDesc3) * (lnPorDesc4 / 100),2)
		
		lnNeto = lnPrecio - lnImpDesc1 - lnImpDesc2 - lnImpDesc3 - lnImpDesc4
		
		REPLACE cur_Deta_View.iDtoVta1 WITH lnImpDesc1 ADDITIVE
		REPLACE cur_Deta_View.iDtoVta2 WITH lnImpDesc2 ADDITIVE
		REPLACE cur_Deta_View.iDtoVta3 WITH lnImpDesc3 ADDITIVE
		REPLACE cur_Deta_View.iDtoVta4 WITH lnImpDesc4 ADDITIVE
		
		*******************************************************************************************************************************
		* Agrego el recargo del cliente en el item
		*******************************************************************************************************************************
		lnPorRec = Thisform.contenido.txtporrec.Value 
		
		lnImpRec = ROUND(lnNeto * (lnPorRec / 100), 2)
		
		lnNeto = lnNeto + lnImpRec

		REPLACE cur_Deta_View.pRecVta WITH lnPorRec ADDITIVE
		REPLACE cur_Deta_View.iRecVta WITH lnImpRec ADDITIVE

		*******************************************************************************************************************************
		&& Incluyo el recargo por ítem.
		*******************************************************************************************************************************
		lnImpRecItem = ROUND(lnNeto * (cur_Deta_View.pRecItem / 100),2)		
		
		lnNeto = lnNeto + lnImpRecItem

		REPLACE cur_Deta_View.pRecItem WITH cur_Deta_View.pRecItem ADDITIVE
		REPLACE cur_Deta_View.iRecItem WITH lnImpRecItem ADDITIVE
		
		*******************************************************************************************************************************
		* Recalculo el IVA y los Subtotales
		*******************************************************************************************************************************
		REPLACE cur_Deta_View.impNeto WITH lnNeto ADDITIVE 
		
		lnSubTotNeto = ROUND(lnNeto * cur_Deta_View.cantidad, 2)
		
		IF (ALLTRIM(Thisform.cbte) == "PTO") THEN
			REPLACE cur_Deta_View.impIVA WITH 0 ADDITIVE
			REPLACE cur_Deta_View.alicIVA WITH 0 ADDITIVE
		ELSE
			REPLACE cur_Deta_View.impIVA WITH ROUND(lnSubTotNeto * (tmp_artic.alicIVA / 100), 2) ADDITIVE
			REPLACE cur_Deta_View.alicIVA WITH tmp_artic.alicIVA ADDITIVE
		ENDIF
		
		REPLACE cur_Deta_View.totNeto WITH lnSubTotNeto ADDITIVE
		
		IF (ALLTRIM(Thisform.cbte) == "PTO") THEN
			REPLACE cur_Deta_View.subTotal WITH cur_Deta_View.totNeto ADDITIVE		
		ELSE 
			REPLACE cur_Deta_View.subTotal WITH cur_Deta_View.totNeto + cur_Deta_View.impIVA ADDITIVE
		ENDIF 
		UNLOCK
	ENDIF
	
	&& Si el artículo tiene impuestos internos, entonces, tengo
	&& que recalcular los valores con el impuesto interno.
	IF tmp_artic.usarImpuIn THEN
		&& Recalculo los impuestos internos.
		lnSubtNoGrav = cur_Deta_View.subTotal * (tmp_artic.porImpuIn / 100)
		lnBaseGrav = (cur_Deta_View.subTotal - lnSubtNoGrav) / (1 + (tmp_artic.alicIVA / 100))
		lnImpIVA = lnBaseGrav * (tmp_artic.alicIVA / 100)
		
		&& Acomodo los importes en el cursor de detalles
		SELECT cur_Deta_View
		LOCK()
		REPLACE cur_Deta_View.subtNoGrav WITH lnSubtNoGrav
		REPLACE cur_Deta_View.baseGrav WITH lnBaseGrav ADDITIVE
		REPLACE cur_Deta_View.totNeto WITH lnBaseGrav ADDITIVE	&& Es lo mismo que la base gravada.
		REPLACE cur_Deta_View.impIVA WITH lnImpIVA ADDITIVE
		UNLOCK
	ENDIF

	lo_artic.close_query()
		
	SELECT cur_Deta_View
	SKIP
ENDDO

IF !(ALLTRIM(Thisform.contenido.sel_Articulo.txtCodigo.Value) == "") THEN
	Thisform.contenido.sel_Articulo.recuperar_datos()
	Thisform.contenido.sel_Articulo.txtCodigo.Valid()
ENDIF

SELECT cur_Deta_View
IF RECCOUNT("cur_Deta_View") > 0 THEN
	GO TOP
ENDIF

Thisform.contenido.grdDetalles.Refresh()
Thisform.sumar_items()
Thisform.calcular_ret_iibb()

RETURN .T.

ENDPROC
PROCEDURE getoferta_byart
PARAMETERS tnIdArticulo

LOCAL lnPrecio, loResult, lcSql, loDT

loDT = CREATEOBJECT("datetime")
loResult = CREATEOBJECT("odbc_result")
lcSql = ""
lnPrecio = 0.00
lnPorDesc2 = Thisform.Contenido.txtDesc2.Value

lcSql = "SELECT * FROM ofertas "
lcSql = lcSql + "WHERE idArticulo = " + ALLTRIM(STR(tnIdArticulo)) + " "
lcSql = lcSql + "AND fecVigDD <= " + loDT.toMySql(DATE()) + " "
lcSql = lcSql + "AND fecVigHH >= " + loDT.toMySql(DATE())

loResult.ActiveConnection = goConn.ActiveConnection
loResult.Cursor_Name = "cur_tmpofta"

IF !loResult.OpenQuery(lcSql) THEN
	MESSAGEBOX(loResult.Error_Message, 0+48, Thisform.Caption)
	RETURN -1
ENDIF

SELECT cur_tmpofta
IF RECCOUNT("cur_tmpofta") > 0 THEN
	IF cur_tmpofta.porOfert >= lnPorDesc2 THEN
		lnPrecio = cur_tmpofta.impOfert
	ELSE
		lnPrecio = 0
	ENDIF
ENDIF

loResult.Close_Query()

RETURN lnPrecio
ENDPROC
PROCEDURE get_precio_oferta
LOCAL lnPrecio, loResult, lcSql, loDT
LOCAL lnPorDesc1, lnPorDesc2, lnPorDesc3, lnPorDesc4
LOCAL lnPorOferta

loDT = CREATEOBJECT("datetime")
loResult = CREATEOBJECT("odbc_result")
lcSql = ""
lnPrecio = 0.00

lnPorDesc1 = Thisform.contenido.txtDesc1.Value
lnPorDesc2 = Thisform.contenido.txtDesc2.Value
lnPorDesc3 = Thisform.contenido.txtDesc3.Value
lnPorDesc4 = Thisform.contenido.txtDesc4.Value

lcSql = "SELECT * FROM ofertas "
lcSql = lcSql + "WHERE idArticulo = " + ALLTRIM(STR(thisform.contenido.sel_articulo.valcpoid)) + " "
lcSql = lcSql + "AND fecVigDD <= " + loDT.toMySql(DATE()) + " "
lcSql = lcSql + "AND fecVigHH >= " + loDT.toMySql(DATE())

loResult.ActiveConnection = goConn.ActiveConnection
loResult.Cursor_Name = "cur_tmpofta"

IF !loResult.OpenQuery(lcSql) THEN
	MESSAGEBOX(loResult.Error_Message, 0+48, Thisform.Caption)
	RETURN -1
ENDIF

SELECT cur_tmpofta
IF RECCOUNT("cur_tmpofta") > 0 THEN
	lnPorOferta = cur_tmpofta.porOfert
	IF lnPorOferta >= lnPorDesc2 THEN
		lnPrecio = cur_tmpofta.impOfert
	ELSE
		lnPrecio = 0
	ENDIF
ENDIF

loResult.Close_Query()

RETURN lnPrecio
ENDPROC
PROCEDURE agregar_item_viewer
LOCAL lnPDtoCli1, lnPDtoCli2, lnPDtoCli3, lnPDtoCli4
LOCAL lnIDtoCli1, lnIDtoCli2, lnIDtoCli3, lnIDtoCli4, lnCantAnt
LOCAL loResult, lcSql, lnPrecio, llEsOferta, lnproferta, lnAlicIva
LOCAL lnPrVta, lnPorImpuInt

lnPDtoCli1 = Thisform.contenido.txtDesc1.Value
lnPDtoCli2 = Thisform.contenido.txtDesc2.Value
lnPDtoCli3 = Thisform.contenido.txtDesc3.Value
lnPDtoCli4 = Thisform.contenido.txtDesc4.Value
lnIDtoCli1 = 0.00
lnIDtoCli2 = 0.00
lnIDtoCli3 = 0.00
lnIDtoCli4 = 0.00
lnPrecio = 0.00
loResult = CREATEOBJECT("odbc_result")
lcSql = ""
llEsOferta = .F.
lnproferta = 0.00
lnAlicIva = 0.00
lnCantAnt = 0.00
llTomaOferta = .F.
lnPorImpuInt = 0.00

IF !Thisform.ValidarDetalle()
	RETURN .F.
ENDIF

lcSql = "SELECT * FROM articulos WHERE idArticulo = " + ALLTRIM(STR(Thisform.contenido.sel_Articulo.valcpoid))
loResult.ActiveConnection = goConn.ActiveConnection
loResult.Cursor_Name = "cur_Art"
loResult.OpenQuery(lcSql)

IF RIGHT(ALLTRIM(Thisform.Contenido.sel_Articulo.txtCodigo.Value), 3) == "ARX" THEN
	*lnPrecio = Thisform.prarti_x
	IF clientes.mayorista then
		lnPrecio = Thisform.Contenido.txtPrMay.Value
	ELSE
		lnPrecio = Thisform.Contenido.txtPrMinorista.Value
	ENDIF
	Thisform.prarti_x = lnPrecio
ELSE	
	IF clientes.mayorista THEN 
		lnPrecio = thisform.get_precio_oferta()
		lnproferta = lnPrecio
		
		IF lnPrecio = 0 THEN
			lnPrecio = cur_Art.prVentaMax
			llEsOferta = .F.
		ELSE
			llEsOferta = .T.
		ENDIF
	ELSE
		lnPrecio = cur_Art.prVentaMin
		llEsOferta = .F.
	ENDIF		
ENDIF

&& Me traigo el porcentaje de impuestos internos
lnPorImpuInt = cur_Art.porImpuIn

loResult.Close_Query()

IF glVersionBeta THEN
	SELECT cur_Deta_View
	IF RECCOUNT() = 5 THEN
		MESSAGEBOX("Usted está utilizando una versión límitada del sistema, si desea comprarlo envíe un mail a ldz.software@gmail.com", 0+64, Thisform.Caption)
		RETURN .F.
	ENDIF
ENDIF

* Valido si el artículo ya se encuentra cargado en el presupuesto
SELECT cur_Deta_View
IF RECCOUNT() > 0
	GO TOP
ENDIF

SELECT cur_Deta_View
DO WHILE !EOF()
	IF ALLTRIM(cur_Deta_View.codArt) == ALLTRIM(Thisform.contenido.sel_Articulo.txtCodigo.Value) THEN
		IF MESSAGEBOX("El artículo ya se encuentra cargado, ¿Desea acumular la cantidad?",4+32, Thisform.Caption) == 6 THEN
			lnCantAnt = Thisform.contenido.txtcantidad.Value
			Thisform.contenido.txtcantidad.Value = Thisform.contenido.txtcantidad.Value + cur_Deta_View.cantidad
			
			&& Vuelvo a verificar el stock nuevamente al acumular la cantidad 
			IF (ALLTRIM(Thisform.cbte) != "COT") .AND. (ALLTRIM(Thisform.cbte) != "NC") THEN
				&& Valido el stock solo en caso que no sea artículo X
				IF RIGHT(ALLTRIM(Thisform.Contenido.sel_Articulo.txtCodigo.Value), 3) != "ARX" THEN
					IF getGlobalCFG("STK_MODULE") THEN
						IF Thisform.mov_stock.get_exist_byart(Thisform.Contenido.sel_Articulo.valcpoid) <= 0 THEN
							Thisform.Contenido.sel_Articulo.txtCodigo.SetFocus()
							
							MESSAGEBOX("No hay stock disponible", 0+48, Thisform.Caption)				
							thisform.contenido.txtCantidad.Value = lnCantAnt
							thisform.contenido.txtCantidad.SetFocus()
							RETURN .F.
						ENDIF
						
						&& Valido si está o no cubierto al 100%
						IF Thisform.Contenido.txtCantidad.Value > Thisform.Contenido.txtExistencia.Value THEN
							MESSAGEBOX("No hay stock suficiente para cubrir la cantidad ingresada", 0+48, Thisform.Caption)
							thisform.contenido.txtCantidad.Value = lnCantAnt
							thisform.contenido.txtCantidad.SetFocus()
							RETURN .F.
						ENDIF
					ENDIF
				ENDIF
			ENDIF			
			
			Thisform.calc_item_desc()
			
			SELECT cur_Deta_View
			DELETE
		ELSE 
			Thisform.contenido.sel_Articulo.txtCodigo.SetFocus()
			RETURN .F.
		ENDIF 
	ENDIF

	SELECT cur_Deta_View
	SKIP
ENDDO

SELECT cur_Deta_View
APPEND BLANK
REPLACE cur_Deta_View.idDetalle WITH RECCOUNT("cur_Deta_View")
REPLACE cur_Deta_View.idArticulo WITH Thisform.contenido.sel_Articulo.valcpoid ADDITIVE	
REPLACE cur_Deta_View.codArt WITH Thisform.contenido.sel_Articulo.txtCodigo.Value ADDITIVE
REPLACE cur_Deta_View.descripcio WITH Thisform.contenido.sel_Articulo.txtDescripcion.Value ADDITIVE
REPLACE cur_Deta_View.cantidad WITH Thisform.contenido.txtCantidad.Value ADDITIVE

*******************************************************************************************************************************
* Verifico el tipo de cliente que es para saber desde donde tomar el precio
*******************************************************************************************************************************
IF RIGHT(ALLTRIM(Thisform.Contenido.sel_Articulo.txtCodigo.Value), 3) == "ARX" THEN
	&& Si es artículo X, siempre cargo el contenido de lo que el usuario haya ingresado
	REPLACE cur_Deta_View.prVta WITH Thisform.contenido.txtPrMinorista.Value ADDITIVE
	REPLACE cur_Deta_View.prArtic WITH Thisform.prarti_x ADDITIVE
ELSE
	IF clientes.mayorista THEN
		REPLACE cur_Deta_View.prVta WITH Thisform.contenido.txtPrMay.Value ADDITIVE
		
		IF !llEsOferta THEN
			* REPLACE cur_Deta_View.prArtic WITH thisform.pr_mayorista ADDITIVE
			REPLACE cur_Deta_View.prArtic WITH Thisform.contenido.txtPrMay.Value ADDITIVE
		ELSE
			REPLACE cur_Deta_View.prArtic WITH thisform.pr_oferta ADDITIVE
		ENDIF
	ELSE
		REPLACE cur_Deta_View.prVta WITH Thisform.contenido.txtPrMinorista.Value ADDITIVE
		* REPLACE cur_Deta_View.prArtic WITH Thisform.pr_minorista ADDITIVE
		REPLACE cur_Deta_View.prArtic WITH Thisform.contenido.txtPrMinorista.Value ADDITIVE
	ENDIF
	
	* Levanto el stock actual solo en caso que no sea ARX
	REPLACE cur_Deta_View.stkDisp  WITH Thisform.mov_stock.get_exist_byart(Thisform.contenido.sel_Articulo.valcpoid) ADDITIVE
ENDIF

*******************************************************************************************************************************
* Calculo el descuento del cliente en el ítem para grabar
*******************************************************************************************************************************
lnIDtoCli1 = ROUND(lnPrecio * (lnPDtoCli1 / 100),2)
IF !llEsOferta THEN
	lnIDtoCli2 = ROUND((lnPrecio - lnIDtoCli1) * (lnPDtoCli2 / 100),2)
	lnIDtoCli3 = ROUND((lnPrecio - lnIDtoCli1 - lnIDtoCli2) * (lnPDtoCli3 / 100),2)
	lnIDtoCli4 = ROUND((lnPrecio - lnIDtoCli1 - lnIDtoCli2 - lnIDtoCli3) * (lnPDtoCli4 / 100),2)
ENDIF

REPLACE cur_Deta_View.pDtoCli1 WITH lnPDtoCli1 ADDITIVE
REPLACE cur_Deta_View.pDtoCli2 WITH lnPDtoCli2 ADDITIVE
REPLACE cur_Deta_View.pDtoCli3 WITH lnPDtoCli3 ADDITIVE
REPLACE cur_Deta_View.pDtoCli4 WITH lnPDtoCli4 ADDITIVE
REPLACE cur_Deta_View.iDtoCli1 WITH lnIDtoCli1 ADDITIVE
REPLACE cur_Deta_View.iDtoCli2 WITH lnIDtoCli2 ADDITIVE
REPLACE cur_Deta_View.iDtoCli3 WITH lnIDtoCli3 ADDITIVE
REPLACE cur_Deta_View.iDtoCli4 WITH lnIDtoCli4 ADDITIVE
REPLACE cur_Deta_View.esOferta WITH llEsOferta ADDITIVE

*******************************************************************************************************************************
&& Calculo los descuentos por item
*******************************************************************************************************************************
REPLACE cur_Deta_View.pDtoVta1 WITH Thisform.contenido.txtPorDesc1.Value
REPLACE cur_Deta_View.pDtoVta2 WITH Thisform.contenido.txtPorDesc2.Value
REPLACE cur_Deta_View.pDtoVta3 WITH Thisform.contenido.txtPorDesc3.Value
REPLACE cur_Deta_View.pDtoVta4 WITH Thisform.contenido.txtPorDesc4.Value
REPLACE cur_Deta_View.iDtoVta1 WITH Thisform.contenido.txtImpDescItem1.Value
REPLACE cur_Deta_View.iDtoVta2 WITH Thisform.contenido.txtImpDescItem2.Value 
REPLACE cur_Deta_View.iDtoVta3 WITH Thisform.contenido.txtImpDescItem3.Value
REPLACE cur_Deta_View.iDtoVta4 WITH Thisform.contenido.txtImpDescItem4.Value

*******************************************************************************************************************************
* Agrego el recargo del cliente en el item
*******************************************************************************************************************************
REPLACE cur_Deta_View.pRecVta WITH Thisform.contenido.txtporrec.Value ADDITIVE
REPLACE cur_Deta_View.iRecVta WITH ROUND((lnPrecio - lnIDtoCli1 - lnIDtoCli2 - lnIDtoCli3 - lnIDtoCli4) * (Thisform.contenido.txtporrec.Value/ 100), 2) ADDITIVE

*******************************************************************************************************************************
&& Incluyo el recargo por ítem.
*******************************************************************************************************************************
REPLACE cur_Deta_View.pRecItem WITH Thisform.contenido.txtPorRecItem.Value ADDITIVE
REPLACE cur_Deta_View.iRecItem WITH Thisform.contenido.txtRecItem.Value ADDITIVE

REPLACE cur_Deta_View.impNeto WITH Thisform.contenido.txtPrNeto.Value ADDITIVE

*******************************************************************************************************************************
* Hago el cálculo del IVA
*******************************************************************************************************************************
IF (ALLTRIM(Thisform.cbte) == "PTO") THEN
	REPLACE cur_Deta_View.impIVA WITH 0 ADDITIVE
	REPLACE cur_Deta_View.alicIVA WITH 0 ADDITIVE
ELSE
	REPLACE cur_Deta_View.alicIVA WITH Thisform.contenido.txtAlicIVA.Value ADDITIVE
	REPLACE cur_Deta_View.impIVA WITH Thisform.contenido.txtImpIVA.Value ADDITIVE 
ENDIF

REPLACE cur_Deta_View.totNeto WITH Thisform.contenido.txtSTNeto.Value ADDITIVE
REPLACE cur_Deta_View.subTotal WITH Thisform.contenido.txtSubTotal.Value ADDITIVE


REPLACE cur_Deta_View.uniDesp WITH VAL(Thisform.contenido.cboUnidVta.Value) ADDITIVE
REPLACE cur_Deta_View.cantPack WITH Thisform.contenido.txtCantPack.Value ADDITIVE
REPLACE cur_Deta_View.uniMed WITH Thisform.unimed ADDITIVE

&& Grablo los no gravados en los tres campos que generé.
REPLACE cur_Deta_View.porNoGrav WITH lnPorImpuInt ADDITIVE
REPLACE cur_Deta_View.baseGrav WITH cur_Deta_View.totNeto ADDITIVE && Queda igual que el totNeto.
REPLACE cur_Deta_View.subtNoGrav WITH Thisform.contenido.txt_subtotal_no_grav.Value

SELECT cur_Deta_View

RETURN .T.
ENDPROC
PROCEDURE imprimir
LOCAL m.NroCli, m.RazSoc, m.Telefono, m.direccion, m.localidad, m.codPostal, m.pcia, m.TipoIVA, m.nroCUIT
LOCAL m.Total, m.tipoDoc, m.NroCbte, m.Fecha, m.leyenda, m.fecVto, m.tipoDoc, m.ptoVta
LOCAL m.porDesc1, m.porDesc2, m.porDesc3, m.porDesc4, m.porRec
LOCAL m.impDesc1, m.impDesc2, m.impDesc3, m.impDesc4
LOCAL m.porIIBB, m.impIIBB, m.observ, m.vendedor
LOCAL m.porIVA105, m.impIVA105, m.porIVA21, m.impIVA21, m.impNeto, m.impFinal
LOCAL lcSql, loNumerador, lcPrinterName, lnCantCpia
LOCAL m.cae, m.caevto, lcDia, lcMes, lcAnio
LOCAL m.codigoCbte, m.barcode, m.code, m.condPago
LOCAL lnIdNum, lnResp, m.NroRto, m.nroOC, m.qr
LOCAL loPDF, lcMailMsg
LOCAL lcNomEmp, llUsaTicket, m.motivo, m.totaNoGrav

loNumerador = CREATEOBJECT("odbc_result")
lcSql = ""
m.NroCli = Thisform.contenido.sel_Cliente.txtCodigo.Value
m.RazSoc = Thisform.contenido.sel_Cliente.txtDescripcion.Value
m.Telefono = ALLTRIM(Thisform.cli_telefono)
m.direccion = ALLTRIM(Thisform.cli_calle)
m.localidad = ALLTRIM(Thisform.cli_localidad)
m.codPostal = ALLTRIM(Thisform.cli_codPostal)
m.pcia = ALLTRIM(Thisform.cli_Pcia)
m.nroCUIT = ALLTRIM(Thisform.contenido.txtCuit.Value)
m.TipoIVA = Thisform.Contenido.txtSitIVA.Value
m.Total = 0.00
m.tipoDoc = ""
m.ptoVta = ""
m.NroCbte = ""
m.leyenda = ""
m.Fecha = Thisform.Contenido.txtFecEmis.Value
m.porIVA105 = 0.00
m.porIVA21 = 0.00
m.impIVA105 = 0.00
m.impIVA21 = 0.00
m.impNeto = 0.00
m.impFinal = 0.00
m.fecVto = Thisform.Contenido.txtFecEmis.Value + thisform.cp_cntdias
m.tipoDoc = Thisform.tipodoc
m.totaNoGrav = 0.00 && Agrego el no gravado
m.porIIBB = 0.00
m.impIIBB = 0.00
lnCantCpia = 0
m.observ = ""
m.vendedor = thisform.nombre_usuario
m.cae = thisform.aut_cae
m.codigoCbte = REPLICATE("0", 2 - LEN(ALLTRIM(STR(Thisform.codigo_cbte)))) + ALLTRIM(STR(Thisform.codigo_cbte))
m.barcode = ""
m.code = ""
lnIdNum = 0
lnResp = 0
m.NroRto = ""
m.nroOC = Thisform.contenido.txtoc.Value
lcNomEmp = getconfig("NOMEMP")
m.condPago = IIF(This.idCondPago = 1, "CONTADO", "CUENTAS CORRIENTES")
m.qr = Thisform.qr_image
llUsaTicket = .T.

IF Thisform.sitivacli = 6 THEN
	&& Solo extraigo el motivo si es monotributista
	m.motivo = "El crédito fiscal discriminado en el presente comprobante, " ;
		+ "sólo podrá ser computado a efectos del Régimen de Sostenimiento e Inclusión Fiscal para Pequeños Contribuyentes de la Ley Nº 27.618"
ELSE
	m.motivo = ""
ENDIF

lcAnio = SUBSTR(Thisform.aut_cae_vto, 1, 4)
lcMes = SUBSTR(Thisform.aut_cae_vto, 5, 2)
lcDia = SUBSTR(Thisform.aut_cae_vto, 7, 2)

m.caevto = lcDia + "/" + lcMes + "/" + lcAnio
m.ptovta = INT(VAL(ALLTRIM(getconfig("PTOVTA"))))

&& Levanto el talonario del numerador solo para tomar la configuración de la impresora
lcSql = "select * from numerador where cbte = '" + ALLTRIM(Thisform.cbte) + "' and tipoDoc = '" + ALLTRIM(m.tipoDoc) + "' AND ptoVta = " + ALLTRIM(STR(m.ptoVta))
loNumerador = CREATEOBJECT("odbc_result")
loNumerador.ActiveConnection = goConn.ActiveConnection
loNumerador.Cursor_Name = "cur_num"
loNumerador.OpenQuery(lcSql)

SELECT cur_num
GO TOP
lnIdNum = cur_num.idNum

loNumerador.close_query()

&& Levanto la impresora configurada en el puesto de trabajo actual
lcSql = "SELECT * FROM impresoras WHERE hostName = '" + ALLTRIM(SYS(0)) + "' AND "
lcSql = lcSql + "idNum = " + ALLTRIM(STR(lnIdNum))

loNumerador.ActiveConnection = goConn.ActiveConnection
loNumerador.Cursor_Name = "cur_imp"

IF !loNumerador.OpenQuery(lcSql) THEN
	MESSAGEBOX(loNumerador.Error_Message, 0+48, Thisform.Caption)
	RETURN
ENDIF

SELECT cur_imp
IF RECCOUNT("cur_imp") = 0 THEN
	MESSAGEBOX("La impresora no se encuentra configurada en el puesto de trabajo actual", 0+48, Thisform.Caption)
	loNumerador.Close_Query()
	RETURN
ENDIF

lcPrinterName = ALLTRIM(cur_imp.impresora)
lnCantCpia = cur_imp.copias
llUsaTicket = cur_imp.usa_ticket

loNumerador.Close_Query()

m.NroCbte = REPLICATE("0", 4 - LEN(ALLTRIM(STR(Thisform.ptovta)))) + ALLTRIM(STR(Thisform.ptovta)) + "-" + REPLICATE("0", 8 - LEN(ALLTRIM(STR(Thisform.nrocbte)))) + ALLTRIM(STR(Thisform.nrocbte))

IF ALLTRIM(Thisform.cbte) == "COT"
	m.leyenda = "COTIZACION"
	m.tipoDoc = "X"
	m.Total = cur_Subtotal.totFact
ELSE 
	IF ALLTRIM(Thisform.cbte) == "PTO"
		m.leyenda = "PRESUPUESTO"
		m.tipoDoc = "X"
		m.Total = cur_Subtotal.impFinal
	ELSE
		IF ALLTRIM(Thisform.cbte) == "PED"
			m.leyenda = "NOTA DE PEDIDO"
			m.tipoDoc = "P"
			m.Total = Thisform.contenido.txtTotFact.Value
		ELSE
			IF ALLTRIM(Thisform.Cbte) == "FC"
				m.leyenda = "FACTURA"
				m.Total = cur_Subtotal.totFact
			ELSE
				IF ALLTRIM(Thisform.Cbte) == "NC"
					m.Leyenda = "NOTA DE CREDITO"
					m.Total = cur_Subtotal.totFact
				ELSE
					IF ALLTRIM(Thisform.Cbte) == "ND"
						m.leyenda = "NOTA DE DEBITO"
						m.Total = cur_Subtotal.totFact
					ENDIF
				ENDIF
			ENDIF
		ENDIF
	ENDIF
ENDIF

IF (ALLTRIM(Thisform.cbte) == "NC") .OR. (ALLTRIM(Thisform.cbte) == "FC") .OR. (ALLTRIM(Thisform.cbte) == "PTO") .OR. (ALLTRIM(Thisform.cbte) == "COT") THEN
	m.porDesc1 = cur_Subtotal.porDesc1 
	m.porDesc2 = cur_Subtotal.porDesc2 
	m.porDesc3 = cur_Subtotal.porDesc3 
	m.porDesc4 = cur_Subtotal.porDesc4 
	m.impDesc1 = cur_Subtotal.impDesc1
	m.impDesc2 = cur_Subtotal.impDesc2
	m.impDesc3 = cur_Subtotal.impDesc3
	m.impDesc4 = cur_Subtotal.impDesc4
	m.porIVA105 = cur_Subtotal.porIVA105
	m.porIVA21 = cur_Subtotal.porIVA21
	m.impIVA105 = cur_Subtotal.impIVA105
	m.impIVA21 = cur_Subtotal.impIVA21
	m.impNeto = cur_Subtotal.impFinal
	m.impFinal = cur_Subtotal.impFinal
	m.porIIBB = cur_Subtotal.porIIBB
	m.impIIBB = cur_Subtotal.impIIBB
	m.porRec = cur_Subtotal.porRec
	
	&& Agrego el no gravado
	m.totaNoGrav = cur_Subtotal.totaNoGrav	
	
	SELECT cur_aux
ELSE 
	m.porDesc1 = Thisform.Contenido.txtDesc1.Value
	m.porDesc2 = Thisform.Contenido.txtDesc2.Value
	m.porDesc3 = Thisform.Contenido.txtDesc3.Value
	m.porDesc4 = Thisform.Contenido.txtDesc4.Value
	m.impDesc1 = Thisform.Contenido.txtImpDesc1.Value
	m.impDesc2 = Thisform.Contenido.txtImpDesc2.Value
	m.impDesc3 = Thisform.Contenido.txtImpDesc3.Value
	m.impDesc4 = Thisform.Contenido.txtImpDesc4.Value
	m.porIVA105 = Thisform.contenido.txtPorIVA105.Value
	m.porIVA21 = Thisform.Contenido.txtPorIVA21.value
	m.impIVA105 = Thisform.Contenido.txtImpIVA105.Value
	m.impIVA21 = Thisform.Contenido.txtImpIVA21.Value
	m.impNeto = Thisform.Contenido.txtST.Value
	m.impFinal = Thisform.Contenido.txtTotFact.Value
	m.porIIBB = Thisform.Contenido.txtPorIIBB.Value
	m.impIIBB = Thisform.Contenido.txtImpIIBB.Value
	m.porRec = Thisform.contenido.txtPorRec.Value
	
	SELECT cur_detalle
ENDIF 

m.observ = thisform.contenido.txtObserv.Value + ""

&& Generación del código de barra
m.barcode = ALLTRIM(Thisform.cli_cuit)
m.barcode = m.barcode + ALLTRIM(m.codigoCbte)
m.barcode = m.barcode + REPLICATE("0", 4 - LEN(ALLTRIM(STR(m.ptovta)))) + ALLTRIM(STR(m.ptovta))
m.barcode = m.barcode + ALLTRIM(m.cae)
m.barcode = m.barcode + ALLTRIM(lcAnio)
m.barcode = m.barcode + REPLICATE("0", 2 - LEN(ALLTRIM(lcMes))) + ALLTRIM(lcMes)
m.barcode = m.barcode + REPLICATE("0", 2 - LEN(ALLTRIM(lcDia))) + ALLTRIM(lcDia)
m.barcode = m.barcode + ALLTRIM(STR(Thisform.calc_digito_verificador(m.barcode)))
m.code = m.barcode
m.barcode = getcodbarras(m.barcode)

IF thisform.contenido.chkImprimirCbte.Value THEN
	IF !llUsaTicket THEN
		* Paso por acá si no usa ticket.
		SET PRINTER TO NAME ALLTRIM(lcPrinterName)

		FOR i = 1 TO lnCantCpia 
			IF ALLTRIM(Thisform.tipodoc) == "A" THEN
				&& Imprime el comprobante de tipo "A"
				SELECT cur_aux
				REPORT FORM "repcbtesvta.frx" TO PRINTER NOCONSOLE
			ELSE
				&& Imprime el comprobante de tipo "B"
				SELECT cur_aux
				REPORT FORM "repcbtesvta_b.frx" TO PRINTER NOCONSOLE
			ENDIF
		NEXT
	ELSE
		* En caso de que esté configurado para usar ticket ejecuto el siguiente
		* código.
		SET PRINTER TO NAME ALLTRIM(lcPrinterName)	
		
		****************************************************************************
		* Envío a imprimir el ticket
		****************************************************************************
		Thisform.oticket.limpiar_datos()
		Thisform.oticket.con_corte = getGlobalCFG("TKT_CORTE")
		Thisform.oticket.codigo_cbte = m.codigoCbte
		Thisform.oticket.leyenda = m.leyenda
		Thisform.oticket.letra = m.tipoDoc
		Thisform.oticket.nro_cbte = m.nroCbte
		Thisform.oticket.fecha_cbte = m.fecha
		Thisform.oticket.fecha_vencimiento = m.fecVto
		Thisform.oticket.numero_cliente = m.NroCli
		Thisform.oticket.razon_social = m.razSoc
		Thisform.oticket.direccion = m.direccion
		Thisform.oticket.codigo_postal = m.codPostal 
		Thisform.oticket.localidad = m.localidad
		Thisform.oticket.provincia = m.pcia
		Thisform.oticket.tipo_iva = m.TipoIVA
		Thisform.oticket.condicion_pago = m.condPago
		
		SELECT cur_aux
		GO TOP
		DO WHILE !EOF("cur_aux")
			&&Thisform.oticket.add_item(cur_aux.codArt, cur_aux.descripcio, cur_aux.cantidad,;
			&&		cur_aux.alicIVA, cur_aux.impNeto, cur_aux.totNeto)
			Thisform.oticket.add_item(cur_aux.codArt, cur_aux.descripcio, cur_aux.cantidad,;
					cur_aux.alicIVA, cur_aux.impNeto, cur_aux.subTotal)			
			SELECT cur_aux
			SKIP
		ENDDO
		
		Thisform.oticket.total_neto = m.impNeto
		Thisform.oticket.total_imp_iva21 = m.impIVA21
		Thisform.oticket.total_imp_iva105 = m.impIVA105

		IF ALLTRIM(Thisform.tipodoc) == "B" THEN
			thisform.oticket.total_nograv = m.totaNoGrav
			
		ENDIF 

		Thisform.oticket.total = m.Total
		Thisform.oticket.qr_image = Thisform.qr_image
		Thisform.oticket.nro_cae = m.cae
		Thisform.oticket.vto_cae = m.caevto
		Thisform.oticket.motivo = m.motivo
		Thisform.oticket.imprimir()
	ENDIF
ENDIF

IF thisform.contenido.chkEnviarMail.Value THEN
	Thisform.mailfc = ALLTRIM(Thisform.Contenido.txtMailFC.Value)
	lcFileName = SYS(5) + SYS(2003) + "\wsafip\ComprobantesPDF\" + this.cbte + "_" + m.NroCbte + ".pdf"
	
	loPDF = CREATEOBJECT("Bullzip.PDFPrinterSettings")
		loPDF.SetValue('output', lcFileName)
		loPDF.SetValue('DisableOptionDialog', 'no') 
		loPDF.SetValue('ConfirmOverwrite', 'no')
		loPDF.SetValue('Showsettings', 'never') 
		loPDF.SetValue('ShowSaveAS', 'nofile') 
		loPDF.SetValue('ShowPdf', 'no') 
		loPDF.WriteSettings(.t.)
	
	SET CONSOLE OFF
	SET PRINTER TO NAME("Bullzip PDF Printer")
	IF ALLTRIM(Thisform.tipodoc) == "A" THEN
		&& Imprime el comprobante de tipo "A"
		SELECT cur_aux
		REPORT FORM "repcbtesvta.frx" NOCONSOLE TO PRINTER
	ELSE
		&& Imprime el comprobante de tipo "B"
		SELECT cur_aux
		REPORT FORM "repcbtesvta_b.frx" NOCONSOLE TO PRINTER
	ENDIF
	SET PRINTER TO DEFAULT
	SET CONSOLE ON
	
	WAIT WINDOW "El archivo PDF se está generando, aguarde unos segundos..." NOWAIT
	DO WHILE !FILE(lcFileName)
		
	ENDDO
	
	&&MESSAGEBOX("Archivo generado en " + lcFileName, 0+64, thisform.Caption)
	
	TEXT TO lcMailMsg NOSHOW
	Estimado cliente,
	
	Le adjuntamos el comprobante electrónico de su compra en formato PDF.
	
	Muchas gracias!
	
	
	Saludos cordiales,
	
	ENDTEXT
	lcMailMsg = lcMailMsg + lcNomEmp

	&& Procedo a hacer el envío de mail
	DO LOCFILE("FoxyPreviewer.App")
	WITH _screen.oFoxyPreviewer
		.cEmailType = "PDF"
		.nEmailMode = 2
		.cEMailTo = thisform.mailfc
		.cEmailCC = ALLTRIM(getGlobalCFG("EMAILCC"))
		.cSMTPServer = getGlobalCFG("EMAILSMTP")
		.cEmailFrom = getGlobalCFG("EMAILEMP") + " <" + getGlobalCFG("EMAILADDR") + ">"
		.cEMailSubject = "Comprobante Electrónico " + this.cbte + " " + m.NroCbte
		.nSMTPPort = getGlobalCFG("EMAILPORT")
		.lSMTPUseSSL = getGlobalCFG("EMAILSSL")
		.cSMTPUserName = getGlobalCFG("EMAILUSR")
		.cSMTPPassword = getGlobalCFG("EMAILPWD")
		.lReadReceipt  = .F.
		.lPriority = .F.
		.cEmailBody = lcMailMsg
		.SendEmailUsingCDO(lcFileName)
	ENDWITH	
ENDIF

DO FoxyPreviewer.App WITH "Release"
ENDPROC
PROCEDURE blanquear
DODEFAULT()
Thisform.contenido.sel_Cliente.txtCodigo.SetFocus()
Thisform.contenido.sel_Cliente.txtCodigo.Value = getGlobalCFG("CLI_CF")
Thisform.contenido.sel_Articulo.txtCodigo.SetFocus()
Thisform.contenido.txtCuit.Value = "11111111"


ENDPROC
PROCEDURE validarcampos
IF !DODEFAULT() THEN
	RETURN .F.
ENDIF

*!*	IF Thisform.contenido.txtTotFact.Value > 100000 then
*!*		MESSAGEBOX("No se puede emitir una factura superior a $100.000", 0+48, Thisform.Caption)
*!*		RETURN .F.
*!*	ENDIF

RETURN .T.
ENDPROC
PROCEDURE contenido.sel_Cliente.recuperar_datos
LOCAL lo_rsSitIVA, lo_rsCondPago, lo_rsLocalidad, lo_rsPcia, lo_rsIIBB, lcSql
LOCAL lo_rsTipoDoc, lnResp, lorsFalt

lo_rsSitIVA = CREATEOBJECT("odbc_result")
lo_rsCondPago = CREATEOBJECT("odbc_result")
lo_rsLocalidad = CREATEOBJECT("odbc_result")
lo_rsPcia = CREATEOBJECT("odbc_result")
lo_rsIIBB = CREATEOBJECT("odbc_result")
lo_rsTipoDoc = CREATEOBJECT("odbc_result")
loRsFalt = CREATEOBJECT("odbc_result")
lcSql = ""

IF Thisform.contenido.sel_Cliente.txtCodigo.Value == 0 THEN 
	Thisform.contenido.sel_Cliente.txtDescripcion.Value = ""
	RETURN .F.
ENDIF 

SELECT clientes
IF !clientes.habilitado THEN 
	MESSAGEBOX("Este cliente no está habilitado, por favor, verifique el estado del cliente", 0+48, Thisform.Caption)
	this.valcpoid = 0
	this.blanquear()
	this.txtcodigo.SetFocus()
	
	RETURN .F.
ENDIF 

IF ALLTRIM(thisform.cbte) == "FC" .OR. ALLTRIM(thisform.cbte) == "PED" THEN
	IF clientes.contrCM THEN
		thisform.calcular_saldo_dedudor()
		
		IF thisform.saldodeudor > clientes.credMax THEN
			MESSAGEBOX("El saldo deudor supera al crédito máximo otorgado", 0+48, Thisform.Caption)
			RETURN .F.
		ENDIF
	ENDIF
ENDIF

Thisform.contenido.txtDesc1.Value = clientes.desc1
Thisform.contenido.txtDesc2.Value = clientes.desc2
Thisform.contenido.txtDesc3.Value = clientes.desc3
Thisform.contenido.txtDesc4.Value = clientes.desc4
Thisform.cli_calle = clientes.direccion
Thisform.cli_cuit = clientes.nroCUIT
Thisform.cli_telefono = clientes.telefono
Thisform.cli_Id = clientes.idCliente
Thisform.contenido.txttelefono.Value = clientes.telefono
Thisform.contenido.txtcuit.Value = clientes.nrocuit
Thisform.envcbte = clientes.envcbte
Thisform.contenido.chkEnviarMail.Value = clientes.envcbte
Thisform.contenido.chkImprimirCbte.Value = clientes.printcbte
Thisform.mailfc = ALLTRIM(clientes.mailFC)
Thisform.Contenido.txtMailFC.Value = ALLTRIM(clientes.mailFC)
Thisform.printcbte = clientes.printcbte

&& Levanto el codigo de tipo de documento
lcSql = "SELECT * FROM tipodoc WHERE idTipoDoc = " + ALLTRIM(STR(clientes.idTipoDoc))
lo_rsTipoDoc.ActiveConnection = goConn.ActiveConnection
lo_rsTipoDoc.Cursor_Name = "cur_tipodoc"
lo_rsTipoDoc.OpenQuery(lcSql)

SELECT cur_tipodoc
Thisform.cli_tipodoc = cur_tipodoc.tipodoc
Thisform.cli_idtipodoc = clientes.idTipoDoc

IF !(ALLTRIM(Thisform.cli_tipodoc) == "CUIT" .OR. ALLTRIM(Thisform.cli_tipodoc) == "CUIL") THEN
	This.Parent.txtCuit.InputMask = ""
ELSE
	This.Parent.txtCuit.InputMask = "XX-XXXXXXXX-XX"
ENDIF

lo_rsTipoDoc.close_query()

lcSql = "SELECT * FROM localidad WHERE idLocalid = " + ALLTRIM(STR(clientes.idLocalid))
lo_rsLocalidad.ActiveConnection = goConn.ActiveConnection
lo_rsLocalidad.Cursor_Name = "cur_Localid"
lo_rsLocalidad.OpenQuery(lcSql)

SELECT cur_Localid
Thisform.cli_localidad = cur_Localid.descripcio
Thisform.cli_codpostal = cur_Localid.codPostal

lcSql = "SELECT * FROM provincias WHERE idProvin = " + ALLTRIM(STR(cur_Localid.idProvin))
lo_rsPcia.ActiveConnection = goConn.ActiveConnection
lo_rsPcia.Cursor_Name = "cur_Pcia"
lo_rsPcia.OpenQuery(lcSql)

SELECT cur_Pcia
Thisform.cli_pcia = cur_Pcia.descripcio

lo_rsPcia.close_query()
lo_rsLocalidad.close_query()

lcSql = "SELECT * FROM sitiva WHERE idSitIVA = " + ALLTRIM(STR(clientes.idSitIVA))
lo_rsSitIVA.ActiveConnection = goConn.ActiveConnection
lo_rsSitIVA.Cursor_Name = "cur_SitIVA"
lo_rsSitIVA.OpenQuery(lcSql)

SELECT cur_SitIVA
Thisform.contenido.txtSitIVA.Value = cur_SitIVA.descripcio
Thisform.sitivacli = cur_SitIVA.idSitIVA
Thisform.CodIVAFiscal = cur_SitIVA.CodFiscal
Thisform.condicion_iva_receptor_id = cur_SitIVA.conivareid

lo_rsSitIVA.close_query()

lcSql = "SELECT * FROM condpagos WHERE idCondPago = " + ALLTRIM(STR(clientes.idCondPago))
lo_rsCondPago.ActiveConnection = goConn.ActiveConnection
lo_rsCondPago.Cursor_Name = "cur_CondPago"
lo_rsCondPago.OpenQuery(lcSql)

SELECT cur_CondPago
Thisform.contenido.sel_FormaPago.valcpoid = cur_CondPago.idCondPago
Thisform.contenido.sel_FormaPago.txtCodigo.Value = cur_CondPago.idCondPago
Thisform.contenido.sel_FormaPago.txtDescripcion.Value = cur_CondPago.Descripcio
Thisform.cp_cntdias = cur_CondPago.cntDias
Thisform.idCondPago = cur_CondPago.idCondPago

lo_rsCondPago.close_query()

IF ALLTRIM(Thisform.cbte) <> "PTO" THEN 
	lcSql = "SELECT * FROM padronib WHERE cuit = '" + ALLTRIM(STRTRAN(clientes.nrocuit,"-","")) + "'"
	lo_rsIIBB.ActiveConnection = goConn.ActiveConnection
	lo_rsIIBB.Cursor_Name = "cur_PadronIB"
	lo_rsIIBB.OpenQuery(lcSql)

	SELECT cur_PadronIB
	IF RECCOUNT("cur_PadronIB") > 0 THEN
		Thisform.contenido.txtPorIIBB.Value = cur_PadronIB.AlicuotaPer
	ELSE 
		Thisform.contenido.txtPorIIBB.Value = 0.00
	ENDIF 

	lo_rsIIBB.close_query()
ENDIF 

Thisform.contenido.txtPorRec.Value = IIF(ISNULL(clientes.recargo), 0.00, clientes.recargo)

IF ALLTRIM(thisform.cbte) != "NC" THEN 
	thisform.recalcular_todo()
ENDIF

IF ALLTRIM(thisform.cbte) == "FC" .OR. ALLTRIM(thisform.cbte) == "PED" THEN
	IF clientes.ctrMoro THEN
		thisform.mostrar_morosidad()
	ENDIF	
ENDIF

IF This.valcpoid = getglobalcfg("CLI_CF") THEN
	This.txtDescripcion.ReadOnly = .F.
	This.txtDescripcion.Enabled = .T.
	Thisform.contenido.txtCuit.Enabled = .T.		
	Thisform.contenido.txtCuit.ReadOnly = .F.
ELSE
	This.txtDescripcion.ReadOnly = .T.
	This.txtDescripcion.Enabled = .F.
	Thisform.contenido.txtPrMinorista.ReadOnly = .T.
	Thisform.contenido.txtPrMinorista.Enabled = .F.
	Thisform.contenido.txtCuit.Enabled = .F.
	Thisform.contenido.txtCuit.ReadOnly = .T.
	
	IF ALLTRIM(thisform.cbte) == "PED" THEN
		lcSql = "SELECT * "
		lcSql = lcSql + "FROM faltantes "
		lcSql = lcSql + "WHERE idCliente = " + ALLTRIM(STR(This.valcpoid)) + " "
		lcSql = lcSql + "	AND fecBaja IS NULL"
		
		loRsFalt.ActiveConnection = goConn.ActiveConnection
		loRsFalt.Cursor_Name = "cur_x"
		
		IF !loRsFalt.OpenQuery(lcSql) THEN
			MESSAGEBOX(loRsFalt.Error_Message, 0+48, Thisform.Caption)
		ELSE
			SELECT cur_x
			IF RECCOUNT("cur_x") > 0 THEN
				lnResp = MESSAGEBOX("Este cliente tiene faltantes de pedidos anteriores, ¿desea incorporarlos?", 4+32, Thisform.Caption)
				IF lnResp = 6 THEN
					Thisform.leer_faltantes()
				ENDIF
			ENDIF
		
			loRsFalt.Close_Query()
		ENDIF
	ENDIF
ENDIF
ENDPROC
PROCEDURE contenido.sel_Articulo.recuperar_datos
LOCAL lnPorDesc1, lnPorDesc2, lnPorDesc3, lnPorDesc4
LOCAL lnImpDesc1, lnImpDesc2, lnImpDesc3, lnImpDesc4
LOCAL lnPrVtaMax, lnPrVtaMin, lnImpOfert
LOCAL loResult, lcSql

lnPorDesc1 = Thisform.contenido.txtDesc1.Value
lnPorDesc2 = Thisform.contenido.txtDesc2.Value
lnPorDesc3 = Thisform.contenido.txtDesc3.Value
lnPorDesc4 = Thisform.contenido.txtDesc4.Value
lnImpDesc1 = 0.00
lnImpDesc2 = 0.00
lnImpDesc3 = 0.00
lnImpDesc4 = 0.00
lnPrVtaMax = 0.00
lnPrVtaMin = 0.00
lnImpOfert = 0.00
lcSql = ""
loResult = CREATEOBJECT("odbc_result")

SELECT articulos

IF !articulos.habilitado THEN
	MESSAGEBOX("Este artículo no se puede facturar ya que está inhabilitado, dirijase a Archivos / Artículos y " + ;
		"habilitelo para poder facturar o comuniquese con la persona responsable que haya deshabilitado el mismo.", 0+48, Thisform.Caption)
		
	this.txtCodigo.SetFocus()
	RETURN .F.
ENDIF

lcSql = "select * from unidmed where idUniMed = " + ALLTRIM(STR(articulos.idUniMed))

loResult.ActiveConnection = goConn.ActiveConnection
loResult.Cursor_Name = "cur_x"

IF !loResult.OpenQuery(lcSql) THEN
	MESSAGEBOX(loResult.Error_Message, 0+48, Thisform.Caption)
	RETURN .F.
ENDIF

SELECT cur_x
IF RECCOUNT("cur_x") > 0 THEN
	thisform.unimed = cur_x.codUM
ENDIF

loResult.close_query()

lnImpOfert = thisform.get_precio_oferta()

IF lnImpOfert = 0 THEN
	SELECT articulos
	lnPrVtaMax = articulos.prVentaMax
	lnPrVtaMin = articulos.prVentaMin
ELSE
	lnPrVtaMin = lnImpOfert
	thisform.pr_oferta = lnImpOfert
ENDIF

SELECT articulos
lnPrVtaMax = articulos.prVentaMax

thisform.pr_mayorista = lnPrVtaMax
thisform.pr_minorista = lnPrVtaMin

lnImpDesc1 = ROUND(lnPrVtaMax * (lnPorDesc1 / 100),2)
IF lnImpOfert = 0 THEN
	lnImpDesc2 = ROUND((lnPrVtaMax - lnImpDesc1) * (lnPorDesc2 / 100),2)
	lnImpDesc3 = ROUND((lnPrVtaMax - lnImpDesc1 - lnImpDesc2) * (lnPorDesc3 / 100),2)
	lnImpDesc4 = ROUND((lnPrVtaMax - lnImpDesc1 - lnImpDesc2 - lnImpDesc3) * (lnPorDesc4 /100),2)
ENDIF

lnPrVtaMax = lnPrVtaMax - lnImpDesc1 - lnImpDesc2 - lnImpDesc3 - lnImpDesc4
Thisform.contenido.txtPrMay.Value = lnPrVtaMax 

lnImpDesc1 = ROUND(lnPrVtaMin * (lnPorDesc1 / 100),2)
lnImpDesc2 = ROUND((lnPrVtaMin - lnImpDesc1) * (lnPorDesc2 / 100),2)
lnImpDesc3 = ROUND((lnPrVtaMin - lnImpDesc1 - lnImpDesc2) * (lnPorDesc3 / 100),2)
lnImpDesc4 = ROUND((lnPrVtaMin - lnImpDesc1 - lnImpDesc2 - lnImpDesc3) * (lnPorDesc4 /100),2)

lnPrVtaMin = lnPrVtaMin - lnImpDesc1 - lnImpDesc2 - lnImpDesc3 - lnImpDesc4
Thisform.contenido.txtPrMinorista.Value = lnPrVtaMin
Thisform.prFinalAnt = lnPrVtaMin 

thisform.contenido.txtAlicIVA.Value = articulos.alicIVA
Thisform.Contenido.txtExistencia.Value = Thisform.mov_stock.get_exist_byart(Thisform.contenido.sel_Articulo.valcpoid)

IF clientes.mayorista THEN
	Thisform.contenido.txtPrUnitFinal.Value = lnPrVtaMax * (1 + (articulos.alicIVA / 100))
ELSE
	Thisform.contenido.txtPrUnitFinal.Value = lnPrVtaMin * (1 + (articulos.alicIVA / 100))
ENDIF

* Agrego esto para el artículo "X"
IF RIGHT(ALLTRIM(This.txtCodigo.Value), 3) == "ARX" THEN
	This.txtDescripcion.Enabled = .T.
	This.txtDescripcion.ReadOnly = .F.
*!*		This.Parent.txtPrMinorista.Enabled = .T.
*!*		This.Parent.txtPrMinorista.ReadOnly = .F.
ENDIF

Thisform.calc_item_desc()
ENDPROC
PROCEDURE contenido.txtCantidad.Valid
IF This.Value > 500 then
	MESSAGEBOX("La cantidad supera las 500 unidades. Ingrese una cantidad válida", 0+48, Thisform.Caption)
	RETURN .F.
ENDIF
RETURN .t.

ENDPROC
PROCEDURE contenido.txtPrUnitFinal.Valid
*!*	IF This.Value > 100000 then
*!*		MESSAGEBOX("Está ingresando un importe superior a $ 100.000", 0+48, Thisform.Caption)
*!*		RETURN .F.
*!*	ENDIF

IF !DODEFAULT() THEN
	RETURN .F.
ENDIF

RETURN .T.

ENDPROC


************************************************************
OBJETO: 
************************************************************
*** PROPIEDADES ***
Arial, 0, 9, 5, 15, 12, 32, 3, 0
Arial, 1, 8, 5, 14, 11, 29, 3, 0
Arial, 1, 11, 7, 18, 14, 39, 4, 0
Arial, 1, 9, 6, 15, 12, 32, 3, 0

*** METODOS ***


