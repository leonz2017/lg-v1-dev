************************************************************
OBJETO: Dataenvironment
************************************************************
*** PROPIEDADES ***
Top = 0
Left = 0
Width = 0
Height = 0
DataSource = .NULL.
Name = "Dataenvironment"

*** METODOS ***


************************************************************
OBJETO: FRM_FACTURA_FE
************************************************************
*** PROPIEDADES ***
DoCreate = .T.
cbte = FC
Name = "FRM_FACTURA_FE"
contenido.Clsetiqueta1.TabIndex = 40
contenido.Clsetiqueta1.Name = "Clsetiqueta1"
contenido.sel_Cliente.txtCodigo.Name = "txtCodigo"
contenido.sel_Cliente.txtDescripcion.Name = "txtDescripcion"
contenido.sel_Cliente.TabIndex = 1
contenido.sel_Cliente.Name = "sel_Cliente"
contenido.Clsetiqueta2.TabIndex = 42
contenido.Clsetiqueta2.Name = "Clsetiqueta2"
contenido.Clsetiqueta3.TabIndex = 43
contenido.Clsetiqueta3.Name = "Clsetiqueta3"
contenido.txtSitIVA.TabIndex = 32
contenido.txtSitIVA.Name = "txtSitIVA"
contenido.sel_FormaPago.txtCodigo.Name = "txtCodigo"
contenido.sel_FormaPago.txtDescripcion.Name = "txtDescripcion"
contenido.sel_FormaPago.TabIndex = 3
contenido.sel_FormaPago.Name = "sel_FormaPago"
contenido.Clslinea1.Name = "Clslinea1"
contenido.Clsetiqueta4.TabIndex = 44
contenido.Clsetiqueta4.Name = "Clsetiqueta4"
contenido.sel_Articulo.txtCodigo.Name = "txtCodigo"
contenido.sel_Articulo.txtDescripcion.Name = "txtDescripcion"
contenido.sel_Articulo.TabIndex = 5
contenido.sel_Articulo.Name = "sel_Articulo"
contenido.Clsetiqueta5.Left = 238
contenido.Clsetiqueta5.Top = 144
contenido.Clsetiqueta5.TabIndex = 47
contenido.Clsetiqueta5.Name = "Clsetiqueta5"
contenido.txtCantidad.Left = 291
contenido.txtCantidad.TabIndex = 8
contenido.txtCantidad.Top = 140
contenido.txtCantidad.Name = "txtCantidad"
contenido.btnAgregar.TabIndex = 9
contenido.btnAgregar.Name = "btnAgregar"
contenido.grdDetalles.COLUMN1.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN1.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN1.Name = "COLUMN1"
contenido.grdDetalles.COLUMN2.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN2.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN2.Name = "COLUMN2"
contenido.grdDetalles.COLUMN3.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN3.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN3.Name = "COLUMN3"
contenido.grdDetalles.COLUMN4.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN4.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN4.Name = "COLUMN4"
contenido.grdDetalles.COLUMN5.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN5.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN5.Name = "COLUMN5"
contenido.grdDetalles.COLUMN6.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN6.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN6.Name = "COLUMN6"
contenido.grdDetalles.COLUMN7.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN7.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN7.Name = "COLUMN7"
contenido.grdDetalles.COLUMN8.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN8.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN8.Name = "COLUMN8"
contenido.grdDetalles.COLUMN9.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN9.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN9.Name = "COLUMN9"
contenido.grdDetalles.COLUMN10.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN10.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN10.Name = "COLUMN10"
contenido.grdDetalles.COLUMN11.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN11.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN11.Name = "COLUMN11"
contenido.grdDetalles.COLUMN12.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN12.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN12.Name = "COLUMN12"
contenido.grdDetalles.COLUMN13.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN13.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN13.Name = "COLUMN13"
contenido.grdDetalles.COLUMN14.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN14.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN14.Name = "COLUMN14"
contenido.grdDetalles.COLUMN15.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN15.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN15.Name = "COLUMN15"
contenido.grdDetalles.COLUMN16.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN16.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN16.Name = "COLUMN16"
contenido.grdDetalles.COLUMN17.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN17.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN17.Name = "COLUMN17"
contenido.grdDetalles.COLUMN18.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN18.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN18.Name = "COLUMN18"
contenido.grdDetalles.COLUMN19.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN19.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN19.Name = "COLUMN19"
contenido.grdDetalles.COLUMN20.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN20.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN20.Name = "COLUMN20"
contenido.grdDetalles.TabIndex = 48
contenido.grdDetalles.Name = "grdDetalles"
contenido.btnGrabar.TabIndex = 11
contenido.btnGrabar.Name = "btnGrabar"
contenido.btnCancelar.TabIndex = 13
contenido.btnCancelar.Name = "btnCancelar"
contenido.Clscerrar1.TabIndex = 12
contenido.Clscerrar1.Name = "Clscerrar1"
contenido.Clsetiqueta10.Left = 372
contenido.Clsetiqueta10.Top = 144
contenido.Clsetiqueta10.TabIndex = 70
contenido.Clsetiqueta10.Name = "Clsetiqueta10"
contenido.txtPrMay.Left = 477
contenido.txtPrMay.TabIndex = 29
contenido.txtPrMay.Top = 140
contenido.txtPrMay.Name = "txtPrMay"
contenido.Clsetiqueta11.Left = 586
contenido.Clsetiqueta11.Top = 144
contenido.Clsetiqueta11.TabIndex = 73
contenido.Clsetiqueta11.Name = "Clsetiqueta11"
contenido.txtPrMinorista.Left = 691
contenido.txtPrMinorista.TabIndex = 28
contenido.txtPrMinorista.Top = 140
contenido.txtPrMinorista.Name = "txtPrMinorista"
contenido.Clsetiqueta12.TabIndex = 79
contenido.Clsetiqueta12.Name = "Clsetiqueta12"
contenido.txtAlicIVA.TabIndex = 80
contenido.txtAlicIVA.Name = "txtAlicIVA"
contenido.btnEliminar.TabIndex = 10
contenido.btnEliminar.Name = "btnEliminar"
contenido.chkImprimeDup.Alignment = 0
contenido.chkImprimeDup.TabIndex = 87
contenido.chkImprimeDup.Name = "chkImprimeDup"
contenido.btnCbteOrigen.TabIndex = 30
contenido.btnCbteOrigen.Name = "btnCbteOrigen"
contenido.txtObserv.TabIndex = 26
contenido.txtObserv.Name = "txtObserv"
contenido.Clsetiqueta6.TabIndex = 49
contenido.Clsetiqueta6.Name = "Clsetiqueta6"
contenido.Clsetiqueta7.TabIndex = 53
contenido.Clsetiqueta7.Name = "Clsetiqueta7"
contenido.Clsetiqueta8.TabIndex = 56
contenido.Clsetiqueta8.Name = "Clsetiqueta8"
contenido.Clsetiqueta9.TabIndex = 57
contenido.Clsetiqueta9.Name = "Clsetiqueta9"
contenido.txtTotNeto.TabIndex = 59
contenido.txtTotNeto.Name = "txtTotNeto"
contenido.txtPorIVA21.TabIndex = 62
contenido.txtPorIVA21.Name = "txtPorIVA21"
contenido.txtPorIVA105.TabIndex = 63
contenido.txtPorIVA105.Name = "txtPorIVA105"
contenido.txtImpIVA21.TabIndex = 65
contenido.txtImpIVA21.Name = "txtImpIVA21"
contenido.txtImpIVA105.TabIndex = 66
contenido.txtImpIVA105.Name = "txtImpIVA105"
contenido.txtTotal.TabIndex = 67
contenido.txtTotal.Name = "txtTotal"
contenido.Clsetiqueta14.TabIndex = 82
contenido.Clsetiqueta14.Name = "Clsetiqueta14"
contenido.txtDesc1.ReadOnly = .F.
contenido.txtDesc1.TabIndex = 16
contenido.txtDesc1.Name = "txtDesc1"
contenido.txtDesc2.ReadOnly = .F.
contenido.txtDesc2.TabIndex = 17
contenido.txtDesc2.Name = "txtDesc2"
contenido.txtDesc3.ReadOnly = .F.
contenido.txtDesc3.TabIndex = 19
contenido.txtDesc3.Name = "txtDesc3"
contenido.txtDesc4.ReadOnly = .F.
contenido.txtDesc4.TabIndex = 20
contenido.txtDesc4.Name = "txtDesc4"
contenido.txtImpDesc1.TabIndex = 35
contenido.txtImpDesc1.Name = "txtImpDesc1"
contenido.txtImpDesc2.TabIndex = 36
contenido.txtImpDesc2.Name = "txtImpDesc2"
contenido.txtImpDesc3.TabIndex = 37
contenido.txtImpDesc3.Name = "txtImpDesc3"
contenido.txtImpDesc4.TabIndex = 38
contenido.txtImpDesc4.Name = "txtImpDesc4"
contenido.Clsetiqueta15.TabIndex = 81
contenido.Clsetiqueta15.Name = "Clsetiqueta15"
contenido.Clsetiqueta16.TabIndex = 84
contenido.Clsetiqueta16.Name = "Clsetiqueta16"
contenido.Clsetiqueta17.TabIndex = 58
contenido.Clsetiqueta17.Name = "Clsetiqueta17"
contenido.txtTotFact.TabIndex = 68
contenido.txtTotFact.Name = "txtTotFact"
contenido.Clsetiqueta18.TabIndex = 54
contenido.Clsetiqueta18.Name = "Clsetiqueta18"
contenido.txtPorIIBB.TabIndex = 61
contenido.txtPorIIBB.Name = "txtPorIIBB"
contenido.txtImpIIBB.TabIndex = 64
contenido.txtImpIIBB.Name = "txtImpIIBB"
contenido.Clsetiqueta19.TabIndex = 83
contenido.Clsetiqueta19.Name = "Clsetiqueta19"
contenido.txtST.TabIndex = 60
contenido.txtST.Name = "txtST"
contenido.Clsetiqueta20.TabIndex = 69
contenido.Clsetiqueta20.Name = "Clsetiqueta20"
contenido.txtPorDesc1.ReadOnly = .F.
contenido.txtPorDesc1.TabIndex = 21
contenido.txtPorDesc1.Name = "txtPorDesc1"
contenido.txtImpDescItem1.TabIndex = 88
contenido.txtImpDescItem1.Name = "txtImpDescItem1"
contenido.txtPorDesc2.ReadOnly = .F.
contenido.txtPorDesc2.TabIndex = 22
contenido.txtPorDesc2.Name = "txtPorDesc2"
contenido.txtImpDescItem2.TabIndex = 89
contenido.txtImpDescItem2.Name = "txtImpDescItem2"
contenido.txtPorDesc3.ReadOnly = .F.
contenido.txtPorDesc3.TabIndex = 23
contenido.txtPorDesc3.Name = "txtPorDesc3"
contenido.txtImpDescItem3.TabIndex = 90
contenido.txtImpDescItem3.Name = "txtImpDescItem3"
contenido.txtPorDesc4.ReadOnly = .F.
contenido.txtPorDesc4.TabIndex = 24
contenido.txtPorDesc4.Name = "txtPorDesc4"
contenido.txtImpDescItem4.TabIndex = 91
contenido.txtImpDescItem4.Name = "txtImpDescItem4"
contenido.Clsetiqueta21.TabIndex = 78
contenido.Clsetiqueta21.Name = "Clsetiqueta21"
contenido.txtImpIVA.TabIndex = 92
contenido.txtImpIVA.Name = "txtImpIVA"
contenido.Clsetiqueta22.TabIndex = 74
contenido.Clsetiqueta22.Name = "Clsetiqueta22"
contenido.txtSTNeto.TabIndex = 76
contenido.txtSTNeto.Name = "txtSTNeto"
contenido.Clsetiqueta13.TabIndex = 85
contenido.Clsetiqueta13.Name = "Clsetiqueta13"
contenido.txtSubTotal.TabIndex = 86
contenido.txtSubTotal.Name = "txtSubTotal"
contenido.Clsetiqueta23.TabIndex = 72
contenido.Clsetiqueta23.Name = "Clsetiqueta23"
contenido.txtPrNeto.TabIndex = 75
contenido.txtPrNeto.Name = "txtPrNeto"
contenido.lblExistencia.TabIndex = 77
contenido.lblExistencia.Name = "lblExistencia"
contenido.txtExistencia.TabIndex = 93
contenido.txtExistencia.Name = "txtExistencia"
contenido.Clsetiqueta24.TabIndex = 50
contenido.Clsetiqueta24.Name = "Clsetiqueta24"
contenido.txtPorRec.TabIndex = 15
contenido.txtPorRec.Name = "txtPorRec"
contenido.txtImpRec.TabIndex = 94
contenido.txtImpRec.Name = "txtImpRec"
contenido.txtRecItem.TabIndex = 39
contenido.txtRecItem.Name = "txtRecItem"
contenido.Clsetiqueta25.TabIndex = 41
contenido.Clsetiqueta25.Name = "Clsetiqueta25"
contenido.txtTelefono.TabIndex = 31
contenido.txtTelefono.Name = "txtTelefono"
contenido.Clsetiqueta26.TabIndex = 52
contenido.Clsetiqueta26.Name = "Clsetiqueta26"
contenido.txtcuit.TabIndex = 2
contenido.txtcuit.Name = "txtcuit"
contenido.Clsetiqueta27.Left = 9
contenido.Clsetiqueta27.Top = 144
contenido.Clsetiqueta27.TabIndex = 46
contenido.Clsetiqueta27.Name = "Clsetiqueta27"
contenido.cboUnidVta.Left = 114
contenido.cboUnidVta.TabIndex = 7
contenido.cboUnidVta.Top = 140
contenido.cboUnidVta.Name = "cboUnidVta"
contenido.txtCantPack.Left = 176
contenido.txtCantPack.TabIndex = 27
contenido.txtCantPack.Top = 140
contenido.txtCantPack.Name = "txtCantPack"
contenido.Clsetiqueta28.TabIndex = 51
contenido.Clsetiqueta28.Name = "Clsetiqueta28"
contenido.txtOC.TabIndex = 34
contenido.txtOC.Name = "txtOC"
contenido.Clsetiqueta29.TabIndex = 71
contenido.Clsetiqueta29.Name = "Clsetiqueta29"
contenido.txtPorRecItem.TabIndex = 25
contenido.txtPorRecItem.Name = "txtPorRecItem"
contenido.Clsetiqueta30.TabIndex = 45
contenido.Clsetiqueta30.Name = "Clsetiqueta30"
contenido.TXTFECEMIS.TabIndex = 4
contenido.TXTFECEMIS.Name = "TXTFECEMIS"
contenido.Clsetiqueta31.TabIndex = 55
contenido.Clsetiqueta31.Name = "Clsetiqueta31"
contenido.txtMailFC.TabIndex = 14
contenido.txtMailFC.Name = "txtMailFC"
contenido.chkEnviarMail.Alignment = 0
contenido.chkEnviarMail.TabIndex = 18
contenido.chkEnviarMail.Name = "chkEnviarMail"
contenido.lblPrecioUnitFinal.Name = "lblPrecioUnitFinal"
contenido.txtPrUnitFinal.Name = "txtPrUnitFinal"
contenido.chkImprimirCbte.Alignment = 0
contenido.chkImprimirCbte.Name = "chkImprimirCbte"
contenido.BTNAGREGARCLIENTE.Name = "BTNAGREGARCLIENTE"
contenido.CLSETIQUETA32.Name = "CLSETIQUETA32"
contenido.TXT_SUBTOTAL_NO_GRAV.Name = "TXT_SUBTOTAL_NO_GRAV"
contenido.CLSETIQUETA33.Name = "CLSETIQUETA33"
contenido.TXT_TOTAL_NO_GRAV.Name = "TXT_TOTAL_NO_GRAV"
contenido.Name = "contenido"
mov_stock.Name = "mov_stock"
faltantes.Name = "faltantes"
fe.Top = 480
fe.Left = 612
fe.Height = 24
fe.Width = 36
fe.Name = "fe"

*** METODOS ***
PROCEDURE recalcular_todo
LOCAL lo_artic, lcSql
LOCAL lnPorDesc1, lnPorDesc2, lnPorDesc3, lnPorDesc4
LOCAL lnImpDesc1, lnImpDesc2, lnImpDesc3, lnImpDesc4
LOCAL lnPrVtaMax, lnPrVtaMin, lnPrecio, lnNeto, lnSubTotNeto
LOCAL lnPorRec, lnImpRec, lnPrOferta, llEsOferta

lcSql = ""
lo_artic = CREATEOBJECT("odbc_result")
lnPrOferta = 0.00
llEsOferta = .F.

SELECT cur_Deta_View
IF RECCOUNT("cur_Deta_View") > 0 THEN
	GO TOP
ENDIF

&& Recalculo los datos de la grilla
DO WHILE !EOF("cur_Deta_View")
	lcSql = "SELECT * FROM articulos WHERE articulos.idArticulo = " + ALLTRIM(STR(cur_Deta_View.idArticulo))

	lo_artic.ActiveConnection = goConn.ActiveConnection
	lo_artic.cursor_name = "tmp_artic"
	
	IF !lo_artic.OpenQuery(lcSql) THEN
		MESSAGEBOX(lo_artic.error_Message, 0+16, Thisform.Caption)
		RETURN .F.
	ENDIF

	SELECT tmp_artic
	IF RECCOUNT() > 0 THEN
		lnPrOferta = thisform.getoferta_byart(cur_Deta_View.idArticulo)
	
		SELECT cur_Deta_View
		LOCK()
		
*******************************************************************************************************************************
* Recalculo los precios mayorista y minorista segun los descuentos del cliente
*******************************************************************************************************************************

		lnPorDesc1 = Thisform.contenido.txtDesc1.Value
		lnPorDesc2 = Thisform.contenido.txtDesc2.Value
		lnPorDesc3 = Thisform.contenido.txtDesc3.Value
		lnPorDesc4 = Thisform.contenido.txtDesc4.Value
		lnImpDesc1 = 0.00
		lnImpDesc2 = 0.00
		lnImpDesc3 = 0.00
		lnImpDesc4 = 0.00
		lnPrVtaMax = 0.00
		lnPrVtaMin = 0.00

		SELECT tmp_artic
		lnPrVtaMax = tmp_artic.prVentaMax + (tmp_artic.prVentaMax * (cur_Deta_View.pRecItem / 100))
		lnPrVtaMin = tmp_artic.prVentaMin + (tmp_artic.prVentaMin * (cur_Deta_View.pRecItem / 100))
		
*!*			IF RIGHT(ALLTRIM(cur_Deta_View.codArt), 3) == "ARX" THEN
*!*				lnPrecio = cur_Deta_View.prArtic
*!*			ELSE
*!*				IF lnPrOferta <> 0 THEN
*!*					lnPrecio = lnPrOferta
*!*				ELSE
*!*					IF clientes.mayorista
*!*						lnPrecio = lnPrVtaMax
*!*					ELSE 
*!*						lnPrecio = lnPrVtaMin
*!*					ENDIF 	
*!*				ENDIF
*!*			ENDIF
		
		IF RIGHT(ALLTRIM(cur_Deta_View.codArt), 3) == "ARX" THEN
			lnPrecio = cur_Deta_View.prArtic
		ELSE
			IF clientes.mayorista THEN 
				IF lnPrOferta = 0 THEN
					lnPrecio = lnPrVtaMax
					llEsOferta = .F.
				ELSE 
					lnPrecio = lnPrOferta
					llEsOferta = .T.
				ENDIF 
			ELSE 
				lnPrecio = lnPrVtaMin
				llEsOferta = .F.
			ENDIF 
		ENDIF
		
		lnPrecio = lnPrecio + (lnPrecio * (cur_Deta_View.pRecItem / 100))
		
		REPLACE cur_Deta_View.prArtic WITH lnPrecio ADDITIVE
		
		&& Calculo el precio con descuento del cliente
		lnImpDesc1 = lnPrecio * (lnPorDesc1 / 100)
		lnImpDesc2 = (lnPrecio - lnImpDesc1 ) * (lnPorDesc2 / 100)
		lnImpDesc3 = (lnPrecio - lnImpDesc1 - lnImpDesc2 ) * (lnPorDesc3 / 100)
		lnImpDesc4 = (lnPrecio - lnImpDesc1 - lnImpDesc2 - lnImpDesc3) * (lnPorDesc4 / 100)
		lnPrecio = lnPrecio - lnImpDesc1 - lnImpDesc2 - lnImpDesc3 - lnImpDesc4
		
		REPLACE cur_Deta_View.prVta WITH lnPrecio ADDITIVE  
		
		REPLACE cur_Deta_View.pDtoCli1 WITH lnPorDesc1 ADDITIVE
		REPLACE cur_Deta_View.pDtoCli2 WITH lnPorDesc2 ADDITIVE
		REPLACE cur_Deta_View.pDtoCli3 WITH lnPorDesc3 ADDITIVE
		REPLACE cur_Deta_View.pDtoCli4 WITH lnPorDesc4 ADDITIVE
		REPLACE cur_Deta_View.iDtoCli1 WITH lnImpDesc1 ADDITIVE
		REPLACE cur_Deta_View.iDtoCli2 WITH lnImpDesc2 ADDITIVE
		REPLACE cur_Deta_View.iDtoCli3 WITH lnImpDesc3 ADDITIVE
		REPLACE cur_Deta_View.iDtoCli4 WITH lnImpDesc4 ADDITIVE
		REPLACE cur_Deta_View.esOferta WITH llEsOferta ADDITIVE
		
*******************************************************************************************************************************
* Recalculo los precios de acuerdo al descuento de cada item
*******************************************************************************************************************************

		lnPorDesc1 = cur_Deta_View.pDtoVta1
		lnPorDesc2 = cur_Deta_View.pDtoVta2
		lnPorDesc3 = cur_Deta_View.pDtoVta3
		lnPorDesc4 = cur_Deta_View.pDtoVta4
		lnImpDesc1 = 0.00
		lnImpDesc2 = 0.00
		lnImpDesc3 = 0.00
		lnImpDesc4 = 0.00
		lnNeto = 0.00

		&& Calculo el precio neto
		lnImpDesc1 = lnPrecio * (lnPorDesc1 / 100)
		lnImpDesc2 = (lnPrecio - lnImpDesc1 ) * (lnPorDesc2 / 100)
		lnImpDesc3 = (lnPrecio - lnImpDesc1 - lnImpDesc2 ) * (lnPorDesc3 / 100)
		lnImpDesc4 = (lnPrecio - lnImpDesc1 - lnImpDesc2 - lnImpDesc3) * (lnPorDesc4 / 100)
		lnNeto = lnPrecio - lnImpDesc1 - lnImpDesc2 - lnImpDesc3 - lnImpDesc4
		
		REPLACE cur_Deta_View.iDtoVta1 WITH lnImpDesc1 ADDITIVE
		REPLACE cur_Deta_View.iDtoVta2 WITH lnImpDesc2 ADDITIVE
		REPLACE cur_Deta_View.iDtoVta3 WITH lnImpDesc3 ADDITIVE
		REPLACE cur_Deta_View.iDtoVta4 WITH lnImpDesc4 ADDITIVE
		
*******************************************************************************************************************************
* Recalculo el recargo 
*******************************************************************************************************************************
		lnPorRec = Thisform.contenido.txtporrec.Value 
		
		lnImpRec = ROUND(lnNeto * (lnPorRec / 100), 2)
		lnNeto = lnNeto + lnImpRec
		
		* Recalculo el recargo por ítem
		*lnNeto = lnNeto + (lnNeto * (cur_Deta_View.pRecItem / 100))				

*******************************************************************************************************************************
* Recalculo el IVA y los Subtotales
*******************************************************************************************************************************
		REPLACE cur_Deta_View.impNeto WITH lnNeto ADDITIVE 
		
		lnSubTotNeto = ROUND(lnNeto * cur_Deta_View.cantidad, 2)
		
		IF (ALLTRIM(Thisform.cbte) == "PTO") THEN
			REPLACE cur_Deta_View.impIVA WITH 0 ADDITIVE
			REPLACE cur_Deta_View.alicIVA WITH 0 ADDITIVE
		ELSE
			REPLACE cur_Deta_View.impIVA WITH ROUND(lnSubTotNeto * (tmp_artic.alicIVA / 100), 2) ADDITIVE
			REPLACE cur_Deta_View.alicIVA WITH tmp_artic.alicIVA ADDITIVE
		ENDIF
		
		REPLACE cur_Deta_View.totNeto WITH lnSubTotNeto ADDITIVE
		
		IF (ALLTRIM(Thisform.cbte) == "PTO") THEN
			REPLACE cur_Deta_View.subTotal WITH cur_Deta_View.totNeto ADDITIVE		
		ELSE 
			REPLACE cur_Deta_View.subTotal WITH cur_Deta_View.totNeto + cur_Deta_View.impIVA ADDITIVE
		ENDIF 
		UNLOCK
	ENDIF

	lo_artic.close_query()
		
	SELECT cur_Deta_View
	SKIP
ENDDO

IF !(ALLTRIM(Thisform.contenido.sel_Articulo.txtCodigo.Value) == "") THEN
	Thisform.contenido.sel_Articulo.recuperar_datos()
	Thisform.contenido.sel_Articulo.txtCodigo.Valid()
ENDIF

SELECT cur_Deta_View
IF RECCOUNT("cur_Deta_View") > 0 THEN
	GO TOP
ENDIF

Thisform.contenido.grdDetalles.Refresh()
Thisform.sumar_items()
Thisform.calcular_ret_iibb()

RETURN .T.

ENDPROC
PROCEDURE particionar_cbte
************************************************************************************
** Esta función permite grabar una factura cada 25 items.
** Pablo Díaz
** Adaptado por Leonardo Zulli
************************************************************************************

LOCAL ln_cantitems
LOCAL lnResp, llPreguntarPorComprobante

STORE 0 TO lnResp, ln_cantitems
STORE getGlobalCFG("RTOIMPXFC") TO llPreguntarPorComprobante

IF getGlobalCFG("PRINT_RTO") .AND. !llPreguntarPorComprobante THEN
	lnResp = MESSAGEBOX("Desea imprimir remitos para este cliente", 4+32, Thisform.Caption)
ENDIF

SELECT cur_aux
ZAP 

*!*	IF !(ALLTRIM(thisform.cbte) == "COT") .AND. getGlobalCFG("STK_MODULE") THEN
*!*		IF !thisform.validar_stk_en_grabado() THEN
*!*			goConn.Rollback()
*!*			RETURN
*!*		ENDIF
*!*	ENDIF

SELECT cur_detalle
IF RECCOUNT() > 0 THEN 
	GO TOP
ELSE 
	RETURN 
ENDIF 

************************************************************************************
** Paso de a 25 items del cursor de detalle al cursor auxiliar
************************************************************************************
SELECT cur_detalle
DO WHILE !EOF()
	ln_cantitems = ln_cantitems + 1
	
	SELECT cur_aux
	APPEND BLANK	
	
	REPLACE cur_aux.idDetalle WITH cur_detalle.idDetalle
	REPLACE cur_aux.idArticulo WITH cur_detalle.idArticulo ADDITIVE
	REPLACE cur_aux.codArt WITH cur_detalle.codArt ADDITIVE
	REPLACE cur_aux.descripcio WITH cur_detalle.descripcio ADDITIVE
	REPLACE cur_aux.nroPart WITH cur_detalle.nroPart ADDITIVE
	REPLACE cur_aux.cantidad WITH cur_detalle.cantidad ADDITIVE
	REPLACE cur_aux.prVta WITH cur_detalle.prVta ADDITIVE
	REPLACE cur_aux.pDtoVta1 WITH cur_detalle.pDtoVta1 ADDITIVE
	REPLACE cur_aux.pDtoVta2 WITH cur_detalle.pDtoVta2 ADDITIVE
	REPLACE cur_aux.pDtoVta3 WITH cur_detalle.pDtoVta3 ADDITIVE
	REPLACE cur_aux.pDtoVta4 WITH cur_detalle.pDtoVta4 ADDITIVE
	REPLACE cur_aux.iDtoVta1 WITH cur_detalle.iDtoVta1 ADDITIVE
	REPLACE cur_aux.iDtoVta2 WITH cur_detalle.iDtoVta2 ADDITIVE
	REPLACE cur_aux.iDtoVta3 WITH cur_detalle.iDtoVta3 ADDITIVE
	REPLACE cur_aux.iDtoVta4 WITH cur_detalle.iDtoVta4 ADDITIVE
	REPLACE cur_aux.pDtoCli1 WITH cur_detalle.pDtoCli1 ADDITIVE
	REPLACE cur_aux.pDtoCli2 WITH cur_detalle.pDtoCli2 ADDITIVE
	REPLACE cur_aux.pDtoCli3 WITH cur_detalle.pDtoCli3 ADDITIVE
	REPLACE cur_aux.pDtoCli4 WITH cur_detalle.pDtoCli4 ADDITIVE
	REPLACE cur_aux.iDtoCli1 WITH cur_detalle.iDtoCli1 ADDITIVE
	REPLACE cur_aux.iDtoCli2 WITH cur_detalle.iDtoCli2 ADDITIVE
	REPLACE cur_aux.iDtoCli3 WITH cur_detalle.iDtoCli3 ADDITIVE
	REPLACE cur_aux.iDtoCli4 WITH cur_detalle.iDtoCli4 ADDITIVE
	REPLACE cur_aux.pRecItem WITH cur_detalle.pRecItem ADDITIVE
	REPLACE cur_aux.iRecItem WITH cur_detalle.iRecItem ADDITIVE
	REPLACE cur_aux.alicIVA WITH cur_detalle.alicIVA ADDITIVE
	REPLACE cur_aux.impIVA WITH cur_detalle.impIVA ADDITIVE
	REPLACE cur_aux.impNeto WITH cur_detalle.impNeto ADDITIVE
	REPLACE cur_aux.totNeto WITH cur_detalle.totNeto ADDITIVE
	REPLACE cur_aux.subTotal WITH cur_detalle.subTotal ADDITIVE
	REPLACE cur_aux.prArtic WITH cur_detalle.prArtic ADDITIVE
	REPLACE cur_aux.esOferta WITH cur_detalle.esOferta ADDITIVE
	REPLACE cur_aux.pRecVta WITH cur_detalle.pRecVta ADDITIVE 
	REPLACE cur_aux.iRecVta WITH cur_detalle.iRecVta ADDITIVE
	REPLACE cur_aux.uniDesp WITH cur_detalle.uniDesp ADDITIVE
	REPLACE cur_aux.cantPack WITH cur_detalle.cantPack ADDITIVE 
	REPLACE cur_aux.uniMed WITH cur_detalle.uniMed ADDITIVE
	REPLACE cur_aux.detobs WITH cur_detalle.detobs ADDITIVE
	
	&& Cuando el contador llegue a 25 items grabo una factura nueva.
	IF ln_cantitems = 25
		&& tengo que hacer el calculo de los totales y el grabado		
		Thisform.calc_subtot_cur_aux()
		
		IF !thisform.grabar_cbte_part()
			MESSAGEBOX("Error al intentar grabar el comprobante", 0+16, Thisform.Caption)
			RETURN .F.
		ENDIF	
		
		IF !thisform.enviar_wsafipfe() THEN
			MESSAGEBOX(Thisform.error_message, 0+48, Thisform.Caption)
			*RETURN .F.
		ELSE
			IF thisform.fe_set_cae() THEN
				thisform.grabar_ctacte(thisform.id_ventasc)
				thisform.imprimir()
				
				&& Habilito la pregunta solo si está habilitada la impresión de remitos
				IF getGlobalCFG("PRINT_RTO") THEN
					&& Pregunto si quiere imprimir el remito por comprobante
					IF llPreguntarPorComprobante THEN
						lnResp = MESSAGEBOX("Desea imprimir remitos para esta factura", 4+32, Thisform.Caption)
					ENDIF
					
					IF lnResp = 6 THEN
						Thisform.generar_remitos()
					ENDIF
				ENDIF			
			ENDIF
		ENDIF
		
		ln_cantitems = 0
		
		SELECT cur_aux
		ZAP
		Thisform.mov_stock.limpiar()	
	ENDIF 
	
	SELECT cur_detalle
	SKIP  
ENDDO 

&& En el caso que la ultima factura no haya llegado a los 25 items
&& tengo que hacer una nueva factura con los items restantes.
IF ln_cantitems <> 0 
	&& tengo que hacer el calculo de los totales y el grabado
	Thisform.calc_subtot_cur_aux()
	
	IF !thisform.grabar_cbte_part()
		MESSAGEBOX("Error al intentar grabar el comprobante", 0+16, Thisform.Caption)
		RETURN .F.
	ENDIF	
	
	IF !thisform.enviar_wsafipfe() THEN
		MESSAGEBOX("Este comprobante no ha sido autorizado, por favor, vuelva a intentarlo desde la autorización diferida", 0+48, Thisform.Caption)
		RETURN .F.
	ELSE
		IF thisform.fe_set_cae() THEN
			&& Si se asignó el número de CAE, entonces procedo a hacer el grabado
			&& de la cuenta corriente.
			thisform.grabar_ctacte(thisform.id_ventasc)
			thisform.imprimir()
			
			&& Habilito la pregunta solo si está habilitada la emisión de remitos
			IF getGlobalCFG("PRINT_RTO") THEN
				&& Pregunto si quiere impimir el remito por comprobante
				IF llPreguntarPorComprobante THEN
					lnResp = MESSAGEBOX("Desea imprimir remitos para esta factura", 4+32, Thisform.Caption)
				ENDIF
				
				IF lnResp = 6 .AND. getGlobalCFG("PRINT_RTO") THEN
					Thisform.generar_remitos()
				ENDIF
			ENDIF						
			thisform.id_ventasc = 0
		ENDIF
	ENDIF
	
	Thisform.mov_stock.limpiar()
ENDIF 

RETURN .T.
ENDPROC
PROCEDURE agregar_item
LOCAL lnPDtoCli1, lnPDtoCli2, lnPDtoCli3, lnPDtoCli4
LOCAL lnIDtoCli1, lnIDtoCli2, lnIDtoCli3, lnIDtoCli4
LOCAL lnPDtoVta1, lnPDtoVta2, lnPDtoVta3, lnPDtoVta4
LOCAL lnIDtoVta1, lnIDtoVta2, lnIDtoVta3, lnIDtoVta4
LOCAL lnSTNeto, lnSubTotal, lnPrNeto1, lnPrNeto2, lnImpNeto
LOCAL loResult, lcSql, lnPrecio, lnAlicIva
LOCAL lnPRecVta, lnIRecVta

lnPDtoCli1 = Thisform.contenido.txtDesc1.Value
lnPDtoCli2 = Thisform.contenido.txtDesc2.Value
lnPDtoCli3 = Thisform.contenido.txtDesc3.Value
lnPDtoCli4 = Thisform.contenido.txtDesc4.Value
lnIDtoCli1 = 0.00
lnIDtoCli2 = 0.00
lnIDtoCli3 = 0.00
lnIDtoCli4 = 0.00
lnPDtoVta1 = 0.00
lnPDtoVta2 = 0.00
lnPDtoVta3 = 0.00
lnPDtoVta4 = 0.00
lnIDtoVta1 = 0.00
lnIDtoVta2 = 0.00
lnIDtoVta3 = 0.00
lnIDtoVta4 = 0.00
lnPrecio = 0.00
lnSTNeto = 0.00
lnSubTotal = 0.00
loResult = CREATEOBJECT("odbc_result")
lcSql = ""
lnPrNeto1 = 0.00
lnPrNeto2 = 0.00
lnAlicIva = 0.00
lnPRecVta = Thisform.contenido.txtporrec.Value 
lnIRecVta = 0.00

IF glVersionBeta THEN
	SELECT cur_Detalle
	IF RECCOUNT() = 5 THEN
		MESSAGEBOX("Usted está utilizando una versión límitada del sistema, si desea comprarlo envíe un mail a ldz.software@gmail.com", 0+64, Thisform.Caption)
		RETURN .F.
	ENDIF
ENDIF

* Valido si el artículo ya se encuentra cargado en el presupuesto

SELECT cur_Deta_View
IF RECCOUNT("cur_Deta_View") > 0 THEN
	GO TOP
ENDIF

DO WHILE !EOF("cur_Deta_View")
	IF (ALLTRIM(Thisform.cbte) != "PED") THEN 
		IF !thisform.asignar_partida(cur_Deta_View.idArticulo, cur_Deta_View.Cantidad) THEN
			MESSAGEBOX("Ha ocurrido un error al intentar asignar partidas", 0+48, thisform.Caption)
			RETURN .F.
		ENDIF
	ENDIF  


	lnIDtoCli1 = cur_Deta_View.iDtoCli1
	lnIDtoCli2 = cur_Deta_View.iDtoCli2
	lnIDtoCli3 = cur_Deta_View.iDtoCli3
	lnIDtoCli4 = cur_Deta_View.iDtoCli4
	lnIDtoVta1 = cur_Deta_View.iDtoVta1
	lnIDtoVta2 = cur_Deta_View.iDtoVta2
	lnIDtoVta3 = cur_Deta_View.iDtoVta3
	lnIDtoVta4 = cur_Deta_View.iDtoVta4

	&& Si cur_DetPart es 0 (Cero)
	SELECT cur_DetPart
	IF RECCOUNT("cur_DetPart") = 0 THEN
		SELECT cur_Detalle
		APPEND BLANK
		REPLACE cur_Detalle.idDetalle WITH RECCOUNT("cur_Detalle") + 1
		REPLACE cur_Detalle.idArticulo WITH cur_Deta_View.idArticulo 			ADDITIVE
		REPLACE cur_Detalle.codArt WITH ALLTRIM(cur_Deta_View.codArt)			ADDITIVE
		REPLACE cur_Detalle.descripcio WITH ALLTRIM(cur_Deta_View.descripcio) 	ADDITIVE
		REPLACE cur_Detalle.nroPart WITH "" 									ADDITIVE
		REPLACE cur_Detalle.cantidad WITH cur_Deta_View.cantidad 				ADDITIVE
		REPLACE cur_Detalle.prVta WITH cur_Deta_View.prVta						ADDITIVE
		REPLACE cur_Detalle.prArtic WITH cur_Deta_View.prArtic					ADDITIVE
		REPLACE cur_Detalle.pDtoVta1 WITH cur_Deta_View.pDtoVta1				ADDITIVE
		REPLACE cur_Detalle.pDtoVta2 WITH cur_Deta_View.pDtoVta2				ADDITIVE
		REPLACE cur_Detalle.pDtoVta3 WITH cur_Deta_View.pDtoVta3				ADDITIVE
		REPLACE cur_Detalle.pDtoVta4 WITH cur_Deta_View.pDtoVta4				ADDITIVE
		REPLACE cur_Detalle.iDtoVta1 WITH cur_Deta_View.iDtoVta1				ADDITIVE
		REPLACE cur_Detalle.iDtoVta2 WITH cur_Deta_View.iDtoVta2				ADDITIVE
		REPLACE cur_Detalle.iDtoVta3 WITH cur_Deta_View.iDtoVta3				ADDITIVE
		REPLACE cur_Detalle.iDtoVta4 WITH cur_Deta_View.iDtoVta4				ADDITIVE
		REPLACE cur_Detalle.impNeto WITH cur_Deta_View.impNeto					ADDITIVE
		REPLACE cur_Detalle.impIVA WITH cur_Deta_View.impIVA					ADDITIVE
		REPLACE cur_Detalle.alicIVA WITH cur_Deta_View.alicIVA					ADDITIVE
		REPLACE cur_Detalle.totNeto WITH cur_Deta_View.totNeto					ADDITIVE
		REPLACE cur_Detalle.subTotal WITH cur_Deta_View.subTotal				ADDITIVE
		REPLACE cur_Detalle.pDtoCli1 WITH cur_Deta_View.pDtoCli1 				ADDITIVE
		REPLACE cur_Detalle.pDtoCli2 WITH cur_Deta_View.pDtoCli2 				ADDITIVE
		REPLACE cur_Detalle.pDtoCli3 WITH cur_Deta_View.pDtoCli3 				ADDITIVE
		REPLACE cur_Detalle.pDtoCli4 WITH cur_Deta_View.pDtoCli4 				ADDITIVE
		REPLACE cur_Detalle.iDtoCli1 WITH cur_Deta_View.iDtoCli1 				ADDITIVE
		REPLACE cur_Detalle.iDtoCli2 WITH cur_Deta_View.iDtoCli2 				ADDITIVE
		REPLACE cur_Detalle.iDtoCli3 WITH cur_Deta_View.iDtoCli3 				ADDITIVE
		REPLACE cur_Detalle.iDtoCli4 WITH cur_Deta_View.iDtoCli4 				ADDITIVE
		REPLACE cur_Detalle.esOferta WITH cur_Deta_View.esOferta 				ADDITIVE
		REPLACE cur_Detalle.pRecVta WITH cur_Deta_View.pRecVta					ADDITIVE 
		REPLACE cur_Detalle.iRecVta WITH cur_Deta_View.iRecVta					ADDITIVE 
		REPLACE cur_Detalle.uniDesp WITH cur_Deta_View.uniDesp					ADDITIVE
		REPLACE cur_Detalle.cantPack WITH cur_Deta_View.cantPack				ADDITIVE
		REPLACE cur_Detalle.uniMed WITH cur_Deta_View.uniMed					ADDITIVE
		REPLACE cur_Detalle.detobs WITH cur_Deta_View.detobs					ADDITIVE
		
		&& Incorporo el recargo por ítem
		REPLACE cur_Detalle.pRecItem WITH cur_Deta_View.pRecItem				ADDITIVE
		REPLACE cur_Detalle.iRecItem WITH cur_Deta_View.iRecItem				ADDITIVE		
		
		&& Si está habilitado el módulo de stock, entonces, lo doy de alta.
		IF getGlobalCFG("STK_MODULE") THEN
			IF !(RIGHT(ALLTRIM(cur_Deta_View.codArt), 3) == "ARX") THEN
				Thisform.mov_stock.agregar_articulo(cur_Deta_View.idArticulo, cur_Deta_View.Cantidad, "")
			ENDIF
		ENDIF
	ELSE
		*************************************************************************************************
		* Paso por aca en el caso de que el artículo lleve número de partida
		*************************************************************************************************
		lnPDtoVta1 = cur_Deta_View.pDtoVta1
		lnPDtoVta2 = cur_Deta_View.pDtoVta2
		lnPDtoVta3 = cur_Deta_View.pDtoVta3
		lnPDtoVta4 = cur_Deta_View.pDtoVta4
		
		SELECT cur_DetPart
		GO TOP

		DO WHILE !EOF("cur_DetPart")
			SELECT cur_Detalle
			APPEND BLANK
			REPLACE cur_Detalle.idDetalle WITH RECCOUNT("cur_Detalle") + 1
			REPLACE cur_Detalle.idArticulo WITH cur_Deta_View.idArticulo 	ADDITIVE
			REPLACE cur_Detalle.codArt WITH cur_Deta_View.codArt	ADDITIVE
			REPLACE cur_Detalle.descripcio WITH IIF(ALLTRIM(cur_DetPart.nroPart) == "", ALLTRIM(cur_Deta_View.Descripcio), ALLTRIM(SUBSTR(cur_Deta_View.Descripcio, 1, 20)) + " (" + ALLTRIM(cur_DetPart.nroPart) + ")") ADDITIVE
			REPLACE cur_Detalle.nroPart WITH cur_DetPart.nroPart ADDITIVE
			REPLACE cur_Detalle.cantidad WITH cur_DetPart.cantidad ADDITIVE
			REPLACE cur_Detalle.prVta WITH cur_Deta_View.prVta ADDITIVE
			REPLACE cur_Detalle.prArtic WITH cur_Deta_View.prArtic ADDITIVE			

			&& Calculo el descuento del cliente en el ítem para grabar
			
			lnIDtoCli1 = ROUND(cur_Deta_View.prArtic * (lnPDtoCli1 / 100), 2)
			lnIDtoCli2 = ROUND((cur_Deta_View.prArtic - lnIDtoCli1) * (lnPDtoCli2 / 100), 2)
			lnIDtoCli3 = ROUND((cur_Deta_View.prArtic - lnIDtoCli1 - lnIDtoCli2) * (lnPDtoCli3 / 100), 2)
			lnIDtoCli4 = ROUND((cur_Deta_View.prArtic - lnIDtoCli1 - lnIDtoCli2 - lnIDtoCli3) * (lnPDtoCli4 / 100), 2)
			
			lnPrNeto1 = cur_Deta_View.prArtic - lnIDtoCli1 - lnIDtoCli2 - lnIDtoCli3 - lnIDtoCli4
 			
			&& Calculo el descuento por item
			
			lnIDtoVta1 = ROUND(lnPrNeto1 * (lnPDtoVta1 / 100), 2)
			lnIDtoVta2 = ROUND((lnPrNeto1 - lnIDtoVta1) * (lnPDtoVta2 / 100), 2)
			lnIDtoVta3 = ROUND((lnPrNeto1 - lnIDtoVta1 - lnIDtoVta2) * (lnPDtoVta3 / 100), 2)
			lnIDtoVta4 = ROUND((lnPrNeto1 - lnIDtoVta1 - lnIDtoVta2 - lnIDtoVta3) * (lnPDtoVta4 / 100), 2)
			
			lnImpNeto = lnPrNeto1 - lnIDtoVta1 - lnIDtoVta2 - lnIDtoVta3 - lnIDtoVta4
			
			&& Hago el recargo
			lnIRecVta = ROUND(lnImpNeto * (lnPRecVta / 100), 2)

			lnImpNeto = lnImpNeto + lnIRecVta	
			
			lnSTNeto = ROUND(lnImpNeto * cur_DetPart.Cantidad, 2)

			REPLACE cur_Detalle.pDtoVta1 WITH lnPDtoVta1 ADDITIVE
			REPLACE cur_Detalle.pDtoVta2 WITH lnPDtoVta2 ADDITIVE
			REPLACE cur_Detalle.pDtoVta3 WITH lnPDtoVta3 ADDITIVE
			REPLACE cur_Detalle.pDtoVta4 WITH lnPDtoVta4 ADDITIVE
			REPLACE cur_Detalle.iDtoVta1 WITH lnIDtoVta1 ADDITIVE
			REPLACE cur_Detalle.iDtoVta2 WITH lnIDtoVta2 ADDITIVE
			REPLACE cur_Detalle.iDtoVta3 WITH lnIDtoVta3 ADDITIVE
			REPLACE cur_Detalle.iDtoVta4 WITH lnIDtoVta4 ADDITIVE
						
			&& Hago el cálculo del IVA
			
			IF (ALLTRIM(Thisform.cbte) == "PTO") THEN
				REPLACE cur_Detalle.impIVA WITH 0 ADDITIVE
				REPLACE cur_Detalle.alicIVA WITH 0 ADDITIVE
			ELSE
				lnAlicIva = cur_Deta_View.alicIVA
				REPLACE cur_Detalle.impIVA WITH ROUND(lnSTNeto  * (lnAlicIva / 100), 2) ADDITIVE
				REPLACE cur_Detalle.alicIVA WITH lnAlicIva ADDITIVE
			ENDIF
			
			REPLACE cur_Detalle.impNeto WITH lnImpNeto ADDITIVE
			REPLACE cur_Detalle.totNeto WITH lnSTNeto ADDITIVE
			REPLACE cur_Detalle.subTotal WITH lnSTNeto + cur_Detalle.impIVA ADDITIVE

			REPLACE cur_Detalle.pDtoCli1 WITH cur_Deta_View.pDtoCli1 ADDITIVE
			REPLACE cur_Detalle.pDtoCli2 WITH cur_Deta_View.pDtoCli2 ADDITIVE
			REPLACE cur_Detalle.pDtoCli3 WITH cur_Deta_View.pDtoCli3 ADDITIVE
			REPLACE cur_Detalle.pDtoCli4 WITH cur_Deta_View.pDtoCli4 ADDITIVE
			REPLACE cur_Detalle.iDtoCli1 WITH cur_Deta_View.iDtoCli1 ADDITIVE
			REPLACE cur_Detalle.iDtoCli2 WITH cur_Deta_View.iDtoCli2 ADDITIVE
			REPLACE cur_Detalle.iDtoCli3 WITH cur_Deta_View.iDtoCli3 ADDITIVE
			REPLACE cur_Detalle.iDtoCli4 WITH cur_Deta_View.iDtoCli4 ADDITIVE
			REPLACE cur_Detalle.esOferta WITH cur_Deta_View.esOferta ADDITIVE
			REPLACE cur_Detalle.pRecVta WITH cur_Deta_View.pRecVta ADDITIVE 
			REPLACE cur_Detalle.iRecVta WITH cur_Deta_View.iRecVta ADDITIVE
			REPLACE cur_Detalle.detobs WITH cur_Deta_View.detobs ADDITIVE 
			
			&& Incorporo el recargo por ítem
			REPLACE cur_Detalle.pRecItem WITH cur_Deta_View.pRecItem				ADDITIVE
			REPLACE cur_Detalle.iRecItem WITH cur_Deta_View.iRecItem				ADDITIVE						

			&& Si está habilitado el módulo de stock, entonces, genero el movimiento.
			IF getGlobalCFG("STK_MODULE") THEN
				IF !(RIGHT(ALLTRIM(cur_Deta_View.codArt), 3) == "ARX") THEN
					Thisform.mov_stock.agregar_articulo(cur_DetPart.idArticulo, cur_DetPart.cantidad, cur_DetPart.nroPart)
				ENDIF
			ENDIF
					
			SELECT cur_DetPart
			SKIP
		ENDDO	
	ENDIF
	
	SELECT cur_Deta_View
	SKIP
ENDDO

RETURN .T.

ENDPROC
PROCEDURE agregar_item_viewer
LOCAL lnPDtoCli1, lnPDtoCli2, lnPDtoCli3, lnPDtoCli4
LOCAL lnIDtoCli1, lnIDtoCli2, lnIDtoCli3, lnIDtoCli4, lnCantAnt
LOCAL loResult, lcSql, lnPrecio, llEsOferta, lnproferta, lnAlicIva
LOCAL lnPrVta

lnPDtoCli1 = Thisform.contenido.txtDesc1.Value
lnPDtoCli2 = Thisform.contenido.txtDesc2.Value
lnPDtoCli3 = Thisform.contenido.txtDesc3.Value
lnPDtoCli4 = Thisform.contenido.txtDesc4.Value
lnIDtoCli1 = 0.00
lnIDtoCli2 = 0.00
lnIDtoCli3 = 0.00
lnIDtoCli4 = 0.00
lnPrecio = 0.00
loResult = CREATEOBJECT("odbc_result")
lcSql = ""
llEsOferta = .F.
lnproferta = 0.00
lnAlicIva = 0.00
lnCantAnt = 0.00

IF !Thisform.ValidarDetalle()
	RETURN .F.
ENDIF

lcSql = "SELECT * FROM articulos WHERE idArticulo = " + ALLTRIM(STR(Thisform.contenido.sel_Articulo.valcpoid))
loResult.ActiveConnection = goConn.ActiveConnection
loResult.Cursor_Name = "cur_Art"
loResult.OpenQuery(lcSql)

IF RIGHT(ALLTRIM(Thisform.Contenido.sel_Articulo.txtCodigo.Value), 3) == "ARX" THEN
	lnPrecio = Thisform.prarti_x
ELSE	
	IF clientes.mayorista THEN 
		lnPrecio = thisform.get_precio_oferta()
		lnproferta = lnPrecio
		
		IF lnPrecio = 0 THEN
			lnPrecio = cur_Art.prVentaMax
			llEsOferta = .F.
		ELSE
			llEsOferta = .T.
		ENDIF
	ELSE
		lnPrecio = cur_Art.prVentaMin
		llEsOferta = .F.
	ENDIF		
ENDIF

loResult.Close_Query()

IF glVersionBeta THEN
	SELECT cur_Deta_View
	IF RECCOUNT() = 5 THEN
		MESSAGEBOX("Usted está utilizando una versión límitada del sistema, si desea comprarlo envíe un mail a ldz.software@gmail.com", 0+64, Thisform.Caption)
		RETURN .F.
	ENDIF
ENDIF

* Valido si el artículo ya se encuentra cargado en el presupuesto
SELECT cur_Deta_View
IF RECCOUNT() > 0
	GO TOP
ENDIF

SELECT cur_Deta_View
DO WHILE !EOF()
	IF ALLTRIM(cur_Deta_View.codArt) == ALLTRIM(Thisform.contenido.sel_Articulo.txtCodigo.Value) THEN
		IF MESSAGEBOX("El artículo ya se encuentra cargado, ¿Desea acumular la cantidad?",4+32, Thisform.Caption) == 6 THEN
			lnCantAnt = Thisform.contenido.txtcantidad.Value
			Thisform.contenido.txtcantidad.Value = Thisform.contenido.txtcantidad.Value + cur_Deta_View.cantidad
			
			&& Vuelvo a verificar el stock nuevamente al acumular la cantidad 
			IF Thisform.Mov_stock.lleva_stock(Thisform.Contenido.sel_Articulo.valcpoid) THEN
				IF (ALLTRIM(Thisform.cbte) != "COT") .AND. (ALLTRIM(Thisform.cbte) != "NC") THEN
					&& Valido el stock solo en caso que no sea artículo X
					IF RIGHT(ALLTRIM(Thisform.Contenido.sel_Articulo.txtCodigo.Value), 3) != "ARX" THEN
						IF Thisform.Mov_stock.lleva_stock(Thisform.Contenido.sel_Articulo.valcpoid) THEN
							IF Thisform.mov_stock.get_exist_byart(Thisform.Contenido.sel_Articulo.valcpoid) <= 0 THEN
								Thisform.Contenido.sel_Articulo.txtCodigo.SetFocus()
								
								MESSAGEBOX("No hay stock disponible", 0+48, Thisform.Caption)				
								thisform.contenido.txtCantidad.Value = lnCantAnt
								thisform.contenido.txtCantidad.SetFocus()
								RETURN .F.
							ENDIF
							
							&& Valido si está o no cubierto al 100%
							IF Thisform.Contenido.txtCantidad.Value > Thisform.Contenido.txtExistencia.Value THEN
								MESSAGEBOX("No hay stock suficiente para cubrir la cantidad ingresada", 0+48, Thisform.Caption)
								thisform.contenido.txtCantidad.Value = lnCantAnt
								thisform.contenido.txtCantidad.SetFocus()
								RETURN .F.
							ENDIF
						ENDIF
					ENDIF
				ENDIF			
			ENDIF
			Thisform.calc_item_desc()
			
			SELECT cur_Deta_View
			DELETE
		ELSE 
			Thisform.contenido.sel_Articulo.txtCodigo.SetFocus()
			RETURN .F.
		ENDIF 
	ENDIF

	SELECT cur_Deta_View
	SKIP
ENDDO

SELECT cur_Deta_View
APPEND BLANK
REPLACE cur_Deta_View.idDetalle WITH RECCOUNT("cur_Deta_View")
REPLACE cur_Deta_View.idArticulo WITH Thisform.contenido.sel_Articulo.valcpoid ADDITIVE
REPLACE cur_Deta_View.codArt WITH Thisform.contenido.sel_Articulo.txtCodigo.Value ADDITIVE
REPLACE cur_Deta_View.descripcio WITH Thisform.contenido.sel_Articulo.txtDescripcion.Value ADDITIVE
REPLACE cur_Deta_View.cantidad WITH Thisform.contenido.txtCantidad.Value ADDITIVE

*******************************************************************************************************************************
* Verifico el tipo de cliente que es para saber desde donde tomar el precio
*******************************************************************************************************************************
IF RIGHT(ALLTRIM(Thisform.Contenido.sel_Articulo.txtCodigo.Value), 3) == "ARX" THEN
	&& Si es artículo X, siempre cargo el contenido de lo que el usuario haya ingresado
	REPLACE cur_Deta_View.prVta WITH Thisform.contenido.txtPrMinorista.Value ADDITIVE
	REPLACE cur_Deta_View.prArtic WITH Thisform.prarti_x ADDITIVE
ELSE
	IF clientes.mayorista THEN
		REPLACE cur_Deta_View.prVta WITH Thisform.contenido.txtPrMay.Value ADDITIVE
		
		IF lnproferta = 0 THEN
			REPLACE cur_Deta_View.prArtic WITH thisform.pr_mayorista ADDITIVE
		ELSE
			REPLACE cur_Deta_View.prArtic WITH thisform.pr_oferta ADDITIVE
		ENDIF
	ELSE
		REPLACE cur_Deta_View.prVta WITH Thisform.contenido.txtPrMinorista.Value ADDITIVE
		REPLACE cur_Deta_View.prArtic WITH Thisform.pr_minorista ADDITIVE
	ENDIF
	
	* Levanto el stock actual solo en caso que no sea ARX
	REPLACE cur_Deta_View.stkDisp  WITH Thisform.mov_stock.get_exist_byart(Thisform.contenido.sel_Articulo.valcpoid) ADDITIVE
ENDIF

REPLACE cur_Deta_View.pDtoVta1 WITH Thisform.contenido.txtPorDesc1.Value
REPLACE cur_Deta_View.pDtoVta2 WITH Thisform.contenido.txtPorDesc2.Value
REPLACE cur_Deta_View.pDtoVta3 WITH Thisform.contenido.txtPorDesc3.Value
REPLACE cur_Deta_View.pDtoVta4 WITH Thisform.contenido.txtPorDesc4.Value
REPLACE cur_Deta_View.iDtoVta1 WITH Thisform.contenido.txtImpDescItem1.Value
REPLACE cur_Deta_View.iDtoVta2 WITH Thisform.contenido.txtImpDescItem2.Value 
REPLACE cur_Deta_View.iDtoVta3 WITH Thisform.contenido.txtImpDescItem3.Value
REPLACE cur_Deta_View.iDtoVta4 WITH Thisform.contenido.txtImpDescItem4.Value

&& Incluyo el calculo del recargo por ítem.
REPLACE cur_Deta_View.pRecItem WITH Thisform.contenido.txtPorRecItem.Value ADDITIVE
REPLACE cur_Deta_View.iRecItem WITH cur_Deta_View.prArtic * (cur_Deta_View.pRecItem / 100) ADDITIVE
REPLACE cur_Deta_View.prArtic WITH cur_Deta_View.prArtic + cur_Deta_View.iRecItem ADDITIVE

REPLACE cur_Deta_View.impNeto WITH Thisform.contenido.txtPrNeto.Value

*******************************************************************************************************************************
* Hago el cálculo del IVA
*******************************************************************************************************************************
IF (ALLTRIM(Thisform.cbte) == "PTO") THEN
	REPLACE cur_Deta_View.impIVA WITH 0 ADDITIVE
	REPLACE cur_Deta_View.alicIVA WITH 0 ADDITIVE
ELSE
	lnAlicIva = Thisform.contenido.txtAlicIVA.Value
		
	REPLACE cur_Deta_View.impIVA WITH Thisform.contenido.txtImpIVA.Value ADDITIVE
	REPLACE cur_Deta_View.alicIVA WITH lnAlicIva ADDITIVE
ENDIF

REPLACE cur_Deta_View.totNeto WITH Thisform.contenido.txtSTNeto.Value ADDITIVE
REPLACE cur_Deta_View.subTotal WITH Thisform.contenido.txtSubTotal.Value ADDITIVE

*******************************************************************************************************************************
* Calculo el descuento del cliente en el ítem para grabar
*******************************************************************************************************************************
lnIDtoCli1 = lnPrecio * (lnPDtoCli1 / 100)
lnIDtoCli2 = (lnPrecio - lnIDtoCli1) * (lnPDtoCli2 / 100)
lnIDtoCli3 = (lnPrecio - lnIDtoCli1 - lnIDtoCli2) * (lnPDtoCli3 / 100)
lnIDtoCli4 = (lnPrecio - lnIDtoCli1 - lnIDtoCli2 - lnIDtoCli3) * (lnPDtoCli4 / 100)

REPLACE cur_Deta_View.pDtoCli1 WITH lnPDtoCli1 ADDITIVE
REPLACE cur_Deta_View.pDtoCli2 WITH lnPDtoCli2 ADDITIVE
REPLACE cur_Deta_View.pDtoCli3 WITH lnPDtoCli3 ADDITIVE
REPLACE cur_Deta_View.pDtoCli4 WITH lnPDtoCli4 ADDITIVE
REPLACE cur_Deta_View.iDtoCli1 WITH lnIDtoCli1 ADDITIVE
REPLACE cur_Deta_View.iDtoCli2 WITH lnIDtoCli2 ADDITIVE
REPLACE cur_Deta_View.iDtoCli3 WITH lnIDtoCli3 ADDITIVE
REPLACE cur_Deta_View.iDtoCli4 WITH lnIDtoCli4 ADDITIVE
REPLACE cur_Deta_View.esOferta WITH llEsOferta ADDITIVE

*******************************************************************************************************************************
* Agrego el recargo del item
*******************************************************************************************************************************
REPLACE cur_Deta_View.pRecVta WITH Thisform.contenido.txtporrec.Value ADDITIVE
REPLACE cur_Deta_View.iRecVta WITH Thisform.contenido.txtrecitem.Value ADDITIVE
REPLACE cur_Deta_View.uniDesp WITH VAL(Thisform.contenido.cboUnidVta.Value) ADDITIVE
REPLACE cur_Deta_View.cantPack WITH Thisform.contenido.txtCantPack.Value ADDITIVE
REPLACE cur_Deta_View.uniMed WITH Thisform.unimed ADDITIVE
REPLACE cur_Deta_View.detobs WITH ALLTRIM(Thisform.Contenido.txtDetObs.Value) ADDITIVE

RETURN .T.


ENDPROC
PROCEDURE Load
SET TALK OFF
SET DATE FRENCH
SET CENTURY ON
SET SAFETY OFF
SET NOTIFY OFF
SET EXCLUSIVE OFF
SET DATE FRENCH
SET MULTILOCKS ON
SET DELETED ON
SET ENGINEBEHAVIOR 90

CREATE CURSOR cur_PedExt (	;
	codArt			varchar(20),;
	cantidad		int)

CREATE CURSOR cur_Detalle (	;
	idDetalle		int			,;
	idArticulo		int 		,;
	codArt			C(20)		,;
	descripcio		C(60)		,;
	nroPart			varchar(30)	,;
	cantidad		float(10,2)	,;
	prVta			float(10,2)	,;
	pDtoVta1		float(10,2)	,;
	pDtoVta2		float(10,2)	,;
	pDtoVta3		float(10,2)	,;
	pDtoVta4		float(10,2)	,;
	iDtoVta1		float(10,2)	,;
	iDtoVta2		float(10,2)	,;
	iDtoVta3		float(10,2)	,;
	iDtoVta4		float(10,2)	,;
	pDtoCli1		float(10,2)	,;
	pDtoCli2		float(10,2)	,;
	pDtoCli3		float(10,2)	,;
	pDtoCli4		float(10,2)	,;
	iDtoCli1		float(10,2)	,;
	iDtoCli2		float(10,2)	,;
	iDtoCli3		float(10,2)	,;
	iDtoCli4		float(10,2)	,;
	pRecItem		float(10,2)	,;
	iRecItem		float(10,2)	,;	
	alicIVA			float(10,2)	,;
	impIVA			float(10,2)	,;
	impNeto			float(10,2)	,;	
	totNeto			float(10,2)	,;
	subTotal		float(10,2)	,;
	porNoGrav		double DEFAULT 0,;
	baseGrav		double DEFAULT 0,;
	subtNoGrav		double DEFAULT 0,;		
	stkDisp			float(10,2)	,;
	prArtic			float(10,2)	,;
	esOferta		l,;
	pRecVta			float(10,2)	,;
	iRecVta			float(10,2)	,;
	uniDesp			float(10,2)	,;
	cantPack		float(10,2)	,;
	uniMed			varchar(3),;
	detobs			varchar(30))

CREATE CURSOR cur_Aux (	;
	idDetalle		int			,;
	idArticulo		int 		,;
	codArt			C(20)		,;
	descripcio		C(60)		,;
	nroPart			varchar(30) ,;
	cantidad		float(10,2)	,;
	prVta			float(10,2)	,;
	pDtoVta1		float(10,2)	,;
	pDtoVta2		float(10,2)	,;
	pDtoVta3		float(10,2)	,;
	pDtoVta4		float(10,2)	,;
	iDtoVta1		float(10,2)	,;
	iDtoVta2		float(10,2)	,;
	iDtoVta3		float(10,2)	,;
	iDtoVta4		float(10,2)	,;
	pDtoCli1		float(10,2)	,;
	pDtoCli2		float(10,2)	,;
	pDtoCli3		float(10,2)	,;
	pDtoCli4		float(10,2)	,;
	iDtoCli1		float(10,2)	,;
	iDtoCli2		float(10,2)	,;
	iDtoCli3		float(10,2)	,;
	iDtoCli4		float(10,2)	,;	
	pRecItem		float(10,2)	,;
	iRecItem		float(10,2)	,;
	alicIVA			float(10,2)	,;
	impIVA			float(10,2)	,;
	impNeto			float(10,2)	,;	
	totNeto			float(10,2)	,;
	subTotal		float(10,2)	,;
	porNoGrav		double DEFAULT 0,;
	baseGrav		double DEFAULT 0,;
	subtNoGrav		double DEFAULT 0,;		
	prArtic			float(10,2)	,;
	esOferta		l,;
	pRecVta			float(10,2) ,;
	iRecVta			float(10,2) ,;
	uniDesp			float(10,2) ,;
	cantPack		float(10,2) ,;
	uniMed			varchar(3),;
	detobs			varchar(30))

&& Ese cursor es para mostrar en la grilla el detalle sin importar
&& de que partida se saque
CREATE CURSOR cur_Deta_View (	;
	idDetalle		int			,;
	idArticulo		int 		,;
	codArt			C(20)		,;
	descripcio		C(60)		,;
	cantidad		float(10,2)	,;
	prVta			float(10,2)	,;
	pDtoVta1		float(10,2)	,;
	pDtoVta2		float(10,2)	,;
	pDtoVta3		float(10,2)	,;
	pDtoVta4		float(10,2)	,;
	iDtoVta1		float(10,2)	,;
	iDtoVta2		float(10,2)	,;
	iDtoVta3		float(10,2)	,;
	iDtoVta4		float(10,2)	,;
	pDtoCli1		float(10,2)	,;
	pDtoCli2		float(10,2)	,;
	pDtoCli3		float(10,2)	,;
	pDtoCli4		float(10,2)	,;
	iDtoCli1		float(10,2)	,;
	iDtoCli2		float(10,2)	,;
	iDtoCli3		float(10,2)	,;
	iDtoCli4		float(10,2)	,;	
	pRecItem		float(10,2)	,;
	iRecItem		float(10,2)	,;
	alicIVA			float(10,2)	,;
	impIVA			float(10,2)	,;
	impNeto			float(10,2)	,;	
	totNeto			float(10,2)	,;
	porNoGrav		double DEFAULT 0,;
	baseGrav		double DEFAULT 0,;
	subtNoGrav		double DEFAULT 0,;		
	subTotal		float(10,2) ,;
	stkDisp			float(10,2) ,;
	prArtic			float(10,2) ,;
	esOferta		l,;
	pRecVta			float(10,2) ,;
	iRecVta			float(10,2) ,;
	uniDesp			float(10,2) ,;
	cantPack		float(10,2) ,;
	uniMed			varchar(3),;
	detobs			varchar(30),;
	apli_PRG		l)	

CREATE CURSOR cur_Subtotal(	;
	impNeto			float(10,2)	,;
	impFinal		float(10,2) ,;
	porIVA21		float(10,2) ,;
	impIVA21		float(10,2) ,;
	porIVA105		float(10,2) ,;
	impIVA105		float(10,2) ,;
	porDesc1		float(10,2)	,;
	porDesc2		float(10,2)	,;
	porDesc3		float(10,2)	,;
	porDesc4		float(10,2)	,;
	impDesc1		float(10,2)	,;
	impDesc2		float(10,2)	,;
	impDesc3		float(10,2)	,;
	impDesc4		float(10,2)	,;
	totaNoGrav		double DEFAULT 0,;
	totFact			float(10,2) ,;
	porRec			float(10,2) ,;
	impRec			float(10,2) ,;
	porIIBB			float(10,2) ,;
	impIIBB			float(10,2))
	
&& Agrego este cursor por partida
CREATE CURSOR cur_DetPart (	;
	idArticulo		int,;
	nroPart			varchar(30),;
	cantidad		float(10, 2))
	
&& El siguiente cursor es para mostrar los stocks insuficiente
CREATE CURSOR cur_StkInsu (	;
	idArticulo		int,;
	codArt			varchar(20),;
	descripcio		varchar(60),;
	stock_disp		float(10, 2),;
	cantFC			float(10, 2))
	
&& Este cursor va a contener los pedidos pendientes de facturar para cuando
&& se quiera levantar los mismos a partir de una factura.
CREATE CURSOR cur_Cbtes (	;
	sel			L,;
	idVentasC	int,;
	fecEmision	D,;
	numCbte		varchar(20),;
	idCliente	int,;
	razSoc		varchar(60) NULL,;
	totFact		float(10,2),;
	idTipoDoc	int NULL,;
	nroDoc	varchar(20) NULL) 

SELECT cur_Cbtes
INDEX ON idVentasC TAG idVentasC ASCENDING
INDEX ON fecEmision TAG fecEmision ASCENDING ADDITIVE
INDEX ON numCbte TAG numCbte ASCENDING ADDITIVE
INDEX ON idCliente TAG idCliente ASCENDING ADDITIVE
INDEX ON razSoc TAG razSoc ASCENDING ADDITIVE
INDEX ON totFact TAG totFact ASCENDING ADDITIVE

SET ORDER TO TAG fecEmision ASCENDING

&& Agrego el cursor que voy a administrar los faltantes
CREATE CURSOR cur_faltantes (	;
	idArticulo	int,;
	idCliente	int,;
	codArt		varchar(20),;
	uniDesp		float(10, 2),;
	cantidad	float(10, 2))
		
&& Si usa impresora fiscal, agrego estas líneas para que el formulario
&& tenga soporte a los eventos del control OCX que se inserto para el
&& manejo de impresoras fiscales
IF ALLTRIM(GetConfig("USA_FISCAL")) == "S" THEN
	SYS(2333, 0)
	_VFP.AutoYield = .F.
	
	RETURN
ENDIF


ENDPROC
PROCEDURE grabar_cbte_part
&& Grabo la info en la base

LOCAL lnIdVentasC, lnIdCliente, lcFecEmis, lcCbte, lcTipoDoc, lnPtoVta
LOCAL lnNroCbte, llAnulado, lnImpNeto, lnImpFinal, lnPorIVA21, lnImpIVA21
LOCAL lnPorIVA105, lnImpIVA105, lnPorDesc1, lnPorDesc2, lnPorDesc3, lnPorDesc4
LOCAL lnImpDesc1, lnImpDesc2, lnImpDesc3, lnImpDesc4, lnTotFact
LOCAL lnIdVentasD, lnIdArticulo, lnCantidad, lnCostoRep, lnPrVenta, lnAlicIVA, lnImpIVA
LOCAL lnTotNeto, lnSubTotal, lnSaldo, lcObserv, lnPorIIBB, lnImpIIBB
LOCAL lnPDtoVta1, lnPDtoVta2, lnPDtoVta3, lnPDtoVta4, lnIDtoVta1, lnIDtoVta2, lnIDtoVta3, lnIDtoVta4
LOCAL lnIdCondPago, lnIdSitIVA, lnPrArtic, lnPorRec, lnImpRec, lnUnidDesp, lnCantPack, lcUniMed
LOCAL lnPRecItem, lnIRecItem
LOCAL ldFecVto, lnIdOper, oDT
LOCAL loNumerador, lcSql, loCommand, loArtic, loOper, lnSqlSrv, lnPrNeto, lnIdCCOrig, loCliente, lnIdVendedor
LOCAL loConDMO, loResCli, lcSql, lnIntentos, lcDetOBS

&& Inicializo las variables del detalle

lnIdVentasD = 0
lnIdArticulo = 0
lnCantidad = 0.00
lnCostoRep = 0.00
lnPrVenta = 0.00
lnAlicIVA = 0.00
lnImpIVA = 0.00
lnTotNeto = 0.00
lnSubTotal = 0.00
ldFecVto = {}
lnIdOper = 0
lnSaldo = 0
oDT = CREATEOBJECT("datetime")
loArtic = CREATEOBJECT("odbc_result")
loOper = CREATEOBJECT("odbc_result")
loCliente = CREATEOBJECT("odbc_result")
loCommand = CREATEOBJECT("odbc_command")
lnSqlSrv = INT(VAL(getconfig("SQLSRV")))
lcObserv = Thisform.Contenido.txtObserv.Value
lnPorIIBB = 0.00
lnImpIIBB = 0.00
lnPDtoVta1 = 0.00
lnPDtoVta2 = 0.00
lnPDtoVta3 = 0.00
lnPDtoVta4 = 0.00
lnIDtoVta1 = 0.00
lnIDtoVta2 = 0.00
lnIDtoVta3 = 0.00
lnIDtoVta4 = 0.00
lnPrNeto = 0.00
lnIdCondPago = 0
lnIdSitIVA = 0
lnIdVendedor = 0
loConDMO = CREATEOBJECT("odbc_connect")
lnPrArtic = 0.00
lnPorRec = 0.00
lnImpRec = 0.00
lcSql = ""
loResCli = CREATEOBJECT("odbc_result") && Este objeto lo uso para validar que el cliente exista
lnUniDesp = 0.00
lnCantPack = 0.00
lcUniMed = ""
lcDetOBS = ""
lcCbte = Thisform.Cbte
lnPRecItem = 0.00
lnIRecItem = 0.00

lnIdCliente = Thisform.Contenido.sel_Cliente.ValCpoId

IF ALLTRIM(lcCbte) == "PTO" THEN
	&& Si es un comprobante PTO, entonces, abro la base DMO para generar el registro.

	loConDMO.ConnectionString = ALLTRIM(getConfig("DMO_CC"))

	IF !loConDMO.Open() THEN
		MESSAGEBOX(loConDMO.ErrorMessage, 0+48, Thisform.Caption)
		RETURN .F.
	ENDIF
	
	lcSql = "SELECT COUNT(*) AS cantCli FROM clientes WHERE idCliente = " + ALLTRIM(STR(lnIdCliente))
	loResCli.ActiveConnection = loConDMO.ActiveConnection
	loResCli.Cursor_Name = "cur_x"
	
	IF !loResCli.OpenQuery(lcSql) THEN
		MESSAGEBOX(loResCli.Error_Message, 0+48, Thisform.Caption)
		RETURN .F.
	ENDIF
	
	IF TYPE('cur_x.cantCli') != "C" THEN
		IF cur_x.cantCli = 0 THEN
			MESSAGEBOX("El cliente no existe en DMO, actualice la base y vuelva a intentar", 0+48, Thisform.Caption)
			loResCli.Close_Query()
			RETURN .F.
		ENDIF
	ELSE
		IF INT(VAL(cur_x.cantCli)) = 0 THEN
			MESSAGEBOX("El cliente no existe en DMO, actualice la base y vuelva a intentar", 0+48, Thisform.Caption)
			loResCli.Close_Query()
			RETURN .F.
		ENDIF	
	ENDIF
	
	loResCli.Close_Query()
ENDIF


&& Asigno el idvendedor
lcSql = "SELECT * FROM clientes WHERE idCliente = " + ALLTRIM(STR(lnIdCliente))
loCliente.ActiveConnection = goConn.ActiveConnection
loCliente.Cursor_Name = "cur_cliente"
loCliente.OpenQuery(lcSql)

lnIdVendedor = cur_cliente.idVendedor

loCliente.Close_Query()

lcFecEmis = ALLTRIM(STR(YEAR(DATETIME()))) + "-" + ALLTRIM(STR(MONTH(DATETIME()))) + " - " + ;
	ALLTRIM(STR(DAY(DATETIME())))

IF lcCbte == "COT"
	lcTipoDoc = "X"
	Thisform.tipodoc = lcTipoDoc
ELSE
	&& Aca tengo que agregar el cálculo en caso que sea
	&& comprobante fiscal
	IF lcCbte == "PED"
		lcTipoDoc = "P"
		Thisform.tipodoc = lcTipoDoc
	ELSE
		lcTipoDoc = thisform.calcular_tipodoc()
		Thisform.tipodoc = lcTipoDoc
	ENDIF
ENDIF

IF lcCbte == "PTO" THEN
	lnPtoVta = 9999
	lcTipoDoc = "X"
	Thisform.tipodoc = lcTipoDoc
ELSE
	lnPtoVta = INT(VAL(ALLTRIM(getconfig("PTOVTA"))))
ENDIF

*Thisform.ptovta = REPLICATE("0", 4 - LEN(ALLTRIM(STR(lnPtoVta)))) + ALLTRIM(STR(lnPtoVta))
Thisform.ptovta = lnPtoVta

llAnulado = .F.
lnImpNeto = cur_Subtotal.impNeto
lnImpFinal = cur_Subtotal.impFinal
lnPorIVA21 = cur_Subtotal.porIVA21
lnPorIVA105 = cur_Subtotal.porIVA105
lnImpIVA21 = cur_Subtotal.impIVA21
lnImpIVA105 = cur_Subtotal.impIVA105
lnPorIIBB= cur_Subtotal.porIIBB
lnImpIIBB = cur_Subtotal.impIIBB
lnPorDesc1 = cur_Subtotal.porDesc1
lnPorDesc2 = cur_Subtotal.porDesc2
lnPorDesc3 = cur_Subtotal.porDesc3
lnPorDesc4 = cur_Subtotal.porDesc4
lnImpDesc1 = cur_Subtotal.impDesc1
lnImpDesc2 = cur_Subtotal.impDesc2
lnImpDesc3 = cur_Subtotal.impDesc3
lnImpDesc4 = cur_Subtotal.impDesc4
lnTotFact = cur_Subtotal.totFact
lnPorRec = cur_Subtotal.porRec
lnImpRec = cur_Subtotal.impRec
lnIdCondPago = clientes.idCondPago
lnIdSitIVA = clientes.idSitIVA

IF ALLTRIM(thisform.cbte) == "PTO"
	lnIdVentasC = loConDMO.GetNextID("ventascab", "idVentasC")
ELSE
	lnIdVentasC = goConn.GetNextID("ventascab", "idVentasC")
ENDIF

Thisform.id_ventasc = lnIdVentasC
lnNroCbte = 0

&& Calculo la fecha de vencimiento correspondiente a la factura
IF ALLTRIM(Thisform.cbte) == "FC" THEN 
	IF thisform.cp_cntdias <> 0 THEN
		ldFecVto = Thisform.contenido.txtFecEmis.Value + thisform.cp_cntdias
	ELSE
		ldFecVto = DATE()
	ENDIF 
ELSE
	ldFecVto = DATE()
ENDIF

IF ALLTRIM(Thisform.cbte) == "FC" .OR. ALLTRIM(Thisform.cbte) == "PTO" THEN
	lnSaldo = lnTotFact
ELSE
	lnSaldo = 0
ENDIF

lcSql = "INSERT INTO ventascab ( "
lcSql = lcSql + "idVentasC, idCliente, razSoc, idTipoDoc, nroDoc, fecEmision, cbte, tipoDoc, ptoVta, numCbte, anulado, idCondPago, idSitIVA, idVendedor,"
lcSql = lcSql + "impNeto, impFinal, porIVA21, impIVA21, porIVA105, impIVA105, porDesc1, "
lcSql = lcSql + "porDesc2, porDesc3, porDesc4, impDesc1, impDesc2, impDesc3, impDesc4, totFact, Saldo, usuAlta, fecAlta, idHostAlta, observ, porIIBB, impIIBB, fecVto, porRec, impRec) VALUES ("
lcSql = lcSql + ALLTRIM(STR(lnIdVentasC)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnIdCliente)) + ", "
lcSql = lcSql + "'" + STRTRAN(ALLTRIM(Thisform.contenido.sel_Cliente.txtDescripcion.Value), "'", "''") + "', "
lcSql = lcSql + ALLTRIM(STR(Thisform.cli_idTipoDoc)) + ", "
lcSql = lcSql + "'" + ALLTRIM(Thisform.contenido.txtCuit.Value) + "', "
*lcSql = lcSql + oDT.getDateTime() + ", "
lcSql = lcSql + oDT.toMySql(Thisform.contenido.txtFecEmis.Value) + ", "
lcSql = lcSql + "'" + IIF(ALLTRIM(lcCbte) == "PTO", "FC", ALLTRIM(lcCbte)) + "', "
lcSql = lcSql + "'" + ALLTRIM(lcTipoDoc) + "', "
lcSql = lcSql + ALLTRIM(STR(lnPtoVta)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnNroCbte)) + ", "
lcSql = lcSql + IIF(lnSqlSrv = 0, "false", "0") + ", "
lcSql = lcSql + ALLTRIM(STR(lnIdCondPago)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnIdSitIVA)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnIdVendedor)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpNeto, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpFinal, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnPorIVA21, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpIVA21, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnPorIVA105, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpIVA105, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnPorDesc1, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnPorDesc2, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnPorDesc3, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnPorDesc4, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpDesc1, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpDesc2, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpDesc3, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpDesc4, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnTotFact, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnSaldo, 10, 2)) + ", "
lcSql = lcSql + "'" + ALLTRIM(gcCodUsu) + "', " 
lcSql = lcSql + oDT.getDateTime() + ", "
lcSql = lcSql + "'" + SYS(0) + "', '" + ALLTRIM(lcObserv) + "', "
lcSql = lcSql + ALLTRIM(STR(lnPorIIBB, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpIIBB, 10, 2)) + ", "

IF INT(VAL(getconfig("SQLSRV"))) = 1 THEN
	lcSql = lcSql + oDT.getDateTime() + " + " + ALLTRIM(STR(thisform.cp_cntdias)) + ", "
ELSE
	lcSql = lcSql + oDT.toMySql(ldFecVto) + ", "
ENDIF

lcSql = lcSql + ALLTRIM(STR(lnPorRec, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpRec, 10, 2)) + ")"

loCommand.CommandText = lcSql

IF ALLTRIM(lcCbte) == "PTO" THEN
	loCommand.ActiveConnection = loConDMO.ActiveConnection
	
	IF !loCommand.Execute()
		thisform.desbloq_numerador()
		loConDMO.Rollback()
		RETURN .F.
	ENDIF	
ELSE
	loCommand.ActiveConnection = goConn.ActiveConnection
	IF !loCommand.Execute()
		thisform.desbloq_numerador()
		goConn.Rollback()
		RETURN .F.
	ENDIF
ENDIF

&& Grabo el detalle del comprobante

SELECT cur_aux
IF RECCOUNT() > 0
	GO TOP
ENDIF

lnIdVentasD = 0

DO WHILE !EOF()
	lnIdVentasD = lnIdVentasD + 1
	
	lnIdArticulo = cur_aux.idArticulo
	lnCantidad = cur_aux.cantidad
	lnAlicIVA = cur_aux.alicIVA
	lnPrVenta = cur_aux.PrVta
	lnImpIVA = cur_aux.impIVA
	lnPrNeto = cur_aux.impNeto
	lnTotNeto = cur_aux.totNeto
	lnSubTotal = cur_aux.subTotal
	lnPDtoVta1 = cur_aux.pDtoVta1
	lnPDtoVta2 = cur_aux.pDtoVta2
	lnPDtoVta3 = cur_aux.pDtoVta3
	lnPDtoVta4 = cur_aux.pDtoVta4
	lnIDtoVta1 = cur_aux.iDtoVta1
	lnIDtoVta2 = cur_aux.iDtoVta2
	lnIDtoVta3 = cur_aux.iDtoVta3
	lnIDtoVta4 = cur_aux.iDtoVta4
	lnPRecItem = cur_aux.pRecItem
	lnIRecItem = cur_aux.iRecItem
	
	lnPorDesc1 = cur_aux.pDtoCli1
	lnPorDesc2 = cur_aux.pDtoCli2
	lnPorDesc3 = cur_aux.pDtoCli3
	lnPorDesc4 = cur_aux.pDtoCli4
	lnImpDesc1 = cur_aux.iDtoCli1
	lnImpDesc2 = cur_aux.iDtoCli2
	lnImpDesc3 = cur_aux.iDtoCli3
	lnImpDesc4 = cur_aux.iDtoCli4
	
	lnPrArtic = cur_aux.prArtic
	lnPorRec = cur_aux.pRecVta
	lnImpRec = cur_aux.iRecVta
	lnUniDesp = cur_aux.uniDesp
	lnCantPack = cur_aux.cantPack
	lcUniMed = cur_aux.uniMed
	lcDetOBS = cur_aux.detobs
	
	lcSql = "SELECT * FROM articulos WHERE idArticulo = " + ALLTRIM(STR(lnIdArticulo))
	
	IF ALLTRIM(lcCbte) == "PTO" THEN
		loArtic.ActiveConnection = loConDMO.ActiveConnection
	ELSE
		loArtic.ActiveConnection = goConn.ActiveConnection
	ENDIF
	
	loArtic.Cursor_Name = "cur_Artic"
	loArtic.OpenQuery(lcSql)
	
	SELECT cur_Artic
	lnCostoRep = cur_Artic.costoRep
	
	loArtic.close_query()

	lcSql = "INSERT INTO ventasdet ( "
	lcSql = lcSql + "idVentasD, "
	lcSql = lcSql + "idVentasC, "
	lcSql = lcSql + "idArticulo, "
	lcSql = lcSql + "descripcio, "
	lcSql = lcSQl + "nroPart, "
	lcSql = lcSql + "Cantidad, "
	
	IF ALLTRIM(lcCbte) == "PED" THEN
		lcSql = lcSql + "cant_pri1, "
	ENDIF
	
	lcSql = lcSql + "costoRep, "
	lcSql = lcSql + "prVenta, "
	lcSql = lcSql + "alicIVA, "
	lcSql = lcSql + "impIVA, "
	lcSql = lcSql + "subTotal, "
	lcSql = lcSql + "porDesc1, "
	lcSql = lcSql + "porDesc2, "
	lcSql = lcSql + "porDesc3, "
	lcSql = lcSql + "porDesc4, "
	lcSql = lcSql + "impDesc1, "
	lcSql = lcSql + "impDesc2, "
	lcSql = lcSql + "impDesc3, "
	lcSql = lcSql + "impDesc4, "
	lcSql = lcSql + "pDtoVta1, "
	lcSql = lcSql + "pDtoVta2, "
	lcSql = lcSql + "pDtoVta3, "
	lcSql = lcSql + "pDtoVta4, "
	lcSql = lcSql + "iDtoVta1, "
	lcSql = lcSql + "iDtoVta2, "
	lcSql = lcSql + "iDtoVta3, "
	lcSql = lcSql + "iDtoVta4, "
	lcSql = lcSql + "pRecItem, "
	lcSql = lcSql + "iRecItem, "
	lcSql = lcSql + "impNeto, "
	lcSql = lcSql + "totNeto, "
	lcSql = lcSql + "prArtic, "
	lcSql = lcSql + "esOferta, "
	lcSql = lcSql + "pRecVta, "
	lcSql = lcSql + "iRecVta, "
	lcSql = lcSql + "uniDesp, "
	lcSql = lcSql + "cantPack, "
	lcSql = lcSql + "codUM, "
	lcSql = lcSql + "observ) "
	lcSql = lcSql + "VALUES ( "
	lcSql = lcSql + ALLTRIM(STR(lnIdVentasD)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIdVentasC)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIdArticulo)) + ", "
	lcSql = lcSql + "'" + STRTRAN(ALLTRIM(cur_aux.descripcio), "'", "''") + "', "
	lcSql = lcSql + "'" + ALLTRIM(cur_aux.nroPart) + "', "
	lcSql = lcSql + ALLTRIM(STR(lnCantidad, 10, 2)) + ", "
	
	IF ALLTRIM(lcCbte) == "PED" THEN
		lcSql = lcSql + ALLTRIM(STR(lnCantidad, 10, 2)) + ", "
	ENDIF	
	
	lcSql = lcSql + ALLTRIM(STR(lnCostoRep, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPrVenta, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnAlicIVA, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnImpIVA, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnSubTotal, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPorDesc1, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPorDesc2, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPorDesc3, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPorDesc4, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnImpDesc1, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnImpDesc2, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnImpDesc3, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnImpDesc4, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPDtoVta1, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPDtoVta2, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPDtoVta3, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPDtoVta4, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIDtoVta1, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIDtoVta2, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIDtoVta3, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIDtoVta4, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPRecItem, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIRecItem, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPrNeto, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnTotNeto, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPrArtic, 10, 2)) + ", "
	lcSql = lcSql + IIF(cur_detalle.esOferta, "1", "0") + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPorRec, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnImpRec, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnUniDesp, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnCantPack, 10, 2)) + ", "
	lcSql = lcSql + "'" + ALLTRIM(lcUniMed) + "', "
	lcSql = lcSql + "'" + ALLTRIM(lcDetOBS) + "') "
	
	*******************************************************************************************
	
	loCommand.CommandText = lcSql

	IF ALLTRIM(lcCbte) == "PTO" 
		loCommand.ActiveConnection = loConDMO.ActiveConnection
		IF !loCommand.Execute()
			thisform.desbloq_numerador()
			loConDMO.Rollback()
			RETURN .F.
		ENDIF	
	ELSE
		loCommand.ActiveConnection = goConn.ActiveConnection
		IF !loCommand.Execute()
			thisform.desbloq_numerador()
			goConn.Rollback()
			RETURN .F.
		ENDIF
	ENDIF	
	
	&& Si es nota de crédito entonces, actualizo la cantidad de NC en los
	&& items de la factura.
	&& Actualizar este dato tiene como objetivo de que si se hace más una NC
	&& que no se pueda hacer dos veces sobre la misma cantidad de un producto
	&& sino que por el resto.
	
	IF ALLTRIM(Thisform.cbte) == "NC" THEN
		lcSql = "UPDATE ventasdet SET cantNC = cantNC + " + ALLTRIM(STR(lnCantidad, 10, 2)) + " "
		lcSql = lcSql + "WHERE idVentasC = " + ALLTRIM(STR(Thisform.idorigen)) + " "
		lcSql = lcSql + " AND idArticulo = " + ALLTRIM(STR(cur_aux.idArticulo))
		
		loCommand.ActiveConnection = goConn.ActiveConnection
		loCommand.CommandText = lcSql
		
		IF !loCommand.Execute() THEN
			thisform.desbloq_numerador()
			goConn.Rollback()
			RETURN .F.
		ENDIF
	ENDIF
	
	SELECT cur_aux
	SKIP
ENDDO

IF ALLTRIM(thisform.cbte) == "PTO" THEN
	lnProxID = loConDMO.GetNextId("cc_cli", "idCC_Cli")
	lnIdOper = loConDMO.GetNextID("cc_cli", "idOper")		
	lnIdCliente = Thisform.contenido.sel_Cliente.valcpoid

	&& Inserto el registro correspondiente a la factura en la tabla de cuentas corrientes
	lcSql = "INSERT INTO cc_cli (idCC_Cli, idCliente, idCC_Orig, cbte, nroCbte, tipoDoc, ptoVta, idCondPago, idSitIVA, idVendedor, "
	lcSql = lcSql + "fecEmis, fecVto, impDebe, impHaber, idOper, idVentasC, usuAlta, fecAlta, idHostAlta) VALUES ( "
	lcSql = lcSql + ALLTRIM(STR(lnProxID)) + ", " + ALLTRIM(STR(lnIdCliente)) + ", null, '" + IIF(ALLTRIM(lcCbte) == "PTO", "FC", ALLTRIM(lcCbte)) + "', "
	lcSql = lcSql + ALLTRIM(STR(lnNroCbte)) + ", '" + ALLTRIM(lcTipoDoc) + "', " + ALLTRIM(STR(lnPtoVta)) + ", " + ALLTRIM(STR(lnIdCondPago)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIdSitIVA)) + ", " + ALLTRIM(STR(lnIdVendedor)) + ", " + oDT.toMySql(Thisform.contenido.txtFecEmis.Value) + ", "
	lcSql = lcsql + IIF(INT(VAL(getconfig("SQLSRV"))) = 1, oDT.getDateTime() + " + " + ALLTRIM(STR(thisform.cp_cntdias)), oDT.toMySql(ldFecVto)) + ", " + ALLTRIM(STR(lnTotFact, 10, 2)) + ", 0, " + ALLTRIM(STR(lnIdOper)) + ", " + ALLTRIM(STR(lnIdVentasC)) + ", "
	lcSql = lcSql + "'" + ALLTRIM(gcCodUsu) + "', " + oDT.getDateTime() + ", '" + ALLTRIM(SYS(0)) + "')"

	IF ALLTRIM(thisform.cbte) == "PTO" THEN	
		loCommand.ActiveConnection = loConDMO.ActiveConnection
	ELSE
		loCommand.ActiveConnection = goConn.ActiveConnection
	ENDIF
	
	loCommand.CommandText = lcSql
	
	IF !loCommand.Execute()	
		thisform.desbloq_numerador()
		goConn.Rollback()
		RETURN .F.
	ENDIF
ENDIF

&& Ahora tengo que generar la relación entre el comprobante de origen con el comprobante
&& de destino
IF (ALLTRIM(Thisform.cbte) == "NC") .OR. (ALLTRIM(Thisform.Cbte) == "FC") .OR. (ALLTRIM(Thisform.cbte) == "PTO") THEN
	SELECT cur_cbtes
	IF RECCOUNT("cur_cbtes") > 0 THEN
		GO TOP
	ENDIF
	
	DO WHILE !EOF("cur_cbtes")
		IF cur_cbtes.sel THEN
			IF ALLTRIM(thisform.cbte) == "PTO" THEN
				lnProxID = loConDMO.GetNextId("ventasrel", "idVtaRel")
			ELSE
				lnProxID = goConn.GetNextId("ventasrel", "idVtaRel")
			ENDIF
			
			lcSql = "INSERT INTO ventasrel (idVtaRel, idVtaCO, idVtaCD) VALUES ("
			lcSql = lcSql + ALLTRIM(STR(lnProxID)) + ", " + ALLTRIM(STR(cur_cbtes.idVentasC)) + ", " + ALLTRIM(STR(lnIdVentasC)) + ")"
			
			loCommand.CommandText = lcSql

			IF ALLTRIM(lcCbte) == "PTO" 
				loCommand.ActiveConnection = loConDMO.ActiveConnection
				IF !loCommand.Execute()
					thisform.desbloq_numerador()
					loConDMO.Rollback()
					RETURN .F.
				ENDIF	
			ELSE
				loCommand.ActiveConnection = goConn.ActiveConnection
				IF !loCommand.Execute()
					thisform.desbloq_numerador()
					goConn.Rollback()
					RETURN .F.
				ENDIF
			ENDIF
		ENDIF
		
		SELECT cur_cbtes
		SKIP
	ENDDO
ENDIF

************************************************************************************************
* Agrego que se genere el movimiento de stock al grabar la operación
* siempre y cuando el sistema se encuentre configurado para soportar esta funcionalidad
************************************************************************************************
*!*	IF getGlobalCFG("STK_MODULE") .AND. (ALLTRIM(THisform.Cbte) <> "COT" .OR. ALLTRIM(THisform.Cbte) <> "NC") THEN
*!*		IF ALLTRIM(thisform.cbte) == "PTO" THEN
*!*			Thisform.mov_stock.circuito = "S"
*!*			Thisform.mov_stock.tipodoc = ""
*!*			Thisform.mov_stock.cbte = ""
*!*		ELSE
*!*			Thisform.mov_stock.circuito = "V"
*!*			Thisform.mov_stock.idcliente = thisform.contenido.sel_Cliente.valcpoid
*!*			Thisform.mov_stock.idprov = 0
*!*			Thisform.mov_stock.tipodoc = Thisform.tipodoc
*!*			Thisform.mov_stock.cbte = IIF(ALLTRIM(lcCbte) == "PTO", "SAL", lcCbte)
*!*			Thisform.mov_stock.numcbte =  REPLICATE("0", 4 - LEN(ALLTRIM(STR(lnPtoVta)))) + ALLTRIM(STR(lnPtoVta)) + "-" + REPLICATE("0", 8 - LEN(ALLTRIM(STR(lnNroCbte)))) + ALLTRIM(STR(lnNroCbte))		
*!*		ENDIF
*!*		
*!*		IF !(ALLTRIM(Thisform.cbte) == "COT") THEN
*!*			IF !(ALLTRIM(Thisform.cbte) == "PED") THEN
*!*				IF !Thisform.mov_stock.grabar2() THEN
*!*					MESSAGEBOX(Thisform.mov_stock.ErrorMessage, 0+48, Thisform.Caption)
*!*					thisform.desbloq_numerador()
*!*					goConn.Rollback()
*!*					RETURN .F.
*!*				ENDIF
*!*			ENDIF	
*!*		ENDIF 			
*!*	ENDIF

IF ALLTRIM(thisform.cbte) == "PTO" THEN
	loConDMO.Commit()
	loConDMO.close()	
ELSE
	goConn.Commit()
ENDIF

thisform.desbloq_numerador()

thisform.id_ventasc = lnIdVentasC

RETURN .T.
ENDPROC
PROCEDURE recuperar_ped
&& Este método permite recuperar los pedidos para facturar.

LOCAL lcSql, loResult, loResArt, lcCodArt, lcDescripcio, lnContOfta
LOCAL lnCantidad
LOCAL lnImpNeto, lnTotNeto

loResult = CREATEOBJECT("odbc_result")
loResArt = CREATEOBJECT("odbc_result")
lcSql = ""
lnContOfta = 0
lnCantidad = 0
lnImpNeto = 0.00
lnTotNeto = 0.00

&& Levanto el detalle del comprobante 
lcSql = "SELECT * FROM ventasdet WHERE idVentasC = " + ALLTRIM(STR(Thisform.idorigen)) + " "

loResult.ActiveConnection = goConn.ActiveConnection
loResult.cursor_name = "cur_Vtas"
loResult.OpenQuery(lcSql)

SELECT cur_Vtas
IF RECCOUNT("cur_Vtas") > 0 THEN 
	GO TOP 
ENDIF 

SELECT cur_Vtas
DO WHILE !EOF("cur_Vtas")
	lcSql = "SELECT * FROM articulos WHERE idArticulo = " + ALLTRIM(STR(cur_Vtas.idArticulo))
	loResArt.ActiveConnection = goConn.ActiveConnection
	loResArt.cursor_name = "cur_artic"
	
	IF !loResArt.OpenQuery(lcSql)
		MESSAGEBOX(loResArt.error_message, 0+48, Thisform.Caption)
		RETURN .F.
	ENDIF
	
	SELECT cur_artic
	IF RECCOUNT("cur_artic") > 0 THEN 
		GO TOP 
	ENDIF  
	
	SELECT cur_artic
	lcCodArt = cur_artic.codArt
	lcDescripcio = cur_Vtas.descripcio
	
	IF ALLTRIM(Thisform.cbte) == "FC" THEN
		lnCantidad = cur_Vtas.cant_pri1 - cur_Vtas.cantNC
	ELSE
		IF ALLTRIM(Thisform.cbte) == "PTO" THEN
			lnCantidad = cur_Vtas.cant_pri2 - cur_Vtas.cantNC
		ELSE
			lnCantidad = cur_Vtas.cantidad - cur_Vtas.cantNC
		ENDIF
	ENDIF	
	
	loResArt.Close_Query()
	
	IF lnCantidad <> 0 THEN
		SELECT cur_Deta_View
		APPEND BLANK
		REPLACE cur_Deta_View.idDetalle		WITH Thisform.nroitem
		REPLACE cur_Deta_View.idArticulo 	WITH cur_Vtas.idArticulo ADDITIVE
		REPLACE cur_Deta_View.codArt 		WITH lcCodArt ADDITIVE
		REPLACE cur_Deta_View.descripcio 	WITH lcDescripcio ADDITIVE
		REPLACE cur_Deta_View.cantidad 		WITH lnCantidad ADDITIVE 
		REPLACE cur_Deta_View.prVta			WITH cur_Vtas.prVenta ADDITIVE
		REPLACE cur_Deta_View.pDtoVta1		WITH cur_Vtas.pDtoVta1 ADDITIVE 
		REPLACE cur_Deta_View.pDtoVta2		WITH cur_Vtas.pDtoVta2 ADDITIVE 
		REPLACE cur_Deta_View.pDtoVta3		WITH cur_Vtas.pDtoVta3 ADDITIVE 
		REPLACE cur_Deta_View.pDtoVta4		WITH cur_Vtas.pDtoVta4 ADDITIVE
		REPLACE cur_Deta_View.iDtoVta1		WITH cur_Vtas.iDtoVta1 ADDITIVE 
		REPLACE cur_Deta_View.iDtoVta2		WITH cur_Vtas.iDtoVta2 ADDITIVE 
		REPLACE cur_Deta_View.iDtoVta3		WITH cur_Vtas.iDtoVta3 ADDITIVE 
		REPLACE cur_Deta_View.iDtoVta4		WITH cur_Vtas.iDtoVta4 ADDITIVE 
		REPLACE cur_Deta_View.pDtoCli1		WITH cur_Vtas.porDesc1 ADDITIVE 
		REPLACE cur_Deta_View.pDtoCli2		WITH cur_Vtas.porDesc2 ADDITIVE 
		REPLACE cur_Deta_View.pDtoCli3		WITH cur_Vtas.porDesc3 ADDITIVE 
		REPLACE cur_Deta_View.pDtoCli4		WITH cur_Vtas.porDesc4 ADDITIVE 		
		REPLACE cur_Deta_View.iDtoCli1		WITH cur_Vtas.impDesc1 ADDITIVE 
		REPLACE cur_Deta_View.iDtoCli2		WITH cur_Vtas.impDesc2 ADDITIVE 
		REPLACE cur_Deta_View.iDtoCli3		WITH cur_Vtas.impDesc3 ADDITIVE 
		REPLACE cur_Deta_View.iDtoCli4		WITH cur_Vtas.impDesc4 ADDITIVE		
		REPLACE cur_Deta_View.pRecItem		WITH cur_Vtas.pRecItem ADDITIVE
		REPLACE cur_Deta_View.iRecItem		WITH cur_Vtas.iRecItem ADDITIVE
		REPLACE cur_Deta_View.alicIVA 		WITH cur_Vtas.alicIVA ADDITIVE
		REPLACE cur_Deta_View.impIVA 		WITH cur_Vtas.impIVA ADDITIVE
		REPLACE cur_Deta_View.impNeto 		WITH cur_Vtas.impNeto ADDITIVE
		REPLACE cur_Deta_View.totNeto 		WITH cur_Vtas.totNeto ADDITIVE
		REPLACE cur_Deta_View.subTotal 		WITH cur_Vtas.subTotal ADDITIVE
		REPLACE cur_Deta_View.esOferta 		WITH cur_Vtas.esOferta ADDITIVE
		REPLACE cur_Deta_View.prArtic		WITH cur_Vtas.prArtic ADDITIVE
		REPLACE cur_Deta_View.pRecVta 		WITH cur_Vtas.pRecVta ADDITIVE 
		REPLACE cur_Deta_View.iRecVta		WITH cur_Vtas.iRecVta ADDITIVE
		REPLACE cur_Deta_View.uniDesp		WITH cur_Vtas.uniDesp ADDITIVE
		REPLACE cur_Deta_View.cantPack		WITH cur_Vtas.cantPack ADDITIVE
		REPLACE cur_Deta_View.uniMed		WITH cur_Vtas.codUM ADDITIVE
		REPLACE cur_Deta_View.detobs		WITH cur_Vtas.observ ADDITIVE
		
		Thisform.nroitem = Thisform.nroitem + 1
	ENDIF
	
	IF cur_Vtas.esOferta THEN
		lnContOfta = lnContOfta + 1
	ENDIF
	
	SELECT cur_Vtas
	SKIP
ENDDO

loResult.Close_Query()

SELECT cur_Deta_View
IF RECCOUNT("cur_Deta_View") > 0 THEN
	GO TOP
ENDIF

Thisform.contenido.txtdesc1.Value = cur_Deta_View.pDtoCli1
Thisform.contenido.txtdesc2.Value = cur_Deta_View.pDtoCli2
Thisform.contenido.txtdesc3.Value = cur_Deta_View.pDtoCli3
Thisform.contenido.txtdesc4.Value = cur_Deta_View.pDtoCli4
Thisform.contenido.txtporrec.Value = cur_Deta_View.pRecVta

Thisform.Contenido.grdDetalles.Refresh()

IF lnContOfta > 0 THEN
	MESSAGEBOX("Este pedido tiene " + ALLTRIM(STR(lnContOfta)) + " artículo(s) en oferta", 0+64, Thisform.Caption)
ENDIF

thisform.recalcular_todo()

RETURN .T.
ENDPROC
PROCEDURE contenido.sel_Cliente.recuperar_datos
LOCAL lo_rsSitIVA, lo_rsCondPago, lo_rsLocalidad, lo_rsPcia, lo_rsIIBB, lcSql
LOCAL lo_rsTipoDoc

lo_rsSitIVA = CREATEOBJECT("odbc_result")
lo_rsCondPago = CREATEOBJECT("odbc_result")
lo_rsLocalidad = CREATEOBJECT("odbc_result")
lo_rsPcia = CREATEOBJECT("odbc_result")
lo_rsIIBB = CREATEOBJECT("odbc_result")
lo_rsTipoDoc = CREATEOBJECT("odbc_result")
lcSql = ""

IF Thisform.contenido.sel_Cliente.txtCodigo.Value == 0 THEN 
	Thisform.contenido.sel_Cliente.txtDescripcion.Value = ""
	RETURN .F.
ENDIF 

SELECT clientes

IF !clientes.habilitado THEN 
	MESSAGEBOX("Este cliente no está habilitado, por favor, verifique el estado del cliente", 0+48, Thisform.Caption)
	this.valcpoid = 0
	this.blanquear()
	this.txtcodigo.SetFocus()
	
	RETURN .F.
ENDIF 

IF ALLTRIM(thisform.cbte) == "FC" .OR. ALLTRIM(thisform.cbte) == "PED" THEN
	IF clientes.contrCM THEN
		thisform.calcular_saldo_dedudor()
		
		IF thisform.saldodeudor > clientes.credMax THEN
			MESSAGEBOX("El saldo deudor supera al crédito máximo otorgado", 0+48, Thisform.Caption)
			RETURN .F.
		ENDIF
	ENDIF
ENDIF

Thisform.contenido.txtDesc1.Value = clientes.desc1
Thisform.contenido.txtDesc2.Value = clientes.desc2
Thisform.contenido.txtDesc3.Value = clientes.desc3
Thisform.contenido.txtDesc4.Value = clientes.desc4
Thisform.cli_calle = clientes.direccion
Thisform.cli_cuit = clientes.nroCUIT
Thisform.cli_telefono = clientes.telefono
Thisform.cli_Id = clientes.idCliente
Thisform.contenido.txttelefono.Value = clientes.telefono
Thisform.contenido.txtcuit.Value = clientes.nrocuit
Thisform.envcbte = clientes.envcbte
Thisform.contenido.chkEnviarMail.Value = clientes.envcbte
Thisform.contenido.chkImprimirCbte.Value = clientes.printcbte
Thisform.mailfc = ALLTRIM(clientes.mailFC)
Thisform.Contenido.txtMailFC.Value = ALLTRIM(clientes.mailFC)
Thisform.printcbte = clientes.printcbte

&& Levanto el codigo de tipo de documento
lcSql = "SELECT * FROM tipodoc WHERE idTipoDoc = " + ALLTRIM(STR(clientes.idTipoDoc))
lo_rsTipoDoc.ActiveConnection = goConn.ActiveConnection
lo_rsTipoDoc.Cursor_Name = "cur_tipodoc"
lo_rsTipoDoc.OpenQuery(lcSql)

SELECT cur_tipodoc
Thisform.cli_tipodoc = cur_tipodoc.tipodoc
Thisform.cli_idtipodoc = clientes.idTipoDoc

IF !(ALLTRIM(Thisform.cli_tipodoc) == "CUIT" .OR. ALLTRIM(Thisform.cli_tipodoc) == "CUIL") THEN
	This.Parent.txtCuit.InputMask = ""
ELSE
	This.Parent.txtCuit.InputMask = "XX-XXXXXXXX-XX"
ENDIF

lo_rsTipoDoc.close_query()

lcSql = "SELECT * FROM localidad WHERE idLocalid = " + ALLTRIM(STR(clientes.idLocalid))
lo_rsLocalidad.ActiveConnection = goConn.ActiveConnection
lo_rsLocalidad.Cursor_Name = "cur_Localid"
lo_rsLocalidad.OpenQuery(lcSql)

SELECT cur_Localid
Thisform.cli_localidad = cur_Localid.descripcio
Thisform.cli_codpostal = cur_Localid.codPostal

lcSql = "SELECT * FROM provincias WHERE idProvin = " + ALLTRIM(STR(cur_Localid.idProvin))
lo_rsPcia.ActiveConnection = goConn.ActiveConnection
lo_rsPcia.Cursor_Name = "cur_Pcia"
lo_rsPcia.OpenQuery(lcSql)

SELECT cur_Pcia
Thisform.cli_pcia = cur_Pcia.descripcio

lo_rsPcia.close_query()
lo_rsLocalidad.close_query()

lcSql = "SELECT * FROM sitiva WHERE idSitIVA = " + ALLTRIM(STR(clientes.idSitIVA))
lo_rsSitIVA.ActiveConnection = goConn.ActiveConnection
lo_rsSitIVA.Cursor_Name = "cur_SitIVA"
lo_rsSitIVA.OpenQuery(lcSql)

SELECT cur_SitIVA
Thisform.contenido.txtSitIVA.Value = cur_SitIVA.descripcio
Thisform.sitivacli = cur_SitIVA.idSitIVA
Thisform.CodIVAFiscal = cur_SitIVA.CodFiscal
Thisform.condicion_iva_receptor_id = cur_SitIVA.conivareid

lo_rsSitIVA.close_query()

lcSql = "SELECT * FROM condpagos WHERE idCondPago = " + ALLTRIM(STR(clientes.idCondPago))
lo_rsCondPago.ActiveConnection = goConn.ActiveConnection
lo_rsCondPago.Cursor_Name = "cur_CondPago"
lo_rsCondPago.OpenQuery(lcSql)

SELECT cur_CondPago
Thisform.contenido.sel_FormaPago.valcpoid = cur_CondPago.idCondPago
Thisform.contenido.sel_FormaPago.txtCodigo.Value = cur_CondPago.idCondPago
Thisform.contenido.sel_FormaPago.txtDescripcion.Value = cur_CondPago.Descripcio
thisform.cp_cntdias = cur_CondPago.cntDias

lo_rsCondPago.close_query()

IF ALLTRIM(Thisform.cbte) <> "PTO" THEN 
	lcSql = "SELECT * FROM padronib WHERE cuit = '" + ALLTRIM(STRTRAN(clientes.nrocuit,"-","")) + "'"
	lo_rsIIBB.ActiveConnection = goConn.ActiveConnection
	lo_rsIIBB.Cursor_Name = "cur_PadronIB"
	lo_rsIIBB.OpenQuery(lcSql)

	SELECT cur_PadronIB
	IF RECCOUNT("cur_PadronIB") > 0 THEN
		Thisform.contenido.txtPorIIBB.Value = cur_PadronIB.AlicuotaPer
	ELSE 
		Thisform.contenido.txtPorIIBB.Value = 0.00
	ENDIF 

	lo_rsIIBB.close_query()
ENDIF 

Thisform.contenido.txtPorRec.Value = IIF(ISNULL(clientes.recargo), 0.00, clientes.recargo)

IF ALLTRIM(thisform.cbte) != "NC" THEN 
	thisform.recalcular_todo()
ENDIF

IF ALLTRIM(thisform.cbte) == "FC" .OR. ALLTRIM(thisform.cbte) == "PED" THEN
	IF clientes.ctrMoro THEN
		thisform.mostrar_morosidad()
	ENDIF	
ENDIF

* Valido que el CUIT esté bien cargado mediante el dígito verificador
* Solo lo valido si el tipo de documento es CUIT o CUIL
IF clientes.idTipoDoc = 1 .OR. clientes.idTipoDoc = 6 THEN
	IF !ValidarCUIT(ALLTRIM(Thisform.cli_cuit)) THEN
		MESSAGEBOX("El CUIT no es válido, por favor verifique el mismo y corrijalo desde el ABM de clientes", 0+48, Thisform.Caption)
		RETURN
	ENDIF
ENDIF

IF This.valcpoid = getglobalcfg("CLI_CF") THEN
	This.txtDescripcion.ReadOnly = .F.
	This.txtDescripcion.Enabled = .T.
	This.txtDescripcion.SetFocus()
	Thisform.contenido.txtPrMinorista.ReadOnly = .F.
	Thisform.contenido.txtPrMinorista.Enabled = .T.
	Thisform.contenido.txtDesc1.Enabled = .T.
	Thisform.contenido.txtDesc2.Enabled = .T.
	Thisform.contenido.txtDesc3.Enabled = .T.
	Thisform.contenido.txtDesc4.Enabled = .T.
	Thisform.contenido.txtCuit.Enabled = .T.
		
	Thisform.contenido.txtDesc1.ReadOnly = .F.
	Thisform.contenido.txtDesc2.ReadOnly = .F.
	Thisform.contenido.txtDesc3.ReadOnly = .F.
	Thisform.contenido.txtDesc4.ReadOnly = .F.
	Thisform.contenido.txtCuit.ReadOnly = .F.
ELSE
	This.txtDescripcion.ReadOnly = .T.
	This.txtDescripcion.Enabled = .F.
	Thisform.contenido.txtPrMinorista.ReadOnly = .T.
	Thisform.contenido.txtPrMinorista.Enabled = .F.
	Thisform.contenido.txtDesc1.Enabled = .T.
	Thisform.contenido.txtDesc2.Enabled = .T.
	Thisform.contenido.txtDesc3.Enabled = .T.
	Thisform.contenido.txtDesc4.Enabled = .T.
	Thisform.contenido.txtCuit.Enabled = .T.
		
	Thisform.contenido.txtDesc1.ReadOnly = .F.
	Thisform.contenido.txtDesc2.ReadOnly = .F.
	Thisform.contenido.txtDesc3.ReadOnly = .F.
	Thisform.contenido.txtDesc4.ReadOnly = .F.
	Thisform.contenido.txtCuit.ReadOnly = .F.
ENDIF

ENDPROC
PROCEDURE contenido.btnAgregar.Click
IF thisform.agregar_item_viewer() THEN
	Thisform.contenido.sel_Articulo.blanquear()
	Thisform.contenido.txtprMay.Value = 0.00
	Thisform.contenido.txtPrMinorista.Value = 0.00
	Thisform.contenido.txtCantidad.Value = 0.00
	Thisform.contenido.txtPrNeto.Value = 0.00
	Thisform.contenido.txtSubTotal.Value = 0.00
	Thisform.contenido.txtAlicIVA.Value = 0.00
	Thisform.contenido.txtImpIVA.Value = 0.00
	Thisform.contenido.txtSTNeto.Value = 0.00
	Thisform.contenido.txtPorDesc1.Value = 0.00
	Thisform.contenido.txtPorDesc2.Value = 0.00
	Thisform.contenido.txtPorDesc3.Value = 0.00
	Thisform.contenido.txtPorDesc4.Value = 0.00
	Thisform.contenido.txtImpDescItem1.Value = 0.00
	Thisform.contenido.txtImpDescItem2.Value = 0.00
	Thisform.contenido.txtImpDescItem3.Value = 0.00
	Thisform.contenido.txtImpDescItem4.Value = 0.00
	Thisform.contenido.txtDetObs.blanquear()
	Thisform.pr_mayorista = 0.00
	Thisform.pr_minorista = 0.00
	Thisform.contenido.txtCantPack.Value = 0.00
	Thisform.contenido.cboUnidVta.Clear()
	Thisform.unimed = ""
	Thisform.prarti_x = 0.00
	Thisform.contenido.txtPorRecItem.Value = 0.00

	Thisform.sumar_items()
	Thisform.calcular_ret_iibb()
	
	SELECT cur_Deta_View 
	GO BOTTOM
	Thisform.contenido.grdDetalles.Refresh()

	Thisform.contenido.sel_Articulo.txtDescripcion.Enabled = .F.
	Thisform.contenido.txtPrMinorista.Enabled = .F.
	Thisform.contenido.sel_Articulo.txtCodigo.SetFocus()
ENDIF
ENDPROC
PROCEDURE contenido.txtPorRec.LostFocus
thisform.recalcular_todo()

ENDPROC


************************************************************
OBJETO: Clsetiqueta28
************************************************************
*** PROPIEDADES ***
Caption = "Observación:"
Height = 15
Left = 676
Top = 121
Width = 80
TabIndex = 95
Name = "Clsetiqueta28"

*** METODOS ***


************************************************************
OBJETO: txtDetObs
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 756
MaxLength = 30
TabIndex = 6
Top = 117
Width = 230
ischaracter = .T.
Name = "txtDetObs"

*** METODOS ***


************************************************************
OBJETO: 
************************************************************
*** PROPIEDADES ***
Arial, 0, 9, 5, 15, 12, 32, 3, 0
Arial, 1, 8, 5, 14, 11, 29, 3, 0
Arial, 1, 9, 6, 15, 12, 32, 3, 0

*** METODOS ***


