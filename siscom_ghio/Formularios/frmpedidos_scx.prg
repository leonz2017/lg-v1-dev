************************************************************
OBJETO: Dataenvironment
************************************************************
*** PROPIEDADES ***
Top = 0
Left = 0
Width = 0
Height = 0
DataSource = .NULL.
Name = "Dataenvironment"

*** METODOS ***


************************************************************
OBJETO: FRMPEDIDOS
************************************************************
*** PROPIEDADES ***
BorderStyle = 2
Height = 571
Width = 990
DoCreate = .T.
Caption = "Ingreso de Pedidos"
cbte = PED
Name = "FRMPEDIDOS"
contenido.Clsetiqueta1.TabIndex = 38
contenido.Clsetiqueta1.Name = "Clsetiqueta1"
contenido.sel_Cliente.txtCodigo.Name = "txtCodigo"
contenido.sel_Cliente.txtDescripcion.Name = "txtDescripcion"
contenido.sel_Cliente.TabIndex = 1
contenido.sel_Cliente.nombre_tabla = clientes
contenido.sel_Cliente.Name = "sel_Cliente"
contenido.Clsetiqueta2.TabIndex = 40
contenido.Clsetiqueta2.Name = "Clsetiqueta2"
contenido.Clsetiqueta3.TabIndex = 41
contenido.Clsetiqueta3.Name = "Clsetiqueta3"
contenido.txtSitIVA.TabIndex = 30
contenido.txtSitIVA.Name = "txtSitIVA"
contenido.sel_FormaPago.txtCodigo.Name = "txtCodigo"
contenido.sel_FormaPago.txtDescripcion.Name = "txtDescripcion"
contenido.sel_FormaPago.TabIndex = 3
contenido.sel_FormaPago.Name = "sel_FormaPago"
contenido.Clslinea1.Left = 8
contenido.Clslinea1.Top = 118
contenido.Clslinea1.Name = "Clslinea1"
contenido.Clsetiqueta4.Left = 9
contenido.Clsetiqueta4.Top = 126
contenido.Clsetiqueta4.TabIndex = 42
contenido.Clsetiqueta4.Name = "Clsetiqueta4"
contenido.sel_Articulo.txtCodigo.Name = "txtCodigo"
contenido.sel_Articulo.txtDescripcion.Name = "txtDescripcion"
contenido.sel_Articulo.Top = 120
contenido.sel_Articulo.Left = 112
contenido.sel_Articulo.TabIndex = 5
contenido.sel_Articulo.Name = "sel_Articulo"
contenido.Clsetiqueta5.Left = 238
contenido.Clsetiqueta5.Top = 149
contenido.Clsetiqueta5.TabIndex = 44
contenido.Clsetiqueta5.Name = "Clsetiqueta5"
contenido.txtCantidad.Left = 291
contenido.txtCantidad.TabIndex = 8
contenido.txtCantidad.Top = 145
contenido.txtCantidad.Name = "txtCantidad"
contenido.btnAgregar.Top = 192
contenido.btnAgregar.Left = 899
contenido.btnAgregar.TabIndex = 9
contenido.btnAgregar.Name = "btnAgregar"
contenido.grdDetalles.COLUMN1.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN1.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN1.Name = "COLUMN1"
contenido.grdDetalles.COLUMN2.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN2.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN2.Name = "COLUMN2"
contenido.grdDetalles.COLUMN3.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN3.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN3.Name = "COLUMN3"
contenido.grdDetalles.COLUMN4.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN4.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN4.Name = "COLUMN4"
contenido.grdDetalles.COLUMN5.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN5.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN5.Name = "COLUMN5"
contenido.grdDetalles.COLUMN6.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN6.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN6.Name = "COLUMN6"
contenido.grdDetalles.COLUMN7.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN7.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN7.Name = "COLUMN7"
contenido.grdDetalles.COLUMN8.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN8.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN8.Name = "COLUMN8"
contenido.grdDetalles.COLUMN9.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN9.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN9.Name = "COLUMN9"
contenido.grdDetalles.COLUMN10.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN10.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN10.Name = "COLUMN10"
contenido.grdDetalles.COLUMN11.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN11.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN11.Name = "COLUMN11"
contenido.grdDetalles.COLUMN12.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN12.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN12.Name = "COLUMN12"
contenido.grdDetalles.COLUMN13.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN13.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN13.Name = "COLUMN13"
contenido.grdDetalles.COLUMN14.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN14.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN14.Name = "COLUMN14"
contenido.grdDetalles.COLUMN15.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN15.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN15.Name = "COLUMN15"
contenido.grdDetalles.COLUMN16.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN16.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN16.Name = "COLUMN16"
contenido.grdDetalles.COLUMN17.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN17.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN17.Name = "COLUMN17"
contenido.grdDetalles.COLUMN18.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN18.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN18.Name = "COLUMN18"
contenido.grdDetalles.COLUMN19.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN19.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN19.Name = "COLUMN19"
contenido.grdDetalles.COLUMN20.Header1.Name = "Header1"
contenido.grdDetalles.COLUMN20.Text1.Name = "Text1"
contenido.grdDetalles.COLUMN20.Name = "COLUMN20"
contenido.grdDetalles.Left = 6
contenido.grdDetalles.TabIndex = 45
contenido.grdDetalles.Top = 235
contenido.grdDetalles.Name = "grdDetalles"
contenido.btnGrabar.Top = 523
contenido.btnGrabar.Left = 893
contenido.btnGrabar.TabIndex = 11
contenido.btnGrabar.Name = "btnGrabar"
contenido.btnCancelar.Top = 522
contenido.btnCancelar.Left = 7
contenido.btnCancelar.TabIndex = 13
contenido.btnCancelar.Name = "btnCancelar"
contenido.Clscerrar1.Top = 523
contenido.Clscerrar1.Left = 941
contenido.Clscerrar1.TabIndex = 12
contenido.Clscerrar1.Name = "Clscerrar1"
contenido.Clsetiqueta10.Left = 373
contenido.Clsetiqueta10.Top = 149
contenido.Clsetiqueta10.TabIndex = 67
contenido.Clsetiqueta10.Name = "Clsetiqueta10"
contenido.txtPrMay.Left = 478
contenido.txtPrMay.TabIndex = 27
contenido.txtPrMay.Top = 145
contenido.txtPrMay.Name = "txtPrMay"
contenido.Clsetiqueta11.Left = 587
contenido.Clsetiqueta11.Top = 149
contenido.Clsetiqueta11.TabIndex = 69
contenido.Clsetiqueta11.Name = "Clsetiqueta11"
contenido.txtPrMinorista.Left = 692
contenido.txtPrMinorista.TabIndex = 26
contenido.txtPrMinorista.Top = 145
contenido.txtPrMinorista.Name = "txtPrMinorista"
contenido.Clsetiqueta12.Left = 207
contenido.Clsetiqueta12.Top = 195
contenido.Clsetiqueta12.TabIndex = 75
contenido.Clsetiqueta12.Name = "Clsetiqueta12"
contenido.txtAlicIVA.Left = 290
contenido.txtAlicIVA.TabIndex = 76
contenido.txtAlicIVA.Top = 191
contenido.txtAlicIVA.Name = "txtAlicIVA"
contenido.btnEliminar.Top = 192
contenido.btnEliminar.Left = 942
contenido.btnEliminar.TabIndex = 10
contenido.btnEliminar.Name = "btnEliminar"
contenido.chkImprimeDup.Alignment = 0
contenido.chkImprimeDup.TabIndex = 83
contenido.chkImprimeDup.Name = "chkImprimeDup"
contenido.btnCbteOrigen.TabIndex = 28
contenido.btnCbteOrigen.Name = "btnCbteOrigen"
contenido.txtObserv.Left = 6
contenido.txtObserv.TabIndex = 24
contenido.txtObserv.Top = 424
contenido.txtObserv.Name = "txtObserv"
contenido.Clsetiqueta6.Left = 8
contenido.Clsetiqueta6.Top = 471
contenido.Clsetiqueta6.TabIndex = 46
contenido.Clsetiqueta6.Name = "Clsetiqueta6"
contenido.Clsetiqueta7.Left = 316
contenido.Clsetiqueta7.Top = 471
contenido.Clsetiqueta7.TabIndex = 50
contenido.Clsetiqueta7.Name = "Clsetiqueta7"
contenido.Clsetiqueta8.Left = 316
contenido.Clsetiqueta8.Top = 494
contenido.Clsetiqueta8.TabIndex = 52
contenido.Clsetiqueta8.Name = "Clsetiqueta8"
contenido.Clsetiqueta9.Left = 8
contenido.Clsetiqueta9.Top = 495
contenido.Clsetiqueta9.TabIndex = 53
contenido.Clsetiqueta9.Name = "Clsetiqueta9"
contenido.txtTotNeto.Left = 44
contenido.txtTotNeto.TabIndex = 55
contenido.txtTotNeto.Top = 467
contenido.txtTotNeto.Name = "txtTotNeto"
contenido.txtPorIVA21.Left = 387
contenido.txtPorIVA21.TabIndex = 58
contenido.txtPorIVA21.Top = 467
contenido.txtPorIVA21.Name = "txtPorIVA21"
contenido.txtPorIVA105.Left = 387
contenido.txtPorIVA105.TabIndex = 59
contenido.txtPorIVA105.Top = 490
contenido.txtPorIVA105.Name = "txtPorIVA105"
contenido.txtImpIVA21.Left = 469
contenido.txtImpIVA21.TabIndex = 61
contenido.txtImpIVA21.Top = 467
contenido.txtImpIVA21.Name = "txtImpIVA21"
contenido.txtImpIVA105.Left = 469
contenido.txtImpIVA105.TabIndex = 62
contenido.txtImpIVA105.Top = 490
contenido.txtImpIVA105.Name = "txtImpIVA105"
contenido.txtTotal.Left = 44
contenido.txtTotal.TabIndex = 63
contenido.txtTotal.Top = 490
contenido.txtTotal.Name = "txtTotal"
contenido.Clsetiqueta14.TabIndex = 78
contenido.Clsetiqueta14.Name = "Clsetiqueta14"
contenido.txtDesc1.ReadOnly = .F.
contenido.txtDesc1.TabIndex = 15
contenido.txtDesc1.Name = "txtDesc1"
contenido.txtDesc2.ReadOnly = .F.
contenido.txtDesc2.TabIndex = 16
contenido.txtDesc2.Name = "txtDesc2"
contenido.txtDesc3.ReadOnly = .F.
contenido.txtDesc3.TabIndex = 17
contenido.txtDesc3.Name = "txtDesc3"
contenido.txtDesc4.ReadOnly = .F.
contenido.txtDesc4.TabIndex = 18
contenido.txtDesc4.Name = "txtDesc4"
contenido.txtImpDesc1.TabIndex = 33
contenido.txtImpDesc1.Name = "txtImpDesc1"
contenido.txtImpDesc2.TabIndex = 34
contenido.txtImpDesc2.Name = "txtImpDesc2"
contenido.txtImpDesc3.TabIndex = 35
contenido.txtImpDesc3.Name = "txtImpDesc3"
contenido.txtImpDesc4.TabIndex = 36
contenido.txtImpDesc4.Name = "txtImpDesc4"
contenido.Clsetiqueta15.TabIndex = 77
contenido.Clsetiqueta15.Name = "Clsetiqueta15"
contenido.Clsetiqueta16.TabIndex = 80
contenido.Clsetiqueta16.Name = "Clsetiqueta16"
contenido.Clsetiqueta17.Left = 868
contenido.Clsetiqueta17.Top = 471
contenido.Clsetiqueta17.TabIndex = 54
contenido.Clsetiqueta17.Name = "Clsetiqueta17"
contenido.txtTotFact.Left = 911
contenido.txtTotFact.TabIndex = 64
contenido.txtTotFact.Top = 467
contenido.txtTotFact.Name = "txtTotFact"
contenido.Clsetiqueta18.Height = 15
contenido.Clsetiqueta18.Left = 568
contenido.Clsetiqueta18.Top = 470
contenido.Clsetiqueta18.Width = 63
contenido.Clsetiqueta18.TabIndex = 51
contenido.Clsetiqueta18.Name = "Clsetiqueta18"
contenido.txtPorIIBB.Height = 21
contenido.txtPorIIBB.Left = 639
contenido.txtPorIIBB.TabIndex = 57
contenido.txtPorIIBB.Top = 467
contenido.txtPorIIBB.Width = 78
contenido.txtPorIIBB.Name = "txtPorIIBB"
contenido.txtImpIIBB.Height = 21
contenido.txtImpIIBB.Left = 721
contenido.txtImpIIBB.TabIndex = 60
contenido.txtImpIIBB.Top = 467
contenido.txtImpIIBB.Width = 75
contenido.txtImpIIBB.Name = "txtImpIIBB"
contenido.Clsetiqueta19.Left = 148
contenido.Clsetiqueta19.Top = 471
contenido.Clsetiqueta19.TabIndex = 79
contenido.Clsetiqueta19.Name = "Clsetiqueta19"
contenido.txtST.Left = 207
contenido.txtST.TabIndex = 56
contenido.txtST.Top = 467
contenido.txtST.Name = "txtST"
contenido.Clsetiqueta20.Left = 9
contenido.Clsetiqueta20.Top = 171
contenido.Clsetiqueta20.TabIndex = 65
contenido.Clsetiqueta20.Name = "Clsetiqueta20"
contenido.txtPorDesc1.Left = 114
contenido.txtPorDesc1.ReadOnly = .F.
contenido.txtPorDesc1.TabIndex = 19
contenido.txtPorDesc1.Top = 168
contenido.txtPorDesc1.Name = "txtPorDesc1"
contenido.txtImpDescItem1.Left = 182
contenido.txtImpDescItem1.TabIndex = 84
contenido.txtImpDescItem1.Top = 168
contenido.txtImpDescItem1.Name = "txtImpDescItem1"
contenido.txtPorDesc2.Left = 250
contenido.txtPorDesc2.ReadOnly = .F.
contenido.txtPorDesc2.TabIndex = 20
contenido.txtPorDesc2.Top = 168
contenido.txtPorDesc2.Name = "txtPorDesc2"
contenido.txtImpDescItem2.Left = 319
contenido.txtImpDescItem2.TabIndex = 85
contenido.txtImpDescItem2.Top = 168
contenido.txtImpDescItem2.Name = "txtImpDescItem2"
contenido.txtPorDesc3.Left = 387
contenido.txtPorDesc3.ReadOnly = .F.
contenido.txtPorDesc3.TabIndex = 21
contenido.txtPorDesc3.Top = 168
contenido.txtPorDesc3.Name = "txtPorDesc3"
contenido.txtImpDescItem3.Left = 455
contenido.txtImpDescItem3.TabIndex = 86
contenido.txtImpDescItem3.Top = 168
contenido.txtImpDescItem3.Name = "txtImpDescItem3"
contenido.txtPorDesc4.Left = 523
contenido.txtPorDesc4.ReadOnly = .F.
contenido.txtPorDesc4.TabIndex = 22
contenido.txtPorDesc4.Top = 168
contenido.txtPorDesc4.Name = "txtPorDesc4"
contenido.txtImpDescItem4.Left = 591
contenido.txtImpDescItem4.TabIndex = 87
contenido.txtImpDescItem4.Top = 168
contenido.txtImpDescItem4.Name = "txtImpDescItem4"
contenido.Clsetiqueta21.Left = 363
contenido.Clsetiqueta21.Top = 194
contenido.Clsetiqueta21.TabIndex = 74
contenido.Clsetiqueta21.Name = "Clsetiqueta21"
contenido.txtImpIVA.Left = 430
contenido.txtImpIVA.TabIndex = 88
contenido.txtImpIVA.Top = 191
contenido.txtImpIVA.Name = "txtImpIVA"
contenido.Clsetiqueta22.Left = 9
contenido.Clsetiqueta22.Top = 195
contenido.Clsetiqueta22.TabIndex = 70
contenido.Clsetiqueta22.Name = "Clsetiqueta22"
contenido.txtSTNeto.Left = 114
contenido.txtSTNeto.TabIndex = 72
contenido.txtSTNeto.Top = 191
contenido.txtSTNeto.Name = "txtSTNeto"
contenido.Clsetiqueta13.Left = 505
contenido.Clsetiqueta13.Top = 195
contenido.Clsetiqueta13.TabIndex = 81
contenido.Clsetiqueta13.Name = "Clsetiqueta13"
contenido.txtSubTotal.Left = 579
contenido.txtSubTotal.TabIndex = 82
contenido.txtSubTotal.Top = 191
contenido.txtSubTotal.Name = "txtSubTotal"
contenido.Clsetiqueta23.Left = 815
contenido.Clsetiqueta23.Top = 171
contenido.Clsetiqueta23.TabIndex = 68
contenido.Clsetiqueta23.Name = "Clsetiqueta23"
contenido.txtPrNeto.Height = 21
contenido.txtPrNeto.Left = 890
contenido.txtPrNeto.TabIndex = 71
contenido.txtPrNeto.Top = 168
contenido.txtPrNeto.Width = 88
contenido.txtPrNeto.Name = "txtPrNeto"
contenido.lblExistencia.Left = 711
contenido.lblExistencia.Top = 194
contenido.lblExistencia.TabIndex = 73
contenido.lblExistencia.Name = "lblExistencia"
contenido.txtExistencia.Left = 778
contenido.txtExistencia.TabIndex = 89
contenido.txtExistencia.Top = 191
contenido.txtExistencia.Name = "txtExistencia"
contenido.CLSETIQUETA24.TabIndex = 47
contenido.CLSETIQUETA24.Name = "CLSETIQUETA24"
contenido.TXTPORREC.TabIndex = 14
contenido.TXTPORREC.Name = "TXTPORREC"
contenido.TXTIMPREC.TabIndex = 90
contenido.TXTIMPREC.Name = "TXTIMPREC"
contenido.TXTRECITEM.TabIndex = 37
contenido.TXTRECITEM.Name = "TXTRECITEM"
contenido.CLSETIQUETA25.TabIndex = 39
contenido.CLSETIQUETA25.Name = "CLSETIQUETA25"
contenido.TXTTELEFONO.TabIndex = 29
contenido.TXTTELEFONO.Name = "TXTTELEFONO"
contenido.CLSETIQUETA26.TabIndex = 49
contenido.CLSETIQUETA26.Name = "CLSETIQUETA26"
contenido.TXTCUIT.TabIndex = 2
contenido.TXTCUIT.Name = "TXTCUIT"
contenido.CLSETIQUETA27.Left = 9
contenido.CLSETIQUETA27.Top = 149
contenido.CLSETIQUETA27.TabIndex = 43
contenido.CLSETIQUETA27.Name = "CLSETIQUETA27"
contenido.CBOUNIDVTA.Left = 114
contenido.CBOUNIDVTA.TabIndex = 7
contenido.CBOUNIDVTA.Top = 145
contenido.CBOUNIDVTA.Name = "CBOUNIDVTA"
contenido.TXTCANTPACK.Left = 176
contenido.TXTCANTPACK.TabIndex = 25
contenido.TXTCANTPACK.Top = 145
contenido.TXTCANTPACK.Name = "TXTCANTPACK"
contenido.CLSETIQUETA28.TabIndex = 48
contenido.CLSETIQUETA28.Name = "CLSETIQUETA28"
contenido.TXTOC.TabIndex = 31
contenido.TXTOC.Name = "TXTOC"
contenido.Clsetiqueta29.Left = 662
contenido.Clsetiqueta29.Top = 172
contenido.Clsetiqueta29.TabIndex = 66
contenido.Clsetiqueta29.Name = "Clsetiqueta29"
contenido.txtPorRecItem.Left = 745
contenido.txtPorRecItem.TabIndex = 23
contenido.txtPorRecItem.Top = 168
contenido.txtPorRecItem.Name = "txtPorRecItem"
contenido.Clsetiqueta30.Left = 614
contenido.Clsetiqueta30.Top = 87
contenido.Clsetiqueta30.Name = "Clsetiqueta30"
contenido.TXTFECEMIS.Left = 704
contenido.TXTFECEMIS.Top = 84
contenido.TXTFECEMIS.Name = "TXTFECEMIS"
contenido.Clsetiqueta31.Visible = .F.
contenido.Clsetiqueta31.Name = "Clsetiqueta31"
contenido.txtMailFC.Left = 321
contenido.txtMailFC.Top = 84
contenido.txtMailFC.Visible = .F.
contenido.txtMailFC.Name = "txtMailFC"
contenido.chkEnviarMail.Top = 103
contenido.chkEnviarMail.Left = 705
contenido.chkEnviarMail.Alignment = 0
contenido.chkEnviarMail.Visible = .F.
contenido.chkEnviarMail.Name = "chkEnviarMail"
contenido.lblPrecioUnitFinal.Name = "lblPrecioUnitFinal"
contenido.txtPrUnitFinal.Name = "txtPrUnitFinal"
contenido.chkImprimirCbte.Alignment = 0
contenido.chkImprimirCbte.Name = "chkImprimirCbte"
contenido.btnAgregarCliente.Name = "btnAgregarCliente"
contenido.Clsetiqueta32.Name = "Clsetiqueta32"
contenido.txt_subtotal_no_grav.Name = "txt_subtotal_no_grav"
contenido.Clsetiqueta33.Visible = .F.
contenido.Clsetiqueta33.Name = "Clsetiqueta33"
contenido.txt_total_no_grav.Visible = .F.
contenido.txt_total_no_grav.Name = "txt_total_no_grav"
contenido.Name = "contenido"
mov_stock.Name = "mov_stock"
FALTANTES.Name = "FALTANTES"

*** METODOS ***
PROCEDURE blanquear
Thisform.Contenido.sel_Cliente.blanquear()
thisform.contenido.sel_Cliente.valcpoid = 0
Thisform.contenido.txtcuit.Value = ""
Thisform.contenido.sel_transporte.blanquear
Thisform.Contenido.txtSitIVA.Value = ""
Thisform.conteNIDO.txttelefono.Value = ""
Thisform.Contenido.sel_FormaPago.blanquear()
Thisform.contenido.sel_Articulo.blanquear()
Thisform.contenido.sel_Articulo.valcpoid = 0
Thisform.Contenido.txtCantidad.Value = 0.00
Thisform.Contenido.txtPrMay.Value = 0.00
Thisform.Contenido.txtPrMinorista.Value = 0.00
Thisform.Contenido.txtDesc1.Value = 0.00
Thisform.Contenido.txtDesc2.Value = 0.00
Thisform.Contenido.txtDesc3.Value = 0.00
Thisform.Contenido.txtDesc4.Value = 0.00
Thisform.Contenido.txtImpDesc1.Value = 0.00
Thisform.Contenido.txtImpDesc2.Value = 0.00
Thisform.Contenido.txtImpDesc3.Value = 0.00
Thisform.Contenido.txtImpDesc4.Value = 0.00
Thisform.contenido.txtPorDesc1.Value = 0.00
Thisform.contenido.txtPorDesc2.Value = 0.00
Thisform.contenido.txtPorDesc3.Value = 0.00
Thisform.contenido.txtPorDesc4.Value = 0.00
Thisform.contenido.txtImpDescItem1.Value = 0.00
Thisform.contenido.txtImpDescItem2.Value = 0.00
Thisform.contenido.txtImpDescItem3.Value = 0.00
Thisform.contenido.txtImpDescItem4.Value = 0.00
Thisform.contenido.txtPrNeto.Value = 0.00
Thisform.contenido.txtSTNeto.Value = 0.00
Thisform.Contenido.txtAlicIVA.Value = 0.00
Thisform.contenido.txtImpIva.Value = 0.00
Thisform.Contenido.txtSubTotal.Value = 0.00
Thisform.contenido.txtporrec.Value = 0.00
Thisform.contenido.txtimprec.Value = 0.00
Thisform.contenido.txtrecItem.Value = 0.00

Thisform.Contenido.txtTotNeto.Value = 0.00
Thisform.Contenido.txtTotal.Value = 0.00
Thisform.contenido.txtST.Value = 0.00
Thisform.Contenido.txtPorIVA21.Value = 0.00
Thisform.Contenido.txtPorIVA105.Value = 0.00
Thisform.Contenido.txtPorIIBB.Value = 0.00
Thisform.Contenido.txtImpIVA21.Value = 0.00
Thisform.Contenido.txtImpIVA105.Value = 0.00
Thisform.Contenido.txtImpIIBB.Value = 0.00
Thisform.Contenido.txtTotFact.Value = 0.00
Thisform.Contenido.txtOC.Value = 0

thisform.pedido_automatica = .F.
Thisform.Contenido.txtObserv.Value = ""

SELECT cur_Detalle
ZAP
Thisform.Contenido.grdDetalles.Refresh()
Thisform.contenido.btnCbteOrigen.Enabled = .T.
Thisform.Contenido.sel_Cliente.txtCodigo.SetFocus()
Thisform.mov_stock.limpiar()

SELECT cur_Deta_View
ZAP

SELECT cur_DetPart
ZAP

SELECT cur_cbtes
ZAP

ENDPROC
PROCEDURE grabar
&& Grabo la info en la base

LOCAL lnIdVentasC, lnIdCliente, lcFecEmis, lcCbte, lcTipoDoc, lnPtoVta, lnIdTransp
LOCAL lnNroCbte, llAnulado, lnImpNeto, lnImpFinal, lnPorIVA21, lnImpIVA21
LOCAL lnPorIVA105, lnImpIVA105, lnPorDesc1, lnPorDesc2, lnPorDesc3, lnPorDesc4
LOCAL lnImpDesc1, lnImpDesc2, lnImpDesc3, lnImpDesc4, lnTotFact
LOCAL lnIdVentasD, lnIdArticulo, lnCantidad, lnCostoRep, lnPrVenta, lnAlicIVA, lnImpIVA
LOCAL lnTotNeto, lnSubTotal, lnSaldo, lcObserv, lnPorIIBB, lnImpIIBB
LOCAL lnPDtoVta1, lnPDtoVta2, lnPDtoVta3, lnPDtoVta4, lnIDtoVta1, lnIDtoVta2, lnIDtoVta3, lnIDtoVta4
LOCAL lnIdCondPago, lnIdSitIVA, lnPrArtic, lnPorRec, lnImpRec, lnUniDesp, lnCantPack, lcUniMed
LOCAL lnPRecItem, lnIRecItem
LOCAL ldFecVto, lnIdOper, oDT
LOCAL loNumerador, lcSql, loCommand, loArtic, loOper, lnSqlSrv, lnPrNeto, lnIdCCOrig, loCliente, lnIdVendedor
LOCAL lcDetOBS

&& Inicializo las variables del detalle

lnIdVentasD = 0
lnIdArticulo = 0
lnCantidad = 0.00
lnCostoRep = 0.00
lnPrVenta = 0.00
lnAlicIVA = 0.00
lnImpIVA = 0.00
lnTotNeto = 0.00
lnSubTotal = 0.00
ldFecVto = {}
lnIdOper = 0
lnSaldo = 0
lnIdTransp = 0
oDT = CREATEOBJECT("datetime")
loArtic = CREATEOBJECT("odbc_result")
loOper = CREATEOBJECT("odbc_result")
loCliente = CREATEOBJECT("odbc_result")
loCommand = CREATEOBJECT("odbc_command")
lnSqlSrv = INT(VAL(getconfig("SQLSRV")))
lcObserv = Thisform.Contenido.txtObserv.Value
lnPorIIBB = 0.00
lnImpIIBB = 0.00
lnPDtoVta1 = 0.00
lnPDtoVta2 = 0.00
lnPDtoVta3 = 0.00
lnPDtoVta4 = 0.00
lnIDtoVta1 = 0.00
lnIDtoVta2 = 0.00
lnIDtoVta3 = 0.00
lnIDtoVta4 = 0.00
lnImpDesc1 = 0.00
lnImpDesc2 = 0.00
lnImpDesc3 = 0.00
lnImpDesc4 = 0.00
lnPrNeto = 0.00
lnIdCondPago = 0
lnIdSitIVA = 0
lnIdVendedor = 0
lnPrArtic = 0.00
lnPorRec = 0.00
lnImpRec = 0.00
lcUniMed = ""
lcDetOBS = ""
lnPRecItem = 0.00
lnIRecItem = 0.00

&& Inicio la transacción
goConn.BeginTransaction()

&& Asigno los valores de la cabecera

lnIdCliente = Thisform.Contenido.sel_Cliente.ValCpoId
lnIdTransp = Thisform.Contenido.sel_transporte.valcpoid

&& Asigno el idvendedor
lcSql = "SELECT * FROM clientes WHERE idCliente = " + ALLTRIM(STR(lnIdCliente))
loCliente.ActiveConnection = goConn.ActiveConnection
loCliente.Cursor_Name = "cur_cliente"
loCliente.OpenQuery(lcSql)

lnIdVendedor = cur_cliente.idVendedor

loCliente.Close_Query()

lcFecEmis = ALLTRIM(STR(YEAR(DATETIME()))) + "-" + ALLTRIM(STR(MONTH(DATETIME()))) + " - " + ;
	ALLTRIM(STR(DAY(DATETIME())))
	
lcCbte = Thisform.Cbte

IF lcCbte == "COT"
	lcTipoDoc = "X"
	Thisform.tipodoc = lcTipoDoc
ELSE
	&& Aca tengo que agregar el cálculo en caso que sea
	&& comprobante fiscal
	IF lcCbte == "PED"
		lcTipoDoc = "P"
		Thisform.tipodoc = lcTipoDoc
	ELSE
		lcTipoDoc = thisform.calcular_tipodoc()
		Thisform.tipodoc = lcTipoDoc
	ENDIF
ENDIF

IF lcCbte == "PTO" THEN
	lnPtoVta = 9999
	lcTipoDoc = "X"
	Thisform.tipodoc = lcTipoDoc
ELSE
	lnPtoVta = INT(VAL(ALLTRIM(getconfig("PTOVTA"))))
ENDIF

IF !(lcCbte == "COT") .AND. getGlobalCFG("STK_MODULE") THEN
	IF !thisform.validar_stk_en_grabado() THEN
		goConn.Rollback()
		RETURN .F.
	ENDIF
ENDIF

Thisform.ptovta = REPLICATE("0", 4 - LEN(ALLTRIM(STR(lnPtoVta)))) + ALLTRIM(STR(lnPtoVta))

IF Thisform.usar_fiscal THEN
	Thisform.enviar_fiscal()
	lnNroCbte = Thisform.fis_numcbte
	
	IF lnNroCbte = 0 THEN
		MESSAGEBOX("Error en el controlador fiscal, la factura no se grabará", 0+48, Thisform.Caption)
		RETURN .F.
	ENDIF
ELSE
	&& En caso que el sistema no use controlador fiscal, entonces,
	&& el número debe generarlo a partir de la tabla numerador de la
	&& base de datos
	
	lcSql = "select * from numerador where cbte = '" + ALLTRIM(lcCbte) + "' and tipoDoc = '" + ALLTRIM(lcTipoDoc) + "' AND ptoVta = " + ALLTRIM(STR(lnPtoVta))
	loNumerador = CREATEOBJECT("odbc_result")
	loNumerador.ActiveConnection = goConn.ActiveConnection
	loNumerador.Cursor_Name = "cur_num"
	loNumerador.OpenQuery(lcSql)
	SELECT cur_num

	IF RECCOUNT("cur_num") = 0 THEN
		MESSAGEBOX("No se encuentra configurado el numerador del comprobante " + ALLTRIM(lcCbte) + " Punto de Venta: " + ALLTRIM(STR(lnPtoVta)) + " Letra: " + ALLTRIM(lcTipoDoc), 0+48, thisform.Caption)
		loNumerador.close_query()
		RETURN .F.
	ENDIF

	SELECT cur_num
	lnNroCbte = cur_num.numActual + 1
	Thisform.nrocbte = REPLICATE("0", 8 - LEN(ALLTRIM(STR(lnNroCbte)))) + ALLTRIM(STR(lnNroCbte))
	Thisform.idNum = cur_num.idNum
	*Thisform.printerDevice = cur_num.impresora
	*Thisform.cant_copias = cur_num.cantCpia

	loNumerador.close_query()	
	
	&& Actualizo el numerador
	lcSql = "update numerador set numActual = " + ALLTRIM(STR(lnNroCbte)) + ;
		" where cbte = '" + ALLTRIM(lcCbte) + "' and tipoDoc = '" + ALLTRIM(lcTipoDoc) + "' " + ;
		"	and ptoVta = " + ALLTRIM(STR(lnPtoVta))

	loCommand.ActiveConnection = goConn.ActiveConnection
	loCommand.CommandText = lcSql

	IF !loCommand.Execute()
		goConn.Rollback()
		RETURN .F.
	ENDIF	
ENDIF

llAnulado = .F.
lnImpNeto = Thisform.Contenido.txtTotNeto.Value
lnImpFinal = Thisform.Contenido.txtST.Value
lnPorIVA21 = Thisform.Contenido.txtPorIVA21.Value
lnPorIVA105 = Thisform.Contenido.txtPorIVA105.Value
lnImpIVA21 = Thisform.Contenido.txtImpIva21.Value
lnImpIVA105 = Thisform.Contenido.txtImpIva105.Value
lnPorIIBB= Thisform.contenido.txtPorIIBB.Value
lnImpIIBB = thisform.contenido.txtImpIIBB.Value
lnPorDesc1 = thisform.contenido.txtDesc1.Value
lnPorDesc2 = thisform.contenido.txtdesc2.Value
lnPorDesc3 = Thisform.contenido.txtdesc3.Value
lnPorDesc4 = Thisform.contenido.txtdesc4.Value
lnPorRec = Thisform.contenido.txtporrec.Value
lnImpRec = Thisform.contenido.txtimprec.Value  

SELECT cur_detalle
GO TOP 
DO WHILE !EOF()
	lnImpDesc1 = lnImpDesc1 + ROUND(cur_detalle.iDtoCli1 * cur_detalle.cantidad, 2)
	lnImpDesc2 = lnImpDesc2 + ROUND(cur_detalle.iDtoCli2 * cur_detalle.cantidad, 2)
	lnImpDesc3 = lnImpDesc3 + ROUND(cur_detalle.iDtoCli3 * cur_detalle.cantidad, 2)
	lnImpDesc4 = lnImpDesc4 + ROUND(cur_detalle.iDtoCli4 * cur_detalle.cantidad, 2)
	
	SELECT cur_detalle
	SKIP 
ENDDO ´

lnTotFact = Thisform.Contenido.txtTotFact.Value
lnIdCondPago = clientes.idCondPago
lnIdSitIVA = clientes.idSitIVA

lnIdVentasC = goConn.GetNextID("ventascab", "idVentasC")

&& Calculo la fecha de vencimiento correspondiente a la factura
IF ALLTRIM(Thisform.cbte) == "FC" THEN 
	IF thisform.cp_cntdias <> 0 THEN
		ldFecVto = DATE() + thisform.cp_cntdias
	ELSE
		ldFecVto = DATE()		
	ENDIF 
ELSE
	ldFecVto = DATE()
ENDIF

IF ALLTRIM(Thisform.cbte) == "FC" THEN
	lnSaldo = Thisform.Contenido.txtTotFact.Value
ELSE
	lnSaldo = 0
ENDIF
	
lcSql = "INSERT INTO ventascab ( "
lcSql = lcSql + "idVentasC, idCliente, razSoc, idTipoDoc, nroDoc, idTransp, fecEmision, cbte, tipoDoc, ptoVta, numCbte, anulado, idCondPago, idSitIVA, idVendedor,"
lcSql = lcSql + "impNeto, impFinal, porIVA21, impIVA21, porIVA105, impIVA105, porDesc1, "
lcSql = lcSql + "porDesc2, porDesc3, porDesc4, impDesc1, impDesc2, impDesc3, impDesc4, totFact, Saldo, usuAlta, fecAlta, idHostAlta, observ, porIIBB, impIIBB, fecVto, porRec, impRec) VALUES ("
lcSql = lcSql + ALLTRIM(STR(lnIdVentasC)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnIdCliente)) + ", "
lcSql = lcSql + "'" + STRTRAN(ALLTRIM(Thisform.contenido.sel_Cliente.txtDescripcion.Value), "'", "''") + "', "
lcSql = lcSql + ALLTRIM(STR(Thisform.cli_idTipoDoc)) + ", "
lcSql = lcSql + "'" + ALLTRIM(Thisform.contenido.txtCuit.Value) + "', "
lcSql = lcSql + ALLTRIM(STR(lnIdTransp)) + ", "
lcSql = lcSql + oDT.getDateTime() + ", "
lcSql = lcSql + "'" + ALLTRIM(lcCbte) + "', "
lcSql = lcSql + "'" + ALLTRIM(lcTipoDoc) + "', "
lcSql = lcSql + ALLTRIM(STR(lnPtoVta)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnNroCbte)) + ", "
lcSql = lcSql + IIF(lnSqlSrv = 0, "false", "0") + ", "
lcSql = lcSql + ALLTRIM(STR(lnIdCondPago)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnIdSitIVA)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnIdVendedor)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpNeto, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpFinal, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnPorIVA21, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpIVA21, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnPorIVA105, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpIVA105, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnPorDesc1, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnPorDesc2, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnPorDesc3, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnPorDesc4, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpDesc1, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpDesc2, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpDesc3, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpDesc4, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnTotFact, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnSaldo, 10, 2)) + ", "
lcSql = lcSql + "'" + ALLTRIM(gcCodUsu) + "', " 
lcSql = lcSql + oDT.getDateTime() + ", "
lcSql = lcSql + "'" + SYS(0) + "', '" + ALLTRIM(lcObserv) + "', "
lcSql = lcSql + ALLTRIM(STR(lnPorIIBB, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpIIBB, 10, 2)) + ", "
lcSql = lcSql + IIF(INT(VAL(getconfig("SQLSRV"))) = 1, oDT.getDateTime() + " + " + ALLTRIM(STR(thisform.cp_cntdias)), oDT.toMySql(ldFecVto)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnPorRec, 10, 2)) + ", "
lcSql = lcSql + ALLTRIM(STR(lnImpRec, 10, 2)) + ")"

loCommand.ActiveConnection = goConn.ActiveConnection
loCommand.CommandText = lcSql

IF !loCommand.Execute()
	goConn.Rollback()
	RETURN .F.
ENDIF

&& Grabo el detalle del comprobante

SELECT cur_Detalle
IF RECCOUNT() > 0
	GO TOP
ENDIF

lnIdVentasD = 0

DO WHILE !EOF()
	lnIdVentasD = lnIdVentasD + 1
	
	lnIdArticulo = cur_Detalle.idArticulo
	lnCantidad = cur_Detalle.cantidad
	lnAlicIVA = cur_Detalle.alicIVA
	lnPrVenta = cur_Detalle.PrVta
	lnImpIVA = cur_Detalle.impIVA
	lnPrNeto = cur_Detalle.impNeto
	lnTotNeto = cur_Detalle.totNeto
	lnSubTotal = cur_Detalle.subTotal
	lnPDtoVta1 = cur_Detalle.pDtoVta1
	lnPDtoVta2 = cur_Detalle.pDtoVta2
	lnPDtoVta3 = cur_Detalle.pDtoVta3
	lnPDtoVta4 = cur_Detalle.pDtoVta4
	lnIDtoVta1 = cur_Detalle.iDtoVta1
	lnIDtoVta2 = cur_Detalle.iDtoVta2
	lnIDtoVta3 = cur_Detalle.iDtoVta3
	lnIDtoVta4 = cur_Detalle.iDtoVta4
	
	lnPorDesc1 = cur_Detalle.pDtoCli1
	lnPorDesc2 = cur_Detalle.pDtoCli2
	lnPorDesc3 = cur_Detalle.pDtoCli3
	lnPorDesc4 = cur_Detalle.pDtoCli4
	lnImpDesc1 = cur_Detalle.iDtoCli1
	lnImpDesc2 = cur_Detalle.iDtoCli2
	lnImpDesc3 = cur_Detalle.iDtoCli3
	lnImpDesc4 = cur_Detalle.iDtoCli4
	
	lnPRecItem = cur_Detalle.pRecItem
	lnIRecItem = cur_Detalle.iRecItem
	
	lnPrArtic = cur_Detalle.prArtic
	lnPorRec = cur_Detalle.pRecVta
	lnImpRec = cur_Detalle.iRecVta
	lnUniDesp = cur_Detalle.uniDesp
	lnCantPack = cur_Detalle.cantPack
	lcUniMed = cur_Detalle.uniMed
	lcDetOBS = cur_Detalle.detobs
	
	lcSql = "SELECT * FROM articulos WHERE idArticulo = " + ALLTRIM(STR(lnIdArticulo))
	loArtic.ActiveConnection = goConn.ActiveConnection
	loArtic.Cursor_Name = "cur_Artic"
	loArtic.OpenQuery(lcSql)
	
	SELECT cur_Artic
	lnCostoRep = cur_Artic.costoRep
	
	loArtic.close_query()

	lcSql = "INSERT INTO ventasdet ( "
	lcSql = lcSql + "idVentasD, "
	lcSql = lcSql + "idVentasC, "
	lcSql = lcSql + "idArticulo, "
	lcSql = lcSql + "descripcio, "
	lcSql = lcSql + "nroPart, "
	lcSql = lcSql + "Cantidad, "

	IF ALLTRIM(lcCbte) == "PED" THEN
		lcSql = lcSql + "cant_pri1, "
	ENDIF	
	
	lcSql = lcSql + "costoRep, "
	lcSql = lcSql + "prVenta, "
	lcSql = lcSql + "alicIVA, "
	lcSql = lcSql + "impIVA, "
	lcSql = lcSql + "subTotal, "
	lcSql = lcSql + "porDesc1, "
	lcSql = lcSql + "porDesc2, "
	lcSql = lcSql + "porDesc3, "
	lcSql = lcSql + "porDesc4, "
	lcSql = lcSql + "impDesc1, "
	lcSql = lcSql + "impDesc2, "
	lcSql = lcSql + "impDesc3, "
	lcSql = lcSql + "impDesc4, "
	lcSql = lcSql + "pDtoVta1, "
	lcSql = lcSql + "pDtoVta2, "
	lcSql = lcSql + "pDtoVta3, "
	lcSql = lcSql + "pDtoVta4, "
	lcSql = lcSql + "iDtoVta1, "
	lcSql = lcSql + "iDtoVta2, "
	lcSql = lcSql + "iDtoVta3, "
	lcSql = lcSql + "iDtoVta4, "
	lcSql = lcSql + "pRecItem, "
	lcSql = lcSql + "iRecItem, "
	lcSql = lcSql + "impNeto, "
	lcSql = lcSql + "totNeto, "
	lcSql = lcSql + "prArtic, "
	lcSql = lcSql + "esOferta, "
	lcSql = lcSql + "pRecVta, "
	lcSql = lcSql + "iRecVta, "
	lcSql = lcSql + "uniDesp, "
	lcSql = lcSql + "cantPack, "
	lcSql = lcSql + "observ, "
	lcSql = lcSql + "codUM) VALUES ( "
	lcSql = lcSql + ALLTRIM(STR(lnIdVentasD)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIdVentasC)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIdArticulo)) + ", "
	lcSql = lcSql + "'" + STRTRAN(ALLTRIM(cur_detalle.descripcio), "'", "''") + "', "
	lcSql = lcSql + "'" + ALLTRIM(cur_detalle.nroPart) + "', "
	lcSql = lcSql + ALLTRIM(STR(lnCantidad, 10, 2)) + ", "
	
	IF ALLTRIM(lcCbte) == "PED" THEN
		lcSql = lcSql + ALLTRIM(STR(lnCantidad, 10, 2)) + ", "
	ENDIF	
	
	lcSql = lcSql + ALLTRIM(STR(lnCostoRep, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPrVenta, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnAlicIVA, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnImpIVA, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnSubTotal, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPorDesc1, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPorDesc2, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPorDesc3, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPorDesc4, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnImpDesc1, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnImpDesc2, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnImpDesc3, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnImpDesc4, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPDtoVta1, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPDtoVta2, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPDtoVta3, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPDtoVta4, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIDtoVta1, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIDtoVta2, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIDtoVta3, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIDtoVta4, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPRecItem, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIRecItem, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPrNeto, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnTotNeto, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPrArtic, 10, 2)) + ", "
	lcSql = lcSql + IIF(cur_detalle.esOferta, "1", "0") + ", "
	lcSql = lcSql + ALLTRIM(STR(lnPorRec, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnImpRec, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnUniDesp, 10, 2)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnCantPack, 10, 2)) + ", "
	lcSql = lcSql + "'" + ALLTRIM(lcDetOBS) + "', "
	lcSql = lcSql + "'" + ALLTRIM(lcUniMed) + "')"
	
	*******************************************************************************************
	
	loCommand.ActiveConnection = goConn.ActiveConnection
	loCommand.CommandText = lcSql
	
	IF !loCommand.Execute()
		goConn.Rollback()
		RETURN .F.
	ENDIF
	
	&& Si es nota de crédito entonces, actualizo la cantidad de NC en los
	&& items de la factura.
	&& Actualizar este dato tiene como objetivo de que si se hace más una NC
	&& que no se pueda hacer dos veces sobre la misma cantidad de un producto
	&& sino que por el resto.
	
	IF ALLTRIM(Thisform.cbte) == "NC" THEN
		lcSql = "UPDATE ventasdet SET cantNC = cantNC + " + ALLTRIM(STR(lnCantidad)) + " "
		lcSql = lcSql + "WHERE idVentasC = " + ALLTRIM(STR(Thisform.idorigen)) + " "
		lcSql = lcSql + " AND idArticulo = " + ALLTRIM(STR(cur_Detalle.idArticulo))
		
		loCommand.ActiveConnection = goConn.ActiveConnection
		loCommand.CommandText = lcSql
		
		IF !loCommand.Execute() THEN
			goConn.Rollback()
			RETURN .F.
		ENDIF
	ENDIF
	
	SELECT cur_Detalle
	SKIP
ENDDO

IF ALLTRIM(thisform.cbte) == "FC" THEN
	lnProxID = goConn.GetNextId("cc_cli", "idCC_Cli")
	lnIdCliente = Thisform.contenido.sel_Cliente.valcpoid
	lnIdOper = goConn.GetNextID("cc_cli", "idOper")
	
	&& Inserto el registro correspondiente a la factura en la tabla de cuentas corrientes
	lcSql = "INSERT INTO cc_cli (idCC_Cli, idCliente, idCC_Orig, cbte, nroCbte, tipoDoc, ptoVta, idCondPago, idSitIVA, idVendedor, "
	lcSql = lcSql + "fecEmis, fecVto, impDebe, impHaber, idOper, idVentasC, usuAlta, fecAlta, idHostAlta) VALUES ( "
	lcSql = lcSql + ALLTRIM(STR(lnProxID)) + ", " + ALLTRIM(STR(lnIdCliente)) + ", null, '" + ALLTRIM(lcCbte) + "', "
	lcSql = lcSql + ALLTRIM(STR(lnNroCbte)) + ", '" + ALLTRIM(lcTipoDoc) + "', " + ALLTRIM(STR(lnPtoVta)) + ", " + ALLTRIM(STR(lnIdCondPago)) + ", "
	lcSql = lcSql + ALLTRIM(STR(lnIdSitIVA)) + ", " + ALLTRIM(STR(lnIdVendedor)) + ", " + oDT.getDateTime() + ", "
	lcSql = lcsql + IIF(INT(VAL(getconfig("SQLSRV"))) = 1, oDT.getDateTime() + " + " + ALLTRIM(STR(thisform.cp_cntdias)), oDT.toMySql(ldFecVto)) + ", " + ALLTRIM(STR(lnTotFact, 10, 2)) + ", 0, " + ALLTRIM(STR(lnIdOper)) + ", " + ALLTRIM(STR(lnIdVentasC)) + ", "
	lcSql = lcSql + "'" + ALLTRIM(gcCodUsu) + "', " + oDT.getDateTime() + ", '" + ALLTRIM(SYS(0)) + "')"
	
	loCommand.ActiveConnection = goConn.ActiveConnection
	loCommand.CommandText = lcSql
	
	IF !loCommand.Execute()
		goConn.Rollback()
		RETURN .F.
	ENDIF
ELSE
	IF ALLTRIM(Thisform.cbte) == "NC" THEN
		&& Verifico si tiene numero de operación asignado
		lcSql = "SELECT idCC_Cli, idOper FROM cc_cli WHERE idVentasC = " + ALLTRIM(STR(Thisform.idorigen))
		loOper.ActiveConnection = goConn.ActiveConnection
		loOper.Cursor_Name = "cur_Oper"
		loOper.OpenQuery(lcSql)
		
		lnIdCCOrig = cur_Oper.idCC_Cli
		lnIdOper = cur_Oper.idOper
		
		loOper.Close_Query()
		
		&& Tengo que calcular el Id de Operación para vincular ambos comprobantes
		IF lnIdOper = 0 THEN
			lcSql = "SELECT MAX(cc_cli.idOper) AS maxIdOper FROM cc_cli"
			loOper.ActiveConnection = goConn.ActiveConnection
			loOper.Cursor_Name = "cur_Oper"
			loOper.OpenQuery(lcSql)
			
			lnIdOper = cur_Oper.maxIdOper + 1
			
			loOper.Close_Query()
		
			&& Actualizo el comprobante de origen con el Id de Operación calculado
			lcSql = "UPDATE cc_cli SET idOper = " + ALLTRIM(STR(lnIdOper)) + " WHERE idVentasC = " + ALLTRIM(STR(Thisform.idorigen))
			loCommand.ActiveConnection = goConn.ActiveConnection
			loCommand.CommandText = lcSql
		
			IF !loCommand.Execute()
				goConn.Rollback()
				RETURN .F.
			ENDIF	
		ENDIF
		
		&& Genero el registro de la nota de crédito en las cuentas corrientes del cliente
		
		lnProxID = goConn.GetNextId("cc_cli", "idCC_Cli")
		lnIdCliente = Thisform.contenido.sel_Cliente.valcpoid	
		
		lcSql = "INSERT INTO cc_cli (idCC_Cli, idCliente, idCC_Orig, cbte, nroCbte, tipoDoc, ptoVta, idCondPago, idSitIVA, idVendedor, "
		lcSql = lcSql + "fecEmis, fecvto, impDebe, impHaber, idOper, idVentasC, usuAlta, fecAlta, idHostAlta) VALUES ( "
		lcSql = lcSql + ALLTRIM(STR(lnProxID)) + ", " + ALLTRIM(STR(lnIdCliente)) + ", " + ALLTRIM(STR(lnIdCCOrig)) + ", '" + ALLTRIM(lcCbte) + "', "
		lcSql = lcSql + ALLTRIM(STR(lnNroCbte)) + ", '" + ALLTRIM(lcTipoDoc) + "', " + ALLTRIM(STR(lnPtoVta)) + ", " + ALLTRIM(STR(lnIdCondPago)) + ", "
		lcSql = lcSql + ALLTRIM(STR(lnIdSitIVA)) + ", " + ALLTRIM(STR(lnIdVendedor)) + ", " + oDT.getDateTime() + ", "
		lcSql = lcsql + IIF(INT(VAL(getconfig("SQLSRV"))) = 1, oDT.getDateTime() + " + " + ALLTRIM(STR(thisform.cp_cntdias)), oDT.toMySql(ldFecVto)) + ", 0, " + ALLTRIM(STR(lnTotFact, 10, 2)) + ", " + ALLTRIM(STR(lnIdOper)) + ", " + ALLTRIM(STR(lnIdVentasC)) + ", "
		lcSql = lcSql + "'" + ALLTRIM(gcCodUsu) + "', " + oDT.getDateTime() + ", '" + ALLTRIM(SYS(0)) + "')"
		
		loCommand.ActiveConnection = goConn.ActiveConnection
		loCommand.CommandText = lcSql
		
		IF !loCommand.Execute()
			goConn.Rollback()
			RETURN .F.
		ENDIF
		
		lnSaldo = Thisform.saldo_fc - thisform.Contenido.txtTotFact.Value
		
		&& Actualizo el Saldo en la factura para validar que no se pueda
		&& aplicar un importe superior al saldo.
		lcSql = "UPDATE ventascab SET saldo = " + ALLTRIM(STR(lnSaldo, 10, 2)) + ", "
		lcSql = lcSql + "usuModi = '" + ALLTRIM(gcCodUsu) + "', "
		lcSql = lcSql + "fecModi = " + oDT.getDateTime() + ", "
		lcSql = lcSql + "idHostModi = '" + ALLTRIM(SYS(0)) + "' " 				
		lcSql = lcSql + "WHERE idVentasC = " + ALLTRIM(STR(Thisform.idorigen))
		
		loCommand.ActiveConnection = goConn.ActiveConnection
		loCommand.CommandText = lcSql
		
		IF !loCommand.Execute()
			goConn.Rollback()
			RETURN .F.
		ENDIF	
	ENDIF
ENDIF

&& Ahora tengo que generar la relación entre el comprobante de origen con el comprobante
&& de destino
IF (ALLTRIM(Thisform.cbte) == "NC") .OR. (ALLTRIM(Thisform.Cbte) == "FC") .OR. (ALLTRIM(Thisform.cbte) == "PTO") THEN
	SELECT cur_cbtes
	IF RECCOUNT("cur_cbtes") > 0 THEN
		GO TOP
	ENDIF
	
	DO WHILE !EOF("cur_cbtes")
		IF cur_cbtes.sel THEN
			IF ALLTRIM(thisform.cbte) == "PTO" THEN
				lnProxID = loConDMO.GetNextId("ventasrel", "idVtaRel")
			ELSE
				lnProxID = goConn.GetNextId("ventasrel", "idVtaRel")
			ENDIF
			
			lcSql = "INSERT INTO ventasrel (idVtaRel, idVtaCO, idVtaCD) VALUES ("
			lcSql = lcSql + ALLTRIM(STR(lnProxID)) + ", " + ALLTRIM(STR(cur_cbtes.idVentasC)) + ", " + ALLTRIM(STR(lnIdVentasC)) + ")"
			
			loCommand.CommandText = lcSql

			IF ALLTRIM(lcCbte) == "PTO" 
				loCommand.ActiveConnection = loConDMO.ActiveConnection
				IF !loCommand.Execute()
					thisform.desbloq_numerador()
					loConDMO.Rollback()
					RETURN .F.
				ENDIF	
			ELSE
				loCommand.ActiveConnection = goConn.ActiveConnection
				IF !loCommand.Execute()
					thisform.desbloq_numerador()
					goConn.Rollback()
					RETURN .F.
				ENDIF
			ENDIF
		ENDIF
		
		SELECT cur_cbtes
		SKIP
	ENDDO
ENDIF

IF ALLTRIM(Thisform.Cbte) == "PED" THEN
	IF thisform.pedido_automatica THEN
		IF getglobalcfg("TRANS_PED") THEN
			Thisform.marcar_procesado()
		ENDIF
	ENDIF
ENDIF

************************************************************************************************
* Agrego que se genere el movimiento de stock al grabar la operación
* siempre y cuando el sistema se encuentre configurado para soportar esta funcionalidad
************************************************************************************************
IF getGlobalCFG("STK_MODULE") .AND. (ALLTRIM(THisform.Cbte) <> "COT" .OR. ALLTRIM(THisform.Cbte) <> "NC") THEN
	Thisform.mov_stock.idcliente = thisform.contenido.sel_Cliente.valcpoid
	Thisform.mov_stock.idprov = 0
	Thisform.mov_stock.tipodoc = Thisform.tipodoc
	Thisform.mov_stock.cbte = lcCbte
	Thisform.mov_stock.numcbte =  REPLICATE("0", 4 - LEN(ALLTRIM(STR(lnPtoVta)))) + ALLTRIM(STR(lnPtoVta)) + "-" + REPLICATE("0", 8 - LEN(ALLTRIM(STR(lnNroCbte)))) + ALLTRIM(STR(lnNroCbte))

	IF !(ALLTRIM(Thisform.cbte) == "COT") THEN
		IF !(ALLTRIM(Thisform.cbte) == "PED") THEN
			IF !Thisform.mov_stock.grabar2() THEN
				MESSAGEBOX(Thisform.mov_stock.ErrorMessage, 0+48, Thisform.Caption)
				goConn.Rollback()
				RETURN .F.
			ENDIF
		ENDIF	
	ENDIF
ENDIF

goConn.Commit()

MESSAGEBOX("El comprobante: " + ALLTRIM(lcCbte) + " " + ALLTRIM(lcTipoDoc) + " " + REPLICATE("0", 4 - LEN(ALLTRIM(STR(lnPtoVta)))) + ALLTRIM(STR(lnPtoVta)) + "-" + ;
	REPLICATE("0", 8 - LEN(ALLTRIM(STR(lnNroCbte)))) + ALLTRIM(STR(lnNroCbte)) + " se ha generado exitosamente...", 0+64, Thisform.Caption)

RETURN .T.
ENDPROC
PROCEDURE agregar_item
LOCAL lnPDtoCli1, lnPDtoCli2, lnPDtoCli3, lnPDtoCli4
LOCAL lnIDtoCli1, lnIDtoCli2, lnIDtoCli3, lnIDtoCli4
LOCAL lnPDtoVta1, lnPDtoVta2, lnPDtoVta3, lnPDtoVta4
LOCAL lnIDtoVta1, lnIDtoVta2, lnIDtoVta3, lnIDtoVta4
LOCAL lnSTNeto, lnSubTotal, lnPrNeto1, lnPrNeto2, lnImpNeto
LOCAL loResult, lcSql, lnPrecio, lnAlicIva
LOCAL lnPRecVta, lnIRecVta

lnPDtoCli1 = Thisform.contenido.txtDesc1.Value
lnPDtoCli2 = Thisform.contenido.txtDesc2.Value
lnPDtoCli3 = Thisform.contenido.txtDesc3.Value
lnPDtoCli4 = Thisform.contenido.txtDesc4.Value
lnIDtoCli1 = 0.00
lnIDtoCli2 = 0.00
lnIDtoCli3 = 0.00
lnIDtoCli4 = 0.00
lnPDtoVta1 = 0.00
lnPDtoVta2 = 0.00
lnPDtoVta3 = 0.00
lnPDtoVta4 = 0.00
lnIDtoVta1 = 0.00
lnIDtoVta2 = 0.00
lnIDtoVta3 = 0.00
lnIDtoVta4 = 0.00
lnPrecio = 0.00
lnSTNeto = 0.00
lnSubTotal = 0.00
loResult = CREATEOBJECT("odbc_result")
lcSql = ""
lnPrNeto1 = 0.00
lnPrNeto2 = 0.00
lnAlicIva = 0.00
lnPRecVta = Thisform.contenido.txtporrec.Value 
lnIRecVta = 0.00

IF glVersionBeta THEN
	SELECT cur_Detalle
	IF RECCOUNT() = 5 THEN
		MESSAGEBOX("Usted está utilizando una versión límitada del sistema, si desea comprarlo envíe un mail a ldz.software@gmail.com", 0+64, Thisform.Caption)
		RETURN .F.
	ENDIF
ENDIF

* Valido si el artículo ya se encuentra cargado en el presupuesto

SELECT cur_Deta_View
IF RECCOUNT("cur_Deta_View") > 0 THEN
	GO TOP
ENDIF

DO WHILE !EOF("cur_Deta_View")
	IF (ALLTRIM(Thisform.cbte) != "PED") THEN 
		IF !thisform.asignar_partida(cur_Deta_View.idArticulo, cur_Deta_View.Cantidad) THEN
			MESSAGEBOX("Ha ocurrido un error al intentar asignar partidas", 0+48, thisform.Caption)
			RETURN .F.
		ENDIF
	ENDIF  


	lnIDtoCli1 = cur_Deta_View.iDtoCli1
	lnIDtoCli2 = cur_Deta_View.iDtoCli2
	lnIDtoCli3 = cur_Deta_View.iDtoCli3
	lnIDtoCli4 = cur_Deta_View.iDtoCli4
	lnIDtoVta1 = cur_Deta_View.iDtoVta1
	lnIDtoVta2 = cur_Deta_View.iDtoVta2
	lnIDtoVta3 = cur_Deta_View.iDtoVta3
	lnIDtoVta4 = cur_Deta_View.iDtoVta4

	&& Si cur_DetPart es 0 (Cero)
	SELECT cur_DetPart
	IF RECCOUNT("cur_DetPart") = 0 THEN
		SELECT cur_Detalle
		APPEND BLANK
		REPLACE cur_Detalle.idDetalle WITH RECCOUNT("cur_Detalle") + 1
		REPLACE cur_Detalle.idArticulo WITH cur_Deta_View.idArticulo 			ADDITIVE
		REPLACE cur_Detalle.codArt WITH ALLTRIM(cur_Deta_View.codArt)			ADDITIVE
		REPLACE cur_Detalle.descripcio WITH ALLTRIM(cur_Deta_View.descripcio) 	ADDITIVE
		REPLACE cur_Detalle.nroPart WITH "" 									ADDITIVE
		REPLACE cur_Detalle.cantidad WITH cur_Deta_View.cantidad 				ADDITIVE
		REPLACE cur_Detalle.prVta WITH cur_Deta_View.prVta						ADDITIVE
		REPLACE cur_Detalle.prArtic WITH cur_Deta_View.prArtic					ADDITIVE
		REPLACE cur_Detalle.pDtoVta1 WITH cur_Deta_View.pDtoVta1				ADDITIVE
		REPLACE cur_Detalle.pDtoVta2 WITH cur_Deta_View.pDtoVta2				ADDITIVE
		REPLACE cur_Detalle.pDtoVta3 WITH cur_Deta_View.pDtoVta3				ADDITIVE
		REPLACE cur_Detalle.pDtoVta4 WITH cur_Deta_View.pDtoVta4				ADDITIVE
		REPLACE cur_Detalle.iDtoVta1 WITH cur_Deta_View.iDtoVta1				ADDITIVE
		REPLACE cur_Detalle.iDtoVta2 WITH cur_Deta_View.iDtoVta2				ADDITIVE
		REPLACE cur_Detalle.iDtoVta3 WITH cur_Deta_View.iDtoVta3				ADDITIVE
		REPLACE cur_Detalle.iDtoVta4 WITH cur_Deta_View.iDtoVta4				ADDITIVE
		REPLACE cur_Detalle.impNeto WITH cur_Deta_View.impNeto					ADDITIVE
		REPLACE cur_Detalle.impIVA WITH cur_Deta_View.impIVA					ADDITIVE
		REPLACE cur_Detalle.alicIVA WITH cur_Deta_View.alicIVA					ADDITIVE
		REPLACE cur_Detalle.totNeto WITH cur_Deta_View.totNeto					ADDITIVE
		REPLACE cur_Detalle.subTotal WITH cur_Deta_View.subTotal				ADDITIVE
		REPLACE cur_Detalle.pDtoCli1 WITH cur_Deta_View.pDtoCli1 				ADDITIVE
		REPLACE cur_Detalle.pDtoCli2 WITH cur_Deta_View.pDtoCli2 				ADDITIVE
		REPLACE cur_Detalle.pDtoCli3 WITH cur_Deta_View.pDtoCli3 				ADDITIVE
		REPLACE cur_Detalle.pDtoCli4 WITH cur_Deta_View.pDtoCli4 				ADDITIVE
		REPLACE cur_Detalle.iDtoCli1 WITH cur_Deta_View.iDtoCli1 				ADDITIVE
		REPLACE cur_Detalle.iDtoCli2 WITH cur_Deta_View.iDtoCli2 				ADDITIVE
		REPLACE cur_Detalle.iDtoCli3 WITH cur_Deta_View.iDtoCli3 				ADDITIVE
		REPLACE cur_Detalle.iDtoCli4 WITH cur_Deta_View.iDtoCli4 				ADDITIVE
		REPLACE cur_Detalle.pRecItem WITH cur_Deta_View.pRecItem				ADDITIVE
		REPLACE cur_Detalle.iRecItem WITH cur_Deta_View.iRecItem				ADDITIVE
		REPLACE cur_Detalle.esOferta WITH cur_Deta_View.esOferta 				ADDITIVE
		REPLACE cur_Detalle.pRecVta WITH cur_Deta_View.pRecVta					ADDITIVE 
		REPLACE cur_Detalle.iRecVta WITH cur_Deta_View.iRecVta					ADDITIVE 
		REPLACE cur_Detalle.uniDesp WITH cur_Deta_View.uniDesp					ADDITIVE
		REPLACE cur_Detalle.cantPack WITH cur_Deta_View.cantPack				ADDITIVE
		REPLACE cur_Detalle.uniMed WITH cur_Deta_View.uniMed					ADDITIVE
		REPLACE cur_Detalle.detobs WITH cur_Deta_View.detobs 					ADDITIVE
		
		&& Si está habilitado el módulo de stock, entonces, lo doy de alta.
		IF getGlobalCFG("STK_MODULE") THEN
			IF !(RIGHT(ALLTRIM(cur_Deta_View.codArt), 3) == "ARX") THEN
				Thisform.mov_stock.agregar_articulo(cur_Deta_View.idArticulo, cur_Deta_View.Cantidad, "")
			ENDIF
		ENDIF
	ELSE
		*************************************************************************************************
		* Paso por aca en el caso de que el artículo lleve número de partida
		*************************************************************************************************
		lnPDtoVta1 = cur_Deta_View.pDtoVta1
		lnPDtoVta2 = cur_Deta_View.pDtoVta2
		lnPDtoVta3 = cur_Deta_View.pDtoVta3
		lnPDtoVta4 = cur_Deta_View.pDtoVta4
		
		SELECT cur_DetPart
		GO TOP

		DO WHILE !EOF("cur_DetPart")
			SELECT cur_Detalle
			APPEND BLANK
			REPLACE cur_Detalle.idDetalle WITH RECCOUNT("cur_Detalle") + 1
			REPLACE cur_Detalle.idArticulo WITH cur_Deta_View.idArticulo 	ADDITIVE
			REPLACE cur_Detalle.codArt WITH cur_Deta_View.codArt	ADDITIVE
			REPLACE cur_Detalle.descripcio WITH IIF(ALLTRIM(cur_DetPart.nroPart) == "", ALLTRIM(cur_Deta_View.Descripcio), ALLTRIM(SUBSTR(cur_Deta_View.Descripcio, 1, 20)) + " (" + ALLTRIM(cur_DetPart.nroPart) + ")") ADDITIVE
			REPLACE cur_Detalle.nroPart WITH cur_DetPart.nroPart ADDITIVE
			REPLACE cur_Detalle.cantidad WITH cur_DetPart.cantidad ADDITIVE
			REPLACE cur_Detalle.prVta WITH cur_Deta_View.prVta ADDITIVE
			REPLACE cur_Detalle.prArtic WITH cur_Deta_View.prArtic ADDITIVE			

			&& Calculo el descuento del cliente en el ítem para grabar
			
			lnIDtoCli1 = ROUND(cur_Deta_View.prArtic * (lnPDtoCli1 / 100), 2)
			lnIDtoCli2 = ROUND((cur_Deta_View.prArtic - lnIDtoCli1) * (lnPDtoCli2 / 100), 2)
			lnIDtoCli3 = ROUND((cur_Deta_View.prArtic - lnIDtoCli1 - lnIDtoCli2) * (lnPDtoCli3 / 100), 2)
			lnIDtoCli4 = ROUND((cur_Deta_View.prArtic - lnIDtoCli1 - lnIDtoCli2 - lnIDtoCli3) * (lnPDtoCli4 / 100), 2)
			
			lnPrNeto1 = cur_Deta_View.prArtic - lnIDtoCli1 - lnIDtoCli2 - lnIDtoCli3 - lnIDtoCli4
 			
			&& Calculo el descuento por item
			
			lnIDtoVta1 = ROUND(lnPrNeto1 * (lnPDtoVta1 / 100), 2)
			lnIDtoVta2 = ROUND((lnPrNeto1 - lnIDtoVta1) * (lnPDtoVta2 / 100), 2)
			lnIDtoVta3 = ROUND((lnPrNeto1 - lnIDtoVta1 - lnIDtoVta2) * (lnPDtoVta3 / 100), 2)
			lnIDtoVta4 = ROUND((lnPrNeto1 - lnIDtoVta1 - lnIDtoVta2 - lnIDtoVta3) * (lnPDtoVta4 / 100), 2)
			
			lnImpNeto = lnPrNeto1 - lnIDtoVta1 - lnIDtoVta2 - lnIDtoVta3 - lnIDtoVta4
			
			&& Hago el recargo
			lnIRecVta = ROUND(lnImpNeto * (lnPRecVta / 100), 2)

			lnImpNeto = lnImpNeto + lnIRecVta	
			
			lnSTNeto = ROUND(lnImpNeto * cur_DetPart.Cantidad, 2)

			REPLACE cur_Detalle.pDtoVta1 WITH lnPDtoVta1 ADDITIVE
			REPLACE cur_Detalle.pDtoVta2 WITH lnPDtoVta2 ADDITIVE
			REPLACE cur_Detalle.pDtoVta3 WITH lnPDtoVta3 ADDITIVE
			REPLACE cur_Detalle.pDtoVta4 WITH lnPDtoVta4 ADDITIVE
			REPLACE cur_Detalle.iDtoVta1 WITH lnIDtoVta1 ADDITIVE
			REPLACE cur_Detalle.iDtoVta2 WITH lnIDtoVta2 ADDITIVE
			REPLACE cur_Detalle.iDtoVta3 WITH lnIDtoVta3 ADDITIVE
			REPLACE cur_Detalle.iDtoVta4 WITH lnIDtoVta4 ADDITIVE
			REPLACE cur_Detalle.pRecItem WITH cur_Deta_View.pRecItem ADDITIVE
			REPLACE cur_Detalle.iRecItem WITH cur_Deta_View.iRecItem ADDITIVE
			
			&& Hago el cálculo del IVA
			
			IF (ALLTRIM(Thisform.cbte) == "PTO") THEN
				REPLACE cur_Detalle.impIVA WITH 0 ADDITIVE
				REPLACE cur_Detalle.alicIVA WITH 0 ADDITIVE
			ELSE
				lnAlicIva = cur_Deta_View.alicIVA
				REPLACE cur_Detalle.impIVA WITH ROUND(lnSTNeto  * (lnAlicIva / 100), 2) ADDITIVE
				REPLACE cur_Detalle.alicIVA WITH lnAlicIva ADDITIVE
			ENDIF
			
			REPLACE cur_Detalle.impNeto WITH lnImpNeto ADDITIVE
			REPLACE cur_Detalle.totNeto WITH lnSTNeto ADDITIVE
			REPLACE cur_Detalle.subTotal WITH lnSTNeto + cur_Detalle.impIVA ADDITIVE

			REPLACE cur_Detalle.pDtoCli1 WITH cur_Deta_View.pDtoCli1 ADDITIVE
			REPLACE cur_Detalle.pDtoCli2 WITH cur_Deta_View.pDtoCli2 ADDITIVE
			REPLACE cur_Detalle.pDtoCli3 WITH cur_Deta_View.pDtoCli3 ADDITIVE
			REPLACE cur_Detalle.pDtoCli4 WITH cur_Deta_View.pDtoCli4 ADDITIVE
			REPLACE cur_Detalle.iDtoCli1 WITH cur_Deta_View.iDtoCli1 ADDITIVE
			REPLACE cur_Detalle.iDtoCli2 WITH cur_Deta_View.iDtoCli2 ADDITIVE
			REPLACE cur_Detalle.iDtoCli3 WITH cur_Deta_View.iDtoCli3 ADDITIVE
			REPLACE cur_Detalle.iDtoCli4 WITH cur_Deta_View.iDtoCli4 ADDITIVE
			REPLACE cur_Detalle.esOferta WITH cur_Deta_View.esOferta ADDITIVE
			REPLACE cur_Detalle.pRecVta WITH cur_Deta_View.pRecVta ADDITIVE 
			REPLACE cur_Detalle.iRecVta WITH cur_Deta_View.iRecVta ADDITIVE
			REPLACE cur_Detalle.detobs WITH cur_Deta_View.detobs ADDITIVE

			&& Si está habilitado el módulo de stock, entonces, genero el movimiento.
			IF getGlobalCFG("STK_MODULE") THEN
				IF !(RIGHT(ALLTRIM(cur_Deta_View.codArt), 3) == "ARX") THEN
					Thisform.mov_stock.agregar_articulo(cur_DetPart.idArticulo, cur_DetPart.cantidad, cur_DetPart.nroPart)
				ENDIF
			ENDIF
					
			SELECT cur_DetPart
			SKIP
		ENDDO	
	ENDIF
	
	SELECT cur_Deta_View
	SKIP
ENDDO

RETURN .T.

ENDPROC
PROCEDURE agregar_item_viewer
LOCAL lnPDtoCli1, lnPDtoCli2, lnPDtoCli3, lnPDtoCli4
LOCAL lnIDtoCli1, lnIDtoCli2, lnIDtoCli3, lnIDtoCli4, lnCantAnt
LOCAL loResult, lcSql, lnPrecio, llEsOferta, lnproferta, lnAlicIva
LOCAL lnPrVta

lnPDtoCli1 = Thisform.contenido.txtDesc1.Value
lnPDtoCli2 = Thisform.contenido.txtDesc2.Value
lnPDtoCli3 = Thisform.contenido.txtDesc3.Value
lnPDtoCli4 = Thisform.contenido.txtDesc4.Value
lnIDtoCli1 = 0.00
lnIDtoCli2 = 0.00
lnIDtoCli3 = 0.00
lnIDtoCli4 = 0.00
lnPrecio = 0.00
loResult = CREATEOBJECT("odbc_result")
lcSql = ""
llEsOferta = .F.
lnproferta = 0.00
lnAlicIva = 0.00
lnCantAnt = 0.00

SET FIXED OFF

IF !Thisform.ValidarDetalle()
	RETURN .F.
ENDIF

lcSql = "SELECT * FROM articulos WHERE idArticulo = " + ALLTRIM(STR(Thisform.contenido.sel_Articulo.valcpoid))
loResult.ActiveConnection = goConn.ActiveConnection
loResult.Cursor_Name = "cur_Art"
loResult.OpenQuery(lcSql)

IF RIGHT(ALLTRIM(Thisform.Contenido.sel_Articulo.txtCodigo.Value), 3) == "ARX" THEN
	lnPrecio = Thisform.prarti_x
ELSE	
	IF clientes.mayorista THEN 
		lnPrecio = thisform.get_precio_oferta()
		lnproferta = lnPrecio
		
		IF lnPrecio = 0 THEN
			lnPrecio = cur_Art.prVentaMax
			llEsOferta = .F.
		ELSE
			llEsOferta = .T.
		ENDIF
	ELSE
		lnPrecio = cur_Art.prVentaMin
		llEsOferta = .F.
	ENDIF		
ENDIF

loResult.Close_Query()

IF glVersionBeta THEN
	SELECT cur_Deta_View
	IF RECCOUNT() = 5 THEN
		MESSAGEBOX("Usted está utilizando una versión límitada del sistema, si desea comprarlo envíe un mail a ldz.software@gmail.com", 0+64, Thisform.Caption)
		RETURN .F.
	ENDIF
ENDIF

* Valido si el artículo ya se encuentra cargado en el presupuesto
SELECT cur_Deta_View
IF RECCOUNT() > 0
	GO TOP
ENDIF

SELECT cur_Deta_View
DO WHILE !EOF()
	IF ALLTRIM(cur_Deta_View.codArt) == ALLTRIM(Thisform.contenido.sel_Articulo.txtCodigo.Value) THEN
		IF MESSAGEBOX("El artículo ya se encuentra cargado, ¿Desea acumular la cantidad?",4+32, Thisform.Caption) == 6 THEN
			lnCantAnt = Thisform.contenido.txtcantidad.Value
			Thisform.contenido.txtcantidad.Value = Thisform.contenido.txtcantidad.Value + cur_Deta_View.cantidad
			
			&& Vuelvo a verificar el stock nuevamente al acumular la cantidad 
			IF (ALLTRIM(Thisform.cbte) != "COT") .AND. (ALLTRIM(Thisform.cbte) != "NC") THEN
				&& Valido el stock solo en caso que no sea artículo X
				IF RIGHT(ALLTRIM(Thisform.Contenido.sel_Articulo.txtCodigo.Value), 3) != "ARX" THEN
					IF getGlobalCFG("STK_MODULE") THEN
						IF Thisform.mov_stock.get_exist_byart(Thisform.Contenido.sel_Articulo.valcpoid) <= 0 THEN
							Thisform.Contenido.sel_Articulo.txtCodigo.SetFocus()
							
							MESSAGEBOX("No hay stock disponible", 0+48, Thisform.Caption)				
							thisform.contenido.txtCantidad.Value = lnCantAnt
							thisform.contenido.txtCantidad.SetFocus()
							RETURN .F.
						ENDIF
						
						&& Valido si está o no cubierto al 100%
						IF Thisform.Contenido.txtCantidad.Value > Thisform.Contenido.txtExistencia.Value THEN
							MESSAGEBOX("No hay stock suficiente para cubrir la cantidad ingresada", 0+48, Thisform.Caption)
							thisform.contenido.txtCantidad.Value = lnCantAnt
							thisform.contenido.txtCantidad.SetFocus()
							RETURN .F.
						ENDIF
					ENDIF
				ENDIF
			ENDIF			
			
			Thisform.calc_item_desc()
			
			SELECT cur_Deta_View
			DELETE
		ELSE 
			Thisform.contenido.sel_Articulo.txtCodigo.SetFocus()
			RETURN .F.
		ENDIF 
	ENDIF

	SELECT cur_Deta_View
	SKIP
ENDDO

SELECT cur_Deta_View
APPEND BLANK
REPLACE cur_Deta_View.idDetalle WITH RECCOUNT("cur_Deta_View")
REPLACE cur_Deta_View.idArticulo WITH Thisform.contenido.sel_Articulo.valcpoid ADDITIVE
REPLACE cur_Deta_View.codArt WITH Thisform.contenido.sel_Articulo.txtCodigo.Value ADDITIVE
REPLACE cur_Deta_View.descripcio WITH Thisform.contenido.sel_Articulo.txtDescripcion.Value ADDITIVE
REPLACE cur_Deta_View.cantidad WITH Thisform.contenido.txtCantidad.Value ADDITIVE

*******************************************************************************************************************************
* Verifico el tipo de cliente que es para saber desde donde tomar el precio
*******************************************************************************************************************************
IF RIGHT(ALLTRIM(Thisform.Contenido.sel_Articulo.txtCodigo.Value), 3) == "ARX" THEN
	&& Si es artículo X, siempre cargo el contenido de lo que el usuario haya ingresado
	REPLACE cur_Deta_View.prVta WITH Thisform.contenido.txtPrMinorista.Value ADDITIVE
	REPLACE cur_Deta_View.prArtic WITH Thisform.prarti_x ADDITIVE
ELSE
	IF clientes.mayorista THEN
		REPLACE cur_Deta_View.prVta WITH Thisform.contenido.txtPrMay.Value ADDITIVE
		
		IF lnproferta = 0 THEN
			REPLACE cur_Deta_View.prArtic WITH thisform.pr_mayorista ADDITIVE
		ELSE
			REPLACE cur_Deta_View.prArtic WITH thisform.pr_oferta ADDITIVE
		ENDIF
	ELSE
		REPLACE cur_Deta_View.prVta WITH Thisform.contenido.txtPrMinorista.Value ADDITIVE
		REPLACE cur_Deta_View.prArtic WITH Thisform.pr_minorista ADDITIVE
	ENDIF
	
	* Levanto el stock actual solo en caso que no sea ARX
	REPLACE cur_Deta_View.stkDisp  WITH Thisform.mov_stock.get_exist_byart(Thisform.contenido.sel_Articulo.valcpoid) ADDITIVE
ENDIF

* Agrego el recargo por item
REPLACE cur_Deta_View.pRecItem WITH Thisform.contenido.txtPorRecItem.Value ADDITIVE
REPLACE cur_Deta_View.iRecItem WITH cur_Deta_View.prArtic * (cur_Deta_View.pRecItem / 100) ADDITIVE
REPLACE cur_Deta_View.prArtic WITH cur_Deta_View.prArtic + cur_Deta_View.iRecItem ADDITIVE

REPLACE cur_Deta_View.pDtoVta1 WITH Thisform.contenido.txtPorDesc1.Value
REPLACE cur_Deta_View.pDtoVta2 WITH Thisform.contenido.txtPorDesc2.Value
REPLACE cur_Deta_View.pDtoVta3 WITH Thisform.contenido.txtPorDesc3.Value
REPLACE cur_Deta_View.pDtoVta4 WITH Thisform.contenido.txtPorDesc4.Value
REPLACE cur_Deta_View.iDtoVta1 WITH Thisform.contenido.txtImpDescItem1.Value
REPLACE cur_Deta_View.iDtoVta2 WITH Thisform.contenido.txtImpDescItem2.Value 
REPLACE cur_Deta_View.iDtoVta3 WITH Thisform.contenido.txtImpDescItem3.Value
REPLACE cur_Deta_View.iDtoVta4 WITH Thisform.contenido.txtImpDescItem4.Value
REPLACE cur_Deta_View.impNeto WITH Thisform.contenido.txtPrNeto.Value

*******************************************************************************************************************************
* Hago el cálculo del IVA
*******************************************************************************************************************************
IF (ALLTRIM(Thisform.cbte) == "PTO") THEN
	REPLACE cur_Deta_View.impIVA WITH 0 ADDITIVE
	REPLACE cur_Deta_View.alicIVA WITH 0 ADDITIVE
ELSE
	lnAlicIva = Thisform.contenido.txtAlicIVA.Value
	REPLACE cur_Deta_View.impIVA WITH Thisform.contenido.txtImpIVA.Value ADDITIVE
	REPLACE cur_Deta_View.alicIVA WITH lnAlicIva ADDITIVE
ENDIF

REPLACE cur_Deta_View.totNeto WITH Thisform.contenido.txtSTNeto.Value ADDITIVE
REPLACE cur_Deta_View.subTotal WITH Thisform.contenido.txtSubTotal.Value ADDITIVE

*******************************************************************************************************************************
* Calculo el descuento del cliente en el ítem para grabar
*******************************************************************************************************************************
lnIDtoCli1 = ROUND(lnPrecio * (lnPDtoCli1 / 100), 2)
lnIDtoCli2 = ROUND((lnPrecio - lnIDtoCli1) * (lnPDtoCli2 / 100), 2)
lnIDtoCli3 = ROUND((lnPrecio - lnIDtoCli1 - lnIDtoCli2) * (lnPDtoCli3 / 100), 2)
lnIDtoCli4 = ROUND((lnPrecio - lnIDtoCli1 - lnIDtoCli2 - lnIDtoCli3) * (lnPDtoCli4 / 100), 2)

REPLACE cur_Deta_View.pDtoCli1 WITH lnPDtoCli1 ADDITIVE
REPLACE cur_Deta_View.pDtoCli2 WITH lnPDtoCli2 ADDITIVE
REPLACE cur_Deta_View.pDtoCli3 WITH lnPDtoCli3 ADDITIVE
REPLACE cur_Deta_View.pDtoCli4 WITH lnPDtoCli4 ADDITIVE
REPLACE cur_Deta_View.iDtoCli1 WITH lnIDtoCli1 ADDITIVE
REPLACE cur_Deta_View.iDtoCli2 WITH lnIDtoCli2 ADDITIVE
REPLACE cur_Deta_View.iDtoCli3 WITH lnIDtoCli3 ADDITIVE
REPLACE cur_Deta_View.iDtoCli4 WITH lnIDtoCli4 ADDITIVE
REPLACE cur_Deta_View.esOferta WITH llEsOferta ADDITIVE

*******************************************************************************************************************************
* Agrego el recargo del item
*******************************************************************************************************************************
REPLACE cur_Deta_View.pRecVta WITH Thisform.contenido.txtporrec.Value ADDITIVE
REPLACE cur_Deta_View.iRecVta WITH Thisform.contenido.txtrecitem.Value ADDITIVE
REPLACE cur_Deta_View.uniDesp WITH VAL(Thisform.contenido.cboUnidVta.Value) ADDITIVE
REPLACE cur_Deta_View.cantPack WITH Thisform.contenido.txtCantPack.Value ADDITIVE
REPLACE cur_Deta_View.uniMed WITH Thisform.unimed ADDITIVE
REPLACE cur_Deta_View.detobs WITH ALLTRIM(Thisform.Contenido.txtDetObs.Value) ADDITIVE

RETURN .T.


ENDPROC
PROCEDURE Load
SET TALK OFF
SET DATE FRENCH
SET CENTURY ON
SET SAFETY OFF
SET NOTIFY OFF
SET EXCLUSIVE OFF
SET DATE FRENCH
SET MULTILOCKS ON
SET DELETED ON
SET ENGINEBEHAVIOR 90

CREATE CURSOR cur_PedExt (	;
	idPedExt		int,;
	idArticulo		int,;
	codArt			varchar(20),;
	cantidad		int)

CREATE CURSOR cur_Detalle (	;
	idDetalle		int			,;
	idArticulo		int 		,;
	codArt			C(20)		,;
	descripcio		C(60)		,;
	nroPart			varchar(30)	,;
	cantidad		float(10,2)	,;
	prVta			float(10,2)	,;
	pDtoVta1		float(10,2)	,;
	pDtoVta2		float(10,2)	,;
	pDtoVta3		float(10,2)	,;
	pDtoVta4		float(10,2)	,;
	iDtoVta1		float(10,2)	,;
	iDtoVta2		float(10,2)	,;
	iDtoVta3		float(10,2)	,;
	iDtoVta4		float(10,2)	,;
	pDtoCli1		float(10,2)	,;
	pDtoCli2		float(10,2)	,;
	pDtoCli3		float(10,2)	,;
	pDtoCli4		float(10,2)	,;
	iDtoCli1		float(10,2)	,;
	iDtoCli2		float(10,2)	,;
	iDtoCli3		float(10,2)	,;
	iDtoCli4		float(10,2)	,;	
	pRecItem		float(10,2)	,;
	iRecItem		float(10,2)	,;
	alicIVA			float(10,2)	,;
	impIVA			float(10,2)	,;
	impNeto			float(10,2)	,;	
	totNeto			float(10,2)	,;
	subTotal		float(10,2)	,;
	porNoGrav		double DEFAULT 0,;
	baseGrav		double DEFAULT 0,;
	subtNoGrav		double DEFAULT 0,;		
	stkDisp			float(10,2)	,;
	prArtic			float(10,2)	,;
	esOferta		l,;
	pRecVta			float(10,2)	,;
	iRecVta			float(10,2)	,;
	uniDesp			float(10,2)	,;
	cantPack		float(10,2)	,;
	uniMed			varchar(3),;
	detobs			varchar(30))

CREATE CURSOR cur_Aux (	;
	idDetalle		int			,;
	idArticulo		int 		,;
	codArt			C(20)		,;
	descripcio		C(60)		,;
	nroPart			varchar(30) ,;
	cantidad		float(10,2)	,;
	prVta			float(10,2)	,;
	pDtoVta1		float(10,2)	,;
	pDtoVta2		float(10,2)	,;
	pDtoVta3		float(10,2)	,;
	pDtoVta4		float(10,2)	,;
	iDtoVta1		float(10,2)	,;
	iDtoVta2		float(10,2)	,;
	iDtoVta3		float(10,2)	,;
	iDtoVta4		float(10,2)	,;
	pDtoCli1		float(10,2)	,;
	pDtoCli2		float(10,2)	,;
	pDtoCli3		float(10,2)	,;
	pDtoCli4		float(10,2)	,;
	iDtoCli1		float(10,2)	,;
	iDtoCli2		float(10,2)	,;
	iDtoCli3		float(10,2)	,;
	iDtoCli4		float(10,2)	,;	
	pRecItem		float(10,2)	,;
	iRecItem		float(10,2)	,;
	alicIVA			float(10,2)	,;
	impIVA			float(10,2)	,;
	impNeto			float(10,2)	,;	
	totNeto			float(10,2)	,;
	subTotal		float(10,2)	,;
	porNoGrav		double DEFAULT 0,;
	baseGrav		double DEFAULT 0,;
	subtNoGrav		double DEFAULT 0,;		
	prArtic			float(10,2)	,;
	esOferta		l,;
	pRecVta			float(10,2) ,;
	iRecVta			float(10,2) ,;
	uniDesp			float(10,2) ,;
	cantPack		float(10,2) ,;
	uniMed			varchar(3),;
	detobs			varchar(30))

&& Ese cursor es para mostrar en la grilla el detalle sin importar
&& de que partida se saque
CREATE CURSOR cur_Deta_View (	;
	idDetalle		int			,;
	idArticulo		int 		,;
	codArt			C(20)		,;
	descripcio		C(60)		,;
	cantidad		float(10,2)	,;
	prVta			float(10,2)	,;
	pDtoVta1		float(10,2)	,;
	pDtoVta2		float(10,2)	,;
	pDtoVta3		float(10,2)	,;
	pDtoVta4		float(10,2)	,;
	iDtoVta1		float(10,2)	,;
	iDtoVta2		float(10,2)	,;
	iDtoVta3		float(10,2)	,;
	iDtoVta4		float(10,2)	,;
	pDtoCli1		float(10,2)	,;
	pDtoCli2		float(10,2)	,;
	pDtoCli3		float(10,2)	,;
	pDtoCli4		float(10,2)	,;
	iDtoCli1		float(10,2)	,;
	iDtoCli2		float(10,2)	,;
	iDtoCli3		float(10,2)	,;
	iDtoCli4		float(10,2)	,;	
	pRecItem		float(10,2)	,;
	iRecItem		float(10,2)	,;
	alicIVA			float(10,2)	,;
	impIVA			float(10,2)	,;
	impNeto			float(10,2)	,;	
	totNeto			float(10,2)	,;
	subTotal		float(10,2) ,;
	porNoGrav		double DEFAULT 0,;
	baseGrav		double DEFAULT 0,;
	subtNoGrav		double DEFAULT 0,;		
	stkDisp			float(10,2) ,;
	prArtic			float(10,2) ,;
	esOferta		l,;
	pRecVta			float(10,2) ,;
	iRecVta			float(10,2) ,;
	uniDesp			float(10,2) ,;
	cantPack		float(10,2) ,;
	uniMed			varchar(3),;
	detobs			varchar(30),;
	apli_PRG		l)	

CREATE CURSOR cur_Subtotal(	;
	impNeto			float(10,2)	,;
	impFinal		float(10,2) ,;
	porIVA21		float(10,2) ,;
	impIVA21		float(10,2) ,;
	porIVA105		float(10,2) ,;
	impIVA105		float(10,2) ,;
	porDesc1		float(10,2)	,;
	porDesc2		float(10,2)	,;
	porDesc3		float(10,2)	,;
	porDesc4		float(10,2)	,;
	impDesc1		float(10,2)	,;
	impDesc2		float(10,2)	,;
	impDesc3		float(10,2)	,;
	impDesc4		float(10,2)	,;
	totaNoGrav		double DEFAULT 0,;	
	totFact			float(10,2) ,;
	porRec			float(10,2) ,;
	impRec			float(10,2) ,;
	porIIBB			float(10,2) ,;
	impIIBB			float(10,2))
	
&& Agrego este cursor por partida
CREATE CURSOR cur_DetPart (	;
	idArticulo		int,;
	nroPart			varchar(30),;
	cantidad		float(10, 2))
	
&& El siguiente cursor es para mostrar los stocks insuficiente
CREATE CURSOR cur_StkInsu (	;
	idArticulo		int,;
	codArt			varchar(20),;
	descripcio		varchar(60),;
	stock_disp		float(10, 2),;
	cantFC			float(10, 2))
	
&& Este cursor va a contener los pedidos pendientes de facturar para cuando
&& se quiera levantar los mismos a partir de una factura.
CREATE CURSOR cur_Cbtes (	;
	sel			L,;
	idVentasC	int,;
	fecEmision	D,;
	numCbte		varchar(20),;
	idCliente	int,;
	razSoc		varchar(60) NULL,;
	totFact		float(10,2),;
	idTipoDoc	int NULL,;
	nroDoc	varchar(20) NULL) 

SELECT cur_Cbtes
INDEX ON idVentasC TAG idVentasC ASCENDING
INDEX ON fecEmision TAG fecEmision ASCENDING ADDITIVE
INDEX ON numCbte TAG numCbte ASCENDING ADDITIVE
INDEX ON idCliente TAG idCliente ASCENDING ADDITIVE
INDEX ON razSoc TAG razSoc ASCENDING ADDITIVE
INDEX ON totFact TAG totFact ASCENDING ADDITIVE

SET ORDER TO TAG fecEmision ASCENDING

&& Agrego el cursor que voy a administrar los faltantes
CREATE CURSOR cur_faltantes (	;
	idArticulo	int,;
	idCliente	int,;
	codArt		varchar(20),;
	uniDesp		float(10, 2),;
	cantidad	float(10, 2))
	
&& El siguiente cursor que agrego es para dar de baja los faltantes
CREATE CURSOR cur_BajaFalt ( ;
	idFaltante int)
		
&& Si usa impresora fiscal, agrego estas líneas para que el formulario
&& tenga soporte a los eventos del control OCX que se inserto para el
&& manejo de impresoras fiscales
IF ALLTRIM(GetConfig("USA_FISCAL")) == "S" THEN
	SYS(2333, 0)
	_VFP.AutoYield = .F.
	
	RETURN
ENDIF


ENDPROC
PROCEDURE imprimir
LOCAL m.NroCli, m.RazSoc, m.Telefono, m.direccion, m.localidad, m.codPostal, m.pcia, m.TipoIVA, m.nroCUIT
LOCAL m.CodTrans, m.RazSocTR
LOCAL m.Total, m.tipoDoc, m.NroCbte, m.Fecha, m.leyenda, m.fecVto, m.tipoDoc, m.ptoVta
LOCAL m.porDesc1, m.porDesc2, m.porDesc3, m.porDesc4
LOCAL m.impDesc1, m.impDesc2, m.impDesc3, m.impDesc4
LOCAL m.porIIBB, m.impIIBB, m.observ, m.vendedor
LOCAL m.porIVA105, m.impIVA105, m.porIVA21, m.impIVA21, m.impNeto, m.impFinal
LOCAL m.NroRto
LOCAL lcSql, loNumerador, lcPrinterName, lnCantCpia

loNumerador = CREATEOBJECT("odbc_result")
lcSql = ""
m.NroCli = Thisform.contenido.sel_Cliente.txtCodigo.Value
m.RazSoc = Thisform.contenido.sel_Cliente.txtDescripcion.Value
m.CodTrans = thisform.contenido.sel_transporte.txtCodigo.Value
m.RazSocTR = thisform.contenido.sel_transporte.txtDescripcion.Value
m.Telefono = ALLTRIM(Thisform.cli_telefono)
m.direccion = ALLTRIM(Thisform.cli_calle)
m.localidad = ALLTRIM(Thisform.cli_localidad)
m.codPostal = ALLTRIM(Thisform.cli_codPostal)
m.pcia = ALLTRIM(Thisform.cli_Pcia)
m.nroCUIT = ALLTRIM(Thisform.contenido.txtCuit.Value)
m.TipoIVA = Thisform.Contenido.txtSitIVA.Value
m.Total = 0.00
m.tipoDoc = ""
m.ptoVta = ""
m.NroCbte = ""
m.leyenda = ""
m.Fecha = DATETIME()
m.porIVA105 = 0.00
m.porIVA21 = 0.00
m.impIVA105 = 0.00
m.impIVA21 = 0.00
m.impNeto = 0.00
m.impFinal = 0.00
m.fecVto = DATE() + thisform.cp_cntdias
m.tipoDoc = Thisform.tipodoc
m.porIIBB = 0.00
m.impIIBB = 0.00
lnCantCpia = 0
m.observ = ""
m.vendedor = thisform.nombre_usuario
m.NroRto = ""

m.NroCbte = Thisform.ptovta + "-" + Thisform.nrocbte

&& Levanto la configuración de impresora para este puesto de trabajo

lcSql = "SELECT * FROM impresoras "
lcSql = lcSql + "WHERE hostName = '" + ALLTRIM(SYS(0)) + "' "
lcSql = lcSql + "	AND idNum = " + ALLTRIM(STR(Thisform.idNum))

loNumerador.ActiveConnection = goConn.ActiveConnection
loNumerador.Cursor_Name = "cur_num"

IF !loNumerador.OpenQuery(lcSql) THEN
	MESSAGEBOX(loNumerador.Error_Message, 0+48, Thisform.Caption)
	RETURN
ENDIF

SELECT cur_num
IF RECCOUNT("cur_num") = 0 THEN
	MESSAGEBOX("No hay impresora configurada para este puesto de trabajo", 0+48, Thisform.Caption)
	loNumerador.Close_Query()
	RETURN
ENDIF

lcPrinterName = ALLTRIM(cur_Num.impresora)
lnCantCpia = cur_Num.copias

loNumerador.Close_Query()

IF ALLTRIM(Thisform.cbte) == "COT"
	m.leyenda = "COTIZACION"
	m.tipoDoc = "X"
	m.Total = cur_Subtotal.totFact
ELSE 
	IF ALLTRIM(Thisform.cbte) == "PTO"
		m.leyenda = "PRESUPUESTO"
		m.tipoDoc = "X"
		m.Total = cur_Subtotal.impFinal
	ELSE
		IF ALLTRIM(Thisform.cbte) == "PED"
			m.leyenda = "NOTA DE PEDIDO"
			m.tipoDoc = "P"
			m.Total = Thisform.contenido.txtTotFact.Value
		ELSE
			IF ALLTRIM(Thisform.Cbte) == "FC"
				m.leyenda = "FACTURA"
				m.Total = cur_Subtotal.totFact
			ELSE
				IF ALLTRIM(Thisform.Cbte) == "NC"
					m.Leyenda = "NOTA DE CREDITO"
					m.Total = cur_Subtotal.totFact
				ELSE
					IF ALLTRIM(Thisform.Cbte) == "ND"
						m.leyenda = "NOTA DE DEBITO"
						m.Total = cur_Subtotal.totFact
					ENDIF
				ENDIF
			ENDIF
		ENDIF
	ENDIF
ENDIF 

IF (ALLTRIM(Thisform.cbte) == "NC") .OR. (ALLTRIM(Thisform.cbte) == "FC") .OR. (ALLTRIM(Thisform.cbte) == "PTO") .OR. (ALLTRIM(Thisform.cbte) == "COT") THEN
	m.porDesc1 = cur_Subtotal.porDesc1 
	m.porDesc2 = cur_Subtotal.porDesc2 
	m.porDesc3 = cur_Subtotal.porDesc3 
	m.porDesc4 = cur_Subtotal.porDesc4 
	m.impDesc1 = cur_Subtotal.impDesc1
	m.impDesc2 = cur_Subtotal.impDesc2
	m.impDesc3 = cur_Subtotal.impDesc3
	m.impDesc4 = cur_Subtotal.impDesc4
	m.porIVA105 = cur_Subtotal.porIVA105
	m.porIVA21 = cur_Subtotal.porIVA21
	m.impIVA105 = cur_Subtotal.impIVA105
	m.impIVA21 = cur_Subtotal.impIVA21
	m.impNeto = cur_Subtotal.impFinal
	m.impFinal = cur_Subtotal.impFinal
	m.porIIBB = cur_Subtotal.porIIBB
	m.impIIBB = cur_Subtotal.impIIBB
	
	SET PRINTER TO NAME ALLTRIM(lcPrinterName)
	SELECT cur_aux
ELSE 
	m.porDesc1 = Thisform.Contenido.txtDesc1.Value
	m.porDesc2 = Thisform.Contenido.txtDesc2.Value
	m.porDesc3 = Thisform.Contenido.txtDesc3.Value
	m.porDesc4 = Thisform.Contenido.txtDesc4.Value
	m.impDesc1 = Thisform.Contenido.txtImpDesc1.Value
	m.impDesc2 = Thisform.Contenido.txtImpDesc2.Value
	m.impDesc3 = Thisform.Contenido.txtImpDesc3.Value
	m.impDesc4 = Thisform.Contenido.txtImpDesc4.Value
	m.porIVA105 = Thisform.contenido.txtPorIVA105.Value
	m.porIVA21 = Thisform.Contenido.txtPorIVA21.value
	m.impIVA105 = Thisform.Contenido.txtImpIVA105.Value
	m.impIVA21 = Thisform.Contenido.txtImpIVA21.Value
	m.impNeto = Thisform.Contenido.txtST.Value
	m.impFinal = Thisform.Contenido.txtTotFact.Value
	m.porIIBB = Thisform.Contenido.txtPorIIBB.Value
	m.impIIBB = Thisform.Contenido.txtImpIIBB.Value

	SET PRINTER TO NAME ALLTRIM(lcPrinterName)
	SELECT cur_detalle
ENDIF 

IF !(TYPE("thisform.contenido.txtObserv.Value") == "C") THEN
	m.observ = ""
ELSE
	m.observ = thisform.contenido.txtObserv.Value + " "
ENDIF

&& Mando a imprimir los remitos
*!*	IF getglobalcfg("PRINT_RTO") THEN
*!*		IF This.cbte == "PTO" THEN
*!*			lnResp = MESSAGEBOX("¿Desea emitir remito?", 32+4, Thisform.Caption)
*!*			IF lnResp = 6 THEN
*!*				IF Thisform.getprinterrto() THEN
*!*					m.NroRto = Thisform.rto_numero
*!*					SET PRINTER TO NAME ALLTRIM(lcPrinterName)
*!*					SELECT cur_aux
*!*				
*!*					FOR i = 1 TO This.rto_cantcpias
*!*						REPORT FORM "rep_rtos.frx" TO PRINTER NOCONSOLE
*!*					NEXT i
*!*				ENDIF
*!*			ENDIF
*!*		ELSE
*!*			lnResp = MESSAGEBOX("¿Desea emitir remito?", 32+4, Thisform.Caption)
*!*			IF lnResp = 6 THEN	
*!*				IF This.cbte == "FC" THEN
*!*					IF Thisform.getprinterrto() THEN
*!*						m.NroRto = Thisform.rto_numero
*!*						SET PRINTER TO NAME ALLTRIM(lcPrinterName)
*!*						SELECT cur_aux
*!*					
*!*						FOR i = 1 TO This.rto_cantcpias
*!*							REPORT FORM "rep_rtos.frx" TO PRINTER NOCONSOLE
*!*						NEXT i
*!*					ENDIF
*!*				ENDIF
*!*			ENDIF
*!*		ENDIF
*!*	ENDIF

FOR i = 1 TO lnCantCpia
	IF (this.cbte == "COT") THEN
		&& Imprime una cotizacion
		SELECT cur_aux
		REPORT FORM "repcot.frx" TO PRINTER NOCONSOLE
	ELSE
		IF (this.cbte == "PTO") THEN
			&& Imprime un presupuesto
			SELECT cur_aux
			REPORT FORM "reppto.frx" TO PRINTER NOCONSOLE			
		ELSE
			&& Si el comprobante es "PED" entonces, tiene que enviar a imprimir una nota de pedido
			IF ALLTRIM(Thisform.cbte) == "PED" THEN
				SELECT cur_detalle
				m.observ = Thisform.contenido.txtObserv.Value
				REPORT FORM "reppedido.frx" TO PRINTER NOCONSOLE
			ELSE 
				IF ALLTRIM(Thisform.tipodoc) == "A" THEN
					&& Imprime el comprobante de tipo "A"
					SELECT cur_aux
					REPORT FORM "repcbtesvta.frx" TO PRINTER NOCONSOLE
				ELSE
					&& Imprime el comprobante de tipo "B"
					SELECT cur_aux
					REPORT FORM "repcbtesvta_b.frx" TO PRINTER NOCONSOLE
				ENDIF
			ENDIF
		ENDIF
	ENDIF
NEXT

ENDPROC
PROCEDURE contenido.sel_Cliente.recuperar_datos
LOCAL lo_rsSitIVA, lo_rsCondPago, lo_rsLocalidad, lo_rsPcia, lo_rsIIBB, lcSql
LOCAL lo_rsTipoDoc, lo_RsTransp

lo_rsSitIVA = CREATEOBJECT("odbc_result")
lo_rsCondPago = CREATEOBJECT("odbc_result")
lo_rsLocalidad = CREATEOBJECT("odbc_result")
lo_rsPcia = CREATEOBJECT("odbc_result")
lo_rsIIBB = CREATEOBJECT("odbc_result")
lo_rsTipoDoc = CREATEOBJECT("odbc_result")
lo_RsTransp = CREATEOBJECT("odbc_result")
lcSql = ""

IF Thisform.contenido.sel_Cliente.txtCodigo.Value == 0 THEN 
	Thisform.contenido.sel_Cliente.txtDescripcion.Value = ""
	RETURN .F.
ENDIF 

SELECT clientes

IF !clientes.habilitado THEN 
	MESSAGEBOX("Este cliente no está habilitado, por favor, verifique el estado del cliente", 0+48, Thisform.Caption)
	this.valcpoid = 0
	this.blanquear()
	this.txtcodigo.SetFocus()
	
	RETURN .F.
ENDIF 

IF ALLTRIM(thisform.cbte) == "FC" .OR. ALLTRIM(thisform.cbte) == "PED" THEN
	IF clientes.contrCM THEN
		thisform.calcular_saldo_dedudor()
		
		IF thisform.saldodeudor > clientes.credMax THEN
			MESSAGEBOX("El saldo deudor supera al crédito máximo otorgado", 0+48, Thisform.Caption)
			RETURN .F.
		ENDIF
	ENDIF
ENDIF

Thisform.contenido.txtDesc1.Value = clientes.desc1
Thisform.contenido.txtDesc2.Value = clientes.desc2
Thisform.contenido.txtDesc3.Value = clientes.desc3
Thisform.contenido.txtDesc4.Value = clientes.desc4
Thisform.cli_calle = clientes.direccion
Thisform.cli_cuit = clientes.nroCUIT
Thisform.cli_telefono = clientes.telefono
Thisform.cli_Id = clientes.idCliente
Thisform.contenido.txttelefono.Value = clientes.telefono
Thisform.contenido.txtcuit.Value = clientes.nrocuit

&& Levanto el codigo de tipo de documento
lcSql = "SELECT * FROM tipodoc WHERE idTipoDoc = " + ALLTRIM(STR(clientes.idTipoDoc))
lo_rsTipoDoc.ActiveConnection = goConn.ActiveConnection
lo_rsTipoDoc.Cursor_Name = "cur_tipodoc"
lo_rsTipoDoc.OpenQuery(lcSql)

SELECT cur_tipodoc
Thisform.cli_tipodoc = cur_tipodoc.tipodoc
Thisform.cli_idtipodoc = clientes.idTipoDoc

IF !(ALLTRIM(Thisform.cli_tipodoc) == "CUIT" .OR. ALLTRIM(Thisform.cli_tipodoc) == "CUIL") THEN
	This.Parent.txtCuit.InputMask = ""
ELSE
	This.Parent.txtCuit.InputMask = "XX-XXXXXXXX-XX"
ENDIF

lo_rsTipoDoc.close_query()

lcSql = "SELECT * FROM localidad WHERE idLocalid = " + ALLTRIM(STR(clientes.idLocalid))
lo_rsLocalidad.ActiveConnection = goConn.ActiveConnection
lo_rsLocalidad.Cursor_Name = "cur_Localid"
lo_rsLocalidad.OpenQuery(lcSql)

SELECT cur_Localid
Thisform.cli_localidad = cur_Localid.descripcio
Thisform.cli_codpostal = cur_Localid.codPostal

lcSql = "SELECT * FROM provincias WHERE idProvin = " + ALLTRIM(STR(cur_Localid.idProvin))
lo_rsPcia.ActiveConnection = goConn.ActiveConnection
lo_rsPcia.Cursor_Name = "cur_Pcia"
lo_rsPcia.OpenQuery(lcSql)

SELECT cur_Pcia
Thisform.cli_pcia = cur_Pcia.descripcio

lo_rsPcia.close_query()
lo_rsLocalidad.close_query()

lcSql = "SELECT * FROM sitiva WHERE idSitIVA = " + ALLTRIM(STR(clientes.idSitIVA))
lo_rsSitIVA.ActiveConnection = goConn.ActiveConnection
lo_rsSitIVA.Cursor_Name = "cur_SitIVA"
lo_rsSitIVA.OpenQuery(lcSql)

SELECT cur_SitIVA
Thisform.contenido.txtSitIVA.Value = cur_SitIVA.descripcio
Thisform.sitivacli = cur_SitIVA.idSitIVA
Thisform.CodIVAFiscal = cur_SitIVA.CodFiscal

lo_rsSitIVA.close_query()

lcSql = "SELECT * FROM condpagos WHERE idCondPago = " + ALLTRIM(STR(clientes.idCondPago))
lo_rsCondPago.ActiveConnection = goConn.ActiveConnection
lo_rsCondPago.Cursor_Name = "cur_CondPago"
lo_rsCondPago.OpenQuery(lcSql)

SELECT cur_CondPago
Thisform.contenido.sel_FormaPago.valcpoid = cur_CondPago.idCondPago
Thisform.contenido.sel_FormaPago.txtCodigo.Value = cur_CondPago.idCondPago
Thisform.contenido.sel_FormaPago.txtDescripcion.Value = cur_CondPago.Descripcio
thisform.cp_cntdias = cur_CondPago.cntDias

lo_rsCondPago.close_query()

&& Recupero el transporte
lcSql = "SELECT * FROM transp "
lcSql = lcSql + "WHERE idTransp = " + ALLTRIM(STR(clientes.idTransp))
lo_RsTransp.ActiveConnection = goConn.ActiveConnection
lo_RsTransp.Cursor_Name = "cur_trn"

IF !lo_RsTransp.OpenQuery(lcSql) THEN
	MESSAGEBOX(lo_RsTransp.Error_Message, 0+48, Thisform.Caption)
	RETURN
ENDIF

Thisform.contenido.sel_Transporte.valcpoid = cur_trn.idTransp
Thisform.contenido.sel_transporte.txtCodigo.Value = cur_trn.codTrans
Thisform.contenido.sel_transporte.txtDescripcion.Value = cur_trn.razSoc

lo_RsTransp.Close_Query()

IF ALLTRIM(Thisform.cbte) <> "PTO" THEN 
	lcSql = "SELECT * FROM padronib WHERE cuit = '" + ALLTRIM(STRTRAN(clientes.nrocuit,"-","")) + "'"
	lo_rsIIBB.ActiveConnection = goConn.ActiveConnection
	lo_rsIIBB.Cursor_Name = "cur_PadronIB"
	lo_rsIIBB.OpenQuery(lcSql)

	SELECT cur_PadronIB
	IF RECCOUNT("cur_PadronIB") > 0 THEN
		Thisform.contenido.txtPorIIBB.Value = cur_PadronIB.AlicuotaPer
	ELSE 
		Thisform.contenido.txtPorIIBB.Value = 0.00
	ENDIF 

	lo_rsIIBB.close_query()
ENDIF 

Thisform.contenido.txtPorRec.Value = IIF(ISNULL(clientes.recargo), 0.00, clientes.recargo)

IF ALLTRIM(thisform.cbte) != "NC" THEN 
	thisform.recalcular_todo()
ENDIF

IF ALLTRIM(thisform.cbte) == "FC" .OR. ALLTRIM(thisform.cbte) == "PED" THEN
	IF clientes.ctrMoro THEN
		thisform.mostrar_morosidad()
	ENDIF	
ENDIF

IF This.valcpoid = getglobalcfg("CLI_CF") THEN
	This.txtDescripcion.ReadOnly = .F.
	This.txtDescripcion.Enabled = .T.
	This.txtDescripcion.SetFocus()
	Thisform.contenido.txtPrMinorista.ReadOnly = .F.
	Thisform.contenido.txtPrMinorista.Enabled = .T.
	Thisform.contenido.txtDesc1.Enabled = .T.
	Thisform.contenido.txtDesc2.Enabled = .T.
	Thisform.contenido.txtDesc3.Enabled = .T.
	Thisform.contenido.txtDesc4.Enabled = .T.
	Thisform.contenido.txtCuit.Enabled = .T.
		
	Thisform.contenido.txtDesc1.ReadOnly = .F.
	Thisform.contenido.txtDesc2.ReadOnly = .F.
	Thisform.contenido.txtDesc3.ReadOnly = .F.
	Thisform.contenido.txtDesc4.ReadOnly = .F.
	Thisform.contenido.txtCuit.ReadOnly = .F.
ELSE
	This.txtDescripcion.ReadOnly = .T.
	This.txtDescripcion.Enabled = .F.
	Thisform.contenido.txtPrMinorista.ReadOnly = .T.
	Thisform.contenido.txtPrMinorista.Enabled = .F.
	Thisform.contenido.txtDesc1.Enabled = .T.
	Thisform.contenido.txtDesc2.Enabled = .T.
	Thisform.contenido.txtDesc3.Enabled = .T.
	Thisform.contenido.txtDesc4.Enabled = .T.
	Thisform.contenido.txtCuit.Enabled = .T.
		
	Thisform.contenido.txtDesc1.ReadOnly = .F.
	Thisform.contenido.txtDesc2.ReadOnly = .F.
	Thisform.contenido.txtDesc3.ReadOnly = .F.
	Thisform.contenido.txtDesc4.ReadOnly = .F.
	Thisform.contenido.txtCuit.ReadOnly = .F.
ENDIF
ENDPROC
PROCEDURE contenido.btnAgregar.Click
IF thisform.agregar_item_viewer() THEN
	Thisform.contenido.sel_Articulo.blanquear()
	Thisform.contenido.txtprMay.Value = 0.00
	Thisform.contenido.txtPrMinorista.Value = 0.00
	Thisform.contenido.txtCantidad.Value = 0.00
	Thisform.contenido.txtPrNeto.Value = 0.00
	Thisform.contenido.txtSubTotal.Value = 0.00
	Thisform.contenido.txtAlicIVA.Value = 0.00
	Thisform.contenido.txtImpIVA.Value = 0.00
	Thisform.contenido.txtSTNeto.Value = 0.00
	Thisform.contenido.txtPorDesc1.Value = 0.00
	Thisform.contenido.txtPorDesc2.Value = 0.00
	Thisform.contenido.txtPorDesc3.Value = 0.00
	Thisform.contenido.txtPorDesc4.Value = 0.00
	Thisform.contenido.txtImpDescItem1.Value = 0.00
	Thisform.contenido.txtImpDescItem2.Value = 0.00
	Thisform.contenido.txtImpDescItem3.Value = 0.00
	Thisform.contenido.txtImpDescItem4.Value = 0.00
	Thisform.contenido.txtDetObs.blanquear()
	Thisform.pr_mayorista = 0.00
	Thisform.pr_minorista = 0.00
	Thisform.contenido.txtCantPack.Value = 0.00
	Thisform.contenido.cboUnidVta.Clear()
	Thisform.unimed = ""
	Thisform.prarti_x = 0.00
	Thisform.contenido.txtPorRecItem.Value = 0.00

	Thisform.sumar_items()
	Thisform.calcular_ret_iibb()
	
	SELECT cur_Deta_View 
	GO BOTTOM
	Thisform.contenido.grdDetalles.Refresh()

	Thisform.contenido.sel_Articulo.txtDescripcion.Enabled = .F.
	Thisform.contenido.txtPrMinorista.Enabled = .F.
	Thisform.contenido.sel_Articulo.txtCodigo.SetFocus()
ENDIF
ENDPROC
PROCEDURE contenido.TXTPORREC.LostFocus
thisform.recalcular_todo()
ENDPROC


************************************************************
OBJETO: Clsetiqueta28
************************************************************
*** PROPIEDADES ***
Caption = "Observación:"
Height = 15
Left = 674
Top = 126
Width = 80
TabIndex = 91
Name = "Clsetiqueta28"

*** METODOS ***


************************************************************
OBJETO: txtDetObs
************************************************************
*** PROPIEDADES ***
Height = 21
Left = 754
MaxLength = 30
TabIndex = 6
Top = 122
Width = 230
ischaracter = .T.
Name = "txtDetObs"

*** METODOS ***


************************************************************
OBJETO: Clsetiqueta29
************************************************************
*** PROPIEDADES ***
Caption = "Transporte:"
Left = 12
Top = 88
TabIndex = 92
Name = "Clsetiqueta29"

*** METODOS ***


************************************************************
OBJETO: Sel_transporte
************************************************************
*** PROPIEDADES ***
Top = 82
Left = 111
TabIndex = 4
esnumerico = .T.
nombre_campo_codigo = codTrans
nombre_campo_desc = razSoc
nombre_tabla = transp
pkfield = idTransp
Name = "Sel_transporte"
txtCodigo.Name = "txtCodigo"
txtDescripcion.Name = "txtDescripcion"

*** METODOS ***


************************************************************
OBJETO: 
************************************************************
*** PROPIEDADES ***
Arial, 0, 9, 5, 15, 12, 32, 3, 0
Arial, 1, 8, 5, 14, 11, 29, 3, 0
Arial, 1, 9, 6, 15, 12, 32, 3, 0

*** METODOS ***


